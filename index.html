<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366f1">
    <title>Mago Max S.A.V.E.R.S. - Per Animatori & Spettacolo</title>
    <!-- DISABLED for single-file deployment (Arcanis/GHL) -->
    <!-- <link rel="manifest" href="manifest.json"> -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js" async></script>
    <!-- Chart.js for Analytics - defer instead of async to ensure proper loading -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js" async></script>
    <script src="https://accounts.google.com/gsi/client" async></script>
    <style>
/* ============================================
   MAGO MAX S.A.V.E.R.S. - COMPLETE STYLES
   Per Animatori & Spettacolo
   ============================================ */

:root {
    /* Brand Colors - Modern Purple/Indigo */
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;
    --secondary: #14b8a6;
    --accent: #f59e0b;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    
    /* Finance Colors */
    --income: #10b981;
    --expense: #ef4444;
    --savings: #6366f1;
    
    /* Neutral Colors */
    --bg-primary: #f8fafc;
    --bg-secondary: #f1f5f9;
    --bg-card: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --border: #e2e8f0;
    --border-light: #f1f5f9;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    
    /* Sizing */
    --radius-sm: 8px;
    --radius: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --spacing: 16px;
    
    /* Transitions */
    --transition: all 0.2s ease;
}

/* Dark Theme */
.theme-dark {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border: #334155;
    --border-light: #1e293b;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    /* Previene il bounce/overscroll su iOS */
    overscroll-behavior: none;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    /* Previene il bounce/overscroll su iOS */
    overscroll-behavior: none;
    -webkit-overflow-scrolling: touch;
}

/* ============================================
   LAYOUT
   ============================================ */

.app-container {
    max-width: 100%;
    min-height: 100vh;
    min-height: 100dvh;
    padding-bottom: calc(70px + env(safe-area-inset-bottom));
    /* Previene overscroll */
    overscroll-behavior: contain;
}

.page {
    display: none;
    padding: var(--spacing);
    padding-bottom: calc(100px + env(safe-area-inset-bottom));
    max-width: 600px;
    margin: 0 auto;
    animation: fadeIn 0.3s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   HEADER
   ============================================ */

.header {
    background: var(--bg-card);
    padding: 20px var(--spacing);
    padding-top: calc(20px + env(safe-area-inset-top, 0px));
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-logo {
    font-size: 1.8rem;
}

.header-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
}

.header-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.header-profile {
    padding: 0 !important;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
}

.profile-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
}

.header-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-size: 1.1rem;
    cursor: pointer;
    transition: var(--transition);
}

.header-btn:hover {
    background: var(--primary);
    color: white;
}

/* ============================================
   CARDS
   ============================================ */

.card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 16px;
    margin-bottom: 14px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-light);
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-title-icon {
    font-size: 1.2rem;
}

.card-action {
    font-size: 0.8rem;
    color: var(--primary);
    font-weight: 500;
    cursor: pointer;
    text-decoration: none;
}

.card-action:hover {
    text-decoration: underline;
}

/* Colored Cards */
.card-gradient {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border: none;
}

.card-gradient .card-title,
.card-gradient .card-action {
    color: white;
}

.card-success {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
    border: none;
}

.card-warning {
    background: linear-gradient(135deg, var(--warning), #d97706);
    color: white;
    border: none;
}

.card-danger {
    background: linear-gradient(135deg, var(--danger), #dc2626);
    color: white;
    border: none;
}

/* ============================================
   STATS GRID
   ============================================ */

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: var(--spacing);
}

.stats-grid.cols-3 {
    grid-template-columns: repeat(3, 1fr);
}

.stat-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.stat-card.highlight {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border: none;
}

.stat-icon {
    font-size: 1.5rem;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 2px;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-card.highlight .stat-label {
    color: rgba(255,255,255,0.8);
}

/* ============================================
   BUTTONS
   ============================================ */

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 20px;
    border-radius: var(--radius);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: var(--transition);
    text-decoration: none;
    min-height: 44px; /* Touch target minimo */
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.btn-secondary:hover {
    background: var(--border);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-outline {
    background: transparent;
    border: 2px solid var(--primary);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
}

.btn-ghost {
    background: transparent;
    color: var(--text-secondary);
}

.btn-ghost:hover {
    background: var(--bg-secondary);
}

.btn-sm {
    padding: 7px 14px;
    font-size: 0.8rem;
    min-height: 36px;
}

.btn-xs {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
}
.btn-xs:hover {
    background: var(--bg-secondary);
    transform: scale(1.05);
}

.btn-lg {
    padding: 16px 32px;
    font-size: 1.1rem;
}

.btn-block {
    width: 100%;
}

.btn-icon {
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
}

.btn-fab {
    position: fixed;
    bottom: calc(95px + env(safe-area-inset-bottom));
    right: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    font-size: 1.5rem;
    box-shadow: var(--shadow-lg);
    z-index: 100;
}

.btn-fab:hover {
    transform: scale(1.1);
}

/* ============================================
   FORMS
   ============================================ */

.form-group {
    margin-bottom: 16px;
}

.form-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.form-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    color: var(--text-primary);
    background: var(--bg-card);
    transition: var(--transition);
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
}

.form-input::placeholder {
    color: var(--text-muted);
}

/* Form input error state */
.form-input.input-error,
.form-input:invalid:not(:placeholder-shown) {
    border-color: var(--danger) !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.form-input.input-success {
    border-color: var(--success) !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

/* Field error message */
.field-error-msg {
    color: var(--danger);
    font-size: 0.75rem;
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.field-error-msg::before {
    content: '⚠️';
    font-size: 0.7rem;
}

/* Enhanced empty state */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.5;
}

.empty-state-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-secondary);
}

.empty-state-message {
    font-size: 0.85rem;
    margin-bottom: 16px;
}

/* Loading overlay for cards */
.card.loading {
    position: relative;
    pointer-events: none;
}

.card.loading::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(var(--bg-card-rgb), 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: inherit;
}

.card.loading::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 30px;
    height: 30px;
    margin: -15px 0 0 -15px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    z-index: 1;
}

/* Swipe action hint */
.swipe-hint {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: var(--danger);
    color: white;
    padding: 8px 16px;
    border-radius: 8px 0 0 8px;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.item-swiping .swipe-hint {
    opacity: 1;
}

.form-textarea {
    min-height: 100px;
    resize: vertical;
}

.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* Input with icon */
.input-group {
    position: relative;
}

.input-group .form-input {
    padding-left: 44px;
}

.input-group-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.1rem;
    color: var(--text-muted);
}

/* Toggle Switch */
.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-light);
}

.toggle-label {
    font-size: 0.95rem;
    color: var(--text-primary);
}

.toggle-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 2px;
}

.toggle-switch {
    width: 48px;
    height: 26px;
    background: var(--border);
    border-radius: 13px;
    position: relative;
    cursor: pointer;
    transition: var(--transition);
}

.toggle-switch.active {
    background: var(--primary);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: var(--transition);
    box-shadow: var(--shadow-sm);
}

.toggle-switch.active::after {
    transform: translateX(22px);
}

/* Weekday checkboxes per ricorrenza */
.weekday-check {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.weekday-check:has(input:checked) {
    background: var(--primary);
    color: white;
}

.weekday-check input {
    display: none;
}

/* ============================================
   BOTTOM NAVIGATION
   ============================================ */

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-card);
    display: flex;
    justify-content: space-around;
    padding: 6px 0;
    padding-bottom: calc(6px + env(safe-area-inset-bottom));
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    border-top: 1px solid var(--border-light);
    z-index: 200;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 16px;
    color: var(--text-muted);
    cursor: pointer;
    transition: var(--transition);
    border-radius: var(--radius);
    min-width: 64px;
    min-height: 54px;
    -webkit-tap-highlight-color: rgba(99, 102, 241, 0.2);
    touch-action: manipulation;
    user-select: none;
}

.nav-item.active {
    color: var(--primary);
}

.nav-item:hover {
    background: var(--bg-secondary);
}

.nav-item:active {
    transform: scale(0.95);
    background: rgba(99, 102, 241, 0.15);
}

.nav-icon {
    font-size: 1.4rem;
    margin-bottom: 4px;
}

.nav-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* ============================================
   MODALS
   ============================================ */

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(15,23,42,0.6);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: flex-end;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
    overflow: hidden;
    /* Assicura che non vada oltre lo schermo */
    padding-top: env(safe-area-inset-top, 0);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--bg-card);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    width: 100%;
    max-width: 500px;
    max-height: 70vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    position: relative;
}

.modal-overlay.active .modal {
    transform: translateY(0);
}

.modal-center .modal {
    border-radius: var(--radius-xl);
    max-height: 85vh;
    margin: 20px;
}

.modal-handle {
    width: 48px;
    height: 5px;
    background: var(--border);
    border-radius: 3px;
    margin: 14px auto 10px;
    flex-shrink: 0;
    opacity: 0.6;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-light);
    background: var(--bg-card);
    z-index: 10;
    flex-shrink: 0;
}

.modal-title {
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.modal-close:hover {
    background: var(--border);
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
}

/* More Menu Styles */
.more-menu-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}

.more-menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 8px;
    background: var(--bg-secondary);
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
}

.more-menu-item:hover {
    background: var(--bg-hover);
    transform: translateY(-2px);
}

.more-menu-icon {
    font-size: 1.8rem;
    margin-bottom: 8px;
}

.more-menu-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-primary);
    text-align: center;
}

.modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: 12px;
    flex-shrink: 0;
    background: var(--bg-card);
}

.modal-footer .btn {
    flex: 1;
}

/* ============================================
   FINANCE - SUMMARY CARD
   ============================================ */

.finance-hero {
    background: linear-gradient(135deg, var(--primary), #7c3aed);
    border-radius: var(--radius-xl);
    padding: 24px;
    color: white;
    margin-bottom: var(--spacing);
    position: relative;
    overflow: hidden;
}

.finance-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 200px;
    height: 200px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
}

.finance-hero::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -10%;
    width: 150px;
    height: 150px;
    background: rgba(255,255,255,0.05);
    border-radius: 50%;
}

.finance-balance-label {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 4px;
}

.finance-balance-amount {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 20px;
}

.finance-stats-row {
    display: flex;
    justify-content: space-around;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 16px;
}

.finance-stat {
    text-align: center;
}

.finance-stat-label {
    font-size: 0.75rem;
    opacity: 0.8;
    margin-bottom: 4px;
}

.finance-stat-value {
    font-size: 1.2rem;
    font-weight: 700;
}

.finance-stat-value.income { color: #86efac; }
.finance-stat-value.expense { color: #fca5a5; }

/* ============================================
   TRANSACTION ITEM
   ============================================ */

.transaction-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-card);
    border-radius: var(--radius);
    margin-bottom: 10px;
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
}

.transaction-item:hover {
    border-color: var(--border);
    box-shadow: var(--shadow-sm);
}

.transaction-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.transaction-info {
    flex: 1;
    min-width: 0;
}

.transaction-title {
    font-weight: 500;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.transaction-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
    display: flex;
    gap: 8px;
    align-items: center;
}

.transaction-amount {
    font-weight: 700;
    font-size: 1rem;
    white-space: nowrap;
}

.transaction-amount.income { color: var(--income); }
.transaction-amount.expense { color: var(--expense); }

/* Category Colors */
.cat-food { background: #fef3c7; }
.cat-transport { background: #dbeafe; }
.cat-shopping { background: #fce7f3; }
.cat-bills { background: #fee2e2; }
.cat-entertainment { background: #e0e7ff; }
.cat-health { background: #d1fae5; }
.cat-education { background: #ede9fe; }
.cat-home { background: #ffedd5; }
.cat-income { background: #d1fae5; }
.cat-other { background: #f1f5f9; }

/* ============================================
   BUDGET PROGRESS
   ============================================ */

.budget-item {
    margin-bottom: 16px;
}

.budget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.budget-category {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.budget-category-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.budget-amounts {
    text-align: right;
    font-size: 0.85rem;
}

.budget-spent {
    font-weight: 600;
    color: var(--text-primary);
}

.budget-limit {
    color: var(--text-muted);
}

.budget-bar {
    height: 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    overflow: hidden;
}

.budget-progress {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
}

.budget-progress.safe { background: var(--success); }
.budget-progress.warning { background: var(--warning); }
.budget-progress.danger { background: var(--danger); }

/* ============================================
   MONEY GOALS
   ============================================ */

.money-goal-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border-light);
}

.money-goal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.money-goal-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.money-goal-icon {
    font-size: 1.3rem;
}

.money-goal-target {
    text-align: right;
}

.money-goal-current {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary);
}

.money-goal-total {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.money-goal-bar {
    height: 10px;
    background: var(--bg-secondary);
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 8px;
}

.money-goal-progress {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    border-radius: 5px;
    transition: width 0.5s ease;
}

.money-goal-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ============================================
   RECEIPT SCANNER
   ============================================ */

.scanner-area {
    border: 3px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    background: var(--bg-secondary);
}

.scanner-area:hover,
.scanner-area.active {
    border-color: var(--primary);
    background: rgba(99,102,241,0.05);
}

.scanner-area.processing {
    pointer-events: none;
    opacity: 0.7;
}

.scanner-icon {
    font-size: 3rem;
    margin-bottom: 12px;
}

.scanner-text {
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.scanner-hint {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.scanner-preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: var(--radius);
    margin-top: 16px;
    display: none;
}

.scanner-progress {
    margin-top: 20px;
    text-align: center;
}

.scanner-progress-bar {
    height: 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
}

.scanner-progress-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.scanner-progress-text {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.scanner-result {
    margin-top: 20px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    text-align: left;
}

.scanner-result-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-light);
}

.scanner-result-row:last-child {
    border-bottom: none;
}

.scanner-result-label {
    color: var(--text-secondary);
}

.scanner-result-value {
    font-weight: 600;
}

.scanner-result-value.editable {
    color: var(--primary);
    cursor: pointer;
}


/* ============================================
   TASKS
   ============================================ */

.task-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px;
    background: var(--bg-card);
    border-radius: var(--radius);
    margin-bottom: 10px;
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
}

.task-item:hover {
    border-color: var(--border);
}

.task-item.completed {
    opacity: 0.5;
}

.task-item.completed .task-title {
    text-decoration: line-through;
    color: var(--text-muted);
}

.task-checkbox {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: white;
    flex-shrink: 0;
    margin-top: 2px;
    transition: var(--transition);
    cursor: pointer;
    position: relative;
    z-index: 10;
}

.task-checkbox:hover {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
    transform: scale(1.1);
}

.task-checkbox:active {
    transform: scale(0.95);
}

.task-checkbox.checked,
.task-item.completed .task-checkbox {
    background: var(--success);
    border-color: var(--success);
    color: white;
    font-weight: bold;
}

.completed-badge {
    background: var(--success);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
}

.line-through {
    text-decoration: line-through;
    color: var(--text-muted);
}

.task-content {
    flex: 1;
    min-width: 0;
}

.task-title {
    font-weight: 500;
    margin-bottom: 4px;
}

.task-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.task-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: var(--bg-secondary);
    border-radius: 20px;
}

.task-priority {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.priority-high { background: var(--danger); }
.priority-medium { background: var(--warning); }
.priority-low { background: var(--info); }

.task-due { color: var(--text-muted); }
.task-due.overdue { color: var(--danger); }
.task-due.today { color: var(--warning); }

/* Eisenhower Matrix */
.matrix-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.matrix-quadrant {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 14px;
    min-height: 150px;
    border: 2px solid transparent;
}

.quadrant-1 { border-color: rgba(239,68,68,0.3); }
.quadrant-2 { border-color: rgba(34,197,94,0.3); }
.quadrant-3 { border-color: rgba(245,158,11,0.3); }
.quadrant-4 { border-color: rgba(148,163,184,0.3); }

.quadrant-header {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 10px;
    text-transform: uppercase;
}

.quadrant-1 .quadrant-header { color: var(--danger); }
.quadrant-2 .quadrant-header { color: var(--success); }
.quadrant-3 .quadrant-header { color: var(--warning); }
.quadrant-4 .quadrant-header { color: var(--text-muted); }

.matrix-task {
    font-size: 0.85rem;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    margin-bottom: 6px;
    cursor: pointer;
}

/* Kanban */
.kanban-container {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 10px;
    -webkit-overflow-scrolling: touch;
}

.kanban-column {
    min-width: 260px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 12px;
}

/* Colonna task delegati - evidenziata */
.kanban-column.delegated-column {
    border: 2px solid rgba(139, 92, 246, 0.3);
    background: linear-gradient(180deg, rgba(139, 92, 246, 0.05) 0%, var(--bg-secondary) 100%);
}

.kanban-column.delegated-column .kanban-header {
    color: white;
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    margin: -12px -12px 12px -12px;
}

/* Badge progetto sui task delegati */
.delegated-task-badge {
    display: inline-block;
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    color: white;
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: 4px;
    margin-bottom: 4px;
    font-weight: 500;
}

.delegated-task-owner {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 4px;
}

.kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
}

.kanban-title {
    font-weight: 600;
    font-size: 0.9rem;
}

.kanban-count {
    background: var(--bg-card);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
}

.kanban-column-content {
    min-height: 100px;
    padding: 4px;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.kanban-column-content.drag-over {
    background: rgba(99, 102, 241, 0.1);
    border: 2px dashed var(--primary);
}

.kanban-task {
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 8px;
    box-shadow: var(--shadow-sm);
    cursor: grab;
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
    user-select: none;
}

.kanban-task:active {
    cursor: grabbing;
}

.kanban-task.dragging {
    opacity: 0.5;
    transform: rotate(2deg) scale(1.02);
    box-shadow: var(--shadow-lg);
}

.kanban-task.priority-high { border-left-color: var(--danger); }
.kanban-task.priority-medium { border-left-color: var(--warning); }
.kanban-task.priority-low { border-left-color: var(--info); }

/* ============================================
   GOALS
   ============================================ */

.goal-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    border-left: 4px solid var(--primary);
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.goal-title {
    font-weight: 600;
}

.goal-progress-text {
    font-size: 0.9rem;
    color: var(--primary);
    font-weight: 600;
}

.goal-bar {
    height: 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 10px;
}

.goal-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--success));
    border-radius: 3px;
    transition: width 0.5s ease;
}

.key-results {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-light);
}

.key-result {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 0.9rem;
}

.kr-checkbox {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.7rem;
    color: white;
}

.key-result.completed .kr-checkbox {
    background: var(--success);
    border-color: var(--success);
}

.kr-text {
    flex: 1;
}

.key-result.completed .kr-text {
    text-decoration: line-through;
    color: var(--text-muted);
}

/* ============================================
   TIME TRACKING
   ============================================ */

.timer-display {
    text-align: center;
    padding: 30px 0;
}

.timer-time {
    font-size: 4rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.timer-label {
    color: var(--text-secondary);
    margin-bottom: 20px;
}

.timer-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
}

.time-block {
    background: rgba(99,102,241,0.1);
    border-left: 3px solid var(--primary);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    padding: 10px 14px;
    margin-bottom: 8px;
}

.time-block-title {
    font-weight: 500;
    font-size: 0.9rem;
}

.time-block-time {
    font-size: 0.8rem;
    color: var(--text-muted);
}

/* ============================================
   POMODORO
   ============================================ */

.pomodoro-container {
    text-align: center;
    padding: 20px 0;
}

.pomodoro-timer {
    font-size: 5rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    color: var(--primary);
    margin-bottom: 8px;
}

.pomodoro-label {
    color: var(--text-secondary);
    font-size: 1rem;
    margin-bottom: 24px;
}

.pomodoro-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 24px;
}

.pomodoro-sessions {
    display: flex;
    justify-content: center;
    gap: 8px;
}

.pomodoro-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--border);
    transition: var(--transition);
}

.pomodoro-dot.completed {
    background: var(--success);
}

.pomodoro-dot.current {
    background: var(--primary);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.8; }
}

/* ============================================
   FOCUS PAGE (Unified Pomodoro + Time Tracker)
   ============================================ */

.focus-hero {
    display: flex;
    justify-content: center;
    padding: 20px 0 30px;
}

.focus-timer-ring {
    position: relative;
    width: 220px;
    height: 220px;
}

.focus-timer-ring svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.focus-ring-bg {
    fill: none;
    stroke: var(--bg-secondary);
    stroke-width: 10;
}

.focus-ring-progress {
    fill: none;
    stroke: var(--primary);
    stroke-width: 10;
    stroke-linecap: round;
    stroke-dasharray: 565.48;
    stroke-dashoffset: 0;
    transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
}

.focus-ring-progress.break {
    stroke: var(--success);
}

.focus-timer-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.focus-time {
    font-size: 3.5rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    color: var(--text-primary);
    line-height: 1;
}

.focus-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

.focus-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
}

.focus-main-btn {
    min-width: 140px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-lg {
    padding: 14px 24px;
    font-size: 1.1rem;
}

.focus-type-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    background: var(--bg-secondary);
    padding: 4px;
    border-radius: var(--radius);
}

.focus-type-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    background: transparent;
    border-radius: calc(var(--radius) - 2px);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition);
}

.focus-type-btn.active {
    background: var(--bg-card);
    color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.focus-type-btn:hover:not(.active) {
    color: var(--text-primary);
}

.focus-current-task {
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.focus-current-task .task-name {
    font-weight: 600;
    color: var(--text-primary);
}

.focus-session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border-light);
}

.focus-session-item:last-child {
    border-bottom: none;
}

.focus-session-type {
    display: flex;
    align-items: center;
    gap: 10px;
}

.focus-session-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.focus-session-info {
    font-weight: 600;
    font-size: 0.9rem;
}

.focus-session-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.focus-session-duration {
    font-weight: 700;
    color: var(--primary);
}

/* Distraction Item */
.distraction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
}

.distraction-item:last-child {
    margin-bottom: 0;
}

.distraction-text {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.distraction-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Daily Flow Mood Buttons */
.mood-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: var(--bg-secondary);
    cursor: pointer;
    transition: var(--transition);
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mood-btn:hover {
    border-color: var(--primary);
    transform: scale(1.1);
}

/* ============================================
   NOTES
   ============================================ */

.note-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 14px;
    margin-bottom: 10px;
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
}

.note-card:hover {
    border-color: var(--border);
}

.note-title {
    font-weight: 600;
    margin-bottom: 6px;
}

.note-preview {
    font-size: 0.85rem;
    color: var(--text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.note-meta {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.note-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 8px;
}

.note-tag {
    padding: 2px 8px;
    background: var(--bg-secondary);
    border-radius: 10px;
    font-size: 0.7rem;
    color: var(--text-secondary);
}

/* ============================================
   HABITS
   ============================================ */

.habit-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-card);
    border-radius: var(--radius);
    margin-bottom: 10px;
    border: 1px solid var(--border-light);
}

.habit-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    background: var(--bg-secondary);
}

.habit-info {
    flex: 1;
}

.habit-name {
    font-weight: 500;
    margin-bottom: 4px;
}

.habit-streak {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.habit-check {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.9rem;
    color: white;
}

.habit-check:hover {
    border-color: var(--primary);
}

.habit-check.completed {
    background: var(--success);
    border-color: var(--success);
}

/* ============================================
   ROUTINE (S.A.V.E.R.S.)
   ============================================ */

.routine-progress {
    text-align: center;
    margin-bottom: 20px;
}

.progress-ring {
    width: 140px;
    height: 140px;
    margin: 0 auto 12px;
    position: relative;
}

.progress-ring svg {
    transform: rotate(-90deg);
}

.progress-ring circle {
    fill: none;
    stroke-width: 10;
}

.progress-ring .bg {
    stroke: var(--bg-secondary);
}

.progress-ring .progress {
    stroke: var(--primary);
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
}

.progress-ring-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.progress-ring-value {
    font-size: 1.8rem;
    font-weight: 700;
}

.progress-ring-label {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.routine-activity {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-card);
    border-radius: var(--radius);
    margin-bottom: 10px;
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
}

.routine-activity:hover {
    border-color: var(--border);
}

.routine-activity.completed {
    background: rgba(16,185,129,0.05);
    border-color: var(--success);
}

.activity-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    background: var(--bg-secondary);
}

.routine-activity.completed .activity-icon {
    background: var(--success);
}

.activity-info {
    flex: 1;
}

.activity-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.activity-duration {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.activity-check {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: white;
}

.routine-activity.completed .activity-check {
    background: var(--success);
    border-color: var(--success);
}

/* ============================================
   ANALYTICS / CHARTS
   ============================================ */

.chart-container {
    position: relative;
    height: 200px;
    margin: 16px 0;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.analytics-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 16px;
    text-align: center;
    border: 1px solid var(--border-light);
}

.analytics-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
}

.analytics-label {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 4px;
}

/* ============================================
   BADGES
   ============================================ */

.badges-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.badge-item {
    text-align: center;
    padding: 16px 10px;
    background: var(--bg-card);
    border-radius: var(--radius);
    border: 1px solid var(--border-light);
}

.badge-item.locked {
    opacity: 0.4;
    filter: grayscale(1);
}

.badge-icon {
    font-size: 2rem;
    margin-bottom: 8px;
}

.badge-name {
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-desc {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 2px;
}

/* ============================================
   HABIT HEATMAP
   ============================================ */

.habit-heatmap {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    padding: 8px 0;
}

.heatmap-day {
    aspect-ratio: 1;
    border-radius: 4px;
    background: var(--bg-secondary);
    cursor: pointer;
    transition: var(--transition);
}

.heatmap-day:hover {
    transform: scale(1.1);
}

.heatmap-day.level-0 { background: var(--bg-secondary); }
.heatmap-day.level-1 { background: rgba(99, 102, 241, 0.25); }
.heatmap-day.level-2 { background: rgba(99, 102, 241, 0.5); }
.heatmap-day.level-3 { background: rgba(99, 102, 241, 0.75); }
.heatmap-day.level-4 { background: var(--primary); }

/* ============================================
   UTILITIES
   ============================================ */

.toast {
    position: fixed;
    bottom: calc(100px + env(safe-area-inset-bottom));
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--text-primary);
    color: white;
    padding: 14px 24px;
    border-radius: var(--radius-xl);
    font-weight: 500;
    box-shadow: var(--shadow-lg);
    z-index: 99999;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    align-items: center;
    gap: 8px;
    max-width: calc(100% - 32px);
    width: auto;
    text-align: center;
    justify-content: center;
}

.toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
}

.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); }

.empty-state {
    text-align: center;
    padding: 40px 20px;
}

.empty-icon {
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: 0.5;
}

.empty-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 6px;
}

.empty-text {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 16px;
}

.loader {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.text-center { text-align: center; }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success); }
.text-danger { color: var(--danger); }
.text-sm { font-size: 0.85rem; }
.text-xs { font-size: 0.75rem; }
.font-bold { font-weight: 700; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.flex { display: flex; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-1 { gap: 8px; }
.gap-2 { gap: 12px; }
.hidden { display: none !important; }

/* ============================================
   CLOUD SYNC & LOGIN
   ============================================ */

.cloud-sync-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    background: var(--bg-card);
    border-radius: var(--radius);
    margin-bottom: var(--spacing);
    border: 1px solid var(--border-light);
}

.sync-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sync-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-muted);
}

.sync-indicator.syncing {
    background: var(--warning);
    animation: syncPulse 1s ease infinite;
}

.sync-indicator.synced {
    background: var(--success);
}

.sync-indicator.error {
    background: var(--danger);
}

@keyframes syncPulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
}

.sync-text {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* Indicatore sottile di sincronizzazione attiva - non blocca i click */
body.is-syncing::after {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
    background-size: 200% 100%;
    animation: syncProgressBar 1.5s ease infinite;
    z-index: 9999;
    pointer-events: none;
}

@keyframes syncProgressBar {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}

.cloud-user {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
}

.cloud-user-icon {
    width: 28px;
    height: 28px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75rem;
}

/* Login Modal Styles */
.login-form-container {
    text-align: center;
}

.login-logo {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 20px;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
}

.login-tabs {
    display: flex;
    margin-bottom: 20px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    padding: 4px;
}

.login-tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    border-radius: 8px;
    transition: var(--transition);
}

.login-tab.active {
    background: var(--bg-card);
    color: var(--primary);
}

.login-form-fields {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.login-input-group {
    position: relative;
}

.login-input-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: var(--text-muted);
}

.login-input {
    width: 100%;
    padding: 14px 14px 14px 44px;
    background: var(--bg-secondary);
    border: 2px solid transparent;
    border-radius: var(--radius);
    color: var(--text-primary);
    font-size: 1rem;
}

.login-input:focus {
    outline: none;
    border-color: var(--primary);
}

.login-submit {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
}

.login-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.login-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.login-divider::before,
.login-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
}

.login-info {
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.login-info strong {
    color: var(--text-primary);
}

/* Google Login Button */
.google-login-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 12px 20px;
    background: white;
    border: 1px solid #dadce0;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    color: #3c4043;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.google-login-btn:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

.google-login-btn:active {
    background: #f1f3f4;
}

/* Dark mode */
.theme-dark .google-login-btn {
    background: #2d2d2d;
    border-color: #5f6368;
    color: #e8eaed;
}

.theme-dark .google-login-btn:hover {
    background: #3c3c3c;
}

/* ============================================
   LOGIN SCREEN (Obbligatorio all'avvio)
   ============================================ */

.login-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
}

.login-screen-content {
    text-align: center;
    max-width: 400px;
    width: 100%;
}

.login-screen-logo {
    font-size: 5rem;
    margin-bottom: 16px;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.login-screen-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.login-screen-subtitle {
    font-size: 1rem;
    color: rgba(255,255,255,0.85);
    margin: 0 0 32px 0;
}

.login-screen-box {
    background: white;
    border-radius: 20px;
    padding: 32px 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.google-login-btn-large {
    padding: 16px 24px;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: 12px;
}

.login-screen-features {
    margin-top: 24px;
    text-align: left;
}

.login-feature {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    color: #555;
    font-size: 0.9rem;
}

.login-feature-icon {
    font-size: 1.2rem;
}

.login-screen-footer {
    margin-top: 24px;
}

.login-screen-footer p {
    color: rgba(255,255,255,0.7);
    font-size: 0.8rem;
}

/* Loading state */
.login-screen.loading .google-login-btn-large {
    opacity: 0.7;
    pointer-events: none;
}

.login-screen.loading .google-login-btn-large::after {
    content: '...';
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
}

/* Hide login screen when logged in */
.login-screen.hidden {
    display: none;
}

/* ============================================
   SEARCH MODAL STYLES
   ============================================ */

.search-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.search-filters .chip {
    padding: 6px 12px;
    background: var(--bg-secondary);
    border: none;
    border-radius: 20px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition);
}

.search-filters .chip.active {
    background: var(--primary);
    color: white;
}

.search-results-list {
    max-height: 400px;
    overflow-y: auto;
}

.search-result-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    margin-bottom: 8px;
    cursor: pointer;
    transition: var(--transition);
}

.search-result-item:hover {
    background: var(--border);
}

.search-result-icon {
    font-size: 1.5rem;
    width: 40px;
    text-align: center;
}

.search-result-content {
    flex: 1;
}

.search-result-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.search-result-meta {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.search-result-type {
    display: inline-block;
    padding: 2px 8px;
    background: var(--primary);
    color: white;
    border-radius: 10px;
    font-size: 0.7rem;
    margin-left: 8px;
}

/* ============================================
   PROFILE MODAL STYLES
   ============================================ */

.profile-avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 auto;
    cursor: pointer;
    transition: var(--transition);
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
}

.profile-avatar-large:hover {
    transform: scale(1.05);
}

.profile-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* ============================================
   GUIDED MODE & ONBOARDING
   ============================================ */

.guided-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 3000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    box-sizing: border-box;
}

.guided-overlay.active {
    display: flex;
}

.guided-card {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: 24px;
    max-width: calc(100vw - 32px);
    max-height: calc(100vh - 120px);
    width: 100%;
    text-align: center;
    animation: guidedPop 0.4s ease;
    position: relative;
    overflow-y: auto;
    margin: auto;
}

@keyframes guidedPop {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.guided-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    animation: guidedBounce 2s ease infinite;
}

@keyframes guidedBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.guided-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-primary);
}

.guided-text {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
}

.guided-progress {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 24px;
}

.guided-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--border);
    transition: var(--transition);
}

.guided-dot.active {
    background: var(--primary);
    transform: scale(1.2);
}

.guided-dot.completed {
    background: var(--success);
}

.guided-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.guided-skip {
    color: var(--text-muted);
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 12px 20px;
}

.guided-skip:hover {
    color: var(--text-secondary);
}

/* Spotlight Effect */
.spotlight-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 2500;
    pointer-events: none;
    display: none;
}

.spotlight-overlay.active {
    display: block;
}

.spotlight-highlight {
    position: absolute;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
    border-radius: var(--radius);
    pointer-events: auto;
    animation: spotlightPulse 2s ease infinite;
}

@keyframes spotlightPulse {
    0%, 100% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 0 4px var(--primary); }
    50% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 0 8px var(--primary-light); }
}

.spotlight-tooltip {
    position: fixed;
    background: var(--bg-card);
    padding: 16px 20px;
    border-radius: var(--radius-lg);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    max-width: calc(100vw - 32px);
    width: 280px;
    pointer-events: auto;
    z-index: 2600;
    left: 50% !important;
    transform: translateX(-50%);
    box-sizing: border-box;
    border: 2px solid var(--primary);
}

/* Nessuna freccetta - il tooltip è centrato sullo schermo */

.spotlight-tooltip-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.spotlight-tooltip-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 12px;
}

/* Onboarding Checklist */
.onboarding-checklist {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: var(--spacing);
    color: white;
}

.onboarding-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.onboarding-title {
    font-weight: 700;
    font-size: 1.1rem;
}

.onboarding-progress-text {
    font-size: 0.85rem;
    opacity: 0.9;
}

.onboarding-progress-bar {
    height: 6px;
    background: rgba(255,255,255,0.3);
    border-radius: 3px;
    margin-bottom: 16px;
    overflow: hidden;
}

.onboarding-progress-fill {
    height: 100%;
    background: white;
    border-radius: 3px;
    transition: width 0.5s ease;
}

.onboarding-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.onboarding-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: rgba(255,255,255,0.15);
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
}

.onboarding-item:hover {
    background: rgba(255,255,255,0.25);
}

.onboarding-item.completed {
    opacity: 0.7;
}

.onboarding-check {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    flex-shrink: 0;
}

.onboarding-item.completed .onboarding-check {
    background: white;
    color: var(--primary);
    border-color: white;
}

.onboarding-item-text {
    flex: 1;
    font-size: 0.95rem;
}

.onboarding-item-action {
    font-size: 1.2rem;
}

/* Contextual Tips */
.contextual-tip {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 1px solid #bae6fd;
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: var(--spacing);
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.theme-dark .contextual-tip {
    background: linear-gradient(135deg, #1e3a5f, #1e293b);
    border-color: #3b82f6;
}

.contextual-tip-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.contextual-tip-content {
    flex: 1;
}

.contextual-tip-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: #0369a1;
}

.theme-dark .contextual-tip-title {
    color: #60a5fa;
}

.contextual-tip-text {
    font-size: 0.9rem;
    color: #0c4a6e;
    line-height: 1.5;
}

.theme-dark .contextual-tip-text {
    color: #93c5fd;
}

.contextual-tip-dismiss {
    background: transparent;
    border: none;
    color: #0369a1;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 4px;
}

/* ============================================
   BOOKS & READING TRACKER
   ============================================ */

.book-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border-light);
    display: flex;
    gap: 16px;
}

.book-cover {
    width: 60px;
    height: 90px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    flex-shrink: 0;
}

.book-info {
    flex: 1;
    min-width: 0;
}

.book-title {
    font-weight: 700;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.book-author {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.book-progress {
    display: flex;
    align-items: center;
    gap: 8px;
}

.book-progress-bar {
    flex: 1;
    height: 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    overflow: hidden;
}

.book-progress-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.book-progress-text {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--primary);
    min-width: 40px;
    text-align: right;
}

/* Recommended Books Section */
.book-categories-filter {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 12px;
    margin-bottom: 16px;
    -webkit-overflow-scrolling: touch;
}

.book-categories-filter::-webkit-scrollbar {
    display: none;
}

.book-category-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
    cursor: pointer;
    transition: var(--transition);
}

.book-category-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.book-category-btn:hover:not(.active) {
    background: var(--bg-secondary);
}

.recommended-book-card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
}

.recommended-book-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.recommended-book-card.book-of-month {
    border: 2px solid var(--accent);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.1));
}

.recommended-book-header {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}

.recommended-book-cover {
    width: 70px;
    height: 100px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    flex-shrink: 0;
    position: relative;
}

.recommended-book-cover.productivity { background: linear-gradient(135deg, #6366f1, #4f46e5); }
.recommended-book-cover.mindset { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.recommended-book-cover.business { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
.recommended-book-cover.finance { background: linear-gradient(135deg, #10b981, #059669); }
.recommended-book-cover.motivation { background: linear-gradient(135deg, #f59e0b, #d97706); }
.recommended-book-cover.communication { background: linear-gradient(135deg, #ec4899, #db2777); }
.recommended-book-cover.wellbeing { background: linear-gradient(135deg, #14b8a6, #0d9488); }

.book-of-month-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--accent);
    color: white;
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 700;
}

.recommended-book-info {
    flex: 1;
    min-width: 0;
}

.recommended-book-title {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 4px;
    color: var(--text-primary);
}

.recommended-book-author {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.recommended-book-category {
    display: inline-block;
    padding: 3px 10px;
    background: var(--bg-secondary);
    border-radius: 12px;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 600;
}

.recommended-book-summary {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 12px;
}

.recommended-book-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.book-action-btn {
    padding: 8px 14px;
    border-radius: var(--radius-sm);
    border: none;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
}

.book-action-btn.primary {
    background: var(--primary);
    color: white;
}

.book-action-btn.primary:hover {
    background: var(--primary-dark);
}

.book-action-btn.secondary {
    background: var(--bg-secondary);
    color: var(--text-secondary);
}

.book-action-btn.secondary:hover {
    background: var(--border);
}

.book-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.book-status-badge.reading {
    background: rgba(99, 102, 241, 0.15);
    color: var(--primary);
}

.book-status-badge.completed {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

.book-status-badge.wishlist {
    background: rgba(245, 158, 11, 0.15);
    color: var(--accent);
}

/* Book Detail Modal */
.book-detail-cover {
    width: 120px;
    height: 180px;
    margin: 0 auto 20px;
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
}

.book-detail-title {
    font-size: 1.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 4px;
}

.book-detail-author {
    text-align: center;
    color: var(--text-secondary);
    margin-bottom: 16px;
}

.book-detail-summary {
    background: var(--bg-secondary);
    padding: 16px;
    border-radius: var(--radius);
    margin-bottom: 16px;
    line-height: 1.6;
    font-size: 0.95rem;
}

.book-buy-links {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 16px;
}

.book-buy-btn {
    padding: 12px 20px;
    border-radius: var(--radius);
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}

.book-buy-btn.amazon {
    background: #FF9900;
    color: #232F3E;
}

.book-buy-btn.amazon:hover {
    background: #FFB84D;
}

.book-buy-btn.ibs {
    background: #E31E24;
    color: white;
}

.book-buy-btn.ibs:hover {
    background: #FF4146;
}

/* ============================================
   ADVANCED ANALYTICS
   ============================================ */

.heatmap-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 12px;
}

.heatmap-cell {
    aspect-ratio: 1;
    border-radius: 4px;
    background: var(--bg-secondary);
    position: relative;
    cursor: pointer;
    transition: transform 0.2s;
}

.heatmap-cell:hover {
    transform: scale(1.1);
}

.heatmap-cell.level-1 { background: rgba(99, 102, 241, 0.2); }
.heatmap-cell.level-2 { background: rgba(99, 102, 241, 0.4); }
.heatmap-cell.level-3 { background: rgba(99, 102, 241, 0.6); }
.heatmap-cell.level-4 { background: rgba(99, 102, 241, 0.8); }
.heatmap-cell.level-5 { background: var(--primary); }

.heatmap-labels {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 8px;
    font-size: 0.65rem;
    color: var(--text-muted);
    text-align: center;
}

.correlation-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    margin-bottom: 8px;
}

.correlation-icon {
    font-size: 1.5rem;
}

.correlation-text {
    flex: 1;
    font-size: 0.9rem;
}

.correlation-value {
    font-weight: 700;
    color: var(--success);
}

.correlation-value.negative {
    color: var(--danger);
}

/* ============================================
   CHALLENGES & ACHIEVEMENTS
   ============================================ */

.challenge-card {
    background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 12px;
    border: 2px solid var(--border-light);
    position: relative;
    overflow: hidden;
}

.challenge-card.active {
    border-color: var(--primary);
}

.challenge-card.completed {
    border-color: var(--success);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
}

.challenge-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
}

.challenge-badge.daily { background: var(--info); color: white; }
.challenge-badge.weekly { background: var(--primary); color: white; }
.challenge-badge.monthly { background: var(--accent); color: white; }

.challenge-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.challenge-desc {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 12px;
}

.challenge-progress {
    display: flex;
    align-items: center;
    gap: 12px;
}

.challenge-bar {
    flex: 1;
    height: 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    overflow: hidden;
}

.challenge-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--primary-light));
    border-radius: 4px;
    transition: width 0.5s ease;
}

.challenge-reward {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--accent);
}

.achievement-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}

.achievement-item {
    text-align: center;
    padding: 16px 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    transition: var(--transition);
}

.achievement-item.unlocked {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
}

.achievement-item.locked {
    opacity: 0.5;
    filter: grayscale(1);
}

.achievement-icon {
    font-size: 2rem;
    margin-bottom: 8px;
}

.achievement-name {
    font-size: 0.7rem;
    font-weight: 600;
}

/* ============================================
   AMBIENT SOUNDS
   ============================================ */

.sound-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
}

.sound-btn {
    aspect-ratio: 1;
    border: none;
    border-radius: var(--radius);
    background: var(--bg-secondary);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.sound-btn:hover {
    background: var(--border);
}

.sound-btn.active {
    background: var(--primary);
    color: white;
}

.sound-btn .sound-icon {
    font-size: 1.8rem;
}

.sound-btn .sound-label {
    font-size: 0.7rem;
    font-weight: 600;
}

.volume-slider {
    width: 100%;
    margin-top: 16px;
}

/* ============================================
   ENERGY TRACKER
   ============================================ */

.energy-meter {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin: 16px 0;
}

.energy-level {
    width: 40px;
    height: 60px;
    border-radius: 20px;
    background: var(--bg-secondary);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: flex-end;
    justify-content: center;
    overflow: hidden;
}

.energy-level:hover {
    transform: scale(1.05);
}

.energy-level.active {
    background: linear-gradient(to top, var(--success), var(--primary));
}

.energy-level.low { background: linear-gradient(to top, var(--danger), var(--warning)); }
.energy-level.medium { background: linear-gradient(to top, var(--warning), var(--accent)); }
.energy-level.high { background: linear-gradient(to top, var(--success), var(--secondary)); }

/* ============================================
   BREAK REMINDERS
   ============================================ */

.break-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.5s ease;
}

.break-overlay.active {
    opacity: 1;
    visibility: visible;
}

.break-icon {
    font-size: 5rem;
    margin-bottom: 24px;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.break-title {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 12px;
}

.break-message {
    font-size: 1.1rem;
    opacity: 0.8;
    margin-bottom: 32px;
    max-width: 300px;
}

.break-timer {
    font-size: 3rem;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
    margin-bottom: 24px;
}

/* ============================================
   QUICK CAPTURE
   ============================================ */

.quick-capture-fab {
    position: fixed;
    bottom: calc(160px + env(safe-area-inset-bottom));
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f59e0b, #f97316);
    color: white;
    border: none;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    font-size: 1.3rem;
    z-index: 99;
    transition: var(--transition);
}

.quick-capture-fab:hover {
    transform: scale(1.1);
    background: var(--primary-dark);
}

/* ============================================
   TAGS
   ============================================ */

.tag-input-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    min-height: 44px;
    align-items: center;
}

.tag-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--primary);
    color: white;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.tag-pill .tag-remove {
    cursor: pointer;
    opacity: 0.7;
    margin-left: 4px;
}

.tag-pill .tag-remove:hover {
    opacity: 1;
}

.tag-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.tag-suggestion {
    padding: 4px 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: var(--transition);
}

.tag-suggestion:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ============================================
   RECURRING TASKS
   ============================================ */

.recurrence-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: var(--info);
    color: white;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 600;
}

/* ============================================
   DO NOT DISTURB MODE
   ============================================ */

.dnd-mode .bottom-nav,
.dnd-mode .header,
.dnd-mode .quick-capture-fab {
    display: none !important;
}

.dnd-mode .page {
    padding: 0;
    max-width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--bg-primary);
}

.dnd-mode .focus-hero {
    transform: scale(1.3);
}

/* ============================================
   SMART SUGGESTIONS
   ============================================ */

.suggestion-card {
    background: linear-gradient(135deg, var(--info), var(--primary));
    color: white;
    border-radius: var(--radius-lg);
    padding: 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: var(--transition);
}

.suggestion-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.suggestion-title {
    font-weight: 600;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.suggestion-desc {
    font-size: 0.85rem;
    opacity: 0.9;
}

/* ============================================
   GOOGLE CALENDAR & TASKS INTEGRATION
   ============================================ */

.google-connect-card {
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    border-radius: var(--radius-lg);
    padding: 20px;
    color: white;
    margin-bottom: 16px;
}

.google-connect-card .card-title {
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
}

.google-connect-btn {
    background: white;
    color: #4285f4;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    transition: all 0.2s;
}

.google-connect-btn:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.google-connect-btn img {
    width: 20px;
    height: 20px;
}

.calendar-events-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.calendar-event-item {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 14px;
    border-left: 4px solid var(--primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-event-item.past {
    opacity: 0.6;
    border-left-color: var(--text-muted);
}

/* Evento rifiutato - barrato */
.calendar-event-item.declined {
    opacity: 0.5;
    border-left-color: var(--danger);
    background: rgba(239, 68, 68, 0.05);
}

.calendar-event-item.declined .calendar-event-title {
    text-decoration: line-through;
    color: var(--text-muted);
}

.calendar-event-item.declined::after {
    content: '✗ Rifiutato';
    font-size: 0.7rem;
    color: var(--danger);
    background: rgba(239, 68, 68, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
}

.calendar-event-time {
    font-size: 0.85rem;
    color: var(--primary);
    font-weight: 600;
    min-width: 60px;
}

.calendar-event-title {
    flex: 1;
    font-weight: 500;
    margin-left: 12px;
}

.calendar-event-calendar {
    font-size: 0.75rem;
    color: var(--text-muted);
    background: var(--bg-secondary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
}

.calendar-selector {
    margin-bottom: 16px;
}

.calendar-selector select {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: 1rem;
}

.smart-scheduler-card {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: var(--radius-lg);
    padding: 20px;
    color: white;
    margin-top: 16px;
}

.scheduler-config {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-top: 12px;
}

.time-slot-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
}

.time-slot-row:last-child {
    border-bottom: none;
}

.time-slot-day {
    font-weight: 500;
    min-width: 80px;
}

.time-slot-inputs {
    display: flex;
    align-items: center;
    gap: 8px;
}

.time-slot-inputs input[type="time"] {
    padding: 8px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.auto-schedule-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 1rem;
}

.auto-schedule-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.task-sync-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.task-sync-indicator.synced {
    color: var(--success);
}

.energy-preference {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
}

.energy-chip {
    padding: 8px 14px;
    border-radius: 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.energy-chip.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.no-events-message {
    text-align: center;
    padding: 30px;
    color: var(--text-muted);
}

.no-events-message .icon {
    font-size: 3rem;
    margin-bottom: 10px;
}

/* ============================================
   DIVISIONE VITA / LAVORO
   ============================================ */

:root {
    --work-color: #f59e0b;
    --personal-color: #10b981;
}

.department-switcher {
    display: flex;
    gap: 8px;
    padding: 12px;
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
}

.dept-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    background: transparent;
    color: var(--text-secondary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.dept-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.dept-btn[data-dept="all"].active {
    background: linear-gradient(135deg, var(--personal-color), var(--work-color));
    border-color: transparent;
    color: white;
}

.dept-btn[data-dept="personal"].active {
    background: var(--personal-color);
    border-color: var(--personal-color);
    color: white;
}

.dept-btn[data-dept="work"].active {
    background: var(--work-color);
    border-color: var(--work-color);
    color: white;
}

.dept-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}

.dept-indicator.work { background: var(--work-color); }
.dept-indicator.personal { background: var(--personal-color); }

/* Department selector buttons in forms */
.dept-select-btn {
    flex: 1;
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.dept-select-btn:hover {
    border-color: var(--primary);
}

.dept-select-btn.active[data-dept="personal"] {
    background: var(--personal-color);
    border-color: var(--personal-color);
    color: white;
}

.dept-select-btn.active[data-dept="work"] {
    background: var(--work-color);
    border-color: var(--work-color);
    color: white;
}

.dept-tag {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.dept-tag.work {
    background: rgba(245, 158, 11, 0.15);
    color: var(--work-color);
}

.dept-tag.personal {
    background: rgba(16, 185, 129, 0.15);
    color: var(--personal-color);
}

.stats-dual-column {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.stat-column {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 16px;
}

.stat-column.work {
    border-top: 3px solid var(--work-color);
}

.stat-column.personal {
    border-top: 3px solid var(--personal-color);
}

.stat-column-title {
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.balance-bar {
    background: var(--bg-secondary);
    border-radius: 20px;
    height: 24px;
    overflow: hidden;
    display: flex;
    margin: 12px 0;
}

.balance-work {
    background: var(--work-color);
    height: 100%;
    transition: width 0.5s ease;
}

.balance-personal {
    background: var(--personal-color);
    height: 100%;
    transition: width 0.5s ease;
}

/* Stats Split Container */
.stats-split-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

.stats-split-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 14px;
}

.stats-split-card.dept-work {
    border-left: 4px solid var(--work-color);
}

.stats-split-card.dept-personal {
    border-left: 4px solid var(--personal-color);
}

.stats-split-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
}

.stats-split-icon {
    font-size: 1.2rem;
}

.stats-split-title {
    font-weight: 700;
    font-size: 0.85rem;
    color: var(--text-primary);
}

.stats-split-items {
    display: flex;
    justify-content: space-between;
    gap: 8px;
}

.stats-split-item {
    text-align: center;
    flex: 1;
}

.stats-split-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    display: block;
}

.stats-split-label {
    font-size: 0.7rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Dept Badge for lists */
.dept-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 8px;
}

.dept-badge-work {
    background: rgba(245, 158, 11, 0.15);
}

.dept-badge-personal {
    background: rgba(16, 185, 129, 0.15);
}

/* ============================================
   SKILLS PER ANIMATORI
   ============================================ */

.skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
}

.skill-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.skill-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
}

.skill-card.performance { border-color: #ef4444; }
.skill-card.technique { border-color: #8b5cf6; }
.skill-card.business { border-color: #3b82f6; }

.skill-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.skill-name {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.skill-level {
    font-size: 1.1rem;
    margin-bottom: 8px;
    letter-spacing: 2px;
}

.skill-progress-bar {
    background: var(--bg-secondary);
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin-bottom: 6px;
}

.skill-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 10px;
    transition: width 0.5s ease;
}

.skill-xp {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.skill-category-filter {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    overflow-x: auto;
    padding-bottom: 8px;
}

.skill-category-btn {
    padding: 8px 16px;
    border-radius: 20px;
    border: 2px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}

.skill-category-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.skill-category-btn.performance.active { background: #ef4444; border-color: #ef4444; }
.skill-category-btn.technique.active { background: #8b5cf6; border-color: #8b5cf6; }
.skill-category-btn.business.active { background: #3b82f6; border-color: #3b82f6; }

.practice-btn {
    background: linear-gradient(135deg, var(--success), #059669);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
    transition: all 0.2s;
}

.practice-btn:hover {
    transform: scale(1.02);
}

/* ============================================
   TEAM ALIGNMENT MAP
   ============================================ */

.team-project-header {
    background: linear-gradient(135deg, var(--primary), #8b5cf6);
    border-radius: var(--radius-lg);
    padding: 20px;
    color: white;
    margin-bottom: 16px;
}

.team-project-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.team-project-meta {
    display: flex;
    gap: 16px;
    font-size: 0.9rem;
    opacity: 0.9;
}

.team-kanban {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

@media (max-width: 768px) {
    .team-kanban {
        grid-template-columns: 1fr;
    }

    /* ===== GESTIONE TASTIERA VIRTUALE MOBILE ===== */
    /* Previene il resize della viewport quando la tastiera è aperta */
    html {
        height: 100%;
        overflow: hidden;
    }

    body {
        height: 100%;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Modal che si adattano alla tastiera */
    .modal-content {
        max-height: 85vh;
        max-height: 85dvh; /* dynamic viewport height */
        overflow-y: auto;
        transition: max-height 0.3s ease;
    }

    /* Quando un input è in focus, assicura visibilità */
    input:focus,
    textarea:focus {
        position: relative;
        z-index: 10;
    }

    /* Padding extra in fondo ai form per la tastiera */
    .modal-body {
        padding-bottom: 20px;
    }

    /* Fix per commenti in fondo al modal */
    #eventCommentsSection,
    .comments-section {
        scroll-margin-bottom: 100px;
    }

    /* Textarea commenti più compatta su mobile */
    #newEventComment {
        min-height: 60px;
    }
}

.team-kanban-column {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: 12px;
    min-height: 200px;
}

.team-kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--border);
}

.team-kanban-title {
    font-weight: 700;
    font-size: 0.9rem;
}

.team-kanban-count {
    background: var(--primary);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
}

.team-task-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 12px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.2s;
    border-left: 3px solid var(--primary);
}

.team-task-card:hover {
    box-shadow: var(--shadow-md);
}

.team-task-card.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.team-task-title {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.team-task-assignee {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.team-task-assignee-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
}

.team-task-badges {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.team-task-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 8px;
    background: var(--bg-secondary);
}

.team-task-badge.resource { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
.team-task-badge.problem { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

/* Team Kanban Task Cards */
.team-kanban-tasks {
    min-height: 100px;
}

.kanban-task {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 12px;
    margin-bottom: 8px;
    cursor: grab;
    transition: all 0.2s;
    border-left: 3px solid var(--primary);
}

.kanban-task:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.kanban-task.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.kanban-task-title {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.kanban-task-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.kanban-assignee {
    display: flex;
    align-items: center;
}

.kanban-warning {
    animation: pulse 1s infinite;
}

.kanban-comments {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 2px;
}

/* Assignees Checklist */
.assignees-checklist {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    max-height: 120px;
    overflow-y: auto;
}

.assignee-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.assignee-checkbox:hover {
    background: var(--bg-hover);
}

.assignee-checkbox.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
}

.assignee-checkbox input {
    display: none;
}

.assignee-avatar-mini {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: white;
}

.assignee-name {
    font-size: 0.85rem;
    font-weight: 500;
}

/* Task Card Assignees Display */
.task-assignees {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 6px;
}

.task-assignee-chip {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    background: var(--bg-secondary);
    border-radius: 12px;
    font-size: 0.7rem;
}

.task-assignee-chip .mini-avatar {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.5rem;
    color: white;
}

/* Task Deadline Badge */
.task-deadline-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 8px;
    background: rgba(59, 130, 246, 0.15);
    color: #3b82f6;
}

.task-deadline-badge.overdue {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
}

.task-deadline-badge.soon {
    background: rgba(245, 158, 11, 0.15);
    color: #f59e0b;
}

.kanban-task-actions {
    display: flex;
    gap: 4px;
    margin-top: 8px;
    justify-content: flex-end;
}

.kanban-empty {
    text-align: center;
    color: var(--text-muted);
    padding: 20px;
    font-size: 0.85rem;
}

/* Problem Card */
.problem-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 10px;
    margin-bottom: 8px;
    border-left: 3px solid var(--warning);
}

.problem-card.priority-high { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.08); }
.problem-card.priority-medium { border-left-color: var(--warning); background: rgba(245, 158, 11, 0.08); }
.problem-card.priority-low { border-left-color: var(--success); background: rgba(16, 185, 129, 0.08); }

.problem-title {
    font-weight: 500;
    font-size: 0.85rem;
    margin-bottom: 6px;
}

.problem-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Resource Card */
.resource-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 10px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.resource-icon {
    font-size: 1.2rem;
}

.resource-title {
    flex: 1;
    font-size: 0.85rem;
}

.empty-mini {
    text-align: center;
    color: var(--text-muted);
    padding: 16px;
    font-size: 0.85rem;
}

/* Event Attendees */
.attendee-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 12px 0;
}

.attendee-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    background: var(--bg-tertiary);
}

.attendee-chip.accepted { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
.attendee-chip.declined { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
.attendee-chip.tentative { background: rgba(234, 179, 8, 0.15); color: #eab308; }
.attendee-chip.pending { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }

/* Badge rifiuto negli eventi agenda */
.declined-badge {
    display: inline-block;
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 6px;
}

/* Evento con invitati che hanno rifiutato */
.agenda-event.has-declined {
    border-left-color: var(--danger);
    position: relative;
}

.agenda-event.has-declined::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--danger);
}

.attendee-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 600;
}

/* Event Comments */
.event-comments {
    margin-top: 16px;
    border-top: 1px solid var(--border);
    padding-top: 16px;
}

.comment-item {
    display: flex;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
}

.comment-item:last-child { border-bottom: none; }

.comment-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    flex-shrink: 0;
}

.comment-content {
    flex: 1;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.comment-author {
    font-weight: 600;
    font-size: 0.85rem;
}

.comment-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.comment-text {
    font-size: 0.9rem;
    line-height: 1.4;
}

.comment-text .mention {
    color: var(--primary);
    font-weight: 500;
}

.comment-input-wrapper {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    position: relative; /* Necessario per posizionamento autocomplete */
    align-items: stretch;
}

.comment-send-btn {
    flex-shrink: 0;
    white-space: nowrap;
}

.comment-input {
    flex: 1;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text);
    font-size: 0.9rem;
}

/* Mention Autocomplete - Improved positioning and interaction */
.mention-autocomplete {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 0;
    right: 0;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    max-height: 220px;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 1001;
    display: none;
    -webkit-overflow-scrolling: touch;
}

.mention-autocomplete.visible,
.mention-autocomplete[style*="display: block"] {
    display: block !important;
    animation: mentionSlideUp 0.15s ease-out;
}

@keyframes mentionSlideUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Empty state per autocomplete */
.mention-autocomplete-empty {
    padding: 16px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.85rem;
}

.mention-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.15s;
    border-bottom: 1px solid var(--border-light);
    user-select: none;
}

.mention-item:last-child {
    border-bottom: none;
}

.mention-item:hover, .mention-item.selected {
    background: var(--primary);
    color: white;
}

.mention-item:hover .mention-email,
.mention-item.selected .mention-email {
    color: rgba(255,255,255,0.8);
}

.mention-item:active {
    transform: scale(0.98);
}

.mention-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    font-weight: 600;
    flex-shrink: 0;
}

.mention-item:hover .mention-avatar,
.mention-item.selected .mention-avatar {
    background: rgba(255,255,255,0.2);
}

.mention-info {
    flex: 1;
    min-width: 0;
}

.mention-name {
    font-weight: 500;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.mention-email {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Inbox / Notifications */
.inbox-badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ef4444;
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.inbox-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: var(--bg-card);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.inbox-item:hover {
    background: var(--bg-tertiary);
}

.inbox-item.unread {
    border-left: 3px solid var(--primary);
}

.inbox-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.inbox-icon.invite { background: rgba(59, 130, 246, 0.15); }
.inbox-icon.mention { background: rgba(168, 85, 247, 0.15); }
.inbox-icon.reminder { background: rgba(234, 179, 8, 0.15); }

.inbox-content {
    flex: 1;
    min-width: 0;
}

.inbox-title {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 2px;
}

.inbox-preview {
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.inbox-time {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.inbox-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.rsvp-btn {
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
}

.rsvp-btn.accept { background: #22c55e; color: white; }
.rsvp-btn.decline { background: #ef4444; color: white; }
.rsvp-btn.maybe { background: #eab308; color: white; }

/* Team Project Header */
.team-project-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
}

.team-project-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.team-project-meta {
    display: flex;
    gap: 20px;
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Project Stats Bar */
.project-stats-bar {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin: 16px 0;
    padding: 12px;
    background: rgba(0,0,0,0.15);
    border-radius: var(--radius-md);
}

@media (max-width: 600px) {
    .project-stats-bar {
        grid-template-columns: repeat(2, 1fr);
    }
}

.project-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.project-stat-icon {
    font-size: 1.2rem;
    margin-bottom: 4px;
}

.project-stat-value {
    font-size: 1.4rem;
    font-weight: 700;
}

.project-stat-label {
    font-size: 0.7rem;
    opacity: 0.8;
    text-transform: uppercase;
}

/* Project Progress Bar */
.project-progress-container {
    width: 100%;
    height: 8px;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 12px;
}

.project-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
    border-radius: 4px;
    transition: width 0.5s ease;
}

/* Button style for avatar selection */
.member-avatar-btn.selected {
    background: var(--primary) !important;
    color: white !important;
    box-shadow: 0 0 0 2px var(--primary);
}

/* Task Comments */
.task-comments-list {
    max-height: 200px;
    overflow-y: auto;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: 8px;
}

.task-comment {
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    padding: 10px;
    margin-bottom: 8px;
}

.task-comment:last-child {
    margin-bottom: 0;
}

.task-comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.task-comment-author {
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--primary);
}

.task-comment-date {
    font-size: 0.7rem;
    color: var(--text-muted);
}

.task-comment-text {
    font-size: 0.85rem;
    line-height: 1.4;
}

.task-comment-actions {
    display: flex;
    gap: 4px;
    margin-top: 4px;
}

.no-comments {
    text-align: center;
    color: var(--text-muted);
    padding: 16px;
    font-size: 0.85rem;
}

/* Mention Tags @username */
.mention-tag {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    padding: 1px 6px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.8rem;
    cursor: pointer;
}

.mention-tag:hover {
    filter: brightness(1.1);
}

/* Autocomplete menzioni - Task comments (stili extra) */
.mention-autocomplete.show {
    display: block;
}

.mention-option.selected {
    background: var(--primary);
    color: white;
}

.mention-option.selected .mention-option-email {
    color: rgba(255,255,255,0.8);
}

.mention-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    cursor: pointer;
    transition: background 0.15s;
    border-bottom: 1px solid var(--border-light);
    user-select: none;
}

.mention-option:last-child {
    border-bottom: none;
}

.mention-option:active {
    transform: scale(0.98);
}

.mention-option:hover {
    background: var(--bg-secondary);
}

.mention-option-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
}

.mention-option-name {
    font-size: 0.85rem;
}

.mention-option-email {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* Collaborators List */
.collaborators-list {
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    padding: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.collaborator-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
}

.collaborator-item:last-child {
    margin-bottom: 0;
}

.collaborator-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.collaborator-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: white;
}

.collaborator-details {
    display: flex;
    flex-direction: column;
}

.collaborator-email {
    font-weight: 500;
    font-size: 0.9rem;
}

.collaborator-role {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.collaborator-actions {
    display: flex;
    gap: 4px;
    align-items: center;
}

.permission-badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
}

.permission-badge.editor {
    background: rgba(99, 102, 241, 0.15);
    color: var(--primary);
}

.permission-badge.viewer {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

.permission-badge.owner {
    background: rgba(245, 158, 11, 0.15);
    color: var(--warning);
}

.no-collaborators {
    text-align: center;
    color: var(--text-muted);
    padding: 20px;
    font-size: 0.85rem;
}

/* User Search Results */
.user-search-result {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.15s ease;
    border: 1px solid transparent;
}

.user-search-result:hover {
    background: var(--bg-tertiary);
    border-color: var(--accent);
}

.user-search-result:last-child {
    margin-bottom: 0;
}

.user-result-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    flex-shrink: 0;
}

.user-result-info {
    flex: 1;
    min-width: 0;
}

.user-result-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
}

.user-result-email {
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-result-profession {
    font-size: 0.75rem;
    color: var(--accent);
    margin-top: 2px;
}

.skill-tag-mini {
    display: inline-block;
    padding: 2px 6px;
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
    border-radius: 8px;
    font-size: 0.65rem;
    margin-right: 4px;
}

/* Team Members Quick Select */
.team-member-quick-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
}

.team-member-quick-btn:hover {
    background: var(--bg-tertiary);
    border-color: var(--accent);
    transform: translateY(-2px);
}

.quick-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.85rem;
}

.quick-name {
    font-size: 0.75rem;
    color: var(--text-secondary);
    max-width: 60px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Spinner small for loading */
.spinner-small {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.team-sidebar {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

@media (max-width: 768px) {
    .team-sidebar {
        grid-template-columns: 1fr;
    }
}

.team-sidebar-card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 16px;
}

.team-sidebar-title {
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.team-problem-item {
    padding: 10px;
    background: rgba(239, 68, 68, 0.1);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
    border-left: 3px solid #ef4444;
}

.team-problem-item.low { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }

.team-resource-item {
    padding: 10px;
    background: rgba(59, 130, 246, 0.1);
    border-radius: var(--radius-md);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.team-members-grid {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 8px;
}

.team-member-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: var(--bg-secondary);
    border-radius: 20px;
    white-space: nowrap;
}

.team-member-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

/* Team Member Cards - Vista migliorata */
.team-member-card {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--bg-card);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
    border: 1px solid var(--border);
}

.team-member-card:hover {
    background: var(--bg-tertiary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.member-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    flex-shrink: 0;
}

.member-info {
    flex: 1;
    min-width: 0;
}

.member-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.member-team-badge {
    display: inline-block;
    font-size: 0.7rem;
    color: var(--text-muted);
    background: var(--bg-secondary);
    padding: 2px 6px;
    border-radius: 8px;
    margin-top: 2px;
}

/* Grid per membri del team */
#teamMembersGrid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.add-team-btn {
    background: linear-gradient(135deg, var(--secondary), #0d9488);
    color: white;
    border: none;
    padding: 12px;
    border-radius: var(--radius-md);
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}

.add-team-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* ============================================
   CALENDARIO AVANZATO
   ============================================ */

.calendar-view-btns {
    display: flex;
    gap: 4px;
}

.cal-view-btn {
    padding: 4px 10px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: all 0.2s;
}

.cal-view-btn.active {
    background: var(--primary);
    color: white;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 8px 0;
}

.cal-nav-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 1.2rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.cal-nav-btn:hover {
    background: var(--primary);
    color: white;
}

.cal-nav-date {
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    padding: 4px 12px;
    border-radius: var(--radius-sm);
    transition: background 0.2s;
}

.cal-nav-date:hover {
    background: var(--bg-secondary);
}

/* Day View */
.calendar-day-view {
    max-height: 300px;
    overflow-y: auto;
}

.day-timeline {
    position: relative;
}

.day-hour-slot {
    display: flex;
    align-items: flex-start;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    min-height: 50px;
}

.day-hour-slot.has-events {
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    margin: 2px 0;
    padding: 8px;
}

.day-hour-label {
    width: 50px;
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 600;
    flex-shrink: 0;
}

.day-hour-events {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.day-event {
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    cursor: pointer;
    transition: transform 0.2s;
}

.day-event:hover {
    transform: scale(1.02);
}

.day-event.show { background: linear-gradient(135deg, #f59e0b20, #f59e0b10); border-left: 3px solid #f59e0b; }
.day-event.rehearsal { background: linear-gradient(135deg, #8b5cf620, #8b5cf610); border-left: 3px solid #8b5cf6; }
.day-event.meeting { background: linear-gradient(135deg, #3b82f620, #3b82f610); border-left: 3px solid #3b82f6; }
.day-event.personal { background: linear-gradient(135deg, #10b98120, #10b98110); border-left: 3px solid #10b981; }
.day-event.other { background: linear-gradient(135deg, #6b728020, #6b728010); border-left: 3px solid #6b7280; }
.day-event.google { background: linear-gradient(135deg, #4285f420, #4285f410); border-left: 3px solid #4285f4; }

.day-event-title {
    font-weight: 600;
    margin-bottom: 2px;
}

.day-event-time {
    font-size: 0.75rem;
    opacity: 0.8;
}

/* Week View */
.calendar-week-view {
    overflow-x: auto;
}

.week-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 8px;
    text-align: center;
}

.week-header-day {
    padding: 8px 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
}

.week-header-day.today {
    background: var(--primary);
    color: white;
    border-radius: var(--radius-sm);
}

.week-header-day.has-events {
    position: relative;
}

.week-header-day.has-events::after {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background: var(--primary);
    border-radius: 50%;
}

.week-header-day.today.has-events::after {
    background: white;
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.week-day-cell {
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    padding: 8px;
    min-height: 80px;
    cursor: pointer;
    transition: all 0.2s;
}

.week-day-cell:hover {
    background: var(--bg-tertiary);
}

.week-day-cell.today {
    border: 2px solid var(--primary);
}

.week-day-number {
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: 4px;
}

.week-day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.week-event-dot {
    font-size: 0.65rem;
    padding: 2px 4px;
    border-radius: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Month View */
.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.month-day-cell {
    aspect-ratio: 1;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    padding: 4px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.8rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 2px;
}

.month-day-cell:hover {
    background: var(--bg-tertiary);
}

.month-day-cell.today {
    background: var(--primary);
    color: white;
}

.month-day-cell.other-month {
    opacity: 0.4;
}

.month-day-cell.has-events {
    font-weight: 600;
}

/* Pallini eventi nella vista mese */
.event-dots {
    display: flex;
    gap: 2px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    max-width: 100%;
}

.event-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
}

.event-more {
    font-size: 0.6rem;
    color: var(--text-muted);
    margin-left: 1px;
}

/* Agenda View */
.calendar-agenda-view {
    max-height: 400px;
    overflow-y: auto;
}

.agenda-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.agenda-day-group {
    margin-bottom: 16px;
}

.agenda-day-header {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--primary);
    padding: 8px 0;
    border-bottom: 2px solid var(--primary);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.agenda-day-header.today {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    border-bottom: none;
}

.agenda-event {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid var(--primary);
}

.agenda-event:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow);
}

.agenda-event.google {
    border-left-color: #4285f4;
}

.agenda-event.show { border-left-color: #f59e0b; }
.agenda-event.rehearsal { border-left-color: #8b5cf6; }
.agenda-event.meeting { border-left-color: #3b82f6; }
.agenda-event.personal { border-left-color: #10b981; }

/* Task provvisori (stile Reclaim.ai) */
.agenda-event.task-tentative {
    border-left-color: #8b5cf6;
    background: repeating-linear-gradient(
        -45deg,
        var(--bg-secondary),
        var(--bg-secondary) 5px,
        rgba(139, 92, 246, 0.1) 5px,
        rgba(139, 92, 246, 0.1) 10px
    );
    opacity: 0.85;
}

.agenda-event.task-tentative:hover {
    opacity: 1;
}

.agenda-event.task-tentative .agenda-event-title::before {
    content: '🎯 ';
}

.agenda-event.task-scheduled {
    border-left-color: #6366f1;
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
}

/* Habits nel calendario */
.agenda-event.habit {
    border-left-color: #10b981;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
}

.agenda-event.habit .agenda-event-title::before {
    content: '✨ ';
}

/* Buffer time */
.agenda-event.buffer {
    border-left-color: #94a3b8;
    background: var(--bg-secondary);
    opacity: 0.6;
    font-style: italic;
}

/* Badge per tipo evento */
.agenda-event-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-left: 8px;
}

.badge-tentative {
    background: rgba(139, 92, 246, 0.2);
    color: #8b5cf6;
}

.badge-scheduled {
    background: rgba(99, 102, 241, 0.2);
    color: #6366f1;
}

.badge-habit {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

/* Drag & Drop per Kanban/Matrix */
.task-card[draggable="true"] {
    cursor: grab;
}

.task-card[draggable="true"]:active {
    cursor: grabbing;
}

.task-card.dragging {
    opacity: 0.5;
    transform: rotate(3deg);
}

.kanban-column.drag-over,
.matrix-quadrant.drag-over,
.touch-drag-over {
    background: rgba(99, 102, 241, 0.15) !important;
    border: 2px dashed var(--primary) !important;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Touch drag clone styling */
.touch-drag-clone {
    border-radius: 12px;
    background: var(--card-bg);
}

/* Team kanban column touch drag */
.team-kanban-column.touch-drag-over {
    background: rgba(99, 102, 241, 0.15) !important;
    border: 2px dashed var(--primary) !important;
}

/* Prevent text selection during drag */
.dragging, .touch-drag-clone {
    user-select: none;
    -webkit-user-select: none;
}

.drop-indicator {
    height: 4px;
    background: var(--primary);
    border-radius: 2px;
    margin: 4px 0;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

/* ============================================
   UNDO TOAST & ANIMATIONS
   ============================================ */

@keyframes slideUp {
    from { transform: translateX(-50%) translateY(100px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

@keyframes slideDown {
    from { transform: translateX(-50%) translateY(0); opacity: 1; }
    to { transform: translateX(-50%) translateY(100px); opacity: 0; }
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.undo-toast {
    animation: slideUp 0.3s ease forwards;
}

.undo-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.undo-btn:hover {
    background: var(--primary-dark);
}

/* Spinner inline per bottoni */
.spinner-inline {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

/* Spinner grande per loading globale */
.loading-spinner-large {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Skeleton loader */
.skeleton-item {
    background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card) 50%, var(--bg-secondary) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 12px;
}

/* Pull to refresh */
.pull-refresh-indicator {
    font-family: inherit;
}

.pull-refresh-spinner {
    font-size: 20px;
    display: inline-block;
}

/* Offline indicator */
.offline-banner {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--warning);
    color: var(--bg-primary);
    padding: 8px;
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    z-index: 99998;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
}

.offline-banner.visible {
    transform: translateY(0);
}

.agenda-event-time {
    min-width: 60px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
}

.agenda-event-content {
    flex: 1;
}

.agenda-event-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.agenda-event-details {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.agenda-event-icon {
    font-size: 1.2rem;
}

.agenda-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
}

.agenda-empty-icon {
    font-size: 3rem;
    margin-bottom: 12px;
}

/* ============================================
   MOBILE RESPONSIVE FIXES
   ============================================ */

@media (max-width: 480px) {
    /* Layout generale */
    .page {
        padding: 12px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
        max-width: 100%;
    }

    .header {
        padding: 12px;
    }

    .header-content {
        padding: 0;
    }

    .header-title {
        font-size: 1.1rem;
    }

    /* Cards */
    .card {
        padding: 14px;
        margin-bottom: 12px;
        border-radius: 12px;
    }

    /* Stats Grid */
    .stats-grid {
        gap: 8px;
    }

    .stat-card {
        padding: 12px 8px;
    }

    .stat-value {
        font-size: 1.3rem;
    }

    .stat-label {
        font-size: 0.7rem;
    }

    /* Buttons */
    .btn {
        padding: 10px 14px;
        font-size: 0.85rem;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 0.75rem;
    }

    /* Form inputs */
    .form-input {
        padding: 10px 12px;
        font-size: 0.95rem;
    }

    /* Calendar - Settimana e mese */
    .week-header-day {
        padding: 6px 2px;
        font-size: 0.65rem;
    }

    .week-day-cell {
        padding: 4px;
        min-height: 60px;
    }

    .week-day-number {
        font-size: 0.75rem;
    }

    .month-day-cell {
        font-size: 0.7rem;
    }

    /* Kanban */
    .kanban-task {
        padding: 10px;
    }

    .kanban-task-title {
        font-size: 0.85rem;
    }

    /* Team */
    .team-kanban {
        gap: 8px;
    }

    .team-kanban-column {
        padding: 8px;
    }

    .project-stats-bar {
        gap: 8px;
        padding: 12px;
    }

    .project-stat-value {
        font-size: 1.1rem;
    }

    .project-stat-label {
        font-size: 0.6rem;
    }

    /* Bottom nav */
    .nav-item {
        padding: 6px 8px;
        min-width: 50px;
    }

    .nav-icon {
        font-size: 1.2rem;
    }

    .nav-label {
        font-size: 0.55rem;
    }

    /* Modal */
    .modal {
        margin: 0;
        max-height: 75vh;
        border-radius: 20px 20px 0 0;
    }

    .modal-header {
        padding: 14px 16px;
    }

    .modal-body {
        padding: 14px 16px;
        -webkit-overflow-scrolling: touch;
    }

    .modal-footer {
        padding: 12px 16px;
        padding-bottom: max(12px, env(safe-area-inset-bottom));
    }

    /* Quick actions */
    .quick-actions {
        gap: 8px;
    }

    .quick-action-btn {
        padding: 12px 8px;
        font-size: 0.75rem;
    }

    /* Task list */
    .task-item {
        padding: 12px;
    }

    .task-title {
        font-size: 0.9rem;
    }

    /* Finance */
    .balance-card .stat-value {
        font-size: 1.8rem;
    }

    .transaction-item {
        padding: 10px;
    }

    /* Pomodoro */
    .pomodoro-time {
        font-size: 2.5rem;
    }

    /* Skills */
    .skill-card {
        padding: 12px;
    }

    /* Fix per elementi con width fissa */
    .calendar-view-btns {
        flex-wrap: wrap;
        gap: 4px;
    }

    .calendar-view-btn {
        padding: 6px 10px;
        font-size: 0.75rem;
    }

    /* Collaborators */
    .collaborator-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    /* Finance hero */
    .finance-hero {
        padding: 16px;
        border-radius: 14px;
    }

    .finance-balance-amount {
        font-size: 1.8rem;
    }

    .finance-stat-value {
        font-size: 1rem;
    }

    /* Calendar */
    .calendar-nav {
        padding: 8px;
        gap: 6px;
    }

    .calendar-nav-btn {
        padding: 6px 10px;
        font-size: 0.8rem;
    }

    .week-day-cell {
        min-height: 55px;
    }

    .event-pill {
        padding: 2px 5px;
        font-size: 0.6rem;
    }

    /* Team kanban scroll hint */
    .team-kanban {
        padding-left: 12px;
        margin-left: -12px;
        margin-right: -12px;
    }

    .team-kanban-column {
        min-width: 240px;
    }

    /* Inbox */
    .inbox-item {
        padding: 12px;
    }

    .inbox-icon {
        width: 36px;
        height: 36px;
        font-size: 1rem;
    }

    .inbox-action-btn {
        padding: 6px 10px;
        font-size: 0.75rem;
    }

    /* Attendees */
    .attendee-item {
        padding: 10px;
    }

    .attendee-avatar {
        width: 32px;
        height: 32px;
    }

    /* Comments */
    .comment-item {
        padding: 10px;
        gap: 8px;
    }

    .comment-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }

    /* Empty states */
    .empty-state {
        padding: 24px 16px;
    }

    .empty-state-icon {
        font-size: 2.5rem;
    }

    /* FAB */
    .btn-fab {
        width: 50px;
        height: 50px;
        font-size: 1.3rem;
        right: 12px;
    }

    /* SAVERS routine */
    .savers-item {
        padding: 12px;
    }

    .savers-letter {
        font-size: 1.4rem;
    }

    /* Goals */
    .goal-card {
        padding: 12px;
    }

    /* Journal/Notes */
    .note-card,
    .journal-entry {
        padding: 12px;
    }
}

/* Extra small screens (Android economici) */
@media (max-width: 360px) {
    .page {
        padding: 8px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }

    .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 6px;
    }

    .stat-card {
        padding: 10px 6px;
    }

    .stat-value {
        font-size: 1.1rem;
    }

    .header-title {
        font-size: 1rem;
    }

    .btn {
        padding: 8px 12px;
        font-size: 0.8rem;
    }

    /* Nav labels - mostra sempre su schermi piccoli Android */
    .nav-label {
        display: block !important;
        font-size: 0.55rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .nav-icon {
        font-size: 1.2rem;
    }

    .nav-item {
        padding: 4px 6px;
        min-width: 48px;
    }

    .bottom-nav {
        padding: 4px 6px;
        padding-bottom: calc(4px + env(safe-area-inset-bottom));
    }

    /* Stats split per schermi piccolissimi */
    .stats-split-container {
        grid-template-columns: 1fr;
        gap: 6px;
    }

    .stats-split-card {
        padding: 10px;
    }

    .stats-split-items {
        justify-content: space-around;
    }

    .stats-split-value {
        font-size: 1rem;
    }

    .stats-split-label {
        font-size: 0.65rem;
    }

    .project-stats-bar {
        grid-template-columns: repeat(2, 1fr);
    }

    /* Comment input per schermi molto piccoli */
    .comment-input-wrapper {
        flex-direction: column;
        gap: 8px;
    }

    .comment-input-wrapper .btn-sm {
        width: 100%;
    }

    .mention-autocomplete {
        max-height: 180px;
    }

    .mention-item,
    .mention-option {
        padding: 10px 12px;
    }

    /* Header compatto */
    .header {
        padding: 10px 8px;
    }

    .header-logo {
        font-size: 1.4rem;
    }

    .header-btn {
        width: 34px;
        height: 34px;
        font-size: 1rem;
    }

    /* Cards ultra compatte */
    .card {
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 8px;
    }

    .card-title {
        font-size: 0.9rem;
    }

    /* Finance */
    .finance-hero {
        padding: 14px;
        border-radius: 12px;
    }

    .finance-balance-amount {
        font-size: 1.6rem;
    }

    .finance-stat-label {
        font-size: 0.65rem;
    }

    .finance-stat-value {
        font-size: 0.95rem;
    }

    .transaction-item {
        padding: 8px;
        gap: 8px;
    }

    .transaction-icon {
        width: 34px;
        height: 34px;
        font-size: 1rem;
    }

    .transaction-title {
        font-size: 0.85rem;
    }

    .transaction-amount {
        font-size: 0.9rem;
    }

    /* Calendar ultra compatto */
    .calendar-header {
        padding: 8px;
    }

    .calendar-title {
        font-size: 0.9rem;
    }

    .week-header-day {
        font-size: 0.6rem;
        padding: 4px 2px;
    }

    .week-day-cell {
        min-height: 50px;
        padding: 2px;
    }

    .week-day-number {
        font-size: 0.7rem;
    }

    .month-day-cell {
        min-height: 38px;
        font-size: 0.65rem;
    }

    /* Team kanban */
    .team-kanban-column {
        min-width: 220px;
        padding: 8px;
    }

    .team-task-card {
        padding: 8px;
    }

    .team-task-title {
        font-size: 0.8rem;
    }

    /* Task items */
    .task-item {
        padding: 10px;
    }

    .task-checkbox {
        width: 20px;
        height: 20px;
    }

    .task-title {
        font-size: 0.85rem;
    }

    .task-meta {
        font-size: 0.7rem;
    }

    /* Form inputs */
    .form-input,
    .form-select,
    input,
    textarea,
    select {
        padding: 10px 12px;
        font-size: 16px;
        min-height: 42px;
    }

    /* Buttons */
    .btn {
        min-height: 40px;
    }

    .btn-sm {
        padding: 6px 10px;
        font-size: 0.75rem;
        min-height: 32px;
    }

    /* Modal */
    .modal {
        margin: 0;
        border-radius: 16px 16px 0 0;
        max-height: 72vh;
    }

    .modal-header {
        padding: 12px;
    }

    .modal-title {
        font-size: 1rem;
    }

    .modal-body {
        padding: 12px;
    }

    .modal-footer {
        padding: 10px 12px;
        gap: 6px;
    }

    /* Bottom nav */
    .bottom-nav {
        padding: 6px 8px;
    }

    .nav-item {
        padding: 6px 8px;
        min-width: 44px;
    }

    .nav-icon {
        font-size: 1.3rem;
        margin-bottom: 2px;
    }

    /* Quick actions grid */
    .quick-actions {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
    }

    .quick-action-btn {
        padding: 10px 6px;
        font-size: 0.7rem;
    }

    .quick-action-btn span:first-child {
        font-size: 1.2rem;
    }

    /* SAVERS */
    .savers-item {
        padding: 10px;
    }

    .savers-letter {
        font-size: 1.3rem;
    }

    .savers-title {
        font-size: 0.75rem;
    }

    /* Inbox */
    .inbox-item {
        padding: 10px;
        gap: 8px;
    }

    .inbox-icon {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }

    .inbox-title {
        font-size: 0.85rem;
    }

    .inbox-message {
        font-size: 0.75rem;
    }

    /* FAB */
    .btn-fab {
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
        right: 10px;
        bottom: calc(80px + env(safe-area-inset-bottom));
    }

    /* Pomodoro */
    .pomodoro-time {
        font-size: 2.2rem;
    }

    .pomodoro-btn {
        padding: 10px 16px;
        font-size: 0.85rem;
    }

    /* Skills */
    .skill-card {
        padding: 10px;
    }

    .skill-name {
        font-size: 0.85rem;
    }

    /* Empty state */
    .empty-state {
        padding: 20px 12px;
    }

    .empty-state-icon {
        font-size: 2rem;
    }

    .empty-state-title {
        font-size: 0.9rem;
    }

    .empty-state-text {
        font-size: 0.8rem;
    }

    /* Toast */
    .toast {
        padding: 12px 16px;
        font-size: 0.85rem;
        border-radius: 12px;
        left: 16px;
        right: 16px;
        bottom: calc(90px + env(safe-area-inset-bottom));
        transform: translateX(0) translateY(20px);
        max-width: none;
        width: auto;
    }

    .toast.show {
        transform: translateX(0) translateY(0);
    }

    /* Comment avatars smaller */
    .comment-avatar,
    .member-avatar,
    .collaborator-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
    }

    /* Attendees */
    .attendee-item {
        padding: 8px;
        gap: 8px;
    }

    .attendee-avatar {
        width: 28px;
        height: 28px;
    }

    .attendee-name {
        font-size: 0.8rem;
    }

    .attendee-status {
        font-size: 0.65rem;
        padding: 2px 6px;
    }

    /* Goals */
    .goal-card {
        padding: 10px;
    }

    .goal-title {
        font-size: 0.85rem;
    }

    .goal-bar {
        height: 6px;
    }

    /* Budget */
    .budget-category-icon {
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
    }

    /* Activity */
    .activity-item {
        padding: 8px;
    }

    .activity-icon {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
    }

    .activity-text {
        font-size: 0.8rem;
    }
}

/* ============================================
   ANDROID CHROME OPTIMIZATIONS
   Stili più compatti e puliti per Android
   ============================================ */

/* Android detection via hover capability (Android non ha hover preciso) */
@media (hover: none) and (pointer: coarse) {
    /* Reset text size per evitare ingrandimenti automatici */
    html {
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
    }

    /* Root sizing più compatto per Android */
    :root {
        --radius-sm: 6px;
        --radius: 10px;
        --radius-lg: 14px;
        --radius-xl: 20px;
        --spacing: 14px;
    }

    /* Body font più nitido */
    body {
        font-size: 15px;
        -webkit-tap-highlight-color: transparent;
    }

    /* Cards più compatte */
    .card {
        padding: 14px;
        margin-bottom: 10px;
        border-radius: 12px;
    }

    .card-gradient {
        padding: 14px;
    }

    /* Header più snello */
    .header {
        padding: 14px var(--spacing);
    }

    .header-title {
        font-size: 1.1rem;
    }

    /* Bottoni più compatti */
    .btn {
        padding: 10px 16px;
        font-size: 0.875rem;
        border-radius: 10px;
        min-height: 42px;
    }

    .btn-sm {
        padding: 7px 12px;
        font-size: 0.8rem;
        min-height: 34px;
    }

    .btn-lg {
        padding: 12px 20px;
        font-size: 0.95rem;
        min-height: 48px;
    }

    /* Stats grid ottimizzate */
    .stats-grid {
        gap: 8px;
    }

    .stat-card {
        padding: 12px 10px;
        border-radius: 10px;
    }

    .stat-value {
        font-size: 1.4rem;
    }

    .stat-label {
        font-size: 0.7rem;
    }

    /* Quick actions più compatte */
    .quick-actions {
        gap: 8px;
    }

    .quick-action-btn {
        padding: 14px 10px;
        font-size: 0.8rem;
        border-radius: 12px;
    }

    .quick-action-btn span:first-child {
        font-size: 1.4rem;
    }

    /* Form inputs ottimizzati */
    .form-input,
    .form-select,
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
        padding: 11px 14px;
        font-size: 16px; /* Previene zoom su focus in iOS/Android */
        border-radius: 10px;
        min-height: 44px;
    }

    /* Task items più compatti */
    .task-item {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
    }

    .task-title {
        font-size: 0.9rem;
    }

    .task-meta {
        font-size: 0.75rem;
    }

    /* Kanban cards più compatte */
    .kanban-task,
    .team-task-card {
        padding: 10px;
        margin-bottom: 6px;
        border-radius: 8px;
    }

    .kanban-task-title,
    .team-task-title {
        font-size: 0.85rem;
    }

    /* Team kanban columns */
    .team-kanban-column {
        padding: 10px;
        border-radius: 12px;
    }

    .team-kanban-title {
        font-size: 0.85rem;
    }

    /* Bottom navigation più compatta */
    .bottom-nav {
        padding: 8px 12px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }

    .nav-item {
        padding: 8px 10px;
        border-radius: 10px;
    }

    .nav-icon {
        font-size: 1.3rem;
    }

    .nav-label {
        font-size: 0.65rem;
        margin-top: 2px;
    }

    /* Modal più compatto */
    .modal {
        margin: 0;
        border-radius: 18px 18px 0 0;
        max-height: 70vh;
    }

    .modal-header {
        padding: 14px 16px;
    }

    .modal-header h3 {
        font-size: 1.05rem;
    }

    .modal-body {
        padding: 14px 16px;
    }

    .modal-footer {
        padding: 12px 16px;
        gap: 8px;
    }

    /* Project stats bar più compatta */
    .project-stats-bar {
        padding: 12px;
        gap: 10px;
        border-radius: 12px;
    }

    .project-stat-value {
        font-size: 1.15rem;
    }

    .project-stat-label {
        font-size: 0.65rem;
    }

    /* Activity feed più compatto */
    .activity-feed {
        gap: 8px;
    }

    .activity-item {
        padding: 10px;
        border-radius: 10px;
    }

    /* Calendário ottimizzato */
    .calendar-header {
        padding: 10px 12px;
    }

    .week-day-cell {
        min-height: 70px;
        padding: 4px;
    }

    .event-pill {
        padding: 3px 6px;
        font-size: 0.65rem;
        border-radius: 6px;
    }

    /* Finance cards */
    .balance-card .stat-value {
        font-size: 1.8rem;
    }

    .transaction-item {
        padding: 10px 12px;
        border-radius: 10px;
    }

    /* Habit tracker */
    .habit-item {
        padding: 12px;
        border-radius: 10px;
    }

    /* Skill cards */
    .skill-card {
        padding: 12px;
        border-radius: 10px;
    }

    /* Comments section - Android optimized */
    .event-comments {
        margin-top: 12px;
        padding-top: 12px;
    }

    .comment-item {
        padding: 10px;
        margin-bottom: 8px;
        gap: 8px;
    }

    .comment-avatar {
        width: 30px;
        height: 30px;
        font-size: 0.75rem;
    }

    .comment-author {
        font-size: 0.8rem;
    }

    .comment-time {
        font-size: 0.7rem;
    }

    .comment-text {
        font-size: 0.85rem;
    }

    /* Comment input wrapper - Android */
    .comment-input-wrapper {
        gap: 8px;
        margin-top: 10px;
        flex-wrap: nowrap;
    }

    .comment-input {
        padding: 10px 12px;
        font-size: 16px; /* Previene zoom */
        border-radius: 10px;
        min-height: 42px;
    }

    .comment-input-wrapper .btn-sm {
        padding: 8px 12px;
        font-size: 0.8rem;
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Mention autocomplete - Android optimized */
    .mention-autocomplete {
        bottom: calc(100% + 6px);
        left: 0;
        right: 0; /* Full width su Android */
        max-height: 200px;
        border-radius: 12px;
        box-shadow: 0 -4px 16px rgba(0,0,0,0.2);
    }

    .mention-item {
        padding: 12px 14px;
        gap: 10px;
        min-height: 48px; /* Touch target più grande */
    }

    .mention-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
    }

    .mention-name {
        font-size: 0.9rem;
    }

    .mention-email {
        font-size: 0.75rem;
    }

    /* Mention option (task comments) */
    .mention-option {
        padding: 12px 14px;
        min-height: 48px;
    }

    .mention-option-avatar {
        width: 36px;
        height: 36px;
    }

    .mention-option-name {
        font-size: 0.9rem;
    }

    .mention-option-email {
        font-size: 0.75rem;
    }

    /* Avatar sizes */
    .member-avatar,
    .collaborator-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.85rem;
    }

    /* Toast più compatto */
    .toast {
        padding: 12px 18px;
        font-size: 0.85rem;
        border-radius: 12px;
        bottom: calc(95px + env(safe-area-inset-bottom));
    }

    /* Inbox items */
    .inbox-item {
        padding: 12px;
        border-radius: 10px;
    }

    /* Progress bars */
    .progress-bar {
        height: 6px;
        border-radius: 3px;
    }

    /* Pomodoro */
    .pomodoro-time {
        font-size: 3rem;
    }

    /* Section headers */
    .section-title {
        font-size: 0.9rem;
        margin-bottom: 10px;
    }

    /* Badge sizes */
    .badge,
    .team-task-badge {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 6px;
    }

    /* Fix double-tap zoom */
    * {
        touch-action: manipulation;
    }

    /* ========== SAVERS ROUTINE PAGE ========== */
    .savers-grid {
        gap: 10px;
    }

    .savers-item {
        padding: 14px;
        border-radius: 12px;
    }

    .savers-letter {
        font-size: 1.6rem;
    }

    .savers-title {
        font-size: 0.85rem;
    }

    .savers-check {
        width: 24px;
        height: 24px;
    }

    /* ========== GOALS SECTION ========== */
    .goal-card {
        padding: 14px;
        border-radius: 12px;
        margin-bottom: 10px;
    }

    .goal-title {
        font-size: 0.95rem;
    }

    .goal-progress-text {
        font-size: 0.85rem;
    }

    .goal-bar {
        height: 8px;
        border-radius: 4px;
    }

    /* ========== NOTES SECTION ========== */
    .note-card {
        padding: 14px;
        border-radius: 12px;
        margin-bottom: 10px;
    }

    .note-title {
        font-size: 0.95rem;
    }

    .note-preview {
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .note-meta {
        font-size: 0.75rem;
    }

    /* ========== JOURNAL/GRATITUDE ========== */
    .journal-entry {
        padding: 14px;
        border-radius: 12px;
        margin-bottom: 10px;
    }

    .gratitude-item {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
    }

    /* ========== SKILLS/LEARNING ========== */
    .skill-card {
        padding: 14px;
        border-radius: 12px;
    }

    .skill-name {
        font-size: 0.95rem;
    }

    .skill-progress {
        height: 8px;
    }

    .skill-level {
        font-size: 0.8rem;
    }

    /* ========== CALENDAR VIEWS ========== */
    .calendar-nav {
        padding: 10px;
        gap: 8px;
    }

    .calendar-nav-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
        min-height: 40px;
    }

    .calendar-title {
        font-size: 1rem;
    }

    /* Day View */
    .day-view-header {
        padding: 12px;
    }

    .day-view-date {
        font-size: 1.1rem;
    }

    .time-slot {
        padding: 8px;
        min-height: 50px;
    }

    .time-slot-label {
        font-size: 0.75rem;
        width: 45px;
    }

    .time-slot-event {
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 0.8rem;
    }

    /* Week View */
    .week-header {
        padding: 8px 4px;
    }

    .week-header-day {
        font-size: 0.7rem;
        padding: 6px 2px;
    }

    .week-day-number {
        font-size: 0.85rem;
    }

    .week-day-name {
        font-size: 0.6rem;
    }

    .week-grid {
        gap: 2px;
    }

    .week-day-cell {
        min-height: 65px;
        padding: 4px;
    }

    /* Month View */
    .month-grid {
        gap: 2px;
    }

    .month-day-cell {
        min-height: 45px;
        padding: 4px;
        font-size: 0.75rem;
    }

    .month-day-number {
        font-size: 0.8rem;
    }

    .month-event-dot {
        width: 5px;
        height: 5px;
    }

    /* Event Pills */
    .event-pill {
        padding: 4px 8px;
        font-size: 0.7rem;
        border-radius: 6px;
        margin-bottom: 2px;
    }

    .event-pill-time {
        font-size: 0.65rem;
    }

    /* ========== FINANCE SECTION ========== */
    .finance-hero {
        padding: 18px;
        border-radius: 16px;
    }

    .finance-balance-label {
        font-size: 0.8rem;
    }

    .finance-balance-amount {
        font-size: 2rem;
    }

    .finance-stats-row {
        padding-top: 14px;
    }

    .finance-stat-label {
        font-size: 0.7rem;
    }

    .finance-stat-value {
        font-size: 1.1rem;
    }

    /* Transactions */
    .transaction-item {
        padding: 12px;
        gap: 10px;
        border-radius: 12px;
    }

    .transaction-icon {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
    }

    .transaction-title {
        font-size: 0.9rem;
    }

    .transaction-meta {
        font-size: 0.75rem;
    }

    .transaction-amount {
        font-size: 0.95rem;
    }

    /* Budget */
    .budget-item {
        margin-bottom: 14px;
    }

    .budget-category {
        font-size: 0.85rem;
    }

    .budget-category-icon {
        width: 26px;
        height: 26px;
        font-size: 0.85rem;
    }

    .budget-amounts {
        font-size: 0.8rem;
    }

    .budget-bar {
        height: 6px;
    }

    /* Money Goals */
    .money-goal-card {
        padding: 14px;
        border-radius: 12px;
    }

    .money-goal-icon {
        font-size: 1.2rem;
    }

    .money-goal-current {
        font-size: 1rem;
    }

    .money-goal-bar {
        height: 8px;
    }

    /* ========== TEAM/PROJECTS ========== */
    .team-header {
        padding: 12px;
        border-radius: 12px;
    }

    .team-name {
        font-size: 1rem;
    }

    .team-code {
        font-size: 0.75rem;
    }

    /* Project selector */
    .project-select {
        padding: 10px 14px;
        font-size: 0.9rem;
        border-radius: 10px;
    }

    /* Team Kanban */
    .team-kanban {
        gap: 10px;
        padding-bottom: 12px;
    }

    .team-kanban-column {
        min-width: 260px;
        padding: 12px;
        border-radius: 14px;
    }

    .team-kanban-header {
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .team-kanban-title {
        font-size: 0.9rem;
    }

    .team-kanban-count {
        font-size: 0.75rem;
        padding: 2px 8px;
    }

    /* Team Task Cards */
    .team-task-card {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
    }

    .team-task-title {
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

    .team-task-meta {
        font-size: 0.75rem;
        gap: 6px;
    }

    .team-task-assignee {
        width: 24px;
        height: 24px;
        font-size: 0.7rem;
    }

    .team-task-priority {
        width: 8px;
        height: 8px;
    }

    .team-task-due {
        font-size: 0.7rem;
        padding: 2px 6px;
    }

    /* Collaborators */
    .collaborator-item {
        padding: 12px;
        border-radius: 10px;
        gap: 10px;
    }

    .collaborator-avatar {
        width: 38px;
        height: 38px;
        font-size: 0.9rem;
    }

    .collaborator-name {
        font-size: 0.9rem;
    }

    .collaborator-email {
        font-size: 0.75rem;
    }

    .collaborator-role {
        font-size: 0.7rem;
        padding: 2px 8px;
    }

    /* Activity Feed */
    .activity-item {
        padding: 12px;
        border-radius: 10px;
        gap: 10px;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }

    .activity-text {
        font-size: 0.85rem;
    }

    .activity-time {
        font-size: 0.7rem;
    }

    /* ========== INBOX/NOTIFICATIONS ========== */
    .inbox-tabs {
        gap: 6px;
        padding: 8px;
        overflow-x: auto;
    }

    .inbox-tab {
        padding: 8px 12px;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .inbox-item {
        padding: 14px;
        gap: 12px;
        border-radius: 12px;
    }

    .inbox-icon {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
    }

    .inbox-title {
        font-size: 0.9rem;
    }

    .inbox-message {
        font-size: 0.8rem;
    }

    .inbox-time {
        font-size: 0.7rem;
    }

    .inbox-actions {
        gap: 6px;
    }

    .inbox-action-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
        min-height: 36px;
    }

    /* ========== SETTINGS PAGE ========== */
    .settings-section {
        padding: 14px;
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .settings-section-title {
        font-size: 0.9rem;
        margin-bottom: 12px;
    }

    .settings-item {
        padding: 12px 0;
    }

    .settings-item-label {
        font-size: 0.9rem;
    }

    .settings-item-desc {
        font-size: 0.75rem;
    }

    /* Toggle switches */
    .toggle-row {
        padding: 12px 0;
    }

    .toggle-label {
        font-size: 0.9rem;
    }

    .toggle-desc {
        font-size: 0.75rem;
    }

    .toggle-switch {
        width: 46px;
        height: 26px;
    }

    .toggle-switch::after {
        width: 20px;
        height: 20px;
    }

    /* ========== POMODORO ========== */
    .pomodoro-container {
        padding: 20px;
    }

    .pomodoro-time {
        font-size: 3.5rem;
    }

    .pomodoro-label {
        font-size: 0.9rem;
    }

    .pomodoro-controls {
        gap: 10px;
    }

    .pomodoro-btn {
        padding: 12px 20px;
        font-size: 0.9rem;
        min-height: 44px;
    }

    .pomodoro-stats {
        gap: 16px;
        padding: 14px;
    }

    .pomodoro-stat-value {
        font-size: 1.3rem;
    }

    .pomodoro-stat-label {
        font-size: 0.75rem;
    }

    /* ========== SCANNER/OCR ========== */
    .scanner-area {
        padding: 30px 16px;
        border-radius: 14px;
    }

    .scanner-icon {
        font-size: 2.5rem;
    }

    .scanner-text {
        font-size: 0.9rem;
    }

    .scanner-hint {
        font-size: 0.75rem;
    }

    .scanner-result {
        padding: 14px;
        border-radius: 12px;
    }

    .scanner-result-row {
        padding: 10px 0;
    }

    .scanner-result-label {
        font-size: 0.85rem;
    }

    .scanner-result-value {
        font-size: 0.9rem;
    }

    /* ========== ATTENDEES LIST ========== */
    .attendee-list {
        gap: 8px;
    }

    .attendee-item {
        padding: 10px 12px;
        border-radius: 10px;
        gap: 10px;
    }

    .attendee-avatar {
        width: 34px;
        height: 34px;
        font-size: 0.85rem;
    }

    .attendee-name {
        font-size: 0.9rem;
    }

    .attendee-email {
        font-size: 0.75rem;
    }

    .attendee-status {
        font-size: 0.7rem;
        padding: 3px 8px;
    }

    /* ========== CHIPS/TAGS ========== */
    .chip {
        padding: 6px 12px;
        font-size: 0.8rem;
        border-radius: 20px;
        min-height: 32px;
    }

    .tag {
        padding: 3px 8px;
        font-size: 0.7rem;
        border-radius: 6px;
    }

    /* ========== EMPTY STATES ========== */
    .empty-state {
        padding: 30px 20px;
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 12px;
    }

    .empty-state-title {
        font-size: 1rem;
    }

    .empty-state-text {
        font-size: 0.85rem;
    }

    /* ========== LOADING STATES ========== */
    .loading-spinner {
        width: 36px;
        height: 36px;
    }

    .loading-text {
        font-size: 0.85rem;
    }

    /* ========== SCROLLBAR STYLING ========== */
    ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
    }

    /* ========== FAB BUTTON ========== */
    .btn-fab {
        width: 52px;
        height: 52px;
        font-size: 1.4rem;
        bottom: calc(85px + env(safe-area-inset-bottom));
        right: 16px;
    }

    /* ========== QUICK ADD PANEL ========== */
    .quick-add-panel {
        padding: 16px;
        border-radius: 16px 16px 0 0;
    }

    .quick-add-title {
        font-size: 1rem;
    }

    .quick-add-grid {
        gap: 10px;
    }

    .quick-add-item {
        padding: 14px 12px;
        border-radius: 12px;
    }

    .quick-add-icon {
        font-size: 1.5rem;
    }

    .quick-add-label {
        font-size: 0.8rem;
    }

    /* ========== CONTEXT MENUS ========== */
    .context-menu {
        border-radius: 12px;
        min-width: 180px;
    }

    .context-menu-item {
        padding: 12px 16px;
        font-size: 0.9rem;
        min-height: 44px;
    }

    .context-menu-icon {
        font-size: 1.1rem;
    }

    /* ========== DRAG & DROP FEEDBACK ========== */
    .dragging {
        opacity: 0.7;
        transform: rotate(2deg) scale(1.02);
    }

    .drop-zone-active {
        border: 2px dashed var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }

    /* ========== CELEBRATION/CONFETTI ========== */
    .celebration-overlay {
        padding: 20px;
    }

    .celebration-content {
        padding: 24px;
        border-radius: 20px;
    }

    .celebration-icon {
        font-size: 4rem;
    }

    .celebration-title {
        font-size: 1.3rem;
    }

    .celebration-text {
        font-size: 0.9rem;
    }

    /* ========== FIX OVERFLOW E ELEMENTI FUORI SCHERMO ========== */

    /* Stats Split (Box Vita/Lavoro) - Fix overflow */
    .stats-split-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }

    .stats-split-card {
        padding: 10px 8px;
        border-radius: 10px;
        min-width: 0; /* Previene overflow */
        overflow: hidden;
    }

    .stats-split-header {
        gap: 4px;
        margin-bottom: 8px;
    }

    .stats-split-icon {
        font-size: 1rem;
    }

    .stats-split-title {
        font-size: 0.75rem;
    }

    .stats-split-items {
        gap: 4px;
    }

    .stats-split-value {
        font-size: 0.9rem;
    }

    .stats-split-label {
        font-size: 0.6rem;
        letter-spacing: 0.3px;
    }

    /* Bottom Navigation - MOSTRA le etichette su Android */
    .bottom-nav {
        padding: 6px 8px;
        padding-bottom: calc(6px + env(safe-area-inset-bottom));
        height: auto;
    }

    .nav-item {
        padding: 6px 8px;
        flex-direction: column;
        gap: 2px;
        min-width: 56px;
    }

    .nav-icon {
        font-size: 1.2rem;
    }

    .nav-label {
        display: block !important; /* Forza visibilità su Android */
        font-size: 0.6rem;
        margin-top: 1px;
        opacity: 0.8;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .nav-item.active .nav-label {
        opacity: 1;
    }

    /* Department Switcher - Compatto */
    .department-switcher {
        gap: 6px;
        margin-bottom: 10px;
        padding: 4px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .dept-btn {
        padding: 8px 12px;
        font-size: 0.75rem;
        white-space: nowrap;
        border-radius: 8px;
        min-width: fit-content;
    }

    /* Balance Card - Compatto */
    #balanceCard {
        padding: 12px;
    }

    #balanceCard > div:first-child {
        gap: 8px;
        margin-bottom: 6px;
        flex-wrap: wrap;
    }

    #balanceCard span[style*="font-size:1.2rem"] {
        font-size: 1rem !important;
    }

    #balanceCard span[style*="font-weight:600"] {
        font-size: 0.85rem;
    }

    /* Stats Grid - Compatta */
    .stats-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
    }

    .stat-card {
        padding: 10px 6px;
    }

    .stat-icon {
        font-size: 1.2rem;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.1rem;
    }

    .stat-label {
        font-size: 0.6rem;
    }

    /* Calendar Section - Compatto */
    #calendarSection .card-header {
        flex-wrap: wrap;
        gap: 8px;
    }

    .calendar-view-btns {
        flex-wrap: wrap;
        gap: 4px;
    }

    .cal-view-btn {
        padding: 6px 10px;
        font-size: 0.7rem;
    }

    .calendar-nav {
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px;
    }

    .cal-nav-btn {
        padding: 6px 10px;
        font-size: 1rem;
    }

    .cal-nav-date {
        font-size: 0.85rem;
    }

    /* Quick Actions Home - Compatte */
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .quick-action-btn {
        padding: 12px 8px;
    }

    /* Finance Quick Actions */
    #homePage .card > div[style*="gap:8px"] {
        gap: 6px !important;
    }

    /* Page container - No overflow */
    .page {
        overflow-x: hidden;
        max-width: 100vw;
    }

    .page-content,
    .app-content {
        overflow-x: hidden;
        max-width: 100%;
    }

    /* Card overflow prevention */
    .card {
        max-width: 100%;
        overflow: hidden;
        word-wrap: break-word;
    }

    /* Greeting card compatto */
    .card-gradient {
        padding: 12px;
    }

    .card-gradient > div {
        gap: 8px;
    }

    #greetingText {
        font-size: 1.1rem !important;
    }

    #motivationQuote {
        font-size: 0.8rem !important;
    }

    #focusScore {
        font-size: 1.6rem !important;
    }

    /* Onboarding checklist compatto */
    .onboarding-checklist {
        padding: 12px;
        border-radius: 12px;
    }

    .onboarding-title {
        font-size: 0.95rem;
    }

    /* Contextual tip compatto */
    .contextual-tip {
        padding: 10px;
        gap: 10px;
    }

    .contextual-tip-icon {
        font-size: 1.3rem;
    }

    .contextual-tip-title {
        font-size: 0.85rem;
    }

    .contextual-tip-text {
        font-size: 0.8rem;
    }
}

/* Subtasks/Checklist Styles */
.subtask-container {
    margin-top: 8px;
}

.subtask-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    margin-bottom: 6px;
    transition: all 0.2s ease;
}

.subtask-item:hover {
    background: var(--bg-primary);
}

.subtask-check {
    width: 18px;
    height: 18px;
    accent-color: var(--primary);
    cursor: pointer;
}

.subtask-text {
    flex: 1;
    font-size: 0.9rem;
}

.subtask-text.completed {
    text-decoration: line-through;
    opacity: 0.6;
}

.subtask-remove {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 1rem;
}

.subtask-remove:hover {
    background: var(--danger);
    color: white;
}

.subtask-add-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.subtask-add-row input {
    flex: 1;
}

.subtask-progress {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

/* Split Transaction Styles */
.split-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
}

.split-row select {
    flex: 1;
}

.split-row input {
    width: 100px;
}

/* Weekly Trend Chart */
.trend-chart-container {
    padding: 16px;
}

/* Intention Card */
.intention-card {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 20px;
    border-radius: var(--radius-lg);
    margin-bottom: 16px;
}

.intention-card h4 {
    margin-bottom: 12px;
}

.intention-card textarea {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    margin-bottom: 12px;
}

.intention-card textarea::placeholder {
    color: rgba(255,255,255,0.7);
}

    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastIcon">✓</span>
        <span id="toastMessage">Messaggio</span>
    </div>

    <!-- Quick Capture FAB -->
    <button class="quick-capture-fab" onclick="openModal('quickCaptureModal')" title="Quick Capture">
        ⚡
    </button>

    <!-- Break Reminder Overlay -->
    <div class="break-overlay" id="breakOverlay">
        <div class="break-icon" id="breakIcon">🧘</div>
        <div class="break-title" id="breakTitle">Tempo di una Pausa!</div>
        <div class="break-message" id="breakMessage">Hai lavorato per 25 minuti. Fai stretching e riposa gli occhi.</div>
        <div class="break-timer" id="breakTimer">5:00</div>
        <button class="btn btn-lg" style="background:white; color:var(--text-primary);" onclick="skipBreak()">Salta Pausa</button>
    </div>

    <!-- Guided Mode Overlay -->
    <div class="guided-overlay" id="guidedOverlay">
        <div class="guided-card">
            <div class="guided-icon" id="guidedIcon">🚀</div>
            <div class="guided-title" id="guidedTitle">Benvenuto in Mago Max!</div>
            <div class="guided-text" id="guidedText">La tua app all-in-one per produttività e crescita personale.</div>
            <div class="guided-progress" id="guidedProgress"></div>
            <div class="guided-actions" id="guidedActions">
                <button class="guided-skip" onclick="skipGuidedTour()">Salta Tour</button>
                <button class="btn btn-primary" onclick="nextGuidedStep()">Inizia →</button>
            </div>
        </div>
    </div>

    <!-- Spotlight Overlay for Feature Highlights -->
    <div class="spotlight-overlay" id="spotlightOverlay">
        <div class="spotlight-highlight" id="spotlightHighlight"></div>
        <div class="spotlight-tooltip top" id="spotlightTooltip">
            <div class="spotlight-tooltip-title" id="spotlightTitle">Feature</div>
            <div class="spotlight-tooltip-text" id="spotlightText">Description</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-sm btn-secondary" onclick="prevSpotlight()">← Indietro</button>
                <button class="btn btn-sm btn-primary" onclick="nextSpotlight()">Avanti →</button>
            </div>
        </div>
    </div>

    <!-- ============================================
         LOGIN SCREEN (Obbligatorio)
         ============================================ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-screen-content">
            <div class="login-screen-logo">🎩</div>
            <h1 class="login-screen-title">SAVERS Pro</h1>
            <p class="login-screen-subtitle">La tua app all-in-one per produttività e crescita personale</p>

            <div class="login-screen-box">
                <button class="google-login-btn google-login-btn-large" onclick="loginWithGoogle()" id="googleLoginMainBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" style="margin-right:12px;">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Accedi con Google
                </button>

                <div class="login-screen-features">
                    <div class="login-feature">
                        <span class="login-feature-icon">📅</span>
                        <span>Sincronizza con Google Calendar</span>
                    </div>
                    <div class="login-feature">
                        <span class="login-feature-icon">☁️</span>
                        <span>Backup automatico nel cloud</span>
                    </div>
                    <div class="login-feature">
                        <span class="login-feature-icon">📱</span>
                        <span>Accedi da qualsiasi dispositivo</span>
                    </div>
                </div>
            </div>

            <div class="login-screen-footer">
                <p class="text-muted">Accedendo, accetti i nostri <a href="#" style="color:var(--primary);">Termini di Servizio</a></p>
            </div>
        </div>
    </div>

    <!-- ============================================
         MAIN APP
         ============================================ -->
    <div class="app-container" id="app" style="display:none;">

        <!-- HEADER -->
        <div class="header">
            <div class="header-content">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="header-logo" onclick="handleSecretTap()" style="cursor:pointer; user-select:none;">🎩</div>
                    <div>
                        <div class="header-title" id="headerTitle">Mago Max</div>
                        <div class="header-subtitle" id="headerDate">Lunedì, 20 Gennaio</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openModal('searchModal')">🔍</button>
                    <button class="header-btn" onclick="openModal('quickAddModal')">➕</button>
                    <button class="header-btn" onclick="openInbox()" id="headerInboxBtn" style="position:relative;">
                        📬
                        <span class="inbox-badge" id="inboxBadge" style="display:none;">0</span>
                    </button>
                    <button class="header-btn header-profile" onclick="openProfileModal()" id="headerProfileBtn">
                        <span class="profile-avatar" id="profileAvatar">M</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             PAGE: HOME DASHBOARD
             ============================================ -->
        <div class="page active" id="homePage">

            <!-- Cloud Sync Bar -->
            <div class="cloud-sync-bar" id="syncStatus" style="display:none;">
                <div class="sync-status">
                    <div class="sync-indicator" id="syncIndicator"></div>
                    <span class="sync-text" id="syncText">Non sincronizzato</span>
                </div>
                <div class="cloud-user">
                    <div class="cloud-user-icon">☁️</div>
                    <span id="cloudUserName">Non connesso</span>
                    <button class="btn btn-sm btn-secondary" onclick="forceSync()" style="padding:6px 10px; font-size:0.75rem;">🔄</button>
                </div>
            </div>

            <!-- API Stats Widget (cliccabile per dettagli) -->
            <div id="apiStatsWidget" onclick="showApiStatsModal()" style="cursor:pointer;padding:6px 12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;text-align:center;"></div>

            <!-- Greeting -->
            <div class="card card-gradient mb-2">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:1.3rem; font-weight:700; margin-bottom:4px;" id="greetingText">Buongiorno! ☀️</div>
                        <div style="opacity:0.9; font-size:0.9rem;" id="motivationQuote">Lo spettacolo deve continuare!</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:2rem; font-weight:800;" id="focusScore">85</div>
                        <div style="font-size:0.75rem; opacity:0.8;">Focus Score</div>
                    </div>
                </div>
            </div>

            <!-- Department Switcher - Vita/Lavoro -->
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                <div class="department-switcher" id="departmentSwitcher" style="flex:1;">
                    <button class="dept-btn active" data-dept="all" onclick="switchDepartment('all')">🌟 Tutto</button>
                    <button class="dept-btn" data-dept="personal" onclick="switchDepartment('personal')">👤 Vita</button>
                    <button class="dept-btn" data-dept="work" onclick="switchDepartment('work')">🎭 Lavoro</button>
                </div>
                <button class="btn btn-ghost" onclick="openModal('workLifeInfoModal')" style="width:32px; height:32px; padding:0; border-radius:50%; font-size:1rem; color:var(--text-muted); flex-shrink:0;" title="Cos'è questo?">❓</button>
            </div>

            <!-- Stats Split Vita/Lavoro -->
            <div class="stats-split-container" id="statsSplitContainer">
                <div class="stats-split-card dept-work">
                    <div class="stats-split-header">
                        <span class="stats-split-icon">🎭</span>
                        <span class="stats-split-title">Lavoro</span>
                    </div>
                    <div class="stats-split-items">
                        <div class="stats-split-item">
                            <span class="stats-split-value" id="workTasksCount">0/0</span>
                            <span class="stats-split-label">Task</span>
                        </div>
                        <div class="stats-split-item">
                            <span class="stats-split-value" id="workFocusHours">0h</span>
                            <span class="stats-split-label">Focus</span>
                        </div>
                        <div class="stats-split-item">
                            <span class="stats-split-value" id="workEventsCount">0</span>
                            <span class="stats-split-label">Eventi</span>
                        </div>
                    </div>
                </div>
                <div class="stats-split-card dept-personal">
                    <div class="stats-split-header">
                        <span class="stats-split-icon">👤</span>
                        <span class="stats-split-title">Vita</span>
                    </div>
                    <div class="stats-split-items">
                        <div class="stats-split-item">
                            <span class="stats-split-value" id="personalRoutinePercent">0%</span>
                            <span class="stats-split-label">Routine</span>
                        </div>
                        <div class="stats-split-item">
                            <span class="stats-split-value" id="personalHabitsCount">0</span>
                            <span class="stats-split-label">Habits</span>
                        </div>
                        <div class="stats-split-item">
                            <span class="stats-split-value" id="personalEnergy">-</span>
                            <span class="stats-split-label">Energia</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work-Life Balance Indicator -->
            <div class="card mb-2" id="balanceCard">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                    <span style="font-size:1.2rem;">⚖️</span>
                    <span style="font-weight:600;">Equilibrio Vita/Lavoro</span>
                    <span style="margin-left:auto; font-weight:700; color:var(--primary);" id="balancePercent">50%</span>
                </div>
                <div class="progress-bar-container" style="height:8px; background:var(--bg-tertiary); border-radius:4px; overflow:hidden;">
                    <div id="balanceBar" style="height:100%; width:50%; background:linear-gradient(90deg, var(--personal-color), var(--work-color)); border-radius:4px; transition:width 0.3s;"></div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.75rem; color:var(--text-secondary);">
                    <span>👤 Vita</span>
                    <span>🎭 Lavoro</span>
                </div>
            </div>

            <!-- Onboarding Checklist (shows for new users) -->
            <div class="onboarding-checklist" id="onboardingChecklist" style="display:none;">
                <div class="onboarding-header">
                    <div class="onboarding-title">🎯 Inizia il tuo viaggio</div>
                    <div class="onboarding-progress-text" id="onboardingProgressText">0/5 completati</div>
                </div>
                <div class="onboarding-progress-bar">
                    <div class="onboarding-progress-fill" id="onboardingProgressFill" style="width:0%"></div>
                </div>
                <div class="onboarding-items" id="onboardingItems">
                    <!-- Populated by JS -->
                </div>
                <button class="btn btn-sm" style="margin-top:12px; background:rgba(255,255,255,0.2); color:white; width:100%;" onclick="dismissOnboarding()">
                    Nascondi guida
                </button>
            </div>

            <!-- Contextual Tip -->
            <div class="contextual-tip" id="contextualTip" style="display:none;">
                <div class="contextual-tip-icon" id="contextualTipIcon">💡</div>
                <div class="contextual-tip-content">
                    <div class="contextual-tip-title" id="contextualTipTitle">Suggerimento</div>
                    <div class="contextual-tip-text" id="contextualTipText">Contenuto del suggerimento</div>
                </div>
                <button class="contextual-tip-dismiss" onclick="dismissContextualTip()">×</button>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card" onclick="switchPage('tasks')">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="tasksToday">0/0</div>
                    <div class="stat-label">Tasks Oggi</div>
                </div>
                <div class="stat-card" onclick="switchPage('finance')">
                    <div class="stat-icon">💰</div>
                    <div class="stat-value" id="todayBalance">€0</div>
                    <div class="stat-label">Bilancio Oggi</div>
                </div>
                <div class="stat-card" onclick="switchPage('routine')">
                    <div class="stat-icon">🌅</div>
                    <div class="stat-value" id="routinePercent">0%</div>
                    <div class="stat-label">Routine</div>
                </div>
                <div class="stat-card" onclick="switchPage('analytics')">
                    <div class="stat-icon">🔥</div>
                    <div class="stat-value" id="streakCount">0</div>
                    <div class="stat-label">Streak</div>
                </div>
                <div class="stat-card" onclick="switchPage('goals')">
                    <div class="stat-icon">🎯</div>
                    <div class="stat-value" id="goalsProgress">0%</div>
                    <div class="stat-label">Goals</div>
                </div>
                <div class="stat-card" onclick="switchPage('habits')">
                    <div class="stat-icon">✨</div>
                    <div class="stat-value" id="habitsProgress">0%</div>
                    <div class="stat-label">Habits</div>
                </div>
            </div>

            <!-- Calendario Integrato con Navigazione -->
            <div class="card" id="calendarSection">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📅</span> Calendario</div>
                    <div class="calendar-view-btns">
                        <button class="cal-view-btn active" onclick="setCalendarView('day')">Giorno</button>
                        <button class="cal-view-btn" onclick="setCalendarView('week')">Settimana</button>
                        <button class="cal-view-btn" onclick="setCalendarView('month')">Mese</button>
                        <button class="cal-view-btn" onclick="setCalendarView('agenda')">Agenda</button>
                    </div>
                </div>

                <!-- Navigazione Data -->
                <div class="calendar-nav">
                    <button class="cal-nav-btn" onclick="navigateCalendar(-1)">‹</button>
                    <div class="cal-nav-date" id="calNavDate" onclick="goToToday()">Oggi</div>
                    <button class="cal-nav-btn" onclick="navigateCalendar(1)">›</button>
                    <button class="btn btn-sm btn-ghost" id="compactViewToggle" onclick="toggleCalendarCompactView()" style="margin-left:auto;" title="Vista estesa">📋</button>
                    <button class="btn btn-sm btn-secondary" onclick="openModal('busyModal')" title="Segna non disponibilità">🚫</button>
                    <button class="btn btn-sm btn-primary" onclick="openAddEventModal()">+ Evento</button>
                </div>

                <!-- Vista Giornaliera -->
                <div class="calendar-day-view" id="calDayView">
                    <div class="day-timeline" id="dayTimeline">
                        <!-- Generato da JS -->
                    </div>
                </div>

                <!-- Vista Settimanale -->
                <div class="calendar-week-view" id="calWeekView" style="display:none;">
                    <div class="week-header" id="weekHeader">
                        <!-- L M M G V S D -->
                    </div>
                    <div class="week-grid" id="weekGrid">
                        <!-- Generato da JS -->
                    </div>
                </div>

                <!-- Vista Mensile -->
                <div class="calendar-month-view" id="calMonthView" style="display:none;">
                    <div class="month-grid" id="monthGrid">
                        <!-- Generato da JS -->
                    </div>
                </div>

                <!-- Vista Agenda -->
                <div class="calendar-agenda-view" id="calAgendaView" style="display:none;">
                    <div class="agenda-list" id="agendaList">
                        <!-- Generato da JS -->
                    </div>
                </div>

                <!-- Google Calendar Integration -->
                <div id="googleCalendarSync" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                    <div id="googleNotConnected" style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:0.85rem; color:var(--text-secondary);">Google Calendar:</span>
                        <button class="btn btn-sm btn-secondary" onclick="signInWithGoogle()">🔗 Connetti</button>
                    </div>
                    <div id="googleConnected" style="display:none;">
                        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                            <span style="color:var(--success); font-size:0.85rem;">✓ Connesso</span>
                            <select id="calendarSelect" onchange="changeCalendar(this.value)" style="flex:1; min-width:150px; font-size:0.85rem; padding:6px 8px; border-radius:6px; border:1px solid var(--border);">
                                <option value="primary">Calendario principale</option>
                            </select>
                            <button class="btn btn-ghost btn-xs" onclick="refreshGoogleCalendars()" title="Aggiorna calendari">🔄</button>
                        </div>
                        <div id="calendarEventsCount" style="font-size:0.75rem; color:var(--text-muted); margin-top:6px;"></div>
                    </div>
                </div>

                <!-- Inviti in Attesa -->
                <div id="pendingInvitesSection" style="display:none; margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <span style="font-weight:600; font-size:0.9rem;">📩 Inviti in Attesa</span>
                        <span id="pendingInvitesCount" class="badge" style="background:var(--warning); color:white; padding:2px 8px; border-radius:10px; font-size:0.75rem;">0</span>
                    </div>
                    <div id="pendingInvitesList" style="display:flex; flex-direction:column; gap:8px;">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Today's Top 3 Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🎯</span> Top 3 di Oggi</div>
                    <span class="card-action" onclick="openModal('addTaskModal')">+ Aggiungi</span>
                </div>
                <div id="top3TasksList">
                    <div class="empty-state" style="padding:20px;">
                        <div class="text-muted">Nessun task prioritario</div>
                    </div>
                </div>
            </div>

            <!-- Quick Pomodoro -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🍅</span> Focus Timer</div>
                </div>
                <div class="pomodoro-container">
                    <div class="pomodoro-timer" id="pomodoroTimer">25:00</div>
                    <div class="pomodoro-label" id="pomodoroLabel">Pronto per iniziare</div>
                    <div class="pomodoro-controls">
                        <button class="btn btn-primary" id="pomodoroStartBtn" onclick="togglePomodoro()">▶️ Inizia</button>
                        <button class="btn btn-secondary" onclick="resetPomodoro()">🔄</button>
                    </div>
                    <div class="pomodoro-sessions" id="pomodoroSessions">
                        <div class="pomodoro-dot"></div>
                        <div class="pomodoro-dot"></div>
                        <div class="pomodoro-dot"></div>
                        <div class="pomodoro-dot"></div>
                    </div>
                </div>
            </div>

            <!-- Today's Finance Summary -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">💳</span> Finanze Oggi</div>
                    <span class="card-action" onclick="switchPage('finance')">Vedi tutto →</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                    <div>
                        <div class="text-sm text-muted">Entrate</div>
                        <div class="font-bold text-success" id="todayIncome">+€0.00</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="text-sm text-muted">Uscite</div>
                        <div class="font-bold text-danger" id="todayExpense">-€0.00</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-success btn-sm" style="flex:1;" onclick="openModal('addIncomeModal')">+ Entrata</button>
                    <button class="btn btn-danger btn-sm" style="flex:1;" onclick="openModal('addExpenseModal')">+ Uscita</button>
                    <button class="btn btn-primary btn-sm" onclick="openModal('scanReceiptModal')">📷</button>
                </div>
            </div>

            <!-- Daily Flow Quick Action -->
            <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; cursor:pointer;" onclick="openDailyFlow()">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:1.1rem; font-weight:700; margin-bottom:4px;" id="dailyFlowCTA">🌅 Morning Flow</div>
                        <div style="opacity:0.9; font-size:0.85rem;">Inizia la giornata nel modo giusto</div>
                    </div>
                    <div style="font-size:2rem;">→</div>
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: TASKS
             ============================================ -->
        <div class="page" id="tasksPage">

            <!-- View Switcher -->
            <div class="card">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-primary btn-sm" id="viewListBtn" onclick="setTaskView('list')">📋 Lista</button>
                    <button class="btn btn-secondary btn-sm" id="viewKanbanBtn" onclick="setTaskView('kanban')">📊 Kanban</button>
                    <button class="btn btn-secondary btn-sm" id="viewMatrixBtn" onclick="setTaskView('matrix')">🎯 Matrix</button>
                    <button class="auto-schedule-btn" style="padding:8px 16px; margin-top:0; width:auto; flex:1;" onclick="autoScheduleTasks()">
                        🤖 Auto-Schedule
                    </button>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div style="display:flex; gap:8px; margin-bottom:16px; overflow-x:auto; padding-bottom:8px;">
                <button class="btn btn-primary btn-sm" onclick="filterTasks('all', event)">Tutti</button>
                <button class="btn btn-secondary btn-sm" onclick="filterTasks('today', event)">Oggi</button>
                <button class="btn btn-secondary btn-sm" onclick="filterTasks('week', event)">Settimana</button>
                <button class="btn btn-secondary btn-sm" onclick="filterTasks('done', event)">Completati</button>
            </div>

            <!-- List View -->
            <div id="taskListView">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><span class="card-title-icon">✅</span> I Miei Task</div>
                        <span class="card-action" onclick="openModal('addTaskModal')">+ Nuovo</span>
                    </div>
                    <div id="tasksList"></div>
                </div>
            </div>

            <!-- Kanban View (Drag & Drop Enabled) -->
            <div id="taskKanbanView" style="display:none;">
                <div class="kanban-container">
                    <!-- Colonna Task Delegati a Me (da progetti team) -->
                    <div class="kanban-column delegated-column">
                        <div class="kanban-header" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                            <span class="kanban-title">👥 Delegati a Me</span>
                            <span class="kanban-count" id="kanbanDelegatedCount">0</span>
                        </div>
                        <div id="kanbanDelegated" class="kanban-column-content" data-status="delegated"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-title">📥 Da Fare</span>
                            <span class="kanban-count" id="kanbanTodoCount">0</span>
                        </div>
                        <div id="kanbanTodo" class="kanban-column-content" data-status="todo"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-title">🔄 In Corso</span>
                            <span class="kanban-count" id="kanbanProgressCount">0</span>
                        </div>
                        <div id="kanbanProgress" class="kanban-column-content" data-status="progress"></div>
                    </div>
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-title">✅ Fatto</span>
                            <span class="kanban-count" id="kanbanDoneCount">0</span>
                        </div>
                        <div id="kanbanDone" class="kanban-column-content" data-status="done"></div>
                    </div>
                </div>
            </div>

            <!-- Eisenhower Matrix View -->
            <div id="taskMatrixView" style="display:none;">
                <div class="matrix-grid">
                    <div class="matrix-quadrant quadrant-1">
                        <div class="quadrant-header">🔥 Urgente & Importante</div>
                        <div id="matrixQ1"></div>
                    </div>
                    <div class="matrix-quadrant quadrant-2">
                        <div class="quadrant-header">📅 Importante</div>
                        <div id="matrixQ2"></div>
                    </div>
                    <div class="matrix-quadrant quadrant-3">
                        <div class="quadrant-header">⚡ Urgente</div>
                        <div id="matrixQ3"></div>
                    </div>
                    <div class="matrix-quadrant quadrant-4">
                        <div class="quadrant-header">🗑️ Elimina/Delega</div>
                        <div id="matrixQ4"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: FINANCE
             ============================================ -->
        <div class="page" id="financePage">

            <!-- Balance Hero -->
            <div class="finance-hero">
                <div class="finance-balance-label">Saldo Corrente</div>
                <div class="finance-balance-amount" id="currentBalance">€0.00</div>
                <div class="finance-stats-row">
                    <div class="finance-stat">
                        <div class="finance-stat-label">Entrate (mese)</div>
                        <div class="finance-stat-value income" id="monthIncome">€0</div>
                    </div>
                    <div class="finance-stat">
                        <div class="finance-stat-label">Uscite (mese)</div>
                        <div class="finance-stat-value expense" id="monthExpense">€0</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="display:flex; gap:8px; margin-bottom:12px;">
                <button class="btn btn-success btn-sm" style="flex:1;" onclick="openModal('addIncomeModal')">➕ Entrata</button>
                <button class="btn btn-danger btn-sm" style="flex:1;" onclick="openModal('addExpenseModal')">➖ Uscita</button>
                <button class="btn btn-primary btn-sm" style="flex:1;" onclick="openModal('scanReceiptModal')">📷 Scansiona</button>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:16px;">
                <button class="btn btn-secondary btn-sm" style="flex:1;" onclick="exportTransactionsCSV()">📥 Esporta CSV</button>
                <button class="btn btn-secondary btn-sm" style="flex:1;" onclick="openModal('splitTransactionModal')">➗ Dividi Spesa</button>
            </div>

            <!-- Weekly Trend Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📈</span> Trend Settimanale</div>
                </div>
                <div class="trend-chart-container">
                    <canvas id="weeklyTrendChart" height="200"></canvas>
                </div>
            </div>

            <!-- Money Goals -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🎯</span> Obiettivi Finanziari</div>
                    <span class="card-action" onclick="openModal('addMoneyGoalModal')">+ Nuovo</span>
                </div>
                <div id="moneyGoalsList"></div>
            </div>

            <!-- Daily Budget -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📊</span> Budget Giornaliero</div>
                </div>
                <div style="text-align:center; margin-bottom:16px;">
                    <div style="font-size:0.9rem; color:var(--text-muted);">Disponibile oggi</div>
                    <div style="font-size:2rem; font-weight:700;" id="dailyBudgetRemaining">€0.00</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);" id="dailyBudgetSpent">Speso: €0 di €0</div>
                </div>
                <div class="budget-bar" style="height:12px; margin-bottom:8px;">
                    <div class="budget-progress safe" id="dailyBudgetBar" style="width:0%;"></div>
                </div>
            </div>

            <!-- Budget by Category -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📈</span> Spese per Categoria</div>
                </div>
                <div id="budgetByCategory"></div>
            </div>

            <!-- Transactions -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">💳</span> Transazioni</div>
                    <span class="card-action" onclick="openModal('allTransactionsModal')">Vedi tutte</span>
                </div>
                <div id="transactionsList"></div>
            </div>

        </div>

        <!-- ============================================
             PAGE: ROUTINE (S.A.V.E.R.S.)
             ============================================ -->
        <div class="page" id="routinePage">

            <!-- Progress Ring -->
            <div class="card">
                <div class="routine-progress">
                    <div class="progress-ring">
                        <svg width="140" height="140">
                            <circle class="bg" cx="70" cy="70" r="60"/>
                            <circle class="progress" id="routineProgressRing" cx="70" cy="70" r="60" 
                                stroke-dasharray="377" stroke-dashoffset="377"/>
                        </svg>
                        <div class="progress-ring-center">
                            <div class="progress-ring-value" id="routineProgressValue">0%</div>
                            <div class="progress-ring-label">Completato</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- S.A.V.E.R.S. Activities -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🌅</span> Routine Mattutina</div>
                </div>
                <div id="routineActivities"></div>
            </div>

            <!-- Wellness Quick Stats -->
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
                <div class="stat-card" onclick="openModal('moodModal')">
                    <div class="stat-icon" id="moodEmoji">😊</div>
                    <div class="stat-value" id="moodValue">-</div>
                    <div class="stat-label">Mood</div>
                </div>
                <div class="stat-card" onclick="openModal('sleepModal')">
                    <div class="stat-icon">😴</div>
                    <div class="stat-value" id="sleepValue">-</div>
                    <div class="stat-label">Sonno</div>
                </div>
                <div class="stat-card" onclick="openModal('waterModal')">
                    <div class="stat-icon">💧</div>
                    <div class="stat-value" id="waterValue">0/8</div>
                    <div class="stat-label">Acqua</div>
                </div>
            </div>

            <!-- Daily Habits -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">✨</span> Abitudini Oggi</div>
                    <span class="card-action" onclick="openModal('addHabitModal')">+ Aggiungi</span>
                </div>
                <div id="habitsList"></div>
            </div>

        </div>


        <!-- ============================================
             PAGE: GOALS
             ============================================ -->
        <div class="page" id="goalsPage">

            <!-- Time Filter -->
            <div style="display:flex; gap:8px; margin-bottom:16px; overflow-x:auto;">
                <button class="btn btn-primary btn-sm" onclick="filterGoals('all')">Tutti</button>
                <button class="btn btn-secondary btn-sm" onclick="filterGoals('weekly')">Settimanali</button>
                <button class="btn btn-secondary btn-sm" onclick="filterGoals('monthly')">Mensili</button>
                <button class="btn btn-secondary btn-sm" onclick="filterGoals('yearly')">Annuali</button>
            </div>

            <!-- Goals List -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🎯</span> I Miei Obiettivi</div>
                    <span class="card-action" onclick="openModal('addGoalModal')">+ Nuovo</span>
                </div>
                <div id="goalsList"></div>
            </div>

            <!-- OKRs -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📈</span> OKRs</div>
                </div>
                <div id="okrsList"></div>
            </div>

        </div>

        <!-- ============================================
             PAGE: TIME TRACKING
             ============================================ -->
        <div class="page" id="timePage">

            <!-- Time Tracker -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">⏱️</span> Time Tracker</div>
                </div>
                <div class="timer-display">
                    <div class="timer-time" id="timeTrackerDisplay">00:00:00</div>
                    <div class="timer-label" id="timeTrackerProject">Nessun progetto</div>
                    <div class="timer-controls">
                        <button class="btn btn-primary" id="timeStartBtn" onclick="toggleTimeTracker()">▶️ Inizia</button>
                        <button class="btn btn-secondary" onclick="openModal('selectProjectModal')">📁 Progetto</button>
                        <button class="btn btn-secondary" onclick="resetTimeTracker()">🔄</button>
                    </div>
                </div>
            </div>

            <!-- Today Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">📅</div>
                    <div class="stat-value" id="timeToday">0h</div>
                    <div class="stat-label">Oggi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📆</div>
                    <div class="stat-value" id="timeWeek">0h</div>
                    <div class="stat-label">Settimana</div>
                </div>
            </div>

            <!-- Time Blocks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🗓️</span> Time Blocks Oggi</div>
                    <span class="card-action" onclick="openModal('timeBlockModal')">+ Nuovo</span>
                </div>
                <div id="timeBlocksList"></div>
            </div>

            <!-- Time Log -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📝</span> Log Tempo</div>
                </div>
                <div id="timeLogList"></div>
            </div>

        </div>

        <!-- ============================================
             PAGE: NOTES
             ============================================ -->
        <div class="page" id="notesPage">

            <!-- Search -->
            <div class="input-group mb-2">
                <span class="input-group-icon">🔍</span>
                <input type="text" class="form-input" id="notesSearch" placeholder="Cerca nelle note..." oninput="searchNotes(this.value)">
            </div>

            <!-- Quick Capture -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">⚡</span> Quick Capture</div>
                </div>
                <div class="form-group mb-1">
                    <textarea class="form-input" id="quickCaptureText" placeholder="Cattura un'idea velocemente..." style="min-height:60px;"></textarea>
                </div>
                <button class="btn btn-primary btn-sm" onclick="quickCapture()">💾 Salva</button>
            </div>

            <!-- Notes List -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📝</span> Le Mie Note</div>
                    <span class="card-action" onclick="openModal('addNoteModal')">+ Nuova</span>
                </div>
                <div id="notesList"></div>
            </div>

            <!-- Templates -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📄</span> Templates</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('morning')">🌅 Morning Plan</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('evening')">🌙 Evening Review</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('daily')">📅 Daily Note</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('weeklyPlan')">📋 Weekly Plan</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('weekly')">📆 Weekly Review</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('monthlyReview')">📊 Monthly Review</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('meeting')">🤝 Meeting</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('idea')">💡 Idea</button>
                    <button class="btn btn-secondary btn-sm" onclick="useNoteTemplate('quarterlyOKR')">🎯 OKR</button>
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: HABITS
             ============================================ -->
        <div class="page" id="habitsPage">

            <!-- Streak Card -->
            <div class="card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; text-align: center; padding: 24px;">
                <div style="font-size: 3rem; font-weight: 800;" id="habitStreak">0</div>
                <div style="font-size: 1rem; opacity: 0.9;">Giorni di Streak 🔥</div>
            </div>

            <!-- Today's Habits -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">✨</span> Abitudini di Oggi</div>
                    <span class="card-action" onclick="openModal('addHabitModal')">+ Nuova</span>
                </div>
                <div id="todayHabitsList">
                    <div class="empty-state" style="padding:20px; text-align:center;">
                        <div class="text-muted">Nessuna abitudine ancora</div>
                        <button class="btn btn-primary btn-sm mt-2" onclick="openModal('addHabitModal')">+ Aggiungi Abitudine</button>
                    </div>
                </div>
            </div>

            <!-- Habit Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="habitsCompletedToday">0</div>
                    <div class="stat-label">Completate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="habitsTotalToday">0</div>
                    <div class="stat-label">Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="habitsRateToday">0%</div>
                    <div class="stat-label">Tasso</div>
                </div>
                <div class="stat-card" onclick="switchPage('analytics')">
                    <div class="stat-icon">📊</div>
                    <div class="stat-value">→</div>
                    <div class="stat-label">Analytics</div>
                </div>
            </div>

            <!-- All Habits List -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📋</span> Tutte le Abitudini</div>
                </div>
                <div id="allHabitsList">
                    <!-- Popolato dinamicamente -->
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: SKILLS - Per Animatori
             ============================================ -->
        <div class="page" id="skillsPage">

            <!-- Skills Header -->
            <div class="card" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:1.3rem; font-weight:700;">🎭 Le Tue Skills</div>
                        <div style="opacity:0.9; font-size:0.9rem;">Migliora le tue competenze da animatore</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:2rem; font-weight:800;" id="totalSkillsLevel">0</div>
                        <div style="font-size:0.75rem; opacity:0.8;">Livello Totale</div>
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="skill-category-filter">
                <button class="skill-category-btn active" onclick="filterSkills('all')">🌟 Tutte</button>
                <button class="skill-category-btn performance" onclick="filterSkills('performance')">🎭 Performance</button>
                <button class="skill-category-btn technique" onclick="filterSkills('technique')">🎨 Tecniche</button>
                <button class="skill-category-btn business" onclick="filterSkills('business')">💼 Business</button>
            </div>

            <!-- Skills Grid -->
            <div class="skills-grid" id="skillsGrid">
                <!-- Popolato dinamicamente -->
            </div>

            <!-- Add Skill Button -->
            <button class="btn btn-primary" style="width:100%; margin-top:16px;" onclick="openModal('addSkillModal')">
                ➕ Aggiungi Nuova Skill
            </button>

            <!-- Skill Stats -->
            <div class="card" style="margin-top:16px;">
                <div class="card-title"><span class="card-title-icon">📊</span> Statistiche Skills</div>
                <div class="stats-grid" style="margin-top:12px;">
                    <div class="stat-card">
                        <div class="stat-icon">🎭</div>
                        <div class="stat-value" id="performanceSkillsCount">0</div>
                        <div class="stat-label">Performance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🎨</div>
                        <div class="stat-value" id="techniqueSkillsCount">0</div>
                        <div class="stat-label">Tecniche</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💼</div>
                        <div class="stat-value" id="businessSkillsCount">0</div>
                        <div class="stat-label">Business</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⏱️</div>
                        <div class="stat-value" id="totalPracticeHours">0h</div>
                        <div class="stat-label">Pratica</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             PAGE: TEAM ALIGNMENT MAP
             ============================================ -->
        <div class="page" id="teamPage">

            <!-- I Miei Team (Team a cui appartengo o che gestisco) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🏢</span> I Miei Team</div>
                    <span class="card-action" onclick="openModal('createTeamModal')">+ Crea Team</span>
                </div>
                <div id="myTeamsList" style="display:flex; flex-direction:column; gap:8px;">
                    <!-- Popolato dinamicamente -->
                </div>
                <!-- Cerca Team pubblici -->
                <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border-color);">
                    <button class="btn btn-secondary btn-sm" onclick="openModal('joinTeamModal')" style="width:100%;">
                        🔍 Cerca e Unisciti a un Team
                    </button>
                </div>
            </div>

            <!-- Richieste di Iscrizione (solo per admin/owner del team) -->
            <div class="card" id="teamJoinRequestsCard" style="display:none;">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📩</span> Richieste di Iscrizione</div>
                    <span class="badge badge-primary" id="pendingRequestsCount">0</span>
                </div>
                <div id="teamJoinRequestsList">
                    <!-- Popolato dinamicamente -->
                </div>
            </div>

            <!-- Team Members Bar -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">👥</span> Membri del Team</div>
                    <span class="card-action" onclick="openTeamManagement()">Gestisci Team</span>
                </div>
                <div class="team-members-grid" id="teamMembersGrid">
                    <!-- Popolato dinamicamente dai Team a cui appartieni -->
                </div>
                <div id="noTeamMembersHint" style="display:none; padding:12px; text-align:center; color:var(--text-muted); font-size:0.85rem;">
                    Unisciti a un Team nelle Impostazioni per vedere i membri
                </div>
            </div>

            <!-- Project Selector -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📁</span> Progetti</div>
                    <div style="display:flex; gap:8px;">
                        <span class="card-action" onclick="openArchivedProjectsModal()" title="Archivio & Template">📦</span>
                        <span class="card-action" onclick="openAddProjectModal()">+ Progetto</span>
                    </div>
                </div>
                <select class="form-input form-select" id="teamProjectSelect" onchange="loadTeamProject(this.value)" style="margin-top:8px;">
                    <option value="">Seleziona un progetto...</option>
                </select>
            </div>

            <!-- Team Alignment Map (shown when project selected) -->
            <div id="teamAlignmentMap" style="display:none;">

                <!-- Project Header -->
                <div class="team-project-header" id="teamProjectHeader">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div class="team-project-title" id="currentProjectTitle">Nome Progetto</div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportProjectCSV()" style="background:rgba(255,255,255,0.2); border:none;" title="Esporta CSV">
                                📊
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="openEditProjectModal()" style="background:rgba(255,255,255,0.2); border:none;" title="Modifica Progetto">
                                ✏️
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="openShareProject()" style="background:rgba(255,255,255,0.2); border:none;">
                                🔗 Condividi
                            </button>
                        </div>
                    </div>

                    <!-- Project Stats Bar -->
                    <div class="project-stats-bar">
                        <div class="project-stat">
                            <span class="project-stat-icon">⏳</span>
                            <span class="project-stat-value" id="projectDaysLeft">--</span>
                            <span class="project-stat-label">giorni rimasti</span>
                        </div>
                        <div class="project-stat">
                            <span class="project-stat-icon">📋</span>
                            <span class="project-stat-value" id="projectTotalTasks">0</span>
                            <span class="project-stat-label">task totali</span>
                        </div>
                        <div class="project-stat">
                            <span class="project-stat-icon">✅</span>
                            <span class="project-stat-value" id="projectCompletedTasks">0</span>
                            <span class="project-stat-label">completati</span>
                        </div>
                        <div class="project-stat">
                            <span class="project-stat-icon">📊</span>
                            <span class="project-stat-value" id="projectCompletionPercent">0%</span>
                            <span class="project-stat-label">completamento</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="project-progress-container">
                        <div class="project-progress-bar" id="projectProgressBar" style="width:0%"></div>
                    </div>

                    <div class="team-project-meta">
                        <span>📅 Scadenza: <span id="currentProjectDeadline">--</span></span>
                        <span>👥 Team: <span id="currentProjectTeamCount">0</span> membri</span>
                        <span id="projectSharingBadge" style="display:none;">🔗 Condiviso con <span id="sharedWithCount">0</span></span>
                    </div>

                    <!-- Obiettivo (cliccabile per modificare) -->
                    <div style="margin-top:12px; padding:12px; background:rgba(255,255,255,0.1); border-radius:8px; cursor:pointer;" onclick="openEditProjectModal()" title="Clicca per modificare">
                        <strong>🎯 Obiettivo:</strong> <span id="currentProjectObjective">--</span>
                        <span style="float:right; opacity:0.7; font-size:0.8rem;">✏️ modifica</span>
                    </div>
                </div>

                <!-- Kanban Board -->
                <div class="team-kanban">
                    <div class="team-kanban-column" data-status="todo" ondragover="allowDrop(event)" ondrop="dropTask(event, 'todo')">
                        <div class="team-kanban-header">
                            <span class="team-kanban-title">📋 Da Fare</span>
                            <span class="team-kanban-count" id="teamTodoCount">0</span>
                        </div>
                        <div class="team-kanban-tasks" id="teamTodoTasks">
                            <!-- Task cards -->
                        </div>
                        <button class="btn btn-ghost btn-sm" style="width:100%; margin-top:8px;" onclick="openAddTeamTask('todo')">
                            + Aggiungi Task
                        </button>
                    </div>

                    <div class="team-kanban-column" data-status="doing" ondragover="allowDrop(event)" ondrop="dropTask(event, 'doing')">
                        <div class="team-kanban-header">
                            <span class="team-kanban-title">🔄 In Corso</span>
                            <span class="team-kanban-count" id="teamDoingCount">0</span>
                        </div>
                        <div class="team-kanban-tasks" id="teamDoingTasks">
                            <!-- Task cards -->
                        </div>
                    </div>

                    <div class="team-kanban-column" data-status="done" ondragover="allowDrop(event)" ondrop="dropTask(event, 'done')">
                        <div class="team-kanban-header">
                            <span class="team-kanban-title">✅ Fatto</span>
                            <span class="team-kanban-count" id="teamDoneCount">0</span>
                        </div>
                        <div class="team-kanban-tasks" id="teamDoneTasks">
                            <!-- Task cards -->
                        </div>
                    </div>
                </div>

                <!-- Problems & Resources -->
                <div class="team-sidebar">
                    <div class="team-sidebar-card">
                        <div class="team-sidebar-title">⚠️ Problemi</div>
                        <div id="teamProblemsList">
                            <div class="empty-state" style="padding:16px; text-align:center; font-size:0.85rem;">
                                Nessun problema segnalato 🎉
                            </div>
                        </div>
                        <button class="btn btn-ghost btn-sm" style="width:100%; margin-top:8px;" onclick="openModal('addTeamProblemModal')">
                            + Segnala Problema
                        </button>
                    </div>

                    <div class="team-sidebar-card">
                        <div class="team-sidebar-title">📦 Risorse</div>
                        <div id="teamResourcesList">
                            <div class="empty-state" style="padding:16px; text-align:center; font-size:0.85rem;">
                                Nessuna risorsa aggiunta
                            </div>
                        </div>
                        <button class="btn btn-ghost btn-sm" style="width:100%; margin-top:8px;" onclick="openModal('addTeamResourceModal')">
                            + Aggiungi Risorsa
                        </button>
                    </div>

                    <!-- Bacheca Attività Progetto -->
                    <div class="team-sidebar-card">
                        <div class="team-sidebar-title" style="display:flex; justify-content:space-between; align-items:center;">
                            <span>📋 Bacheca Attività</span>
                            <button class="btn btn-ghost btn-xs" onclick="refreshProjectActivityLog()" title="Aggiorna">🔄</button>
                        </div>
                        <div id="projectActivityLog" style="max-height:300px; overflow-y:auto;">
                            <div class="empty-state" style="padding:16px; text-align:center; font-size:0.85rem;">
                                Nessuna attività recente
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State (no project selected) -->
            <div id="teamEmptyState">
                <div class="card" style="text-align:center; padding:40px;">
                    <div style="font-size:4rem; margin-bottom:16px;">👥</div>
                    <h3>Team Alignment Map</h3>
                    <p style="color:var(--text-muted); margin:16px 0;">Crea un progetto per iniziare a collaborare con il tuo team</p>
                    <button class="add-team-btn" style="max-width:250px; margin:0 auto;" onclick="openAddProjectModal()">
                        🎯 Crea Nuovo Progetto
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================
             PAGE: FOCUS (Pomodoro + Time Tracker unificati)
             ============================================ -->
        <div class="page" id="focusPage">

            <!-- Intention Setting Card -->
            <div class="intention-card" id="intentionCard" style="display:none;">
                <h4>🎯 Intenzione della Sessione</h4>
                <p style="font-size:0.9rem; opacity:0.9; margin-bottom:12px;">Cosa vuoi ottenere in questa sessione di focus?</p>
                <textarea class="form-input form-textarea" id="sessionIntention"
                          placeholder="Es: Completare la revisione del documento, scrivere 500 parole..."
                          style="min-height:80px; margin-bottom:12px;"></textarea>
                <button class="btn btn-primary" onclick="startFocusWithIntention()" style="width:100%;">
                    Inizia Sessione Focus
                </button>
            </div>

            <!-- Focus Timer Hero -->
            <div class="focus-hero">
                <div class="focus-timer-ring">
                    <svg viewBox="0 0 200 200">
                        <circle class="focus-ring-bg" cx="100" cy="100" r="90" />
                        <circle class="focus-ring-progress" id="focusRingProgress" cx="100" cy="100" r="90" />
                    </svg>
                    <div class="focus-timer-display">
                        <div class="focus-time" id="focusTimerDisplay">25:00</div>
                        <div class="focus-label" id="focusTimerLabel">Pronto per iniziare</div>
                    </div>
                </div>
            </div>

            <!-- Focus Controls -->
            <div class="focus-controls">
                <button class="btn btn-lg btn-secondary" onclick="resetFocusTimer()">
                    <span>🔄</span>
                </button>
                <button class="btn btn-lg btn-primary focus-main-btn" id="focusMainBtn" onclick="toggleFocusTimer()">
                    <span id="focusMainBtnIcon">▶️</span>
                    <span id="focusMainBtnText">Inizia</span>
                </button>
                <button class="btn btn-lg btn-secondary" onclick="skipFocusPhase()">
                    <span>⏭️</span>
                </button>
            </div>

            <!-- Session Type Selector -->
            <div class="focus-type-selector">
                <button class="focus-type-btn active" onclick="setFocusType('pomodoro', event)">🍅 Pomodoro</button>
                <button class="focus-type-btn" onclick="setFocusType('deepwork', event)">🧠 Deep Work</button>
                <button class="focus-type-btn" onclick="setFocusType('custom', event)">⏱️ Custom</button>
            </div>

            <!-- Current Task -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🎯</span> Sto lavorando su</div>
                    <span class="card-action" onclick="openModal('selectFocusTaskModal')">Cambia</span>
                </div>
                <div id="currentFocusTask" class="focus-current-task">
                    <div class="text-muted">Nessun task selezionato</div>
                    <button class="btn btn-sm btn-primary" onclick="openModal('selectFocusTaskModal')">Seleziona Task</button>
                </div>
            </div>

            <!-- Today's Focus Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">🍅</div>
                    <div class="stat-value" id="focusPomodorosToday">0</div>
                    <div class="stat-label">Pomodori</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⏱️</div>
                    <div class="stat-value" id="focusTimeToday">0h</div>
                    <div class="stat-label">Focus Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🔥</div>
                    <div class="stat-value" id="focusStreak">0</div>
                    <div class="stat-label">Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">😵</div>
                    <div class="stat-value" id="focusDistractions">0</div>
                    <div class="stat-label">Distrazioni</div>
                </div>
            </div>

            <!-- Distraction Log -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">😵</span> Log Distrazioni</div>
                    <span class="card-action" onclick="logDistraction()">+ Aggiungi</span>
                </div>
                <div id="distractionLog" class="text-muted text-center" style="padding:16px;">
                    Nessuna distrazione registrata 🎉
                </div>
            </div>

            <!-- Sessions History -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📊</span> Sessioni di Oggi</div>
                </div>
                <div id="focusSessionsHistory">
                    <div class="text-muted text-center" style="padding:16px;">
                        Nessuna sessione completata oggi
                    </div>
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: ANALYTICS
             ============================================ -->
        <div class="page" id="analyticsPage">

            <!-- Overview Stats -->
            <div class="analytics-grid">
                <div class="analytics-card">
                    <div class="analytics-value" id="totalXP">0</div>
                    <div class="analytics-label">XP Totali</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="currentLevel">1</div>
                    <div class="analytics-label">Livello</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="totalDays">0</div>
                    <div class="analytics-label">Giorni</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="badgesEarned">0</div>
                    <div class="analytics-label">Badge</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value" id="avgFocusScore">0</div>
                    <div class="analytics-label">Focus Medio</div>
                </div>
            </div>

            <!-- Productivity Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📊</span> Produttività Settimanale</div>
                </div>
                <div class="chart-container">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>

            <!-- Finance Chart -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">💰</span> Spese Settimanali</div>
                </div>
                <div class="chart-container">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>

            <!-- Habit Heatmap -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🔥</span> Consistenza Abitudini</div>
                </div>
                <div class="habit-heatmap" id="habitHeatmap">
                    <!-- Generato dinamicamente da renderHabitHeatmap() -->
                </div>
            </div>

            <!-- Time Distribution -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">⏰</span> Distribuzione Tempo</div>
                </div>
                <div id="timeDistribution">
                    <!-- Generato dinamicamente da renderTimeDistribution() -->
                </div>
            </div>

            <!-- Badges -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🏅</span> Badge</div>
                </div>
                <div class="badges-grid" id="badgesGrid"></div>
            </div>

            <!-- Productivity Heatmap (When you're most productive) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🗓️</span> Quando Sei Più Produttivo</div>
                </div>
                <div class="heatmap-labels">
                    <span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span>
                </div>
                <div class="heatmap-grid" id="productivityHeatmap">
                    <!-- Generated dynamically -->
                </div>
                <div class="text-muted text-sm mt-1" id="bestDayText">Analisi in corso...</div>
            </div>

            <!-- Correlations -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🔗</span> Correlazioni Scoperte</div>
                </div>
                <div id="correlationsList">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <!-- Personalized Tips -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">💡</span> Suggerimenti Personalizzati</div>
                </div>
                <div id="personalizedTips">
                    <!-- Generated dynamically -->
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: BOOKS (Reading Tracker with XP)
             ============================================ -->
        <div class="page" id="booksPage">

            <!-- Reading Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">📚</div>
                    <div class="stat-value" id="booksRead">0</div>
                    <div class="stat-label">Letti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📖</div>
                    <div class="stat-value" id="booksReading">0</div>
                    <div class="stat-label">In Lettura</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📄</div>
                    <div class="stat-value" id="pagesRead">0</div>
                    <div class="stat-label">Pagine</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-value" id="readingXP">0</div>
                    <div class="stat-label">XP Lettura</div>
                </div>
            </div>

            <!-- Currently Reading -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📖</span> In Lettura</div>
                    <span class="card-action" onclick="openModal('addBookModal')">+ Aggiungi</span>
                </div>
                <div id="currentlyReadingList">
                    <div class="empty-state" style="padding:20px;">
                        <div class="text-muted">Nessun libro in lettura</div>
                        <button class="btn btn-primary btn-sm mt-1" onclick="openModal('addBookModal')">+ Aggiungi Libro</button>
                    </div>
                </div>
            </div>

            <!-- Completed Books -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">✅</span> Completati</div>
                </div>
                <div id="completedBooksList">
                    <div class="empty-state" style="padding:20px;">
                        <div class="text-muted">Nessun libro completato</div>
                    </div>
                </div>
            </div>

            <!-- Reading Goal -->
            <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                <div class="card-header" style="border-bottom: none;">
                    <div class="card-title" style="color: white;"><span class="card-title-icon">🎯</span> Obiettivo Annuale</div>
                </div>
                <div style="text-align:center; padding-bottom:12px;">
                    <div style="font-size:3rem; font-weight:800;" id="readingGoalProgress">0/12</div>
                    <div style="opacity:0.9;">libri quest'anno</div>
                    <div class="book-progress-bar" style="margin-top:12px; background:rgba(255,255,255,0.3);">
                        <div class="book-progress-fill" id="readingGoalBar" style="width:0%; background:white;"></div>
                    </div>
                </div>
            </div>

            <!-- Libro del Mese -->
            <div class="card" id="bookOfMonthCard" style="display:none;">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">⭐</span> Libro del Mese</div>
                    <span class="badge" style="background:var(--accent);color:white;">Consigliato</span>
                </div>
                <div id="bookOfMonthContent">
                    <!-- Generato dinamicamente -->
                </div>
            </div>

            <!-- Libri Consigliati -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📚</span> Libri Consigliati</div>
                </div>

                <!-- Filtri Categorie -->
                <div class="book-categories-filter" id="bookCategoriesFilter">
                    <button class="book-category-btn active" onclick="filterRecommendedBooks('all')">🌟 Tutti</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('motivation')">🎯 Motivazione</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('productivity')">📈 Produttività</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('mindset')">🧠 Mindset</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('business')">💼 Business</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('finance')">💰 Finanza</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('communication')">🗣️ Comunicazione</button>
                    <button class="book-category-btn" onclick="filterRecommendedBooks('wellbeing')">🧘 Benessere</button>
                </div>

                <!-- Lista Libri Consigliati -->
                <div id="recommendedBooksList">
                    <!-- Generato dinamicamente -->
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: CHALLENGES
             ============================================ -->
        <div class="page" id="challengesPage">

            <!-- Active Challenges -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🏆</span> Sfide Attive</div>
                </div>
                <div id="activeChallengesList">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <!-- Achievements -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">🏅</span> Achievement</div>
                </div>
                <div class="achievement-grid" id="achievementGrid">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <!-- Leaderboard (Personal Best) -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="card-title-icon">📈</span> Record Personali</div>
                </div>
                <div id="personalRecords">
                    <!-- Generated dynamically -->
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: SETTINGS
             ============================================ -->
        <div class="page" id="settingsPage">

            <!-- Profile & Cloud Sync Unificato - SOLO GOOGLE -->
            <div class="card">
                <div class="card-title mb-2" style="display:flex;align-items:center;gap:8px;">
                    <img src="https://www.google.com/favicon.ico" alt="Google" style="width:18px;height:18px;">
                    <span>Account Google</span>
                </div>

                <!-- Profile Header con Avatar Google -->
                <div style="display:flex;align-items:center;gap:16px;padding:12px 0;border-bottom:1px solid var(--border);">
                    <div id="settingsProfileAvatar" style="width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg, #4285F4, #34A853);display:flex;align-items:center;justify-content:center;font-size:24px;color:white;overflow:hidden;">
                        U
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:1.1rem;" id="settingsProfileName">Utente</div>
                        <div style="color:var(--text-muted);font-size:0.85rem;display:flex;align-items:center;gap:4px;" id="settingsProfileEmail">
                            <span>email@esempio.com</span>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">
                            <span class="badge" style="background:#4285F4;color:white;" id="googleBadge">✓ Google connesso</span>
                            <span class="badge" id="settingsProfileLevel">Livello 1</span>
                            <span class="badge badge-secondary" id="settingsProfileXP">0 XP</span>
                        </div>
                    </div>
                </div>

                <!-- Sync Status Unificato -->
                <div class="toggle-row" style="margin-top:12px;" id="cloudSyncSection">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:1.3rem;">☁️</span>
                        <div>
                            <div class="toggle-label">Sincronizzazione</div>
                            <div class="toggle-desc">Ultima sync: <span id="lastSyncText">Mai</span></div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="forceSync()">🔄 Sync</button>
                </div>

                <!-- Google Calendar Status -->
                <div class="toggle-row">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:1.3rem;">📅</span>
                        <div>
                            <div class="toggle-label">Google Calendar</div>
                            <div class="toggle-desc" id="googleCalendarStatus">Connesso</div>
                        </div>
                    </div>
                    <span style="color:var(--success);font-weight:600;" id="calendarConnectedIcon">✓</span>
                </div>

                <!-- Calendario Default -->
                <div class="toggle-row" id="defaultCalendarRow" style="display:none;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:1.3rem;">⭐</span>
                        <div>
                            <div class="toggle-label">Calendario Predefinito</div>
                            <div class="toggle-desc">Usato per creare nuovi eventi</div>
                        </div>
                    </div>
                    <select class="form-input form-select" id="defaultCalendarSelect" style="width:auto;max-width:160px;" onchange="saveDefaultCalendar(this.value)">
                        <option value="primary">Principale</option>
                    </select>
                </div>

                <!-- Logout Button -->
                <div id="logoutSection" style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border-color);">
                    <button class="btn btn-secondary" onclick="confirmLogout()" style="width:100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                        <span>🚪</span>
                        <span>Esci dall'account Google</span>
                    </button>
                </div>
            </div>

            <!-- Personalizzazione Profilo -->
            <div class="card">
                <div class="card-title mb-2">✨ Personalizzazione</div>

                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Professione</div>
                        <div class="toggle-desc" id="settingsProfileProfession">Non impostata</div>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="openProfileModal()">Modifica</button>
                </div>

                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Nome d'Arte / Nickname</div>
                        <div class="toggle-desc" id="settingsProfileStageName">Non impostato</div>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="openProfileModal()">Modifica</button>
                </div>
            </div>

            <!-- Notifications -->
            <div class="card">
                <div class="card-title mb-2">🔔 Notifiche</div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Notifiche Push</div>
                        <div class="toggle-desc">Reminder giornalieri</div>
                    </div>
                    <div class="toggle-switch" id="notifToggle" onclick="toggleSetting('notifications')"></div>
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">🔔 Suono Notifiche</div>
                        <div class="toggle-desc">Riproduci suono per nuovi messaggi</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="btn btn-ghost btn-sm" onclick="playNotificationSound()" title="Test suono">🔊</button>
                        <div class="toggle-switch active" id="notifSoundToggle" onclick="toggleSetting('notificationSound')"></div>
                    </div>
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Orario Notifica</div>
                    </div>
                    <input type="time" class="form-input" id="notifTime" value="06:00" style="width:auto;">
                </div>
            </div>

            <!-- Finance Settings -->
            <div class="card">
                <div class="card-title mb-2">💰 Finanze</div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Valuta</div>
                    </div>
                    <select class="form-input form-select" id="currencySelect" style="width:auto;" onchange="saveSetting('currency', this.value)">
                        <option value="€" selected>€ EUR</option>
                        <option value="$">$ USD</option>
                        <option value="£">£ GBP</option>
                    </select>
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Budget Mensile</div>
                    </div>
                    <input type="number" class="form-input" id="monthlyBudgetInput" value="2000" style="width:100px;" onchange="saveSetting('monthlyBudget', this.value)">
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Budget Giornaliero Auto</div>
                        <div class="toggle-desc">Calcola automaticamente</div>
                    </div>
                    <div class="toggle-switch active" id="autoDailyBudget" onclick="toggleSetting('autoDailyBudget')"></div>
                </div>
            </div>

            <!-- Pomodoro -->
            <div class="card">
                <div class="card-title mb-2">🍅 Pomodoro</div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Durata Focus</div>
                    </div>
                    <select class="form-input form-select" id="pomodoroDuration" style="width:auto;" onchange="saveSetting('pomodoroDuration', this.value)">
                        <option value="15">15 min</option>
                        <option value="25" selected>25 min</option>
                        <option value="30">30 min</option>
                        <option value="45">45 min</option>
                        <option value="60">60 min</option>
                    </select>
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Durata Pausa</div>
                    </div>
                    <select class="form-input form-select" id="breakDuration" style="width:auto;" onchange="saveSetting('breakDuration', this.value)">
                        <option value="3">3 min</option>
                        <option value="5" selected>5 min</option>
                        <option value="10">10 min</option>
                    </select>
                </div>
            </div>

            <!-- Theme -->
            <div class="card">
                <div class="card-title mb-2">🎨 Aspetto</div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Tema Scuro</div>
                    </div>
                    <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()"></div>
                </div>
            </div>

            <!-- Guided Mode & Help -->
            <div class="card">
                <div class="card-title mb-2">🎓 Guida & Tutorial</div>
                <button class="btn btn-primary btn-block mb-1" onclick="restartGuidedTour()">🚀 Riavvia Tour Guidato</button>
                <button class="btn btn-secondary btn-block mb-1" onclick="startSpotlightTutorial()">💡 Tutorial Spotlight</button>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">Mostra Suggerimenti</div>
                        <div class="toggle-desc">Tips contestuali nelle pagine</div>
                    </div>
                    <div class="toggle-switch active" id="tipsToggle" onclick="toggleSetting('showTips')"></div>
                </div>
            </div>

            <!-- Data -->
            <div class="card">
                <div class="card-title mb-2">💾 Dati</div>
                <button class="btn btn-secondary btn-block mb-1" onclick="exportData()">📤 Esporta Dati</button>
                <button class="btn btn-secondary btn-block mb-1" onclick="importData()">📥 Importa Dati</button>
                <button class="btn btn-danger btn-block" onclick="confirmClearData()">🗑️ Cancella Tutto</button>
            </div>

            <!-- About & Credits -->
            <div class="card">
                <div class="card-title mb-2" style="text-align:center;">✨ Credits</div>
                <div style="text-align:center; padding:16px 0;">
                    <div style="font-size:2rem; margin-bottom:8px;">🎩</div>
                    <div style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:4px;">Mago Max S.A.V.E.R.S.</div>
                    <div style="font-size:0.9rem; color:var(--text-secondary); margin-bottom:16px;">v4.0 • Per Animatori & Spettacolo</div>

                    <div style="background:var(--bg-secondary); border-radius:var(--radius-lg); padding:16px; margin:12px 0;">
                        <div style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:4px;">Ideato e Creato da</div>
                        <div style="font-size:1.2rem; font-weight:700; color:var(--text-primary);">Massimiliano</div>
                        <div style="font-size:0.85rem; color:var(--primary); margin-top:4px;">aka Mago Max 🎭</div>
                    </div>

                    <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:16px; line-height:1.5;">
                        App per la gestione della produttività,<br>
                        crescita personale e team di animatori.<br><br>
                        <span style="font-size:1.2rem;">Made with ❤️ & ✨</span>
                    </div>

                    <!-- Admin Access (nascosto, visibile solo cliccando 5 volte sul logo) -->
                    <div id="adminAccessSection" style="display:none; margin-top:20px; padding-top:16px; border-top:1px solid var(--border-color);">
                        <button class="btn btn-sm" onclick="openSuperAdminPanel()" style="background:linear-gradient(135deg, #dc2626, #991b1b); color:white; width:100%;">
                            🛡️ Super Admin Panel
                        </button>
                    </div>

                    <!-- Link nascosto - clicca 5 volte su "v4.0" per mostrare admin -->
                    <div style="margin-top:12px;">
                        <span onclick="handleAdminReveal()" style="cursor:default; font-size:0.7rem; color:var(--text-muted); user-select:none;">
                            v4.0.1
                        </span>
                    </div>
                </div>
            </div>

        </div>

        <!-- ============================================
             PAGE: SHOP
             ============================================ -->
        <div class="page" id="shopPage">
            <div class="page-header" style="margin-bottom:20px;">
                <h1 style="font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:8px;">
                    <span>🛍️</span> Shop
                </h1>
                <p style="color:var(--text-secondary);font-size:0.9rem;margin-top:4px;">
                    I miei prodotti e strumenti per te
                </p>
            </div>

            <!-- Filtri Categorie -->
            <div class="filter-pills" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:12px;margin-bottom:16px;">
                <button class="pill active" onclick="filterProducts('all')" data-filter="all">Tutti</button>
                <button class="pill" onclick="filterProducts('digitale')" data-filter="digitale">Digitali</button>
                <button class="pill" onclick="filterProducts('fisico')" data-filter="fisico">Fisici</button>
                <button class="pill" onclick="filterProducts('bundle')" data-filter="bundle">Bundle</button>
            </div>

            <!-- Griglia Prodotti -->
            <div id="productsGrid" class="products-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
                <!-- Prodotti caricati dinamicamente -->
                <div class="skeleton-card" style="height:200px;"></div>
                <div class="skeleton-card" style="height:200px;"></div>
            </div>

            <!-- Empty State -->
            <div id="shopEmptyState" class="empty-state" style="display:none;text-align:center;padding:40px 20px;">
                <div style="font-size:3rem;margin-bottom:12px;">🛍️</div>
                <h3>Nessun prodotto disponibile</h3>
                <p style="color:var(--text-muted);">I prodotti saranno disponibili presto!</p>
            </div>
        </div>

        <!-- ============================================
             PAGE: VIDEOCORSI
             ============================================ -->
        <div class="page" id="coursesPage">
            <div class="page-header" style="margin-bottom:20px;">
                <h1 style="font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:8px;">
                    <span>🎓</span> Videocorsi
                </h1>
                <p style="color:var(--text-secondary);font-size:0.9rem;margin-top:4px;">
                    Impara nuove skill con i miei corsi
                </p>
            </div>

            <!-- Filtri Difficolta -->
            <div class="filter-pills" style="display:flex;gap:8px;overflow-x:auto;padding-bottom:12px;margin-bottom:16px;">
                <button class="pill active" onclick="filterCourses('all')" data-filter="all">Tutti</button>
                <button class="pill" onclick="filterCourses('beginner')" data-filter="beginner">Principiante</button>
                <button class="pill" onclick="filterCourses('intermediate')" data-filter="intermediate">Intermedio</button>
                <button class="pill" onclick="filterCourses('advanced')" data-filter="advanced">Avanzato</button>
            </div>

            <!-- Lista Corsi -->
            <div id="coursesGrid" class="courses-list" style="display:flex;flex-direction:column;gap:16px;">
                <!-- Corsi caricati dinamicamente -->
                <div class="skeleton-card" style="height:120px;"></div>
                <div class="skeleton-card" style="height:120px;"></div>
            </div>

            <!-- Empty State -->
            <div id="coursesEmptyState" class="empty-state" style="display:none;text-align:center;padding:40px 20px;">
                <div style="font-size:3rem;margin-bottom:12px;">🎓</div>
                <h3>Nessun corso disponibile</h3>
                <p style="color:var(--text-muted);">I videocorsi saranno disponibili presto!</p>
            </div>
        </div>

        <!-- ============================================
             PAGE: ADMIN PANEL (Solo per Admin)
             ============================================ -->
        <div class="page" id="adminPage">
            <div class="page-header" style="margin-bottom:20px;">
                <h1 style="font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:8px;">
                    <span>🛡️</span> Admin Panel
                </h1>
                <p style="color:var(--text-secondary);font-size:0.9rem;margin-top:4px;">
                    Gestisci contenuti e notifiche
                </p>
            </div>

            <!-- Tabs Admin -->
            <div class="admin-tabs" style="display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;">
                <button class="tab-btn active" onclick="switchAdminTab('products')" data-tab="products">🛍️ Prodotti</button>
                <button class="tab-btn" onclick="switchAdminTab('courses')" data-tab="courses">🎓 Corsi</button>
                <button class="tab-btn" onclick="switchAdminTab('notifications')" data-tab="notifications">🔔 Notifiche</button>
            </div>

            <!-- TAB: Gestione Prodotti -->
            <div class="admin-tab-content active" id="adminProductsTab">
                <button class="btn btn-primary" onclick="openModal('addProductModal')" style="width:100%;margin-bottom:16px;">
                    ➕ Aggiungi Prodotto
                </button>
                <div id="adminProductsList" class="admin-list">
                    <!-- Lista prodotti admin -->
                </div>
            </div>

            <!-- TAB: Gestione Corsi -->
            <div class="admin-tab-content" id="adminCoursesTab" style="display:none;">
                <button class="btn btn-primary" onclick="openModal('addCourseModal')" style="width:100%;margin-bottom:16px;">
                    ➕ Aggiungi Corso
                </button>
                <div id="adminCoursesList" class="admin-list">
                    <!-- Lista corsi admin -->
                </div>
            </div>

            <!-- TAB: Notifiche Push -->
            <div class="admin-tab-content" id="adminNotificationsTab" style="display:none;">
                <button class="btn btn-primary" onclick="openModal('sendNotificationModal')" style="width:100%;margin-bottom:16px;">
                    📤 Invia Notifica
                </button>
                <div id="notificationHistory" class="admin-list">
                    <!-- Storico notifiche -->
                </div>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('home')">
            <div class="nav-icon">🏠</div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" onclick="switchPage('tasks')">
            <div class="nav-icon">✅</div>
            <div class="nav-label">Tasks</div>
        </div>
        <div class="nav-item" onclick="switchPage('skills')">
            <div class="nav-icon">🎭</div>
            <div class="nav-label">Skills</div>
        </div>
        <div class="nav-item" onclick="switchPage('team')">
            <div class="nav-icon">👥</div>
            <div class="nav-label">Team</div>
        </div>
        <div class="nav-item" onclick="openModal('moreMenuModal')">
            <div class="nav-icon">☰</div>
            <div class="nav-label">Altro</div>
        </div>
    </nav>

    <!-- FAB Button -->
    <button class="btn btn-fab" onclick="openModal('quickAddModal')">➕</button>


    <!-- ============================================
         MODALS
         ============================================ -->

    <!-- More Menu Modal -->
    <div class="modal-overlay" id="moreMenuModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">☰ Menu</div>
                <button class="modal-close" onclick="closeModal('moreMenuModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="more-menu-grid">
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('shop');">
                        <div class="more-menu-icon">🛍️</div>
                        <div class="more-menu-label">Shop</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('courses');">
                        <div class="more-menu-icon">🎓</div>
                        <div class="more-menu-label">Videocorsi</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('analytics');">
                        <div class="more-menu-icon">📊</div>
                        <div class="more-menu-label">Analytics</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('goals');">
                        <div class="more-menu-icon">🎯</div>
                        <div class="more-menu-label">Obiettivi</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('habits');">
                        <div class="more-menu-icon">✨</div>
                        <div class="more-menu-label">Habits</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('focus');">
                        <div class="more-menu-icon">🍅</div>
                        <div class="more-menu-label">Focus</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('finance');">
                        <div class="more-menu-icon">💰</div>
                        <div class="more-menu-label">Finanze</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('routine');">
                        <div class="more-menu-icon">🌅</div>
                        <div class="more-menu-label">Routine</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('notes');">
                        <div class="more-menu-icon">📝</div>
                        <div class="more-menu-label">Note</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('time');">
                        <div class="more-menu-icon">⏱️</div>
                        <div class="more-menu-label">Time Log</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('settings');">
                        <div class="more-menu-icon">⚙️</div>
                        <div class="more-menu-label">Impostazioni</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); openDailyFlow();">
                        <div class="more-menu-icon">🔄</div>
                        <div class="more-menu-label">Daily Flow</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('books');">
                        <div class="more-menu-icon">📚</div>
                        <div class="more-menu-label">Libri</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); switchPage('challenges');">
                        <div class="more-menu-icon">🏆</div>
                        <div class="more-menu-label">Sfide</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); openModal('ambientSoundsModal');">
                        <div class="more-menu-icon">🎵</div>
                        <div class="more-menu-label">Suoni</div>
                    </button>
                    <button class="more-menu-item" onclick="closeModal('moreMenuModal'); openModal('energyModal');">
                        <div class="more-menu-icon">⚡</div>
                        <div class="more-menu-label">Energia</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Add Modal -->
    <div class="modal-overlay" id="quickAddModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">⚡ Quick Add</div>
                <button class="modal-close" onclick="closeModal('quickAddModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('addTaskModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">✅</div>
                        Task
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('addExpenseModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">💸</div>
                        Spesa
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('addIncomeModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">💰</div>
                        Entrata
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('scanReceiptModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">📷</div>
                        Scansiona
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('addNoteModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">📝</div>
                        Nota
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('addGoalModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">🎯</div>
                        Obiettivo
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); openModal('addHabitModal');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">✨</div>
                        Abitudine
                    </button>
                    <button class="btn btn-secondary" style="padding:20px;" onclick="closeModal('quickAddModal'); switchPage('habits');">
                        <div style="font-size:1.5rem; margin-bottom:4px;">📊</div>
                        Vedi Habits
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Select Focus Task Modal -->
    <div class="modal-overlay" id="selectFocusTaskModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎯 Seleziona Task</div>
                <button class="modal-close" onclick="closeModal('selectFocusTaskModal')">✕</button>
            </div>
            <div class="modal-body" id="focusTaskList">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal-overlay" id="addTaskModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">✅ Nuovo Task</div>
                <button class="modal-close" onclick="closeModal('addTaskModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titolo *</label>
                    <input type="text" class="form-input" id="taskTitle" placeholder="Cosa devi fare?">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <textarea class="form-input form-textarea" id="taskDesc" placeholder="Dettagli opzionali..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Scadenza</label>
                        <input type="date" class="form-input" id="taskDue">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorità</label>
                        <select class="form-input form-select" id="taskPriority">
                            <option value="low">🟢 Bassa</option>
                            <option value="medium" selected>🟡 Media</option>
                            <option value="high">🔴 Alta</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-input form-select" id="taskCategory">
                            <option value="work">💼 Lavoro</option>
                            <option value="personal">👤 Personale</option>
                            <option value="health">❤️ Salute</option>
                            <option value="finance">💰 Finanze</option>
                            <option value="learning">📚 Studio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quadrante</label>
                        <select class="form-input form-select" id="taskQuadrant">
                            <option value="1">Q1: Urgente+Importante</option>
                            <option value="2" selected>Q2: Importante</option>
                            <option value="3">Q3: Urgente</option>
                            <option value="4">Q4: Altro</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tempo Stimato (min)</label>
                        <input type="number" class="form-input" id="taskEstimate" value="30" min="5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-input form-select" id="taskDepartment">
                            <option value="work">🎭 Lavoro</option>
                            <option value="personal">👤 Vita Personale</option>
                        </select>
                    </div>
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">⭐ Top 3 di oggi</div>
                        <div class="toggle-desc">Task prioritario</div>
                    </div>
                    <div class="toggle-switch" id="taskTop3" onclick="this.classList.toggle('active')"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Ricorrenza</label>
                    <select class="form-input form-select" id="taskRecurrence">
                        <option value="none">Nessuna</option>
                        <option value="daily">🔄 Giornaliera</option>
                        <option value="weekly">📅 Settimanale</option>
                        <option value="monthly">📆 Mensile</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">📋 Checklist</label>
                    <div id="subtasksList" class="subtask-container"></div>
                    <div class="subtask-add-row">
                        <input type="text" class="form-input" id="newSubtaskInput" placeholder="Aggiungi un sottotask..." onkeypress="if(event.key==='Enter'){event.preventDefault();addSubtaskToForm();}">
                        <button class="btn btn-sm btn-secondary" onclick="addSubtaskToForm()">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Dipende da</label>
                    <select class="form-input form-select" id="taskDependsOn" multiple style="min-height:60px;">
                        <!-- Popolato dinamicamente -->
                    </select>
                    <div class="toggle-desc">Seleziona i task che devono essere completati prima</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTaskModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveTask()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal-overlay" id="addExpenseModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">💸 Nuova Spesa</div>
                <button class="modal-close" onclick="closeModal('addExpenseModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Importo *</label>
                    <div class="input-group">
                        <span class="input-group-icon">€</span>
                        <input type="number" class="form-input" id="expenseAmount" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <input type="text" class="form-input" id="expenseDesc" placeholder="Per cosa hai speso?">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-input form-select" id="expenseCategory">
                        <option value="food">🍕 Cibo & Ristoranti</option>
                        <option value="transport">🚗 Trasporti</option>
                        <option value="shopping">🛒 Shopping</option>
                        <option value="bills">📄 Bollette</option>
                        <option value="entertainment">🎮 Intrattenimento</option>
                        <option value="health">💊 Salute</option>
                        <option value="education">📚 Formazione</option>
                        <option value="home">🏠 Casa</option>
                        <option value="other">📦 Altro</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-input" id="expenseDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Metodo Pagamento</label>
                        <select class="form-input form-select" id="expenseMethod">
                            <option value="card">💳 Carta</option>
                            <option value="cash">💵 Contanti</option>
                            <option value="transfer">🏦 Bonifico</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-input form-select" id="expenseDepartment">
                            <option value="personal">👤 Personale</option>
                            <option value="work">🎭 Lavoro</option>
                        </select>
                    </div>
                    <div class="form-group" style="display:flex;align-items:center;padding-top:24px;">
                        <div class="toggle-switch" id="expenseRecurring" onclick="this.classList.toggle('active')"></div>
                        <span style="margin-left:8px;font-size:0.85rem;">🔄 Ricorrente</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addExpenseModal')">Annulla</button>
                <button class="btn btn-danger" onclick="saveExpense()">💾 Salva Spesa</button>
            </div>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div class="modal-overlay" id="addIncomeModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">💰 Nuova Entrata</div>
                <button class="modal-close" onclick="closeModal('addIncomeModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Importo *</label>
                    <div class="input-group">
                        <span class="input-group-icon">€</span>
                        <input type="number" class="form-input" id="incomeAmount" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <input type="text" class="form-input" id="incomeDesc" placeholder="Da dove arriva?">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria</label>
                    <select class="form-input form-select" id="incomeCategory">
                        <option value="salary">💼 Stipendio</option>
                        <option value="freelance">💻 Freelance</option>
                        <option value="investment">📈 Investimenti</option>
                        <option value="gift">🎁 Regalo</option>
                        <option value="refund">↩️ Rimborso</option>
                        <option value="other">📦 Altro</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-input" id="incomeDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-input form-select" id="incomeDepartment">
                            <option value="personal">👤 Personale</option>
                            <option value="work">🎭 Lavoro</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addIncomeModal')">Annulla</button>
                <button class="btn btn-success" onclick="saveIncome()">💾 Salva Entrata</button>
            </div>
        </div>
    </div>

    <!-- Split Transaction Modal -->
    <div class="modal-overlay" id="splitTransactionModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">➗ Dividi Spesa</div>
                <button class="modal-close" onclick="closeModal('splitTransactionModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Importo Totale *</label>
                    <div class="input-group">
                        <span class="input-group-icon">€</span>
                        <input type="number" class="form-input" id="splitTotalAmount" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <input type="text" class="form-input" id="splitDescription" placeholder="Es: Spesa supermercato">
                </div>
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" class="form-input" id="splitDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Divisione per Categoria</label>
                    <div id="splitCategoriesList"></div>
                    <button class="btn btn-sm btn-secondary" onclick="addSplitCategory()" style="margin-top:8px;">+ Aggiungi Categoria</button>
                </div>
                <div class="form-group">
                    <div class="text-muted" style="font-size:0.85rem;">
                        Totale diviso: <span id="splitTotalCheck">€0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('splitTransactionModal')">Annulla</button>
                <button class="btn btn-danger" onclick="saveSplitTransaction()">💾 Salva Spese</button>
            </div>
        </div>
    </div>

    <!-- Scan Receipt Modal (OCR) -->
    <div class="modal-overlay" id="scanReceiptModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📷 Scansiona Scontrino</div>
                <button class="modal-close" onclick="closeModal('scanReceiptModal'); resetScanner();">✕</button>
            </div>
            <div class="modal-body">
                <!-- Scanner Area -->
                <div class="scanner-area" id="scannerArea">
                    <div class="scanner-icon">📷</div>
                    <div class="scanner-text">Scansiona uno scontrino</div>
                    <div class="scanner-hint">Supporta scontrini, fatture, ricevute</div>

                    <!-- Tips per foto migliori -->
                    <div id="scannerTips" style="background:var(--bg-secondary); border-radius:var(--radius-sm); padding:12px; margin:16px 0; text-align:left;">
                        <div style="font-weight:600; font-size:0.85rem; margin-bottom:8px;">💡 Consigli per risultati migliori:</div>
                        <ul style="font-size:0.8rem; color:var(--text-secondary); margin:0; padding-left:20px; line-height:1.6;">
                            <li>Usa <strong>luce naturale</strong> ed evita ombre</li>
                            <li>Tieni lo scontrino <strong>piatto e fermo</strong></li>
                            <li>Inquadra tutto il testo, specialmente il <strong>totale</strong></li>
                            <li>Evita riflessi e sfocature</li>
                        </ul>
                    </div>

                    <div style="display:flex; gap:12px; margin-top:16px;">
                        <button class="btn btn-primary" onclick="triggerCamera()" style="flex:1;">
                            📸 Scatta Foto
                        </button>
                        <button class="btn btn-secondary" onclick="triggerGallery()" style="flex:1;">
                            🖼️ Galleria
                        </button>
                    </div>

                    <!-- Opzione inserimento manuale -->
                    <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
                        <button class="btn btn-ghost" onclick="showManualReceiptEntry()" style="width:100%; font-size:0.85rem;">
                            ✏️ Inserisci manualmente senza foto
                        </button>
                    </div>
                </div>
                <input type="file" id="receiptInputCamera" accept="image/*" capture="environment" style="display:none;" onchange="processReceipt(this)">
                <input type="file" id="receiptInputGallery" accept="image/*" style="display:none;" onchange="processReceipt(this)">

                <!-- Preview Image -->
                <img id="scannerPreview" class="scanner-preview">

                <!-- Processing Progress -->
                <div id="scannerProcessing" class="scanner-progress" style="display:none;">
                    <div class="scanner-progress-bar">
                        <div class="scanner-progress-fill" id="scannerProgressBar" style="width:0%;"></div>
                    </div>
                    <div class="scanner-progress-text" id="scannerProgressText">Analisi in corso...</div>
                </div>

                <!-- OCR Results / Manual Entry Form -->
                <div id="scannerResults" class="scanner-result" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-weight:600;">📋 Dati Spesa</div>
                        <span id="ocrConfidenceBadge" class="badge" style="display:none;"></span>
                    </div>

                    <!-- Avviso correzione -->
                    <div id="ocrCorrectionHint" style="background:rgba(245,158,11,0.1); border:1px solid var(--accent); border-radius:var(--radius-sm); padding:10px; margin-bottom:12px; display:none;">
                        <div style="font-size:0.85rem; color:var(--accent);">
                            ⚠️ <strong>Verifica i dati</strong> - L'OCR potrebbe aver commesso errori. Correggi se necessario.
                        </div>
                    </div>

                    <div class="scanner-result-row">
                        <span class="scanner-result-label">Negozio</span>
                        <input type="text" class="form-input" id="scannedStore" placeholder="es. Esselunga, Conad..." style="flex:1; padding:8px;">
                    </div>
                    <div class="scanner-result-row">
                        <span class="scanner-result-label">Totale €</span>
                        <input type="number" class="form-input" id="scannedAmount" style="width:120px; padding:8px; text-align:right; font-weight:600; font-size:1.1rem;" step="0.01" placeholder="0.00">
                    </div>
                    <div class="scanner-result-row">
                        <span class="scanner-result-label">Data</span>
                        <input type="date" class="form-input" id="scannedDate" style="width:auto; padding:8px;">
                    </div>
                    <div class="scanner-result-row">
                        <span class="scanner-result-label">Categoria</span>
                        <select class="form-input form-select" id="scannedCategory" style="flex:1; padding:8px;">
                            <option value="food">🍕 Cibo & Spesa</option>
                            <option value="restaurant">🍽️ Ristoranti & Bar</option>
                            <option value="shopping">🛒 Shopping</option>
                            <option value="transport">🚗 Trasporti</option>
                            <option value="fuel">⛽ Carburante</option>
                            <option value="health">💊 Salute & Farmacia</option>
                            <option value="bills">📄 Bollette</option>
                            <option value="entertainment">🎬 Svago</option>
                            <option value="subscription">📱 Abbonamenti</option>
                            <option value="other">📦 Altro</option>
                        </select>
                    </div>
                    <div class="scanner-result-row">
                        <span class="scanner-result-label">Metodo</span>
                        <select class="form-input form-select" id="scannedMethod" style="width:auto; padding:8px;">
                            <option value="card">💳 Carta</option>
                            <option value="cash">💵 Contanti</option>
                            <option value="satispay">📱 Satispay</option>
                            <option value="paypal">🅿️ PayPal</option>
                        </select>
                    </div>
                    <div class="scanner-result-row" style="flex-direction:column; align-items:stretch;">
                        <span class="scanner-result-label" style="margin-bottom:6px;">Note (opzionale)</span>
                        <input type="text" class="form-input" id="scannedNotes" placeholder="es. Spesa settimanale, regalo..." style="padding:8px;">
                    </div>

                    <!-- Quick amount buttons -->
                    <div style="margin-top:12px;">
                        <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">Importi rapidi:</div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button type="button" class="btn btn-ghost btn-sm" onclick="setQuickAmount(5)">€5</button>
                            <button type="button" class="btn btn-ghost btn-sm" onclick="setQuickAmount(10)">€10</button>
                            <button type="button" class="btn btn-ghost btn-sm" onclick="setQuickAmount(20)">€20</button>
                            <button type="button" class="btn btn-ghost btn-sm" onclick="setQuickAmount(50)">€50</button>
                            <button type="button" class="btn btn-ghost btn-sm" onclick="setQuickAmount(100)">€100</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="scannerFooter" style="display:none;">
                <button class="btn btn-secondary" onclick="resetScanner()">🔄 Ricomincia</button>
                <button class="btn btn-primary" onclick="saveScannedReceipt()">💾 Salva Spesa</button>
            </div>
        </div>
    </div>

    <!-- Work-Life Balance Info Modal -->
    <div class="modal-overlay" id="workLifeInfoModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">⚖️ Equilibrio Vita/Lavoro</div>
                <button class="modal-close" onclick="closeModal('workLifeInfoModal')">✕</button>
            </div>
            <div class="modal-body">
                <!-- Filtri -->
                <div style="background:var(--bg-secondary); border-radius:var(--radius); padding:16px; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <span style="font-size:1.5rem;">🌟</span>
                        <div>
                            <div style="font-weight:700;">Tutto</div>
                            <div style="font-size:0.85rem; color:var(--text-secondary);">Visualizza tutti i task ed eventi, sia personali che lavorativi</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                        <span style="font-size:1.5rem;">👤</span>
                        <div>
                            <div style="font-weight:700;">Vita</div>
                            <div style="font-size:0.85rem; color:var(--text-secondary);">Filtra solo i contenuti personali: abitudini, routine, obiettivi di vita</div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span style="font-size:1.5rem;">🎭</span>
                        <div>
                            <div style="font-weight:700;">Lavoro</div>
                            <div style="font-size:0.85rem; color:var(--text-secondary);">Filtra solo i contenuti lavorativi: task di lavoro, eventi professionali</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Box -->
                <div style="background:var(--bg-secondary); border-radius:var(--radius); padding:16px; margin-bottom:16px;">
                    <div style="font-weight:700; margin-bottom:12px;">📊 Box Statistiche</div>
                    <div style="font-size:0.9rem; color:var(--text-secondary); line-height:1.6;">
                        I due riquadri mostrano le tue statistiche divise per area:
                        <ul style="margin:8px 0 0 20px;">
                            <li><strong>Lavoro:</strong> Task completati, ore di focus, eventi</li>
                            <li><strong>Vita:</strong> Routine S.A.V.E.R.S., abitudini, livello energia</li>
                        </ul>
                    </div>
                </div>

                <!-- Balance Bar -->
                <div style="background:var(--bg-secondary); border-radius:var(--radius); padding:16px;">
                    <div style="font-weight:700; margin-bottom:12px;">⚖️ Barra dell'Equilibrio</div>
                    <div style="font-size:0.9rem; color:var(--text-secondary); line-height:1.6;">
                        La barra mostra il rapporto tra attività lavorative e personali:
                        <ul style="margin:8px 0 0 20px;">
                            <li><strong>50%</strong> = Equilibrio perfetto 🎯</li>
                            <li><strong>Verso destra</strong> = Più focus sul lavoro</li>
                            <li><strong>Verso sinistra</strong> = Più focus sulla vita personale</li>
                        </ul>
                        <div style="margin-top:12px; padding:10px; background:rgba(99,102,241,0.1); border-radius:8px;">
                            💡 <strong>Consiglio:</strong> Un buon equilibrio migliora produttività e benessere. Se la barra è troppo spostata da un lato, prova a bilanciare le tue attività!
                        </div>
                    </div>
                </div>

                <!-- Come usare i filtri -->
                <div style="margin-top:16px; padding:16px; background:linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius:var(--radius); color:white;">
                    <div style="font-weight:700; margin-bottom:8px;">🎯 Come usarlo</div>
                    <div style="font-size:0.9rem; opacity:0.95;">
                        Quando crei un task o evento, puoi assegnarlo a "Vita" o "Lavoro". Poi usa i filtri per visualizzare solo ciò che ti serve in quel momento!
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('workLifeInfoModal')">Ho capito! 👍</button>
            </div>
        </div>
    </div>

    <!-- Add Money Goal Modal -->
    <div class="modal-overlay" id="addMoneyGoalModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎯 Nuovo Obiettivo Finanziario</div>
                <button class="modal-close" onclick="closeModal('addMoneyGoalModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Obiettivo *</label>
                    <input type="text" class="form-input" id="moneyGoalName" placeholder="es. Fondo Emergenza, Vacanza...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Obiettivo (€) *</label>
                        <input type="number" class="form-input" id="moneyGoalTarget" placeholder="10000" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Già Risparmiato (€)</label>
                        <input type="number" class="form-input" id="moneyGoalCurrent" placeholder="0" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Data Obiettivo</label>
                    <input type="date" class="form-input" id="moneyGoalDeadline">
                </div>
                <div class="form-group">
                    <label class="form-label">Icona</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon active" onclick="selectMoneyGoalIcon(this, '🏦')">🏦</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '🏠')">🏠</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '🚗')">🚗</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '✈️')">✈️</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '💻')">💻</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '📱')">📱</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '🎓')">🎓</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '💍')">💍</button>
                        <button type="button" class="btn btn-secondary btn-sm money-goal-icon" onclick="selectMoneyGoalIcon(this, '🎁')">🎁</button>
                    </div>
                    <input type="hidden" id="moneyGoalIcon" value="🏦">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addMoneyGoalModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveMoneyGoal()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div class="modal-overlay" id="addGoalModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎯 Nuovo Obiettivo</div>
                <button class="modal-close" onclick="closeModal('addGoalModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Obiettivo *</label>
                    <input type="text" class="form-input" id="goalTitle" placeholder="Cosa vuoi raggiungere?">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <textarea class="form-input form-textarea" id="goalDesc" placeholder="Perché è importante?"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Periodo</label>
                        <select class="form-input form-select" id="goalPeriod">
                            <option value="weekly">Settimanale</option>
                            <option value="monthly" selected>Mensile</option>
                            <option value="quarterly">Trimestrale</option>
                            <option value="yearly">Annuale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Scadenza</label>
                        <input type="date" class="form-input" id="goalDeadline">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Key Results (opzionale)</label>
                        <div id="keyResultsContainer">
                            <input type="text" class="form-input mb-1" placeholder="Key Result 1" data-kr="1">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addKeyResultInput()">+ Aggiungi KR</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-input form-select" id="goalDepartment">
                            <option value="work">🎭 Lavoro</option>
                            <option value="personal">👤 Vita Personale</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addGoalModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveGoal()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div class="modal-overlay" id="addNoteModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📝 Nuova Nota</div>
                <button class="modal-close" onclick="closeModal('addNoteModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titolo</label>
                    <input type="text" class="form-input" id="noteTitle" placeholder="Titolo nota">
                </div>
                <div class="form-group">
                    <label class="form-label">Contenuto</label>
                    <textarea class="form-input" id="noteContent" placeholder="Scrivi qui..." style="min-height:200px;"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Tags (separati da virgola)</label>
                        <input type="text" class="form-input" id="noteTags" placeholder="es. idea, progetto, importante">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-input form-select" id="noteDepartment">
                            <option value="work">🎭 Lavoro</option>
                            <option value="personal">👤 Vita Personale</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addNoteModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveNote()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Add Habit Modal -->
    <div class="modal-overlay" id="addHabitModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">✨ Nuova Abitudine</div>
                <button class="modal-close" onclick="closeModal('addHabitModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome *</label>
                    <input type="text" class="form-input" id="habitName" placeholder="es. Meditare 10 minuti">
                </div>
                <div class="form-group">
                    <label class="form-label">Icona</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-secondary btn-sm habit-icon active" onclick="selectHabitIcon(this, '🧘')">🧘</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '📚')">📚</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '💪')">💪</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '💧')">💧</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '🏃')">🏃</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '✍️')">✍️</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '🎯')">🎯</button>
                        <button type="button" class="btn btn-secondary btn-sm habit-icon" onclick="selectHabitIcon(this, '😴')">😴</button>
                    </div>
                    <input type="hidden" id="habitIcon" value="🧘">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Frequenza</label>
                        <select class="form-input form-select" id="habitFrequency">
                            <option value="daily">Giornaliera</option>
                            <option value="weekdays">Giorni feriali</option>
                            <option value="weekly">Settimanale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Area</label>
                        <select class="form-input form-select" id="habitDepartment">
                            <option value="personal">👤 Vita Personale</option>
                            <option value="work">🎭 Lavoro</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addHabitModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveHabit()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="addEventModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📅 Nuovo Evento</div>
                <button class="modal-close" onclick="closeModal('addEventModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titolo *</label>
                    <input type="text" class="form-input" id="eventTitle" placeholder="Nome evento">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <input type="date" class="form-input" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ora Inizio</label>
                        <input type="time" class="form-input" id="eventStartTime" value="09:00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Durata</label>
                        <select class="form-input form-select" id="eventDuration">
                            <option value="30">30 min</option>
                            <option value="60" selected>1 ora</option>
                            <option value="90">1.5 ore</option>
                            <option value="120">2 ore</option>
                            <option value="150">2.5 ore</option>
                            <option value="180">3 ore</option>
                            <option value="240">4 ore</option>
                            <option value="480">Tutto il giorno</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select class="form-input form-select" id="eventType">
                            <option value="show">🎭 Spettacolo</option>
                            <option value="rehearsal">🎯 Prova</option>
                            <option value="meeting">👥 Meeting</option>
                            <option value="personal">👤 Personale</option>
                            <option value="other">📌 Altro</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">📂 Area</label>
                    <div class="dept-selector" style="display:flex; gap:8px;">
                        <button type="button" class="dept-select-btn" data-dept="work" onclick="selectEventDepartment('work')">
                            <span>🎭</span> Lavoro
                        </button>
                        <button type="button" class="dept-select-btn active" data-dept="personal" onclick="selectEventDepartment('personal')">
                            <span>👤</span> Vita
                        </button>
                    </div>
                    <input type="hidden" id="eventDepartment" value="personal">
                </div>
                <div class="form-group">
                    <label class="form-label">Luogo</label>
                    <input type="text" class="form-input" id="eventLocation" placeholder="Dove si svolge?">
                </div>
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea class="form-input form-textarea" id="eventNotes" placeholder="Dettagli aggiuntivi..."></textarea>
                </div>
                <div class="form-group" id="eventAttendeesGroup">
                    <label class="form-label">👥 Invita Partecipanti</label>
                    <div id="eventAttendeesInput" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;"></div>
                    <div style="display:flex;gap:8px;position:relative;">
                        <input type="text" class="form-input" id="eventAttendeeEmail" placeholder="Cerca membro del team o inserisci email..." style="flex:1;" oninput="showAttendeeSuggestions()" onfocus="showAttendeeSuggestions()" autocomplete="off">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addEventAttendee()">+ Aggiungi</button>
                        <!-- Dropdown suggerimenti team members -->
                        <div id="attendeeSuggestions" style="display:none; position:absolute; top:100%; left:0; right:60px; background:var(--bg-primary); border:1px solid var(--border-color); border-radius:8px; max-height:200px; overflow-y:auto; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                    <div class="text-muted" style="font-size:0.75rem;margin-top:4px;">Digita per cercare membri del team o inserisci un'email</div>
                </div>
                <div class="form-group" id="eventCalendarSelectGroup" style="display:none;">
                    <label class="form-label">☁️ Calendario Google</label>
                    <select class="form-input form-select" id="eventCalendarSelect">
                        <option value="">-- Seleziona calendario --</option>
                    </select>
                </div>
                <div class="toggle-row">
                    <div>
                        <div class="toggle-label">☁️ Sincronizza con Google</div>
                        <div class="toggle-desc">Aggiungi anche a Google Calendar</div>
                    </div>
                    <div class="toggle-switch" id="eventSyncGoogle" onclick="toggleEventGoogleSync()"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addEventModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveEvent()">💾 Salva Evento</button>
            </div>
        </div>
    </div>

    <!-- Busy/Non Disponibile Modal -->
    <div class="modal-overlay" id="busyModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🚫 Non Disponibile</div>
                <button class="modal-close" onclick="closeModal('busyModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Motivo (opzionale)</label>
                    <input type="text" class="form-input" id="busyReason" placeholder="es. Impegno personale, Viaggio...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data Inizio</label>
                        <input type="date" class="form-input" id="busyDateStart">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Fine</label>
                        <input type="date" class="form-input" id="busyDateEnd">
                    </div>
                </div>
                <div class="toggle-row" style="margin-bottom:12px;">
                    <div>
                        <div class="toggle-label">Tutto il giorno</div>
                        <div class="toggle-desc">Blocca l'intera giornata</div>
                    </div>
                    <div class="toggle-switch" id="busyAllDay" onclick="toggleBusyAllDay()"></div>
                </div>
                <div id="busyTimeSection" style="display:block;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ora Inizio</label>
                            <input type="time" class="form-input" id="busyTimeStart" value="09:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ora Fine</label>
                            <input type="time" class="form-input" id="busyTimeEnd" value="18:00">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Luogo (opzionale)</label>
                    <input type="text" class="form-input" id="busyLocation" placeholder="es. Fuori città, Milano...">
                </div>

                <!-- Ricorrenza -->
                <div class="toggle-row" style="margin:12px 0;">
                    <div>
                        <div class="toggle-label">🔁 Si ripete</div>
                        <div class="toggle-desc">Evento ricorrente</div>
                    </div>
                    <div class="toggle-switch" id="busyRecurring" onclick="toggleBusyRecurring()"></div>
                </div>
                <div id="busyRecurrenceSection" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Frequenza</label>
                        <select class="form-input form-select" id="busyRecurrenceType" onchange="updateBusyRecurrenceOptions()">
                            <option value="daily">Ogni giorno</option>
                            <option value="weekly" selected>Ogni settimana</option>
                            <option value="biweekly">Ogni 2 settimane</option>
                            <option value="monthly">Ogni mese</option>
                            <option value="yearly">Ogni anno</option>
                            <option value="custom">Personalizzato...</option>
                        </select>
                    </div>
                    <div id="busyWeekdaysSection" style="display:none; margin-bottom:12px;">
                        <label class="form-label" style="margin-bottom:8px;">Giorni della settimana</label>
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <label class="weekday-check"><input type="checkbox" value="MO" id="busyDay_MO"> Lun</label>
                            <label class="weekday-check"><input type="checkbox" value="TU" id="busyDay_TU"> Mar</label>
                            <label class="weekday-check"><input type="checkbox" value="WE" id="busyDay_WE"> Mer</label>
                            <label class="weekday-check"><input type="checkbox" value="TH" id="busyDay_TH"> Gio</label>
                            <label class="weekday-check"><input type="checkbox" value="FR" id="busyDay_FR"> Ven</label>
                            <label class="weekday-check"><input type="checkbox" value="SA" id="busyDay_SA"> Sab</label>
                            <label class="weekday-check"><input type="checkbox" value="SU" id="busyDay_SU"> Dom</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Termina</label>
                        <select class="form-input form-select" id="busyRecurrenceEnd" onchange="updateBusyEndOptions()">
                            <option value="never">Mai</option>
                            <option value="date">In una data specifica</option>
                            <option value="count">Dopo N occorrenze</option>
                        </select>
                    </div>
                    <div id="busyEndDateSection" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">Data fine</label>
                            <input type="date" class="form-input" id="busyRecurrenceEndDate">
                        </div>
                    </div>
                    <div id="busyEndCountSection" style="display:none;">
                        <div class="form-group">
                            <label class="form-label">Numero di occorrenze</label>
                            <input type="number" class="form-input" id="busyRecurrenceCount" value="10" min="1" max="365">
                        </div>
                    </div>
                </div>

                <div class="form-group" id="busyCalendarSelectGroup" style="display:none;">
                    <label class="form-label">☁️ Calendario Google</label>
                    <select class="form-input form-select" id="busyCalendarSelect">
                        <option value="">-- Seleziona calendario --</option>
                    </select>
                </div>
                <div style="background:var(--bg-secondary);padding:12px;border-radius:8px;margin-top:8px;">
                    <div style="font-size:0.85rem;color:var(--text-muted);">
                        ℹ️ Questo evento verrà creato come "Occupato" su Google Calendar, bloccando lo slot per altri.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('busyModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveBusyEvent()">🚫 Segna Non Disponibile</button>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal-overlay" id="addBookModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📚 Nuovo Libro</div>
                <button class="modal-close" onclick="closeModal('addBookModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titolo *</label>
                    <input type="text" class="form-input" id="bookTitle" placeholder="es. Atomic Habits">
                </div>
                <div class="form-group">
                    <label class="form-label">Autore</label>
                    <input type="text" class="form-input" id="bookAuthor" placeholder="es. James Clear">
                </div>
                <div class="form-group">
                    <label class="form-label">Pagine Totali</label>
                    <input type="number" class="form-input" id="bookPages" placeholder="es. 320" value="300">
                </div>
                <div class="form-group">
                    <label class="form-label">Pagine Lette</label>
                    <input type="number" class="form-input" id="bookPagesRead" placeholder="es. 50" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addBookModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveBook()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Book Detail Modal -->
    <div class="modal-overlay" id="bookDetailModal">
        <div class="modal" style="max-height:90vh;overflow-y:auto;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📖 Dettagli Libro</div>
                <button class="modal-close" onclick="closeModal('bookDetailModal')">✕</button>
            </div>
            <div class="modal-body" id="bookDetailContent">
                <!-- Generato dinamicamente -->
            </div>
            <div class="modal-footer" id="bookDetailFooter">
                <button class="btn btn-secondary" onclick="closeModal('bookDetailModal')">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Add Skill Modal -->
    <div class="modal-overlay" id="addSkillModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎭 Nuova Skill</div>
                <button class="modal-close" onclick="closeModal('addSkillModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Skill *</label>
                    <input type="text" class="form-input" id="skillName" placeholder="es. Magia Close-Up, Balloon Art...">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoria *</label>
                    <select class="form-input form-select" id="skillCategory">
                        <option value="performance">🎭 Performance (Magia, Giocoleria, Clown...)</option>
                        <option value="technique">🎨 Tecniche (Palloncini, Face Painting...)</option>
                        <option value="business">💼 Business (Marketing, Vendita...)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Icona</label>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🎩')">🎩</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🎪')">🎪</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🤹')">🤹</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🎈')">🎈</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🎨')">🎨</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🃏')">🃏</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🎤')">🎤</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('📱')">📱</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('💰')">💰</button>
                        <button type="button" class="btn btn-secondary btn-sm skill-icon-btn" onclick="selectSkillIcon('🎯')">🎯</button>
                    </div>
                    <input type="hidden" id="skillIcon" value="🎩">
                </div>
                <div class="form-group">
                    <label class="form-label">Livello Attuale</label>
                    <select class="form-input form-select" id="skillLevel">
                        <option value="1">⭐ Principiante</option>
                        <option value="2">⭐⭐ Base</option>
                        <option value="3">⭐⭐⭐ Intermedio</option>
                        <option value="4">⭐⭐⭐⭐ Avanzato</option>
                        <option value="5">⭐⭐⭐⭐⭐ Maestro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Area</label>
                    <select class="form-input form-select" id="skillDepartment">
                        <option value="work">🎭 Lavoro</option>
                        <option value="personal">👤 Personale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea class="form-input form-textarea" id="skillNotes" placeholder="Obiettivi, risorse da studiare..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addSkillModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveSkill()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Practice Skill Modal -->
    <div class="modal-overlay" id="practiceSkillModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎯 Registra Pratica</div>
                <button class="modal-close" onclick="closeModal('practiceSkillModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="practiceSkillId" value="">
                <div id="practiceSkillInfo" style="text-align:center; margin-bottom:20px;">
                    <h3 id="practiceSkillName">Skill</h3>
                </div>
                <div class="form-group">
                    <label class="form-label">Durata Pratica (minuti)</label>
                    <input type="number" class="form-input" id="practiceMinutes" value="30" min="5">
                </div>
                <div class="form-group">
                    <label class="form-label">Cosa hai praticato?</label>
                    <textarea class="form-input form-textarea" id="practiceNotes" placeholder="Descrivi cosa hai fatto..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('practiceSkillModal')">Annulla</button>
                <button class="btn btn-primary" onclick="savePractice()">✅ Registra +XP</button>
            </div>
        </div>
    </div>

    <!-- Add Team Member Modal RIMOSSO - ora i membri vengono dai Team -->

    <!-- Add Team Project Modal -->
    <div class="modal-overlay" id="addTeamProjectModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎯 Nuovo Progetto Team</div>
                <button class="modal-close" onclick="closeModal('addTeamProjectModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Progetto *</label>
                    <input type="text" class="form-input" id="projectName" placeholder="es. Festa Aziendale XYZ">
                </div>
                <div class="form-group">
                    <label class="form-label">Obiettivo *</label>
                    <textarea class="form-input form-textarea" id="projectObjective" placeholder="es. Intrattenere 200 ospiti per 3 ore"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Scadenza</label>
                    <input type="date" class="form-input" id="projectDeadline">
                </div>
                <div class="form-group">
                    <label class="form-label">Membri del Team</label>
                    <div id="projectMembersSelect" style="display:flex; flex-wrap:wrap; gap:8px;">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTeamProjectModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveTeamProject()">💾 Crea Progetto</button>
            </div>
        </div>
    </div>

    <!-- Add Team Task Modal -->
    <div class="modal-overlay" id="addTeamTaskModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📋 Nuovo Task Team</div>
                <button class="modal-close" onclick="closeModal('addTeamTaskModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titolo Task *</label>
                    <input type="text" class="form-input" id="teamTaskTitle" placeholder="es. Preparare numero magia">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <textarea class="form-input form-textarea" id="teamTaskDesc" placeholder="Dettagli del task..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">📅 Scadenza Task</label>
                    <input type="date" class="form-input" id="newTeamTaskDeadline">
                </div>
                <div class="form-group">
                    <label class="form-label">👥 Assegna a (puoi selezionare più persone)</label>
                    <div id="newTeamTaskAssignees" class="assignees-checklist">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
                <input type="hidden" id="teamTaskStatus" value="todo">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTeamTaskModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveTeamTask()">💾 Aggiungi</button>
            </div>
        </div>
    </div>

    <!-- Add Team Problem Modal -->
    <div class="modal-overlay" id="addTeamProblemModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">⚠️ Segnala Problema</div>
                <button class="modal-close" onclick="closeModal('addTeamProblemModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Descrizione Problema *</label>
                    <input type="text" class="form-input" id="problemTitle" placeholder="es. Manca materiale palloncini">
                </div>
                <div class="form-group">
                    <label class="form-label">Priorità</label>
                    <select class="form-input form-select" id="problemPriority">
                        <option value="high">🔴 Alta - Urgente</option>
                        <option value="medium" selected>🟡 Media</option>
                        <option value="low">🟢 Bassa</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTeamProblemModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveTeamProblem()">⚠️ Segnala</button>
            </div>
        </div>
    </div>

    <!-- Add Team Resource Modal -->
    <div class="modal-overlay" id="addTeamResourceModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📦 Aggiungi Risorsa</div>
                <button class="modal-close" onclick="closeModal('addTeamResourceModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Risorsa *</label>
                    <input type="text" class="form-input" id="resourceTitle" placeholder="es. Scheda tecnica venue">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-input form-select" id="resourceType">
                        <option value="document">📄 Documento</option>
                        <option value="link">🔗 Link</option>
                        <option value="contact">👤 Contatto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">URL / Info</label>
                    <input type="text" class="form-input" id="resourceUrl" placeholder="Link o informazioni">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addTeamResourceModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveTeamResource()">💾 Aggiungi</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div class="modal-overlay" id="editProjectModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">✏️ Modifica Progetto</div>
                <button class="modal-close" onclick="closeModal('editProjectModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Progetto *</label>
                    <input type="text" class="form-input" id="editProjectName" placeholder="Nome del progetto">
                </div>
                <div class="form-group">
                    <label class="form-label">🎯 Obiettivo *</label>
                    <textarea class="form-input form-textarea" id="editProjectObjective" placeholder="Qual è l'obiettivo principale di questo progetto?" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">📅 Scadenza</label>
                    <input type="date" class="form-input" id="editProjectDeadline">
                </div>
                <div class="form-group">
                    <label class="form-label">📝 Note</label>
                    <textarea class="form-input form-textarea" id="editProjectNotes" placeholder="Note aggiuntive..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">👥 Membri del Progetto</label>
                    <div id="editProjectMembersSelect" style="display:flex; flex-wrap:wrap; gap:8px; max-height:150px; overflow-y:auto;">
                        <!-- Popolato dinamicamente -->
                    </div>
                    <div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">
                        Seleziona i membri del team che lavorano a questo progetto
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentProject()" style="margin-right:auto;">🗑️ Elimina</button>
                <button class="btn btn-ghost" onclick="exportProjectCSV()" title="Esporta in CSV">📊 Export CSV</button>
                <button class="btn btn-ghost" onclick="archiveProject()" title="Archivia progetto">📦 Archivia</button>
                <button class="btn btn-secondary" onclick="closeModal('editProjectModal')">Annulla</button>
                <button class="btn btn-primary" onclick="updateProject()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Edit Team Task Modal (with Comments) -->
    <div class="modal-overlay" id="editTeamTaskModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📋 Dettaglio Task</div>
                <button class="modal-close" onclick="closeModal('editTeamTaskModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTeamTaskId">

                <!-- Task Info -->
                <div class="form-group">
                    <label class="form-label">Titolo *</label>
                    <input type="text" class="form-input" id="editTeamTaskTitle" placeholder="Titolo del task">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <textarea class="form-input form-textarea" id="editTeamTaskDesc" placeholder="Descrizione dettagliata..." rows="2"></textarea>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label class="form-label">📅 Scadenza Task</label>
                        <input type="date" class="form-input" id="editTeamTaskDeadline">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stato</label>
                        <select class="form-input form-select" id="editTeamTaskStatus">
                            <option value="todo">📋 Da Fare</option>
                            <option value="doing">🔄 In Corso</option>
                            <option value="done">✅ Fatto</option>
                        </select>
                    </div>
                </div>

                <!-- Assegnatari Multipli -->
                <div class="form-group">
                    <label class="form-label">👥 Assegna a (puoi selezionare più persone)</label>
                    <div id="editTeamTaskAssignees" class="assignees-checklist">
                        <!-- Popolato dinamicamente con checkbox -->
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="form-group" style="margin-top:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <label class="form-label" style="margin:0;">💬 Commenti <span class="text-muted text-xs">(usa @nome per menzionare)</span></label>
                        <button class="btn btn-ghost btn-xs" onclick="manualRefreshComments()" title="Aggiorna commenti" style="padding:4px 8px;">
                            🔄 <span id="commentsRefreshStatus"></span>
                        </button>
                    </div>
                    <div id="teamTaskComments" class="task-comments-list">
                        <!-- Commenti popolati dinamicamente -->
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px; position:relative;">
                        <input type="text" class="form-input" id="newTeamTaskComment"
                               placeholder="Scrivi un commento... @nome per menzionare"
                               style="flex:1;"
                               oninput="handleCommentInput(event)"
                               onkeydown="handleCommentKeydown(event)">
                        <div id="mentionAutocomplete" class="mention-autocomplete"></div>
                        <button class="btn btn-secondary" onclick="addTeamTaskComment()">💬</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentTeamTask()" style="margin-right:auto;">🗑️ Elimina</button>
                <button class="btn btn-secondary" onclick="closeModal('editTeamTaskModal')">Annulla</button>
                <button class="btn btn-primary" onclick="updateTeamTask()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Share Project Modal -->
    <div class="modal-overlay" id="shareProjectModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🔗 Condividi Progetto</div>
                <button class="modal-close" onclick="closeModal('shareProjectModal')">✕</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="shareProjectId">

                <!-- Project Info -->
                <div style="background:var(--bg-secondary); padding:12px; border-radius:var(--radius-md); margin-bottom:16px;">
                    <div style="font-weight:600;" id="shareProjectName">Nome Progetto</div>
                    <div style="font-size:0.85rem; color:var(--text-muted);">Proprietario: <span id="shareProjectOwner">Tu</span></div>
                </div>

                <!-- Add New Collaborator -->
                <div class="form-group">
                    <label class="form-label">🔍 Cerca e Aggiungi Collaboratore</label>

                    <!-- Search Input -->
                    <div style="position:relative;">
                        <input type="text"
                               class="form-input"
                               id="userSearchInput"
                               placeholder="Cerca per nome, email o competenza..."
                               autocomplete="off"
                               oninput="debounceUserSearch(this.value)"
                               style="padding-right:80px;">
                        <select id="userSearchType" class="form-select" style="position:absolute; right:4px; top:50%; transform:translateY(-50%); width:70px; padding:4px; font-size:0.75rem;">
                            <option value="all">Tutti</option>
                            <option value="name">Nome</option>
                            <option value="email">Email</option>
                            <option value="skills">Skills</option>
                        </select>
                    </div>

                    <!-- Search Results -->
                    <div id="userSearchResults" style="margin-top:8px; max-height:180px; overflow-y:auto; display:none;">
                        <!-- Risultati dinamici -->
                    </div>

                    <!-- Selected User -->
                    <div id="selectedUserCard" style="display:none; margin-top:8px; padding:10px; background:var(--bg-tertiary); border-radius:var(--radius-md); border:2px solid var(--accent);">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div id="selectedUserAvatar" style="width:36px; height:36px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; color:white; font-weight:600;"></div>
                                <div>
                                    <div id="selectedUserName" style="font-weight:600;"></div>
                                    <div id="selectedUserEmail" style="font-size:0.8rem; color:var(--text-muted);"></div>
                                </div>
                            </div>
                            <button class="btn btn-ghost btn-sm" onclick="clearSelectedUser()" title="Rimuovi">✕</button>
                        </div>
                    </div>

                    <!-- Permission & Add Button -->
                    <div style="display:flex; gap:8px; margin-top:10px;">
                        <select class="form-input form-select" id="sharePermission" style="flex:1;">
                            <option value="editor">✏️ Editor - può modificare</option>
                            <option value="viewer">👁️ Viewer - solo lettura</option>
                        </select>
                        <button class="btn btn-primary" onclick="addSelectedUserAsCollaborator()" id="addCollaboratorBtn" disabled>
                            ➕ Aggiungi
                        </button>
                    </div>

                    <input type="hidden" id="shareEmail">
                    <input type="hidden" id="selectedUserId">
                </div>

                <!-- Divider -->
                <div style="display:flex; align-items:center; gap:10px; margin:16px 0; color:var(--text-muted); font-size:0.8rem;">
                    <div style="flex:1; height:1px; background:var(--border);"></div>
                    <span>oppure seleziona dal team</span>
                    <div style="flex:1; height:1px; background:var(--border);"></div>
                </div>

                <!-- Team Members Quick Select -->
                <div class="form-group">
                    <label class="form-label">👥 Membri del Team</label>
                    <div id="teamMembersQuickSelect" style="display:flex; flex-wrap:wrap; gap:8px;">
                        <!-- Popolato da renderTeamMembersQuickSelect() -->
                    </div>
                </div>

                <!-- Current Collaborators List -->
                <div class="form-group" style="margin-top:16px;">
                    <label class="form-label">👥 Collaboratori</label>
                    <div id="projectCollaboratorsList" class="collaborators-list">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

                <!-- Sharing Status -->
                <div id="sharingStatus" style="margin-top:12px; padding:10px; border-radius:var(--radius-md); font-size:0.85rem; display:none;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('shareProjectModal')">Chiudi</button>
                <button class="btn btn-primary" onclick="saveProjectSharing()">💾 Salva Condivisione</button>
            </div>
        </div>
    </div>

    <!-- Archived Projects & Templates Modal -->
    <div class="modal-overlay" id="archivedProjectsModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📦 Archivio & Template</div>
                <button class="modal-close" onclick="closeModal('archivedProjectsModal')">✕</button>
            </div>
            <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
                <!-- Tabs -->
                <div style="display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:8px;">
                    <button class="btn btn-ghost" id="tabArchived" onclick="showArchiveTab('archived')" style="flex:1;">
                        📦 Archiviati
                    </button>
                    <button class="btn btn-ghost" id="tabTemplates" onclick="showArchiveTab('templates')" style="flex:1;">
                        📄 Template
                    </button>
                </div>

                <!-- Archived Projects Tab -->
                <div id="archivedTab" style="display:block;">
                    <div style="font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                        <span>Progetti Archiviati</span>
                        <span id="archivedCount" class="badge" style="background:var(--bg-tertiary); font-size:0.75rem;">0</span>
                    </div>
                    <div id="archivedProjectsList">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

                <!-- Templates Tab -->
                <div id="templatesTab" style="display:none;">
                    <div style="font-weight:600; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                        <span>Template Progetti</span>
                        <span id="templatesCount" class="badge" style="background:var(--bg-tertiary); font-size:0.75rem;">0</span>
                    </div>
                    <div id="projectTemplatesList">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('archivedProjectsModal')">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Ambient Sounds Modal -->
    <div class="modal-overlay" id="ambientSoundsModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🎵 Suoni Ambient</div>
                <button class="modal-close" onclick="closeModal('ambientSoundsModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="sound-grid">
                    <button class="sound-btn" onclick="toggleSound('rain')">
                        <span class="sound-icon">🌧️</span>
                        <span class="sound-label">Pioggia</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('forest')">
                        <span class="sound-icon">🌲</span>
                        <span class="sound-label">Foresta</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('cafe')">
                        <span class="sound-icon">☕</span>
                        <span class="sound-label">Caffè</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('ocean')">
                        <span class="sound-icon">🌊</span>
                        <span class="sound-label">Oceano</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('fire')">
                        <span class="sound-icon">🔥</span>
                        <span class="sound-label">Fuoco</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('wind')">
                        <span class="sound-icon">💨</span>
                        <span class="sound-label">Vento</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('whitenoise')">
                        <span class="sound-icon">📻</span>
                        <span class="sound-label">White Noise</span>
                    </button>
                    <button class="sound-btn" onclick="toggleSound('birds')">
                        <span class="sound-icon">🐦</span>
                        <span class="sound-label">Uccelli</span>
                    </button>
                </div>
                <div class="form-group mt-2">
                    <label class="form-label">Volume</label>
                    <input type="range" class="form-input volume-slider" id="soundVolume" min="0" max="100" value="50" onchange="setSoundVolume(this.value)">
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Capture Modal -->
    <div class="modal-overlay modal-center" id="quickCaptureModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title">⚡ Quick Capture</div>
                <button class="modal-close" onclick="closeModal('quickCaptureModal')">✕</button>
            </div>
            <div class="modal-body">
                <textarea id="quickCaptureText" class="form-input" rows="4" placeholder="Scrivi un'idea, task o nota..." autofocus></textarea>
                <div class="tag-suggestions mt-1">
                    <span class="tag-suggestion" onclick="quickCaptureAs('task')">✅ Task</span>
                    <span class="tag-suggestion" onclick="quickCaptureAs('note')">📝 Nota</span>
                    <span class="tag-suggestion" onclick="quickCaptureAs('idea')">💡 Idea</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('quickCaptureModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveQuickCapture()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Energy Check Modal -->
    <div class="modal-overlay modal-center" id="energyModal">
        <div class="modal" style="max-width:350px;">
            <div class="modal-header">
                <div class="modal-title">⚡ Livello Energia</div>
                <button class="modal-close" onclick="closeModal('energyModal')">✕</button>
            </div>
            <div class="modal-body" style="text-align:center;">
                <p class="text-muted mb-2">Come ti senti energeticamente?</p>
                <div class="energy-meter">
                    <div class="energy-level" onclick="setEnergy(1)" title="Molto basso">😴</div>
                    <div class="energy-level" onclick="setEnergy(2)" title="Basso">😔</div>
                    <div class="energy-level" onclick="setEnergy(3)" title="Medio">😐</div>
                    <div class="energy-level" onclick="setEnergy(4)" title="Alto">😊</div>
                    <div class="energy-level" onclick="setEnergy(5)" title="Molto alto">🔥</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cloud Login Modal - SOLO GOOGLE -->
    <div class="modal-overlay modal-center" id="cloudLoginModal">
        <div class="modal" style="max-width:380px;">
            <div class="modal-header">
                <div class="modal-title">☁️ Accedi con Google</div>
                <button class="modal-close" onclick="closeModal('cloudLoginModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="login-form-container" style="text-align:center;">
                    <div class="login-logo" style="font-size:3rem;margin-bottom:16px;">🎩</div>
                    <h3 style="margin-bottom:8px;">SAVERS Pro</h3>
                    <p class="text-muted mb-3">Un solo account Google per accesso, sincronizzazione e calendario</p>

                    <!-- Login con Google - UNICO METODO -->
                    <button class="google-login-btn google-login-btn-large" onclick="loginWithGoogle()" style="width:100%;justify-content:center;margin-bottom:16px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" style="margin-right:12px;">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Accedi con Google
                    </button>

                    <div style="display:flex;flex-direction:column;gap:8px;text-align:left;background:var(--bg-secondary);padding:12px;border-radius:10px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:1.2rem;">📅</span>
                            <span style="font-size:0.85rem;">Sincronizza con Google Calendar</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:1.2rem;">☁️</span>
                            <span style="font-size:0.85rem;">Backup automatico dei dati</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:1.2rem;">📱</span>
                            <span style="font-size:0.85rem;">Accesso da tutti i dispositivi</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span style="font-size:1.2rem;">🔒</span>
                            <span style="font-size:0.85rem;">Sicuro e protetto</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Flow Modal -->
    <div class="modal-overlay modal-center" id="dailyFlowModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title" id="dailyFlowTitle">🌅 Morning Flow</div>
                <button class="modal-close" onclick="closeModal('dailyFlowModal')">✕</button>
            </div>
            <div style="height:4px; background:var(--bg-secondary); margin:0 20px;">
                <div id="dailyFlowProgress" style="height:100%; background:var(--primary); width:0%; transition:width 0.3s ease; border-radius:2px;"></div>
            </div>
            <div class="modal-body" id="dailyFlowContent">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Mood Modal -->
    <div class="modal-overlay" id="moodModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">😊 Come Ti Senti?</div>
                <button class="modal-close" onclick="closeModal('moodModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; justify-content:space-around; font-size:2.5rem; margin-bottom:16px;">
                    <span class="mood-option" onclick="selectMood(1, this)" style="cursor:pointer; padding:8px;">😫</span>
                    <span class="mood-option" onclick="selectMood(2, this)" style="cursor:pointer; padding:8px;">😕</span>
                    <span class="mood-option" onclick="selectMood(3, this)" style="cursor:pointer; padding:8px;">😐</span>
                    <span class="mood-option" onclick="selectMood(4, this)" style="cursor:pointer; padding:8px;">🙂</span>
                    <span class="mood-option" onclick="selectMood(5, this)" style="cursor:pointer; padding:8px;">😄</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Note (opzionale)</label>
                    <textarea class="form-input" id="moodNote" placeholder="Cosa influenza il tuo umore?"></textarea>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveMood()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Sleep Modal -->
    <div class="modal-overlay" id="sleepModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">😴 Sonno</div>
                <button class="modal-close" onclick="closeModal('sleepModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Andato a letto</label>
                        <input type="time" class="form-input" id="sleepBedtime" value="23:00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sveglia</label>
                        <input type="time" class="form-input" id="sleepWakeup" value="07:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Qualità</label>
                    <div style="display:flex; justify-content:space-around; font-size:1.8rem;">
                        <span onclick="selectSleepQuality(1, this)" style="cursor:pointer; padding:8px;">😵</span>
                        <span onclick="selectSleepQuality(2, this)" style="cursor:pointer; padding:8px;">😴</span>
                        <span onclick="selectSleepQuality(3, this)" style="cursor:pointer; padding:8px;">😐</span>
                        <span onclick="selectSleepQuality(4, this)" style="cursor:pointer; padding:8px;">😊</span>
                        <span onclick="selectSleepQuality(5, this)" style="cursor:pointer; padding:8px;">🤩</span>
                    </div>
                </div>
                <button class="btn btn-primary btn-block" onclick="saveSleep()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Water Modal -->
    <div class="modal-overlay" id="waterModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">💧 Idratazione</div>
                <button class="modal-close" onclick="closeModal('waterModal')">✕</button>
            </div>
            <div class="modal-body text-center">
                <div style="font-size:4rem; margin-bottom:8px;" id="waterDisplayLarge">💧</div>
                <div style="font-size:2rem; font-weight:700; margin-bottom:4px;" id="waterCountDisplay">0/8</div>
                <div class="text-muted mb-2">Bicchieri d'acqua (250ml)</div>
                <div style="display:flex; justify-content:center; gap:16px;">
                    <button class="btn btn-lg btn-secondary" onclick="adjustWater(-1)">➖</button>
                    <button class="btn btn-lg btn-primary" onclick="adjustWater(1)">➕</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Block Modal -->
    <div class="modal-overlay" id="timeBlockModal">
        <div class="modal">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">🗓️ Nuovo Time Block</div>
                <button class="modal-close" onclick="closeModal('timeBlockModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Attività *</label>
                    <input type="text" class="form-input" id="blockTitle" placeholder="Cosa farai?">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Inizio</label>
                        <input type="time" class="form-input" id="blockStart" value="09:00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fine</label>
                        <input type="time" class="form-input" id="blockEnd" value="10:00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-input form-select" id="blockType">
                        <option value="deepwork">🧠 Deep Work</option>
                        <option value="meeting">🤝 Meeting</option>
                        <option value="admin">📋 Admin</option>
                        <option value="break">☕ Pausa</option>
                        <option value="personal">👤 Personale</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('timeBlockModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveTimeBlock()">💾 Salva</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div class="modal-overlay modal-center" id="searchModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <div class="modal-title">🔍 Cerca</div>
                <button class="modal-close" onclick="closeModal('searchModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-input" id="globalSearchInput" placeholder="Cerca task, note, eventi, skill..." oninput="performGlobalSearch(this.value)" autofocus>
                </div>
                <div class="search-filters mb-2">
                    <button class="chip active" onclick="setSearchFilter('all')" data-filter="all">Tutto</button>
                    <button class="chip" onclick="setSearchFilter('tasks')" data-filter="tasks">✅ Task</button>
                    <button class="chip" onclick="setSearchFilter('notes')" data-filter="notes">📝 Note</button>
                    <button class="chip" onclick="setSearchFilter('events')" data-filter="events">📅 Eventi</button>
                    <button class="chip" onclick="setSearchFilter('skills')" data-filter="skills">🎯 Skills</button>
                </div>
                <div id="searchResults" class="search-results-list">
                    <div class="text-muted text-center py-3">Digita per cercare...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inbox Modal -->
    <div class="modal-overlay" id="inboxModal">
        <div class="modal" style="max-width:500px;max-height:80vh;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">📬 Posta in Arrivo</div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-ghost btn-sm" onclick="refreshInbox()" id="inboxRefreshBtn" title="Aggiorna">🔄</button>
                    <button class="modal-close" onclick="closeModal('inboxModal')">✕</button>
                </div>
            </div>
            <div class="modal-body" style="padding:0;max-height:60vh;overflow-y:auto;">
                <!-- Tabs -->
                <div style="display:flex;border-bottom:1px solid var(--border);padding:0 16px;flex-wrap:wrap;">
                    <button class="btn btn-ghost btn-sm" id="inboxTabAll" onclick="filterInbox('all')" style="border-radius:0;border-bottom:2px solid var(--primary);">Tutti</button>
                    <button class="btn btn-ghost btn-sm" id="inboxTabInvites" onclick="filterInbox('invites')">📅 Inviti</button>
                    <button class="btn btn-ghost btn-sm" id="inboxTabTeam" onclick="filterInbox('team')">👥 Team</button>
                    <button class="btn btn-ghost btn-sm" id="inboxTabMentions" onclick="filterInbox('mentions')">💬 Menzioni</button>
                    <button class="btn btn-ghost btn-sm" id="inboxTabHistory" onclick="filterInbox('history')">📜 Storico</button>
                </div>
                <!-- Inbox Items -->
                <div id="inboxList" style="padding:16px;">
                    <div class="empty-state" style="padding:40px;">
                        <div style="font-size:3rem;margin-bottom:16px;">📭</div>
                        <div class="text-muted">Nessuna notifica</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Detail Modal (con commenti) -->
    <div class="modal-overlay" id="eventDetailModal">
        <div class="modal" style="max-width:500px;max-height:85vh;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title" id="eventDetailTitle">📅 Dettaglio Evento</div>
                <button class="modal-close" onclick="closeModal('eventDetailModal')">✕</button>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <div id="eventDetailContent"></div>

                <!-- Partecipanti -->
                <div id="eventAttendeesSection" style="margin-top:16px;">
                    <div style="font-weight:600;margin-bottom:8px;">👥 Partecipanti</div>
                    <div id="eventAttendeesList" class="attendee-list"></div>
                </div>

                <!-- Commenti -->
                <div class="event-comments">
                    <div style="font-weight:600;margin-bottom:12px;">💬 Commenti</div>
                    <div id="eventCommentsList"></div>
                    <div class="comment-input-wrapper" id="eventCommentInputWrapper">
                        <input type="text" class="comment-input" id="eventCommentInput" placeholder="Scrivi... @ per menzionare" oninput="checkEventMentionAutocomplete(this)" onkeydown="handleEventMentionKeydown(event)" onfocus="scrollInputIntoView(this)">
                        <button class="btn btn-primary btn-sm comment-send-btn" onclick="addEventComment()">Invia</button>
                        <!-- Dropdown autocomplete menzioni eventi -->
                        <div id="eventMentionAutocomplete" class="mention-autocomplete"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="eventDetailFooter">
                <button class="btn btn-secondary" onclick="closeModal('eventDetailModal')">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div class="modal-overlay modal-center" id="profileModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <div class="modal-title">👤 Il Mio Profilo</div>
                <button class="modal-close" onclick="closeModal('profileModal')">✕</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:20px;">
                    <div class="profile-avatar-large" id="profileAvatarLarge" onclick="changeProfileAvatar()">M</div>
                    <div class="text-muted" style="font-size:0.8rem; margin-top:8px;">Tocca per cambiare</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-input" id="profileName" placeholder="Il tuo nome">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="profileEmail" placeholder="La tua email">
                </div>
                <div class="form-group">
                    <label class="form-label">Professione</label>
                    <select class="form-input form-select" id="profileProfession">
                        <option value="">Seleziona...</option>
                        <option value="animator">🎭 Animatore</option>
                        <option value="magician">🎩 Mago</option>
                        <option value="clown">🤡 Clown</option>
                        <option value="juggler">🤹 Giocoliere</option>
                        <option value="balloon">🎈 Balloon Artist</option>
                        <option value="facepainter">🎨 Face Painter</option>
                        <option value="dj">🎧 DJ/Animatore Musicale</option>
                        <option value="actor">🎬 Attore</option>
                        <option value="other">✨ Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nome d'Arte (opzionale)</label>
                    <input type="text" class="form-input" id="profileStageName" placeholder="Es: Mago Max">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('profileModal')">Annulla</button>
                <button class="btn btn-primary" onclick="saveProfile()">💾 Salva Profilo</button>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div class="modal-overlay modal-center" id="createTeamModal">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <div class="modal-title">🏢 Crea Nuovo Team</div>
                <button class="modal-close" onclick="closeModal('createTeamModal')">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nome Team *</label>
                    <input type="text" class="form-input" id="newTeamName" placeholder="Es: Magic Show Crew">
                </div>
                <div class="form-group">
                    <label class="form-label">Descrizione</label>
                    <textarea class="form-input" id="newTeamDescription" rows="3" placeholder="Descrivi il tuo team..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Codice Invito (opzionale)</label>
                    <input type="text" class="form-input" id="newTeamInviteCode" placeholder="Lascia vuoto per generare automaticamente">
                    <small class="text-muted">Condividi questo codice per far unire i membri</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Visibilità</label>
                    <select class="form-input form-select" id="newTeamVisibility">
                        <option value="private">🔒 Privato - Solo su invito</option>
                        <option value="public">🌐 Pubblico - Chiunque può richiedere di unirsi</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createTeamModal')">Annulla</button>
                <button class="btn btn-primary" onclick="createTeam()">🏢 Crea Team</button>
            </div>
        </div>
    </div>

    <!-- Team Management Modal -->
    <div class="modal-overlay" id="teamManagementModal">
        <div class="modal" style="max-width:550px;">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">⚙️ Gestione Team</div>
                <button class="modal-close" onclick="closeModal('teamManagementModal')">✕</button>
            </div>
            <div class="modal-body" style="max-height:70vh; overflow-y:auto;">
                <!-- Team Selector -->
                <div class="form-group">
                    <label class="form-label">Seleziona Team</label>
                    <select class="form-input form-select" id="manageTeamSelect" onchange="loadTeamForManagement(this.value)">
                        <option value="">Scegli un team...</option>
                    </select>
                </div>

                <!-- Team Info (hidden until selected) -->
                <div id="teamManagementContent" style="display:none;">
                    <!-- Team Header -->
                    <div style="background:var(--bg-secondary); padding:12px; border-radius:var(--radius-md); margin-bottom:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:600; font-size:1.1rem;" id="manageTeamName">Nome Team</div>
                                <div style="font-size:0.85rem; color:var(--text-muted);" id="manageTeamCode">Codice: XXXXXX</div>
                            </div>
                            <span id="manageTeamRole" class="permission-badge owner">Owner</span>
                        </div>
                    </div>

                    <!-- Add Member Section (only for owners) -->
                    <div id="addMemberSection" class="form-group">
                        <label class="form-label">🔍 Aggiungi Nuovo Membro</label>
                        <div style="position:relative;">
                            <input type="text"
                                   class="form-input"
                                   id="teamMemberSearchInput"
                                   placeholder="Cerca per nome, email o competenza..."
                                   autocomplete="off"
                                   oninput="debounceTeamMemberSearch(this.value)">
                        </div>
                        <!-- Search Results -->
                        <div id="teamMemberSearchResults" style="margin-top:8px; max-height:150px; overflow-y:auto; display:none;">
                        </div>
                    </div>

                    <!-- Current Members List -->
                    <div class="form-group">
                        <label class="form-label">👥 Membri Attuali (<span id="manageMemberCount">0</span>)</label>
                        <div id="teamMembersList" class="collaborators-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Pending Requests (only for owners) -->
                    <div id="pendingRequestsSection" style="display:none;">
                        <label class="form-label">⏳ Richieste in Attesa</label>
                        <div id="teamPendingRequests" class="collaborators-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Danger Zone (only for owners) -->
                    <div id="teamDangerZone" style="margin-top:20px; padding:12px; background:rgba(239,68,68,0.1); border-radius:var(--radius-md); display:none;">
                        <div style="font-weight:600; color:var(--danger); margin-bottom:8px;">⚠️ Zona Pericolosa</div>
                        <button class="btn btn-ghost" style="color:var(--danger); border-color:var(--danger);" onclick="confirmDeleteTeam()">
                            🗑️ Elimina Team
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('teamManagementModal')">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Join Team Modal -->
    <div class="modal-overlay modal-center" id="joinTeamModal">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <div class="modal-title">🔍 Unisciti a un Team</div>
                <button class="modal-close" onclick="closeModal('joinTeamModal')">✕</button>
            </div>
            <div class="modal-body">
                <!-- Tab per codice invito o cerca -->
                <div style="display:flex; gap:8px; margin-bottom:16px;">
                    <button class="btn btn-sm" id="joinByCodeTab" onclick="switchJoinTab('code')" style="flex:1;">🔑 Codice Invito</button>
                    <button class="btn btn-secondary btn-sm" id="joinBySearchTab" onclick="switchJoinTab('search')" style="flex:1;">🔍 Cerca Team</button>
                </div>

                <!-- Join by Code -->
                <div id="joinByCodeSection">
                    <div class="form-group">
                        <label class="form-label">Codice Invito</label>
                        <input type="text" class="form-input" id="teamInviteCodeInput" placeholder="Inserisci il codice invito">
                    </div>
                    <button class="btn btn-primary" onclick="joinTeamByCode()" style="width:100%;">
                        🚀 Unisciti al Team
                    </button>
                </div>

                <!-- Search Public Teams -->
                <div id="joinBySearchSection" style="display:none;">
                    <div class="form-group">
                        <input type="text" class="form-input" id="searchTeamInput" placeholder="🔍 Cerca team pubblici..." oninput="searchPublicTeams()">
                    </div>
                    <div id="publicTeamsList" style="max-height:300px; overflow-y:auto;">
                        <div class="text-muted text-center" style="padding:20px;">
                            Cerca team pubblici per nome
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Detail Modal -->
    <div class="modal-overlay modal-center" id="teamDetailModal">
        <div class="modal" style="max-width:500px; max-height:90vh;">
            <div class="modal-header">
                <div class="modal-title" id="teamDetailTitle">🏢 Dettaglio Team</div>
                <button class="modal-close" onclick="closeModal('teamDetailModal')">✕</button>
            </div>
            <div class="modal-body" id="teamDetailContent" style="max-height:60vh; overflow-y:auto;">
                <!-- Popolato dinamicamente -->
            </div>
            <div class="modal-footer" id="teamDetailFooter">
                <button class="btn btn-secondary" onclick="closeModal('teamDetailModal')">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Choose Nickname Modal (per nuovi utenti Google) -->
    <div class="modal-overlay modal-center" id="chooseNicknameModal" style="z-index:10001;">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary), #4f46e5);">
                <div class="modal-title" style="color:white;">🎭 Benvenuto in SAVERS!</div>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="font-size:4rem; margin-bottom:12px;">🎩</div>
                    <h3 style="margin:0 0 8px;">Scegli il tuo Nickname</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem;">
                        Questo nome verrà usato per menzionarti nei team e visualizzato nell'app
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">Email Google</label>
                    <input type="text" class="form-input" id="newUserGoogleEmail" readonly style="opacity:0.7;">
                </div>

                <div class="form-group">
                    <label class="form-label">Il tuo Nickname *</label>
                    <input type="text" class="form-input" id="newUserNickname" placeholder="es. MagoMax, Giocoliere, ArtistaDiFuoco..."
                           maxlength="30" oninput="validateNickname(this)">
                    <small style="color:var(--text-muted);">Min 3 caratteri, solo lettere, numeri e underscore</small>
                    <div id="nicknameError" style="color:#dc2626; font-size:0.8rem; margin-top:4px; display:none;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nome Completo (opzionale)</label>
                    <input type="text" class="form-input" id="newUserFullName" placeholder="es. Marco Rossi">
                </div>

                <div style="background:var(--bg-secondary); padding:12px; border-radius:8px; margin-top:16px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="acceptTermsCheckbox" style="width:18px; height:18px;">
                        <span style="font-size:0.85rem;">Accetto i termini di utilizzo e la privacy policy</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cancelGoogleRegistration()">Annulla</button>
                <button class="btn btn-primary" onclick="completeGoogleRegistration()" id="completeRegistrationBtn" disabled>
                    🚀 Inizia!
                </button>
            </div>
        </div>
    </div>

    <!-- Super Admin Modal -->
    <div class="modal-overlay modal-center" id="superAdminModal">
        <div class="modal" style="max-width:600px; max-height:90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #991b1b);">
                <div class="modal-title" style="color:white;">🛡️ Super Admin Panel</div>
                <button class="modal-close" onclick="closeModal('superAdminModal')" style="color:white;">✕</button>
            </div>
            <div class="modal-body" style="padding:0;">
                <!-- Admin Auth Screen -->
                <div id="adminAuthScreen" style="padding:20px;">
                    <div style="text-align:center; margin-bottom:20px;">
                        <div style="font-size:3rem;">🔐</div>
                        <h3 style="margin:10px 0;">Accesso Riservato</h3>
                        <p class="text-muted">Inserisci la password di amministrazione</p>
                    </div>
                    <div class="form-group">
                        <input type="password" class="form-input" id="adminPasswordInput" placeholder="Password Admin" onkeypress="if(event.key==='Enter')verifyAdminPassword()">
                    </div>
                    <button class="btn btn-primary" onclick="verifyAdminPassword()" style="width:100%; background:#dc2626;">
                        🔓 Accedi
                    </button>
                </div>

                <!-- Admin Dashboard (hidden until authenticated) -->
                <div id="adminDashboard" style="display:none;">
                    <!-- Stats Bar -->
                    <div style="background:var(--bg-secondary); padding:12px 16px; display:flex; gap:20px; border-bottom:1px solid var(--border-color);">
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold;" id="adminTotalUsers">0</div>
                            <div class="text-muted" style="font-size:0.75rem;">Utenti Totali</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#22c55e;" id="adminActiveUsers">0</div>
                            <div class="text-muted" style="font-size:0.75rem;">Attivi</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#dc2626;" id="adminBannedUsers">0</div>
                            <div class="text-muted" style="font-size:0.75rem;">Bannati</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="refreshAdminUserList()" style="margin-left:auto;">
                            🔄 Aggiorna
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div style="padding:12px 16px; border-bottom:1px solid var(--border-color);">
                        <input type="text" class="form-input" id="adminUserSearch" placeholder="🔍 Cerca utente per username o email..." oninput="filterAdminUsers()">
                    </div>

                    <!-- Users List -->
                    <div id="adminUsersList" style="max-height:400px; overflow-y:auto; padding:8px;">
                        <div style="text-align:center; padding:40px; color:var(--text-muted);">
                            Caricamento utenti...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin User Detail Modal -->
    <div class="modal-overlay modal-center" id="adminUserDetailModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #991b1b);">
                <div class="modal-title" style="color:white;">👤 Gestione Utente</div>
                <button class="modal-close" onclick="closeModal('adminUserDetailModal')" style="color:white;">✕</button>
            </div>
            <div class="modal-body" id="adminUserDetailContent">
                <!-- Populated dynamically -->
            </div>
            <div class="modal-footer" style="flex-wrap:wrap; gap:8px;">
                <button class="btn btn-secondary" onclick="closeModal('adminUserDetailModal')">Chiudi</button>
                <button class="btn" id="adminToggleBanBtn" onclick="adminToggleUserBan()" style="background:#f59e0b;">
                    🚫 Banna Utente
                </button>
                <button class="btn" onclick="adminResetUserPassword()" style="background:#3b82f6;">
                    🔑 Reset Password
                </button>
                <button class="btn" onclick="adminDeleteUser()" style="background:#dc2626;">
                    🗑️ Elimina Utente
                </button>
            </div>
        </div>
    </div>


    <!-- ============================================
         JAVASCRIPT - CORE
         ============================================ -->
    <script>
// ============================================
// Mago Max S.A.V.E.R.S. v4.0 - MAIN JAVASCRIPT
// Complete Productivity & Finance Suite
// ============================================

// ============================================
// GOOGLE SHEETS API CONFIGURATION
// ============================================

const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbz3JyBguSpTm6luxsOSk8agDSRJ6xAOLA38f3ShoZTpoAQlQDGsLyGP7e-YW4Z6TJQ3Kw/exec',
    SYNC_INTERVAL: 300000, // 5 minuti
    NOTIFICATION_HOUR: 6,
    NOTIFICATION_MINUTE: 0,
    // Google OAuth & API Config
    GOOGLE_CLIENT_ID: '738454882111-994dgh20i92cc55gieo7jcmqsu23hilf.apps.googleusercontent.com',
    GOOGLE_API_KEY: '', // Optional for public calendars
    GOOGLE_SCOPES: 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/tasks https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
    GOOGLE_DISCOVERY_DOCS: [
        'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
        'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'
    ]
};

// Super Admin Configuration
const SUPER_ADMIN_PASSWORD = 'MagoMax2024!';
const SUPER_ADMIN_EMAILS = ['ilmagicartista@gmail.com'];

// Stato autenticazione Cloud (Google Sheets)
let currentUser = null;
let isLoggedIn = false;
let syncInProgress = false;
let lastSyncTime = null;
let initialLoadComplete = false; // Flag per evitare sync prima del caricamento

// Contatore chiamate API (per monitoraggio quota)
let apiCallStats = {
    today: new Date().toISOString().split('T')[0],
    totalCalls: 0,
    callsByAction: {},
    lastReset: Date.now()
};

// Stato Google Calendar/Tasks
let googleAuthInstance = null;
let isGoogleSignedIn = false;
let selectedCalendarId = 'primary';
let userCalendars = [];
let googleTaskLists = [];

// ============================================
// CONFIGURATION & CONSTANTS
// ============================================

const ROUTINE_ACTIVITIES = [
    { id: 'silence', name: 'Silence', icon: '🧘', desc: 'Meditazione', duration: 10, xp: 15 },
    { id: 'affirmations', name: 'Affirmations', icon: '💬', desc: 'Affermazioni', duration: 5, xp: 10 },
    { id: 'visualization', name: 'Visualization', icon: '🎯', desc: 'Visualizzazione', duration: 5, xp: 10 },
    { id: 'exercise', name: 'Exercise', icon: '💪', desc: 'Esercizio', duration: 20, xp: 20 },
    { id: 'reading', name: 'Reading', icon: '📚', desc: 'Lettura', duration: 20, xp: 15 },
    { id: 'scribing', name: 'Scribing', icon: '✍️', desc: 'Scrittura', duration: 10, xp: 15 }
];

const EXPENSE_CATEGORIES = {
    food: { icon: '🍕', name: 'Cibo', color: '#f59e0b' },
    transport: { icon: '🚗', name: 'Trasporti', color: '#3b82f6' },
    shopping: { icon: '🛒', name: 'Shopping', color: '#ec4899' },
    bills: { icon: '📄', name: 'Bollette', color: '#ef4444' },
    entertainment: { icon: '🎮', name: 'Intrattenimento', color: '#8b5cf6' },
    health: { icon: '💊', name: 'Salute', color: '#10b981' },
    education: { icon: '📚', name: 'Formazione', color: '#6366f1' },
    home: { icon: '🏠', name: 'Casa', color: '#f97316' },
    other: { icon: '📦', name: 'Altro', color: '#64748b' }
};

const INCOME_CATEGORIES = {
    salary: { icon: '💼', name: 'Stipendio' },
    freelance: { icon: '💻', name: 'Freelance' },
    investment: { icon: '📈', name: 'Investimenti' },
    gift: { icon: '🎁', name: 'Regalo' },
    refund: { icon: '↩️', name: 'Rimborso' },
    other: { icon: '📦', name: 'Altro' }
};

const BADGES = [
    { id: 'first_day', name: 'Primo Giorno', icon: '🌅', desc: 'Prima sessione', condition: s => s.totalDays >= 1 },
    { id: 'week_streak', name: 'Settimana', icon: '🔥', desc: '7 giorni streak', condition: s => s.streak >= 7 },
    { id: 'month_streak', name: 'Mese Perfetto', icon: '💎', desc: '30 giorni streak', condition: s => s.streak >= 30 },
    { id: 'task_master', name: 'Task Master', icon: '✅', desc: '100 task', condition: s => s.tasksCompleted >= 100 },
    { id: 'pomodoro_pro', name: 'Pomodoro Pro', icon: '🍅', desc: '50 pomodori', condition: s => s.pomodorosTotal >= 50 },
    { id: 'saver', name: 'Risparmiatore', icon: '💰', desc: '€1000 risparmiati', condition: s => s.totalSaved >= 1000 },
    { id: 'tracker', name: 'Tracker', icon: '📊', desc: '100 transazioni', condition: s => s.transactionsCount >= 100 },
    { id: 'goal_getter', name: 'Goal Getter', icon: '🎯', desc: '10 obiettivi', condition: s => s.goalsCompleted >= 10 },
    { id: 'note_taker', name: 'Note Taker', icon: '📝', desc: '50 note', condition: s => s.notesCreated >= 50 },
    { id: 'level_10', name: 'Livello 10', icon: '⭐', desc: 'Raggiungi Lv.10', condition: s => s.level >= 10 },
    { id: 'hydrated', name: 'Idratato', icon: '💧', desc: '7gg 8 bicchieri', condition: s => s.hydrationStreak >= 7 },
    { id: 'scanner', name: 'Scanner Pro', icon: '📷', desc: '20 scontrini', condition: s => s.receiptsScanned >= 20 }
];

const MOTIVATIONAL_QUOTES = [
    "Ogni giorno è una nuova opportunità per crescere 🌱",
    "Il successo è la somma di piccoli sforzi ripetuti 💪",
    "Oggi è il giorno perfetto per iniziare 🚀",
    "La disciplina è il ponte tra gli obiettivi e i risultati 🎯",
    "Piccoli progressi ogni giorno portano a grandi risultati ⭐",
    "Il tuo futuro dipende da quello che fai oggi 📈"
];

// ============================================
// STATE MANAGEMENT
// ============================================

// Esponi state globalmente per garantire persistenza
window.state = window.state || {};

let state = window.state = {
    user: { name: '' },
    currentDepartment: 'all', // 'all' | 'personal' | 'work'
    settings: {
        currency: '€',
        monthlyBudget: 2000,
        dailyBudget: 0,
        autoDailyBudget: true,
        pomodoroDuration: 25,
        breakDuration: 5,
        notifications: false,
        notificationSound: true,
        darkMode: false
    },
    stats: {
        totalXP: 0,
        level: 1,
        streak: 0,
        totalDays: 0,
        tasksCompleted: 0,
        pomodorosTotal: 0,
        totalSaved: 0,
        transactionsCount: 0,
        goalsCompleted: 0,
        notesCreated: 0,
        hydrationStreak: 0,
        receiptsScanned: 0,
        unlockedBadges: []
    },
    today: {
        date: new Date().toISOString().split('T')[0],
        routineCompleted: [false, false, false, false, false, false],
        mood: null,
        moodNote: '',
        sleep: null,
        sleepQuality: null,
        water: 0,
        pomodoros: 0
    },
    tasks: [],
    transactions: [],
    moneyGoals: [],
    goals: [],
    notes: [],
    habits: [],
    timeBlocks: [],
    timeLogs: [],
    // Nuove strutture per Skills e Team
    skills: [],
    teamMembers: [],  // DEPRECATO: ora i membri vengono da state.teams
    teamProjects: [],
    sharedProjects: [],  // Progetti condivisi con me da altri utenti
    archivedProjects: [],  // Progetti completati/archiviati
    projectTemplates: [],  // Template di progetti riutilizzabili
    events: [],
    // Sistema Team con iscrizioni
    teams: [],  // {id, name, description, ownerId, ownerEmail, members: [{email, name, role, joinedAt}], createdAt}
    teamJoinRequests: [],  // {id, teamId, teamName, userEmail, userName, message, status: 'pending'|'approved'|'rejected', requestedAt, respondedAt}
    myTeamMemberships: [],  // {teamId, teamName, role, joinedAt} - team a cui appartengo
    // Profilo utente
    profile: {
        name: '',
        email: '',
        profession: '',
        stageName: '',
        avatar: null
    }
};

// Carica backup profilo dal localStorage se presente
try {
    const backupProfile = JSON.parse(localStorage.getItem('savers_profile_backup') || '{}');
    if (backupProfile.profession || backupProfile.stageName) {
        state.profile = { ...state.profile, ...backupProfile };
        console.log('📂 Profilo caricato da backup localStorage:', backupProfile);
    }
} catch (e) {
    console.warn('Impossibile caricare backup profilo:', e);
}

// Timer states
let pomodoroInterval = null;
let pomodoroTime = 25 * 60;
let pomodoroRunning = false;
let pomodoroSessions = 0;
let pomodoroOnBreak = false;

let timeTrackerInterval = null;
let timeTrackerSeconds = 0;
let timeTrackerRunning = false;
let currentProject = null;

// Temp state
let selectedMood = null;
let selectedSleepQuality = null;
let selectedMoneyGoalIcon = '🏦';
let selectedHabitIcon = '🧘';

// Calendar state (deve essere definito qui per evitare temporal dead zone)
let calendarView = 'day';
let calendarDate = new Date();
let calendarCompactView = true; // Vista compatta del calendario (mostra solo ore con eventi)
let currentTaskFilter = 'all'; // Filtro task attivo: 'all', 'today', 'week', 'done'
let currentBookFilter = 'all'; // Filtro libri consigliati: 'all', 'motivation', 'productivity', etc.
let scannedData = null; // Dati temporanei dallo scanner scontrini

// Finance chart instance
let weeklyTrendChartInstance = null;

// Event editing state
let editingGoogleEventId = null;
let currentEventId = null;
let isCurrentEventGoogle = false;
let currentEventCommentId = null; // ID universale per commenti evento (iCalUID per eventi condivisi)
let currentInboxFilter = 'all';

// Task editing state
let editingTaskId = null;

// Event attendees (per form nuovo evento)
let eventAttendees = [];

// Mention autocomplete state
let mentionMatches = [];
let mentionSelectedIndex = 0;

// Team/Project state
let currentProjectId = null;
let newTeamTaskStatus = 'todo';
let currentEditingTeamTaskId = null;

// Team Management state
let currentManagingTeamId = null;
let teamMemberSearchTimeout = null;

// User Search state (for project sharing)
let userSearchTimeout = null;
let selectedUserData = null;

// Super Admin state
let isAdminAuthenticated = false;
let adminUsersList = [];
let selectedAdminUser = null;
let secretTapCount = 0;
let secretTapTimer = null;
let adminRevealCount = 0;
let adminRevealTimer = null;

// Team management state
let currentTeamId = null;
let joinTeamTab = 'code';

// Touch drag and drop state (deve essere definito prima delle funzioni)
let touchDragData = {
    taskId: null,
    element: null,
    clone: null,
    startX: 0,
    startY: 0,
    offsetX: 0,
    offsetY: 0,
    isDragging: false,
    dropTarget: null,
    isTeamTask: false,
    longPressTimer: null
};

// Mention autocomplete state (deve essere definito prima delle funzioni)
let mentionSearchStart = -1;
let selectedMentionIndex = 0;

// Comments polling state (deve essere definito prima delle funzioni)
let commentsPollingInterval = null;

// ============================================
// PERFORMANCE: CACHE & OPTIMISTIC UI SYSTEM
// ============================================

// Cache per dati frequentemente usati
const dataCache = {
    comments: new Map(),      // taskId -> {data, timestamp}
    projects: new Map(),      // projectId -> {data, timestamp}
    notifications: null,      // {data, timestamp}
    cacheDuration: 30000      // 30 secondi di cache
};

// Coda operazioni in background (per sync asincrono)
const backgroundQueue = {
    pending: [],
    processing: false
};

// ============================================
// INCREMENTAL SYNC SYSTEM (Scalabilità)
// ============================================

// Tiene traccia delle modifiche per sync incrementale
const changeTracker = {
    // Collezioni modificate
    dirtyCollections: new Set(), // 'tasks', 'teamProjects', 'habits', 'transactions', 'moneyGoals', etc.

    // Singoli elementi modificati (per sync granulare)
    modifiedItems: {
        tasks: new Set(),        // Set di task IDs modificati
        teamProjects: new Set(), // Set di project IDs modificati
        habits: new Set(),       // Set di habit IDs modificati
        transactions: new Set(), // Set di transaction IDs modificati
        moneyGoals: new Set(),   // Set di money goal IDs modificati
        notes: new Set(),        // Set di note IDs modificati
        events: new Set(),       // Set di event IDs modificati
        goals: new Set()         // Set di goal IDs modificati
    },

    // Elementi eliminati (devono essere sincronizzati separatamente)
    deletedItems: {
        tasks: [],          // Array di {id, deletedAt}
        teamProjects: [],
        habits: [],
        transactions: [],
        moneyGoals: [],
        notes: [],
        events: [],
        goals: []
    },

    // Timestamp ultima sync completa
    lastFullSync: 0,

    // Intervallo per forzare full sync (24 ore)
    fullSyncInterval: 24 * 60 * 60 * 1000,

    // Contatore modifiche dall'ultima sync
    changeCount: 0,

    // Soglia per forzare sync immediata
    immediatesSyncThreshold: 50
};

// ============================================
// OFFLINE QUEUE SYSTEM
// ============================================

const offlineQueue = {
    operations: JSON.parse(localStorage.getItem('savers_offline_queue') || '[]'),
    isOnline: navigator.onLine,

    // Aggiungi operazione alla coda
    add(operation) {
        this.operations.push({
            ...operation,
            id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            timestamp: Date.now(),
            retries: 0
        });
        this.save();
        console.log('📦 Operazione aggiunta alla coda offline:', operation.type);
    },

    // Salva coda su localStorage
    save() {
        localStorage.setItem('savers_offline_queue', JSON.stringify(this.operations));
    },

    // Processa coda quando torna online
    async processQueue() {
        if (!this.isOnline || this.operations.length === 0) return;

        console.log(`🔄 Processamento ${this.operations.length} operazioni offline...`);
        const toProcess = [...this.operations];
        this.operations = [];
        this.save();

        for (const op of toProcess) {
            try {
                await this.executeOperation(op);
                console.log('✅ Operazione offline completata:', op.type);
            } catch (error) {
                console.error('❌ Errore operazione offline:', error);
                if (op.retries < 3) {
                    op.retries++;
                    this.operations.push(op);
                }
            }
        }
        this.save();

        if (this.operations.length === 0) {
            showToast('✅ Dati sincronizzati!', 'success');
        }
    },

    // Esegui singola operazione
    async executeOperation(op) {
        switch (op.type) {
            case 'sync':
                await syncToCloud();
                break;
            case 'addTask':
                // Re-add task if needed
                break;
            case 'deleteTask':
                // Re-delete if needed
                break;
            default:
                console.warn('Operazione sconosciuta:', op.type);
        }
    }
};

// Listener online/offline
window.addEventListener('online', () => {
    offlineQueue.isOnline = true;
    showToast('🌐 Connessione ripristinata', 'success');
    offlineQueue.processQueue();
});

window.addEventListener('offline', () => {
    offlineQueue.isOnline = false;
    showToast('📴 Modalità offline', 'warning');
});

// ============================================
// UNDO SYSTEM
// ============================================

const undoSystem = {
    stack: [],
    maxSize: 20,
    toastElement: null,
    toastTimeout: null,

    // Registra azione annullabile
    register(action) {
        this.stack.push({
            ...action,
            timestamp: Date.now()
        });
        if (this.stack.length > this.maxSize) {
            this.stack.shift();
        }
        this.showUndoToast(action.message || 'Azione completata');
    },

    // Mostra toast con bottone undo
    showUndoToast(message) {
        // Rimuovi toast precedente
        if (this.toastElement) {
            this.toastElement.remove();
        }
        if (this.toastTimeout) {
            clearTimeout(this.toastTimeout);
        }

        const toast = document.createElement('div');
        toast.className = 'toast undo-toast';
        toast.innerHTML = `
            <span>${message}</span>
            <button class="undo-btn" onclick="undoSystem.undo()">↩️ Annulla</button>
        `;
        toast.style.cssText = `
            position: fixed;
            bottom: calc(80px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 99999;
            animation: slideUp 0.3s ease;
        `;

        document.body.appendChild(toast);
        this.toastElement = toast;

        this.toastTimeout = setTimeout(() => {
            toast.style.animation = 'slideDown 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
            this.toastElement = null;
        }, 5000);
    },

    // Esegui undo
    async undo() {
        if (this.stack.length === 0) return;

        const action = this.stack.pop();

        try {
            switch (action.type) {
                case 'deleteTask':
                    state.tasks.push(action.data);
                    saveStateAndSync();
                    renderTasks();
                    showToast('✅ Task ripristinato', 'success');
                    break;

                case 'deleteEvent':
                    state.events.push(action.data);
                    saveStateAndSync();
                    renderCalendarViews();
                    showToast('✅ Evento ripristinato', 'success');
                    break;

                case 'deleteTransaction':
                    state.transactions.push(action.data);
                    saveStateAndSync();
                    renderFinanceDashboard();
                    showToast('✅ Transazione ripristinata', 'success');
                    break;

                case 'deleteNote':
                    state.notes.push(action.data);
                    saveStateAndSync();
                    renderNotes();
                    showToast('✅ Nota ripristinata', 'success');
                    break;

                case 'deleteHabit':
                    state.habits.push(action.data);
                    saveStateAndSync();
                    renderHabits();
                    showToast('✅ Abitudine ripristinata', 'success');
                    break;

                default:
                    if (action.undoFn) {
                        await action.undoFn();
                    }
            }
        } catch (error) {
            console.error('Errore undo:', error);
            showToast('Errore durante l\'annullamento', 'error');
        }

        // Rimuovi toast
        if (this.toastElement) {
            this.toastElement.remove();
            this.toastElement = null;
        }
    }
};

// ============================================
// PULL TO REFRESH
// ============================================

const pullToRefresh = {
    startY: 0,
    currentY: 0,
    startTime: 0,
    pulling: false,
    activated: false,
    threshold: 120,  // Soglia più alta per attivazione
    minPullDistance: 80,  // Distanza minima prima di mostrare indicatore
    indicator: null,

    init() {
        // Crea indicatore
        this.indicator = document.createElement('div');
        this.indicator.className = 'pull-refresh-indicator';
        this.indicator.innerHTML = '<div class="pull-refresh-spinner">🔄</div><span>Rilascia per aggiornare</span>';
        this.indicator.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 0;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            overflow: hidden;
            transition: height 0.15s ease;
            z-index: 9998;
            font-size: 14px;
            color: var(--text-secondary);
        `;
        document.body.prepend(this.indicator);

        // Touch events solo sul body/document principale
        document.addEventListener('touchstart', (e) => this.onTouchStart(e), { passive: true });
        document.addEventListener('touchmove', (e) => this.onTouchMove(e), { passive: false });
        document.addEventListener('touchend', (e) => this.onTouchEnd(e), { passive: true });
    },

    // Verifica RIGOROSA se siamo al top assoluto della pagina
    isAtAbsoluteTop() {
        // Window deve essere a 0
        if (window.scrollY > 0 || window.pageYOffset > 0) return false;
        if (document.documentElement.scrollTop > 0) return false;
        if (document.body.scrollTop > 0) return false;

        return true;
    },

    // Verifica se il touch è su un elemento scrollabile
    isOnScrollableElement(target) {
        let el = target;
        while (el && el !== document.body && el !== document.documentElement) {
            // Ignora se è dentro un modal aperto
            if (el.classList && el.classList.contains('modal-overlay') && el.classList.contains('active')) {
                return true;
            }

            const style = window.getComputedStyle(el);
            const overflowY = style.overflowY;
            const isScrollable = (overflowY === 'auto' || overflowY === 'scroll');

            // Se l'elemento è scrollabile e ha contenuto che può scrollare
            if (isScrollable && el.scrollHeight > el.clientHeight + 5) {
                return true;
            }
            el = el.parentElement;
        }
        return false;
    },

    onTouchStart(e) {
        // Reset completo
        this.pulling = false;
        this.activated = false;
        this.startY = 0;
        this.currentY = 0;

        // Non attivare se c'è un modal aperto
        const activeModal = document.querySelector('.modal-overlay.active');
        if (activeModal) return;

        // Non attivare se non siamo al top assoluto
        if (!this.isAtAbsoluteTop()) return;

        // Non attivare se siamo su un elemento scrollabile
        if (this.isOnScrollableElement(e.target)) return;

        // Il touch deve partire nella parte alta dello schermo (primi 150px)
        const touchY = e.touches[0].clientY;
        if (touchY > 150) return;

        this.startY = touchY;
        this.startTime = Date.now();
        this.pulling = true;
    },

    onTouchMove(e) {
        if (!this.pulling) return;

        // Se nel frattempo la pagina ha scrollato, annulla
        if (!this.isAtAbsoluteTop()) {
            this.reset();
            return;
        }

        this.currentY = e.touches[0].clientY;
        const diff = this.currentY - this.startY;

        // Solo movimento verso il basso e oltre la soglia minima
        if (diff > this.minPullDistance) {
            e.preventDefault();

            const pullProgress = Math.min((diff - this.minPullDistance) * 0.3, this.threshold - this.minPullDistance);
            const height = Math.min(pullProgress + 20, 60);

            this.indicator.style.height = height + 'px';

            if (diff > this.threshold) {
                this.activated = true;
                this.indicator.querySelector('span').textContent = 'Rilascia per aggiornare';
                this.indicator.querySelector('.pull-refresh-spinner').style.animation = 'spin 1s linear infinite';
            } else {
                this.activated = false;
                this.indicator.querySelector('span').textContent = 'Trascina per aggiornare';
                this.indicator.querySelector('.pull-refresh-spinner').style.animation = 'none';
            }
        } else if (diff < -10) {
            // Movimento verso l'alto, annulla
            this.reset();
        }
    },

    async onTouchEnd(e) {
        if (!this.pulling) return;

        if (this.activated) {
            this.indicator.querySelector('span').textContent = 'Aggiornamento...';
            await this.doRefresh();
        }

        this.reset();
    },

    reset() {
        this.indicator.style.height = '0';
        this.pulling = false;
        this.activated = false;
        this.startY = 0;
        this.currentY = 0;
    },

    async doRefresh() {
        try {
            if (isGoogleSignedIn) {
                await loadCalendarEvents();
                await loadFromCloud();
            }

            if (typeof renderHomePage === 'function') {
                renderHomePage();
            }
            if (typeof renderCurrentPage === 'function') {
                renderCurrentPage();
            }
            showToast('✅ Dati aggiornati', 'success');
        } catch (error) {
            console.error('Errore refresh:', error);
            showToast('Errore durante l\'aggiornamento', 'error');
        }
    }
};

// ============================================
// LOADING STATES & SKELETONS
// ============================================

const loadingUI = {
    // Mostra skeleton loader
    showSkeleton(containerId, count = 3) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = Array(count).fill(0).map(() => `
            <div class="skeleton-item" style="
                background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card) 50%, var(--bg-secondary) 75%);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
                border-radius: 12px;
                height: 60px;
                margin-bottom: 8px;
            "></div>
        `).join('');
    },

    // Mostra spinner inline
    showSpinner(element) {
        if (!element) return;
        element.dataset.originalContent = element.innerHTML;
        element.innerHTML = '<span class="spinner-inline"></span>';
        element.disabled = true;
    },

    // Rimuovi spinner
    hideSpinner(element) {
        if (!element || !element.dataset.originalContent) return;
        element.innerHTML = element.dataset.originalContent;
        element.disabled = false;
        delete element.dataset.originalContent;
    },

    // Overlay loading globale
    showGlobalLoading(message = 'Caricamento...') {
        let overlay = document.getElementById('globalLoadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'globalLoadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 16px;
                z-index: 99999;
            `;
            document.body.appendChild(overlay);
        }
        overlay.innerHTML = `
            <div class="loading-spinner-large"></div>
            <div style="color: white; font-size: 16px;">${message}</div>
        `;
        overlay.style.display = 'flex';
    },

    hideGlobalLoading() {
        const overlay = document.getElementById('globalLoadingOverlay');
        if (overlay) overlay.style.display = 'none';
    }
};

// ============================================
// ERROR HANDLER GLOBALE
// ============================================

const errorHandler = {
    // Messaggi user-friendly
    messages: {
        'network': 'Problema di connessione. Controlla la tua rete.',
        'auth': 'Sessione scaduta. Effettua nuovamente l\'accesso.',
        'quota': 'Troppe richieste. Riprova tra qualche minuto.',
        'notfound': 'Elemento non trovato.',
        'permission': 'Non hai i permessi per questa azione.',
        'server': 'Errore del server. Riprova più tardi.',
        'unknown': 'Si è verificato un errore. Riprova.'
    },

    // Classifica errore
    classify(error) {
        if (!navigator.onLine) return 'network';
        if (error?.status === 401 || error?.status === 403) return 'auth';
        if (error?.status === 429) return 'quota';
        if (error?.status === 404) return 'notfound';
        if (error?.status >= 500) return 'server';
        if (error?.message?.includes('network') || error?.message?.includes('fetch')) return 'network';
        return 'unknown';
    },

    // Gestisci errore con messaggio user-friendly
    handle(error, context = '') {
        console.error(`❌ Errore ${context}:`, error);

        const type = this.classify(error);
        const message = this.messages[type];

        // Azioni speciali per tipo errore
        if (type === 'auth') {
            // Forza re-login
            setTimeout(() => {
                if (confirm('Sessione scaduta. Vuoi effettuare nuovamente l\'accesso?')) {
                    logout();
                }
            }, 500);
        } else if (type === 'network' && !navigator.onLine) {
            // Aggiungi a coda offline se appropriato
            if (context.includes('sync')) {
                offlineQueue.add({ type: 'sync' });
            }
        }

        showToast(message, 'error');
        return { type, message };
    },

    // Wrapper per funzioni async
    async wrap(fn, context = '') {
        try {
            return await fn();
        } catch (error) {
            this.handle(error, context);
            throw error;
        }
    }
};

// ============================================
// TOKEN REFRESH AUTOMATICO
// ============================================

const tokenManager = {
    refreshTimer: null,
    checkInterval: 5 * 60 * 1000, // Controlla ogni 5 minuti

    init() {
        // Avvia controllo periodico
        this.startPeriodicCheck();

        // Controlla al focus della finestra
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.checkAndRefresh();
            }
        });
    },

    startPeriodicCheck() {
        if (this.refreshTimer) clearInterval(this.refreshTimer);
        this.refreshTimer = setInterval(() => this.checkAndRefresh(), this.checkInterval);
    },

    async checkAndRefresh() {
        if (!isGoogleSignedIn) return;

        const expiry = localStorage.getItem('google_token_expiry');
        if (!expiry) return;

        const expiryTime = parseInt(expiry);
        const now = Date.now();
        const timeUntilExpiry = expiryTime - now;

        // Se scade entro 10 minuti, refresh silenzioso
        if (timeUntilExpiry < 10 * 60 * 1000 && timeUntilExpiry > 0) {
            console.log('🔄 Token in scadenza, refresh silenzioso...');
            await this.silentRefresh();
        }
        // Se già scaduto
        else if (timeUntilExpiry <= 0) {
            console.log('⚠️ Token scaduto, richiesta nuovo token...');
            await this.silentRefresh();
        }
    },

    async silentRefresh() {
        try {
            // Richiedi nuovo token senza prompt
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        } catch (error) {
            console.error('Errore refresh token:', error);
            // Non disturbare l'utente a meno che non sia necessario
        }
    }
};

// ============================================
// PERFORMANCE UTILITIES
// ============================================

// Debounce - ritarda esecuzione fino a quando l'utente smette di chiamare
function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Throttle - limita le chiamate a una volta ogni X ms
function throttle(func, limit = 100) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// Render ottimizzato con requestAnimationFrame
function optimizedRender(renderFn) {
    if (window.requestAnimationFrame) {
        requestAnimationFrame(() => renderFn());
    } else {
        renderFn();
    }
}

// Lazy load per liste lunghe (Virtual Scrolling semplificato)
const lazyList = {
    // Renderizza solo elementi visibili + buffer
    render(containerId, items, renderItem, itemHeight = 60, buffer = 5) {
        const container = document.getElementById(containerId);
        if (!container || !items.length) return;

        const containerHeight = container.clientHeight || 400;
        const visibleCount = Math.ceil(containerHeight / itemHeight) + buffer * 2;

        // Per liste piccole, renderizza tutto
        if (items.length <= visibleCount * 2) {
            container.innerHTML = items.map(renderItem).join('');
            return;
        }

        // Per liste grandi, usa lazy loading
        let currentStart = 0;
        const renderVisible = () => {
            const scrollTop = container.scrollTop;
            const start = Math.max(0, Math.floor(scrollTop / itemHeight) - buffer);
            const end = Math.min(items.length, start + visibleCount);

            if (start !== currentStart) {
                currentStart = start;
                const paddingTop = start * itemHeight;
                const paddingBottom = (items.length - end) * itemHeight;

                container.innerHTML = `
                    <div style="height:${paddingTop}px"></div>
                    ${items.slice(start, end).map(renderItem).join('')}
                    <div style="height:${paddingBottom}px"></div>
                `;
            }
        };

        container.style.overflowY = 'auto';
        container.addEventListener('scroll', throttle(renderVisible, 50));
        renderVisible();
    }
};

// ============================================
// FORM VALIDATION HELPERS
// ============================================

const formValidation = {
    // Valida email
    isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    },

    // Valida numero positivo
    isPositiveNumber(value) {
        const num = parseFloat(value);
        return !isNaN(num) && num > 0;
    },

    // Valida data (non nel passato se richiesto)
    isValidDate(dateStr, allowPast = true) {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return false;
        if (!allowPast && date < new Date().setHours(0, 0, 0, 0)) return false;
        return true;
    },

    // Valida lunghezza stringa
    isValidLength(str, min = 1, max = 500) {
        const len = (str || '').trim().length;
        return len >= min && len <= max;
    },

    // Mostra errore su campo
    showFieldError(inputId, message) {
        const input = document.getElementById(inputId);
        if (!input) return;

        input.classList.add('input-error');
        input.style.borderColor = 'var(--danger)';

        // Rimuovi errore precedente
        const existingError = input.parentElement.querySelector('.field-error-msg');
        if (existingError) existingError.remove();

        // Aggiungi messaggio errore
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error-msg';
        errorDiv.style.cssText = 'color: var(--danger); font-size: 0.75rem; margin-top: 4px;';
        errorDiv.textContent = message;
        input.parentElement.appendChild(errorDiv);

        // Focus sul campo
        input.focus();
    },

    // Rimuovi errore da campo
    clearFieldError(inputId) {
        const input = document.getElementById(inputId);
        if (!input) return;

        input.classList.remove('input-error');
        input.style.borderColor = '';

        const errorMsg = input.parentElement.querySelector('.field-error-msg');
        if (errorMsg) errorMsg.remove();
    },

    // Valida form completo
    validateForm(fields) {
        let isValid = true;

        fields.forEach(({ id, rules }) => {
            this.clearFieldError(id);
            const input = document.getElementById(id);
            if (!input) return;

            const value = input.value;

            for (const rule of rules) {
                if (rule.required && !value.trim()) {
                    this.showFieldError(id, rule.message || 'Campo obbligatorio');
                    isValid = false;
                    break;
                }
                if (rule.email && value && !this.isValidEmail(value)) {
                    this.showFieldError(id, rule.message || 'Email non valida');
                    isValid = false;
                    break;
                }
                if (rule.minLength && value.length < rule.minLength) {
                    this.showFieldError(id, rule.message || `Minimo ${rule.minLength} caratteri`);
                    isValid = false;
                    break;
                }
                if (rule.positive && !this.isPositiveNumber(value)) {
                    this.showFieldError(id, rule.message || 'Inserisci un numero positivo');
                    isValid = false;
                    break;
                }
            }
        });

        return isValid;
    }
};

// ============================================
// ENHANCED EMPTY STATES
// ============================================

function renderEmptyState(containerId, config) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const { icon = '📭', title = 'Nessun elemento', message = '', action = null } = config;

    container.innerHTML = `
        <div class="empty-state" style="
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        ">
            <div style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;">${icon}</div>
            <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">${title}</div>
            ${message ? `<div style="font-size: 0.85rem; margin-bottom: 16px;">${message}</div>` : ''}
            ${action ? `<button class="btn btn-primary btn-sm" onclick="${action.onClick}">${action.label}</button>` : ''}
        </div>
    `;
}

// Marca una collezione come modificata
function markCollectionDirty(collectionName) {
    changeTracker.dirtyCollections.add(collectionName);
    changeTracker.changeCount++;
}

// Marca un singolo item come modificato
function markItemModified(collectionName, itemId) {
    if (changeTracker.modifiedItems[collectionName]) {
        changeTracker.modifiedItems[collectionName].add(itemId);
    }
    markCollectionDirty(collectionName);
}

// Marca un item come eliminato
function markItemDeleted(collectionName, itemId) {
    if (changeTracker.deletedItems[collectionName]) {
        changeTracker.deletedItems[collectionName].push({
            id: itemId,
            deletedAt: Date.now()
        });
    }
    markCollectionDirty(collectionName);
}

// Pulisce il tracker dopo una sync riuscita
function clearChangeTracker() {
    changeTracker.dirtyCollections.clear();
    Object.values(changeTracker.modifiedItems).forEach(set => set.clear());
    Object.values(changeTracker.deletedItems).forEach(arr => arr.length = 0);
    changeTracker.changeCount = 0;
}

// Verifica se è necessaria una full sync
function needsFullSync() {
    const timeSinceLastFullSync = Date.now() - changeTracker.lastFullSync;
    return timeSinceLastFullSync > changeTracker.fullSyncInterval;
}

// Prepara i dati per sync incrementale
function prepareIncrementalSyncData() {
    const syncData = {
        type: 'incremental',
        timestamp: Date.now(),
        changes: {}
    };

    // Collezioni che sono oggetti (non array) - sempre fullReplace
    const objectCollections = ['profile', 'user', 'settings', 'today', 'stats', 'journalEntry'];

    // Aggiungi solo le collezioni modificate
    changeTracker.dirtyCollections.forEach(collection => {
        if (state[collection] !== undefined) {
            // Se è un oggetto (non array), usa sempre fullReplace
            if (objectCollections.includes(collection) || !Array.isArray(state[collection])) {
                syncData.changes[collection] = {
                    fullReplace: true,
                    data: state[collection]
                };
                console.log(`📤 Sync ${collection} (oggetto):`, state[collection]);
                return;
            }

            // Per gli array, verifica quanti item sono stati modificati
            const modifiedCount = changeTracker.modifiedItems[collection]?.size || 0;

            if (modifiedCount > 10 || !changeTracker.modifiedItems[collection]) {
                // Invia tutta la collezione
                syncData.changes[collection] = {
                    fullReplace: true,
                    data: state[collection]
                };
            } else {
                // Invia solo gli item modificati
                const modifiedIds = Array.from(changeTracker.modifiedItems[collection]);
                const items = [];

                modifiedIds.forEach(id => {
                    const item = state[collection].find(i => i.id === id);
                    if (item) items.push(item);
                });

                syncData.changes[collection] = {
                    fullReplace: false,
                    items: items,
                    deleted: changeTracker.deletedItems[collection] || []
                };
            }
        }
    });

    return syncData;
}

// ============================================
// LAZY LOADING SYSTEM (Performance)
// ============================================

const lazyLoader = {
    // Configurazione
    batchSize: 20,           // Quanti item caricare per batch
    scrollThreshold: 200,    // Pixel dal fondo per triggerare caricamento
    loadingStates: new Map(), // Container ID -> { loading, hasMore, offset }

    // Inizializza lazy loading per un container
    init(containerId, items, renderFn) {
        const container = document.getElementById(containerId);
        if (!container) return;

        this.loadingStates.set(containerId, {
            loading: false,
            hasMore: items.length > this.batchSize,
            offset: 0,
            items: items,
            renderFn: renderFn
        });

        // Renderizza primo batch
        this.loadBatch(containerId);

        // Setup scroll listener
        container.addEventListener('scroll', () => this.handleScroll(containerId));
    },

    // Carica un batch di items
    loadBatch(containerId) {
        const state = this.loadingStates.get(containerId);
        if (!state || state.loading || !state.hasMore) return;

        state.loading = true;
        const container = document.getElementById(containerId);
        if (!container) return;

        const start = state.offset;
        const end = Math.min(start + this.batchSize, state.items.length);
        const batch = state.items.slice(start, end);

        // Rimuovi loader se presente
        const loader = container.querySelector('.lazy-loader');
        if (loader) loader.remove();

        // Renderizza batch
        batch.forEach(item => {
            const html = state.renderFn(item);
            container.insertAdjacentHTML('beforeend', html);
        });

        // Aggiorna stato
        state.offset = end;
        state.hasMore = end < state.items.length;
        state.loading = false;

        // Aggiungi loader se ci sono altri items
        if (state.hasMore) {
            container.insertAdjacentHTML('beforeend', `
                <div class="lazy-loader" style="text-align:center; padding:10px; color:var(--text-muted);">
                    <span class="spinner-small"></span> Caricamento...
                </div>
            `);
        }
    },

    // Gestisce scroll
    handleScroll(containerId) {
        const state = this.loadingStates.get(containerId);
        if (!state || state.loading || !state.hasMore) return;

        const container = document.getElementById(containerId);
        if (!container) return;

        const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;

        if (scrollBottom < this.scrollThreshold) {
            this.loadBatch(containerId);
        }
    },

    // Reset per un container (quando cambiano i dati)
    reset(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '';
        }
        this.loadingStates.delete(containerId);
    }
};

// Lazy loading per notifiche (può diventare molto grande)
function renderNotificationsLazy(notifications) {
    const container = document.getElementById('notificationsList');
    if (!container) return;

    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="notification-empty">Nessuna notifica</div>';
        return;
    }

    // Ordina per data (più recenti prima)
    const sorted = [...notifications].sort((a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt)
    );

    // Reset e inizializza lazy loading
    lazyLoader.reset('notificationsList');
    lazyLoader.init('notificationsList', sorted, renderSingleNotification);
}

// Renderizza singola notifica (usato da lazy loader)
function renderSingleNotification(notif) {
    const timeAgo = getTimeAgo(notif.createdAt);
    const isRead = notif.read ? 'read' : 'unread';
    const icon = getNotificationIcon(notif.type);

    return `
        <div class="notification-item ${isRead}" data-id="${notif.id}" onclick="handleNotificationClick('${notif.id}')">
            <span class="notification-icon">${icon}</span>
            <div class="notification-content">
                <div class="notification-text">${notif.message || notif.text}</div>
                <div class="notification-time">${timeAgo}</div>
            </div>
            ${!notif.read ? '<span class="notification-dot"></span>' : ''}
        </div>
    `;
}

// Helper per icona notifica
function getNotificationIcon(type) {
    const icons = {
        'task_assigned': '📋',
        'task_completed': '✅',
        'comment_added': '💬',
        'project_shared': '🤝',
        'deadline_reminder': '⏰',
        'mention': '@',
        'system': '🔔'
    };
    return icons[type] || '🔔';
}

// Helper per tempo relativo
function getTimeAgo(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'ora';
    if (diffMins < 60) return `${diffMins}m fa`;
    if (diffHours < 24) return `${diffHours}h fa`;
    if (diffDays < 7) return `${diffDays}g fa`;
    return date.toLocaleDateString('it-IT');
}

// Verifica se la cache è valida
function isCacheValid(cacheEntry) {
    if (!cacheEntry) return false;
    return (Date.now() - cacheEntry.timestamp) < dataCache.cacheDuration;
}

// Prefetch commenti per un task (chiamato quando si hover su un task)
function prefetchTaskComments(taskId) {
    if (!taskId || !state.cloudUser?.token) return;

    // Se già in cache e valido, skip
    if (isCacheValid(dataCache.comments.get(taskId))) return;

    // Fetch in background senza bloccare
    apiCall('ottieniCommentiTask', { task_id: taskId })
        .then(result => {
            if (result.success) {
                dataCache.comments.set(taskId, {
                    data: result.commenti || [],
                    timestamp: Date.now()
                });
                console.log('📦 Prefetched comments for task:', taskId);
            }
        })
        .catch(() => {}); // Ignora errori di prefetch
}

// Prefetch progetti condivisi
function prefetchSharedProjects() {
    if (!state.cloudUser?.token) return;

    apiCall('getSharedProjects', { email: state.cloudUser?.email })
        .then(result => {
            if (result.success && result.projects) {
                result.projects.forEach(p => {
                    dataCache.projects.set(p.id, {
                        data: p,
                        timestamp: Date.now()
                    });
                });
                console.log('📦 Prefetched', result.projects.length, 'shared projects');
            }
        })
        .catch(() => {});
}

// Aggiunge operazione alla coda background
function queueBackgroundOperation(operation) {
    backgroundQueue.pending.push(operation);
    processBackgroundQueue();
}

// Processa la coda in background
async function processBackgroundQueue() {
    if (backgroundQueue.processing || backgroundQueue.pending.length === 0) return;

    backgroundQueue.processing = true;

    while (backgroundQueue.pending.length > 0) {
        const operation = backgroundQueue.pending.shift();
        try {
            await operation();
        } catch (e) {
            console.warn('⚠️ Background operation failed:', e);
        }
    }

    backgroundQueue.processing = false;
}

// Ottieni commenti (con cache)
async function getCachedComments(taskId) {
    const cached = dataCache.comments.get(taskId);
    if (isCacheValid(cached)) {
        console.log('📦 Using cached comments for task:', taskId);
        return cached.data;
    }

    // Fetch fresh
    if (state.cloudUser?.token) {
        try {
            const result = await apiCall('ottieniCommentiTask', { task_id: taskId });
            if (result.success) {
                dataCache.comments.set(taskId, {
                    data: result.commenti || [],
                    timestamp: Date.now()
                });
                return result.commenti || [];
            }
        } catch (e) {
            console.warn('Error fetching comments:', e);
        }
    }
    return null;
}

// Invalida cache per un task specifico
function invalidateTaskCache(taskId) {
    dataCache.comments.delete(taskId);
}

// Invalida cache progetto
function invalidateProjectCache(projectId) {
    dataCache.projects.delete(projectId);
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', () => {
    loadState();
    initializeApp();
    initKeyboardHandler(); // Gestione tastiera virtuale mobile

    // IMPORTANTE: Mostra sempre la schermata di login all'avvio
    // L'app sarà visibile solo dopo autenticazione Google valida
    showLoginScreen();
});

/**
 * Gestisce la tastiera virtuale su mobile
 * Assicura che i campi di input siano sempre visibili quando si digita
 */
function initKeyboardHandler() {
    // Usa visualViewport API se disponibile (più precisa)
    if (window.visualViewport) {
        let pendingUpdate = false;

        const viewportHandler = () => {
            if (pendingUpdate) return;
            pendingUpdate = true;

            requestAnimationFrame(() => {
                pendingUpdate = false;
                const focusedElement = document.activeElement;

                if (focusedElement && (
                    focusedElement.tagName === 'INPUT' ||
                    focusedElement.tagName === 'TEXTAREA' ||
                    focusedElement.isContentEditable
                )) {
                    // Calcola se l'elemento è coperto dalla tastiera
                    const rect = focusedElement.getBoundingClientRect();
                    const viewportHeight = window.visualViewport.height;
                    const viewportTop = window.visualViewport.offsetTop;

                    // Se l'elemento è sotto la viewport visibile
                    if (rect.bottom > viewportHeight + viewportTop) {
                        // Scrolla per mostrare l'elemento con un po' di margine
                        const scrollAmount = rect.bottom - viewportHeight - viewportTop + 50;
                        focusedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        };

        window.visualViewport.addEventListener('resize', viewportHandler);
        window.visualViewport.addEventListener('scroll', viewportHandler);
    }

    // Fallback per browser senza visualViewport
    document.addEventListener('focusin', (e) => {
        const target = e.target;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
            // Piccolo delay per aspettare che la tastiera si apra
            setTimeout(() => {
                // Usa scrollIntoView con block: 'center' per centrare l'elemento
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Per i modal, assicuriamoci che il contenuto sia visibile
                const modal = target.closest('.modal-content');
                if (modal) {
                    modal.style.maxHeight = `${window.innerHeight * 0.6}px`;
                    modal.style.overflowY = 'auto';
                }
            }, 300);
        }
    });

    // Ripristina al blur
    document.addEventListener('focusout', (e) => {
        const target = e.target;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
            const modal = target.closest('.modal-content');
            if (modal) {
                setTimeout(() => {
                    modal.style.maxHeight = '';
                    modal.style.overflowY = '';
                }, 300);
            }
        }
    });
}

/**
 * Scrolla un input nella viewport quando riceve focus
 * Utile per mobile quando la tastiera copre l'input
 */
function scrollInputIntoView(element) {
    if (!element) return;

    // Piccolo delay per aspettare che la tastiera si apra
    setTimeout(() => {
        // Trova il modal contenitore se esiste
        const modal = element.closest('.modal-content');

        if (modal) {
            // Scrolla il modal per mostrare l'input
            const inputRect = element.getBoundingClientRect();
            const modalRect = modal.getBoundingClientRect();

            // Se l'input è fuori dalla vista del modal
            if (inputRect.bottom > modalRect.bottom - 50) {
                // Scrolla il modal per mostrare l'input
                const scrollAmount = inputRect.bottom - modalRect.bottom + 100;
                modal.scrollTop += scrollAmount;
            }
        }

        // Usa anche scrollIntoView per sicurezza
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 350);
}

function loadState() {
    // NON carichiamo più da localStorage - solo da Google Sheets
    // Questa funzione viene chiamata all'avvio, ma i dati reali
    // vengono caricati da loadFromCloud() dopo il login
    console.log('loadState() chiamato - i dati verranno caricati da Google Sheets dopo il login');

    // Apply settings di default
    pomodoroTime = state.settings.pomodoroDuration * 60;
    if (state.settings.darkMode) {
        document.body.classList.add('theme-dark');
    }
}

// Variabile per debounce del salvataggio
let saveStateTimeout = null;
let savingToCloud = false;

// Salva lo stato SOLO su Google Sheets (NO localStorage)
function saveState() {
    // Aggiorna window.state
    window.state = state;
    console.log('State updated in memory. Tasks count:', state.tasks?.length || 0);
    // NON salva su localStorage - tutto va su Google Sheets
}

// Salva lo stato su Google Sheets con debounce breve
function saveStateAndSync(modifiedCollection = null, modifiedItemId = null) {
    window.state = state;

    // Traccia le modifiche per incremental sync
    if (modifiedCollection) {
        if (modifiedItemId) {
            markItemModified(modifiedCollection, modifiedItemId);
        } else {
            markCollectionDirty(modifiedCollection);
        }
    }

    // Sincronizza con debounce di 1 secondo (per evitare troppe chiamate)
    if (isLoggedIn && currentUser && !syncInProgress) {
        clearTimeout(syncTimeout);
        syncTimeout = setTimeout(() => {
            console.log('☁️ Saving to Google Sheets...');
            syncToCloud();
        }, 1000); // 1 secondo di debounce
    } else if (!isLoggedIn) {
        console.warn('⚠️ Non loggato - impossibile salvare su cloud');
        showToast('Effettua il login per salvare i dati', 'warning');
    }
}

// Shorthand per marcare modifiche ai progetti
function saveProjectAndSync(projectId) {
    saveStateAndSync('teamProjects', projectId);
}

// Shorthand per marcare modifiche ai task personali
function saveTasksAndSync() {
    saveStateAndSync('tasks');
}

// Shorthand per marcare modifiche alle abitudini
function saveHabitsAndSync() {
    saveStateAndSync('habits');
}

// Salvataggio immediato su Google Sheets (per casi critici)
async function saveStateImmediate() {
    window.state = state;
    if (isLoggedIn && currentUser) {
        try {
            await syncToCloud();
            console.log('✅ State saved to cloud immediately');
        } catch (e) {
            console.error('Error saving state to cloud:', e);
        }
    }
}

// ============================================
// LOG ATTIVITA PER KPI
// ============================================

// Log attivita utente per analytics e KPI
async function logAttivita(azione, modulo, riferimentoId = null, dettagli = null) {
    if (!state.cloudUser?.token) return;

    try {
        await apiCall('logAttivita', {
            azione: azione,
            modulo: modulo,
            riferimento_id: riferimentoId,
            dettagli: dettagli,
            dispositivo: /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
        });
    } catch (e) {
        // Ignora errori di logging per non bloccare l'app
        console.warn('⚠️ Errore log attivita:', e);
    }
}

// Ottieni KPI utente corrente
async function ottieniKPI() {
    if (!state.cloudUser?.token) return null;

    try {
        const result = await apiCall('ottieniKPI', {});
        if (result.success) {
            return result.kpi;
        }
    } catch (e) {
        console.warn('⚠️ Errore caricamento KPI:', e);
    }
    return null;
}

// ============================================
// DEPARTMENT SWITCHING (VITA/LAVORO)
// ============================================

function switchDepartment(dept) {
    state.currentDepartment = dept;

    // Update UI buttons immediatamente
    document.querySelectorAll('.dept-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.dept === dept);
    });

    // Mostra feedback visivo
    const deptNames = {
        'all': '🌟 Tutto - Visualizzi tutti i contenuti',
        'personal': '👤 Vita - Solo contenuti personali',
        'work': '🎭 Lavoro - Solo contenuti lavorativi'
    };
    showToast(deptNames[dept] || 'Filtro applicato', 'info');

    // Salva lo stato subito
    saveStateAndSync();

    // Renderizza solo la pagina corrente per non bloccare l'UI
    // Le altre pagine si aggiorneranno quando l'utente le visita
    requestAnimationFrame(() => {
        updateDepartmentStats();

        // Renderizza solo la pagina attualmente visibile
        const currentPage = state.currentPage || 'home';
        switch(currentPage) {
            case 'home': renderHomePage(); break;
            case 'tasks': renderTasksPage(); break;
            case 'goals': renderGoalsPage(); break;
            case 'habits': renderHabitsPage(); break;
            case 'notes': renderNotesPage(); break;
            case 'finance': renderFinancePage(); break;
            case 'calendar': if (typeof renderCalendar === 'function') renderCalendar(); break;
        }
    });
}

function updateDepartmentStats() {
    const dept = state.currentDepartment;

    // Helper per update sicuro degli elementi
    const safeUpdate = (id, value, prop = 'textContent') => {
        const el = document.getElementById(id);
        if (el) {
            if (prop === 'textContent') el.textContent = value;
            else if (prop === 'style.width') el.style.width = value;
        }
    };

    // Calcola stats lavoro
    const workTasks = (state.tasks || []).filter(t => t.department === 'work');
    const workCompleted = workTasks.filter(t => t.completed).length;
    safeUpdate('workTasksCount', `${workCompleted}/${workTasks.length}`);
    safeUpdate('workFocusHours', `${state.today?.pomodoros || 0}h`);
    safeUpdate('workEventsCount', '0');

    // Calcola stats personali
    const routineCompleted = (state.today?.routineCompleted || []).filter(r => r).length;
    const routinePercent = Math.round((routineCompleted / 6) * 100);
    safeUpdate('personalRoutinePercent', `${routinePercent}%`);

    const personalHabits = (state.habits || []).filter(h => h.department === 'personal' || !h.department);
    const habitsCompletedToday = personalHabits.filter(h => {
        const today = new Date().toISOString().split('T')[0];
        return h.completedDates && h.completedDates.includes(today);
    }).length;
    safeUpdate('personalHabitsCount', habitsCompletedToday);

    const moodEmojis = ['😫', '😔', '😐', '🙂', '😄'];
    safeUpdate('personalEnergy', state.today?.mood ? moodEmojis[state.today.mood - 1] : '-');

    // Calcola equilibrio vita/lavoro
    const workActivity = workCompleted + (state.today?.pomodoros || 0);
    const personalActivity = routineCompleted + habitsCompletedToday;
    const totalActivity = workActivity + personalActivity || 1;
    const balancePercent = Math.round((workActivity / totalActivity) * 100);

    safeUpdate('balancePercent', `${balancePercent}%`);
    safeUpdate('balanceBar', `${balancePercent}%`, 'style.width');
}

function filterByDepartment(items) {
    if (state.currentDepartment === 'all') return items;
    return items.filter(item => item.department === state.currentDepartment || !item.department);
}

// Debounce per evitare troppe chiamate API
// Sincronizza solo se ci sono modifiche da sincronizzare
let syncTimeout = null;
let lastStateHash = null;

function getStateHash() {
    // Hash semplice basato sui conteggi degli elementi principali
    return `${state.tasks?.length || 0}-${state.notes?.length || 0}-${state.transactions?.length || 0}-${state.habits?.length || 0}-${state.goals?.length || 0}-${state.stats?.xp || 0}`;
}

function debouncedSync() {
    clearTimeout(syncTimeout);

    // Verifica se lo state è effettivamente cambiato
    const currentHash = getStateHash();
    if (currentHash === lastStateHash) {
        console.log('⏭️ Sync skipped - no changes detected');
        return;
    }

    // Aspetta 15 secondi di inattività prima di sincronizzare
    syncTimeout = setTimeout(() => {
        const newHash = getStateHash();
        if (newHash !== lastStateHash) {
            console.log('☁️ Syncing changes to cloud...');
            lastStateHash = newHash;
            syncToCloud();
        }
    }, 15000); // 15 secondi di debounce (era 5)
}

// ============================================
// GOOGLE SHEETS API FUNCTIONS - CORS-SAFE
// ============================================

/**
 * Chiamata API principale - Usa GET per evitare problemi CORS
 * Google Apps Script non gestisce bene le preflight OPTIONS requests
 */
async function apiCall(action, data = {}) {
    const payload = {
        action,
        ...data,
        token: data.token || currentUser?.token
    };

    const jsonPayload = JSON.stringify(payload);
    console.log('📡 API Call:', action, '- size:', jsonPayload.length);

    // Traccia chiamata API per monitoraggio quota
    trackApiCall(action);

    // Azioni che DEVONO usare POST (payload potenzialmente grandi o che modificano dati)
    const forcePostActions = [
        'updateSharedProject',
        'shareProject',
        'syncFullState',
        'syncPartialState',
        'saveProjectActivity',
        'salvaCommentoTask',
        'eliminaCommentoTask'
    ];

    // Verifica se deve usare POST
    const mustUsePost = forcePostActions.includes(action) || jsonPayload.length >= 5000;

    if (mustUsePost) {
        console.log('📤 POST forced for:', action, '- reason:',
            forcePostActions.includes(action) ? 'in forcePostActions' : 'payload size >= 5000');
        return await apiCallPost(action, data);
    } else {
        console.log('📥 GET used for:', action, '- size:', jsonPayload.length);
        return await apiCallGet(action, data);
    }
}

/**
 * GET Request - Sempre funziona con Google Apps Script (no preflight)
 */
async function apiCallGet(action, data = {}) {
    const payload = {
        action,
        ...data,
        token: data.token || currentUser?.token
    };
    const payloadJson = JSON.stringify(payload);
    const encodedData = encodeURIComponent(payloadJson);
    const url = `${CONFIG.API_URL}?data=${encodedData}`;

    console.log('📥 apiCallGet executing:', action);
    console.log('📥 Payload size:', payloadJson.length, 'bytes');
    console.log('📥 URL length:', url.length, 'chars');

    // Avviso se URL troppo lungo (limite browser ~2000 chars, server ~8000 chars)
    if (url.length > 7500) {
        console.warn('⚠️ URL molto lungo (' + url.length + ' chars) - potrebbe fallire!');
    }

    try {
        const response = await fetch(url, {
            method: 'GET',
            redirect: 'follow'
        });

        const text = await response.text();

        // Check for Google redirect page
        if (text.includes('<!DOCTYPE') || text.includes('<html')) {
            console.error('❌ Ricevuto HTML invece di JSON - verifica deployment');
            return localStorageFallback(action, data);
        }

        const result = JSON.parse(text);
        console.log('✅ API GET OK:', action);
        return result;
    } catch (error) {
        console.error('❌ API GET Error:', error);
        return localStorageFallback(action, data);
    }
}

/**
 * POST Request - Per payload grandi
 * Usa application/x-www-form-urlencoded per massima compatibilità con Google Apps Script
 */
async function apiCallPost(action, data = {}) {
    const payload = {
        action,
        ...data,
        token: data.token || currentUser?.token
    };

    const payloadJson = JSON.stringify(payload);
    console.log('📤 apiCallPost executing:', action);
    console.log('📤 Payload size:', payloadJson.length, 'bytes');

    try {
        // Usa URLSearchParams per form-urlencoded (più compatibile con GAS)
        const params = new URLSearchParams();
        params.append('data', payloadJson);

        console.log('📤 Sending POST to:', CONFIG.API_URL);

        const response = await fetch(CONFIG.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString(),
            redirect: 'follow'
        });

        const text = await response.text();

        if (text.includes('<!DOCTYPE') || text.includes('<html')) {
            console.warn('⚠️ POST ha restituito HTML, provo con GET chunked');
            // Per updateSharedProject, non possiamo usare chunked sync
            if (action === 'updateSharedProject') {
                console.error('❌ updateSharedProject fallito - payload troppo grande');
                return { success: false, message: 'Payload troppo grande per la sincronizzazione' };
            }
            return await syncStateChunked(payload.token, payload.state);
        }

        const result = JSON.parse(text);
        console.log('✅ API POST OK:', action);
        return result;
    } catch (error) {
        console.error('❌ API POST Error:', error);
        return localStorageFallback(action, data);
    }
}

/**
 * Sync chunked per payload molto grandi
 */
async function syncStateChunked(token, fullState) {
    if (!fullState) return { success: false, message: 'No state to sync' };

    const chunks = {
        tasks: fullState.tasks || [],
        transactions: fullState.transactions || [],
        events: fullState.events || [],
        goals: fullState.goals || [],
        notes: fullState.notes || [],
        habits: fullState.habits || [],
        moneyGoals: fullState.moneyGoals || [],
        skills: fullState.skills || [],
        settings: fullState.settings || {},
        pomodoro: fullState.pomodoro || {},
        stats: fullState.stats || {}
    };

    let success = true;

    for (const [key, value] of Object.entries(chunks)) {
        if (Array.isArray(value) && value.length === 0) continue;
        if (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0) continue;

        try {
            const partialState = { [key]: value };
            await apiCallGet('syncPartialState', { token, key, data: partialState });
        } catch (error) {
            console.error(`❌ Errore sync chunk ${key}:`, error);
            success = false;
        }
    }

    return { success, message: success ? 'Sync completato' : 'Sync parziale' };
}

function localStorageFallback(action, data) {
    const users = JSON.parse(localStorage.getItem('savers_users') || '{}');
    const sessions = JSON.parse(localStorage.getItem('savers_sessions') || '{}');

    switch (action) {
        case 'login':
            if (users[data.username] && users[data.username].password === data.password) {
                return { success: true, token: 'local_' + data.username };
            }
            return { success: false, message: 'Credenziali non valide' };

        case 'register':
            if (users[data.username]) {
                return { success: false, message: 'Username già esistente' };
            }
            users[data.username] = { password: data.password, email: data.email };
            localStorage.setItem('savers_users', JSON.stringify(users));
            return { success: true, token: 'local_' + data.username };

        case 'saveData':
        case 'syncFullState':
            const userSessions = sessions[currentUser?.username] || [];
            const today = new Date().toISOString().split('T')[0];
            const existingIndex = userSessions.findIndex(s => s.date === today);

            const sessionData = {
                date: today,
                state: data.state,
                timestamp: new Date().toISOString()
            };

            if (existingIndex >= 0) {
                userSessions[existingIndex] = sessionData;
            } else {
                userSessions.unshift(sessionData);
            }

            sessions[currentUser?.username] = userSessions;
            localStorage.setItem('savers_sessions', JSON.stringify(sessions));
            return { success: true, timestamp: new Date().toISOString() };

        case 'getData':
            const userHistory = sessions[currentUser?.username] || [];
            return { success: true, data: userHistory };

        case 'loadFullState':
            const userFullState = sessions[currentUser?.username] || [];
            if (userFullState.length > 0) {
                return { success: true, state: userFullState[0].state, timestamp: userFullState[0].timestamp };
            }
            return { success: true, state: null };

        case 'getTodayData':
            const todaySessions = sessions[currentUser?.username] || [];
            const todayDate = new Date().toISOString().split('T')[0];
            const todaySession = todaySessions.find(s => s.date === todayDate);
            return { success: true, data: todaySession || null };

        default:
            return { success: false, message: 'Azione non supportata' };
    }
}

// ============================================
// API CALL TRACKING (Monitoraggio quota)
// ============================================

function trackApiCall(action) {
    const today = new Date().toISOString().split('T')[0];

    // Reset contatori se è un nuovo giorno
    if (apiCallStats.today !== today) {
        apiCallStats = {
            today: today,
            totalCalls: 0,
            callsByAction: {},
            lastReset: Date.now()
        };
        // Salva reset in localStorage
        localStorage.setItem('savers_api_stats', JSON.stringify(apiCallStats));
    }

    // Incrementa contatori
    apiCallStats.totalCalls++;
    apiCallStats.callsByAction[action] = (apiCallStats.callsByAction[action] || 0) + 1;

    // Salva statistiche
    localStorage.setItem('savers_api_stats', JSON.stringify(apiCallStats));

    // Aggiorna widget se visibile
    updateApiStatsWidget();

    // Warning se si avvicina al limite (80% di 20.000)
    if (apiCallStats.totalCalls === 16000) {
        showToast('⚠️ Attenzione: 80% quota API giornaliera raggiunta!', 'warning');
    }
}

function loadApiStats() {
    const saved = localStorage.getItem('savers_api_stats');
    if (saved) {
        const stats = JSON.parse(saved);
        const today = new Date().toISOString().split('T')[0];
        // Usa solo se è lo stesso giorno
        if (stats.today === today) {
            apiCallStats = stats;
        }
    }
}

function updateApiStatsWidget() {
    const widget = document.getElementById('apiStatsWidget');
    if (!widget) return;

    const percentage = ((apiCallStats.totalCalls / 20000) * 100).toFixed(2);
    const color = percentage > 80 ? '#ef4444' : percentage > 50 ? '#f59e0b' : '#10b981';

    widget.innerHTML = `
        <div style="font-size:0.75rem;color:var(--text-secondary);">
            📊 API Oggi: <strong style="color:${color}">${apiCallStats.totalCalls.toLocaleString()}</strong> / 20.000
            <span style="color:${color}">(${percentage}%)</span>
        </div>
    `;
}

function showApiStatsModal() {
    // Ordina azioni per numero di chiamate (decrescente)
    const sortedActions = Object.entries(apiCallStats.callsByAction)
        .sort((a, b) => b[1] - a[1]);

    const actionsHtml = sortedActions.length > 0
        ? sortedActions.map(([action, count]) => `
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border-color);">
                <span style="font-family:monospace;font-size:0.85rem;">${action}</span>
                <span style="font-weight:600;">${count}</span>
            </div>
        `).join('')
        : '<div class="text-muted">Nessuna chiamata registrata</div>';

    const percentage = ((apiCallStats.totalCalls / 20000) * 100).toFixed(2);
    const color = percentage > 80 ? '#ef4444' : percentage > 50 ? '#f59e0b' : '#10b981';

    const modalHtml = `
        <div style="padding:16px;">
            <h3 style="margin-bottom:16px;">📊 Statistiche API - Oggi</h3>

            <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <span>Chiamate totali:</span>
                    <strong style="font-size:1.5rem;color:${color}">${apiCallStats.totalCalls.toLocaleString()}</strong>
                </div>
                <div style="background:var(--bg-tertiary);border-radius:8px;height:12px;overflow:hidden;">
                    <div style="background:${color};height:100%;width:${Math.min(percentage, 100)}%;transition:width 0.3s;"></div>
                </div>
                <div style="text-align:right;font-size:0.75rem;color:var(--text-secondary);margin-top:4px;">
                    ${percentage}% del limite giornaliero (20.000)
                </div>
            </div>

            <h4 style="margin-bottom:8px;">Dettaglio per azione:</h4>
            <div style="max-height:300px;overflow-y:auto;">
                ${actionsHtml}
            </div>

            <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border-color);font-size:0.75rem;color:var(--text-secondary);">
                <strong>Limiti Google Apps Script (account gratuito):</strong><br>
                • 20.000 esecuzioni/giorno per progetto<br>
                • 60 richieste/minuto per utente (Sheets API)<br>
                • Reset alle 00:00 UTC
            </div>
        </div>
    `;

    // Usa il modal generico se esiste, altrimenti alert
    const existingModal = document.getElementById('apiStatsModal');
    if (existingModal) {
        existingModal.querySelector('.modal-body').innerHTML = modalHtml;
        openModal('apiStatsModal');
    } else {
        // Crea modal temporaneo
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'tempApiStatsModal';
        modal.innerHTML = `
            <div class="modal" style="max-width:400px;">
                <div class="modal-header">
                    <h3>📊 Statistiche API</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                </div>
                <div class="modal-body">${modalHtml}</div>
            </div>
        `;
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        document.body.appendChild(modal);
        modal.classList.add('active');
    }
}

// Carica stats all'avvio
loadApiStats();

// ============================================
// AUTHENTICATION FUNCTIONS
// ============================================

async function login(username, password) {
    showToast('Accesso in corso...', 'info');

    try {
        const response = await apiCall('login', { username, password });

        if (response.success) {
            currentUser = {
                username,
                token: response.token,
                email: response.email || null,  // Backend può restituire email
                nickname: response.nickname || username
            };
            isLoggedIn = true;
            localStorage.setItem('savers_current_user', JSON.stringify(currentUser));

            // Carica dati dal cloud
            await loadFromCloud();

            // Carica progetti condivisi con me da altri utenti
            await loadSharedProjects();

            showToast(`Bentornato, ${username}! 🎉`, 'success');
            updateLoginUI();
            return true;
        } else {
            showToast(response.message || 'Credenziali non valide', 'error');
            return false;
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
        return false;
    }
}

async function register(username, email, password) {
    if (!username || !password) {
        showToast('Inserisci username e password', 'error');
        return false;
    }
    if (password.length < 4) {
        showToast('Password min 4 caratteri', 'error');
        return false;
    }

    showToast('Registrazione in corso...', 'info');

    try {
        const response = await apiCall('register', { username, email, password });

        if (response.success) {
            currentUser = {
                username,
                token: response.token,
                email: email || null,
                nickname: username
            };
            isLoggedIn = true;
            localStorage.setItem('savers_current_user', JSON.stringify(currentUser));

            // Sincronizza lo stato attuale al cloud
            await syncToCloud();

            showToast(`Account creato! Benvenuto, ${username}! 🎉`, 'success');
            updateLoginUI();
            return true;
        } else {
            showToast(response.message || 'Errore durante la registrazione', 'error');
            return false;
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
        return false;
    }
}

// Variabile temporanea per la registrazione Google in corso
let pendingGoogleRegistration = null;

// Registra utente Google su Google Sheets
async function registerGoogleUser(email, name) {
    if (!email) {
        console.error('Email Google mancante per registrazione');
        return false;
    }

    console.log('📝 Verifica utente Google su Sheets:', email);

    try {
        // Prima verifica se l'utente esiste già (login con email come identificatore)
        const checkResponse = await apiCall('checkGoogleUser', { email: email });

        if (checkResponse.success && checkResponse.exists) {
            // Utente già registrato - login diretto
            console.log('✅ Utente Google già registrato, login effettuato');
            currentUser = {
                username: checkResponse.username,
                nickname: checkResponse.nickname || checkResponse.username,
                token: checkResponse.token,
                email: email,
                name: checkResponse.fullName || name,
                loginMethod: 'google'
            };
            localStorage.setItem('savers_current_user', JSON.stringify(currentUser));

            // Mostra l'app
            isLoggedIn = true;
            updateLoginUI();
            showApp();
            await loadFromCloud();
            // Carica progetti condivisi con me da altri utenti
            await loadSharedProjects();

            // AUTO-CONNESSIONE GOOGLE CALENDAR (stesso account)
            try {
                await loadUserCalendars();
                await loadCalendarEvents();
                loadGoogleTaskLists();
                console.log('📅 Google Calendar auto-connesso con account:', email);
            } catch (calError) {
                console.warn('⚠️ Errore auto-connessione Calendar:', calError);
            }

            showToast(`Bentornato, ${currentUser.nickname}!`, 'success');
            return true;
        }

        // Nuovo utente - mostra modal per scegliere nickname
        console.log('🆕 Nuovo utente Google, richiesta nickname');
        pendingGoogleRegistration = {
            email: email,
            googleName: name
        };

        // Popola il modal
        document.getElementById('newUserGoogleEmail').value = email;
        document.getElementById('newUserNickname').value = '';
        document.getElementById('newUserFullName').value = name || '';
        document.getElementById('acceptTermsCheckbox').checked = false;
        document.getElementById('completeRegistrationBtn').disabled = true;
        document.getElementById('nicknameError').style.display = 'none';

        // Mostra il modal
        openModal('chooseNicknameModal');
        return 'pending'; // Registrazione in attesa

    } catch (error) {
        console.error('❌ Errore durante verifica Google user:', error);
        showToast('Errore di connessione. Riprova.', 'error');
        return false;
    }
}

// Valida il nickname in tempo reale
function validateNickname(input) {
    const nickname = input.value.trim();
    const errorEl = document.getElementById('nicknameError');
    const submitBtn = document.getElementById('completeRegistrationBtn');
    const termsChecked = document.getElementById('acceptTermsCheckbox').checked;

    // Regex: solo lettere, numeri, underscore, 3-30 caratteri
    const validPattern = /^[a-zA-Z0-9_]{3,30}$/;

    if (nickname.length < 3) {
        errorEl.textContent = 'Minimo 3 caratteri';
        errorEl.style.display = 'block';
        submitBtn.disabled = true;
        return false;
    }

    if (!validPattern.test(nickname)) {
        errorEl.textContent = 'Solo lettere, numeri e underscore permessi';
        errorEl.style.display = 'block';
        submitBtn.disabled = true;
        return false;
    }

    errorEl.style.display = 'none';
    submitBtn.disabled = !termsChecked;
    return true;
}

// Listener per il checkbox termini
document.addEventListener('DOMContentLoaded', () => {
    const checkbox = document.getElementById('acceptTermsCheckbox');
    if (checkbox) {
        checkbox.addEventListener('change', function() {
            const nicknameInput = document.getElementById('newUserNickname');
            if (nicknameInput && validateNickname(nicknameInput)) {
                document.getElementById('completeRegistrationBtn').disabled = !this.checked;
            }
        });
    }
});

// Annulla la registrazione Google
function cancelGoogleRegistration() {
    pendingGoogleRegistration = null;
    closeModal('chooseNicknameModal');
    signOutFromGoogle();
    showLoginScreen();
    showToast('Registrazione annullata', 'info');
}

// Completa la registrazione Google con il nickname scelto
async function completeGoogleRegistration() {
    if (!pendingGoogleRegistration) {
        showToast('Errore: nessuna registrazione in corso', 'error');
        return;
    }

    const nickname = document.getElementById('newUserNickname').value.trim();
    const fullName = document.getElementById('newUserFullName').value.trim();
    const termsAccepted = document.getElementById('acceptTermsCheckbox').checked;

    if (!validateNickname(document.getElementById('newUserNickname'))) {
        return;
    }

    if (!termsAccepted) {
        showToast('Devi accettare i termini per continuare', 'error');
        return;
    }

    // Disabilita il pulsante durante la registrazione
    const btn = document.getElementById('completeRegistrationBtn');
    btn.disabled = true;
    btn.innerHTML = '⏳ Registrazione...';

    try {
        // Genera password casuale (l'utente usa Google)
        const randomPassword = 'google_' + Math.random().toString(36).substring(2, 15) + Date.now().toString(36);

        // Registra su Google Sheets con nickname e richiedi email benvenuto
        const response = await apiCall('registerGoogleUser', {
            username: nickname.toLowerCase(),
            nickname: nickname,
            email: pendingGoogleRegistration.email,
            fullName: fullName,
            password: randomPassword,
            sendWelcomeEmail: true
        });

        if (response.success) {
            console.log('✅ Utente Google registrato con nickname:', nickname);

            currentUser = {
                username: response.username || nickname.toLowerCase(),
                nickname: nickname,
                token: response.token,
                email: pendingGoogleRegistration.email,
                name: fullName || pendingGoogleRegistration.googleName,
                loginMethod: 'google'
            };
            localStorage.setItem('savers_current_user', JSON.stringify(currentUser));

            // Chiudi modal e mostra app
            closeModal('chooseNicknameModal');
            pendingGoogleRegistration = null;

            isLoggedIn = true;
            updateLoginUI();
            showApp();

            // Sincronizza stato iniziale
            await syncToCloud();

            // AUTO-CONNESSIONE GOOGLE CALENDAR (stesso account)
            try {
                await loadUserCalendars();
                await loadCalendarEvents();
                loadGoogleTaskLists();
                console.log('📅 Google Calendar auto-connesso per nuovo utente');
            } catch (calError) {
                console.warn('⚠️ Errore auto-connessione Calendar:', calError);
            }

            showToast(`🎉 Benvenuto ${nickname}! Controlla la tua email.`, 'success');
        } else if (response.message?.includes('esiste') || response.message?.includes('exists')) {
            document.getElementById('nicknameError').textContent = 'Questo nickname è già in uso. Scegline un altro.';
            document.getElementById('nicknameError').style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '🚀 Inizia!';
        } else {
            showToast(response.message || 'Errore durante la registrazione', 'error');
            btn.disabled = false;
            btn.innerHTML = '🚀 Inizia!';
        }
    } catch (error) {
        console.error('❌ Errore registrazione:', error);
        showToast('Errore di connessione. Riprova.', 'error');
        btn.disabled = false;
        btn.innerHTML = '🚀 Inizia!';
    }
}

// Conferma logout con dialog
function confirmLogout() {
    const userName = currentUser?.nickname || currentUser?.name || currentUser?.username || 'utente';
    if (confirm(`Vuoi uscire dall'account di ${userName}?`)) {
        logout();
    }
}

function logout() {
    // Se l'utente ha fatto login con Google, disconnetti anche Google
    if (currentUser?.loginMethod === 'google' && isGoogleSignedIn) {
        signOutFromGoogle();
    }

    currentUser = null;
    isLoggedIn = false;

    // Pulisci tutti i dati salvati
    localStorage.removeItem('savers_current_user');
    localStorage.removeItem('savers_google_profile');
    localStorage.removeItem('google_access_token');
    localStorage.removeItem('google_token_expiry');

    // Reset state profile
    state.profile = {};

    updateLoginUI();

    // Torna alla schermata di login
    showLoginScreen();

    showToast('Disconnesso. Accedi per continuare.', 'info');
}

function checkSavedLogin() {
    const saved = localStorage.getItem('savers_current_user');
    if (saved) {
        currentUser = JSON.parse(saved);

        // OBBLIGATORIO: Solo login Google è permesso
        if (currentUser?.loginMethod !== 'google') {
            // Utente non-Google (legacy) - forza nuovo login con Google
            console.log('⚠️ Utente legacy rilevato, richiesto login Google');
            currentUser = null;
            isLoggedIn = false;
            localStorage.removeItem('savers_current_user');
            showLoginScreen();
            showToast('Per continuare, accedi con Google', 'warning');
            return;
        }

        // Verifica che il token Google sia ancora valido
        const token = localStorage.getItem('google_access_token');
        const expiry = localStorage.getItem('google_token_expiry');
        const now = Date.now();
        const expiryTime = expiry ? parseInt(expiry) : 0;

        // Token valido (con margine di 5 minuti)
        if (token && expiryTime > 0 && now < expiryTime - 300000) {
            console.log('✅ Token Google valido, ripristino sessione...');
            isLoggedIn = true;

            // IMPORTANTE: Ripristina state.cloudUser e state.profile SUBITO
            if (!state.cloudUser) state.cloudUser = {};
            state.cloudUser.token = currentUser.token;
            state.cloudUser.email = currentUser.email;
            state.cloudUser.username = currentUser.username;
            state.cloudUser.nickname = currentUser.nickname;

            // Ripristina profilo dal localStorage
            const savedProfile = localStorage.getItem('savers_google_profile');
            if (savedProfile) {
                try {
                    const profileData = JSON.parse(savedProfile);
                    state.profile = state.profile || {};
                    state.profile.name = profileData.name || currentUser.nickname || currentUser.username;
                    state.profile.email = profileData.email || currentUser.email;
                    state.profile.picture = profileData.picture;
                    state.profile.googleId = profileData.googleId;
                    state.profile.googleConnected = true;
                    console.log('📧 Profilo ripristinato:', state.profile.email, state.profile.name);
                } catch (e) {
                    console.warn('Errore parsing profilo:', e);
                }
            } else {
                // Fallback con dati da currentUser
                state.profile = state.profile || {};
                state.profile.name = currentUser.nickname || currentUser.username || currentUser.name || 'Utente';
                state.profile.email = currentUser.email || '';
                state.profile.googleConnected = true;
            }

            // Aggiorna UI SUBITO con i dati salvati
            updateLoginUI();
            updateProfileUI();
            updateHeaderAvatar();
            showApp();

            // Poi carica dati freschi dal cloud in background
            setTimeout(async () => {
                await loadFromCloud();
                await loadSharedProjects();
                // Aggiorna UI dopo caricamento cloud
                updateProfileUI();
                updateHeaderAvatar();
            }, 500);
        }
        // Token scaduto ma utente salvato - tenta rinnovo silenzioso
        else if (currentUser?.email) {
            console.log('⏳ Token Google scaduto, tentativo rinnovo silenzioso...');

            // Mostra schermata di caricamento invece del login
            showLoginScreen();
            const loginBtn = document.getElementById('googleLoginMainBtn');
            if (loginBtn) {
                loginBtn.textContent = '⏳ Riconnessione...';
                loginBtn.disabled = true;
            }

            // Attendi che GAPI sia pronto, poi tenta rinnovo
            waitForGapiAndRefreshToken();
        } else {
            // Nessun dato utente valido - mostra login
            console.log('⚠️ Nessun dato utente valido, richiesto login');
            isLoggedIn = false;
            showLoginScreen();
        }
    } else {
        // Nessun utente salvato - mostra login
        showLoginScreen();
    }
}

// Attende che GAPI sia pronto e tenta il refresh del token
async function waitForGapiAndRefreshToken() {
    const maxAttempts = 20; // 10 secondi max
    let attempts = 0;

    const checkInterval = setInterval(async () => {
        attempts++;

        if (gapiInited && gisInited && tokenClient) {
            clearInterval(checkInterval);
            console.log('✅ GAPI pronto, tento rinnovo token...');

            try {
                // Tenta login silenzioso (prompt: '' = no popup se possibile)
                // Se fallisce, proverà con popup
                tokenClient.requestAccessToken({
                    prompt: '',
                    hint: currentUser?.email || '' // Suggerisce l'email dell'utente salvato
                });
            } catch (e) {
                console.log('⚠️ Rinnovo silenzioso fallito, provo con popup:', e);
                try {
                    // Fallback: mostra popup di login
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } catch (e2) {
                    console.log('⚠️ Anche il popup ha fallito:', e2);
                    resetToLoginScreen();
                }
            }
        } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            console.log('⚠️ Timeout attesa GAPI, mostra login');
            resetToLoginScreen();
        }
    }, 500);
}

// Gestisce errori specifici di Google Auth
function handleGoogleAuthError(error) {
    console.error('Google Auth Error:', error);

    if (error.type === 'popup_closed_by_user') {
        showToast('Login annullato', 'warning');
    } else if (error.type === 'access_denied') {
        showToast('Accesso negato. Riprova.', 'error');
    } else {
        showToast('Errore di autenticazione', 'error');
    }

    resetToLoginScreen();
}

// Ripristina la schermata di login pulita
function resetToLoginScreen() {
    const loginBtn = document.getElementById('googleLoginMainBtn');
    if (loginBtn) {
        loginBtn.textContent = '🔐 Accedi con Google';
        loginBtn.disabled = false;
    }
    isLoggedIn = false;
    currentUser = null;

    // Pulisci tutti i dati di sessione
    localStorage.removeItem('savers_current_user');
    localStorage.removeItem('savers_google_profile');
    localStorage.removeItem('google_access_token');
    localStorage.removeItem('google_token_expiry');

    showLoginScreen();
    showToast('Sessione scaduta, accedi di nuovo', 'warning');
}

function updateLoginUI() {
    // IMPORTANTE: Sincronizza currentUser con state.cloudUser
    if (isLoggedIn && currentUser) {
        if (!state.cloudUser) state.cloudUser = {};
        state.cloudUser.token = currentUser.token;
        state.cloudUser.email = currentUser.email;
        state.cloudUser.username = currentUser.username;
        state.cloudUser.nickname = currentUser.nickname;
        console.log('🔄 state.cloudUser sincronizzato:', state.cloudUser.email);
    }

    const loginBtn = document.getElementById('cloudLoginBtn');
    const syncStatus = document.getElementById('syncStatus');
    const userNameEl = document.getElementById('cloudUserName');
    const cloudStatusLabel = document.getElementById('cloudStatusLabel');
    const cloudStatusDesc = document.getElementById('cloudStatusDesc');
    const cloudSyncRow = document.getElementById('cloudSyncRow');
    const lastSyncText = document.getElementById('lastSyncText');

    if (loginBtn) {
        if (isLoggedIn) {
            loginBtn.textContent = 'Disconnetti';
            loginBtn.classList.remove('btn-primary');
            loginBtn.classList.add('btn-secondary');
        } else {
            loginBtn.textContent = 'Accedi';
            loginBtn.classList.remove('btn-secondary');
            loginBtn.classList.add('btn-primary');
        }
    }

    if (userNameEl) {
        userNameEl.textContent = isLoggedIn ? (currentUser.nickname || currentUser.username) : 'Non connesso';
    }

    if (syncStatus) {
        syncStatus.style.display = isLoggedIn ? 'flex' : 'none';
    }

    // Update settings page cloud section
    if (cloudStatusLabel) {
        cloudStatusLabel.textContent = isLoggedIn ? `Connesso come ${currentUser?.nickname || currentUser?.username}` : 'Non connesso';
    }
    if (cloudStatusDesc) {
        cloudStatusDesc.textContent = isLoggedIn ? 'I tuoi dati vengono sincronizzati automaticamente' : 'Sincronizza i tuoi dati su Google Sheets';
    }
    if (cloudSyncRow) {
        cloudSyncRow.style.display = isLoggedIn ? 'flex' : 'none';
    }
    if (lastSyncText && lastSyncTime) {
        lastSyncText.textContent = lastSyncTime.toLocaleTimeString('it-IT');
    }
}

// ============================================
// CLOUD SYNC FUNCTIONS
// ============================================

async function syncToCloud() {
    if (!isLoggedIn || !currentUser || syncInProgress) return;

    // Non sincronizzare prima che il caricamento iniziale sia completo
    if (!initialLoadComplete) {
        console.warn('⚠️ Sync bloccato: caricamento iniziale non completato');
        return;
    }

    // Niente da sincronizzare
    if (changeTracker.dirtyCollections.size === 0 && !needsFullSync()) {
        console.log('✅ Nessuna modifica da sincronizzare');
        return;
    }

    syncInProgress = true;
    updateSyncIndicator('syncing');

    try {
        let response;

        // Decidi se fare full sync o incremental
        if (needsFullSync() || changeTracker.changeCount > changeTracker.immediatesSyncThreshold) {
            // FULL SYNC: ogni 24 ore o se troppe modifiche accumulate
            console.log('🔄 Esecuzione FULL SYNC...');
            response = await apiCall('syncFullState', {
                state: state
            });

            if (response.success) {
                changeTracker.lastFullSync = Date.now();
            }
        } else if (changeTracker.dirtyCollections.size > 0) {
            // INCREMENTAL SYNC: solo le modifiche
            const incrementalData = prepareIncrementalSyncData();
            console.log('⚡ Esecuzione INCREMENTAL SYNC:', Array.from(changeTracker.dirtyCollections));

            response = await apiCall('syncIncrementalState', incrementalData);

            // Fallback a full sync se incremental non supportato
            if (response.error === 'INCREMENTAL_NOT_SUPPORTED') {
                console.log('⚠️ Incremental sync non supportato, fallback a full sync');
                response = await apiCall('syncFullState', { state: state });
                changeTracker.lastFullSync = Date.now();
            }
        }

        if (response?.success) {
            lastSyncTime = new Date();
            updateSyncIndicator('synced');
            clearChangeTracker(); // Pulisci il tracker dopo sync riuscita
            console.log('☁️ Cloud sync completato:', response.timestamp || new Date().toISOString());
        } else {
            console.error('Sync failed:', response?.message);
            updateSyncIndicator('error');
        }
    } catch (error) {
        console.error('Sync error:', error);
        updateSyncIndicator('error');
        showToast('Errore sincronizzazione cloud', 'error');
    }

    syncInProgress = false;
}

async function loadFromCloud() {
    if (!isLoggedIn || !currentUser) return;

    updateSyncIndicator('syncing');

    try {
        const response = await apiCall('loadFullState');

        if (response.success && response.state) {
            const cloudState = response.state;

            // IMPORTANTE: Salva TUTTI i dati profilo PRIMA del merge (potrebbero essere sovrascritti)
            const savedLocalProfile = {
                googleId: state.profile?.googleId,
                name: state.profile?.name,
                email: state.profile?.email,
                picture: state.profile?.picture,
                googleConnected: state.profile?.googleConnected,
                // IMPORTANTE: Preserva anche i dati personalizzati dall'utente
                profession: state.profile?.profession,
                stageName: state.profile?.stageName,
                avatar: state.profile?.avatar,
                updatedAt: state.profile?.updatedAt
            };

            // Carica i dati dal cloud (sovrascrive i default)
            state = deepMerge(state, cloudState);

            // RIPRISTINA i dati profilo se sono stati sovrascritti con valori vuoti
            // Strategia: usa i dati più recenti (confronta updatedAt)
            state.profile = state.profile || {};

            const cloudUpdatedAt = state.profile.updatedAt ? new Date(state.profile.updatedAt).getTime() : 0;
            const localUpdatedAt = savedLocalProfile.updatedAt ? new Date(savedLocalProfile.updatedAt).getTime() : 0;

            // Se i dati locali sono più recenti, usa quelli
            if (localUpdatedAt > cloudUpdatedAt) {
                console.log('🔄 Dati profilo locali più recenti, preservo i dati locali');
                // Preserva i dati personalizzati dall'utente
                if (savedLocalProfile.profession) {
                    state.profile.profession = savedLocalProfile.profession;
                }
                if (savedLocalProfile.stageName) {
                    state.profile.stageName = savedLocalProfile.stageName;
                }
                if (savedLocalProfile.name && savedLocalProfile.name !== 'Utente') {
                    state.profile.name = savedLocalProfile.name;
                }
                if (savedLocalProfile.avatar) {
                    state.profile.avatar = savedLocalProfile.avatar;
                }
            }

            // Ripristina sempre i dati Google se presenti localmente ma non nel cloud
            if (!state.profile.googleId && savedLocalProfile.googleId) {
                state.profile.googleId = savedLocalProfile.googleId;
            }
            if (!state.profile.picture && savedLocalProfile.picture) {
                state.profile.picture = savedLocalProfile.picture;
            }
            if ((!state.profile.name || state.profile.name === 'Utente') && savedLocalProfile.name) {
                state.profile.name = savedLocalProfile.name;
            }
            if (!state.profile.email && savedLocalProfile.email) {
                state.profile.email = savedLocalProfile.email;
            }
            if (savedLocalProfile.googleConnected) {
                state.profile.googleConnected = true;
            }

            // Preserva profession e stageName se non presenti nel cloud ma presenti localmente
            if (!state.profile.profession && savedLocalProfile.profession) {
                state.profile.profession = savedLocalProfile.profession;
            }
            if (!state.profile.stageName && savedLocalProfile.stageName) {
                state.profile.stageName = savedLocalProfile.stageName;
            }

            // Se ancora mancano profession/stageName, prova a caricare dal backup localStorage
            if (!state.profile.profession || !state.profile.stageName) {
                try {
                    const backupProfile = JSON.parse(localStorage.getItem('savers_profile_backup') || '{}');
                    if (backupProfile.profession && !state.profile.profession) {
                        state.profile.profession = backupProfile.profession;
                        console.log('📂 Profession recuperata da backup localStorage');
                    }
                    if (backupProfile.stageName && !state.profile.stageName) {
                        state.profile.stageName = backupProfile.stageName;
                        console.log('📂 StageName recuperato da backup localStorage');
                    }
                } catch (e) {
                    console.warn('Impossibile leggere backup profilo:', e);
                }
            }

            console.log('🔄 Dati profilo preservati dopo merge:', {
                name: state.profile.name,
                email: state.profile.email,
                profession: state.profile.profession,
                stageName: state.profile.stageName
            });

            // Assicura che gli array critici siano inizializzati
            if (!Array.isArray(state.tasks)) {
                state.tasks = [];
            }
            if (!Array.isArray(state.teamProjects)) {
                state.teamProjects = [];
            }
            if (!Array.isArray(state.sharedProjects)) {
                state.sharedProjects = [];
            }
            if (!Array.isArray(state.archivedProjects)) {
                state.archivedProjects = [];
            }
            if (!Array.isArray(state.projectTemplates)) {
                state.projectTemplates = [];
            }
            if (!Array.isArray(state.teams)) {
                state.teams = [];
            }

            console.log('📦 teamProjects caricati:', state.teamProjects?.length || 0);

            // Segna il caricamento come completato
            initialLoadComplete = true;
            console.log('✅ Caricamento iniziale completato, sync abilitato');

            // Check nuovo giorno
            const today = new Date().toISOString().split('T')[0];
            if (state.today && state.today.date !== today) {
                console.log('📅 Nuovo giorno rilevato, reset dati giornalieri');
                archiveDayData();
                state.today = {
                    date: today,
                    routineCompleted: [false, false, false, false, false, false],
                    mood: null,
                    moodNote: '',
                    sleep: null,
                    sleepQuality: null,
                    water: 0,
                    pomodoros: 0
                };
                state.stats.totalDays++;
            }

            window.state = state;
            renderAll();

            // IMPORTANTE: Aggiorna UI del profilo dopo il caricamento cloud
            updateProfileUI();
            updateHeaderAvatar();

            lastSyncTime = new Date();
            updateSyncIndicator('synced');
            console.log('✅ Dati caricati dal cloud. Tasks:', state.tasks?.length || 0);
            showToast('Dati caricati dal cloud ☁️', 'success');
        } else {
            // Nessun dato nel cloud - primo utilizzo
            initialLoadComplete = true; // Anche per primo utilizzo
            updateSyncIndicator('synced');
            console.log('📭 Nessun dato nel cloud, primo utilizzo');
        }

        // Carica anche i team dal backend
        await loadUserTeams();

        // Carica notifiche dal backend (inviti eventi, ecc.)
        await loadUserNotifications();
    } catch (error) {
        console.error('Load from cloud error:', error);
        updateSyncIndicator('error');
        showToast('Errore caricamento dati cloud', 'error');
    }
}

function updateSyncIndicator(status) {
    const indicator = document.getElementById('syncIndicator');
    const text = document.getElementById('syncText');
    const lastSyncTextEl = document.getElementById('lastSyncText');

    // Aggiungi/rimuovi classe body per indicare sync in corso (senza bloccare click)
    if (status === 'syncing') {
        document.body.classList.add('is-syncing');
    } else {
        document.body.classList.remove('is-syncing');
    }

    switch (status) {
        case 'syncing':
            if (indicator) indicator.className = 'sync-indicator syncing';
            if (text) text.textContent = 'Sincronizzazione...';
            break;
        case 'synced':
            if (indicator) indicator.className = 'sync-indicator synced';
            const time = lastSyncTime ? lastSyncTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'ora';
            if (text) text.textContent = `Sincronizzato alle ${time}`;
            // Aggiorna anche nella pagina Settings
            if (lastSyncTextEl && lastSyncTime) {
                lastSyncTextEl.textContent = lastSyncTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            }
            break;
        case 'error':
            if (indicator) indicator.className = 'sync-indicator error';
            if (text) text.textContent = 'Errore sincronizzazione';
            if (lastSyncTextEl) lastSyncTextEl.textContent = 'Errore';
            // Auto-retry dopo 30 secondi in caso di errore
            setTimeout(() => {
                if (isLoggedIn && !syncInProgress) {
                    console.log('🔄 Tentativo automatico di risincronizzazione...');
                    syncToCloud();
                }
            }, 30000);
            break;
    }
}

// Forza sincronizzazione manuale
async function forceSync() {
    if (!isLoggedIn) {
        showToast('Accedi per sincronizzare', 'warning');
        openModal('cloudLoginModal');
        return;
    }

    try {
        await syncToCloud();
        // Il toast di successo viene mostrato solo se non c'è stato errore
        const indicator = document.getElementById('syncIndicator');
        if (indicator && !indicator.classList.contains('error')) {
            showToast('Sincronizzazione completata! ☁️', 'success');
        }
    } catch (error) {
        console.error('ForceSync error:', error);
        // L'errore è già gestito in syncToCloud
    }
}

// ============================================
// LOGIN MODAL FUNCTIONS
// ============================================

let currentLoginTab = 'login';

// DEPRECATO: Login tradizionale rimosso - ora solo Google
function switchLoginTab(tab) {
    // Non più usato - redirect a Google login
    console.log('⚠️ Login tradizionale deprecato, usa Google');
    loginWithGoogle();
}

// DEPRECATO: Login tradizionale rimosso - ora solo Google
async function handleCloudLogin() {
    // Non più usato - redirect a Google login
    console.log('⚠️ Login tradizionale deprecato, usa Google');
    loginWithGoogle();
}

function openCloudLogin() {
    if (isLoggedIn) {
        // Mostra info account e opzione logout
        const userName = state.profile?.name || currentUser?.nickname || currentUser?.username || 'Utente';
        const userEmail = state.profile?.email || currentUser?.email || '';
        if (confirm(`Connesso come:\n${userName}\n${userEmail}\n\nVuoi disconnetterti?`)) {
            confirmLogout();
        }
    } else {
        // Non loggato - avvia login Google direttamente
        loginWithGoogle();
    }
}

// ============================================
// GOOGLE CALENDAR & TASKS API
// ============================================

let tokenClient = null;
let gapiInited = false;
let gisInited = false;

// Initialize Google API
function initGoogleAPI() {
    gapi.load('client', async () => {
        try {
            await gapi.client.init({
                discoveryDocs: CONFIG.GOOGLE_DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableGoogleButtons();
        } catch (error) {
            console.error('Error initializing GAPI:', error);
            showToast('Errore inizializzazione Google API', 'error');
        }
    });
}

// Initialize Google Identity Services
function initGoogleIdentity() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        scope: CONFIG.GOOGLE_SCOPES,
        callback: handleGoogleAuthResponse,
        error_callback: handleGoogleAuthError // Gestisce errori (popup chiuso, accesso negato, etc.)
    });
    gisInited = true;
    maybeEnableGoogleButtons();
}

async function maybeEnableGoogleButtons() {
    if (gapiInited && gisInited) {
        // Check if we have a saved token
        const savedToken = localStorage.getItem('google_access_token');
        const tokenExpiry = localStorage.getItem('google_token_expiry');

        if (savedToken) {
            // Verifica se il token è scaduto (con margine di 5 minuti)
            const now = Date.now();
            const expiryTime = tokenExpiry ? parseInt(tokenExpiry) : 0;

            if (expiryTime > 0 && now >= expiryTime - 300000) {
                // Token scaduto o in scadenza, richiedi nuovo login silenzioso
                console.log('Token Google scaduto, tentativo di rinnovo silenzioso...');
                localStorage.removeItem('google_access_token');
                localStorage.removeItem('google_token_expiry');

                // Tenta login silenzioso
                try {
                    tokenClient.requestAccessToken({ prompt: '' });
                } catch (e) {
                    console.log('Login silenzioso fallito, richiederà interazione utente');
                    // Mostra schermata di login
                    showLoginScreen();
                }
                return;
            }

            gapi.client.setToken({ access_token: savedToken });
            isGoogleSignedIn = true;
            isLoggedIn = true;
            updateGoogleUI();

            // Mostra l'app dopo riconnessione automatica
            showApp();

            // Carica calendari e poi eventi in sequenza
            try {
                await loadUserCalendars();
                await loadCalendarEvents();
                loadGoogleTaskLists(); // Questo può andare in parallelo
            } catch (error) {
                console.error('Errore caricamento Google Calendar:', error);
                // Se errore di autenticazione, invalida il token
                if (error.status === 401 || error.status === 403) {
                    localStorage.removeItem('google_access_token');
                    localStorage.removeItem('google_token_expiry');
                    localStorage.removeItem('savers_current_user');
                    isGoogleSignedIn = false;
                    isLoggedIn = false;
                    currentUser = null;
                    updateGoogleUI();
                    showLoginScreen();
                    showToast('Sessione scaduta, accedi di nuovo', 'warning');
                }
            }
        }
    }
}

// Sign in with Google
function signInWithGoogle() {
    if (!tokenClient) {
        showToast('Google API non pronta, riprova', 'error');
        return;
    }

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        tokenClient.requestAccessToken({ prompt: '' });
    }
}

// Login con Google (dal modal Cloud Login)
function loginWithGoogle() {
    // Mostra stato di caricamento
    const loginScreen = document.getElementById('loginScreen');
    if (loginScreen) {
        loginScreen.classList.add('loading');
    }

    // Chiudi il modal di login (se aperto)
    closeModal('cloudLoginModal');

    // Avvia il flusso di autenticazione Google
    signInWithGoogle();
}

// Mostra l'app e nasconde la schermata di login
function showApp() {
    const loginScreen = document.getElementById('loginScreen');
    const app = document.getElementById('app');

    if (loginScreen) {
        loginScreen.classList.add('hidden');
        loginScreen.classList.remove('loading');
    }
    if (app) {
        app.style.display = 'block';
    }

    // Aggiorna widget statistiche API
    updateApiStatsWidget();

    // Gestione deep link da URL (es. ?action=openEvent&eventId=xxx)
    setTimeout(() => handleDeepLink(), 1000);
}

// Gestisce deep link da URL parameters (per link dalle email)
function handleDeepLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');

    if (!action) return;

    console.log('🔗 Deep link rilevato:', action);

    switch (action) {
        case 'openEvent':
            const eventId = urlParams.get('eventId');
            if (eventId) {
                console.log('🔗 Apertura evento da deep link:', eventId);
                // Cerca prima negli eventi Google, poi in quelli locali
                const googleEvent = state.calendarEvents?.find(e => e.id === eventId);
                const localEvent = state.events?.find(e => e.id === eventId);

                if (googleEvent) {
                    switchPage('home'); // Vai alla home con il calendario
                    setTimeout(() => openEventDetail(eventId, true), 500);
                } else if (localEvent) {
                    switchPage('home');
                    setTimeout(() => openEventDetail(eventId, false), 500);
                } else {
                    showToast('Evento non trovato', 'warning');
                }
            }
            break;

        case 'openTask':
            const taskId = urlParams.get('taskId');
            const projectId = urlParams.get('projectId');
            if (taskId && projectId) {
                console.log('🔗 Apertura task da deep link:', taskId, 'progetto:', projectId);
                // Imposta il progetto corrente e vai alla pagina team
                currentProjectId = projectId;
                switchPage('team');
                setTimeout(() => {
                    // TODO: aprire il modal del task specifico
                    showToast('Naviga ai commenti del task', 'info');
                }, 500);
            }
            break;

        case 'openNotifications':
            console.log('🔗 Apertura notifiche da deep link');
            openInbox();
            break;
    }

    // Pulisci URL dopo aver gestito il deep link
    if (window.history.replaceState) {
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// Mostra la schermata di login e nasconde l'app
function showLoginScreen() {
    const loginScreen = document.getElementById('loginScreen');
    const app = document.getElementById('app');

    if (loginScreen) {
        loginScreen.classList.remove('hidden');
        loginScreen.classList.remove('loading');
    }
    if (app) {
        app.style.display = 'none';
    }
}

// Handle auth response
async function handleGoogleAuthResponse(response) {
    if (response.error !== undefined) {
        console.error('Google auth error:', response);
        // Se è un errore durante il refresh silenzioso, mostra login
        if (currentUser?.email) {
            resetToLoginScreen();
        } else {
            showToast('Errore autenticazione Google', 'error');
        }
        return;
    }

    // Save token and expiry time
    localStorage.setItem('google_access_token', response.access_token);

    // Calcola scadenza: expires_in è in secondi (tipicamente 3600 = 1 ora)
    const expiresIn = response.expires_in || 3600;
    const expiryTime = Date.now() + (expiresIn * 1000);
    localStorage.setItem('google_token_expiry', expiryTime.toString());

    isGoogleSignedIn = true;

    // IMPORTANTE: Imposta il token nel client gapi
    gapi.client.setToken({ access_token: response.access_token });

    // Controlla se è un REFRESH di token (utente già salvato in localStorage)
    const savedUser = localStorage.getItem('savers_current_user');
    const isTokenRefresh = savedUser && JSON.parse(savedUser)?.email;

    if (isTokenRefresh) {
        // È un refresh del token - ripristina sessione esistente
        console.log('✅ Token rinnovato con successo, ripristino sessione...');

        currentUser = JSON.parse(savedUser);
        isLoggedIn = true;

        // Sincronizza con state
        if (!state.cloudUser) state.cloudUser = {};
        state.cloudUser.token = currentUser.token;
        state.cloudUser.email = currentUser.email;
        state.cloudUser.username = currentUser.username;
        state.cloudUser.nickname = currentUser.nickname;

        // IMPORTANTE: Ripristina anche state.profile dal localStorage
        const savedProfile = localStorage.getItem('savers_google_profile');
        if (savedProfile) {
            try {
                const profileData = JSON.parse(savedProfile);
                state.profile = state.profile || {};
                state.profile.name = profileData.name || currentUser.nickname || currentUser.username;
                state.profile.email = profileData.email || currentUser.email;
                state.profile.picture = profileData.picture;
                state.profile.googleId = profileData.googleId;
                state.profile.googleConnected = true;
                console.log('📧 Profilo ripristinato da cache:', state.profile.email);
            } catch (e) {
                console.warn('Errore parsing profilo salvato:', e);
            }
        } else {
            // Fallback: usa i dati da currentUser
            state.profile = state.profile || {};
            state.profile.name = currentUser.nickname || currentUser.username || currentUser.name;
            state.profile.email = currentUser.email;
            state.profile.googleConnected = true;
        }

        // Ripristina il pulsante login
        const loginBtn = document.getElementById('googleLoginMainBtn');
        if (loginBtn) {
            loginBtn.textContent = '🔐 Accedi con Google';
            loginBtn.disabled = false;
        }

        // Aggiorna UI SUBITO con i dati salvati
        updateLoginUI();
        updateProfileUI();
        updateGoogleUI();
        showApp();

        // Poi carica dati freschi in background (incluso aggiornamento profilo)
        setTimeout(async () => {
            try {
                await loadGoogleProfile(response.access_token);
                updateProfileUI(); // Aggiorna UI con dati freschi
                updateHeaderAvatar();
                await loadFromCloud();
                await loadSharedProjects();
                await loadUserCalendars();
                await loadCalendarEvents();
                loadGoogleTaskLists();
            } catch (error) {
                console.error('Errore caricamento dati dopo refresh:', error);
            }
        }, 300);

        return;
    }

    // NUOVO LOGIN - procedi con registrazione normale
    // Carica info profilo Google
    await loadGoogleProfile(response.access_token);

    // Verifica/Registra l'utente su Google Sheets
    const googleEmail = state.profile?.email;
    const googleName = state.profile?.name;

    if (!googleEmail) {
        showToast('Impossibile ottenere email da Google', 'error');
        signOutFromGoogle();
        showLoginScreen();
        return;
    }

    console.log('🔄 Verifica utente Google su Sheets...');
    const registrationResult = await registerGoogleUser(googleEmail, googleName);

    if (registrationResult === 'pending') {
        // Nuovo utente - il modal per il nickname è già aperto
        // Non mostrare l'app ancora, aspetta che completi la registrazione
        console.log('⏳ In attesa scelta nickname...');
        return;
    }

    if (!registrationResult) {
        // Errore durante la registrazione
        showToast('Errore durante la registrazione. Riprova.', 'error');
        signOutFromGoogle();
        showLoginScreen();
        return;
    }

    // Utente già registrato - procedi con il caricamento dati
    updateGoogleUI();
    updateProfileUI();
    updateLoginUI();

    // Carica calendari PRIMA, poi eventi (in sequenza!)
    try {
        await loadUserCalendars();
        await loadCalendarEvents();
        loadGoogleTaskLists(); // Può andare in parallelo
    } catch (error) {
        console.error('Errore caricamento dati Google:', error);
        if (error.status === 401 || error.status === 403) {
            showToast('Errore autenticazione, riprova', 'error');
        }
    }
}

// Carica profilo utente da Google
async function loadGoogleProfile(accessToken) {
    try {
        const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });

        if (!response.ok) throw new Error('Errore caricamento profilo');

        const profile = await response.json();
        console.log('📧 Google Profile:', profile);

        // Salva i dati nel profilo locale
        state.profile = state.profile || {};
        state.profile.googleId = profile.id;
        state.profile.name = profile.name || state.profile.name || '';
        state.profile.email = profile.email || state.profile.email || '';
        state.profile.picture = profile.picture || null;
        state.profile.googleConnected = true;

        // Salva anche per il cloud sync
        if (!state.cloudUser) {
            state.cloudUser = {};
        }
        state.cloudUser.googleEmail = profile.email;
        state.cloudUser.googleName = profile.name;
        state.cloudUser.googlePicture = profile.picture;

        // IMPORTANTE: Salva profilo Google nel localStorage per il ripristino dopo refresh
        localStorage.setItem('savers_google_profile', JSON.stringify({
            googleId: profile.id,
            name: profile.name,
            email: profile.email,
            picture: profile.picture
        }));

        saveStateAndSync();

        // Aggiorna avatar in header
        updateHeaderAvatar();

    } catch (error) {
        console.error('Errore caricamento profilo Google:', error);
    }
}

// updateHeaderAvatar è definita nella sezione PROFILE MANAGEMENT

// Sign out from Google
function signOutFromGoogle() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        localStorage.removeItem('google_access_token');
        localStorage.removeItem('google_token_expiry');
    }
    isGoogleSignedIn = false;
    userCalendars = [];
    googleTaskLists = [];
    updateGoogleUI();
    showToast('Disconnesso da Google', 'info');
}

// Refresh manuale calendari e eventi Google
async function refreshGoogleCalendars() {
    if (!isGoogleSignedIn) {
        showToast('Non connesso a Google', 'warning');
        return;
    }

    // Verifica che il token sia ancora valido nel client gapi
    const token = gapi.client.getToken();
    if (!token) {
        console.warn('Token Google non presente nel client, tentativo di ripristino...');
        const savedToken = localStorage.getItem('google_access_token');
        if (savedToken) {
            gapi.client.setToken({ access_token: savedToken });
            console.log('Token ripristinato da localStorage');
        } else {
            showToast('Sessione scaduta, riconnetti Google', 'warning');
            isGoogleSignedIn = false;
            updateGoogleUI();
            return;
        }
    }

    showToast('Aggiornamento calendari...', 'info');

    try {
        await loadUserCalendars();
        await loadCalendarEvents();

        const eventsCount = (state.calendarEvents || []).length;
        const countEl = document.getElementById('calendarEventsCount');
        if (countEl) {
            countEl.textContent = `${userCalendars.length} calendari · ${eventsCount} eventi caricati`;
        }

        renderCalendar();
        showToast('Calendari aggiornati! ✓', 'success');
    } catch (error) {
        console.error('Errore refresh calendari:', error);
        console.error('Dettaglio errore:', error.result?.error || error.message || error);

        // Se è errore auth, l'utente è già stato avvisato
        if (error.status === 401 || error.status === 403) {
            // Già gestito internamente
        } else {
            const msg = error.result?.error?.message || error.message || 'riprova tra poco';
            showToast('Errore: ' + msg, 'error');
        }
    }
}

// Update UI based on Google auth state
function updateGoogleUI() {
    const notConnected = document.getElementById('googleNotConnected');
    const connected = document.getElementById('googleConnected');
    const actionBtn = document.getElementById('googleCalendarAction');

    // Aggiorna gli elementi principali (Home page)
    if (notConnected && connected) {
        if (isGoogleSignedIn) {
            notConnected.style.display = 'none';
            connected.style.display = 'block';
        } else {
            notConnected.style.display = 'flex';
            connected.style.display = 'none';
        }
    }

    // Aggiorna il pulsante azione se esiste (Settings page)
    if (actionBtn) {
        if (isGoogleSignedIn) {
            actionBtn.textContent = 'Disconnetti';
            actionBtn.onclick = signOutFromGoogle;
        } else {
            actionBtn.textContent = 'Connetti';
            actionBtn.onclick = signInWithGoogle;
        }
    }

    // Aggiorna il select del calendario default nelle impostazioni
    populateDefaultCalendarSelect();

    console.log('Google UI updated, isGoogleSignedIn:', isGoogleSignedIn);
}

function handleGoogleCalendarAction() {
    if (isGoogleSignedIn) {
        signOutFromGoogle();
    } else {
        signInWithGoogle();
    }
}

// Load user's calendars
async function loadUserCalendars() {
    const select = document.getElementById('calendarSelect');
    if (!select) return;

    try {
        // Mostra loading nel select
        select.innerHTML = '<option value="">Caricamento calendari...</option>';
        select.disabled = true;

        const response = await gapi.client.calendar.calendarList.list();
        userCalendars = response.result.items || [];

        select.innerHTML = '';
        select.disabled = false;

        if (userCalendars.length === 0) {
            select.innerHTML = '<option value="primary">Calendario principale</option>';
            selectedCalendarId = 'primary';
            return;
        }

        // Ordina: prima il preferito salvato, poi il primary, poi alfabetico
        const savedCalendar = localStorage.getItem('selected_calendar');
        userCalendars.sort((a, b) => {
            if (a.id === savedCalendar) return -1;
            if (b.id === savedCalendar) return 1;
            if (a.primary) return -1;
            if (b.primary) return 1;
            return (a.summary || '').localeCompare(b.summary || '');
        });

        userCalendars.forEach(cal => {
            const option = document.createElement('option');
            option.value = cal.id;
            option.textContent = cal.summary || cal.id;
            select.appendChild(option);
        });

        // Imposta il calendario salvato o il primo disponibile
        if (savedCalendar && userCalendars.some(c => c.id === savedCalendar)) {
            select.value = savedCalendar;
            selectedCalendarId = savedCalendar;
        } else {
            selectedCalendarId = userCalendars[0]?.id || 'primary';
            select.value = selectedCalendarId;
        }

        console.log('Calendari caricati:', userCalendars.length);

        // Aggiorna anche il select nelle impostazioni
        populateDefaultCalendarSelect();

    } catch (error) {
        console.error('Error loading calendars:', error);
        console.error('Dettaglio:', error.result?.error || error.message || error);

        if (select) {
            select.innerHTML = '<option value="primary">Calendario principale</option>';
            select.disabled = false;
        }
        selectedCalendarId = 'primary';

        // Se errore 401/403, token scaduto o permessi insufficienti
        if (error.status === 401 || error.status === 403) {
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            isGoogleSignedIn = false;
            updateGoogleUI();
            showToast('Sessione Google scaduta, riconnettiti', 'warning');
            throw error; // Rilancia per bloccare operazioni successive
        }
        // Per altri errori, non rilanciamo ma logghiamo
        // In modo che loadCalendarEvents possa comunque provare con 'primary'
    }
}

// Change selected calendar
function changeCalendar(calendarId) {
    selectedCalendarId = calendarId;
    localStorage.setItem('selected_calendar', calendarId);
    loadCalendarEvents();
}

// Salva il calendario di default dalle impostazioni
function saveDefaultCalendar(calendarId) {
    selectedCalendarId = calendarId;
    localStorage.setItem('selected_calendar', calendarId);
    showToast('Calendario predefinito salvato', 'success');
    // Aggiorna anche il select nel modal eventi se presente
    populateEventCalendarSelect();
    // Ricarica gli eventi con il nuovo calendario
    loadCalendarEvents();
}

// Popola il select del calendario default nelle impostazioni
function populateDefaultCalendarSelect() {
    const select = document.getElementById('defaultCalendarSelect');
    const row = document.getElementById('defaultCalendarRow');
    if (!select || !row) return;

    // Mostra la riga solo se connesso a Google
    if (!isGoogleSignedIn) {
        row.style.display = 'none';
        return;
    }

    // Mostra sempre la riga se connesso
    row.style.display = 'flex';

    // Se i calendari non sono ancora caricati, mostra "Caricamento..."
    if (userCalendars.length === 0) {
        select.innerHTML = '<option value="primary">Calendario principale</option>';
        // Prova a caricare i calendari se non ancora fatto
        if (typeof gapi !== 'undefined' && gapi.client && gapi.client.calendar) {
            loadUserCalendars();
        }
        return;
    }

    select.innerHTML = '';
    userCalendars.forEach(cal => {
        const option = document.createElement('option');
        option.value = cal.id;
        option.textContent = cal.summary || cal.id;
        if (cal.id === selectedCalendarId) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

// Load calendar events for the current week (for all views)
async function loadCalendarEvents(forceRange = null) {
    if (!isGoogleSignedIn) return;

    try {
        // Determina il range in base alla vista corrente o al range forzato
        let startOfRange, endOfRange;

        if (forceRange) {
            // Range specifico richiesto (es. quando si naviga a un mese diverso)
            startOfRange = forceRange.start;
            endOfRange = forceRange.end;
        } else if (calendarView === 'month') {
            // Vista mese: carica tutto il mese visualizzato + margini
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            startOfRange = new Date(year, month, 1);
            endOfRange = new Date(year, month + 1, 0, 23, 59, 59); // Ultimo giorno del mese
        } else if (calendarView === 'week' || calendarView === 'agenda') {
            // Vista settimana/agenda: carica 2 settimane
            startOfRange = new Date(calendarDate);
            startOfRange.setDate(startOfRange.getDate() - startOfRange.getDay());
            endOfRange = new Date(startOfRange);
            endOfRange.setDate(endOfRange.getDate() + 14);
        } else {
            // Vista giorno o default: carica 2 settimane dalla data corrente
            const now = new Date();
            startOfRange = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            endOfRange = new Date(startOfRange);
            endOfRange.setDate(endOfRange.getDate() + 14);
        }

        console.log(`📅 Caricamento eventi: ${startOfRange.toLocaleDateString()} - ${endOfRange.toLocaleDateString()}`);

        const response = await gapi.client.calendar.events.list({
            calendarId: selectedCalendarId,
            timeMin: startOfRange.toISOString(),
            timeMax: endOfRange.toISOString(),
            singleEvents: true,
            orderBy: 'startTime',
            maxResults: 250 // Aumentato per mesi con molti eventi
        });

        const events = response.result.items || [];

        // Store in state for calendar views
        state.calendarEvents = events;
        saveStateAndSync();

        // Aggiorna la vista calendario corrente
        if (typeof renderDayView === 'function') renderDayView();
        if (typeof renderWeekView === 'function') renderWeekView();
        if (typeof renderMonthView === 'function') renderMonthView();

        // Aggiorna badge inbox per inviti in attesa
        if (typeof updateInboxBadge === 'function') updateInboxBadge();

        // Aggiorna sezione inviti in attesa nel calendario
        if (typeof renderPendingInvites === 'function') renderPendingInvites();

        console.log('Google Calendar: caricati', events.length, 'eventi');

        // Conta inviti in attesa
        let pendingInvites = 0;
        events.forEach(event => {
            if (event.attendees) {
                const myAttendee = event.attendees.find(a => a.self || a.email === state.profile?.email);
                if (myAttendee && myAttendee.responseStatus === 'needsAction') {
                    pendingInvites++;
                }
            }
        });
        if (pendingInvites > 0) {
            console.log(`📬 Hai ${pendingInvites} invito/i in attesa di risposta`);
        }

    } catch (error) {
        console.error('Error loading events:', error);

        // Mostra errore specifico
        const errorMsg = error.result?.error?.message || error.message || 'Errore sconosciuto';
        console.error('Dettaglio errore:', errorMsg);

        // Token might be expired o permessi insufficienti
        if (error.status === 401 || error.status === 403) {
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            isGoogleSignedIn = false;
            updateGoogleUI();
            showToast('Sessione scaduta, riconnetti Google', 'warning');
        } else {
            showToast('Errore caricamento eventi', 'error');
        }
    }
}

// Load Google Task Lists
async function loadGoogleTaskLists() {
    if (!isGoogleSignedIn) return;

    try {
        const response = await gapi.client.tasks.tasklists.list();
        googleTaskLists = response.result.items || [];

        // Save in state
        state.googleTaskLists = googleTaskLists;
        saveStateAndSync();

    } catch (error) {
        console.error('Error loading task lists:', error);
    }
}

// Sync task to Google Tasks
async function syncTaskToGoogle(task) {
    if (!isGoogleSignedIn || googleTaskLists.length === 0) return;

    try {
        const taskListId = googleTaskLists[0].id; // Use first task list

        const googleTask = {
            title: task.title,
            notes: task.desc || '',
            due: task.due ? new Date(task.due).toISOString() : null,
            status: task.completed ? 'completed' : 'needsAction'
        };

        if (task.googleTaskId) {
            // Update existing
            await gapi.client.tasks.tasks.update({
                tasklist: taskListId,
                task: task.googleTaskId,
                resource: googleTask
            });
        } else {
            // Create new
            const response = await gapi.client.tasks.tasks.insert({
                tasklist: taskListId,
                resource: googleTask
            });
            // Save Google Task ID
            task.googleTaskId = response.result.id;
            saveStateAndSync();
        }
    } catch (error) {
        console.error('Error syncing task to Google:', error);
    }
}

// Create event in Google Calendar
async function createCalendarEvent(title, startTime, endTime, description = '') {
    if (!isGoogleSignedIn) {
        showToast('Connetti Google Calendar prima', 'warning');
        return null;
    }

    try {
        const event = {
            summary: title,
            description: description,
            start: {
                dateTime: startTime.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            end: {
                dateTime: endTime.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }
        };

        const response = await gapi.client.calendar.events.insert({
            calendarId: selectedCalendarId,
            resource: event
        });

        showToast('Evento creato nel calendario! 📅', 'success');
        loadCalendarEvents();
        return response.result;

    } catch (error) {
        console.error('Error creating event:', error);
        showToast('Errore creazione evento', 'error');
        return null;
    }
}

// ============================================
// SMART SCHEDULER (tipo Reclaim.ai)
// ============================================

// Default working hours
const defaultWorkingHours = {
    0: null, // Sunday - off
    1: { start: '09:00', end: '18:00' }, // Monday
    2: { start: '09:00', end: '18:00' },
    3: { start: '09:00', end: '18:00' },
    4: { start: '09:00', end: '18:00' },
    5: { start: '09:00', end: '18:00' },
    6: null // Saturday - off
};

// Energy preferences (when to do hard tasks)
const energyPreferences = {
    morning: { start: '09:00', end: '12:00', label: 'Mattina (9-12)', forHardTasks: true },
    afternoon: { start: '14:00', end: '17:00', label: 'Pomeriggio (14-17)', forHardTasks: false },
    evening: { start: '17:00', end: '19:00', label: 'Sera (17-19)', forHardTasks: false }
};

// Buffer time tra appuntamenti (configurabile, default 10 minuti)
const DEFAULT_BUFFER_TIME = 10; // minuti

function getBufferTime() {
    return state.schedulerConfig?.bufferTime ?? DEFAULT_BUFFER_TIME;
}

// Find free slots in calendar (con Buffer Time stile Reclaim.ai)
async function findFreeSlots(date, durationMinutes = 30) {
    if (!isGoogleSignedIn) return [];

    const bufferTime = getBufferTime();
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);

    try {
        // Get busy times
        const response = await gapi.client.calendar.freebusy.query({
            resource: {
                timeMin: startOfDay.toISOString(),
                timeMax: endOfDay.toISOString(),
                items: [{ id: selectedCalendarId }]
            }
        });

        const busySlots = response.result.calendars[selectedCalendarId]?.busy || [];

        // Get working hours for this day
        const dayOfWeek = date.getDay();
        const workingHours = state.schedulerConfig?.workingHours?.[dayOfWeek] || defaultWorkingHours[dayOfWeek];

        if (!workingHours) return []; // Day off

        // Find free slots within working hours
        const freeSlots = [];
        let currentTime = new Date(date);
        const [startHour, startMin] = workingHours.start.split(':').map(Number);
        const [endHour, endMin] = workingHours.end.split(':').map(Number);

        currentTime.setHours(startHour, startMin, 0, 0);
        const workEnd = new Date(date);
        workEnd.setHours(endHour, endMin, 0, 0);

        // IMPORTANTE: Se è oggi, inizia dall'ora attuale (non dal passato!)
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        if (isToday) {
            // Arrotonda ai prossimi 15 minuti
            const roundedNow = new Date(now);
            roundedNow.setMinutes(Math.ceil(now.getMinutes() / 15) * 15, 0, 0);

            // Se l'orario arrotondato è dopo l'inizio delle ore lavorative, usalo
            if (roundedNow > currentTime) {
                currentTime = roundedNow;
            }

            // Se l'orario corrente è già oltre la fine delle ore lavorative, nessuno slot
            if (currentTime >= workEnd) {
                console.log('⏰ Ore lavorative già terminate per oggi');
                return [];
            }
        }

        // Sort busy slots
        busySlots.sort((a, b) => new Date(a.start) - new Date(b.start));

        for (const busy of busySlots) {
            const busyStart = new Date(busy.start);
            // Aggiungi buffer DOPO l'evento precedente
            const busyEndWithBuffer = new Date(new Date(busy.end).getTime() + bufferTime * 60000);

            // Sottrai buffer PRIMA dell'evento successivo
            const effectiveBusyStart = new Date(busyStart.getTime() - bufferTime * 60000);

            if (effectiveBusyStart > currentTime) {
                // There's a free slot before this busy period (accounting for buffer)
                const slotDuration = (effectiveBusyStart - currentTime) / 60000; // minutes
                if (slotDuration >= durationMinutes) {
                    freeSlots.push({
                        start: new Date(currentTime),
                        end: effectiveBusyStart,
                        duration: slotDuration,
                        hasBufferBefore: busySlots.indexOf(busy) > 0 // C'è un evento prima
                    });
                }
            }
            currentTime = new Date(Math.max(currentTime, busyEndWithBuffer));
        }

        // Check for free slot after last busy period
        if (currentTime < workEnd) {
            const slotDuration = (workEnd - currentTime) / 60000;
            if (slotDuration >= durationMinutes) {
                freeSlots.push({
                    start: new Date(currentTime),
                    end: workEnd,
                    duration: slotDuration
                });
            }
        }

        return freeSlots;

    } catch (error) {
        console.error('Error finding free slots:', error);
        return [];
    }
}

// Auto-schedule tasks
async function autoScheduleTasks() {
    if (!isGoogleSignedIn) {
        showToast('Connetti Google Calendar prima', 'warning');
        return;
    }

    const unscheduledTasks = state.tasks.filter(t =>
        !t.completed &&
        !t.scheduledTime &&
        t.estimate
    );

    if (unscheduledTasks.length === 0) {
        showToast('Nessun task da pianificare', 'info');
        return;
    }

    showToast('Pianificazione in corso... 🤖', 'info');

    // Sort by priority and deadline
    unscheduledTasks.sort((a, b) => {
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
        }
        if (a.due && b.due) {
            return new Date(a.due) - new Date(b.due);
        }
        return a.due ? -1 : 1;
    });

    let scheduledCount = 0;
    const today = new Date();

    // Try to schedule for the next 7 days
    for (let dayOffset = 0; dayOffset < 7 && unscheduledTasks.length > 0; dayOffset++) {
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + dayOffset);

        const freeSlots = await findFreeSlots(targetDate);

        for (const slot of freeSlots) {
            // Find a task that fits this slot
            const taskIndex = unscheduledTasks.findIndex(t => t.estimate <= slot.duration);

            if (taskIndex >= 0) {
                const task = unscheduledTasks[taskIndex];

                // Check if hard task should go in morning
                const slotHour = slot.start.getHours();
                const isHardTask = task.priority === 'high' || task.quadrant === 1;
                const isMorning = slotHour >= 9 && slotHour < 12;

                // Prefer morning for hard tasks
                if (isHardTask && !isMorning && dayOffset === 0) {
                    continue; // Try to find a morning slot
                }

                // Schedule the task
                const endTime = new Date(slot.start);
                endTime.setMinutes(endTime.getMinutes() + task.estimate);

                const event = await createCalendarEvent(
                    `🎯 ${task.title}`,
                    slot.start,
                    endTime,
                    `Task pianificato automaticamente da Mago Max S.A.V.E.R.S.\n\nPriorità: ${task.priority}\nTempo stimato: ${task.estimate} min`
                );

                if (event) {
                    // Update task with scheduled info
                    const stateTask = state.tasks.find(t => t.id === task.id);
                    if (stateTask) {
                        stateTask.scheduledTime = slot.start.toISOString();
                        stateTask.calendarEventId = event.id;
                    }

                    unscheduledTasks.splice(taskIndex, 1);
                    scheduledCount++;

                    // Update slot
                    slot.start = endTime;
                    slot.duration -= task.estimate;
                }
            }
        }
    }

    saveStateAndSync();

    if (scheduledCount > 0) {
        showToast(`${scheduledCount} task pianificati! 🎉`, 'success');
        renderTasksPage();
    } else {
        showToast('Nessuno slot libero trovato', 'warning');
    }
}

// Initialize Google APIs on page load
function initGoogleOnLoad() {
    if (typeof gapi !== 'undefined') {
        initGoogleAPI();
    }
    if (typeof google !== 'undefined' && google.accounts) {
        initGoogleIdentity();
    }
}

// Retry loading Google APIs if not ready
function retryGoogleInit(attempts = 0) {
    if (attempts > 5) {
        console.warn('Google APIs non disponibili dopo 5 tentativi');
        return;
    }

    if (typeof gapi === 'undefined' || typeof google === 'undefined') {
        console.log('Attendo Google APIs... tentativo', attempts + 1);
        setTimeout(() => retryGoogleInit(attempts + 1), 1000);
        return;
    }

    initGoogleOnLoad();
}

// Call init when scripts are loaded
if (document.readyState === 'complete') {
    setTimeout(retryGoogleInit, 300);
} else {
    window.addEventListener('load', () => setTimeout(retryGoogleInit, 300));
}

function deepMerge(target, source) {
    const result = { ...target };
    for (const key in source) {
        if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            result[key] = deepMerge(target[key] || {}, source[key]);
        } else {
            result[key] = source[key];
        }
    }
    return result;
}

function archiveDayData() {
    // Could save historical data here if needed
}

function initializeApp() {
    // Update UI
    updateDateTime();
    updateGreeting();

    // Set default dates in forms (with null checks)
    const today = new Date().toISOString().split('T')[0];
    const expenseDate = document.getElementById('expenseDate');
    const incomeDate = document.getElementById('incomeDate');
    const scannedDate = document.getElementById('scannedDate');
    const taskDue = document.getElementById('taskDue');

    if (expenseDate) expenseDate.value = today;
    if (incomeDate) incomeDate.value = today;
    if (scannedDate) scannedDate.value = today;
    if (taskDue) taskDue.value = today;

    // Render all sections
    renderAll();

    // Update pomodoro display
    updatePomodoroDisplay();
    renderPomodoroSessions();

    // Initialize charts
    setTimeout(initCharts, 500);

    // Check for saved cloud login
    checkSavedLogin();

    // Load profile avatar and update profile UI
    updateHeaderAvatar();
    updateProfileUI();

    // Request notification permission
    requestNotificationPermission();

    // Update task priorities (dopo che loadState ha caricato i dati!)
    updateTaskPriorities();

    // Check and create recurring tasks
    checkRecurringTasks();

    // Schedule notifications
    if (state.settings?.notifications) {
        scheduleNotifications();
    }

    // Schedule daily digest and streak protection
    scheduleDailyDigest();
    setInterval(checkStreakProtection, 3600000); // Check ogni ora

    // Controlla periodicamente lo stato del token Google (ogni 5 minuti)
    setInterval(checkGoogleTokenExpiry, 300000);

    // Refresh automatico notifiche ogni 2 minuti (in background) con suono
    initNotificationSound();
    setInterval(autoRefreshNotifications, 120000); // 2 minuti

    // Controlla se c'è un codice invito team nell'URL
    checkUrlInviteCode();
}

// Controlla se il token Google sta per scadere e tenta rinnovo
function checkGoogleTokenExpiry() {
    if (!isGoogleSignedIn) return;

    const tokenExpiry = localStorage.getItem('google_token_expiry');
    if (!tokenExpiry) return;

    const now = Date.now();
    const expiryTime = parseInt(tokenExpiry);
    const timeUntilExpiry = expiryTime - now;

    // Se mancano meno di 10 minuti alla scadenza, tenta rinnovo silenzioso
    if (timeUntilExpiry < 600000 && timeUntilExpiry > 0) {
        console.log('Token Google in scadenza, tentativo di rinnovo...');
        try {
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        } catch (e) {
            console.warn('Rinnovo silenzioso fallito:', e);
        }
    } else if (timeUntilExpiry <= 0) {
        // Token già scaduto
        console.log('Token Google scaduto');
        localStorage.removeItem('google_access_token');
        localStorage.removeItem('google_token_expiry');
        isGoogleSignedIn = false;
        updateGoogleUI();
        showToast('Sessione Google scaduta. Riconnettiti per continuare.', 'warning');
    }
}

function renderAll() {
    // Renderizza in modo asincrono per non bloccare l'UI
    requestAnimationFrame(() => {
        renderHomePage();

        // Renderizza le altre pagine con un leggero ritardo per mantenere l'UI responsiva
        setTimeout(() => {
            renderTasksPage();
            renderFinancePage();
        }, 50);

        setTimeout(() => {
            renderRoutinePage();
            renderGoalsPage();
            renderNotesPage();
        }, 100);

        setTimeout(() => {
            renderAnalyticsPage();
            renderHabitsPage();
            updateAllStats();
        }, 150);

        // Ripristina la pagina salvata dopo il rendering
        setTimeout(() => {
            restoreLastPage();
        }, 200);
    });
}

// Ripristina l'ultima pagina visitata al refresh
function restoreLastPage() {
    const savedPage = sessionStorage.getItem('savers_currentPage');
    const savedProjectId = sessionStorage.getItem('savers_currentProjectId');

    console.log('🔄 Ripristino pagina:', savedPage, 'progetto:', savedProjectId);

    if (savedPage && savedPage !== 'home') {
        // Se era nella pagina team con un progetto, ripristina anche quello
        if (savedPage === 'team' && savedProjectId) {
            // Verifica che il progetto esista ancora
            const projectExists = state.teamProjects?.find(p => p.id === savedProjectId);
            if (projectExists) {
                currentProjectId = savedProjectId;
                console.log('  - Progetto ripristinato:', projectExists.name);
            }
        }

        switchPage(savedPage);
    }
}

// ============================================
// NAVIGATION
// ============================================

function switchPage(pageName) {
    // Salva la pagina corrente in state e sessionStorage (per ripristino al refresh)
    state.currentPage = pageName;
    sessionStorage.setItem('savers_currentPage', pageName);

    // Salva anche il progetto corrente se siamo nella pagina team
    if (pageName === 'team' && currentProjectId) {
        sessionStorage.setItem('savers_currentProjectId', currentProjectId);
    }

    // Hide all pages
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

    // Show selected
    const page = document.getElementById(pageName + 'Page');
    if (page) page.classList.add('active');

    // Update nav - new 5-item navigation: home, tasks, skills, team, more
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItems = document.querySelectorAll('.nav-item');
    const mainNavPages = ['home', 'tasks', 'skills', 'team'];
    const pageIndex = mainNavPages.indexOf(pageName);
    if (pageIndex >= 0 && navItems[pageIndex]) {
        navItems[pageIndex].classList.add('active');
    }

    // Refresh page content in next frame per non bloccare l'UI
    requestAnimationFrame(() => {
        switch(pageName) {
            case 'home':
                renderHomePage();
                break;
            case 'tasks':
                renderTasksPage();
                break;
            case 'skills':
                renderSkillsPage();
                break;
            case 'team':
                renderTeamPage();
                break;
            case 'analytics':
                setTimeout(initCharts, 100);
                break;
            case 'focus':
                initFocusPage();
                break;
            case 'habits':
                renderHabitsPage();
                break;
            case 'goals':
                renderGoalsPage();
                break;
            case 'notes':
                renderNotesPage();
                break;
            case 'time':
                renderTimePage();
                break;
            case 'finance':
                renderFinancePage();
                break;
        }
    });
}

// ============================================
// MODALS
// ============================================

function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // Blocca scroll del body quando modal è aperto (metodo semplice)
    document.body.style.overflow = 'hidden';

    modal.classList.add('active');

    const today = new Date().toISOString().split('T')[0];

    // Se stiamo aprendo il modal task, verifica se è nuovo o edit
    if (modalId === 'addTaskModal') {
        // Se editingTaskId è null, è un nuovo task - resetta il form
        if (!editingTaskId) {
            resetTaskForm();
            populateDependencySelect();
        }
    }

    // Se stiamo aprendo il modal evento, attiva sync Google (siamo già connessi grazie a openAddEventModal)
    if (modalId === 'addEventModal') {
        const syncToggle = document.getElementById('eventSyncGoogle');
        const calSelectGroup = document.getElementById('eventCalendarSelectGroup');

        // Attiva sync Google di default (l'utente è già connesso)
        if (syncToggle) {
            syncToggle.classList.add('active');
        }
        if (calSelectGroup) {
            calSelectGroup.style.display = 'block';
        }
        populateEventCalendarSelect();

        // Imposta data odierna
        const dateInput = document.getElementById('eventDate');
        if (dateInput && !dateInput.value) {
            dateInput.value = today;
        }

        // Reset department a 'personal' di default (se non stiamo editando)
        if (!editingGoogleEventId && !window.editingEventId) {
            selectEventDepartment('personal');
        }

        // Pulisci invitati
        clearEventAttendees();
    }

    // Se stiamo aprendo il modal busy (non disponibile)
    if (modalId === 'busyModal') {
        // Reset form
        resetBusyForm();

        // Imposta data odierna
        document.getElementById('busyDateStart').value = today;
        document.getElementById('busyDateEnd').value = today;

        // Mostra/nascondi selettore calendario se connesso a Google
        const calSelectGroup = document.getElementById('busyCalendarSelectGroup');
        if (isGoogleSignedIn) {
            calSelectGroup.style.display = 'block';
            populateBusyCalendarSelect();
        } else {
            calSelectGroup.style.display = 'none';
            showToast('Connettiti a Google Calendar per usare questa funzione', 'warning');
        }
    }

    // ========== FINANCE MODALS ==========
    // Imposta data odierna per spesa
    if (modalId === 'addExpenseModal') {
        const dateInput = document.getElementById('expenseDate');
        if (dateInput) {
            dateInput.value = today;
        }
        // Focus sul campo importo
        setTimeout(() => {
            const amountInput = document.getElementById('expenseAmount');
            if (amountInput) amountInput.focus();
        }, 100);
    }

    // Imposta data odierna per entrata
    if (modalId === 'addIncomeModal') {
        const dateInput = document.getElementById('incomeDate');
        if (dateInput) {
            dateInput.value = today;
        }
        // Focus sul campo importo
        setTimeout(() => {
            const amountInput = document.getElementById('incomeAmount');
            if (amountInput) amountInput.focus();
        }, 100);
    }

    // Imposta data per split transaction
    if (modalId === 'splitTransactionModal') {
        const dateInput = document.getElementById('splitDate');
        if (dateInput) {
            dateInput.value = today;
        }
    }

    // Imposta deadline per money goal (opzionale, 3 mesi da oggi)
    if (modalId === 'addMoneyGoalModal') {
        const deadlineInput = document.getElementById('moneyGoalDeadline');
        if (deadlineInput && !deadlineInput.value) {
            const threeMonthsLater = new Date();
            threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
            deadlineInput.value = threeMonthsLater.toISOString().split('T')[0];
        }
        // Reset icon selection
        selectedGoalIcon = '🏦';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
    }

    // Ripristina scroll del body
    document.body.style.overflow = '';

    // Reset editingTaskId quando si chiude il modal task
    if (modalId === 'addTaskModal') {
        editingTaskId = null;
    }

    // Ferma il polling commenti quando si chiude il modale team task
    if (modalId === 'editTeamTaskModal') {
        stopCommentsPolling();
        currentEditingTeamTaskId = null;
    }
}

// Close on overlay click
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) {
        document.body.style.overflow = '';
        e.target.classList.remove('active');
    }
});

// ============================================
// UI HELPERS
// ============================================

function updateDateTime() {
    const now = new Date();
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    const dateStr = now.toLocaleDateString('it-IT', options);
    const headerDateEl = document.getElementById('headerDate');
    if (headerDateEl) {
        headerDateEl.textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
    }
}

function updateGreeting() {
    const hour = new Date().getHours();
    let greeting = 'Buongiorno';
    let emoji = '☀️';

    if (hour >= 5 && hour < 12) {
        greeting = 'Buongiorno';
        emoji = '☀️';
    } else if (hour >= 12 && hour < 18) {
        greeting = 'Buon pomeriggio';
        emoji = '🌤️';
    } else if (hour >= 18 && hour < 22) {
        greeting = 'Buonasera';
        emoji = '🌅';
    } else {
        greeting = 'Buonanotte';
        emoji = '🌙';
    }

    // Ottieni il nome utente (priorità: nickname > fullName > profile.name > stageName)
    let userName = '';
    if (currentUser?.nickname) {
        userName = currentUser.nickname;
    } else if (currentUser?.name) {
        userName = currentUser.name;
    } else if (state.profile?.name && state.profile.name.trim() !== '') {
        userName = state.profile.name;
    } else if (state.profile?.stageName && state.profile.stageName.trim() !== '') {
        userName = state.profile.stageName;
    }
    const displayName = userName ? `, ${userName}` : '';

    const greetingEl = document.getElementById('greetingText');
    if (greetingEl) {
        greetingEl.textContent = `${greeting}${displayName}! ${emoji}`;
    }

    const quote = MOTIVATIONAL_QUOTES[Math.floor(Math.random() * MOTIVATIONAL_QUOTES.length)];
    const quoteEl = document.getElementById('motivationQuote');
    if (quoteEl) {
        quoteEl.textContent = quote;
    }

    // Update Daily Flow CTA based on time
    const ctaEl = document.getElementById('dailyFlowCTA');
    if (ctaEl) {
        if (hour >= 5 && hour < 14) {
            ctaEl.textContent = '🌅 Morning Flow';
            ctaEl.nextElementSibling.textContent = 'Inizia la giornata nel modo giusto';
        } else if (hour >= 20 || hour < 5) {
            ctaEl.textContent = '🌙 Evening Flow';
            ctaEl.nextElementSibling.textContent = 'Chiudi la giornata con riflessione';
        } else {
            ctaEl.textContent = '⚡ Quick Focus';
            ctaEl.nextElementSibling.textContent = 'Avvia una sessione di focus';
        }
    }
}

function showToast(message, type = '') {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    document.getElementById('toastIcon').textContent = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
    toast.className = 'toast ' + type;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============================================
// GLOBAL SEARCH
// ============================================

let currentSearchFilter = 'all';

function setSearchFilter(filter) {
    currentSearchFilter = filter;
    document.querySelectorAll('.search-filters .chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    const query = document.getElementById('globalSearchInput')?.value || '';
    performGlobalSearch(query);
}

function performGlobalSearch(query) {
    const resultsContainer = document.getElementById('searchResults');
    if (!query || query.length < 2) {
        resultsContainer.innerHTML = '<div class="text-muted text-center py-3">Digita almeno 2 caratteri...</div>';
        return;
    }

    const q = query.toLowerCase();
    let results = [];

    // Search Tasks
    if (currentSearchFilter === 'all' || currentSearchFilter === 'tasks') {
        state.tasks.forEach(task => {
            if (task.title?.toLowerCase().includes(q) || task.description?.toLowerCase().includes(q)) {
                results.push({
                    type: 'task',
                    icon: task.completed ? '✅' : '⬜',
                    title: task.title,
                    meta: task.category || 'Task',
                    data: task
                });
            }
        });
    }

    // Search Notes
    if (currentSearchFilter === 'all' || currentSearchFilter === 'notes') {
        state.notes.forEach(note => {
            if (note.title?.toLowerCase().includes(q) || note.content?.toLowerCase().includes(q)) {
                results.push({
                    type: 'note',
                    icon: '📝',
                    title: note.title,
                    meta: note.content?.substring(0, 50) + '...',
                    data: note
                });
            }
        });
    }

    // Search Events
    if (currentSearchFilter === 'all' || currentSearchFilter === 'events') {
        state.events.forEach(event => {
            if (event.title?.toLowerCase().includes(q) || event.location?.toLowerCase().includes(q)) {
                results.push({
                    type: 'event',
                    icon: '📅',
                    title: event.title,
                    meta: event.date + (event.location ? ' • ' + event.location : ''),
                    data: event
                });
            }
        });
    }

    // Search Skills
    if (currentSearchFilter === 'all' || currentSearchFilter === 'skills') {
        state.skills.forEach(skill => {
            if (skill.name?.toLowerCase().includes(q) || skill.category?.toLowerCase().includes(q)) {
                results.push({
                    type: 'skill',
                    icon: '🎯',
                    title: skill.name,
                    meta: skill.category + ' • Livello ' + skill.level,
                    data: skill
                });
            }
        });
    }

    // Render results
    if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted text-center py-3">Nessun risultato trovato</div>';
        return;
    }

    resultsContainer.innerHTML = results.map(r => `
        <div class="search-result-item" onclick="openSearchResult('${r.type}', '${r.data.id || ''}')">
            <div class="search-result-icon">${r.icon}</div>
            <div class="search-result-content">
                <div class="search-result-title">${r.title}<span class="search-result-type">${r.type}</span></div>
                <div class="search-result-meta">${r.meta}</div>
            </div>
        </div>
    `).join('');
}

function openSearchResult(type, id) {
    closeModal('searchModal');
    switch(type) {
        case 'task':
            switchPage('tasks');
            break;
        case 'note':
            switchPage('notes');
            break;
        case 'event':
            switchPage('calendar');
            break;
        case 'skill':
            switchPage('skills');
            break;
    }
}

// ============================================
// PROFILE MANAGEMENT
// ============================================

function openProfileModal() {
    // Load current profile data
    const profile = state.profile || {};

    console.log('📂 Apertura profilo, dati attuali:', {
        name: profile.name,
        profession: profile.profession,
        stageName: profile.stageName
    });

    // Nome e email (usa dati Google se disponibili)
    document.getElementById('profileName').value = profile.name || '';
    document.getElementById('profileEmail').value = profile.email || '';
    document.getElementById('profileProfession').value = profile.profession || '';
    document.getElementById('profileStageName').value = profile.stageName || '';

    // Se connesso a Google, rendi email readonly
    const emailInput = document.getElementById('profileEmail');
    if (profile.googleConnected && profile.email) {
        emailInput.readOnly = true;
        emailInput.style.background = 'var(--bg-tertiary)';
        emailInput.title = 'Email sincronizzata da Google';
    } else {
        emailInput.readOnly = false;
        emailInput.style.background = '';
        emailInput.title = '';
    }

    // Update avatar
    const avatarLarge = document.getElementById('profileAvatarLarge');
    const pictureUrl = profile.picture || profile.avatar;
    if (pictureUrl) {
        avatarLarge.innerHTML = `<img src="${pictureUrl}" alt="Avatar" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
    } else {
        avatarLarge.textContent = (profile.name || 'U').charAt(0).toUpperCase();
    }

    openModal('profileModal');
}

function saveProfile() {
    // Preserva i dati Google esistenti
    const existingProfile = state.profile || {};

    const profile = {
        name: document.getElementById('profileName').value.trim(),
        email: document.getElementById('profileEmail').value.trim(),
        profession: document.getElementById('profileProfession').value,
        stageName: document.getElementById('profileStageName').value.trim(),
        avatar: existingProfile.avatar || null,
        // Preserva dati Google
        googleId: existingProfile.googleId || null,
        googleConnected: existingProfile.googleConnected || false,
        picture: existingProfile.picture || null,
        updatedAt: new Date().toISOString()
    };

    state.profile = profile;
    // Aggiorna anche state.user per compatibilità
    state.user = state.user || {};
    state.user.name = profile.name;
    state.user.profession = profile.profession;
    state.user.nickname = profile.stageName;

    // Salva profilo anche in localStorage come backup
    try {
        localStorage.setItem('savers_profile_backup', JSON.stringify(profile));
        console.log('💾 Profilo salvato in localStorage come backup');
    } catch (e) {
        console.warn('Impossibile salvare profilo in localStorage:', e);
    }

    // IMPORTANTE: Marca profilo e user come modificati per il sync
    markCollectionDirty('profile');
    markCollectionDirty('user');

    saveStateAndSync();

    // Update header avatar and greeting
    updateHeaderAvatar();
    updateGreeting();
    updateProfileUI();

    // Check onboarding progress
    checkOnboardingProgress(true);

    closeModal('profileModal');
    showToast('Profilo salvato! 🎉', 'success');

    console.log('💾 Profilo salvato:', {
        name: profile.name,
        profession: profile.profession,
        stageName: profile.stageName,
        updatedAt: profile.updatedAt
    });
}

function updateHeaderAvatar() {
    const avatar = document.getElementById('profileAvatar');
    const avatarLarge = document.getElementById('profileAvatarLarge');
    const settingsAvatar = document.getElementById('settingsProfileAvatar');
    const profile = state.profile || {};

    const initial = (profile.name || profile.stageName || 'U').charAt(0).toUpperCase();

    // Priorità: foto Google > avatar caricato > iniziale
    const pictureUrl = profile.picture || profile.avatar;

    if (pictureUrl) {
        const imgHtml = `<img src="${pictureUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
        if (avatar) avatar.innerHTML = imgHtml;
        if (avatarLarge) avatarLarge.innerHTML = imgHtml;
        if (settingsAvatar) settingsAvatar.innerHTML = imgHtml;
    } else {
        if (avatar) avatar.textContent = initial;
        if (avatarLarge) avatarLarge.textContent = initial;
        if (settingsAvatar) settingsAvatar.textContent = initial;
    }
}

// Aggiorna UI profilo nella pagina Settings
function updateProfileUI() {
    const profile = state.profile || {};

    // Avatar
    updateHeaderAvatar();

    // Nome (da Google)
    const nameEl = document.getElementById('settingsProfileName');
    if (nameEl) nameEl.textContent = profile.name || currentUser?.nickname || 'Utente';

    // Email (da Google)
    const emailEl = document.getElementById('settingsProfileEmail');
    if (emailEl) {
        emailEl.innerHTML = profile.email || currentUser?.email || 'Nessuna email';
    }

    // Badge Google
    const googleBadge = document.getElementById('googleBadge');
    if (googleBadge) {
        if (isLoggedIn && isGoogleSignedIn) {
            googleBadge.style.display = 'inline-flex';
            googleBadge.textContent = '✓ Google connesso';
        } else {
            googleBadge.style.display = 'none';
        }
    }

    // Livello e XP
    const level = state.stats?.level || 1;
    const xp = state.stats?.xp || 0;
    const levelEl = document.getElementById('settingsProfileLevel');
    const xpEl = document.getElementById('settingsProfileXP');
    if (levelEl) levelEl.textContent = `Livello ${level}`;
    if (xpEl) xpEl.textContent = `${xp} XP`;

    // Professione
    const professionEl = document.getElementById('settingsProfileProfession');
    if (professionEl) {
        const professions = {
            'magician': '🎩 Mago/Illusionista',
            'musician': '🎵 Musicista',
            'actor': '🎭 Attore',
            'entertainer': '🎪 Intrattenitore',
            'speaker': '🎤 Speaker',
            'other': '💼 Altro'
        };
        professionEl.textContent = professions[profile.profession] || 'Non impostata';
    }

    // Nome d'arte
    const stageNameEl = document.getElementById('settingsProfileStageName');
    if (stageNameEl) stageNameEl.textContent = profile.stageName || 'Non impostato';

    // Google Calendar status
    const calStatusEl = document.getElementById('googleCalendarStatus');
    const calIconEl = document.getElementById('calendarConnectedIcon');
    if (calStatusEl && calIconEl) {
        if (isGoogleSignedIn) {
            calStatusEl.textContent = 'Connesso';
            calIconEl.textContent = '✓';
            calIconEl.style.color = 'var(--success)';
        } else {
            calStatusEl.textContent = 'Non connesso';
            calIconEl.textContent = '✗';
            calIconEl.style.color = 'var(--danger)';
        }
    }

    // Aggiorna UI sync
    updateGoogleConnectionUI();
}

// Aggiorna UI connessione Google (UNIFICATA)
function updateGoogleConnectionUI() {
    const syncSection = document.getElementById('cloudSyncSection');
    const logoutSection = document.getElementById('logoutSection');

    if (isLoggedIn && isGoogleSignedIn) {
        // Utente connesso con Google
        if (syncSection) syncSection.style.display = 'block';
        if (logoutSection) logoutSection.style.display = 'block';
    } else {
        // Non connesso - nascondi sezioni
        if (syncSection) syncSection.style.display = 'none';
        if (logoutSection) logoutSection.style.display = 'none';
    }
}

// Toggle connessione Google - ORA FA LOGOUT COMPLETO
function toggleGoogleConnection() {
    if (isGoogleSignedIn) {
        // Disconnetti = logout completo
        confirmLogout();
    } else {
        // Connetti
        signInWithGoogle();
    }
}

function changeProfileAvatar() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const avatar = event.target.result;
                if (!state.profile) state.profile = {};
                state.profile.avatar = avatar;

                // Update UI
                const avatarLarge = document.getElementById('profileAvatarLarge');
                avatarLarge.innerHTML = `<img src="${avatar}" alt="Avatar">`;

                updateHeaderAvatar();
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

function formatCurrency(amount) {
    return state.settings.currency + parseFloat(amount || 0).toFixed(2);
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const todayStr = today.toISOString().split('T')[0];
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    if (dateStr === todayStr) return 'Oggi';
    if (dateStr === yesterdayStr) return 'Ieri';
    
    return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
}

function triggerConfetti() {
    const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}vw;
            top: -10px;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            pointer-events: none;
            z-index: 9999;
            animation: confettiFall ${2 + Math.random()}s linear forwards;
        `;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 3000);
    }
    
    // Add animation if not exists
    if (!document.getElementById('confettiStyle')) {
        const style = document.createElement('style');
        style.id = 'confettiStyle';
        style.textContent = `
            @keyframes confettiFall {
                to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
}

// ============================================
// XP & LEVELING
// ============================================

function addXP(amount) {
    state.stats.totalXP += amount;

    const newLevel = Math.floor(state.stats.totalXP / 200) + 1;
    if (newLevel > state.stats.level) {
        const oldLevel = state.stats.level;
        state.stats.level = newLevel;
        showToast(`🎉 Livello ${newLevel} raggiunto!`, 'success');
        triggerConfetti();

        // Log level up per KPI
        logAttivita('level_up', 'gamification', null, {
            livello_precedente: oldLevel,
            nuovo_livello: newLevel,
            xp_totali: state.stats.totalXP
        });
    }

    saveStateAndSync();
    updateAllStats();
    checkBadges();
}

function checkBadges() {
    BADGES.forEach(badge => {
        if (!state.stats.unlockedBadges.includes(badge.id) && badge.condition(state.stats)) {
            state.stats.unlockedBadges.push(badge.id);
            showToast(`🏆 Badge: ${badge.name}!`, 'success');
            triggerConfetti();

            // Log badge sbloccato per KPI
            logAttivita('badge_sbloccato', 'gamification', badge.id, {
                nome: badge.name,
                descrizione: badge.desc
            });
        }
    });
    saveStateAndSync();
    renderBadgesGrid();
}

function updateAllStats() {
    // Helper per impostare testo in modo sicuro
    const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
    };

    // Calculate focus score
    const routineComplete = state.today.routineCompleted.filter(Boolean).length;
    const todayTasks = state.tasks.filter(t => t.completedDate === state.today.date).length;
    const focusScore = Math.min(100, (routineComplete * 12) + (todayTasks * 5) + (state.today.pomodoros * 8));

    setText('focusScore', focusScore);

    // Tasks today
    const tasksToday = state.tasks.filter(t => !t.completed && (t.isTop3 || t.due === state.today.date)).length;
    const tasksDoneToday = state.tasks.filter(t => t.completedDate === state.today.date).length;
    setText('tasksToday', `${tasksDoneToday}/${tasksToday + tasksDoneToday}`);

    // Finance today
    const todayTx = state.transactions.filter(t => t.date === state.today.date);
    const todayIncome = todayTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
    const todayExpense = todayTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
    setText('todayBalance', formatCurrency(todayIncome - todayExpense));
    setText('todayIncome', '+' + formatCurrency(todayIncome));
    setText('todayExpense', '-' + formatCurrency(todayExpense));

    // Routine progress
    const routinePercent = Math.round((routineComplete / 6) * 100);
    setText('routinePercent', routinePercent + '%');

    // Streak
    setText('streakCount', state.stats.streak);

    // Analytics
    setText('totalXP', state.stats.totalXP);
    setText('currentLevel', state.stats.level);
    setText('totalDays', state.stats.totalDays);
    setText('badgesEarned', state.stats.unlockedBadges.length);

    // Settings
    setText('settingsName', state.user.name);
    setText('settingsEmail', `Livello ${state.stats.level} • ${state.stats.totalXP} XP`);
}


// ============================================
// RECEIPT SCANNER (OCR) - Con OCR.space API + Tesseract fallback
// ============================================

// OCR.space API - Gratuito: 500 richieste/giorno
// Docs: https://ocr.space/ocrapi
const OCR_SPACE_API_KEY = 'K82718984788957'; // La tua API key personale OCR.space

function triggerScan() {
    // Fallback - apre la galleria
    triggerGallery();
}

function triggerCamera() {
    document.getElementById('receiptInputCamera').click();
}

function triggerGallery() {
    document.getElementById('receiptInputGallery').click();
}

// Converte file in base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// OCR con OCR.space API (più accurato, richiede internet)
async function ocrWithOCRSpace(file, loadingText) {
    if (loadingText) loadingText.textContent = 'Invio a OCR.space...';

    const base64 = await fileToBase64(file);

    const formData = new FormData();
    formData.append('base64Image', base64);
    formData.append('apikey', OCR_SPACE_API_KEY);
    formData.append('language', 'ita'); // Italiano
    formData.append('isTable', 'true'); // Modalità tabella per scontrini
    formData.append('scale', 'true'); // Auto-scala per migliore riconoscimento
    formData.append('OCREngine', '2'); // Engine 2 è migliore per scontrini
    formData.append('detectOrientation', 'true');

    if (loadingText) loadingText.textContent = 'Analisi in corso...';

    const response = await fetch('https://api.ocr.space/parse/image', {
        method: 'POST',
        body: formData
    });

    const result = await response.json();

    if (result.IsErroredOnProcessing) {
        throw new Error(result.ErrorMessage || 'Errore OCR.space');
    }

    if (!result.ParsedResults || result.ParsedResults.length === 0) {
        throw new Error('Nessun testo rilevato');
    }

    return result.ParsedResults[0].ParsedText || '';
}

// OCR con Tesseract.js (fallback offline)
async function ocrWithTesseract(file, loadingText) {
    if (typeof Tesseract === 'undefined') {
        throw new Error('Tesseract.js non caricato');
    }

    // Pre-processa l'immagine
    const processedImage = await preprocessImageForOCR(file);

    if (loadingText) loadingText.textContent = 'Inizializzazione OCR locale...';

    const { data: { text } } = await Tesseract.recognize(processedImage, 'ita', {
        logger: m => {
            if (loadingText) {
                if (m.status === 'loading tesseract core') {
                    loadingText.textContent = 'Caricamento motore OCR...';
                } else if (m.status === 'recognizing text') {
                    loadingText.textContent = `Analisi testo... ${Math.round(m.progress * 100)}%`;
                }
            }
        }
    });

    return text;
}

// Pre-processa l'immagine per migliorare l'OCR (versione avanzata per scontrini)
async function preprocessImageForOCR(file) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Scala l'immagine - upscale se troppo piccola, downscale se troppo grande
            let width = img.width;
            let height = img.height;
            const maxSize = 2000; // Aumentato per migliore qualità
            const minSize = 1000; // Minimo per OCR efficace

            // Upscale se troppo piccola
            if (width < minSize && height < minSize) {
                const scale = minSize / Math.max(width, height);
                width = Math.round(width * scale);
                height = Math.round(height * scale);
            }
            // Downscale se troppo grande
            else if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = Math.round(height * maxSize / width);
                    width = maxSize;
                } else {
                    width = Math.round(width * maxSize / height);
                    height = maxSize;
                }
            }

            canvas.width = width;
            canvas.height = height;

            // Disegna l'immagine con smoothing per upscale
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, width, height);

            // STEP 1: Converti in scala di grigi
            let imageData = ctx.getImageData(0, 0, width, height);
            let data = imageData.data;
            const grayValues = new Uint8Array(width * height);

            for (let i = 0, j = 0; i < data.length; i += 4, j++) {
                // Formula luminanza ITU-R BT.709
                grayValues[j] = Math.round(0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2]);
            }

            // STEP 2: Calcola istogramma per Otsu threshold
            const histogram = new Uint32Array(256);
            for (let i = 0; i < grayValues.length; i++) {
                histogram[grayValues[i]]++;
            }

            // Otsu's method per trovare threshold ottimale
            let total = grayValues.length;
            let sum = 0;
            for (let i = 0; i < 256; i++) sum += i * histogram[i];

            let sumB = 0, wB = 0, wF = 0;
            let maxVariance = 0, threshold = 128;

            for (let t = 0; t < 256; t++) {
                wB += histogram[t];
                if (wB === 0) continue;
                wF = total - wB;
                if (wF === 0) break;

                sumB += t * histogram[t];
                let mB = sumB / wB;
                let mF = (sum - sumB) / wF;
                let variance = wB * wF * (mB - mF) * (mB - mF);

                if (variance > maxVariance) {
                    maxVariance = variance;
                    threshold = t;
                }
            }

            // Adatta threshold per scontrini (spesso hanno sfondo chiaro)
            threshold = Math.min(threshold + 20, 220);

            // STEP 3: Applica sharpening (unsharp mask semplificato)
            const sharpened = new Uint8Array(grayValues.length);
            const sharpenAmount = 0.5;

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = y * width + x;
                    const center = grayValues[idx];

                    // Media dei pixel adiacenti (blur)
                    const blur = (
                        grayValues[idx - width - 1] + grayValues[idx - width] + grayValues[idx - width + 1] +
                        grayValues[idx - 1] + center + grayValues[idx + 1] +
                        grayValues[idx + width - 1] + grayValues[idx + width] + grayValues[idx + width + 1]
                    ) / 9;

                    // Unsharp mask: original + amount * (original - blur)
                    let sharp = center + sharpenAmount * (center - blur);
                    sharpened[idx] = Math.max(0, Math.min(255, Math.round(sharp)));
                }
            }

            // Copia bordi
            for (let x = 0; x < width; x++) {
                sharpened[x] = grayValues[x];
                sharpened[(height - 1) * width + x] = grayValues[(height - 1) * width + x];
            }
            for (let y = 0; y < height; y++) {
                sharpened[y * width] = grayValues[y * width];
                sharpened[y * width + width - 1] = grayValues[y * width + width - 1];
            }

            // STEP 4: Binarizzazione adattiva con threshold Otsu
            // Usa binarizzazione adattiva locale per gestire illuminazione non uniforme
            const blockSize = 15;
            const C = 8; // Costante da sottrarre

            for (let i = 0; i < data.length; i += 4) {
                const idx = i / 4;
                const x = idx % width;
                const y = Math.floor(idx / width);

                // Calcola media locale
                let localSum = 0, count = 0;
                const halfBlock = Math.floor(blockSize / 2);

                for (let dy = -halfBlock; dy <= halfBlock; dy++) {
                    for (let dx = -halfBlock; dx <= halfBlock; dx++) {
                        const nx = x + dx, ny = y + dy;
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            localSum += sharpened[ny * width + nx];
                            count++;
                        }
                    }
                }

                const localMean = localSum / count;
                const localThreshold = localMean - C;

                // Binarizza: nero se sotto threshold, bianco altrimenti
                const value = sharpened[idx] < localThreshold ? 0 : 255;

                data[i] = data[i + 1] = data[i + 2] = value;
                data[i + 3] = 255;
            }

            // STEP 5: Rimozione rumore (morphological opening semplificato)
            // Rimuove piccoli punti isolati
            const cleaned = new Uint8Array(width * height);
            for (let i = 0; i < data.length; i += 4) {
                cleaned[i / 4] = data[i];
            }

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const idx = y * width + x;
                    const pixel = cleaned[idx];

                    // Conta vicini dello stesso colore
                    let sameCount = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            if (cleaned[(y + dy) * width + (x + dx)] === pixel) sameCount++;
                        }
                    }

                    // Se pixel isolato (meno di 2 vicini uguali), inverti
                    if (sameCount < 2) {
                        const i = idx * 4;
                        const newVal = pixel === 0 ? 255 : 0;
                        data[i] = data[i + 1] = data[i + 2] = newVal;
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);

            // Converti in PNG per migliore qualità (OCR preferisce PNG per testo)
            canvas.toBlob((blob) => {
                resolve(blob);
            }, 'image/png');
        };

        img.src = URL.createObjectURL(file);
    });
}

// Pulisce il testo OCR correggendo errori comuni
function cleanOCRText(text) {
    let cleaned = text;

    // Normalizza spazi e newline
    cleaned = cleaned.replace(/\r\n/g, '\n');
    cleaned = cleaned.replace(/[ \t]+/g, ' ');

    // Correzioni OCR comuni per numeri in contesti di prezzo
    // es: "12,5O" -> "12,50", "1O,OO" -> "10,00"
    cleaned = cleaned.replace(/(\d)[Oo](\d)/g, '$10$2'); // O tra cifre -> 0
    cleaned = cleaned.replace(/(\d),([Oo])(\d)/g, '$1,0$3'); // ,O -> ,0
    cleaned = cleaned.replace(/(\d)\.([Oo])(\d)/g, '$1.0$3'); // .O -> .0
    cleaned = cleaned.replace(/(\d)[Oo]$/gm, '$10'); // O finale dopo cifra -> 0
    cleaned = cleaned.replace(/(\d),([Oo]{2})/gi, '$1,00'); // ,OO -> ,00
    cleaned = cleaned.replace(/(\d)\.([Oo]{2})/gi, '$1.00'); // .OO -> .00

    // Correzioni per "TOTALE"
    cleaned = cleaned.replace(/T[Oo0]TALE/gi, 'TOTALE');
    cleaned = cleaned.replace(/T[Oo0]T[.,]/gi, 'TOT.');
    cleaned = cleaned.replace(/TOTAL[Ee3]/gi, 'TOTALE');

    // Correzioni per importi comuni
    cleaned = cleaned.replace(/€\s*([Oo])/g, '€ 0'); // € O -> € 0
    cleaned = cleaned.replace(/EUR\s*([Oo])/gi, 'EUR 0');

    // Correzioni I/l/1 in contesti numerici
    cleaned = cleaned.replace(/([€\d])\s*[Il|](\d)/g, '$1 1$2'); // I o l dopo € o cifra -> 1
    cleaned = cleaned.replace(/(\d)[Il|](\d)/g, '$11$2'); // I o l tra cifre -> 1

    // Correggi "S" che viene letto come "5" in alcune parole
    cleaned = cleaned.replace(/E55E/gi, 'ESSE'); // Per Esselunga
    cleaned = cleaned.replace(/5CONTRINO/gi, 'SCONTRINO');

    // Correggi "B" che viene letto come "8"
    cleaned = cleaned.replace(/8AR\s/gi, 'BAR ');

    console.log('🧹 Cleaned OCR text');
    return cleaned;
}

async function processReceipt(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    const preview = document.getElementById('scannerPreview');
    const loading = document.getElementById('scannerProcessing');
    const result = document.getElementById('scannerResults');
    const footer = document.getElementById('scannerFooter');
    const area = document.getElementById('scannerArea');

    // Show preview
    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
    };
    reader.readAsDataURL(file);

    // Show loading
    area.style.display = 'none';
    loading.style.display = 'block';
    result.style.display = 'none';
    footer.style.display = 'none';

    const loadingText = document.querySelector('#scannerLoading p');

    try {
        let rawText = '';
        let ocrMethod = '';

        // Prova OCR.space API (più accurato, richiede internet)
        try {
            if (loadingText) loadingText.textContent = 'Connessione a OCR.space...';
            rawText = await ocrWithOCRSpace(file, loadingText);
            ocrMethod = 'OCR.space';
            console.log('✅ OCR.space success');
        } catch (ocrSpaceError) {
            console.warn('⚠️ OCR.space failed, trying Tesseract...', ocrSpaceError.message);

            // Fallback a Tesseract.js (offline)
            if (typeof Tesseract !== 'undefined') {
                if (loadingText) loadingText.textContent = 'Fallback a OCR locale...';
                rawText = await ocrWithTesseract(file, loadingText);
                ocrMethod = 'Tesseract';
                console.log('✅ Tesseract fallback success');
            } else {
                throw new Error('OCR non disponibile. Verifica la connessione internet.');
            }
        }

        // Pulisci il testo OCR
        const text = cleanOCRText(rawText);
        console.log(`📄 OCR (${ocrMethod}) Raw Text:`, rawText);
        console.log('📄 OCR Cleaned Text:', text);

        // Parse receipt data
        scannedData = parseReceiptText(text);
        console.log('📊 Parsed Data:', scannedData);

        // Calcola confidence basata sui dati trovati
        let confidence = 0;
        if (scannedData.total) confidence += 50;
        if (scannedData.store) confidence += 25;
        if (scannedData.date) confidence += 25;

        // Display results - ora scannedStore è un input
        document.getElementById('scannedStore').value = scannedData.store || '';
        document.getElementById('scannedAmount').value = scannedData.total ? scannedData.total.toFixed(2) : '';
        document.getElementById('scannedDate').value = scannedData.date || new Date().toISOString().split('T')[0];
        document.getElementById('scannedCategory').value = scannedData.category || 'other';

        // Show confidence indicator
        showOCRConfidence(confidence);

        // Show feedback based on what was found
        if (!scannedData.total) {
            console.warn('⚠️ Totale non trovato. Testo estratto:', text);
            showToast(`Totale non rilevato - inseriscilo manualmente`, 'warning');
            // Focus sul campo importo per inserimento rapido
            setTimeout(() => document.getElementById('scannedAmount').focus(), 100);
        } else {
            const storeText = scannedData.store ? ` da ${scannedData.store}` : '';
            showToast(`✅ €${scannedData.total.toFixed(2)}${storeText}`, 'success');
        }

        loading.style.display = 'none';
        result.style.display = 'block';
        footer.style.display = 'flex';

    } catch (error) {
        console.error('OCR Error:', error);

        // In caso di errore totale, mostra form manuale invece di resettare
        showToast('OCR fallito - inserisci manualmente', 'warning');
        showManualReceiptEntry();
    }
}

function parseReceiptText(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    let result = {
        store: null,
        total: null,
        date: null,
        category: 'other',
        items: [],
        rawText: text
    };

    console.log('🔍 Parsing receipt text...');
    console.log('Raw text:', text);

    // ========== STORE NAME ==========
    // Known store patterns (with OCR-friendly variations)
    const knownStores = [
        // Supermercati - con varianti OCR comuni
        { pattern: /eur[o0]spin|eur[o0]\s*spin|eur[o0]sp[i1]n/i, name: 'Eurospin' },
        { pattern: /esse[l1]unga|essel[l1]unga/i, name: 'Esselunga' },
        { pattern: /c[o0]nad/i, name: 'Conad' },
        { pattern: /\bc[o0]{2}p\b|\bcoop\b/i, name: 'Coop' },
        { pattern: /carref[o0]ur/i, name: 'Carrefour' },
        { pattern: /l[i1]d[l1]/i, name: 'Lidl' },
        { pattern: /a[l1]d[i1]/i, name: 'Aldi' },
        { pattern: /penny/i, name: 'Penny' },
        { pattern: /\bmd\s+s\.?p\.?a/i, name: 'MD' },
        { pattern: /\bpam\b/i, name: 'Pam' },
        { pattern: /despar/i, name: 'Despar' },
        { pattern: /t[i1]gre/i, name: 'Tigre' },
        { pattern: /s[i1]gma/i, name: 'Sigma' },
        { pattern: /\b[i1]per\b/i, name: 'Iper' },
        // Bar e ristoranti
        { pattern: /\bbar\s+c[i1]v[i1]c[o0]/i, name: 'Bar Civico' },
        { pattern: /\bbar\s+\w+/i, name: null }, // Catch bar names
        { pattern: /r[i1]st[o0]rante/i, name: null },
        { pattern: /p[i1]zzer[i1]a/i, name: null },
        { pattern: /trattor[i1]a/i, name: null },
        // Negozi
        { pattern: /ch[i1]cc[o0]/i, name: 'Chicco' },
        { pattern: /ec[o0]\s*t[o0]ur[i1]st/i, name: 'Eco Tourist (Parcheggio)' },
        { pattern: /med[i1]aw[o0]r[l1]d/i, name: 'MediaWorld' },
        { pattern: /un[i1]eur[o0]/i, name: 'Unieuro' },
        { pattern: /decath[l1][o0]n/i, name: 'Decathlon' },
        { pattern: /[i1]kea/i, name: 'IKEA' },
        { pattern: /\bzara\b/i, name: 'Zara' },
        { pattern: /h\s*[&e]\s*m/i, name: 'H&M' },
        { pattern: /apc[o0]a|[i1]nterpark[i1]ng/i, name: 'Parcheggio' },
        // Benzinai
        { pattern: /\ben[i1]\b/i, name: 'ENI' },
        { pattern: /\bq8\b/i, name: 'Q8' },
        { pattern: /tam[o0][i1][l1]/i, name: 'Tamoil' },
    ];

    for (const store of knownStores) {
        const match = text.match(store.pattern);
        if (match) {
            if (store.name) {
                result.store = store.name;
            } else {
                // Extract the matched text for generic patterns (bar, ristorante, etc.)
                result.store = match[0].replace(/[^\w\s]/g, '').trim();
                // Capitalize first letter of each word
                result.store = result.store.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
            }
            console.log('✅ Known store found:', result.store);
            break;
        }
    }

    // If no known store, try first meaningful line (cleaned up)
    if (!result.store) {
        for (const line of lines.slice(0, 8)) {
            // Skip common non-store lines
            if (/^(cassa|documento|commerciale|p\.?\s*iva|tel|fax|www\.|http|scontrino|fiscale|\d{5,})/i.test(line)) continue;
            if (line.length < 4 || line.length > 50) continue;
            if (/^\d+[\s.,\d]*$/.test(line)) continue;
            if (/^[-=*_]+$/.test(line)) continue;

            // Clean the line
            let storeName = line
                .replace(/s\.?p\.?a\.?|s\.?r\.?l\.?|s\.?n\.?c\.?|s\.?a\.?s\.?/gi, '')
                .replace(/[^\w\s&'àèéìòù.-]/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            if (storeName.length >= 3 && storeName.length <= 40) {
                result.store = storeName;
                console.log('✅ Store from line:', result.store);
                break;
            }
        }
    }

    // ========== TOTAL AMOUNT ==========
    // Specific patterns for Italian receipts (priority order)
    // Pattern più flessibili per gestire errori OCR (O->0, l->1, ecc.)
    const totalPatterns = [
        // "Totale Complessivo 39,89" - most common Italian format
        /t[o0]tale\s+c[o0]mpless[i1l]v[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "TOTALE DOCUMENTO 39,89" - formato comune
        /t[o0]tale\s+d[o0]cument[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "TOTALE SCONTRINO 39,89"
        /t[o0]tale\s+sc[o0]ntr[i1l]n[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "Amount: 2,50" - parking receipts
        /am[o0]unt\s*:\s*(\d{1,4}[.,]\d{2})/i,
        // "Importo pagato 1,85"
        /[i1l]mp[o0]rt[o0]\s+pagat[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "Importo: €1,85" o "Importo €1,85"
        /[i1l]mp[o0]rt[o0]\s*[:\s]*€?\s*(\d{1,4}[.,]\d{2})/i,
        // "Pagamento elettronico 39,89"
        /pagament[o0]\s+(?:e[l1]ettr[o0]n[i1l]c[o0]|c[o0]ntante|banc[o0]mat|carta)\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "TOTALE € 12,50" or "TOTALE 12,50" - con variazioni OCR
        /\bt[o0]ta[l1]e\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "TOT. 12,50" o "TOT 12,50"
        /\bt[o0]t\.?\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "Da pagare: 12,50"
        /da\s+pagare\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "Dovuto: 12,50"
        /d[o0]vut[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "EURO 12,50" o "EUR 12,50"
        /\beur[o0]?\s*[:\s]*(\d{1,4}[.,]\d{2})/i,
        // "€ 12,50" da solo su una riga (spesso il totale)
        /^€\s*(\d{1,4}[.,]\d{2})\s*$/im,
        // "Contante: 12,50"
        /c[o0]ntante\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "Bancomat: 12,50" o "POS: 12,50"
        /(?:banc[o0]mat|p[o0]s|carta)\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "** TOTALE **" o "*** TOTALE ***" formato con asterischi
        /\*+\s*t[o0]ta[l1]e\s*\*+\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "RESTO 0,00" - indica che il totale è stato pagato
        /rest[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "SPESA 12,50" - comune in supermercati
        /spesa\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
        // "CORRISPETTIVO 12,50"
        /c[o0]rr[i1l]spett[i1l]v[o0]\s*[:\s€]*(\d{1,4}[.,]\d{2})/i,
    ];

    for (const pattern of totalPatterns) {
        const match = text.match(pattern);
        if (match) {
            const amount = parseFloat(match[1].replace(',', '.'));
            if (amount > 0 && amount < 10000) {
                result.total = amount;
                console.log('✅ Total found with pattern:', pattern.toString(), '=>', amount);
                break;
            }
        }
    }

    // If no total found, look for amounts on lines with keywords (più flessibile)
    if (!result.total) {
        // Keywords con variazioni OCR
        const keywords = /t[o0]tale|pagat[o0]|[i1l]mp[o0]rt[o0]|am[o0]unt|d[o0]vut[o0]|c[o0]mpless[i1l]v[o0]|eur[o0]|c[o0]ntante|banc[o0]mat/i;
        for (const line of lines) {
            if (keywords.test(line)) {
                const amountMatch = line.match(/(\d{1,4})[.,](\d{2})/);
                if (amountMatch) {
                    const amount = parseFloat(amountMatch[1] + '.' + amountMatch[2]);
                    if (amount > 0 && amount < 10000) {
                        result.total = amount;
                        console.log('✅ Total from keyword line:', line, '=>', amount);
                        break;
                    }
                }
            }
        }
    }

    // Cerca importi preceduti da € o simbolo euro
    if (!result.total) {
        const euroPattern = /€\s*(\d{1,4})[.,](\d{2})/g;
        const euroAmounts = [];
        let match;
        while ((match = euroPattern.exec(text)) !== null) {
            const amount = parseFloat(match[1] + '.' + match[2]);
            if (amount > 0.50 && amount < 5000) {
                euroAmounts.push(amount);
            }
        }
        if (euroAmounts.length > 0) {
            // Prendi il più grande (spesso è il totale)
            euroAmounts.sort((a, b) => b - a);
            result.total = euroAmounts[0];
            console.log('✅ Total from € symbol:', result.total);
        }
    }

    // Fallback: trova l'importo più grande che appare nelle ultime righe
    if (!result.total) {
        const amounts = [];
        const pricePattern = /(\d{1,4})[.,](\d{2})/g;

        // Prima cerca nelle ultime 10 righe (dove di solito c'è il totale)
        const lastLines = lines.slice(-10).join('\n');
        let match;
        while ((match = pricePattern.exec(lastLines)) !== null) {
            const amount = parseFloat(match[1] + '.' + match[2]);
            if (amount > 0.50 && amount < 5000) {
                amounts.push(amount);
            }
        }

        // Se non trova nulla, cerca in tutto il testo
        if (amounts.length === 0) {
            while ((match = pricePattern.exec(text)) !== null) {
                const amount = parseFloat(match[1] + '.' + match[2]);
                if (amount > 0.50 && amount < 5000) {
                    amounts.push(amount);
                }
            }
        }

        if (amounts.length > 0) {
            amounts.sort((a, b) => b - a);
            result.total = amounts[0];
            console.log('⚠️ Fallback to largest amount:', result.total);
        }
    }

    // ========== DATE ==========
    // Multiple date patterns for Italian receipts
    const datePatterns = [
        // "24/12/2025" or "06-11-2025" or "24.12.2025"
        /(\d{2})[\/\-.](\d{2})[\/\-.](\d{4})/g,
        // "24/12/25" or "6/11/25" (short year)
        /(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2})(?!\d)/g,
    ];

    // Find ALL dates in the text and pick the most likely one
    let foundDates = [];

    for (const pattern of datePatterns) {
        let match;
        while ((match = pattern.exec(text)) !== null) {
            let day = match[1].padStart(2, '0');
            let month = match[2].padStart(2, '0');
            let year = match[3];

            const dayNum = parseInt(day);
            const monthNum = parseInt(month);

            // Validate date
            if (dayNum > 31 || dayNum < 1 || monthNum > 12 || monthNum < 1) continue;

            if (year.length === 2) year = '20' + year;

            // Check if year is reasonable (2020-2030)
            const yearNum = parseInt(year);
            if (yearNum < 2020 || yearNum > 2030) continue;

            const dateStr = `${year}-${month}-${day}`;
            const dateObj = new Date(dateStr);

            // Make sure it's a valid date and not in the future
            if (!isNaN(dateObj.getTime()) && dateObj <= new Date()) {
                foundDates.push({ dateStr, dateObj, position: match.index });
            }
        }
    }

    if (foundDates.length > 0) {
        // Sort by position in text (earlier dates are usually transaction dates)
        // But also prefer dates that are not today
        const today = new Date().toISOString().split('T')[0];
        foundDates.sort((a, b) => {
            // Prefer non-today dates
            if (a.dateStr === today && b.dateStr !== today) return 1;
            if (b.dateStr === today && a.dateStr !== today) return -1;
            // Otherwise prefer earlier in text
            return a.position - b.position;
        });

        result.date = foundDates[0].dateStr;
        console.log('✅ Date found:', result.date, 'from', foundDates.length, 'candidates');
    } else {
        // No date found - leave empty so user can enter manually
        result.date = null;
        console.log('⚠️ No valid date found in receipt');
    }

    // ========== CATEGORY ==========
    const textLower = text.toLowerCase();

    // Parking
    if (/parking|parcheggio|sosta|eco\s*tourist|apcoa|interparking|stay\s*time/i.test(textLower)) {
        result.category = 'transport';
    }
    // Food & Groceries
    else if (/supermercato|alimentari|market|\bcoop\b|esselunga|conad|lidl|eurospin|carrefour|\bpam\b|despar|\bmd\b|penny|aldi|simply|tigre|sigma|\biper\b|ipercoop|dico|tuodi|todis/i.test(textLower)) {
        result.category = 'food';
    }
    // Baby/Kids stores
    else if (/chicco|prenatal|bimbo|baby|neonato|infanzia/i.test(textLower)) {
        result.category = 'shopping';
    }
    // Restaurants & Bars
    else if (/ristorante|pizzeria|trattoria|osteria|\bbar\b|caffè|caffe|cafe|mcdonald|burger|sushi|kebab|pub|tavola calda|rosticceria|gelateria|pasticceria/i.test(textLower)) {
        result.category = 'food';
    }
    // Pharmacy & Health
    else if (/farmacia|parafarmacia|sanitaria|ottica|dentist/i.test(textLower)) {
        result.category = 'health';
    }
    // Transport & Fuel
    else if (/benzina|carburante|diesel|gasolio|\beni\b|agip|\bq8\b|\bip\b|tamoil|\btotal\b|shell|esso|\bapi\b|autostrad|pedaggio|treno|trenitalia|italo|\batm\b|metro|\bbus\b|taxi|uber|bolt/i.test(textLower)) {
        result.category = 'transport';
    }
    // Shopping & Clothing
    else if (/abbigliamento|\bzara\b|h\s*&\s*m|decathlon|oviesse|ovs|benetton|intimissimi|calzedonia|tezenis|primark|nike|adidas|foot\s*locker|mediaworld|euronics|unieuro|amazon|ebay/i.test(textLower)) {
        result.category = 'shopping';
    }
    // Bills & Utilities
    else if (/bolletta|enel|eni\s+gas|edison|a2a|acea|telecom|\btim\b|vodafone|wind|\btre\b|iliad|fastweb|\bsky\b|netflix|spotify|assicurazione|affitto|mutuo/i.test(textLower)) {
        result.category = 'bills';
    }
    // Home
    else if (/ikea|leroy\s*merlin|brico|\bobi\b|ferramenta|castorama|mondo\s*convenienza/i.test(textLower)) {
        result.category = 'home';
    }
    // Entertainment
    else if (/cinema|teatro|concert|biglietto|ticket|evento|museo|mostra|stadio|partita/i.test(textLower)) {
        result.category = 'entertainment';
    }
    // Education
    else if (/libreria|feltrinelli|mondadori|libro|university|scuola|corso|formazione/i.test(textLower)) {
        result.category = 'education';
    }

    console.log('📊 Final result:', result);
    return result;
}

function resetScanner() {
    document.getElementById('scannerArea').style.display = 'block';
    document.getElementById('scannerPreview').style.display = 'none';
    document.getElementById('scannerProcessing').style.display = 'none';
    document.getElementById('scannerResults').style.display = 'none';
    document.getElementById('scannerFooter').style.display = 'none';

    // Reset form fields
    document.getElementById('scannedStore').value = '';
    document.getElementById('scannedAmount').value = '';
    document.getElementById('scannedDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('scannedCategory').value = 'food';
    document.getElementById('scannedMethod').value = 'card';
    const notesEl = document.getElementById('scannedNotes');
    if (notesEl) notesEl.value = '';

    // Hide correction hint and confidence badge
    const correctionHint = document.getElementById('ocrCorrectionHint');
    if (correctionHint) correctionHint.style.display = 'none';
    const confidenceBadge = document.getElementById('ocrConfidenceBadge');
    if (confidenceBadge) confidenceBadge.style.display = 'none';

    // Reset both input fields
    const cameraInput = document.getElementById('receiptInputCamera');
    const galleryInput = document.getElementById('receiptInputGallery');
    if (cameraInput) cameraInput.value = '';
    if (galleryInput) galleryInput.value = '';
    scannedData = null;
}

// Mostra form per inserimento manuale (senza OCR)
function showManualReceiptEntry() {
    document.getElementById('scannerArea').style.display = 'none';
    document.getElementById('scannerPreview').style.display = 'none';
    document.getElementById('scannerProcessing').style.display = 'none';
    document.getElementById('scannerResults').style.display = 'block';
    document.getElementById('scannerFooter').style.display = 'flex';

    // Precompila con data odierna
    document.getElementById('scannedDate').value = new Date().toISOString().split('T')[0];

    // Nascondi hint correzione OCR (è inserimento manuale)
    const correctionHint = document.getElementById('ocrCorrectionHint');
    if (correctionHint) correctionHint.style.display = 'none';
    const confidenceBadge = document.getElementById('ocrConfidenceBadge');
    if (confidenceBadge) confidenceBadge.style.display = 'none';

    // Focus sull'importo
    setTimeout(() => {
        document.getElementById('scannedAmount').focus();
    }, 100);
}

// Imposta importo rapido
function setQuickAmount(amount) {
    document.getElementById('scannedAmount').value = amount.toFixed(2);
}

// Mostra indicatore confidenza OCR
function showOCRConfidence(confidence) {
    const badge = document.getElementById('ocrConfidenceBadge');
    const hint = document.getElementById('ocrCorrectionHint');

    if (!badge) return;

    badge.style.display = 'inline-block';

    if (confidence >= 80) {
        badge.textContent = '✓ Alta precisione';
        badge.style.background = 'var(--success)';
        badge.style.color = 'white';
        if (hint) hint.style.display = 'none';
    } else if (confidence >= 50) {
        badge.textContent = '⚠ Media precisione';
        badge.style.background = 'var(--accent)';
        badge.style.color = 'white';
        if (hint) hint.style.display = 'block';
    } else {
        badge.textContent = '⚠ Bassa precisione';
        badge.style.background = 'var(--danger)';
        badge.style.color = 'white';
        if (hint) hint.style.display = 'block';
    }
}

function saveScannedReceipt() {
    // Get values from form inputs (user may have edited them)
    const amount = parseFloat(document.getElementById('scannedAmount').value);
    const date = document.getElementById('scannedDate').value;
    const category = document.getElementById('scannedCategory').value;
    const method = document.getElementById('scannedMethod').value;
    const store = document.getElementById('scannedStore').value || ''; // Now it's an input
    const notes = document.getElementById('scannedNotes')?.value || '';

    if (!amount || amount <= 0) {
        showToast('Inserisci un importo valido', 'error');
        document.getElementById('scannedAmount').focus();
        return;
    }

    // Build description
    let description = store.trim();
    if (!description) description = 'Spesa';
    if (notes.trim()) description += ` - ${notes.trim()}`;

    const transaction = {
        id: 'tx_' + Date.now(),
        type: 'expense',
        amount: amount,
        description: description,
        category: category,
        date: date || state.today.date,
        method: method,
        scanned: true,
        createdAt: new Date().toISOString()
    };

    state.transactions.push(transaction);
    state.stats.transactionsLogged++;
    if (!state.stats.receiptsScanned) state.stats.receiptsScanned = 0;
    state.stats.receiptsScanned++;
    saveStateAndSync();

    closeModal('scanReceiptModal');
    resetScanner();
    renderFinancePage();
    renderHomePage();
    addXP(5);
    showToast(`Spesa di €${amount.toFixed(2)} salvata! +5 XP`, 'success');
    checkBadges();
}

// ============================================
// ROUTINE (S.A.V.E.R.S.)
// ============================================

function renderRoutinePage() {
    renderRoutineActivities();
    renderHabitsList();
    updateRoutineProgress();
}

function renderRoutineActivities() {
    const container = document.getElementById('routineActivities');
    
    container.innerHTML = ROUTINE_ACTIVITIES.map((activity, index) => `
        <div class="habit-item ${state.today.routineCompleted[index] ? 'completed' : ''}" 
             onclick="toggleRoutineActivity(${index})">
            <div class="habit-icon" style="background: ${state.today.routineCompleted[index] ? 'var(--success)' : 'var(--bg-secondary)'}; color: ${state.today.routineCompleted[index] ? 'white' : 'inherit'}">
                ${activity.icon}
            </div>
            <div class="habit-info">
                <div class="habit-name">${activity.name}</div>
                <div class="habit-streak">${activity.desc} • ${activity.duration} min • +${activity.xp} XP</div>
            </div>
            <div class="habit-check ${state.today.routineCompleted[index] ? 'completed' : ''}">
                ${state.today.routineCompleted[index] ? '✓' : ''}
            </div>
        </div>
    `).join('');
}

function toggleRoutineActivity(index) {
    state.today.routineCompleted[index] = !state.today.routineCompleted[index];

    if (state.today.routineCompleted[index]) {
        addXP(ROUTINE_ACTIVITIES[index].xp);
        showToast(`${ROUTINE_ACTIVITIES[index].name} completato! +${ROUTINE_ACTIVITIES[index].xp} XP`, 'success');

        // Log per KPI - attività routine completata
        logAttivita('routine_attivita_completata', 'routine', ROUTINE_ACTIVITIES[index].id, {
            nome: ROUTINE_ACTIVITIES[index].name,
            lettera: ROUTINE_ACTIVITIES[index].letter,
            xp: ROUTINE_ACTIVITIES[index].xp
        });
    }

    // Check if all completed
    const completedCount = state.today.routineCompleted.filter(Boolean).length;
    if (state.today.routineCompleted.every(Boolean)) {
        addXP(50);
        showToast('🎉 Routine completa! +50 XP Bonus!', 'success');
        triggerConfetti();
        state.stats.streak++;
        state.stats.totalDays++;

        // Log completamento routine SAVERS completa
        logAttivita('routine_savers_completata', 'routine', state.today.date, {
            streak: state.stats.streak,
            giorniTotali: state.stats.totalDays
        });
    }

    saveStateAndSync();
    renderRoutinePage();
    updateAllStats();
    checkBadges();
}

function updateRoutineProgress() {
    const completed = state.today.routineCompleted.filter(Boolean).length;
    const total = 6;
    const percentage = Math.round((completed / total) * 100);
    
    // Update progress ring
    const ring = document.getElementById('routineProgressRing');
    const circumference = 2 * Math.PI * 52;
    const offset = circumference - (percentage / 100) * circumference;
    ring.style.strokeDashoffset = offset;
    
    document.getElementById('routineProgressValue').textContent = percentage + '%';
}

// ============================================
// POMODORO
// ============================================

function togglePomodoro() {
    if (pomodoroRunning) {
        pausePomodoro();
    } else {
        startPomodoro();
    }
}

function startPomodoro() {
    pomodoroRunning = true;
    document.getElementById('pomodoroStartBtn').innerHTML = '⏸️ Pausa';
    document.getElementById('pomodoroLabel').textContent = 'Focus! 🧠';
    
    pomodoroInterval = setInterval(() => {
        pomodoroTime--;
        updatePomodoroDisplay();
        
        if (pomodoroTime <= 0) {
            completePomodoro();
        }
    }, 1000);
}

function pausePomodoro() {
    pomodoroRunning = false;
    clearInterval(pomodoroInterval);
    document.getElementById('pomodoroStartBtn').innerHTML = '▶️ Continua';
    document.getElementById('pomodoroLabel').textContent = 'In pausa';
}

function resetPomodoro() {
    pausePomodoro();
    pomodoroTime = state.settings.pomodoroDuration * 60;
    updatePomodoroDisplay();
    document.getElementById('pomodoroStartBtn').innerHTML = '▶️ Inizia';
    document.getElementById('pomodoroLabel').textContent = 'Pronto per iniziare';
}

function completePomodoro() {
    pausePomodoro();
    pomodoroSessions++;
    state.today.pomodoros++;
    state.stats.pomodorosTotal++;

    addXP(15);
    showToast('🍅 Pomodoro completato! +15 XP', 'success');

    // Log per KPI
    logAttivita('pomodoro_completato', 'pomodoro', null, { sessione: pomodoroSessions });

    // Notification
    if (Notification.permission === 'granted') {
        new Notification('🍅 Pomodoro Completato!', {
            body: 'Tempo per una pausa!'
        });
    }

    // Reset for next session
    if (pomodoroSessions >= 4) {
        pomodoroSessions = 0;
        pomodoroTime = 15 * 60; // Long break
        document.getElementById('pomodoroLabel').textContent = 'Pausa lunga! ☕';
    } else {
        pomodoroTime = state.settings.breakDuration * 60;
        document.getElementById('pomodoroLabel').textContent = 'Pausa breve! ☕';
    }

    updatePomodoroDisplay();
    renderPomodoroSessions();
    saveStateAndSync();
    updateAllStats();
    checkBadges();
}

function updatePomodoroDisplay() {
    const minutes = Math.floor(pomodoroTime / 60);
    const seconds = pomodoroTime % 60;
    document.getElementById('pomodoroTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function renderPomodoroSessions() {
    const container = document.getElementById('pomodoroSessions');
    container.innerHTML = [0, 1, 2, 3].map(i => `
        <div class="pomodoro-dot ${i < pomodoroSessions ? 'completed' : ''} ${i === pomodoroSessions ? 'current' : ''}"></div>
    `).join('');
}

// ============================================
// TIME TRACKER
// ============================================

function toggleTimeTracker() {
    if (timeTrackerRunning) {
        stopTimeTracker();
    } else {
        startTimeTracker();
    }
}

function startTimeTracker() {
    timeTrackerRunning = true;
    document.getElementById('timeStartBtn').innerHTML = '⏹️ Stop';
    
    timeTrackerInterval = setInterval(() => {
        timeTrackerSeconds++;
        updateTimeTrackerDisplay();
    }, 1000);
}

function stopTimeTracker() {
    timeTrackerRunning = false;
    clearInterval(timeTrackerInterval);
    document.getElementById('timeStartBtn').innerHTML = '▶️ Inizia';
    
    // Save time log
    if (timeTrackerSeconds > 60) {
        const log = {
            id: 'tl_' + Date.now(),
            project: currentTimeProject || 'Generale',
            duration: timeTrackerSeconds,
            date: state.today.date,
            createdAt: new Date().toISOString()
        };
        state.timeLogs.push(log);
        saveStateAndSync();
        
        addXP(Math.floor(timeTrackerSeconds / 60));
        showToast(`Tempo registrato! +${Math.floor(timeTrackerSeconds / 60)} XP`, 'success');
    }
    
    renderTimePage();
}

function resetTimeTracker() {
    stopTimeTracker();
    timeTrackerSeconds = 0;
    updateTimeTrackerDisplay();
}

function updateTimeTrackerDisplay() {
    const hours = Math.floor(timeTrackerSeconds / 3600);
    const minutes = Math.floor((timeTrackerSeconds % 3600) / 60);
    const seconds = timeTrackerSeconds % 60;
    
    document.getElementById('timeTrackerDisplay').textContent = 
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function renderTimePage() {
    renderTimeBlocks();
    renderTimeLogs();
    updateTimeStats();
}

function renderTimeBlocks() {
    const container = document.getElementById('timeBlocksList');
    if (!container) return;
    const todayBlocks = state.timeBlocks.filter(b => b.date === state.today.date);
    
    if (todayBlocks.length === 0) {
        container.innerHTML = `<div class="text-muted text-center" style="padding:20px;">Nessun time block</div>`;
        return;
    }
    
    container.innerHTML = todayBlocks.sort((a, b) => a.start.localeCompare(b.start)).map(block => `
        <div class="time-slot">
            <div class="time-slot-hour">${block.start}</div>
            <div class="time-slot-content">
                <div class="time-block">
                    <div class="time-block-title">${block.title}</div>
                    <div class="time-block-duration">${block.start} - ${block.end}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function renderTimeLogs() {
    const container = document.getElementById('timeLogList');
    const todayLogs = state.timeLogs.filter(l => l.date === state.today.date);
    
    if (todayLogs.length === 0) {
        container.innerHTML = `<div class="text-muted text-center" style="padding:20px;">Nessun log oggi</div>`;
        return;
    }
    
    container.innerHTML = todayLogs.map(log => {
        const hours = Math.floor(log.duration / 3600);
        const minutes = Math.floor((log.duration % 3600) / 60);
        const duration = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
        
        return `
            <div class="time-log-item">
                <div class="time-log-color" style="background:var(--primary);"></div>
                <div class="time-log-info">
                    <div class="time-log-project">${log.project}</div>
                    <div class="time-log-task">${formatDate(log.date)}</div>
                </div>
                <div class="time-log-duration">${duration}</div>
            </div>
        `;
    }).join('');
}

function updateTimeStats() {
    const todayLogs = state.timeLogs.filter(l => l.date === state.today.date);
    const todaySeconds = todayLogs.reduce((s, l) => s + l.duration, 0);
    const todayHours = (todaySeconds / 3600).toFixed(1);
    
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
    const weekLogs = state.timeLogs.filter(l => new Date(l.date) >= weekStart);
    const weekSeconds = weekLogs.reduce((s, l) => s + l.duration, 0);
    const weekHours = (weekSeconds / 3600).toFixed(1);
    
    document.getElementById('timeToday').textContent = todayHours + 'h';
    document.getElementById('timeWeek').textContent = weekHours + 'h';
}

function saveTimeBlock() {
    const title = document.getElementById('blockTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }
    
    const block = {
        id: 'tb_' + Date.now(),
        title,
        start: document.getElementById('blockStart').value,
        end: document.getElementById('blockEnd').value,
        type: document.getElementById('blockType').value,
        date: state.today.date,
        createdAt: new Date().toISOString()
    };
    
    state.timeBlocks.push(block);
    saveStateAndSync();
    
    document.getElementById('blockTitle').value = '';
    
    closeModal('timeBlockModal');
    renderTimePage();
    renderHomePage();
    showToast('Time block creato!', 'success');
}


// ============================================
// FOCUS PAGE (Unified Timer)
// ============================================

let focusInterval = null;
let focusRunning = false;
let focusTime = 25 * 60; // seconds
let focusTotalTime = 25 * 60;
let focusType = 'pomodoro'; // 'pomodoro', 'deepwork', 'custom'
let focusSessions = 0;
let focusOnBreak = false;
let focusCurrentTask = null;
let focusDistractions = [];

const focusPresets = {
    pomodoro: { work: 25, break: 5, longBreak: 15, sessions: 4 },
    deepwork: { work: 90, break: 15, longBreak: 30, sessions: 2 },
    custom: { work: 45, break: 10, longBreak: 20, sessions: 3 }
};

function initFocusPage() {
    setFocusType('pomodoro');
    updateFocusDisplay();
    renderFocusStats();
    renderFocusSessions();
    renderDistractionLog();
}

function setFocusType(type, evt) {
    focusType = type;
    const preset = focusPresets[type];
    focusTime = preset.work * 60;
    focusTotalTime = preset.work * 60;
    focusOnBreak = false;

    // Update UI
    document.querySelectorAll('.focus-type-btn').forEach(btn => btn.classList.remove('active'));
    if (evt && evt.target) {
        evt.target.classList.add('active');
    } else {
        // Find button by type
        const btns = document.querySelectorAll('.focus-type-btn');
        btns.forEach(btn => {
            if (btn.textContent.toLowerCase().includes(type === 'pomodoro' ? 'pomodoro' : type === 'deepwork' ? 'deep' : 'custom')) {
                btn.classList.add('active');
            }
        });
    }

    document.getElementById('focusTimerLabel').textContent = 'Pronto per iniziare';
    updateFocusDisplay();
    updateFocusRing();
}

function toggleFocusTimer() {
    if (focusRunning) {
        pauseFocusTimer();
    } else {
        // Show intention card if starting a new work session (not break)
        if (!focusOnBreak && !window.currentSessionId) {
            showIntentionCard();
        } else {
            startFocusTimer();
        }
    }
}

function showIntentionCard() {
    const card = document.getElementById('intentionCard');
    if (card) {
        card.style.display = 'block';
        document.getElementById('sessionIntention').focus();
    }
}

function hideIntentionCard() {
    const card = document.getElementById('intentionCard');
    if (card) {
        card.style.display = 'none';
    }
}

function startFocusWithIntention() {
    const intention = document.getElementById('sessionIntention')?.value.trim() || '';

    // Create session with intention
    const session = {
        id: 'fs_' + Date.now(),
        type: focusType,
        intention: intention,
        startTime: new Date().toISOString(),
        taskId: focusCurrentTask // Usa la variabile corretta
    };

    if (!state.focusSessions) state.focusSessions = [];
    state.focusSessions.push(session);
    window.currentSessionId = session.id;

    hideIntentionCard();
    startFocusTimer();

    if (intention) {
        showToast(`Focus: ${intention.substring(0, 50)}${intention.length > 50 ? '...' : ''}`, 'info');
    }
}

function startFocusTimer() {
    focusRunning = true;
    document.getElementById('focusMainBtnIcon').textContent = '⏸️';
    document.getElementById('focusMainBtnText').textContent = 'Pausa';
    document.getElementById('focusTimerLabel').textContent = focusOnBreak ? 'Pausa ☕' : 'Focus! 🧠';

    focusInterval = setInterval(() => {
        focusTime--;
        updateFocusDisplay();
        updateFocusRing();

        if (focusTime <= 0) {
            completeFocusSession();
        }
    }, 1000);
}

function pauseFocusTimer() {
    focusRunning = false;
    clearInterval(focusInterval);
    document.getElementById('focusMainBtnIcon').textContent = '▶️';
    document.getElementById('focusMainBtnText').textContent = 'Continua';
    document.getElementById('focusTimerLabel').textContent = 'In pausa';
}

function resetFocusTimer() {
    pauseFocusTimer();
    const preset = focusPresets[focusType];
    focusTime = focusOnBreak ? preset.break * 60 : preset.work * 60;
    focusTotalTime = focusTime;
    document.getElementById('focusMainBtnIcon').textContent = '▶️';
    document.getElementById('focusMainBtnText').textContent = 'Inizia';
    document.getElementById('focusTimerLabel').textContent = 'Pronto per iniziare';
    updateFocusDisplay();
    updateFocusRing();
}

function skipFocusPhase() {
    completeFocusSession();
}

function completeFocusSession() {
    pauseFocusTimer();
    const preset = focusPresets[focusType];

    if (!focusOnBreak) {
        // Work session completed
        focusSessions++;
        state.today.pomodoros++;
        state.stats.pomodorosTotal++;

        // Add session to history
        const session = {
            id: 'fs_' + Date.now(),
            type: focusType,
            duration: focusTotalTime,
            task: focusCurrentTask,
            date: state.today.date,
            time: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
        };
        if (!state.focusSessions) state.focusSessions = [];
        state.focusSessions.push(session);

        addXP(focusType === 'deepwork' ? 25 : 15);
        showToast(`${focusType === 'pomodoro' ? '🍅' : '🧠'} Sessione completata! +${focusType === 'deepwork' ? 25 : 15} XP`, 'success');

        // Notification
        if (Notification.permission === 'granted') {
            new Notification('Sessione Completata!', {
                body: 'Tempo per una pausa!'
            });
        }

        // Set up break
        focusOnBreak = true;
        if (focusSessions >= preset.sessions) {
            focusTime = preset.longBreak * 60;
            document.getElementById('focusTimerLabel').textContent = 'Pausa lunga! ☕';
            focusSessions = 0;
        } else {
            focusTime = preset.break * 60;
            document.getElementById('focusTimerLabel').textContent = 'Pausa breve! ☕';
        }
        focusTotalTime = focusTime;
        document.getElementById('focusRingProgress').classList.add('break');

    } else {
        // Break completed
        focusOnBreak = false;
        focusTime = preset.work * 60;
        focusTotalTime = focusTime;
        document.getElementById('focusTimerLabel').textContent = 'Pronto per la prossima sessione!';
        document.getElementById('focusRingProgress').classList.remove('break');

        if (Notification.permission === 'granted') {
            new Notification('Pausa terminata!', {
                body: 'Pronto per un\'altra sessione?'
            });
        }
    }

    updateFocusDisplay();
    updateFocusRing();
    renderFocusStats();
    renderFocusSessions();
    saveStateAndSync();
    updateAllStats();

    // Sync with old pomodoro display
    updatePomodoroDisplay();
    renderPomodoroSessions();
}

function updateFocusDisplay() {
    const minutes = Math.floor(focusTime / 60);
    const seconds = focusTime % 60;
    document.getElementById('focusTimerDisplay').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateFocusRing() {
    const progress = focusTotalTime > 0 ? (focusTime / focusTotalTime) : 0;
    const circumference = 2 * Math.PI * 90; // r=90
    const offset = circumference * (1 - progress);
    document.getElementById('focusRingProgress').style.strokeDashoffset = offset;
}

function renderFocusStats() {
    const todayPomodoros = state.today.pomodoros || 0;
    const todaySessions = (state.focusSessions || []).filter(s => s.date === state.today.date);
    const todayMinutes = todaySessions.reduce((sum, s) => sum + (s.duration / 60), 0);
    const streak = calculateFocusStreak();
    const distractions = focusDistractions.length;

    document.getElementById('focusPomodorosToday').textContent = todayPomodoros;
    document.getElementById('focusTimeToday').textContent = todayMinutes >= 60 ?
        `${Math.floor(todayMinutes / 60)}h ${Math.round(todayMinutes % 60)}m` :
        `${Math.round(todayMinutes)}m`;
    document.getElementById('focusStreak').textContent = streak;
    document.getElementById('focusDistractions').textContent = distractions;
}

function calculateFocusStreak() {
    // Count consecutive days with focus sessions
    let streak = 0;
    const today = new Date();

    for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = checkDate.toISOString().split('T')[0];

        const hasFocus = (state.focusSessions || []).some(s => s.date === dateStr);
        if (hasFocus || (i === 0 && state.today.pomodoros > 0)) {
            streak++;
        } else if (i > 0) {
            break;
        }
    }

    return streak;
}

function renderFocusSessions() {
    const container = document.getElementById('focusSessionsHistory');
    const todaySessions = (state.focusSessions || []).filter(s => s.date === state.today.date);

    if (todaySessions.length === 0) {
        container.innerHTML = `<div class="text-muted text-center" style="padding:16px;">Nessuna sessione completata oggi</div>`;
        return;
    }

    container.innerHTML = todaySessions.slice().reverse().map(session => {
        const icon = session.type === 'pomodoro' ? '🍅' : session.type === 'deepwork' ? '🧠' : '⏱️';
        const typeName = session.type === 'pomodoro' ? 'Pomodoro' : session.type === 'deepwork' ? 'Deep Work' : 'Custom';
        const durationMin = Math.round(session.duration / 60);

        return `
            <div class="focus-session-item">
                <div class="focus-session-type">
                    <div class="focus-session-icon">${icon}</div>
                    <div>
                        <div class="focus-session-info">${typeName}</div>
                        <div class="focus-session-meta">${session.time}${session.task ? ' • ' + session.task : ''}</div>
                    </div>
                </div>
                <div class="focus-session-duration">${durationMin}m</div>
            </div>
        `;
    }).join('');
}

function logDistraction() {
    const note = prompt('Cosa ti ha distratto?');
    if (note) {
        focusDistractions.push({
            text: note,
            time: new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
        });
        renderDistractionLog();
        renderFocusStats();
    }
}

function renderDistractionLog() {
    const container = document.getElementById('distractionLog');

    if (focusDistractions.length === 0) {
        container.innerHTML = `<div class="text-muted text-center" style="padding:16px;">Nessuna distrazione registrata 🎉</div>`;
        return;
    }

    container.innerHTML = focusDistractions.map(d => `
        <div class="distraction-item">
            <span class="distraction-text">😵 ${d.text}</span>
            <span class="distraction-time">${d.time}</span>
        </div>
    `).join('');
}

function setFocusTask(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    focusCurrentTask = task ? task.title : null;
    renderCurrentFocusTask();
    closeModal('selectFocusTaskModal');
}

function renderCurrentFocusTask() {
    const container = document.getElementById('currentFocusTask');
    if (focusCurrentTask) {
        container.innerHTML = `
            <span class="task-name">${focusCurrentTask}</span>
            <button class="btn btn-sm btn-secondary" onclick="focusCurrentTask=null;renderCurrentFocusTask();">✕</button>
        `;
    } else {
        container.innerHTML = `
            <div class="text-muted">Nessun task selezionato</div>
            <button class="btn btn-sm btn-primary" onclick="openModal('selectFocusTaskModal')">Seleziona Task</button>
        `;
    }
}

function renderFocusTaskList() {
    const container = document.getElementById('focusTaskList');
    const incompleteTasks = state.tasks.filter(t => !t.completed);

    if (incompleteTasks.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center" style="padding:30px;">
                <div style="font-size:2rem; margin-bottom:8px;">✅</div>
                <div>Nessun task incompleto</div>
                <button class="btn btn-primary mt-2" onclick="closeModal('selectFocusTaskModal'); openModal('addTaskModal')">+ Crea Task</button>
            </div>
        `;
        return;
    }

    container.innerHTML = incompleteTasks.map(task => `
        <div class="task-item" onclick="setFocusTask('${task.id}')" style="cursor:pointer;">
            <div style="display:flex; align-items:center; gap:12px;">
                <div class="priority-indicator priority-${task.priority}"></div>
                <div>
                    <div style="font-weight:600;">${task.title}</div>
                    <div class="text-muted text-sm">${task.project || 'Nessun progetto'}</div>
                </div>
            </div>
        </div>
    `).join('');
}

// Override openModal to populate focus task list when needed
const originalOpenModal = openModal;
openModal = function(modalId) {
    if (modalId === 'selectFocusTaskModal') {
        renderFocusTaskList();
    }
    document.getElementById(modalId).classList.add('active');
};


// ============================================
// DAILY FLOW (Morning/Evening Guided Mode)
// ============================================

let currentFlowStep = 0;
let flowType = 'morning'; // 'morning' or 'evening'

const morningFlow = [
    { title: '🧘 Come ti senti?', action: 'mood', icon: '😊' },
    { title: '😴 Come hai dormito?', action: 'sleep', icon: '🛏️' },
    { title: '🥤 Bevi un bicchiere d\'acqua', action: 'water', icon: '💧' },
    { title: '🌅 S.A.V.E.R.S. Time!', action: 'savers', icon: '✨' },
    { title: '📋 Rivedi i task di oggi', action: 'tasks', icon: '✅' },
    { title: '🎯 Scegli le 3 priorità', action: 'priorities', icon: '🔝' },
    { title: '🍅 Inizia a lavorare!', action: 'focus', icon: '🚀' }
];

const eveningFlow = [
    { title: '✅ Rivedi cosa hai fatto', action: 'review', icon: '📊' },
    { title: '🙏 3 cose per cui sei grato', action: 'gratitude', icon: '💝' },
    { title: '📝 Note della giornata', action: 'notes', icon: '✏️' },
    { title: '📋 Prepara domani', action: 'tomorrow', icon: '📅' },
    { title: '😴 Buonanotte!', action: 'complete', icon: '🌙' }
];

function openDailyFlow() {
    const hour = new Date().getHours();
    flowType = hour < 14 ? 'morning' : 'evening';
    currentFlowStep = 0;
    openModal('dailyFlowModal');
    renderFlowStep();
}

function renderFlowStep() {
    const flow = flowType === 'morning' ? morningFlow : eveningFlow;
    const step = flow[currentFlowStep];
    const container = document.getElementById('dailyFlowContent');
    const progress = ((currentFlowStep + 1) / flow.length) * 100;

    document.getElementById('dailyFlowProgress').style.width = progress + '%';
    document.getElementById('dailyFlowTitle').textContent = flowType === 'morning' ? '🌅 Morning Flow' : '🌙 Evening Flow';

    let content = `
        <div style="text-align:center; padding:20px 0;">
            <div style="font-size:4rem; margin-bottom:16px;">${step.icon}</div>
            <h3 style="margin-bottom:24px; font-size:1.3rem;">${step.title}</h3>
    `;

    // Action-specific content
    switch(step.action) {
        case 'mood':
            content += `
                <div style="display:flex; justify-content:center; gap:16px; font-size:2rem;">
                    <button class="mood-btn" onclick="setFlowMood(5)">😊</button>
                    <button class="mood-btn" onclick="setFlowMood(4)">🙂</button>
                    <button class="mood-btn" onclick="setFlowMood(3)">😐</button>
                    <button class="mood-btn" onclick="setFlowMood(2)">😔</button>
                    <button class="mood-btn" onclick="setFlowMood(1)">😢</button>
                </div>
            `;
            break;

        case 'sleep':
            content += `
                <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
                    ${[4,5,6,7,8,9,10].map(h => `
                        <button class="btn btn-secondary" onclick="setFlowSleep(${h})" style="min-width:60px;">${h}h</button>
                    `).join('')}
                </div>
            `;
            break;

        case 'water':
            content += `
                <button class="btn btn-primary btn-lg" onclick="logFlowWater()">
                    💧 Ho bevuto!
                </button>
            `;
            break;

        case 'savers':
            const routineItems = ['silence', 'affirmations', 'visualization', 'exercise', 'reading', 'scribing'];
            const routineEmoji = { silence: '🧘', affirmations: '💬', visualization: '👁️', exercise: '🏃', reading: '📚', scribing: '✍️' };
            content += `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
                    ${routineItems.map(item => `
                        <button class="btn ${state.today.routine[item] ? 'btn-success' : 'btn-secondary'}"
                            onclick="toggleFlowRoutine('${item}')" style="padding:16px;">
                            <div style="font-size:1.5rem;">${routineEmoji[item]}</div>
                            <div style="font-size:0.75rem; text-transform:capitalize;">${item}</div>
                        </button>
                    `).join('')}
                </div>
                <button class="btn btn-primary mt-3" onclick="nextFlowStep()">Continua →</button>
            `;
            break;

        case 'tasks':
            const todayTasks = state.tasks.filter(t => !t.completed && t.dueDate === state.today.date);
            content += `
                <div style="text-align:left; max-height:200px; overflow-y:auto;">
                    ${todayTasks.length > 0 ? todayTasks.map(t => `
                        <div style="padding:10px; background:var(--bg-secondary); border-radius:8px; margin-bottom:8px;">
                            <span class="priority-indicator priority-${t.priority}" style="margin-right:8px;"></span>
                            ${t.title}
                        </div>
                    `).join('') : '<p class="text-muted">Nessun task per oggi</p>'}
                </div>
                <button class="btn btn-primary mt-3" onclick="nextFlowStep()">Continua →</button>
            `;
            break;

        case 'priorities':
            content += `
                <p class="text-muted mb-2">Quali sono le 3 cose più importanti per oggi?</p>
                <textarea id="flowPriorities" class="form-input" rows="4" placeholder="1. &#10;2. &#10;3. "></textarea>
                <button class="btn btn-primary mt-3" onclick="saveFlowPriorities()">Salva e Continua →</button>
            `;
            break;

        case 'focus':
            content += `
                <p class="text-muted mb-3">Sei pronto per iniziare!</p>
                <button class="btn btn-primary btn-lg" onclick="closeModal('dailyFlowModal'); switchPage('focus');">
                    🚀 Vai alla Focus Mode
                </button>
            `;
            break;

        case 'review':
            const completedToday = state.tasks.filter(t => t.completed && t.completedDate === state.today.date).length;
            const pomodorosToday = state.today.pomodoros || 0;
            content += `
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card">
                        <div class="stat-value">${completedToday}</div>
                        <div class="stat-label">Task</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${pomodorosToday}</div>
                        <div class="stat-label">Pomodori</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="nextFlowStep()">Continua →</button>
            `;
            break;

        case 'gratitude':
            content += `
                <textarea id="flowGratitude" class="form-input" rows="4" placeholder="1. Sono grato per...&#10;2. Sono grato per...&#10;3. Sono grato per..."></textarea>
                <button class="btn btn-primary mt-3" onclick="saveFlowGratitude()">Salva e Continua →</button>
            `;
            break;

        case 'notes':
            content += `
                <textarea id="flowNotes" class="form-input" rows="4" placeholder="Note e riflessioni sulla giornata..."></textarea>
                <button class="btn btn-primary mt-3" onclick="saveFlowNotes()">Salva e Continua →</button>
            `;
            break;

        case 'tomorrow':
            content += `
                <textarea id="flowTomorrow" class="form-input" rows="4" placeholder="Cosa farò domani:&#10;1. &#10;2. &#10;3. "></textarea>
                <button class="btn btn-primary mt-3" onclick="saveFlowTomorrow()">Salva e Continua →</button>
            `;
            break;

        case 'complete':
            content += `
                <p class="text-muted mb-3">Ottimo lavoro oggi! Riposa bene. 🌙</p>
                <button class="btn btn-primary btn-lg" onclick="closeModal('dailyFlowModal');">
                    ✨ Chiudi
                </button>
            `;
            break;
    }

    content += '</div>';
    container.innerHTML = content;
}

function nextFlowStep() {
    const flow = flowType === 'morning' ? morningFlow : eveningFlow;
    if (currentFlowStep < flow.length - 1) {
        currentFlowStep++;
        renderFlowStep();
    }
}

function setFlowMood(level) {
    state.today.mood = level;
    saveStateAndSync();
    showToast('Mood registrato!', 'success');
    nextFlowStep();
}

function setFlowSleep(hours) {
    state.today.sleep = hours;
    saveStateAndSync();
    showToast(`${hours} ore di sonno registrate!`, 'success');
    nextFlowStep();
}

function logFlowWater() {
    state.today.water = (state.today.water || 0) + 1;
    saveStateAndSync();
    showToast('Acqua registrata! 💧', 'success');
    nextFlowStep();
}

function toggleFlowRoutine(item) {
    state.today.routine[item] = !state.today.routine[item];
    saveStateAndSync();
    renderFlowStep();
}

function saveFlowPriorities() {
    const priorities = document.getElementById('flowPriorities').value;
    if (priorities.trim()) {
        // Create a note with priorities
        const note = {
            id: 'n_' + Date.now(),
            title: `Priorità ${formatDate(state.today.date)}`,
            content: priorities,
            tags: ['priorità', 'daily'],
            createdAt: new Date().toISOString()
        };
        state.notes.push(note);
        saveStateAndSync();
        showToast('Priorità salvate!', 'success');
    }
    nextFlowStep();
}

function saveFlowGratitude() {
    const gratitude = document.getElementById('flowGratitude').value;
    if (gratitude.trim()) {
        const note = {
            id: 'n_' + Date.now(),
            title: `Gratitudine ${formatDate(state.today.date)}`,
            content: gratitude,
            tags: ['gratitudine', 'evening'],
            createdAt: new Date().toISOString()
        };
        state.notes.push(note);
        saveStateAndSync();
        showToast('Gratitudine salvata!', 'success');
    }
    nextFlowStep();
}

function saveFlowNotes() {
    const notes = document.getElementById('flowNotes').value;
    if (notes.trim()) {
        const note = {
            id: 'n_' + Date.now(),
            title: `Riflessioni ${formatDate(state.today.date)}`,
            content: notes,
            tags: ['riflessioni', 'evening'],
            createdAt: new Date().toISOString()
        };
        state.notes.push(note);
        saveStateAndSync();
        showToast('Note salvate!', 'success');
    }
    nextFlowStep();
}

function saveFlowTomorrow() {
    const tomorrow = document.getElementById('flowTomorrow').value;
    if (tomorrow.trim()) {
        const note = {
            id: 'n_' + Date.now(),
            title: `Piano per domani`,
            content: tomorrow,
            tags: ['planning', 'tomorrow'],
            createdAt: new Date().toISOString()
        };
        state.notes.push(note);
        saveStateAndSync();
        showToast('Piano salvato!', 'success');
    }
    nextFlowStep();
}

// Check if user should be prompted for Daily Flow
function checkDailyFlowPrompt() {
    const hour = new Date().getHours();
    const lastFlow = localStorage.getItem('lastFlowDate');
    const today = state.today.date;

    // Morning prompt: 6-10 AM, if not done today
    if (hour >= 6 && hour <= 10 && lastFlow !== today + '_morning') {
        setTimeout(() => {
            if (confirm('🌅 Vuoi iniziare con il Morning Flow?')) {
                flowType = 'morning';
                localStorage.setItem('lastFlowDate', today + '_morning');
                openDailyFlow();
            }
        }, 2000);
    }
    // Evening prompt: 8-11 PM, if not done today
    else if (hour >= 20 && hour <= 23 && lastFlow !== today + '_evening') {
        setTimeout(() => {
            if (confirm('🌙 Vuoi fare l\'Evening Review?')) {
                flowType = 'evening';
                localStorage.setItem('lastFlowDate', today + '_evening');
                openDailyFlow();
            }
        }, 2000);
    }
}


// ============================================
// GOALS
// ============================================

function renderGoalsPage() {
    renderGoalsList();
    renderOKRs();
}

function renderGoalsList() {
    const container = document.getElementById('goalsList');

    // Filtra per department
    const goals = filterByDepartment(state.goals);

    if (goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">🎯</div>
                <div class="empty-title">Nessun obiettivo</div>
                <div class="empty-text">Crea il tuo primo obiettivo</div>
            </div>
        `;
        return;
    }

    container.innerHTML = goals.map(goal => {
        const progress = goal.keyResults ? 
            Math.round((goal.keyResults.filter(kr => kr.completed).length / goal.keyResults.length) * 100) : 0;
        
        return `
            <div class="goal-card">
                <div class="goal-header">
                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-progress-text">${progress}%</div>
                </div>
                <div class="goal-bar">
                    <div class="goal-bar-fill" style="width:${progress}%"></div>
                </div>
                ${goal.keyResults && goal.keyResults.length > 0 ? `
                    <div class="key-results">
                        ${goal.keyResults.map((kr, i) => `
                            <div class="key-result ${kr.completed ? 'completed' : ''}" onclick="toggleKeyResult('${goal.id}', ${i})">
                                <div class="kr-checkbox">${kr.completed ? '✓' : ''}</div>
                                <div class="kr-text">${kr.text}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                <div class="text-xs text-muted mt-1">
                    ${goal.period} • Scadenza: ${goal.deadline ? formatDate(goal.deadline) : 'N/D'}
                </div>
            </div>
        `;
    }).join('');
    
    // Update goals progress in home
    const totalGoals = state.goals.length;
    const completedGoals = state.goals.filter(g => {
        if (!g.keyResults) return false;
        return g.keyResults.every(kr => kr.completed);
    }).length;
    const goalsProgress = totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0;
    const goalsProgressEl = document.getElementById('goalsProgress'); if (goalsProgressEl) goalsProgressEl.textContent = goalsProgress + '%';
}

function renderOKRs() {
    const container = document.getElementById('okrsList');
    const okrs = state.goals.filter(g => g.keyResults && g.keyResults.length > 0);
    
    if (okrs.length === 0) {
        container.innerHTML = `<div class="text-muted text-center" style="padding:20px;">Nessun OKR attivo</div>`;
        return;
    }
    
    container.innerHTML = okrs.slice(0, 3).map(goal => {
        const progress = Math.round((goal.keyResults.filter(kr => kr.completed).length / goal.keyResults.length) * 100);
        return `
            <div class="goal-card" style="border-left-color: ${progress >= 70 ? 'var(--success)' : 'var(--primary)'};">
                <div class="goal-header">
                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-progress-text">${progress}%</div>
                </div>
                <div class="goal-bar">
                    <div class="goal-bar-fill" style="width:${progress}%"></div>
                </div>
            </div>
        `;
    }).join('');
}

function addKeyResultInput() {
    const container = document.getElementById('keyResultsContainer');
    const count = container.querySelectorAll('input').length + 1;
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-input mb-1';
    input.placeholder = `Key Result ${count}`;
    container.appendChild(input);
}

function saveGoal() {
    const title = document.getElementById('goalTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    const keyResultInputs = document.querySelectorAll('#keyResultsContainer input');
    const keyResults = Array.from(keyResultInputs)
        .map(input => input.value.trim())
        .filter(text => text)
        .map(text => ({ text, completed: false }));

    const goal = {
        id: 'goal_' + Date.now(),
        title,
        description: document.getElementById('goalDesc').value,
        period: document.getElementById('goalPeriod').value,
        deadline: document.getElementById('goalDeadline').value,
        department: document.getElementById('goalDepartment').value || 'work',
        keyResults,
        createdAt: new Date().toISOString()
    };

    state.goals.push(goal);
    saveStateAndSync();

    // Log per KPI
    logAttivita('obiettivo_creato', 'obiettivi', goal.id, {
        titolo: title,
        periodo: goal.period,
        keyResults: keyResults.length
    });

    // Clear form
    document.getElementById('goalTitle').value = '';
    document.getElementById('goalDesc').value = '';
    document.getElementById('goalDeadline').value = '';
    document.getElementById('keyResultsContainer').innerHTML = '<input type="text" class="form-input mb-1" placeholder="Key Result 1">';

    closeModal('addGoalModal');
    renderGoalsPage();
    updateDepartmentStats();
    addXP(10);
    showToast('Obiettivo creato! +10 XP', 'success');
}

function toggleKeyResult(goalId, krIndex) {
    const goal = state.goals.find(g => g.id === goalId);
    if (!goal || !goal.keyResults[krIndex]) return;

    goal.keyResults[krIndex].completed = !goal.keyResults[krIndex].completed;

    if (goal.keyResults[krIndex].completed) {
        addXP(15);
        showToast('Key Result completato! +15 XP', 'success');

        // Log per KPI
        logAttivita('keyresult_completato', 'obiettivi', goalId, {
            keyResult: goal.keyResults[krIndex].text,
            indice: krIndex
        });
    }

    // Check if goal is complete
    if (goal.keyResults.every(kr => kr.completed)) {
        state.stats.goalsCompleted++;
        addXP(50);
        showToast('🎯 Obiettivo raggiunto! +50 XP', 'success');
        triggerConfetti();

        // Log completamento obiettivo
        logAttivita('obiettivo_completato', 'obiettivi', goalId, {
            titolo: goal.title,
            periodo: goal.period
        });
    }

    saveStateAndSync();
    renderGoalsPage();
    checkBadges();
}

function filterGoals(period) {
    event.target.parentElement.querySelectorAll('.btn').forEach(b => {
        b.className = 'btn btn-sm btn-secondary';
    });
    event.target.className = 'btn btn-sm btn-primary';
    renderGoalsList();
}

// ============================================
// NOTES
// ============================================

function renderNotesPage() {
    renderNotesList();
}

function renderNotesList() {
    const container = document.getElementById('notesList');

    // Filtra per department
    const notes = filterByDepartment(state.notes);

    if (notes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📝</div>
                <div class="empty-title">Nessuna nota</div>
                <div class="empty-text">Cattura le tue idee</div>
            </div>
        `;
        return;
    }

    const sortedNotes = [...notes].sort((a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt)
    );
    
    container.innerHTML = sortedNotes.map(note => `
        <div class="note-card" onclick="viewNote('${note.id}')">
            <div class="note-title">${note.title || 'Senza titolo'}</div>
            <div class="note-preview">${note.content.substring(0, 100)}...</div>
            <div class="note-meta">
                <span>${formatDate(note.createdAt.split('T')[0])}</span>
            </div>
            ${note.tags && note.tags.length > 0 ? `
                <div class="note-tags">
                    ${note.tags.map(tag => `<span class="note-tag">#${tag}</span>`).join('')}
                </div>
            ` : ''}
        </div>
    `).join('');
}

function quickCapture() {
    const text = document.getElementById('quickCaptureText').value.trim();
    if (!text) {
        showToast('Scrivi qualcosa', 'error');
        return;
    }
    
    const note = {
        id: 'note_' + Date.now(),
        title: 'Quick Note',
        content: text,
        tags: [],
        createdAt: new Date().toISOString()
    };
    
    state.notes.push(note);
    state.stats.notesCreated++;
    saveStateAndSync();
    
    document.getElementById('quickCaptureText').value = '';
    renderNotesList();
    addXP(3);
    showToast('Nota salvata! +3 XP', 'success');
    checkBadges();
}

function saveNote() {
    const title = document.getElementById('noteTitle').value.trim();
    const content = document.getElementById('noteContent').value.trim();

    if (!content) {
        showToast('Scrivi qualcosa', 'error');
        return;
    }

    const tagsStr = document.getElementById('noteTags').value;
    const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t);

    const note = {
        id: 'note_' + Date.now(),
        title: title || 'Senza titolo',
        content,
        tags,
        department: document.getElementById('noteDepartment').value || 'work',
        createdAt: new Date().toISOString()
    };

    state.notes.push(note);
    state.stats.notesCreated++;
    saveStateAndSync();

    document.getElementById('noteTitle').value = '';
    document.getElementById('noteContent').value = '';
    document.getElementById('noteTags').value = '';
    
    closeModal('addNoteModal');
    renderNotesList();
    addXP(5);
    showToast('Nota creata! +5 XP', 'success');
    checkBadges();
}

function searchNotes(query) {
    // Simple search implementation
    renderNotesList();
}

// Visualizza una nota specifica
function viewNote(noteId) {
    const note = state.notes.find(n => n.id === noteId);
    if (!note) {
        showToast('Nota non trovata', 'error');
        return;
    }

    // Popola il form con i dati della nota per visualizzazione/modifica
    document.getElementById('noteTitle').value = note.title || '';
    document.getElementById('noteContent').value = note.content || '';

    // Salva l'ID della nota in editing per permettere aggiornamento
    window.currentEditingNoteId = noteId;

    // Apri il modal delle note
    openModal('noteModal');
}

// Alias per compatibilità
function useNoteTemplate(type) {
    useTemplate(type);
}

function useTemplate(type) {
    let content = '';
    let title = '';
    const today = new Date().toLocaleDateString('it-IT');
    const weekNum = getWeekNumber();

    switch(type) {
        case 'daily':
            title = `Daily Note - ${today}`;
            content = `## 🌅 Morning\n\n### Top 3 Priorities\n1. \n2. \n3. \n\n### Gratitude\n- \n\n## 🌙 Evening Review\n\n### What went well?\n- \n\n### What could be improved?\n- \n\n### Tomorrow's focus:\n- `;
            break;
        case 'meeting':
            title = 'Meeting Notes';
            content = `## Meeting: [Titolo]\n\n**Data:** ${today}\n**Partecipanti:** \n\n### Agenda\n1. \n\n### Note\n- \n\n### Action Items\n- [ ] \n\n### Next Steps\n- `;
            break;
        case 'weekly':
            title = `Weekly Review - Settimana ${weekNum}`;
            content = `## 📅 Weekly Review - Settimana ${weekNum}\n\n### 🏆 Wins della Settimana\n- \n\n### 📚 Cosa Ho Imparato\n- \n\n### 🔄 Cosa Migliorare\n- \n\n### 📊 Statistiche\n- Task completati: \n- Pomodori: \n- Routine completate: \n\n### 🎯 Obiettivi Prossima Settimana\n1. \n2. \n3. `;
            break;
        case 'brainstorm':
        case 'idea':
            title = 'Brainstorm';
            content = `## 💡 Brainstorm: [Topic]\n\n### Ideas\n- \n- \n- \n\n### Pros/Cons\n| Pro | Con |\n|-----|-----|\n|     |     |\n\n### Next Actions\n- `;
            break;
        case 'morning':
            title = `Morning Planning - ${today}`;
            content = `## 🌅 Morning Planning - ${today}\n\n### 🎯 Top 3 Priorità di Oggi\n1. \n2. \n3. \n\n### 💭 Intenzione del Giorno\nCosa voglio provare alla fine di oggi?\n\n\n### 📅 Time Blocks\n- 09:00 - \n- 10:00 - \n- 11:00 - \n- 12:00 - \n- 14:00 - \n- 15:00 - \n- 16:00 - \n\n### ⚡ Livello Energia\nCome mi sento? Di cosa ho bisogno?\n\n`;
            break;
        case 'evening':
            title = `Evening Review - ${today}`;
            content = `## 🌙 Evening Review - ${today}\n\n### ✅ Cosa Ho Realizzato\n- \n- \n- \n\n### 📚 Cosa Ho Imparato\n- \n\n### 🙏 Gratitudine\n3 cose per cui sono grato oggi:\n1. \n2. \n3. \n\n### 🔄 Cosa Potrebbe Andare Meglio\n- \n\n### 🎯 Focus di Domani\n- `;
            break;
        case 'weeklyPlan':
            title = `Weekly Plan - Settimana ${weekNum}`;
            content = `## 📅 Weekly Planning - Settimana ${weekNum}\n\n### 🎯 Obiettivi della Settimana\n1. \n2. \n3. \n\n### 📊 Metriche da Monitorare\n- \n- \n\n### 🗓️ Eventi Importanti\n- Lun: \n- Mar: \n- Mer: \n- Gio: \n- Ven: \n- Sab: \n- Dom: \n\n### 💡 Tema della Settimana\n\n`;
            break;
        case 'monthlyReview':
            title = `Monthly Review - ${new Date().toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}`;
            content = `## 📅 Monthly Review\n\n### 🏆 Risultati del Mese\n- \n\n### 📊 Statistiche\n- Task completati: \n- Obiettivi raggiunti: \n- Spese totali: €\n- Risparmi: €\n\n### 📚 Lezioni Apprese\n- \n\n### 🎯 Obiettivi Prossimo Mese\n1. \n2. \n3. \n\n### 💡 Riflessioni\n\n`;
            break;
        case 'quarterlyOKR':
            const quarter = Math.ceil((new Date().getMonth() + 1) / 3);
            const year = new Date().getFullYear();
            title = `OKR Q${quarter} ${year}`;
            content = `## 🎯 OKR Q${quarter} ${year}\n\n### Objective 1: [Titolo Obiettivo]\n**Key Results:**\n- [ ] KR1: [Risultato misurabile]\n- [ ] KR2: [Risultato misurabile]\n- [ ] KR3: [Risultato misurabile]\n\n**Progress:** 0%\n\n---\n\n### Objective 2: [Titolo Obiettivo]\n**Key Results:**\n- [ ] KR1: [Risultato misurabile]\n- [ ] KR2: [Risultato misurabile]\n- [ ] KR3: [Risultato misurabile]\n\n**Progress:** 0%\n\n---\n\n### Objective 3: [Titolo Obiettivo]\n**Key Results:**\n- [ ] KR1: [Risultato misurabile]\n- [ ] KR2: [Risultato misurabile]\n- [ ] KR3: [Risultato misurabile]\n\n**Progress:** 0%\n\n---\n\n### 📊 Tracking Settimanale\n| Settimana | O1 | O2 | O3 | Note |\n|-----------|----|----|----| -----|\n| W1 | 0% | 0% | 0% | |\n| W2 | | | | |\n| W3 | | | | |\n| W4 | | | | |\n\n### 📝 Riflessioni di Fine Trimestre\n\n`;
            break;
    }

    document.getElementById('noteTitle').value = title;
    document.getElementById('noteContent').value = content;
    openModal('addNoteModal');
}

function getWeekNumber() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const diff = now - start;
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    return Math.ceil(diff / oneWeek);
}

// ============================================
// HABITS
// ============================================

function renderHabitsPage() {
    renderTodayHabits();
    updateHabitStats();
}

function renderHabitsList() {
    renderTodayHabits();
}

function renderTodayHabits() {
    // Renderizza in ENTRAMBI i container se esistono
    const containers = [
        document.getElementById('todayHabitsList'),
        document.getElementById('habitsList')
    ].filter(c => c !== null);

    if (containers.length === 0) return;

    // Mostra TUTTE le abitudini (non filtrare per department qui, è confusivo per l'utente)
    const habits = state.habits || [];

    const html = habits.length === 0 ? `
        <div class="empty-state" style="padding:20px;">
            <div class="text-muted">Nessuna abitudine</div>
            <button class="btn btn-sm btn-primary mt-1" onclick="openModal('addHabitModal')">+ Aggiungi</button>
        </div>
    ` : habits.map(habit => {
        const completedToday = habit.completedDates && habit.completedDates.includes(state.today.date);
        const hasSchedule = habit.scheduledTime ? `<span style="font-size:10px;color:var(--primary);">📅 ${habit.scheduledTime}</span>` : '';

        // Protezione: estrai il nome correttamente anche se è un oggetto
        let habitName = habit.name;
        if (typeof habitName === 'object' && habitName !== null) {
            habitName = habitName.name || habitName.title || habitName.text || JSON.stringify(habitName);
        }
        habitName = habitName || 'Abitudine';

        return `
            <div class="habit-item ${completedToday ? 'completed' : ''}" style="position:relative;">
                <div style="display:flex;align-items:center;flex:1;gap:12px;" onclick="toggleHabit('${habit.id}')">
                    <div class="habit-icon">${habit.icon || '✨'}</div>
                    <div class="habit-info">
                        <div class="habit-name">${habitName}</div>
                        <div class="habit-streak">🔥 ${habit.streak || 0} giorni ${hasSchedule}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn btn-sm" style="padding:4px 8px;font-size:12px;" onclick="event.stopPropagation();scheduleHabit('${habit.id}')" title="Schedula in calendario">📅</button>
                    <div class="habit-check ${completedToday ? 'completed' : ''}" onclick="toggleHabit('${habit.id}')">
                        ${completedToday ? '✓' : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Aggiorna tutti i container trovati
    containers.forEach(container => {
        container.innerHTML = html;
    });
}

function toggleHabit(id) {
    const habit = state.habits.find(h => h.id === id);
    if (!habit) return;

    if (!habit.completedDates) habit.completedDates = [];

    const index = habit.completedDates.indexOf(state.today.date);
    if (index > -1) {
        // Uncomplete
        habit.completedDates.splice(index, 1);
        habit.streak = Math.max(0, (habit.streak || 0) - 1);
    } else {
        // Complete
        habit.completedDates.push(state.today.date);
        habit.streak = (habit.streak || 0) + 1;
        addXP(5);

        // Estrai nome correttamente
        const habitName = typeof habit.name === 'object' ? (habit.name?.name || habit.name?.title || 'Abitudine') : (habit.name || 'Abitudine');
        showToast(`${habitName} completato! +5 XP`, 'success');

        // Log per KPI e sync cloud
        logAttivita('abitudine_completata', 'abitudini', id, { nome: habitName, streak: habit.streak });

        // Sincronizza con cloud per LogAbitudini
        if (state.cloudUser?.token) {
            apiCall('logCompletamentoAbitudine', {
                abitudine_id: id,
                completata: true
            }).catch(e => console.warn('Errore sync abitudine:', e));
        }
    }

    saveStateAndSync();
    renderHabitsPage();
    renderRoutinePage();
    updateHabitStats();
    checkBadges();
}

// Schedula un'abitudine in Google Calendar
async function scheduleHabit(habitId) {
    const habit = state.habits.find(h => h.id === habitId);
    if (!habit) return;

    // Estrai nome correttamente
    const habitName = typeof habit.name === 'object' ? (habit.name?.name || habit.name?.title || 'Abitudine') : (habit.name || 'Abitudine');

    if (!isGoogleSignedIn) {
        showToast('Connetti Google Calendar prima', 'warning');
        return;
    }

    // Chiedi orario all'utente
    const timeInput = prompt(`A che ora vuoi fare "${habitName}"?\n\nFormato: HH:MM (es. 07:00, 18:30)`, habit.scheduledTime || '07:00');
    if (!timeInput) return;

    // Valida formato orario
    const timeMatch = timeInput.match(/^(\d{1,2}):(\d{2})$/);
    if (!timeMatch) {
        showToast('Formato orario non valido (usa HH:MM)', 'error');
        return;
    }

    const hours = parseInt(timeMatch[1]);
    const minutes = parseInt(timeMatch[2]);
    if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
        showToast('Orario non valido', 'error');
        return;
    }

    // Salva orario preferito nell'abitudine
    habit.scheduledTime = timeInput;
    saveStateAndSync();

    // Determina durata in base alla frequenza
    const durationMinutes = 30; // Default 30 minuti per abitudine

    // Crea eventi ricorrenti in base alla frequenza
    const today = new Date();
    const startTime = new Date(today);
    startTime.setHours(hours, minutes, 0, 0);

    // Se l'orario è già passato oggi, inizia da domani
    if (startTime <= new Date()) {
        startTime.setDate(startTime.getDate() + 1);
    }

    const endTime = new Date(startTime);
    endTime.setMinutes(endTime.getMinutes() + durationMinutes);

    // Imposta ricorrenza
    let recurrence = [];
    switch (habit.frequency) {
        case 'daily':
            recurrence = ['RRULE:FREQ=DAILY'];
            break;
        case 'weekdays':
            recurrence = ['RRULE:FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR'];
            break;
        case 'weekly':
            recurrence = ['RRULE:FREQ=WEEKLY'];
            break;
        default:
            recurrence = ['RRULE:FREQ=DAILY'];
    }

    try {
        showToast('Creazione evento ricorrente...', 'info');

        const event = await gapi.client.calendar.events.insert({
            calendarId: selectedCalendarId,
            resource: {
                summary: `${habit.icon} ${habitName}`,
                description: `Abitudine - ${habit.frequency}\n\n🔥 Streak attuale: ${habit.streak || 0} giorni\n\nCreato da Mago Max S.A.V.E.R.S.`,
                start: {
                    dateTime: startTime.toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: endTime.toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                recurrence: recurrence,
                reminders: {
                    useDefault: false,
                    overrides: [
                        { method: 'popup', minutes: 10 }
                    ]
                },
                colorId: '9' // Blu - colore per abitudini
            }
        });

        if (event.result) {
            habit.calendarEventId = event.result.id;
            saveStateAndSync();
            renderHabitsPage();
            showToast(`📅 "${habitName}" schedulato alle ${timeInput}!`, 'success');
        }
    } catch (error) {
        console.error('Errore scheduling abitudine:', error);
        showToast('Errore creazione evento', 'error');
    }
}

// Schedula tutte le abitudini non ancora schedulate
async function scheduleAllHabits() {
    if (!isGoogleSignedIn) {
        showToast('Connetti Google Calendar prima', 'warning');
        return;
    }

    const unscheduled = state.habits.filter(h => !h.calendarEventId);
    if (unscheduled.length === 0) {
        showToast('Tutte le abitudini sono già schedulate', 'info');
        return;
    }

    let scheduled = 0;
    for (const habit of unscheduled) {
        // Estrai nome correttamente
        const habitName = typeof habit.name === 'object' ? (habit.name?.name || habit.name?.title || '') : (habit.name || '');
        const nameLower = habitName.toLowerCase();

        // Assegna orari predefiniti in base al tipo
        let defaultTime = '07:00';
        if (nameLower.includes('sera') || nameLower.includes('notte')) {
            defaultTime = '21:00';
        } else if (nameLower.includes('pranzo') || nameLower.includes('mezzogiorno')) {
            defaultTime = '12:30';
        } else if (nameLower.includes('mattina') || nameLower.includes('sveglia')) {
            defaultTime = '06:30';
        }

        habit.scheduledTime = defaultTime;
    }

    saveStateAndSync();
    showToast(`${unscheduled.length} abitudini pronte per essere schedulate. Clicca 📅 su ciascuna per impostare l'orario.`, 'info');
    renderHabitsPage();
}

function updateHabitStats() {
    const completed = state.habits.filter(h => 
        h.completedDates && h.completedDates.includes(state.today.date)
    ).length;
    const total = state.habits.length;
    const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
    
    if (document.getElementById('habitsCompletedToday')) {
        document.getElementById('habitsCompletedToday').textContent = completed;
        document.getElementById('habitsTotalToday').textContent = total;
        document.getElementById('habitsRateToday').textContent = rate + '%';
    }
    
    // Update streak
    const maxStreak = state.habits.reduce((max, h) => Math.max(max, h.streak || 0), 0);
    if (document.getElementById('habitStreak')) {
        document.getElementById('habitStreak').textContent = maxStreak;
    }
}

// selectedHabitIcon already declared above

function selectHabitIcon(icon) {
    selectedHabitIcon = icon;
    document.getElementById('habitIcon').value = icon;
    document.querySelectorAll('.habit-icon-btn').forEach(b => b.classList.remove('btn-primary'));
    event.target.classList.add('btn-primary');
}

function saveHabit() {
    const name = document.getElementById('habitName').value.trim();
    if (!name) {
        showToast('Inserisci un nome', 'error');
        return;
    }

    const habit = {
        id: 'habit_' + Date.now(),
        name,
        icon: selectedHabitIcon,
        frequency: document.getElementById('habitFrequency').value,
        department: document.getElementById('habitDepartment').value || 'personal',
        streak: 0,
        completedDates: [],
        createdAt: new Date().toISOString()
    };

    state.habits.push(habit);
    saveStateAndSync();

    document.getElementById('habitName').value = '';

    closeModal('addHabitModal');
    renderHabitsPage();
    renderRoutinePage();
    updateDepartmentStats();
    addXP(5);
    showToast('Abitudine creata! +5 XP', 'success');
}

// ============================================
// MOOD & WELLNESS
// ============================================

// selectedMood already declared above
// selectedSleepQuality already declared above

function selectMood(value) {
    selectedMood = value;
    document.querySelectorAll('#moodModal .mood-option').forEach((el, i) => {
        el.style.opacity = (i + 1) === value ? '1' : '0.4';
        el.style.transform = (i + 1) === value ? 'scale(1.2)' : 'scale(1)';
    });
}

function saveMood() {
    if (!selectedMood) {
        showToast('Seleziona il tuo mood', 'error');
        return;
    }
    
    state.today.mood = selectedMood;
    state.today.moodNote = document.getElementById('moodNote').value;
    
    saveStateAndSync();
    closeModal('moodModal');
    updateAllStats();
    addXP(5);
    showToast('Mood registrato! +5 XP', 'success');
}

function selectSleepQuality(value) {
    selectedSleepQuality = value;
    document.querySelectorAll('#sleepModal .mood-option').forEach((el, i) => {
        el.style.opacity = (i + 1) === value ? '1' : '0.4';
        el.style.transform = (i + 1) === value ? 'scale(1.2)' : 'scale(1)';
    });
}

function saveSleep() {
    const bedtime = document.getElementById('sleepBedtime').value;
    const wakeup = document.getElementById('sleepWakeup').value;
    
    if (!bedtime || !wakeup) {
        showToast('Inserisci gli orari', 'error');
        return;
    }
    
    // Calculate hours
    const [bedH, bedM] = bedtime.split(':').map(Number);
    const [wakeH, wakeM] = wakeup.split(':').map(Number);
    let bedMins = bedH * 60 + bedM;
    let wakeMins = wakeH * 60 + wakeM;
    if (wakeMins < bedMins) wakeMins += 24 * 60;
    const sleepHours = ((wakeMins - bedMins) / 60).toFixed(1);
    
    state.today.sleep = parseFloat(sleepHours);
    state.today.sleepQuality = selectedSleepQuality;
    
    saveStateAndSync();
    closeModal('sleepModal');
    updateAllStats();
    addXP(5);
    showToast('Sonno registrato! +5 XP', 'success');
}

function adjustWater(delta) {
    state.today.water = Math.max(0, Math.min(12, state.today.water + delta));
    document.getElementById('waterDisplayLarge').textContent = `💧 ${state.today.water}/8`;
    document.getElementById('waterValue').textContent = `${state.today.water}/8`;
    
    if (state.today.water === 8) {
        state.stats.hydrationStreak++;
        addXP(10);
        showToast('💧 Obiettivo idratazione! +10 XP', 'success');
    }
    
    saveStateAndSync();
    checkBadges();
}


// ============================================
// ANALYTICS
// ============================================

let productivityChartInstance = null;
let financeChartInstance = null;

function initCharts() {
    initProductivityChart();
    initFinanceChart();
}

function renderAnalyticsPage() {
    initCharts();
    renderHabitHeatmap();
    renderTimeDistribution();
    renderBadgesGrid();
    updateAnalyticsStats();
}

function initProductivityChart() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded yet, skipping chart initialization');
        return;
    }

    const canvas = document.getElementById('productivityChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const days = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

    // Generate data from actual tasks
    const data = days.map((day, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - i));
        const dateStr = date.toISOString().split('T')[0];

        // Calculate score for that day
        const dayTasks = state.tasks.filter(t => t.completedDate === dateStr).length;
        const dayPomodoros = (state.timeLogs || []).filter(l => l.date === dateStr).length;
        const score = Math.min(100, (dayTasks * 10) + (dayPomodoros * 15));

        return score;
    });

    // Destroy old chart if exists
    if (productivityChartInstance) {
        productivityChartInstance.destroy();
    }

    productivityChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [{
                label: 'Produttività',
                data: data,
                backgroundColor: 'rgba(99, 102, 241, 0.7)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 1,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
}

function initFinanceChart() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded yet, skipping finance chart initialization');
        return;
    }

    const canvas = document.getElementById('financeChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const days = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

    // Generate data from actual transactions
    const expenseData = days.map((day, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - i));
        const dateStr = date.toISOString().split('T')[0];

        // Sum expenses for that day
        const dayExpenses = state.transactions
            .filter(t => t.date === dateStr && t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);

        return dayExpenses;
    });

    const incomeData = days.map((day, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - i));
        const dateStr = date.toISOString().split('T')[0];

        // Sum income for that day
        const dayIncome = state.transactions
            .filter(t => t.date === dateStr && t.type === 'income')
            .reduce((sum, t) => sum + t.amount, 0);

        return dayIncome;
    });

    // Destroy old chart if exists
    if (financeChartInstance) {
        financeChartInstance.destroy();
    }

    financeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [
                {
                    label: 'Entrate',
                    data: incomeData,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1,
                    borderRadius: 8
                },
                {
                    label: 'Uscite',
                    data: expenseData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                    borderRadius: 8
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                        callback: function(value) {
                            return state.settings.currency + value;
                        }
                    }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });
}

function renderHabitHeatmap() {
    const container = document.getElementById('habitHeatmap');
    const cells = [];
    
    for (let i = 27; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        // Count habits completed that day
        const completed = state.habits.filter(h => 
            h.completedDates && h.completedDates.includes(dateStr)
        ).length;
        
        let level = 0;
        if (completed > 0) level = 1;
        if (completed >= 2) level = 2;
        if (completed >= 4) level = 3;
        if (completed >= 6) level = 4;
        
        cells.push(`<div class="heatmap-day level-${level}" title="${dateStr}: ${completed} abitudini"></div>`);
    }
    
    container.innerHTML = cells.join('');
}

function renderTimeDistribution() {
    const container = document.getElementById('timeDistribution');
    
    // Group time logs by project
    const byProject = {};
    state.timeLogs.forEach(log => {
        byProject[log.project] = (byProject[log.project] || 0) + log.duration;
    });
    
    if (Object.keys(byProject).length === 0) {
        container.innerHTML = `<div class="text-muted text-center" style="padding:20px;">Nessun dato</div>`;
        return;
    }
    
    const total = Object.values(byProject).reduce((a, b) => a + b, 0);
    
    container.innerHTML = Object.entries(byProject).map(([project, seconds]) => {
        const hours = (seconds / 3600).toFixed(1);
        const percentage = Math.round((seconds / total) * 100);
        
        return `
            <div class="budget-item">
                <div class="budget-header">
                    <div class="budget-category">${project}</div>
                    <div class="budget-amounts">${hours}h (${percentage}%)</div>
                </div>
                <div class="budget-bar">
                    <div class="budget-progress safe" style="width:${percentage}%"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderBadgesGrid() {
    const container = document.getElementById('badgesGrid');
    
    container.innerHTML = BADGES.map(badge => {
        const unlocked = state.stats.unlockedBadges.includes(badge.id);
        return `
            <div class="badge-item ${unlocked ? '' : 'locked'}">
                <div class="badge-icon">${badge.icon}</div>
                <div class="badge-name">${badge.name}</div>
                <div class="badge-desc">${badge.desc}</div>
            </div>
        `;
    }).join('');
}

function updateAnalyticsStats() {
    document.getElementById('totalXP').textContent = state.stats.totalXP;
    const avgFocusScoreEl = document.getElementById('avgFocusScore'); if (avgFocusScoreEl) avgFocusScoreEl.textContent = state.today.focusScore;
    document.getElementById('totalDays').textContent = state.stats.totalDays;
    document.getElementById('badgesEarned').textContent = state.stats.unlockedBadges.length;
}

// ============================================
// SETTINGS
// ============================================

function toggleSetting(setting) {
    // Mappa i nomi delle impostazioni ai toggle ID
    let toggleId = setting + 'Toggle';
    if (setting === 'notifications') toggleId = 'notifToggle';
    if (setting === 'notificationSound') toggleId = 'notifSoundToggle';

    const toggle = document.getElementById(toggleId);
    if (!toggle) return;

    const enabled = toggle.classList.toggle('active');
    state.settings[setting] = enabled;

    if (setting === 'notifications' && enabled) {
        requestNotificationPermission();
    }

    // Test suono se attivato
    if (setting === 'notificationSound' && enabled) {
        playNotificationSound();
    }

    saveStateAndSync();
    showToast(enabled ? 'Attivato' : 'Disattivato', 'success');
}

function toggleDarkMode() {
    const toggle = document.getElementById('darkModeToggle');
    const enabled = toggle.classList.toggle('active');
    
    document.body.classList.toggle('theme-dark', enabled);
    state.settings.darkMode = enabled;
    
    saveStateAndSync();
}

function saveSetting(key, value) {
    state.settings[key] = value;
    
    if (key === 'pomodoroDuration') {
        pomodoroTime = parseInt(value) * 60;
        updatePomodoroDisplay();
    }
    
    saveStateAndSync();
    showToast('Impostazione salvata', 'success');
}

async function requestNotificationPermission() {
    // Usa il nuovo sistema push notifications se disponibile
    if (typeof pushNotifications !== 'undefined' && pushNotifications.registration) {
        const granted = await pushNotifications.requestPermission();
        if (granted) {
            // Schedula tutti i reminder
            scheduleAllReminders();
        }
        return;
    }

    // Fallback al sistema base
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showToast('Notifiche attivate! 🔔', 'success');
                if (typeof scheduleAllReminders === 'function') {
                    scheduleAllReminders();
                }
            }
        });
    }
}

// ============================================
// DATA MANAGEMENT
// ============================================

function exportAllData() {
    const data = {
        ...state,
        exportDate: new Date().toISOString(),
        version: '4.0'
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `savers_pro_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();

    showToast('Dati esportati! 📤', 'success');
}

// Alias per compatibilità con bottone
function exportData() {
    exportAllData();
}

// Export spese/entrate in formato CSV
function exportTransactionsCSV() {
    if (!state.transactions || state.transactions.length === 0) {
        showToast('Nessuna transazione da esportare', 'warning');
        return;
    }

    // Categorie per label
    const categoryLabels = {
        food: 'Cibo',
        transport: 'Trasporti',
        shopping: 'Shopping',
        health: 'Salute',
        bills: 'Bollette',
        entertainment: 'Intrattenimento',
        education: 'Formazione',
        home: 'Casa',
        other: 'Altro'
    };

    // Header CSV
    const headers = ['Data', 'Tipo', 'Importo', 'Descrizione', 'Categoria', 'Metodo Pagamento'];

    // Ordina per data (più recenti prima)
    const sortedTransactions = [...state.transactions].sort((a, b) =>
        new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt)
    );

    // Righe CSV
    const rows = sortedTransactions.map(tx => {
        const date = tx.date || tx.createdAt?.split('T')[0] || '';
        const type = tx.type === 'income' ? 'Entrata' : 'Uscita';
        const amount = tx.type === 'income' ? tx.amount.toFixed(2) : '-' + tx.amount.toFixed(2);
        const description = (tx.description || '').replace(/"/g, '""'); // Escape quotes
        const category = categoryLabels[tx.category] || tx.category || 'Altro';
        const method = tx.method === 'cash' ? 'Contanti' : tx.method === 'card' ? 'Carta' : 'Bonifico';

        return [date, type, amount, `"${description}"`, category, method].join(';');
    });

    // Aggiungi totali
    const totalIncome = sortedTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = sortedTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

    rows.push(''); // Riga vuota
    rows.push(`;;${totalIncome.toFixed(2)};Totale Entrate;;`);
    rows.push(`;;-${totalExpense.toFixed(2)};Totale Uscite;;`);
    rows.push(`;;${(totalIncome - totalExpense).toFixed(2)};Saldo;;`);

    // Crea file CSV
    const csvContent = '\uFEFF' + headers.join(';') + '\n' + rows.join('\n'); // BOM per Excel
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    // Download
    const link = document.createElement('a');
    link.href = url;
    link.download = `spese_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    showToast(`Esportate ${sortedTransactions.length} transazioni`, 'success');
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const imported = JSON.parse(event.target.result);
                state = { ...state, ...imported };
                saveStateAndSync();
                location.reload();
            } catch (err) {
                showToast('Errore nel file', 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function confirmClearData() {
    if (confirm('⚠️ Sei sicuro di voler cancellare TUTTI i dati? Questa azione è irreversibile!')) {
        if (confirm('Ultima conferma: tutti i tuoi dati verranno eliminati.')) {
            localStorage.removeItem('savers_pro_state');
            location.reload();
        }
    }
}

// ============================================
// KEYBOARD SHORTCUTS
// ============================================

document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + N = New Task
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        openModal('quickAddModal');
    }
    
    // Escape = Close modal
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => {
            m.classList.remove('active');
        });
    }
    
    // Space = Toggle pomodoro (when not in input)
    if (e.key === ' ' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
        e.preventDefault();
        togglePomodoro();
    }
});

// ============================================
// SERVICE WORKER (PWA) & PUSH NOTIFICATIONS
// ============================================
// Attivo per hosting tradizionale con sw.js e manifest.json

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('✅ Service Worker registered:', registration.scope);

                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateAvailableToast();
                        }
                    });
                });

                // Setup push notifications
                setupPushNotifications(registration);
            })
            .catch(error => {
                console.log('Service Worker registration failed:', error);
            });
    });
}

// Mostra toast aggiornamento disponibile
function showUpdateAvailableToast() {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: calc(80px + env(safe-area-inset-bottom));
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 99999;
    `;
    toast.innerHTML = `
        <span>🆕 Nuova versione disponibile!</span>
        <button onclick="location.reload()" style="background:white;color:var(--primary);border:none;padding:6px 12px;border-radius:6px;font-weight:600;cursor:pointer;">Aggiorna</button>
    `;
    document.body.appendChild(toast);
}

// ============================================
// PUSH NOTIFICATIONS SYSTEM
// ============================================

const pushNotifications = {
    registration: null,
    subscription: null,

    async setup(registration) {
        this.registration = registration;

        // Controlla se già sottoscritto
        this.subscription = await registration.pushManager.getSubscription();

        if (this.subscription) {
            console.log('📬 Push già sottoscritto');
        }
    },

    // Richiedi permesso e sottoscrivi
    async requestPermission() {
        if (!('Notification' in window)) {
            showToast('Notifiche non supportate', 'warning');
            return false;
        }

        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
            console.log('✅ Permesso notifiche concesso');
            await this.subscribe();
            return true;
        } else {
            console.log('❌ Permesso notifiche negato');
            showToast('Notifiche disabilitate', 'warning');
            return false;
        }
    },

    async subscribe() {
        if (!this.registration) return;

        try {
            // Nota: per un vero sistema push serve una VAPID key dal backend
            // Per ora usiamo notifiche locali
            this.subscription = await this.registration.pushManager.subscribe({
                userVisibleOnly: true,
                // applicationServerKey: 'YOUR_VAPID_PUBLIC_KEY' // Necessario per push reali
            });

            console.log('📬 Push sottoscritto:', this.subscription);
            showToast('Notifiche attivate! 🔔', 'success');
        } catch (error) {
            console.error('Errore sottoscrizione push:', error);
        }
    },

    // Invia notifica locale (per reminder)
    async sendLocalNotification(title, body, data = {}) {
        if (Notification.permission !== 'granted') return;

        if (this.registration) {
            this.registration.showNotification(title, {
                body,
                icon: './icon-192.png',
                badge: './icon-192.png',
                vibrate: [100, 50, 100],
                data,
                actions: [
                    { action: 'open', title: 'Apri' },
                    { action: 'dismiss', title: 'Chiudi' }
                ]
            });
        } else {
            // Fallback a notifica browser standard
            new Notification(title, { body, icon: './icon-192.png' });
        }
    },

    // Schedula reminder per evento
    scheduleEventReminder(event, minutesBefore = 15) {
        const eventTime = new Date(event.start?.dateTime || event.date + 'T' + (event.startTime || '09:00'));
        const reminderTime = eventTime.getTime() - (minutesBefore * 60 * 1000);
        const now = Date.now();

        if (reminderTime > now) {
            const delay = reminderTime - now;
            setTimeout(() => {
                this.sendLocalNotification(
                    `⏰ ${event.summary || event.title}`,
                    `Tra ${minutesBefore} minuti`,
                    { eventId: event.id }
                );
            }, delay);

            console.log(`📅 Reminder schedulato per ${event.summary || event.title} tra ${Math.round(delay/60000)} min`);
        }
    },

    // Schedula reminder per task in scadenza
    scheduleTaskReminder(task) {
        if (!task.due) return;

        const dueDate = new Date(task.due);
        const reminderTime = dueDate.getTime() - (60 * 60 * 1000); // 1 ora prima
        const now = Date.now();

        if (reminderTime > now) {
            setTimeout(() => {
                this.sendLocalNotification(
                    `📋 Task in scadenza`,
                    task.title,
                    { taskId: task.id }
                );
            }, reminderTime - now);
        }
    }
};

// Setup push quando SW è pronto
async function setupPushNotifications(registration) {
    await pushNotifications.setup(registration);

    // Se l'utente ha già attivato le notifiche, schedula reminder
    if (Notification.permission === 'granted') {
        scheduleAllReminders();
    }
}

// Schedula tutti i reminder per eventi di oggi
function scheduleAllReminders() {
    const today = new Date().toISOString().split('T')[0];

    // Reminder per eventi Google Calendar
    (state.calendarEvents || []).forEach(event => {
        const eventDate = event.start?.dateTime?.split('T')[0] || event.start?.date;
        if (eventDate === today) {
            pushNotifications.scheduleEventReminder(event, 15);
        }
    });

    // Reminder per eventi locali
    (state.events || []).forEach(event => {
        if (event.date === today) {
            pushNotifications.scheduleEventReminder(event, 15);
        }
    });

    // Reminder per task in scadenza oggi
    (state.tasks || []).filter(t => !t.done && t.due === today).forEach(task => {
        pushNotifications.scheduleTaskReminder(task);
    });

    console.log('📅 Reminder schedulati per oggi');
}

// Sincronizza quando l'utente lascia la pagina (se ci sono modifiche pendenti)
window.addEventListener('beforeunload', (e) => {
    // Sincronizza su Google Sheets prima di chiudere
    if (isLoggedIn && currentUser) {
        // Usa sendBeacon per sync asincrono che sopravvive alla chiusura
        const payload = JSON.stringify({
            action: 'syncFullState',
            state: state,
            token: currentUser?.token
        });

        // sendBeacon è il metodo più affidabile per salvare alla chiusura
        const sent = navigator.sendBeacon(CONFIG.API_URL, payload);
        console.log('📤 beforeunload sendBeacon:', sent ? 'sent' : 'failed');

        // Se sendBeacon fallisce, usa XMLHttpRequest sincrono
        if (!sent) {
            try {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', CONFIG.API_URL, false); // false = sincrono
                xhr.setRequestHeader('Content-Type', 'text/plain;charset=utf-8');
                xhr.send(payload);
            } catch (err) {
                console.warn('Sync on unload failed:', err);
            }
        }
    }
});

// Sincronizza anche quando l'app torna in primo piano
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && isLoggedIn && currentUser) {
        // L'app è tornata in primo piano - verifica se ci sono aggiornamenti dal cloud
        console.log('📱 App tornata in primo piano - checking for updates...');
        // Non caricare automaticamente per evitare conflitti, ma aggiorna l'indicatore
        lastStateHash = getStateHash();
    }
});

// ============================================
// INITIALIZATION
// ============================================

// Set user info in settings
const settingsNameEl = document.getElementById('settingsName');
if (settingsNameEl) settingsNameEl.textContent = state.user.name;

// Apply saved settings
if (state.settings.notifications) {
    document.getElementById('notifToggle')?.classList.add('active');
}
if (state.settings.notificationSound !== false) {
    document.getElementById('notifSoundToggle')?.classList.add('active');
}
if (state.settings.darkMode) {
    document.getElementById('darkModeToggle')?.classList.add('active');
    document.body.classList.add('theme-dark');
}
document.getElementById('pomodoroDuration').value = state.settings.pomodoroDuration;
document.getElementById('breakDuration').value = state.settings.breakDuration;
document.getElementById('monthlyBudgetInput').value = state.settings.monthlyBudget;
document.getElementById('currencySelect').value = state.settings.currency;

// Initial render
renderPomodoroSessions();

console.log('🚀 Mago Max S.A.V.E.R.S. v4.0 Loaded!');

// ============================================
// HOME PAGE - MISSING FUNCTIONS
// ============================================

function renderHomePage() {
    updateDateTime();
    updateGreeting();
    renderTop3Tasks();
    renderTodaySchedule();
    renderTodayFinance();
    updatePomodoroDisplay();
    renderPomodoroSessions();
    updateAllStats();
    updateDepartmentStats(); // Aggiorna bilancia vita/lavoro
}

function renderTop3Tasks() {
    const container = document.getElementById('top3TasksList');
    if (!container) return;
    
    const top3 = state.tasks.filter(t => t.isTop3 && !t.completed).slice(0, 3);
    
    if (top3.length === 0) {
        container.innerHTML = '<div class="text-center text-muted" style="padding:20px;">Nessuna priorità impostata<br><button class="btn btn-sm btn-primary mt-1" onclick="openModal(\'addTaskModal\')">+ Aggiungi Task</button></div>';
        return;
    }
    
    container.innerHTML = top3.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}">
            <div class="task-checkbox" onclick="event.stopPropagation(); toggleTask('${task.id}')">${task.completed ? '✓' : ''}</div>
            <div class="task-content" onclick="toggleTask('${task.id}')">
                <div class="task-title">${task.title}</div>
                <div class="task-meta">
                    <span class="task-tag"><span class="task-priority priority-${task.priority}"></span> ${task.priority}</span>
                    ${task.estimate ? '<span class="task-tag">⏱️ ' + task.estimate + 'm</span>' : ''}
                </div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); editTask('${task.id}')" title="Modifica">✏️</button>
        </div>
    `).join('');
}

function renderTodaySchedule() {
    const container = document.getElementById('motivationQuote');
    if (!container) return;
    
    const todayBlocks = state.timeBlocks.filter(b => b.date === state.today.date);
    
    if (todayBlocks.length === 0) {
        container.innerHTML = '<div class="text-center text-muted" style="padding:15px;">Nessun time block</div>';
        return;
    }
    
    container.innerHTML = todayBlocks.sort((a, b) => a.start.localeCompare(b.start)).map(block => `
        <div class="time-block">
            <div class="time-block-title">${block.title}</div>
            <div class="time-block-duration">${block.start} - ${block.end}</div>
        </div>
    `).join('');
}

function renderTodayFinance() {
    const todayTx = state.transactions.filter(t => t.date === state.today.date);
    const income = todayTx.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
    const expenses = todayTx.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
    
    const todayIncomeEl = document.getElementById('todayIncome');
    const todayExpensesEl = document.getElementById('todayExpense');
    
    if (todayIncomeEl) todayIncomeEl.textContent = formatCurrency(income);
    if (todayExpensesEl) todayExpensesEl.textContent = formatCurrency(expenses);
}

// ============================================
// TASKS PAGE - MISSING FUNCTIONS
// ============================================

function renderTasksPage() {
    renderTasksList();
    renderKanban();
    renderMatrix();
}

function renderTasksList() {
    const container = document.getElementById('tasksList');
    if (!container) return;

    const today = new Date().toISOString().split('T')[0];
    const weekFromNow = new Date();
    weekFromNow.setDate(weekFromNow.getDate() + 7);
    const weekEnd = weekFromNow.toISOString().split('T')[0];

    // Filtra per department
    let tasks = filterByDepartment(state.tasks);

    // Applica il filtro corrente
    switch (currentTaskFilter) {
        case 'today':
            tasks = tasks.filter(t => !t.completed && t.due === today);
            break;
        case 'week':
            tasks = tasks.filter(t => !t.completed && t.due && t.due >= today && t.due <= weekEnd);
            break;
        case 'done':
            tasks = tasks.filter(t => t.completed);
            break;
        case 'all':
        default:
            tasks = tasks.filter(t => !t.completed);
            break;
    }

    // Messaggio vuoto appropriato
    if (tasks.length === 0) {
        let emptyMsg = 'Nessun task';
        let emptyText = 'Aggiungi il tuo primo task';

        if (currentTaskFilter === 'today') {
            emptyMsg = 'Nessun task per oggi';
            emptyText = 'Non hai task con scadenza oggi';
        } else if (currentTaskFilter === 'week') {
            emptyMsg = 'Nessun task questa settimana';
            emptyText = 'Non hai task con scadenza nei prossimi 7 giorni';
        } else if (currentTaskFilter === 'done') {
            emptyMsg = 'Nessun task completato';
            emptyText = 'Completa i tuoi task per vederli qui';
        }

        container.innerHTML = `<div class="empty-state"><div class="empty-icon">📋</div><div class="empty-title">${emptyMsg}</div><div class="empty-text">${emptyText}</div></div>`;
        return;
    }

    container.innerHTML = tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''} dept-${task.department || 'work'}" data-id="${task.id}" data-task-id="${task.id}" draggable="true" ondragstart="handleDragStart(event, '${task.id}')" ondragend="handleDragEnd(event)">
            <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="event.stopPropagation(); toggleTask('${task.id}')">${task.completed ? '✓' : ''}</div>
            <div class="task-content">
                <div class="task-title ${task.completed ? 'line-through' : ''}">${task.title}</div>
                <div class="task-meta">
                    <span class="task-tag"><span class="task-priority priority-${task.priority}"></span></span>
                    <span class="task-category-badge category-${task.category}">${getCategoryIcon(task.category)}</span>
                    <span class="dept-badge dept-badge-${task.department || 'work'}">${task.department === 'personal' ? '👤' : '🎭'}</span>
                    ${task.due ? '<span class="task-due ' + (isToday(task.due) ? 'today' : '') + '">' + formatDate(task.due) + '</span>' : ''}
                    ${task.completed ? '<span class="completed-badge">✅ Completato</span>' : ''}
                </div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); editTask('${task.id}')" title="Modifica">✏️</button>
            <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); deleteTask('${task.id}')" title="Elimina">🗑️</button>
        </div>
    `).join('');

    // Setup touch drag
    setTimeout(() => initTouchDragDrop(), 100);
}

function renderKanban() {
    const todo = state.tasks.filter(t => !t.completed && t.status !== 'progress');
    const progress = state.tasks.filter(t => t.status === 'progress' && !t.completed);
    const done = state.tasks.filter(t => t.completed).slice(0, 10);

    // Task delegati a me da progetti team
    const delegatedTasks = getMyDelegatedTasks();

    const kanbanDelegated = document.getElementById('kanbanDelegated');
    const kanbanTodo = document.getElementById('kanbanTodo');
    const kanbanProgress = document.getElementById('kanbanProgress');
    const kanbanDone = document.getElementById('kanbanDone');

    // Render task delegati con badge del progetto
    if (kanbanDelegated) {
        kanbanDelegated.innerHTML = delegatedTasks.map(t => renderDelegatedTask(t)).join('') ||
            '<div class="text-muted text-center" style="padding:20px;font-size:0.8rem;">Nessun task delegato a te</div>';
    }

    if (kanbanTodo) kanbanTodo.innerHTML = todo.map(t => renderKanbanTask(t)).join('');
    if (kanbanProgress) kanbanProgress.innerHTML = progress.map(t => renderKanbanTask(t)).join('');
    if (kanbanDone) kanbanDone.innerHTML = done.map(t => renderKanbanTask(t)).join('');

    if (document.getElementById('kanbanDelegatedCount')) document.getElementById('kanbanDelegatedCount').textContent = delegatedTasks.length;
    if (document.getElementById('kanbanTodoCount')) document.getElementById('kanbanTodoCount').textContent = todo.length;
    if (document.getElementById('kanbanProgressCount')) document.getElementById('kanbanProgressCount').textContent = progress.length;
    if (document.getElementById('kanbanDoneCount')) document.getElementById('kanbanDoneCount').textContent = done.length;

    // Setup drag & drop per le colonne Kanban (incluso touch)
    setupAllDragDrop();
}

// Raccoglie tutti i task assegnati all'utente corrente dai progetti team
function getMyDelegatedTasks() {
    const myEmail = state.cloudUser?.email?.toLowerCase();
    const myUsername = currentUser?.username?.toLowerCase();
    const myNickname = currentUser?.nickname?.toLowerCase();

    if (!myEmail && !myUsername) return [];

    const delegatedTasks = [];

    // Cerca nei progetti propri
    (state.teamProjects || []).forEach(project => {
        const allTasks = [
            ...(project.columns?.todo || []),
            ...(project.columns?.progress || []),
            ...(project.columns?.done || [])
        ];

        allTasks.forEach(task => {
            if (isTaskAssignedToMe(task, myEmail, myUsername, myNickname)) {
                delegatedTasks.push({
                    ...task,
                    projectName: project.name,
                    projectId: project.id,
                    projectOwner: 'Tu',
                    isFromShared: false
                });
            }
        });
    });

    // Cerca nei progetti condivisi con me
    (state.sharedProjects || []).forEach(shared => {
        const project = shared.data || shared;
        const allTasks = [
            ...(project.columns?.todo || []),
            ...(project.columns?.progress || []),
            ...(project.columns?.done || [])
        ];

        allTasks.forEach(task => {
            if (isTaskAssignedToMe(task, myEmail, myUsername, myNickname)) {
                delegatedTasks.push({
                    ...task,
                    projectName: shared.name || project.name,
                    projectId: shared.id || project.id,
                    projectOwner: shared.ownerUsername || shared.ownerEmail,
                    isFromShared: true
                });
            }
        });
    });

    // Ordina per status e deadline
    return delegatedTasks.sort((a, b) => {
        // Prima i task non completati
        if (a.status === 'done' && b.status !== 'done') return 1;
        if (a.status !== 'done' && b.status === 'done') return -1;
        // Poi per deadline
        if (a.deadline && b.deadline) return new Date(a.deadline) - new Date(b.deadline);
        if (a.deadline) return -1;
        if (b.deadline) return 1;
        return 0;
    });
}

// Verifica se un task è assegnato all'utente corrente
function isTaskAssignedToMe(task, myEmail, myUsername, myNickname) {
    const assignees = task.assignees || (task.assignee ? [task.assignee] : []);

    if (assignees.length === 0) return false;

    // Crea un set di tutti i miei identificatori possibili
    const myIdentifiers = new Set();
    if (myEmail) myIdentifiers.add(myEmail);
    if (myUsername) myIdentifiers.add(myUsername);
    if (myNickname) myIdentifiers.add(myNickname);

    // Aggiungi anche la parte prima della @ dell'email
    if (myEmail && myEmail.includes('@')) {
        myIdentifiers.add(myEmail.split('@')[0]);
    }

    return assignees.some(assigneeId => {
        if (!assigneeId) return false;
        const id = assigneeId.toLowerCase();

        // Confronto diretto
        if (myIdentifiers.has(id)) return true;

        // Confronto con email del membro (cerca nei team)
        const members = getAllTeamMembers();
        const member = members.find(m =>
            m.id?.toLowerCase() === id ||
            m.username?.toLowerCase() === id
        );

        if (member?.email) {
            return member.email.toLowerCase() === myEmail;
        }

        return false;
    });
}

// Render di un task delegato con badge progetto
function renderDelegatedTask(task) {
    const statusIcon = task.status === 'done' ? '✅' : (task.status === 'progress' ? '🔄' : '📋');
    const statusClass = task.status === 'done' ? 'opacity: 0.6;' : '';

    return `
        <div class="kanban-task task-card" style="${statusClass}" data-task-id="${task.id}" data-project-id="${task.projectId}">
            <div class="delegated-task-badge">
                ${task.isFromShared ? '📥' : '📁'} ${task.projectName}
            </div>
            <div class="task-title" style="font-size:0.85rem;">
                ${statusIcon} ${task.title}
            </div>
            ${task.deadline ? `<div class="text-xs text-muted mt-1">📅 ${formatDate(task.deadline)}</div>` : ''}
            <div class="delegated-task-owner">
                👤 Da: ${task.projectOwner}
            </div>
            <div class="kanban-task-actions" style="display:flex; gap:4px; margin-top:8px; justify-content:flex-end;">
                <button class="btn-xs" onclick="event.stopPropagation(); openDelegatedTask('${task.projectId}', '${task.id}')" title="Apri nel progetto">🔗</button>
                ${task.status !== 'done' ? `<button class="btn-xs" onclick="event.stopPropagation(); completeDelegatedTask('${task.projectId}', '${task.id}')" title="Segna come completato">✅</button>` : ''}
            </div>
        </div>
    `;
}

// Apre il progetto e naviga al task
function openDelegatedTask(projectId, taskId) {
    // Naviga alla pagina Team
    showPage('team');

    // Seleziona il progetto
    setTimeout(() => {
        const isShared = state.sharedProjects?.some(p => p.id === projectId);
        const selectValue = isShared ? 'shared_' + projectId : projectId;

        const select = document.getElementById('teamProjectSelect');
        if (select) {
            select.value = selectValue;
            loadTeamProject(selectValue);
        }

        // Evidenzia il task dopo il render
        setTimeout(() => {
            const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskEl) {
                taskEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                taskEl.style.animation = 'pulse 0.5s ease 3';
            }
        }, 500);
    }, 300);
}

// Completa un task delegato
function completeDelegatedTask(projectId, taskId) {
    // Cerca il progetto
    let project = state.teamProjects?.find(p => p.id === projectId);
    let isShared = false;

    if (!project) {
        const shared = state.sharedProjects?.find(p => p.id === projectId);
        if (shared) {
            project = shared.data || shared;
            isShared = true;
        }
    }

    if (!project) {
        showToast('Progetto non trovato', 'error');
        return;
    }

    // Trova e sposta il task in done
    ['todo', 'progress'].forEach(status => {
        const idx = project.columns?.[status]?.findIndex(t => t.id === taskId);
        if (idx >= 0) {
            const task = project.columns[status].splice(idx, 1)[0];
            task.status = 'done';
            task.completedAt = new Date().toISOString();
            if (!project.columns.done) project.columns.done = [];
            project.columns.done.unshift(task);
        }
    });

    saveStateAndSync();
    renderKanban();
    showToast('Task completato! 🎉', 'success');
}

function renderKanbanTask(task) {
    const status = task.completed ? 'done' : (task.status || 'todo');

    return `<div class="kanban-task task-card priority-${task.priority || 'medium'}"
                 draggable="true"
                 data-task-id="${task.id}"
                 ondragstart="handleDragStart(event, '${task.id}')"
                 ondragend="handleDragEnd(event)">
                <div class="task-title" style="font-size:0.85rem;" onclick="toggleTask('${task.id}')">${task.title}</div>
                ${task.due ? `<div class="text-xs text-muted mt-1">📅 ${formatDate(task.due)}</div>` : ''}
                ${task.estimate ? `<div class="text-xs text-muted">⏱️ ${task.estimate}min</div>` : ''}
                <div class="kanban-task-actions" style="display:flex; gap:4px; margin-top:8px; justify-content:flex-end;">
                    <button class="btn-xs" onclick="event.stopPropagation(); editTask('${task.id}')" title="Modifica">✏️</button>
                    ${status !== 'todo' ? `<button class="btn-xs" onclick="event.stopPropagation(); moveTaskToKanbanColumn('${task.id}', 'todo')" title="Sposta in Da Fare">📥</button>` : ''}
                    ${status !== 'progress' ? `<button class="btn-xs" onclick="event.stopPropagation(); moveTaskToKanbanColumn('${task.id}', 'progress')" title="Sposta in Corso">🔄</button>` : ''}
                    ${status !== 'done' ? `<button class="btn-xs" onclick="event.stopPropagation(); moveTaskToKanbanColumn('${task.id}', 'done')" title="Completa">✅</button>` : ''}
                </div>
            </div>`;
}

function renderMatrix() {
    const q1 = state.tasks.filter(t => !t.completed && t.quadrant === '1');
    const q2 = state.tasks.filter(t => !t.completed && t.quadrant === '2');
    const q3 = state.tasks.filter(t => !t.completed && t.quadrant === '3');
    const q4 = state.tasks.filter(t => !t.completed && t.quadrant === '4');

    const m1 = document.getElementById('matrixQ1');
    const m2 = document.getElementById('matrixQ2');
    const m3 = document.getElementById('matrixQ3');
    const m4 = document.getElementById('matrixQ4');

    if (m1) m1.innerHTML = q1.map(t => renderMatrixTask(t)).join('');
    if (m2) m2.innerHTML = q2.map(t => renderMatrixTask(t)).join('');
    if (m3) m3.innerHTML = q3.map(t => renderMatrixTask(t)).join('');
    if (m4) m4.innerHTML = q4.map(t => renderMatrixTask(t)).join('');

    // Setup drag & drop per la matrice (incluso touch)
    setupAllDragDrop();
}

function renderMatrixTask(task) {
    return `<div class="matrix-task task-card"
                 draggable="true"
                 data-task-id="${task.id}"
                 ondragstart="handleDragStart(event, '${task.id}')"
                 ondragend="handleDragEnd(event)">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                    <span onclick="toggleTask('${task.id}')" style="flex:1;cursor:pointer;">${task.title}</span>
                    <button class="btn-xs" onclick="event.stopPropagation(); editTask('${task.id}')" title="Modifica" style="flex-shrink:0;">✏️</button>
                </div>
            </div>`;
}

// ============================================
// DRAG & DROP SYSTEM (Robusto per desktop e mobile)
// ============================================

let draggedTaskId = null;
let draggedElement = null;

function handleDragStart(event, taskId) {
    console.log('Drag started:', taskId);
    draggedTaskId = taskId;
    draggedElement = event.target;
    event.target.classList.add('dragging');

    // Imposta i dati per il trasferimento
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', taskId);
    event.dataTransfer.setData('application/json', JSON.stringify({ taskId }));

    // Imposta immagine di drag personalizzata (opzionale)
    if (event.dataTransfer.setDragImage) {
        const dragImage = event.target.cloneNode(true);
        dragImage.style.position = 'absolute';
        dragImage.style.top = '-1000px';
        document.body.appendChild(dragImage);
        event.dataTransfer.setDragImage(dragImage, 50, 20);
        setTimeout(() => document.body.removeChild(dragImage), 0);
    }
}

function handleDragEnd(event) {
    console.log('Drag ended');
    if (event.target) {
        event.target.classList.remove('dragging');
    }
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
    }
    draggedTaskId = null;
    draggedElement = null;

    // Rimuovi tutte le classi drag-over
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

function setupKanbanDragDrop() {
    console.log('Setting up Kanban drag & drop');

    // Trova tutti i container delle colonne
    const todoCol = document.getElementById('kanbanTodo');
    const progressCol = document.getElementById('kanbanProgress');
    const doneCol = document.getElementById('kanbanDone');

    const columns = [
        { el: todoCol, status: 'todo' },
        { el: progressCol, status: 'progress' },
        { el: doneCol, status: 'done' }
    ];

    columns.forEach(({ el, status }) => {
        if (!el) {
            console.warn('Column not found:', status);
            return;
        }

        // Rimuovi handler esistenti per evitare duplicati
        el.ondragover = null;
        el.ondragleave = null;
        el.ondrop = null;

        el.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        });

        el.addEventListener('dragleave', function(e) {
            e.preventDefault();
            // Solo rimuovi se stiamo uscendo dall'elemento e non entrando in un figlio
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        });

        el.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');

            const taskId = e.dataTransfer.getData('text/plain') || draggedTaskId;
            console.log('Drop on', status, 'taskId:', taskId);

            if (taskId) {
                moveTaskToKanbanColumn(taskId, status);
            }
        });

        console.log('Setup complete for column:', status);
    });
}

function moveTaskToKanbanColumn(taskId, status) {
    console.log('Moving task', taskId, 'to', status);
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) {
        console.error('Task not found:', taskId);
        return;
    }

    if (status === 'done' || status === 'Done') {
        task.completed = true;
        task.completedAt = new Date().toISOString();
        task.status = 'done';
        showToast('Task completato! 🎉', 'success');
        addXP(10);
    } else if (status === 'progress' || status === 'Progress') {
        task.completed = false;
        task.status = 'progress';
        showToast('Task in corso 🔄', 'info');
    } else {
        task.completed = false;
        task.status = 'todo';
        showToast('Task spostato 📋', 'info');
    }

    saveStateAndSync();
    renderKanban();
    renderTasks();
}

function setupMatrixDragDrop() {
    const quadrants = document.querySelectorAll('.matrix-quadrant');
    quadrants.forEach(quadrant => {
        // Trova il container dei task dentro il quadrante
        const container = quadrant.querySelector('.matrix-tasks') || quadrant;

        container.ondragover = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            quadrant.classList.add('drag-over');
        };
        container.ondragleave = (e) => {
            quadrant.classList.remove('drag-over');
        };
        container.ondrop = (e) => {
            e.preventDefault();
            quadrant.classList.remove('drag-over');
            const taskId = e.dataTransfer.getData('text/plain');
            // Estrai il numero del quadrante dalla classe
            const quadrantClass = quadrant.className.match(/quadrant-(\d)/);
            const quadrantNum = quadrantClass ? quadrantClass[1] : '1';
            moveTaskToQuadrant(taskId, quadrantNum);
        };
    });
}

function moveTaskToQuadrant(taskId, quadrant) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task) return;

    task.quadrant = quadrant;

    // Aggiorna anche la priorità in base al quadrante (Eisenhower Matrix)
    const quadrantPriorities = {
        '1': 'high',    // Urgente & Importante -> Alta priorità
        '2': 'medium',  // Importante ma non urgente -> Media
        '3': 'medium',  // Urgente ma non importante -> Media
        '4': 'low'      // Né urgente né importante -> Bassa
    };
    task.priority = quadrantPriorities[quadrant] || 'medium';

    const quadrantNames = {
        '1': '🔴 Urgente & Importante',
        '2': '🟡 Importante',
        '3': '🟠 Urgente',
        '4': '🟢 Delegabile'
    };

    saveStateAndSync();
    renderMatrix();
    renderKanban();
    renderTasks();
    showToast(`Task spostato in ${quadrantNames[quadrant]}`, 'success');
}

// ============================================
// TOUCH DRAG AND DROP SUPPORT
// ============================================
// Nota: touchDragData è definito all'inizio del file per evitare
// "Cannot access before initialization" error

function initTouchDragDrop() {
    // Applica a tutti i task trascinabili
    document.querySelectorAll('[draggable="true"], .kanban-task, .task-item').forEach(el => {
        if (!el.dataset.touchEnabled) {
            el.dataset.touchEnabled = 'true';
            el.addEventListener('touchstart', handleTouchStart, { passive: false });
            el.addEventListener('touchmove', handleTouchMove, { passive: false });
            el.addEventListener('touchend', handleTouchEnd, { passive: false });
            el.addEventListener('touchcancel', handleTouchCancel, { passive: false });
        }
    });
}

function handleTouchStart(e) {
    const target = e.currentTarget;
    const taskId = target.dataset.id || target.dataset.taskId;

    if (!taskId) return;

    // Long press per iniziare il drag (300ms)
    touchDragData.longPressTimer = setTimeout(() => {
        e.preventDefault();

        const touch = e.touches[0];
        const rect = target.getBoundingClientRect();

        touchDragData.taskId = taskId;
        touchDragData.element = target;
        touchDragData.startX = touch.clientX;
        touchDragData.startY = touch.clientY;
        touchDragData.offsetX = touch.clientX - rect.left;
        touchDragData.offsetY = touch.clientY - rect.top;
        touchDragData.isDragging = true;
        touchDragData.isTeamTask = target.closest('.team-kanban-column') !== null;

        // Crea clone per il drag visuale
        touchDragData.clone = target.cloneNode(true);
        touchDragData.clone.classList.add('touch-drag-clone');
        touchDragData.clone.style.cssText = `
            position: fixed;
            left: ${rect.left}px;
            top: ${rect.top}px;
            width: ${rect.width}px;
            opacity: 0.9;
            z-index: 10000;
            pointer-events: none;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        `;
        document.body.appendChild(touchDragData.clone);

        // Nascondi elemento originale
        target.style.opacity = '0.3';
        target.classList.add('dragging');

        // Feedback tattile
        if (navigator.vibrate) navigator.vibrate(50);

    }, 300);
}

function handleTouchMove(e) {
    if (!touchDragData.isDragging) {
        // Se si muove prima del long press, annulla
        if (touchDragData.longPressTimer) {
            clearTimeout(touchDragData.longPressTimer);
            touchDragData.longPressTimer = null;
        }
        return;
    }

    e.preventDefault();
    const touch = e.touches[0];

    // Muovi il clone
    if (touchDragData.clone) {
        touchDragData.clone.style.left = (touch.clientX - touchDragData.offsetX) + 'px';
        touchDragData.clone.style.top = (touch.clientY - touchDragData.offsetY) + 'px';
    }

    // Trova il drop target sotto il dito
    const elementsAtPoint = document.elementsFromPoint(touch.clientX, touch.clientY);

    // Rimuovi evidenziazione precedente
    document.querySelectorAll('.touch-drag-over').forEach(el => {
        el.classList.remove('touch-drag-over');
    });

    // Cerca una colonna kanban valida
    let foundTarget = null;

    for (const el of elementsAtPoint) {
        // Per task del team
        if (touchDragData.isTeamTask) {
            if (el.classList.contains('team-kanban-column') || el.closest('.team-kanban-column')) {
                foundTarget = el.classList.contains('team-kanban-column') ? el : el.closest('.team-kanban-column');
                break;
            }
        } else {
            // Per task personali - Kanban
            if (el.id === 'kanbanTodo' || el.id === 'kanbanProgress' || el.id === 'kanbanDone' ||
                el.closest('#kanbanTodo') || el.closest('#kanbanProgress') || el.closest('#kanbanDone')) {
                foundTarget = el.id?.startsWith('kanban') ? el : el.closest('[id^="kanban"]');
                break;
            }
            // Per task personali - Matrix
            if (el.classList.contains('matrix-quadrant') || el.closest('.matrix-quadrant')) {
                foundTarget = el.classList.contains('matrix-quadrant') ? el : el.closest('.matrix-quadrant');
                break;
            }
        }
    }

    if (foundTarget) {
        foundTarget.classList.add('touch-drag-over');
        touchDragData.dropTarget = foundTarget;
    } else {
        touchDragData.dropTarget = null;
    }
}

function handleTouchEnd(e) {
    // Annulla long press timer se non ancora scattato
    if (touchDragData.longPressTimer) {
        clearTimeout(touchDragData.longPressTimer);
        touchDragData.longPressTimer = null;
    }

    if (!touchDragData.isDragging) return;

    e.preventDefault();

    // Rimuovi clone
    if (touchDragData.clone && touchDragData.clone.parentNode) {
        touchDragData.clone.parentNode.removeChild(touchDragData.clone);
    }

    // Ripristina elemento originale
    if (touchDragData.element) {
        touchDragData.element.style.opacity = '';
        touchDragData.element.classList.remove('dragging');
    }

    // Rimuovi evidenziazioni
    document.querySelectorAll('.touch-drag-over').forEach(el => {
        el.classList.remove('touch-drag-over');
    });

    // Esegui il drop se c'è un target valido
    if (touchDragData.dropTarget && touchDragData.taskId) {
        if (touchDragData.isTeamTask) {
            // Drop su colonna team kanban
            const status = touchDragData.dropTarget.dataset.status;
            if (status) {
                dropTeamTaskTouch(touchDragData.taskId, status);
            }
        } else {
            // Drop su colonna task personali o matrix
            if (touchDragData.dropTarget.id === 'kanbanTodo') {
                moveTaskToKanbanColumn(touchDragData.taskId, 'todo');
            } else if (touchDragData.dropTarget.id === 'kanbanProgress') {
                moveTaskToKanbanColumn(touchDragData.taskId, 'progress');
            } else if (touchDragData.dropTarget.id === 'kanbanDone') {
                moveTaskToKanbanColumn(touchDragData.taskId, 'done');
            } else if (touchDragData.dropTarget.classList.contains('matrix-quadrant')) {
                const quadrantClass = touchDragData.dropTarget.className.match(/quadrant-(\d)/);
                const quadrantNum = quadrantClass ? quadrantClass[1] : '1';
                moveTaskToQuadrant(touchDragData.taskId, quadrantNum);
            }
        }

        // Feedback tattile
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
    }

    // Reset stato
    resetTouchDragData();
}

function handleTouchCancel(e) {
    if (touchDragData.longPressTimer) {
        clearTimeout(touchDragData.longPressTimer);
    }

    if (touchDragData.clone && touchDragData.clone.parentNode) {
        touchDragData.clone.parentNode.removeChild(touchDragData.clone);
    }

    if (touchDragData.element) {
        touchDragData.element.style.opacity = '';
        touchDragData.element.classList.remove('dragging');
    }

    document.querySelectorAll('.touch-drag-over').forEach(el => {
        el.classList.remove('touch-drag-over');
    });

    resetTouchDragData();
}

function resetTouchDragData() {
    touchDragData = {
        taskId: null,
        element: null,
        clone: null,
        startX: 0,
        startY: 0,
        offsetX: 0,
        offsetY: 0,
        isDragging: false,
        dropTarget: null,
        isTeamTask: false,
        longPressTimer: null
    };
}

function dropTeamTaskTouch(taskId, newStatus) {
    const project = getProjectById(currentProjectId);
    if (!project) return;

    const task = project.columns?.tasks?.find(t => t.id === taskId);
    if (task) {
        task.status = newStatus;
        saveStateAndSync();
        renderTeamProject();

        if (newStatus === 'done') {
            addXP(10);
            showToast('Task completato! +10 XP', 'success');
        } else {
            showToast('Task spostato!', 'info');
        }
    }
}

// Inizializza touch drag dopo ogni render
function setupAllDragDrop() {
    setupKanbanDragDrop();
    setupMatrixDragDrop();
    initTouchDragDrop();
}

function setTaskView(view) {
    const listView = document.getElementById('taskListView');
    const kanbanView = document.getElementById('taskKanbanView');
    const matrixView = document.getElementById('taskMatrixView');
    
    if (listView) listView.style.display = view === 'list' ? 'block' : 'none';
    if (kanbanView) kanbanView.style.display = view === 'kanban' ? 'block' : 'none';
    if (matrixView) matrixView.style.display = view === 'matrix' ? 'block' : 'none';
    
    document.getElementById('viewListBtn').className = 'btn btn-sm ' + (view === 'list' ? 'btn-primary' : 'btn-secondary');
    document.getElementById('viewKanbanBtn').className = 'btn btn-sm ' + (view === 'kanban' ? 'btn-primary' : 'btn-secondary');
    document.getElementById('viewMatrixBtn').className = 'btn btn-sm ' + (view === 'matrix' ? 'btn-primary' : 'btn-secondary');
}

// Reset form task per nuovo task
function resetTaskForm() {
    // Reset editingTaskId
    editingTaskId = null;

    // Reset campi form
    const taskTitle = document.getElementById('taskTitle');
    const taskDesc = document.getElementById('taskDesc');
    const taskDue = document.getElementById('taskDue');
    const taskPriority = document.getElementById('taskPriority');
    const taskCategory = document.getElementById('taskCategory');
    const taskQuadrant = document.getElementById('taskQuadrant');
    const taskEstimate = document.getElementById('taskEstimate');
    const taskDepartment = document.getElementById('taskDepartment');
    const taskTop3 = document.getElementById('taskTop3');
    const taskRecurrence = document.getElementById('taskRecurrence');
    const subtasksList = document.getElementById('subtasksList');
    const taskDependsOn = document.getElementById('taskDependsOn');

    if (taskTitle) taskTitle.value = '';
    if (taskDesc) taskDesc.value = '';
    if (taskDue) taskDue.value = '';
    if (taskPriority) taskPriority.value = 'medium';
    if (taskCategory) taskCategory.value = 'work';
    if (taskQuadrant) taskQuadrant.value = '2';
    if (taskEstimate) taskEstimate.value = '30';
    if (taskDepartment) taskDepartment.value = 'work';
    if (taskTop3) taskTop3.classList.remove('active');
    if (taskRecurrence) taskRecurrence.value = 'none';
    if (subtasksList) subtasksList.innerHTML = '';
    if (taskDependsOn) taskDependsOn.selectedIndex = -1;

    // Reset titolo modal
    const modalTitle = document.querySelector('#addTaskModal .modal-title');
    if (modalTitle) modalTitle.textContent = '✅ Nuovo Task';
}

function saveTask() {
    const title = document.getElementById('taskTitle')?.value?.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    // Raccogli subtasks dal form (con gestione errori)
    let subtasks = [];
    try {
        subtasks = getSubtasksFromForm() || [];
    } catch (e) {
        console.warn('Errore lettura subtasks:', e);
    }

    // Raccogli dependencies (con gestione errori)
    let dependsOn = [];
    try {
        const dependsOnSelect = document.getElementById('taskDependsOn');
        if (dependsOnSelect) {
            dependsOn = Array.from(dependsOnSelect.selectedOptions).map(opt => opt.value);
        }
    } catch (e) {
        console.warn('Errore lettura dependencies:', e);
    }

    // Costruisci i dati del task
    const taskData = {
        title: title,
        description: document.getElementById('taskDesc')?.value || '',
        due: document.getElementById('taskDue')?.value || '',
        priority: document.getElementById('taskPriority')?.value || 'medium',
        category: document.getElementById('taskCategory')?.value || 'work',
        quadrant: document.getElementById('taskQuadrant')?.value || '2',
        estimate: parseInt(document.getElementById('taskEstimate')?.value) || 30,
        isTop3: document.getElementById('taskTop3')?.classList?.contains('active') || false,
        top3: document.getElementById('taskTop3')?.classList?.contains('active') || false,
        department: document.getElementById('taskDepartment')?.value || 'work',
        recurrence: document.getElementById('taskRecurrence')?.value || 'none',
        subtasks: subtasks,
        dependsOn: dependsOn,
        actualTime: 0
    };

    // Inizializza state.tasks se non esiste
    if (!state.tasks) {
        state.tasks = [];
    }

    let isEdit = false;
    if (editingTaskId) {
        // Modifica task esistente
        const task = state.tasks.find(t => t.id === editingTaskId);
        if (task) {
            taskData.actualTime = task.actualTime || 0;
            Object.assign(task, taskData);
            task.updatedAt = new Date().toISOString();
            isEdit = true;
        }
        editingTaskId = null;
    } else {
        // Crea nuovo task
        const task = {
            ...taskData,
            id: 'task_' + Date.now(),
            completed: false,
            status: 'todo',
            createdAt: new Date().toISOString(),
            lastRecurrence: null
        };
        state.tasks.push(task);
        addXP(5);
    }

    // Salva lo stato E sincronizza con il cloud
    saveStateAndSync();

    // Mostra messaggio di conferma
    showToast(isEdit ? 'Task modificato!' : 'Task creato! +5 XP', 'success');
    console.log('✅ Task salvato e sincronizzato:', taskData.title);

    // Reset form (sempre eseguito)
    try {
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDesc').value = '';
        document.getElementById('taskDue').value = '';
        document.getElementById('taskPriority').value = 'medium';
        document.getElementById('taskCategory').value = 'work';
        document.getElementById('taskQuadrant').value = '2';
        document.getElementById('taskEstimate').value = '30';
        document.getElementById('taskDepartment').value = 'work';
        const top3Btn = document.getElementById('taskTop3');
        if (top3Btn) top3Btn.classList.remove('active');
        const recurrenceEl = document.getElementById('taskRecurrence');
        if (recurrenceEl) recurrenceEl.value = 'none';
        const subtasksEl = document.getElementById('subtasksList');
        if (subtasksEl) subtasksEl.innerHTML = '';
        const depsEl = document.getElementById('taskDependsOn');
        if (depsEl) depsEl.selectedIndex = -1;

        // Reset titolo modal
        const modalTitle = document.querySelector('#addTaskModal .modal-title');
        if (modalTitle) modalTitle.textContent = '✅ Nuovo Task';
    } catch (e) {
        console.warn('Reset form warning:', e);
    }

    // Chiudi modal SEMPRE
    closeModal('addTaskModal');

    // Re-render pagine
    try {
        renderTasksPage();
        renderHomePage();
        updateDepartmentStats();
    } catch (e) {
        console.warn('Render warning:', e);
    }
}

// ============================================
// SUBTASKS FUNCTIONS
// ============================================

function addSubtaskToForm() {
    const input = document.getElementById('newSubtaskInput');
    const text = input.value.trim();
    if (!text) return;

    const container = document.getElementById('subtasksList');
    const id = 'sub_' + Date.now();

    const subtaskEl = document.createElement('div');
    subtaskEl.className = 'subtask-item';
    subtaskEl.dataset.id = id;
    subtaskEl.innerHTML = `
        <input type="checkbox" class="subtask-check">
        <span class="subtask-text">${text}</span>
        <button class="subtask-remove" onclick="removeSubtaskFromForm('${id}')">×</button>
    `;
    container.appendChild(subtaskEl);
    input.value = '';
    input.focus();
}

function removeSubtaskFromForm(id) {
    const el = document.querySelector(`.subtask-item[data-id="${id}"]`);
    if (el) {
        el.style.transition = 'all 0.2s ease';
        el.style.opacity = '0';
        el.style.transform = 'translateX(-20px)';
        setTimeout(() => el.remove(), 200);
    }
}

function getSubtasksFromForm() {
    const container = document.getElementById('subtasksList');
    if (!container) return [];

    return Array.from(container.querySelectorAll('.subtask-item')).map(el => ({
        id: el.dataset.id,
        text: el.querySelector('.subtask-text').textContent,
        completed: el.querySelector('.subtask-check').checked
    }));
}

function toggleSubtask(taskId, subtaskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task || !task.subtasks) return;

    const subtask = task.subtasks.find(s => s.id === subtaskId);
    if (subtask) {
        subtask.completed = !subtask.completed;
        saveStateAndSync();
        renderTasksPage();

        // Check if all subtasks are completed
        const allCompleted = task.subtasks.every(s => s.completed);
        if (allCompleted && task.subtasks.length > 0) {
            showToast('Tutti i sottotask completati!', 'success');
        }
    }
}

function renderSubtasks(task) {
    if (!task.subtasks || task.subtasks.length === 0) return '';

    const completed = task.subtasks.filter(s => s.completed).length;
    const total = task.subtasks.length;
    const progress = Math.round((completed / total) * 100);

    return `
        <div class="task-subtasks">
            <div class="subtask-progress">${completed}/${total} completati (${progress}%)</div>
            ${task.subtasks.map(s => `
                <div class="subtask-item ${s.completed ? 'completed' : ''}" onclick="event.stopPropagation(); toggleSubtask('${task.id}', '${s.id}')">
                    <input type="checkbox" class="subtask-check" ${s.completed ? 'checked' : ''} onclick="event.stopPropagation(); toggleSubtask('${task.id}', '${s.id}')">
                    <span class="subtask-text ${s.completed ? 'completed' : ''}">${s.text}</span>
                </div>
            `).join('')}
        </div>
    `;
}

// ============================================
// RECURRING TASKS FUNCTIONS
// ============================================

function checkRecurringTasks() {
    const today = new Date().toISOString().split('T')[0];
    let recreated = 0;

    state.tasks.forEach(task => {
        if (!task.recurrence || task.recurrence === 'none' || !task.completed) return;

        const lastDate = task.lastRecurrence || task.completedDate;
        if (!lastDate) return;

        const daysDiff = getDaysDifference(lastDate, today);
        let shouldRecreate = false;

        switch(task.recurrence) {
            case 'daily': shouldRecreate = daysDiff >= 1; break;
            case 'weekly': shouldRecreate = daysDiff >= 7; break;
            case 'monthly': shouldRecreate = daysDiff >= 30; break;
        }

        if (shouldRecreate) {
            const newTask = {
                ...task,
                id: 'task_' + Date.now() + Math.random().toString(36).substr(2, 5),
                completed: false,
                completedDate: null,
                status: 'todo',
                createdAt: new Date().toISOString(),
                due: calculateNextDue(task.due, task.recurrence),
                subtasks: task.subtasks ? task.subtasks.map(s => ({...s, completed: false})) : [],
                lastRecurrence: null
            };
            state.tasks.push(newTask);
            task.lastRecurrence = today;
            recreated++;
        }
    });

    if (recreated > 0) {
        saveStateAndSync();
        showToast(`${recreated} task ricorrenti creati!`, 'info');
    }
}

function getDaysDifference(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

function calculateNextDue(originalDue, recurrence) {
    if (!originalDue) return new Date().toISOString().split('T')[0];
    const date = new Date(originalDue);
    switch(recurrence) {
        case 'daily': date.setDate(date.getDate() + 1); break;
        case 'weekly': date.setDate(date.getDate() + 7); break;
        case 'monthly': date.setMonth(date.getMonth() + 1); break;
    }
    return date.toISOString().split('T')[0];
}

// ============================================
// TASK DEPENDENCIES FUNCTIONS
// ============================================

function populateDependencySelect(currentTaskId = null) {
    const select = document.getElementById('taskDependsOn');
    if (!select) return;

    const incompleteTasks = state.tasks.filter(t =>
        !t.completed && t.id !== currentTaskId
    );

    select.innerHTML = incompleteTasks.length === 0
        ? '<option disabled>Nessun task disponibile</option>'
        : incompleteTasks.map(t =>
            `<option value="${t.id}">${t.title}</option>`
        ).join('');
}

function canCompleteTask(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task || !task.dependsOn || task.dependsOn.length === 0) return true;

    return task.dependsOn.every(depId => {
        const dep = state.tasks.find(t => t.id === depId);
        return dep?.completed;
    });
}

function getBlockingTasks(taskId) {
    const task = state.tasks.find(t => t.id === taskId);
    if (!task || !task.dependsOn) return [];

    return task.dependsOn
        .map(depId => state.tasks.find(t => t.id === depId))
        .filter(t => t && !t.completed)
        .map(t => t.title);
}

// ============================================
// TIME TRACKING FUNCTIONS
// ============================================

function calculateAccuracy(task) {
    if (!task.estimate || !task.actualTime) return '-';
    const ratio = task.actualTime / task.estimate;
    return Math.round((1 - Math.abs(1 - ratio)) * 100);
}

function getAccuracyClass(task) {
    const acc = calculateAccuracy(task);
    if (acc === '-') return '';
    if (acc >= 80) return 'accuracy-good';
    if (acc >= 50) return 'accuracy-medium';
    return 'accuracy-poor';
}

function renderTimeComparison(task) {
    if (!task.estimate) return '';

    const accuracy = calculateAccuracy(task);
    const accClass = getAccuracyClass(task);

    return `
        <div class="time-comparison">
            <span class="time-stat">⏱️ ${task.estimate}min stimati</span>
            ${task.actualTime ? `<span class="time-stat">⏰ ${task.actualTime}min effettivi</span>` : ''}
            ${accuracy !== '-' ? `<span class="time-stat ${accClass}">${accuracy}% accuratezza</span>` : ''}
        </div>
    `;
}

function toggleTask(id) {
    const task = state.tasks.find(t => t.id === id);
    if (!task) return;

    // Check dependencies before completing
    if (!task.completed && !canCompleteTask(id)) {
        const blocking = getBlockingTasks(id);
        showToast(`Completa prima: ${blocking.join(', ')}`, 'warning');
        return;
    }

    // Trova l'elemento DOM del task PRIMA di modificare lo stato
    const taskElement = document.querySelector(`.task-item[data-id="${id}"]`);

    const wasCompleted = task.completed;
    const willBeCompleted = !wasCompleted;

    // Determina se il task sparirà dalla vista corrente
    const willDisappear = (willBeCompleted && currentTaskFilter !== 'done') ||
                          (!willBeCompleted && currentTaskFilter === 'done');

    // Animazione di uscita
    if (taskElement && willDisappear) {
        // Prima aggiorna visivamente il checkbox
        const checkbox = taskElement.querySelector('.task-checkbox');
        if (checkbox) {
            if (willBeCompleted) {
                checkbox.classList.add('checked');
                checkbox.innerHTML = '✓';
            } else {
                checkbox.classList.remove('checked');
                checkbox.innerHTML = '';
            }
        }

        // Animazione di sparizione
        taskElement.style.transition = 'all 0.4s ease';
        taskElement.style.transform = 'translateX(100%)';
        taskElement.style.opacity = '0';

        // Dopo l'animazione, aggiorna lo stato
        setTimeout(() => {
            task.completed = willBeCompleted;
            task.completedDate = willBeCompleted ? state.today.date : null;
            task.status = willBeCompleted ? 'done' : 'todo';

            // SYNC: Se è collegato a un progetto, aggiorna anche il task del progetto
            syncPersonalTaskToProject(task);

            if (willBeCompleted) {
                state.stats.tasksCompleted++;
                addXP(10);
                showToast('Task completato! +10 XP', 'success');
            } else {
                showToast('Task riaperto', 'info');
            }

            saveStateAndSync();
            renderTasksPage();
            renderHomePage();
            checkBadges();
        }, 400);
        return;
    }

    // Nessuna animazione necessaria
    task.completed = willBeCompleted;
    task.completedDate = willBeCompleted ? state.today.date : null;
    task.status = willBeCompleted ? 'done' : 'todo';

    // SYNC: Se è collegato a un progetto, aggiorna anche il task del progetto
    syncPersonalTaskToProject(task);

    if (willBeCompleted) {
        state.stats.tasksCompleted++;
        addXP(10);
        showToast('Task completato! +10 XP', 'success');
    } else {
        showToast('Task riaperto', 'info');
    }

    saveStateAndSync();
    renderTasksPage();
    renderHomePage();
    checkBadges();
}

function deleteTask(id) {
    const task = state.tasks.find(t => t.id === id);
    if (!task) return;

    // Salva per undo
    const taskBackup = { ...task };

    state.tasks = state.tasks.filter(t => t.id !== id);
    saveStateAndSync();
    renderTasksPage();
    renderHomePage();

    // Registra azione per undo
    undoSystem.register({
        type: 'deleteTask',
        data: taskBackup,
        message: '🗑️ Task eliminato'
    });
}

function editTask(id) {
    const task = state.tasks.find(t => t.id === id);
    if (!task) {
        showToast('Task non trovato', 'error');
        return;
    }

    editingTaskId = id;

    // Popola il modal con i dati esistenti
    document.getElementById('taskTitle').value = task.title || '';
    document.getElementById('taskDesc').value = task.description || '';
    document.getElementById('taskDue').value = task.due || '';
    document.getElementById('taskPriority').value = task.priority || 'medium';
    document.getElementById('taskCategory').value = task.category || 'work';
    document.getElementById('taskQuadrant').value = task.quadrant || '2';
    document.getElementById('taskEstimate').value = task.estimate || 30;
    document.getElementById('taskDepartment').value = task.department || 'work';

    // Toggle Top 3
    const top3Toggle = document.getElementById('taskTop3');
    if (task.top3) {
        top3Toggle.classList.add('active');
    } else {
        top3Toggle.classList.remove('active');
    }

    // Popola recurrence
    const recurrenceSelect = document.getElementById('taskRecurrence');
    if (recurrenceSelect) {
        recurrenceSelect.value = task.recurrence || 'none';
    }

    // Popola subtasks
    const subtasksList = document.getElementById('subtasksList');
    if (subtasksList) {
        subtasksList.innerHTML = '';
        if (task.subtasks && task.subtasks.length > 0) {
            task.subtasks.forEach(s => {
                const subtaskEl = document.createElement('div');
                subtaskEl.className = 'subtask-item';
                subtaskEl.dataset.id = s.id;
                subtaskEl.innerHTML = `
                    <input type="checkbox" class="subtask-check" ${s.completed ? 'checked' : ''}>
                    <span class="subtask-text">${s.text}</span>
                    <button class="subtask-remove" onclick="removeSubtaskFromForm('${s.id}')">×</button>
                `;
                subtasksList.appendChild(subtaskEl);
            });
        }
    }

    // Popola dependencies
    populateDependencySelect(id);
    const dependsOnSelect = document.getElementById('taskDependsOn');
    if (dependsOnSelect && task.dependsOn) {
        Array.from(dependsOnSelect.options).forEach(opt => {
            opt.selected = task.dependsOn.includes(opt.value);
        });
    }

    // Cambia titolo modal
    const modalTitle = document.querySelector('#addTaskModal .modal-title');
    if (modalTitle) modalTitle.textContent = '✏️ Modifica Task';

    openModal('addTaskModal');
}

function filterTasks(filter, evt) {
    console.log('filterTasks called:', filter);
    currentTaskFilter = filter;

    // Aggiorna stile bottoni
    const e = evt || window.event;
    if (e && e.target) {
        const container = e.target.parentElement;
        if (container) {
            container.querySelectorAll('.btn').forEach(b => b.className = 'btn btn-sm btn-secondary');
            e.target.className = 'btn btn-sm btn-primary';
        }
    } else {
        // Fallback: aggiorna i bottoni manualmente
        const btns = document.querySelectorAll('[onclick*="filterTasks"]');
        btns.forEach(b => {
            b.className = 'btn btn-sm btn-secondary';
            if (b.getAttribute('onclick').includes(`'${filter}'`)) {
                b.className = 'btn btn-sm btn-primary';
            }
        });
    }

    renderTasksList();
}

function getCategoryIcon(cat) {
    const icons = { work: '💼', personal: '👤', health: '❤️', finance: '💰', learning: '📚' };
    return icons[cat] || '📦';
}

function isToday(dateStr) {
    return dateStr === state.today.date;
}

// ============================================
// FINANCE PAGE - MISSING FUNCTIONS
// ============================================

function renderFinancePage() {
    // Assicurati che transactions sia un array
    if (!Array.isArray(state.transactions)) {
        state.transactions = [];
    }
    if (!Array.isArray(state.moneyGoals)) {
        state.moneyGoals = [];
    }

    renderFinanceSummary();
    renderDailyBudget();
    renderMoneyGoals();
    renderBudget();
    renderTransactions();
    renderWeeklyTrendChart();

    // Aggiorna anche i totali nella home se visibile
    updateHomeFinanceStats();
}

function updateHomeFinanceStats() {
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthTx = state.transactions.filter(t => t.date && t.date.startsWith(thisMonth));

    const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
    const expenses = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
    const balance = income - expenses;

    // Aggiorna elementi home se esistono
    const homeBalanceEl = document.getElementById('homeBalance');
    const homeIncomeEl = document.getElementById('homeMonthIncome');
    const homeExpenseEl = document.getElementById('homeMonthExpense');

    if (homeBalanceEl) homeBalanceEl.textContent = formatCurrency(balance);
    if (homeIncomeEl) homeIncomeEl.textContent = formatCurrency(income);
    if (homeExpenseEl) homeExpenseEl.textContent = formatCurrency(expenses);
}

function renderFinanceSummary() {
    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthTx = (state.transactions || []).filter(t => t.date && t.date.startsWith(thisMonth));

    const income = monthTx.filter(t => t.type === 'income').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
    const expenses = monthTx.filter(t => t.type === 'expense').reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
    const balance = income - expenses;

    const balanceEl = document.getElementById('currentBalance');
    const monthIncomeEl = document.getElementById('monthIncome');
    const monthExpensesEl = document.getElementById('monthExpense');

    if (balanceEl) {
        balanceEl.textContent = formatCurrency(balance);
        // Cambia colore in base al saldo
        balanceEl.style.color = balance >= 0 ? '' : '#ef4444';
    }
    if (monthIncomeEl) monthIncomeEl.textContent = formatCurrency(income);
    if (monthExpensesEl) monthExpensesEl.textContent = formatCurrency(expenses);
}

function renderDailyBudget() {
    const dailyBudgetRemainingEl = document.getElementById('dailyBudgetRemaining');
    const dailyBudgetSpentEl = document.getElementById('dailyBudgetSpent');
    const dailyBudgetBarEl = document.getElementById('dailyBudgetBar');

    if (!dailyBudgetRemainingEl) return;

    // Calcola budget giornaliero
    let dailyBudget = state.settings.dailyBudget || 0;

    // Se auto-calcolo attivo, dividi il budget mensile per i giorni del mese
    if (state.settings.autoDailyBudget && state.settings.monthlyBudget) {
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
        dailyBudget = state.settings.monthlyBudget / daysInMonth;
    }

    // Calcola spese di oggi
    const todayStr = state.today.date || new Date().toISOString().split('T')[0];
    const todayExpenses = (state.transactions || [])
        .filter(t => t.type === 'expense' && t.date === todayStr)
        .reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);

    const remaining = Math.max(0, dailyBudget - todayExpenses);
    const percentage = dailyBudget > 0 ? Math.min(100, (todayExpenses / dailyBudget) * 100) : 0;

    // Determina stato (safe, warning, danger)
    let status = 'safe';
    if (percentage >= 100) status = 'danger';
    else if (percentage >= 80) status = 'warning';

    dailyBudgetRemainingEl.textContent = formatCurrency(remaining);
    dailyBudgetRemainingEl.style.color = status === 'danger' ? '#ef4444' : status === 'warning' ? '#f59e0b' : '';

    if (dailyBudgetSpentEl) {
        dailyBudgetSpentEl.textContent = `Speso: ${formatCurrency(todayExpenses)} di ${formatCurrency(dailyBudget)}`;
    }

    if (dailyBudgetBarEl) {
        dailyBudgetBarEl.style.width = `${percentage}%`;
        dailyBudgetBarEl.className = `budget-progress ${status}`;
    }
}

function renderMoneyGoals() {
    const container = document.getElementById('moneyGoalsList');
    if (!container) return;

    const goals = state.moneyGoals || [];

    if (goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:20px; text-align:center;">
                <div style="font-size:2rem; margin-bottom:8px;">🎯</div>
                <div class="text-muted">Nessun obiettivo finanziario</div>
                <div class="text-muted text-xs mt-1">Crea il tuo primo obiettivo di risparmio!</div>
            </div>
        `;
        return;
    }

    container.innerHTML = goals.map(goal => {
        const current = parseFloat(goal.current) || 0;
        const target = parseFloat(goal.target) || 1;
        const progress = Math.min(100, Math.round((current / target) * 100));
        const remaining = Math.max(0, target - current);
        const isComplete = progress >= 100;

        return `
            <div class="money-goal-card" onclick="openMoneyGoalDetail('${goal.id}')" style="cursor:pointer;">
                <div class="money-goal-header">
                    <div class="money-goal-title">
                        <span class="money-goal-icon">${goal.icon || '🎯'}</span>
                        ${goal.name}
                        ${isComplete ? '<span style="color:#10b981;margin-left:6px;">✓</span>' : ''}
                    </div>
                    <div class="money-goal-target">
                        <div class="money-goal-current">${formatCurrency(current)}</div>
                        <div class="money-goal-total">di ${formatCurrency(target)}</div>
                    </div>
                </div>
                <div class="money-goal-bar">
                    <div class="money-goal-progress" style="width:${progress}%; ${isComplete ? 'background:linear-gradient(90deg,#10b981,#059669);' : ''}"></div>
                </div>
                <div class="money-goal-meta">
                    <span>${progress}% completato</span>
                    <span>${isComplete ? '🎉 Obiettivo raggiunto!' : 'Mancano ' + formatCurrency(remaining)}</span>
                </div>
            </div>
        `;
    }).join('');
}

// Apri dettaglio obiettivo finanziario per modificarlo
function openMoneyGoalDetail(goalId) {
    const goal = (state.moneyGoals || []).find(g => g.id === goalId);
    if (!goal) return;

    // Per ora mostra un prompt semplice per aggiornare il progresso
    const newAmount = prompt(`Aggiorna importo risparmiato per "${goal.name}":\nAttuale: ${formatCurrency(goal.current)}`, goal.current);

    if (newAmount !== null && !isNaN(parseFloat(newAmount))) {
        goal.current = parseFloat(newAmount);
        saveStateAndSync('moneyGoals', goalId);
        renderFinancePage();

        if (goal.current >= goal.target) {
            showToast(`🎉 Hai raggiunto l'obiettivo "${goal.name}"!`, 'success');
            addXP(50);
            state.stats.goalsCompleted = (state.stats.goalsCompleted || 0) + 1;
            triggerConfetti();
        } else {
            showToast('Obiettivo aggiornato!', 'success');
        }
    }
}

function renderBudget() {
    const container = document.getElementById('budgetByCategory');
    if (!container) return;

    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthExpenses = (state.transactions || []).filter(t => t.type === 'expense' && t.date && t.date.startsWith(thisMonth));

    const byCategory = {};
    monthExpenses.forEach(t => {
        const amount = parseFloat(t.amount) || 0;
        byCategory[t.category || 'other'] = (byCategory[t.category || 'other'] || 0) + amount;
    });

    if (Object.keys(byCategory).length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:20px; text-align:center;">
                <div style="font-size:2rem; margin-bottom:8px;">📊</div>
                <div class="text-muted">Nessuna spesa questo mese</div>
                <div class="text-muted text-xs mt-1">Inizia a registrare le tue spese</div>
            </div>
        `;
        return;
    }

    // Calcola budget per categoria (diviso equamente tra le categorie attive)
    const categoryCount = Object.keys(EXPENSE_CATEGORIES).length;
    const budgetPerCategory = (state.settings.monthlyBudget || 2000) / categoryCount;

    // Ordina per spesa (decrescente)
    const sortedCategories = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);

    container.innerHTML = sortedCategories.map(function(entry) {
        const cat = entry[0];
        const spent = entry[1];
        const catInfo = EXPENSE_CATEGORIES[cat] || EXPENSE_CATEGORIES.other;
        const percentage = Math.min(100, Math.round((spent / budgetPerCategory) * 100));
        const status = percentage > 90 ? 'danger' : percentage > 70 ? 'warning' : 'safe';

        return `
            <div class="budget-item">
                <div class="budget-header">
                    <div class="budget-category">
                        <div class="budget-category-icon cat-${cat}">${catInfo.icon}</div>
                        ${catInfo.name}
                    </div>
                    <div class="budget-amounts">
                        <span class="budget-spent">${formatCurrency(spent)}</span>
                        <span class="budget-limit">/ ${formatCurrency(budgetPerCategory)}</span>
                    </div>
                </div>
                <div class="budget-bar">
                    <div class="budget-progress ${status}" style="width:${percentage}%"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderTransactions() {
    const container = document.getElementById('transactionsList');
    if (!container) return;

    // Filtra per department se la funzione esiste
    let filtered = state.transactions || [];
    if (typeof filterByDepartment === 'function') {
        filtered = filterByDepartment(filtered);
    }

    // Ordina per data (più recenti prima) e prendi le ultime 10
    const sorted = [...filtered].sort((a, b) => {
        const dateA = new Date(a.date || a.createdAt || 0);
        const dateB = new Date(b.date || b.createdAt || 0);
        return dateB - dateA;
    });
    const recent = sorted.slice(0, 10);

    if (recent.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:20px; text-align:center;">
                <div style="font-size:2rem; margin-bottom:8px;">💳</div>
                <div class="text-muted">Nessuna transazione</div>
                <div class="text-muted text-xs mt-1">Registra la tua prima entrata o uscita</div>
            </div>
        `;
        return;
    }

    container.innerHTML = recent.map(function(tx) {
        const amount = parseFloat(tx.amount) || 0;
        const catInfo = tx.type === 'expense'
            ? (EXPENSE_CATEGORIES[tx.category] || EXPENSE_CATEGORIES.other)
            : (INCOME_CATEGORIES[tx.category] || INCOME_CATEGORIES.other);

        const methodIcon = tx.method === 'cash' ? '💵' : tx.method === 'transfer' ? '🏦' : '💳';
        const amountClass = tx.type === 'income' ? 'income' : 'expense';
        const amountPrefix = tx.type === 'income' ? '+' : '-';

        return `
            <div class="transaction-item" onclick="openTransactionDetail('${tx.id}')">
                <div class="transaction-icon cat-${tx.category || 'other'}">${catInfo.icon}</div>
                <div class="transaction-info">
                    <div class="transaction-title">${tx.description || catInfo.name}</div>
                    <div class="transaction-meta">
                        <span>${formatDate(tx.date)}</span>
                        <span>${methodIcon}</span>
                        ${tx.department === 'work' ? '<span>🎭</span>' : ''}
                    </div>
                </div>
                <div class="transaction-amount ${amountClass}">${amountPrefix}${formatCurrency(amount)}</div>
            </div>
        `;
    }).join('');
}

// Dettaglio transazione (per ora semplice alert, in futuro modal)
function openTransactionDetail(txId) {
    const tx = (state.transactions || []).find(t => t.id === txId);
    if (!tx) return;

    const catInfo = tx.type === 'expense'
        ? (EXPENSE_CATEGORIES[tx.category] || EXPENSE_CATEGORIES.other)
        : (INCOME_CATEGORIES[tx.category] || INCOME_CATEGORIES.other);

    const details = `
${tx.type === 'expense' ? '💸 Spesa' : '💰 Entrata'}: ${formatCurrency(tx.amount)}
📂 Categoria: ${catInfo.icon} ${catInfo.name}
📝 Descrizione: ${tx.description || '-'}
📅 Data: ${formatDate(tx.date)}
💳 Metodo: ${tx.method === 'cash' ? 'Contanti' : tx.method === 'transfer' ? 'Bonifico' : 'Carta'}
${tx.department === 'work' ? '🎭 Area: Lavoro' : '👤 Area: Personale'}
    `.trim();

    if (confirm(details + '\n\nVuoi eliminare questa transazione?')) {
        deleteTransaction(txId);
    }
}

// Elimina transazione
function deleteTransaction(txId) {
    const index = (state.transactions || []).findIndex(t => t.id === txId);
    if (index === -1) return;

    // Salva per undo
    const txBackup = { ...state.transactions[index] };

    state.transactions.splice(index, 1);
    state.stats.transactionsCount = Math.max(0, (state.stats.transactionsCount || 1) - 1);
    markItemDeleted('transactions', txId);
    saveStateAndSync('transactions');
    renderFinancePage();

    // Registra azione per undo
    undoSystem.register({
        type: 'deleteTransaction',
        data: txBackup,
        message: '🗑️ Transazione eliminata'
    });
}

function saveExpense() {
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    if (!amount || amount <= 0) {
        showToast('Inserisci un importo valido', 'error');
        return;
    }
    
    const transaction = {
        id: 'tx_' + Date.now(),
        type: 'expense',
        amount: amount,
        description: document.getElementById('expenseDesc').value,
        category: document.getElementById('expenseCategory').value,
        date: document.getElementById('expenseDate').value || state.today.date,
        method: document.getElementById('expenseMethod').value,
        recurring: document.getElementById('expenseRecurring').classList.contains('active'),
        department: document.getElementById('expenseDepartment').value || 'personal',
        createdAt: new Date().toISOString()
    };
    
    state.transactions.push(transaction);
    state.stats.transactionsCount++;
    saveStateAndSync('transactions', transaction.id);

    // Log per KPI
    logAttivita('spesa_registrata', 'finanze', transaction.id, {
        importo: amount,
        categoria: transaction.category,
        metodo: transaction.method
    });

    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseDesc').value = '';

    closeModal('addExpenseModal');
    renderFinancePage();
    renderHomePage();
    addXP(3);
    showToast('Spesa registrata! +3 XP', 'success');
    checkBadges();

    // Check budget alerts
    checkBudgetAlerts();
}

function saveIncome() {
    const amount = parseFloat(document.getElementById('incomeAmount').value);
    if (!amount || amount <= 0) {
        showToast('Inserisci un importo valido', 'error');
        return;
    }
    
    const transaction = {
        id: 'tx_' + Date.now(),
        type: 'income',
        amount: amount,
        description: document.getElementById('incomeDesc').value,
        category: document.getElementById('incomeCategory').value,
        date: document.getElementById('incomeDate').value || state.today.date,
        method: 'transfer',
        department: document.getElementById('incomeDepartment').value || 'personal',
        createdAt: new Date().toISOString()
    };
    
    state.transactions.push(transaction);
    state.stats.transactionsCount++;
    saveStateAndSync('transactions', transaction.id);

    // Log per KPI
    logAttivita('entrata_registrata', 'finanze', transaction.id, {
        importo: amount,
        categoria: transaction.category
    });

    document.getElementById('incomeAmount').value = '';
    document.getElementById('incomeDesc').value = '';

    closeModal('addIncomeModal');
    renderFinancePage();
    renderHomePage();
    addXP(3);
    showToast('Entrata registrata! +3 XP', 'success');
}

// ============================================
// ADVANCED FINANCE FUNCTIONS
// ============================================

function checkBudgetAlerts() {
    if (!state.settings?.budgetAlert) return;

    const thisMonth = new Date().toISOString().slice(0, 7);
    const monthExpenses = state.transactions
        .filter(t => t.type === 'expense' && t.date?.startsWith(thisMonth));

    // Group by category
    const byCategory = {};
    monthExpenses.forEach(t => {
        byCategory[t.category] = (byCategory[t.category] || 0) + t.amount;
    });

    // Calculate budget per category (equal split of monthly budget)
    const categoryCount = Object.keys(EXPENSE_CATEGORIES).length;
    const perCategoryBudget = (state.settings.monthlyBudget || 1000) / categoryCount;

    Object.entries(byCategory).forEach(([cat, spent]) => {
        const budget = perCategoryBudget;
        const percentage = (spent / budget) * 100;

        if (percentage >= 100) {
            const catInfo = EXPENSE_CATEGORIES[cat] || EXPENSE_CATEGORIES.other;
            showToast(`🚨 ${catInfo.name}: hai superato il budget! (${Math.round(percentage)}%)`, 'error');
        } else if (percentage >= 80) {
            const catInfo = EXPENSE_CATEGORIES[cat] || EXPENSE_CATEGORIES.other;
            showToast(`⚠️ ${catInfo.name}: ${Math.round(percentage)}% del budget usato`, 'warning');
        }
    });
}

// Nota: weeklyTrendChartInstance è definita all'inizio del file

function renderWeeklyTrendChart() {
    const ctx = document.getElementById('weeklyTrendChart');
    if (!ctx) return;

    // Get last 7 days data
    const days = [];
    const expenses = [];
    const incomes = [];

    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        days.push(date.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric' }));

        const dayExpense = state.transactions
            .filter(t => t.type === 'expense' && t.date === dateStr)
            .reduce((sum, t) => sum + t.amount, 0);

        const dayIncome = state.transactions
            .filter(t => t.type === 'income' && t.date === dateStr)
            .reduce((sum, t) => sum + t.amount, 0);

        expenses.push(dayExpense);
        incomes.push(dayIncome);
    }

    // Destroy existing chart
    if (weeklyTrendChartInstance) {
        weeklyTrendChartInstance.destroy();
    }

    weeklyTrendChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: days,
            datasets: [
                {
                    label: 'Spese',
                    data: expenses,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: '#ef4444',
                    borderWidth: 1
                },
                {
                    label: 'Entrate',
                    data: incomes,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: '#10b981',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { color: '#94a3b8', font: { size: 11 } }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { color: '#94a3b8' },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                },
                x: {
                    ticks: { color: '#94a3b8' },
                    grid: { display: false }
                }
            }
        }
    });
}

// Split Transaction Functions
function addSplitCategory() {
    const container = document.getElementById('splitCategoriesList');
    const id = Date.now();

    const row = document.createElement('div');
    row.className = 'split-row';
    row.dataset.id = id;
    row.innerHTML = `
        <select class="form-input form-select" style="flex:1;">
            ${Object.entries(EXPENSE_CATEGORIES).map(([k, v]) =>
                `<option value="${k}">${v.icon} ${v.name}</option>`
            ).join('')}
        </select>
        <input type="number" class="form-input" style="width:100px;" placeholder="€0.00" step="0.01" min="0" onchange="updateSplitTotal()">
        <button class="btn btn-sm btn-ghost" onclick="this.parentElement.remove(); updateSplitTotal();">×</button>
    `;
    container.appendChild(row);
}

function updateSplitTotal() {
    const rows = document.querySelectorAll('#splitCategoriesList .split-row');
    let total = 0;

    rows.forEach(row => {
        const amount = parseFloat(row.querySelector('input[type="number"]').value) || 0;
        total += amount;
    });

    document.getElementById('splitTotalCheck').textContent = formatCurrency(total);
}

function saveSplitTransaction() {
    const totalAmount = parseFloat(document.getElementById('splitTotalAmount').value);
    if (!totalAmount || totalAmount <= 0) {
        showToast('Inserisci un importo totale valido', 'error');
        return;
    }

    const description = document.getElementById('splitDescription').value || 'Spesa divisa';
    const date = document.getElementById('splitDate').value || state.today.date;
    const rows = document.querySelectorAll('#splitCategoriesList .split-row');

    if (rows.length === 0) {
        showToast('Aggiungi almeno una categoria', 'error');
        return;
    }

    let splitTotal = 0;
    const transactions = [];

    rows.forEach(row => {
        const category = row.querySelector('select').value;
        const amount = parseFloat(row.querySelector('input[type="number"]').value);

        if (amount && amount > 0) {
            splitTotal += amount;
            const catInfo = EXPENSE_CATEGORIES[category] || EXPENSE_CATEGORIES.other;

            transactions.push({
                id: 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                type: 'expense',
                amount: amount,
                category: category,
                description: `${description} (${catInfo.name})`,
                date: date,
                method: 'card',
                department: 'personal',
                createdAt: new Date().toISOString()
            });
        }
    });

    // Verify total matches
    if (Math.abs(splitTotal - totalAmount) > 0.01) {
        showToast(`Il totale diviso (${formatCurrency(splitTotal)}) non corrisponde all'importo (${formatCurrency(totalAmount)})`, 'warning');
        return;
    }

    // Save all transactions
    transactions.forEach(tx => {
        state.transactions.push(tx);
        state.stats.transactionsCount++;
    });

    saveStateAndSync();

    // Reset modal
    document.getElementById('splitTotalAmount').value = '';
    document.getElementById('splitDescription').value = '';
    document.getElementById('splitCategoriesList').innerHTML = '';
    document.getElementById('splitTotalCheck').textContent = '€0.00';

    closeModal('splitTransactionModal');
    renderFinancePage();
    renderHomePage();
    addXP(5);
    showToast(`${transactions.length} spese create! +5 XP`, 'success');
    checkBudgetAlerts();
}

let selectedGoalIcon = '🏦';

function selectGoalIcon(icon) {
    selectedGoalIcon = icon;
    document.getElementById('moneyGoalIcon').value = icon;
    document.querySelectorAll('.goal-icon-btn').forEach(function(b) { b.classList.remove('btn-primary'); });
    event.target.classList.add('btn-primary');
}

// Alias per selectMoneyGoalIcon (chiamato dai button HTML)
function selectMoneyGoalIcon(btn, icon) {
    selectedGoalIcon = icon;
    document.getElementById('moneyGoalIcon').value = icon;
    document.querySelectorAll('.money-goal-icon').forEach(function(b) { b.classList.remove('active', 'btn-primary'); });
    btn.classList.add('active', 'btn-primary');
}

// Funzione per selezionare icona skill
let selectedSkillIcon = '🎩';

function selectSkillIcon(icon) {
    selectedSkillIcon = icon;
    document.getElementById('skillIcon').value = icon;
    document.querySelectorAll('.skill-icon-btn').forEach(function(b) { b.classList.remove('btn-primary'); });
    if (event && event.target) {
        event.target.classList.add('btn-primary');
    }
}

function saveMoneyGoal() {
    const name = document.getElementById('moneyGoalName').value.trim();
    const target = parseFloat(document.getElementById('moneyGoalTarget').value);
    
    if (!name || !target) {
        showToast('Compila tutti i campi', 'error');
        return;
    }
    
    const goal = {
        id: 'mg_' + Date.now(),
        name: name,
        target: target,
        current: parseFloat(document.getElementById('moneyGoalCurrent').value) || 0,
        deadline: document.getElementById('moneyGoalDeadline').value,
        icon: selectedGoalIcon,
        createdAt: new Date().toISOString()
    };
    
    state.moneyGoals.push(goal);
    saveStateAndSync('moneyGoals', goal.id);

    // Log per KPI
    logAttivita('obiettivo_finanziario_creato', 'finanze', goal.id, {
        nome: name,
        target: target,
        corrente: goal.current
    });

    document.getElementById('moneyGoalName').value = '';
    document.getElementById('moneyGoalTarget').value = '';
    document.getElementById('moneyGoalCurrent').value = '0';

    closeModal('addMoneyGoalModal');
    renderFinancePage();
    addXP(10);
    showToast('Obiettivo creato! +10 XP', 'success');
}


// ============================================
// BOOKS & READING TRACKER
// ============================================

function initBooksPage() {
    if (!state.books) state.books = [];
    if (!state.bookWishlist) state.bookWishlist = [];
    renderBooksPage();
    initRecommendedBooks();
}

function renderBooksPage() {
    renderCurrentlyReading();
    renderCompletedBooks();
    updateBookStats();
}

function renderCurrentlyReading() {
    const container = document.getElementById('currentlyReadingList');
    const reading = (state.books || []).filter(b => !b.completed);

    if (reading.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:20px;">
                <div class="text-muted">Nessun libro in lettura</div>
                <button class="btn btn-primary btn-sm mt-1" onclick="openModal('addBookModal')">+ Aggiungi Libro</button>
            </div>
        `;
        return;
    }

    container.innerHTML = reading.map(book => {
        const progress = book.totalPages > 0 ? Math.round((book.pagesRead / book.totalPages) * 100) : 0;
        return `
            <div class="book-card" onclick="updateBookProgress('${book.id}')">
                <div class="book-cover">📖</div>
                <div class="book-info">
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">${book.author || 'Autore sconosciuto'}</div>
                    <div class="book-progress">
                        <div class="book-progress-bar">
                            <div class="book-progress-fill" style="width:${progress}%"></div>
                        </div>
                        <div class="book-progress-text">${progress}%</div>
                    </div>
                    <div class="text-muted text-xs mt-1">${book.pagesRead}/${book.totalPages} pagine</div>
                </div>
            </div>
        `;
    }).join('');
}

function renderCompletedBooks() {
    const container = document.getElementById('completedBooksList');
    const completed = (state.books || []).filter(b => b.completed);

    if (completed.length === 0) {
        container.innerHTML = `<div class="empty-state" style="padding:20px;"><div class="text-muted">Nessun libro completato</div></div>`;
        return;
    }

    container.innerHTML = completed.map(book => `
        <div class="book-card">
            <div class="book-cover" style="background:var(--success);">✅</div>
            <div class="book-info">
                <div class="book-title">${book.title}</div>
                <div class="book-author">${book.author || 'Autore sconosciuto'}</div>
                <div class="text-muted text-sm">+${book.xpEarned || 0} XP guadagnati</div>
            </div>
        </div>
    `).join('');
}

function updateBookStats() {
    const books = state.books || [];
    const completed = books.filter(b => b.completed);
    const reading = books.filter(b => !b.completed);
    const totalPages = books.reduce((sum, b) => sum + (b.pagesRead || 0), 0);
    const readingXP = books.reduce((sum, b) => sum + (b.xpEarned || 0), 0);

    document.getElementById('booksRead').textContent = completed.length;
    document.getElementById('booksReading').textContent = reading.length;
    document.getElementById('pagesRead').textContent = totalPages;
    document.getElementById('readingXP').textContent = readingXP;

    // Reading goal
    const goalTarget = state.settings?.readingGoal || 12;
    document.getElementById('readingGoalProgress').textContent = `${completed.length}/${goalTarget}`;
    const goalPercent = Math.min(100, (completed.length / goalTarget) * 100);
    document.getElementById('readingGoalBar').style.width = goalPercent + '%';
}

function saveBook() {
    const title = document.getElementById('bookTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    const book = {
        id: 'book_' + Date.now(),
        title: title,
        author: document.getElementById('bookAuthor').value.trim(),
        totalPages: parseInt(document.getElementById('bookPages').value) || 300,
        pagesRead: parseInt(document.getElementById('bookPagesRead').value) || 0,
        completed: false,
        xpEarned: 0,
        createdAt: new Date().toISOString()
    };

    if (!state.books) state.books = [];
    state.books.push(book);
    saveStateAndSync();

    document.getElementById('bookTitle').value = '';
    document.getElementById('bookAuthor').value = '';
    document.getElementById('bookPages').value = '300';
    document.getElementById('bookPagesRead').value = '0';

    closeModal('addBookModal');
    renderBooksPage();
    addXP(5);
    showToast('Libro aggiunto! +5 XP', 'success');
}

function updateBookProgress(bookId) {
    const book = state.books.find(b => b.id === bookId);
    if (!book) return;

    const newPages = prompt(`Pagine lette (attualmente ${book.pagesRead}/${book.totalPages}):`, book.pagesRead);
    if (newPages === null) return;

    const pages = parseInt(newPages);
    if (isNaN(pages) || pages < 0) return;

    const oldPages = book.pagesRead;
    book.pagesRead = Math.min(pages, book.totalPages);

    // XP for pages read
    const pagesGain = book.pagesRead - oldPages;
    if (pagesGain > 0) {
        const xp = Math.floor(pagesGain / 10); // 1 XP per 10 pages
        book.xpEarned = (book.xpEarned || 0) + xp;
        addXP(xp);
        showToast(`+${pagesGain} pagine lette! +${xp} XP`, 'success');
    }

    // Check completion
    if (book.pagesRead >= book.totalPages && !book.completed) {
        book.completed = true;
        book.completedAt = new Date().toISOString();
        const bonusXP = 50;
        book.xpEarned += bonusXP;
        addXP(bonusXP);
        showToast(`📚 Libro completato! +${bonusXP} XP bonus!`, 'success');
        triggerConfetti();
    }

    saveStateAndSync();
    renderBooksPage();
}

// ============================================
// RECOMMENDED BOOKS DATABASE
// ============================================

const RECOMMENDED_BOOKS = [
    // 🎯 Sviluppo Personale e Motivazione
    {
        id: 'rec_1',
        title: 'Il monaco che vendette la sua Ferrari',
        author: 'Robin Sharma',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '🧘',
        summary: 'Un avvocato di successo, sull\'orlo del collasso, abbandona tutto per un viaggio spirituale in India. Attraverso una favola coinvolgente, scoprirai i 7 principi per vivere con più coraggio, equilibrio e gioia. Un libro che ti spinge a ripensare cosa significa davvero "avere successo".',
        pages: 208,
        amazonUrl: 'https://www.amazon.it/s?k=il+monaco+che+vendette+la+sua+ferrari',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=il+monaco+che+vendette+la+sua+ferrari',
        bookOfMonth: true
    },
    {
        id: 'rec_2',
        title: 'Chi ha spostato il mio formaggio?',
        author: 'Spencer Johnson',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '🧀',
        summary: 'Una storia semplice ma potente su quattro personaggi in un labirinto alla ricerca del formaggio. Metafora geniale del cambiamento: chi si adatta prospera, chi resiste resta indietro. Lettura di un\'ora che può cambiarti la vita.',
        pages: 94,
        amazonUrl: 'https://www.amazon.it/s?k=chi+ha+spostato+il+mio+formaggio',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=chi+ha+spostato+il+mio+formaggio'
    },
    {
        id: 'rec_3',
        title: 'Miracle Morning',
        author: 'Hal Elrod',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '🌅',
        summary: 'E se la chiave del successo fosse nelle prime ore del mattino? Elrod propone la routine SAVERS: Silenzio, Affermazioni, Visualizzazione, Esercizio, Lettura, Scrittura. Migliaia di persone hanno trasformato la loro vita semplicemente sveglianosi un\'ora prima.',
        pages: 172,
        amazonUrl: 'https://www.amazon.it/s?k=miracle+morning+hal+elrod',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=miracle+morning'
    },
    {
        id: 'rec_4',
        title: 'Le 7 regole per avere successo',
        author: 'Stephen Covey',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '📋',
        summary: 'Il libro di sviluppo personale più influente di sempre. Covey ti guida dalla dipendenza all\'indipendenza fino all\'interdipendenza, attraverso principi come "Essere proattivi" e "Pensare win-win". Un manuale per l\'efficacia personale e professionale.',
        pages: 464,
        amazonUrl: 'https://www.amazon.it/s?k=le+7+regole+per+avere+successo+covey',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=7+regole+successo+covey'
    },
    {
        id: 'rec_5',
        title: 'La sottile arte di fare quello che c***o ti pare',
        author: 'Mark Manson',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '🔥',
        summary: 'Basta con il pensiero positivo a tutti i costi! Manson ti insegna a scegliere con cura i tuoi problemi, accettare i limiti e concentrarti su ciò che conta davvero. Diretto, irriverente e sorprendentemente profondo.',
        pages: 224,
        amazonUrl: 'https://www.amazon.it/s?k=la+sottile+arte+mark+manson',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=sottile+arte+manson'
    },
    {
        id: 'rec_6',
        title: 'Ikigai',
        author: 'Héctor García e Francesc Miralles',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '🎌',
        summary: 'Il segreto dei centenari giapponesi di Okinawa? Avere uno scopo. Questo libro ti aiuta a trovare l\'intersezione tra ciò che ami, ciò in cui sei bravo, ciò di cui il mondo ha bisogno e ciò per cui puoi essere pagato.',
        pages: 194,
        amazonUrl: 'https://www.amazon.it/s?k=ikigai+garcia+miralles',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=ikigai'
    },
    {
        id: 'rec_7',
        title: 'Psicocibernetica',
        author: 'Maxwell Maltz',
        category: 'motivation',
        categoryLabel: 'Motivazione',
        icon: '🧠',
        summary: 'Un chirurgo plastico scopre che cambiare il volto non basta: bisogna cambiare l\'immagine interiore. Scritto negli anni \'60, è ancora attualissimo. La tua autoimmagine determina i tuoi risultati: impara a riprogrammarla.',
        pages: 304,
        amazonUrl: 'https://www.amazon.it/s?k=psicocibernetica+maltz',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=psicocibernetica'
    },

    // 📈 Produttività e Gestione del Tempo
    {
        id: 'rec_8',
        title: 'Deep Work',
        author: 'Cal Newport',
        category: 'productivity',
        categoryLabel: 'Produttività',
        icon: '🎯',
        summary: 'Nell\'era delle notifiche continue, la capacità di concentrarsi profondamente è un superpotere. Newport ti insegna a eliminare le distrazioni e produrre lavoro di qualità eccezionale in meno tempo.',
        pages: 296,
        amazonUrl: 'https://www.amazon.it/s?k=deep+work+cal+newport',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=deep+work+newport'
    },
    {
        id: 'rec_9',
        title: 'Atomic Habits',
        author: 'James Clear',
        category: 'productivity',
        categoryLabel: 'Produttività',
        icon: '⚛️',
        summary: 'Non servono cambiamenti drastici: basta migliorare dell\'1% ogni giorno. Clear spiega la scienza delle abitudini con un sistema pratico: rendile ovvie, attraenti, facili e soddisfacenti. Il libro sulle abitudini più completo mai scritto.',
        pages: 320,
        amazonUrl: 'https://www.amazon.it/s?k=atomic+habits+james+clear',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=atomic+habits'
    },
    {
        id: 'rec_10',
        title: 'The One Thing',
        author: 'Gary Keller',
        category: 'productivity',
        categoryLabel: 'Produttività',
        icon: '1️⃣',
        summary: 'Qual è l\'unica cosa che puoi fare, tale che facendola tutto il resto diventa più facile o non necessario? Keller dimostra che il multitasking è un mito e il focus estremo è la vera chiave del successo.',
        pages: 240,
        amazonUrl: 'https://www.amazon.it/s?k=the+one+thing+gary+keller',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=one+thing+keller'
    },
    {
        id: 'rec_11',
        title: 'Getting Things Done',
        author: 'David Allen',
        category: 'productivity',
        categoryLabel: 'Produttività',
        icon: '✅',
        summary: 'Il metodo GTD ha rivoluzionato la produttività mondiale. Svuota la mente, cattura tutto in un sistema affidabile e agisci con chiarezza. Meno stress, più risultati.',
        pages: 352,
        amazonUrl: 'https://www.amazon.it/s?k=getting+things+done+david+allen',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=getting+things+done'
    },
    {
        id: 'rec_12',
        title: 'Il metodo Bullet Journal',
        author: 'Ryder Carroll',
        category: 'productivity',
        categoryLabel: 'Produttività',
        icon: '📓',
        summary: 'Più di un\'agenda: un sistema per tracciare il passato, organizzare il presente e progettare il futuro. Con carta e penna, ritrovi focus e intenzionalità in un mondo digitale caotico.',
        pages: 320,
        amazonUrl: 'https://www.amazon.it/s?k=bullet+journal+ryder+carroll',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=bullet+journal'
    },

    // 🧠 Mindset e Psicologia
    {
        id: 'rec_13',
        title: 'Mindset',
        author: 'Carol Dweck',
        category: 'mindset',
        categoryLabel: 'Mindset',
        icon: '🌱',
        summary: 'Esistono due mentalità: fissa ("il talento è innato") e di crescita ("posso migliorare"). Decenni di ricerche dimostrano che la seconda porta a risultati straordinari. Cambia mentalità, cambia vita.',
        pages: 320,
        amazonUrl: 'https://www.amazon.it/s?k=mindset+carol+dweck',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=mindset+dweck'
    },
    {
        id: 'rec_14',
        title: 'L\'arte di pensare chiaro',
        author: 'Rolf Dobelli',
        category: 'mindset',
        categoryLabel: 'Mindset',
        icon: '💡',
        summary: '52 errori di pensiero che tutti commettiamo, spiegati in modo brillante. Dalla fallacia del costo sommerso al bias di conferma: una volta che li conosci, li eviti.',
        pages: 384,
        amazonUrl: 'https://www.amazon.it/s?k=arte+pensare+chiaro+dobelli',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=arte+pensare+chiaro'
    },
    {
        id: 'rec_15',
        title: 'Pensieri lenti e veloci',
        author: 'Daniel Kahneman',
        category: 'mindset',
        categoryLabel: 'Mindset',
        icon: '⚡',
        summary: 'Premio Nobel per l\'economia spiega i due sistemi del pensiero: quello veloce e intuitivo, quello lento e razionale. Capolavoro che svela come prendiamo decisioni e perché spesso sbagliamo.',
        pages: 548,
        amazonUrl: 'https://www.amazon.it/s?k=pensieri+lenti+veloci+kahneman',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=pensieri+lenti+veloci'
    },
    {
        id: 'rec_16',
        title: 'Il potere delle abitudini',
        author: 'Charles Duhigg',
        category: 'mindset',
        categoryLabel: 'Mindset',
        icon: '🔄',
        summary: 'Come nascono le abitudini? Come si cambiano? Duhigg esplora la scienza del "loop dell\'abitudine" con storie affascinanti, da Starbucks agli atleti olimpici. Capire il meccanismo è il primo passo per cambiare.',
        pages: 416,
        amazonUrl: 'https://www.amazon.it/s?k=potere+abitudini+duhigg',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=potere+abitudini'
    },

    // 💼 Business e Leadership
    {
        id: 'rec_17',
        title: 'Come trattare gli altri e farseli amici',
        author: 'Dale Carnegie',
        category: 'business',
        categoryLabel: 'Business',
        icon: '🤝',
        summary: 'Scritto nel 1936, ha venduto 30 milioni di copie. Perché? Funziona. Principi semplici ma potenti per costruire relazioni, influenzare positivamente e diventare un leader naturale.',
        pages: 288,
        amazonUrl: 'https://www.amazon.it/s?k=come+trattare+altri+farseli+amici+carnegie',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=trattare+altri+farseli+amici'
    },
    {
        id: 'rec_18',
        title: 'Start with Why',
        author: 'Simon Sinek',
        category: 'business',
        categoryLabel: 'Business',
        icon: '❓',
        summary: 'Perché Apple ispira e altri no? Sinek rivela il "Golden Circle": i grandi leader partono dal PERCHÉ, non dal cosa. Trova il tuo perché e ispirerai gli altri.',
        pages: 256,
        amazonUrl: 'https://www.amazon.it/s?k=start+with+why+simon+sinek',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=start+with+why'
    },
    {
        id: 'rec_19',
        title: 'The Lean Startup',
        author: 'Eric Ries',
        category: 'business',
        categoryLabel: 'Business',
        icon: '🚀',
        summary: 'Non serve il business plan perfetto: servono esperimenti rapidi. Il metodo Lean ti insegna a costruire, misurare, imparare. Fallisci velocemente, impara prima, vinci alla fine.',
        pages: 336,
        amazonUrl: 'https://www.amazon.it/s?k=lean+startup+eric+ries',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=lean+startup'
    },
    {
        id: 'rec_20',
        title: 'Zero to One',
        author: 'Peter Thiel',
        category: 'business',
        categoryLabel: 'Business',
        icon: '0️⃣',
        summary: 'Il co-fondatore di PayPal spiega come creare il futuro. Non copiare, inventa. Non competere, monopolizza. Pensiero contrarian che sfida ogni convenzione.',
        pages: 224,
        amazonUrl: 'https://www.amazon.it/s?k=zero+to+one+peter+thiel',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=zero+to+one'
    },

    // 💰 Finanza Personale
    {
        id: 'rec_21',
        title: 'Padre Ricco Padre Povero',
        author: 'Robert Kiyosaki',
        category: 'finance',
        categoryLabel: 'Finanza',
        icon: '💵',
        summary: 'Due padri, due filosofie: uno dice "studia e trova un lavoro sicuro", l\'altro "fai lavorare i soldi per te". Kiyosaki ti insegna la differenza tra attivi e passivi, e perché i ricchi pensano diversamente.',
        pages: 336,
        amazonUrl: 'https://www.amazon.it/s?k=padre+ricco+padre+povero+kiyosaki',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=padre+ricco+padre+povero'
    },
    {
        id: 'rec_22',
        title: 'L\'uomo più ricco di Babilonia',
        author: 'George Clason',
        category: 'finance',
        categoryLabel: 'Finanza',
        icon: '🏛️',
        summary: 'Parabole ambientate nell\'antica Babilonia che insegnano principi finanziari eterni: paga prima te stesso, vivi sotto le tue possibilità, investi saggiamente. Semplice, potente, senza tempo.',
        pages: 144,
        amazonUrl: 'https://www.amazon.it/s?k=uomo+piu+ricco+babilonia+clason',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=uomo+ricco+babilonia'
    },
    {
        id: 'rec_23',
        title: 'Ricco prima delle 8',
        author: 'Alfio Bardolla',
        category: 'finance',
        categoryLabel: 'Finanza',
        icon: '⏰',
        summary: 'Il coach finanziario italiano più famoso ti sfida: cosa fai prima delle 8 di mattina determina la tua ricchezza. Strategie pratiche per l\'indipendenza finanziaria, applicabili subito.',
        pages: 176,
        amazonUrl: 'https://www.amazon.it/s?k=ricco+prima+delle+8+bardolla',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=ricco+prima+8+bardolla'
    },
    {
        id: 'rec_24',
        title: 'I soldi fanno la felicità',
        author: 'Alfio Bardolla',
        category: 'finance',
        categoryLabel: 'Finanza',
        icon: '😊',
        summary: 'Sfata il mito che "i soldi non fanno la felicità". Bardolla dimostra che la libertà finanziaria è una competenza che si può imparare, con esempi concreti e mentalità vincente.',
        pages: 192,
        amazonUrl: 'https://www.amazon.it/s?k=soldi+fanno+felicita+bardolla',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=soldi+felicita+bardolla'
    },

    // 🗣️ Comunicazione e Soft Skills
    {
        id: 'rec_25',
        title: 'Le armi della persuasione',
        author: 'Robert Cialdini',
        category: 'communication',
        categoryLabel: 'Comunicazione',
        icon: '🎭',
        summary: 'Sei principi psicologici che ci spingono a dire "sì": reciprocità, impegno, riprova sociale, autorità, simpatia, scarsità. Usali eticamente e diventerai irresistibile.',
        pages: 280,
        amazonUrl: 'https://www.amazon.it/s?k=armi+persuasione+cialdini',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=armi+persuasione'
    },
    {
        id: 'rec_26',
        title: 'Comunicare come Steve Jobs',
        author: 'Carmine Gallo',
        category: 'communication',
        categoryLabel: 'Comunicazione',
        icon: '🍎',
        summary: 'Jobs non vendeva prodotti, vendeva sogni. Gallo analizza le sue presentazioni leggendarie e ti insegna a creare storie, usare la regola del tre e lasciare il pubblico a bocca aperta.',
        pages: 272,
        amazonUrl: 'https://www.amazon.it/s?k=comunicare+come+steve+jobs+gallo',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=comunicare+steve+jobs'
    },
    {
        id: 'rec_27',
        title: 'Linguaggio del corpo',
        author: 'Allan Pease',
        category: 'communication',
        categoryLabel: 'Comunicazione',
        icon: '👋',
        summary: 'Il 93% della comunicazione è non verbale. Impara a leggere gesti, posture e microespressioni. Saprai cosa pensa veramente chi hai di fronte, anche quando non parla.',
        pages: 408,
        amazonUrl: 'https://www.amazon.it/s?k=linguaggio+corpo+allan+pease',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=linguaggio+corpo+pease'
    },

    // 🧘 Benessere e Equilibrio
    {
        id: 'rec_28',
        title: 'Il potere di adesso',
        author: 'Eckhart Tolle',
        category: 'wellbeing',
        categoryLabel: 'Benessere',
        icon: '☯️',
        summary: 'La mente ti intrappola tra rimpianti del passato e ansie del futuro. Tolle ti guida al momento presente, l\'unico luogo dove esiste la vera pace. Spiritualità pratica e trasformativa.',
        pages: 236,
        amazonUrl: 'https://www.amazon.it/s?k=potere+adesso+eckhart+tolle',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=potere+adesso+tolle'
    },
    {
        id: 'rec_29',
        title: 'Perché dormiamo',
        author: 'Matthew Walker',
        category: 'wellbeing',
        categoryLabel: 'Benessere',
        icon: '😴',
        summary: 'Dormire poco non è un vanto, è un suicidio lento. Walker, neuroscienziato, spiega perché il sonno è la base di salute, memoria e creatività. Dopo questo libro, andrai a letto prima.',
        pages: 368,
        amazonUrl: 'https://www.amazon.it/s?k=perche+dormiamo+matthew+walker',
        ibsUrl: 'https://www.ibs.it/search/?ts=as&query=perche+dormiamo'
    }
];

// Inizializza la sezione libri consigliati
function initRecommendedBooks() {
    renderBookOfMonth();
    renderRecommendedBooks();
}

// Render libro del mese
function renderBookOfMonth() {
    const bookOfMonth = RECOMMENDED_BOOKS.find(b => b.bookOfMonth);
    const card = document.getElementById('bookOfMonthCard');
    const content = document.getElementById('bookOfMonthContent');

    if (!bookOfMonth || !card || !content) return;

    card.style.display = 'block';

    const userStatus = getBookUserStatus(bookOfMonth.id);

    content.innerHTML = `
        <div class="recommended-book-card book-of-month" onclick="openBookDetail('${bookOfMonth.id}')" style="margin:0;border:none;background:transparent;">
            <div class="recommended-book-header">
                <div class="recommended-book-cover motivation">
                    <span>${bookOfMonth.icon}</span>
                    <span class="book-of-month-badge">⭐ TOP</span>
                </div>
                <div class="recommended-book-info">
                    <div class="recommended-book-title">${bookOfMonth.title}</div>
                    <div class="recommended-book-author">${bookOfMonth.author}</div>
                    ${userStatus ? `<span class="book-status-badge ${userStatus.status}">${userStatus.icon} ${userStatus.label}</span>` : ''}
                </div>
            </div>
            <div class="recommended-book-summary">${bookOfMonth.summary.substring(0, 150)}...</div>
            <div class="recommended-book-actions">
                <button class="book-action-btn primary" onclick="event.stopPropagation(); addRecommendedToReading('${bookOfMonth.id}')">
                    📖 Inizia a leggere
                </button>
                <button class="book-action-btn secondary" onclick="event.stopPropagation(); openBookDetail('${bookOfMonth.id}')">
                    ℹ️ Dettagli
                </button>
            </div>
        </div>
    `;
}

// Render lista libri consigliati
function renderRecommendedBooks() {
    const container = document.getElementById('recommendedBooksList');
    if (!container) return;

    let books = RECOMMENDED_BOOKS;

    // Filtra per categoria
    if (currentBookFilter !== 'all') {
        books = books.filter(b => b.category === currentBookFilter);
    }

    // Escludi il libro del mese dalla lista se mostriamo tutti
    if (currentBookFilter === 'all') {
        books = books.filter(b => !b.bookOfMonth);
    }

    if (books.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:30px;">
                <div style="font-size:3rem;margin-bottom:10px;">📚</div>
                <div class="text-muted">Nessun libro in questa categoria</div>
            </div>
        `;
        return;
    }

    container.innerHTML = books.map(book => {
        const userStatus = getBookUserStatus(book.id);
        return `
            <div class="recommended-book-card" onclick="openBookDetail('${book.id}')">
                <div class="recommended-book-header">
                    <div class="recommended-book-cover ${book.category}">
                        <span>${book.icon}</span>
                    </div>
                    <div class="recommended-book-info">
                        <div class="recommended-book-title">${book.title}</div>
                        <div class="recommended-book-author">${book.author}</div>
                        <span class="recommended-book-category">${book.categoryLabel}</span>
                        ${userStatus ? `<span class="book-status-badge ${userStatus.status}" style="margin-left:8px;">${userStatus.icon} ${userStatus.label}</span>` : ''}
                    </div>
                </div>
                <div class="recommended-book-summary">${book.summary.substring(0, 120)}...</div>
                <div class="recommended-book-actions">
                    ${!userStatus || userStatus.status === 'wishlist' ? `
                        <button class="book-action-btn primary" onclick="event.stopPropagation(); addRecommendedToReading('${book.id}')">
                            📖 Leggi
                        </button>
                    ` : ''}
                    <button class="book-action-btn secondary" onclick="event.stopPropagation(); openBookDetail('${book.id}')">
                        ℹ️ Info
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Filtra libri per categoria
function filterRecommendedBooks(category) {
    currentBookFilter = category;

    // Aggiorna bottoni attivi
    document.querySelectorAll('.book-category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    renderRecommendedBooks();
}

// Controlla lo stato del libro per l'utente
function getBookUserStatus(recommendedId) {
    if (!state.books) return null;

    const recBook = RECOMMENDED_BOOKS.find(b => b.id === recommendedId);
    if (!recBook) return null;

    // Cerca tra i libri dell'utente (per titolo)
    const userBook = state.books.find(b =>
        b.title.toLowerCase().includes(recBook.title.toLowerCase().substring(0, 20)) ||
        b.recommendedId === recommendedId
    );

    if (!userBook) {
        // Controlla wishlist
        if (state.bookWishlist && state.bookWishlist.includes(recommendedId)) {
            return { status: 'wishlist', icon: '💫', label: 'Da leggere' };
        }
        return null;
    }

    if (userBook.completed) {
        return { status: 'completed', icon: '✅', label: 'Completato' };
    }

    return { status: 'reading', icon: '📖', label: 'In lettura' };
}

// Apri dettaglio libro
function openBookDetail(bookId) {
    const book = RECOMMENDED_BOOKS.find(b => b.id === bookId);
    if (!book) return;

    const userStatus = getBookUserStatus(bookId);

    const content = document.getElementById('bookDetailContent');
    content.innerHTML = `
        <div class="book-detail-cover ${book.category}">
            ${book.icon}
        </div>
        <div class="book-detail-title">${book.title}</div>
        <div class="book-detail-author">di ${book.author}</div>

        <div style="display:flex;justify-content:center;gap:10px;margin-bottom:16px;">
            <span class="recommended-book-category">${book.categoryLabel}</span>
            <span class="badge">${book.pages} pagine</span>
            ${userStatus ? `<span class="book-status-badge ${userStatus.status}">${userStatus.icon} ${userStatus.label}</span>` : ''}
        </div>

        <div class="book-detail-summary">
            <strong>📝 Perché leggerlo:</strong><br><br>
            ${book.summary}
        </div>

        <div style="margin-top:16px;">
            ${!userStatus || userStatus.status === 'wishlist' ? `
                <button class="btn btn-primary" style="width:100%;margin-bottom:10px;" onclick="addRecommendedToReading('${book.id}'); closeModal('bookDetailModal');">
                    📖 Aggiungi ai libri in lettura
                </button>
            ` : ''}
            ${!userStatus ? `
                <button class="btn btn-secondary" style="width:100%;margin-bottom:10px;" onclick="addToWishlist('${book.id}')">
                    💫 Aggiungi alla lista desideri
                </button>
            ` : ''}
        </div>

        <div class="book-buy-links">
            <a href="${book.amazonUrl}" target="_blank" class="book-buy-btn amazon" onclick="event.stopPropagation();">
                🛒 Amazon
            </a>
            <a href="${book.ibsUrl}" target="_blank" class="book-buy-btn ibs" onclick="event.stopPropagation();">
                📚 IBS
            </a>
        </div>
    `;

    openModal('bookDetailModal');
}

// Aggiungi libro consigliato ai libri in lettura
function addRecommendedToReading(recommendedId) {
    const recBook = RECOMMENDED_BOOKS.find(b => b.id === recommendedId);
    if (!recBook) return;

    // Controlla se già esiste
    const existing = (state.books || []).find(b =>
        b.title.toLowerCase() === recBook.title.toLowerCase() ||
        b.recommendedId === recommendedId
    );

    if (existing) {
        showToast('Questo libro è già nella tua lista!', 'warning');
        return;
    }

    const book = {
        id: 'book_' + Date.now(),
        recommendedId: recommendedId,
        title: recBook.title,
        author: recBook.author,
        totalPages: recBook.pages,
        pagesRead: 0,
        completed: false,
        xpEarned: 0,
        createdAt: new Date().toISOString()
    };

    if (!state.books) state.books = [];
    state.books.push(book);

    // Rimuovi dalla wishlist se presente
    if (state.bookWishlist) {
        state.bookWishlist = state.bookWishlist.filter(id => id !== recommendedId);
    }

    saveStateAndSync();
    renderBooksPage();
    initRecommendedBooks();
    addXP(5);
    showToast(`"${recBook.title}" aggiunto! +5 XP`, 'success');
}

// Aggiungi alla wishlist
function addToWishlist(recommendedId) {
    if (!state.bookWishlist) state.bookWishlist = [];

    if (state.bookWishlist.includes(recommendedId)) {
        showToast('Già nella lista desideri!', 'warning');
        return;
    }

    const book = RECOMMENDED_BOOKS.find(b => b.id === recommendedId);
    state.bookWishlist.push(recommendedId);
    saveStateAndSync();
    initRecommendedBooks();
    showToast(`"${book.title}" aggiunto alla lista desideri!`, 'success');
}


// ============================================
// CHALLENGES & ACHIEVEMENTS
// ============================================

const CHALLENGES = [
    { id: 'daily_5tasks', type: 'daily', title: '5 Task Champion', desc: 'Completa 5 task oggi', target: 5, metric: 'tasksToday', reward: 25, icon: '✅' },
    { id: 'daily_3pomodoros', type: 'daily', title: 'Focus Master', desc: 'Completa 3 pomodori oggi', target: 3, metric: 'pomodorosToday', reward: 20, icon: '🍅' },
    { id: 'daily_savers', type: 'daily', title: 'Morning Warrior', desc: 'Completa S.A.V.E.R.S.', target: 6, metric: 'routineToday', reward: 30, icon: '🌅' },
    { id: 'weekly_25tasks', type: 'weekly', title: 'Productivity Beast', desc: 'Completa 25 task questa settimana', target: 25, metric: 'tasksWeek', reward: 100, icon: '🦁' },
    { id: 'weekly_15pomodoros', type: 'weekly', title: 'Deep Focus', desc: '15 pomodori questa settimana', target: 15, metric: 'pomodorosWeek', reward: 75, icon: '🧠' },
    { id: 'weekly_book', type: 'weekly', title: 'Book Worm', desc: 'Leggi 100 pagine questa settimana', target: 100, metric: 'pagesWeek', reward: 50, icon: '📚' },
    { id: 'monthly_streak', type: 'monthly', title: 'Consistency King', desc: '30 giorni di streak', target: 30, metric: 'streak', reward: 500, icon: '👑' }
];

const ACHIEVEMENTS = [
    { id: 'first_task', icon: '🎯', name: 'Primo Task', desc: 'Completa il primo task', condition: s => s.stats.tasksCompleted >= 1 },
    { id: 'task_10', icon: '✅', name: '10 Task', desc: 'Completa 10 task', condition: s => s.stats.tasksCompleted >= 10 },
    { id: 'task_50', icon: '💪', name: '50 Task', desc: 'Completa 50 task', condition: s => s.stats.tasksCompleted >= 50 },
    { id: 'task_100', icon: '🏆', name: '100 Task', desc: 'Completa 100 task', condition: s => s.stats.tasksCompleted >= 100 },
    { id: 'pomodoro_10', icon: '🍅', name: 'Pomodoro Lover', desc: '10 pomodori', condition: s => s.stats.pomodorosTotal >= 10 },
    { id: 'pomodoro_50', icon: '🔥', name: 'Focus Fire', desc: '50 pomodori', condition: s => s.stats.pomodorosTotal >= 50 },
    { id: 'streak_7', icon: '📅', name: 'Week Warrior', desc: '7 giorni streak', condition: s => (s.stats.currentStreak || 0) >= 7 },
    { id: 'streak_30', icon: '🌟', name: 'Month Master', desc: '30 giorni streak', condition: s => (s.stats.currentStreak || 0) >= 30 },
    { id: 'book_1', icon: '📖', name: 'Reader', desc: 'Completa 1 libro', condition: s => (s.books || []).filter(b => b.completed).length >= 1 },
    { id: 'book_5', icon: '📚', name: 'Bookworm', desc: 'Completa 5 libri', condition: s => (s.books || []).filter(b => b.completed).length >= 5 },
    { id: 'level_5', icon: '⭐', name: 'Rising Star', desc: 'Raggiungi livello 5', condition: s => (s.stats.level || 1) >= 5 },
    { id: 'level_10', icon: '💎', name: 'Diamond', desc: 'Raggiungi livello 10', condition: s => (s.stats.level || 1) >= 10 }
];

function initChallengesPage() {
    renderActiveChallenges();
    renderAchievements();
    renderPersonalRecords();
}

function renderActiveChallenges() {
    const container = document.getElementById('activeChallengesList');
    if (!container) return;

    container.innerHTML = CHALLENGES.map(challenge => {
        const progress = getChallengeProgress(challenge);
        const percent = Math.min(100, (progress / challenge.target) * 100);
        const completed = progress >= challenge.target;

        return `
            <div class="challenge-card ${completed ? 'completed' : 'active'}">
                <span class="challenge-badge ${challenge.type}">${challenge.type === 'daily' ? 'Giornaliera' : challenge.type === 'weekly' ? 'Settimanale' : 'Mensile'}</span>
                <div class="challenge-title">${challenge.icon} ${challenge.title}</div>
                <div class="challenge-desc">${challenge.desc}</div>
                <div class="challenge-progress">
                    <div class="challenge-bar">
                        <div class="challenge-bar-fill" style="width:${percent}%"></div>
                    </div>
                    <span>${progress}/${challenge.target}</span>
                </div>
                <div class="challenge-reward">🎁 ${challenge.reward} XP</div>
            </div>
        `;
    }).join('');
}

function getChallengeProgress(challenge) {
    switch(challenge.metric) {
        case 'tasksToday':
            return state.tasks.filter(t => t.completed && t.completedDate === state.today.date).length;
        case 'pomodorosToday':
            return state.today.pomodoros || 0;
        case 'routineToday':
            return Object.values(state.today.routine || {}).filter(v => v).length;
        case 'tasksWeek':
            return getWeeklyTasksCompleted();
        case 'pomodorosWeek':
            return getWeeklyPomodoros();
        case 'pagesWeek':
            return getWeeklyPagesRead();
        case 'streak':
            return state.stats.currentStreak || 0;
        default:
            return 0;
    }
}

function getWeeklyTasksCompleted() {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    return state.tasks.filter(t => t.completed && new Date(t.completedDate) >= weekAgo).length;
}

function getWeeklyPomodoros() {
    // Simplified - would need daily tracking
    return (state.today.pomodoros || 0) * 3; // Estimate
}

function getWeeklyPagesRead() {
    // Simplified
    return (state.books || []).reduce((sum, b) => sum + (b.pagesRead || 0), 0);
}

function renderAchievements() {
    const container = document.getElementById('achievementGrid');
    if (!container) return;

    if (!state.achievements) state.achievements = [];

    container.innerHTML = ACHIEVEMENTS.map(ach => {
        const unlocked = state.achievements.includes(ach.id) || ach.condition(state);
        if (unlocked && !state.achievements.includes(ach.id)) {
            state.achievements.push(ach.id);
            saveStateAndSync();
        }

        return `
            <div class="achievement-item ${unlocked ? 'unlocked' : 'locked'}">
                <div class="achievement-icon">${ach.icon}</div>
                <div class="achievement-name">${ach.name}</div>
            </div>
        `;
    }).join('');
}

function renderPersonalRecords() {
    const container = document.getElementById('personalRecords');
    if (!container) return;

    const records = [
        { icon: '✅', label: 'Max Task/Giorno', value: state.stats.maxTasksDay || 0 },
        { icon: '🍅', label: 'Max Pomodori/Giorno', value: state.stats.maxPomodorosDay || 0 },
        { icon: '🔥', label: 'Streak Più Lungo', value: state.stats.longestStreak || 0 },
        { icon: '📚', label: 'Libri Letti', value: (state.books || []).filter(b => b.completed).length }
    ];

    container.innerHTML = records.map(r => `
        <div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid var(--border-light);">
            <span>${r.icon} ${r.label}</span>
            <span style="font-weight:700; color:var(--primary);">${r.value}</span>
        </div>
    `).join('');
}


// ============================================
// ADVANCED ANALYTICS
// ============================================

function renderAdvancedAnalytics() {
    renderProductivityHeatmap();
    renderCorrelations();
    renderPersonalizedTips();
}

function renderProductivityHeatmap() {
    const container = document.getElementById('productivityHeatmap');
    if (!container) return;

    // Generate 4 weeks of data
    const cells = [];
    const dayScores = {};

    for (let week = 0; week < 4; week++) {
        for (let day = 0; day < 7; day++) {
            const date = new Date();
            date.setDate(date.getDate() - (28 - (week * 7 + day)));
            const dateStr = date.toISOString().split('T')[0];

            // Calculate productivity score for that day
            const dayTasks = state.tasks.filter(t => t.completedDate === dateStr).length;
            const score = Math.min(5, Math.ceil(dayTasks / 2));

            const dayName = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'][date.getDay()];
            if (!dayScores[dayName]) dayScores[dayName] = [];
            dayScores[dayName].push(score);

            cells.push(`<div class="heatmap-cell level-${score}" title="${dateStr}: ${dayTasks} task"></div>`);
        }
    }

    container.innerHTML = cells.join('');

    // Find best day
    let bestDay = 'Lun';
    let bestAvg = 0;
    for (const [day, scores] of Object.entries(dayScores)) {
        const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
        if (avg > bestAvg) {
            bestAvg = avg;
            bestDay = day;
        }
    }
    document.getElementById('bestDayText').textContent = `📊 Sei più produttivo il ${bestDay}`;
}

function renderCorrelations() {
    const container = document.getElementById('correlationsList');
    if (!container) return;

    const correlations = analyzeCorrelations();

    container.innerHTML = correlations.map(c => `
        <div class="correlation-item">
            <div class="correlation-icon">${c.icon}</div>
            <div class="correlation-text">${c.text}</div>
            <div class="correlation-value ${c.positive ? '' : 'negative'}">${c.positive ? '+' : ''}${c.value}%</div>
        </div>
    `).join('');
}

function analyzeCorrelations() {
    // Simplified correlation analysis
    const correlations = [];

    // Sleep correlation (if tracked)
    if (state.today.sleep) {
        const sleepEffect = state.today.sleep >= 7 ? 30 : state.today.sleep >= 6 ? 10 : -20;
        correlations.push({
            icon: '😴',
            text: state.today.sleep >= 7 ? 'Dormi 7h+ = più produttivo' : 'Più sonno = più produttività',
            value: sleepEffect,
            positive: sleepEffect > 0
        });
    }

    // Morning routine correlation
    const routineComplete = Object.values(state.today.routine || {}).filter(v => v).length;
    if (routineComplete > 0) {
        correlations.push({
            icon: '🌅',
            text: 'S.A.V.E.R.S. completati = focus migliore',
            value: routineComplete * 5,
            positive: true
        });
    }

    // Pomodoro correlation
    if (state.today.pomodoros > 0) {
        correlations.push({
            icon: '🍅',
            text: 'Pomodori = task completati',
            value: Math.min(50, state.today.pomodoros * 10),
            positive: true
        });
    }

    if (correlations.length === 0) {
        correlations.push({
            icon: '📊',
            text: 'Continua a tracciare per scoprire pattern',
            value: 0,
            positive: true
        });
    }

    return correlations;
}

function renderPersonalizedTips() {
    const container = document.getElementById('personalizedTips');
    if (!container) return;

    const tips = generatePersonalizedTips();

    container.innerHTML = tips.map(tip => `
        <div class="suggestion-card" onclick="${tip.action}">
            <div class="suggestion-title">${tip.icon} ${tip.title}</div>
            <div class="suggestion-desc">${tip.desc}</div>
        </div>
    `).join('');
}

function generatePersonalizedTips() {
    const tips = [];
    const hour = new Date().getHours();

    // Time-based tips
    if (hour >= 6 && hour < 10 && !Object.values(state.today.routine || {}).some(v => v)) {
        tips.push({
            icon: '🌅',
            title: 'Inizia con S.A.V.E.R.S.',
            desc: 'La routine mattutina aumenta la produttività del 30%',
            action: "switchPage('routine')"
        });
    }

    if (state.today.pomodoros < 2 && hour >= 9 && hour < 17) {
        tips.push({
            icon: '🍅',
            title: 'Tempo per un Pomodoro!',
            desc: 'Hai completato solo ' + (state.today.pomodoros || 0) + ' pomodori oggi',
            action: "switchPage('focus')"
        });
    }

    // Task-based tips
    const pendingTasks = state.tasks.filter(t => !t.completed).length;
    if (pendingTasks > 10) {
        tips.push({
            icon: '📋',
            title: 'Troppe cose da fare?',
            desc: `Hai ${pendingTasks} task. Prova a prioritizzare i top 3.`,
            action: "switchPage('tasks')"
        });
    }

    // Default tip
    if (tips.length === 0) {
        tips.push({
            icon: '💪',
            title: 'Ottimo lavoro!',
            desc: 'Continua così! Stai andando alla grande.',
            action: ""
        });
    }

    return tips;
}


// ============================================
// AMBIENT SOUNDS - Web Audio API
// ============================================

let audioContext = null;
let currentSoundNodes = null;
let currentSoundType = null;

// Inizializza AudioContext
function initAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    return audioContext;
}

// Genera rumore bianco
function createWhiteNoise(ctx, duration = 2) {
    const bufferSize = ctx.sampleRate * duration;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
    }
    return buffer;
}

// Genera rumore rosa (più naturale)
function createPinkNoise(ctx, duration = 2) {
    const bufferSize = ctx.sampleRate * duration;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
    for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        b0 = 0.99886 * b0 + white * 0.0555179;
        b1 = 0.99332 * b1 + white * 0.0750759;
        b2 = 0.96900 * b2 + white * 0.1538520;
        b3 = 0.86650 * b3 + white * 0.3104856;
        b4 = 0.55000 * b4 + white * 0.5329522;
        b5 = -0.7616 * b5 - white * 0.0168980;
        data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
        b6 = white * 0.115926;
    }
    return buffer;
}

// Genera rumore marrone (basse frequenze)
function createBrownNoise(ctx, duration = 2) {
    const bufferSize = ctx.sampleRate * duration;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    let lastOut = 0;
    for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        data[i] = (lastOut + (0.02 * white)) / 1.02;
        lastOut = data[i];
        data[i] *= 3.5;
    }
    return buffer;
}

// Crea suono ambient
function createAmbientSound(type) {
    const ctx = initAudioContext();
    const gainNode = ctx.createGain();
    const volume = (document.getElementById('soundVolume')?.value || 50) / 100;
    gainNode.gain.value = volume * 0.3;
    gainNode.connect(ctx.destination);

    let sourceNode, filterNode;

    switch(type) {
        case 'rain':
            // Pioggia: rumore rosa filtrato
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createPinkNoise(ctx, 4);
            sourceNode.loop = true;
            filterNode = ctx.createBiquadFilter();
            filterNode.type = 'lowpass';
            filterNode.frequency.value = 3000;
            sourceNode.connect(filterNode);
            filterNode.connect(gainNode);
            break;

        case 'ocean':
            // Onde: rumore marrone con modulazione
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createBrownNoise(ctx, 4);
            sourceNode.loop = true;
            filterNode = ctx.createBiquadFilter();
            filterNode.type = 'lowpass';
            filterNode.frequency.value = 500;
            const lfo = ctx.createOscillator();
            const lfoGain = ctx.createGain();
            lfo.frequency.value = 0.1;
            lfoGain.gain.value = 200;
            lfo.connect(lfoGain);
            lfoGain.connect(filterNode.frequency);
            lfo.start();
            sourceNode.connect(filterNode);
            filterNode.connect(gainNode);
            break;

        case 'wind':
            // Vento: rumore bianco filtrato passa-banda
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createWhiteNoise(ctx, 4);
            sourceNode.loop = true;
            filterNode = ctx.createBiquadFilter();
            filterNode.type = 'bandpass';
            filterNode.frequency.value = 800;
            filterNode.Q.value = 0.5;
            sourceNode.connect(filterNode);
            filterNode.connect(gainNode);
            break;

        case 'fire':
            // Fuoco: rumore crackle
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createBrownNoise(ctx, 4);
            sourceNode.loop = true;
            filterNode = ctx.createBiquadFilter();
            filterNode.type = 'highpass';
            filterNode.frequency.value = 200;
            sourceNode.connect(filterNode);
            filterNode.connect(gainNode);
            break;

        case 'whitenoise':
            // White noise puro
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createWhiteNoise(ctx, 4);
            sourceNode.loop = true;
            sourceNode.connect(gainNode);
            break;

        case 'forest':
        case 'birds':
            // Foresta/Uccelli: rumore rosa con modulazione alta
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createPinkNoise(ctx, 4);
            sourceNode.loop = true;
            filterNode = ctx.createBiquadFilter();
            filterNode.type = 'bandpass';
            filterNode.frequency.value = 2000;
            filterNode.Q.value = 2;
            sourceNode.connect(filterNode);
            filterNode.connect(gainNode);
            break;

        case 'cafe':
            // Caffè: rumore rosa leggero
            sourceNode = ctx.createBufferSource();
            sourceNode.buffer = createPinkNoise(ctx, 4);
            sourceNode.loop = true;
            filterNode = ctx.createBiquadFilter();
            filterNode.type = 'lowpass';
            filterNode.frequency.value = 4000;
            sourceNode.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.gain.value = volume * 0.15;
            break;

        default:
            return null;
    }

    sourceNode.start();
    return { source: sourceNode, gain: gainNode, filter: filterNode };
}

function toggleSound(soundType) {
    const btns = document.querySelectorAll('.sound-btn');
    btns.forEach(btn => btn.classList.remove('active'));

    // Se stesso suono, fermalo
    if (currentSoundType === soundType && currentSoundNodes) {
        stopCurrentSound();
        showToast('Suono fermato', 'info');
        return;
    }

    // Ferma suono precedente
    stopCurrentSound();

    // Avvia nuovo suono
    try {
        currentSoundNodes = createAmbientSound(soundType);
        currentSoundType = soundType;

        if (currentSoundNodes) {
            event.target.closest('.sound-btn').classList.add('active');
            const soundNames = {
                rain: 'Pioggia', forest: 'Foresta', cafe: 'Caffè', ocean: 'Oceano',
                fire: 'Fuoco', wind: 'Vento', whitenoise: 'White Noise', birds: 'Uccelli'
            };
            showToast('🎵 ' + (soundNames[soundType] || soundType), 'success');
        }
    } catch (e) {
        console.error('Audio error:', e);
        showToast('Audio non supportato', 'error');
    }
}

function stopCurrentSound() {
    if (currentSoundNodes) {
        try {
            currentSoundNodes.source.stop();
            currentSoundNodes.source.disconnect();
            if (currentSoundNodes.filter) currentSoundNodes.filter.disconnect();
            currentSoundNodes.gain.disconnect();
        } catch (e) {}
        currentSoundNodes = null;
        currentSoundType = null;
    }
}

function setSoundVolume(value) {
    if (currentSoundNodes && currentSoundNodes.gain) {
        currentSoundNodes.gain.gain.value = (value / 100) * 0.3;
    }
}


// ============================================
// QUICK CAPTURE
// ============================================

function quickCaptureAs(type) {
    const text = document.getElementById('quickCaptureText').value.trim();
    if (!text) {
        showToast('Scrivi qualcosa prima', 'error');
        return;
    }

    if (type === 'task') {
        const task = {
            id: 't_' + Date.now(),
            title: text,
            completed: false,
            priority: 'medium',
            project: 'Quick Capture',
            createdAt: new Date().toISOString()
        };
        state.tasks.push(task);
        showToast('✅ Task creato!', 'success');
    } else if (type === 'note' || type === 'idea') {
        const note = {
            id: 'n_' + Date.now(),
            title: type === 'idea' ? '💡 ' + text.substring(0, 30) : text.substring(0, 30),
            content: text,
            tags: [type],
            createdAt: new Date().toISOString()
        };
        state.notes.push(note);
        showToast(type === 'idea' ? '💡 Idea salvata!' : '📝 Nota salvata!', 'success');
    }

    saveStateAndSync();
    document.getElementById('quickCaptureText').value = '';
    closeModal('quickCaptureModal');
    addXP(2);
}

function saveQuickCapture() {
    quickCaptureAs('note');
}


// ============================================
// ENERGY TRACKER
// ============================================

function setEnergy(level) {
    state.today.energy = level;
    saveStateAndSync();

    const labels = ['', 'Molto basso 😴', 'Basso 😔', 'Medio 😐', 'Alto 😊', 'Molto alto 🔥'];
    showToast('Energia: ' + labels[level], 'success');
    closeModal('energyModal');

    // Update energy levels visual
    document.querySelectorAll('.energy-level').forEach((el, i) => {
        el.classList.toggle('active', i < level);
    });
}


// ============================================
// BREAK REMINDERS
// ============================================

let breakInterval = null;
let breakTime = 0;

function showBreakReminder(type = 'stretch') {
    const messages = {
        stretch: { icon: '🧘', title: 'Tempo di Stretching!', msg: 'Alzati e fai qualche movimento.' },
        eyes: { icon: '👀', title: 'Riposa gli Occhi!', msg: 'Guarda lontano per 20 secondi.' },
        water: { icon: '💧', title: 'Bevi Acqua!', msg: 'L\'idratazione migliora la concentrazione.' },
        walk: { icon: '🚶', title: 'Fai una Passeggiata!', msg: 'Una breve camminata rigenera la mente.' }
    };

    const m = messages[type] || messages.stretch;
    document.getElementById('breakIcon').textContent = m.icon;
    document.getElementById('breakTitle').textContent = m.title;
    document.getElementById('breakMessage').textContent = m.msg;

    breakTime = 300; // 5 minutes
    updateBreakTimer();

    document.getElementById('breakOverlay').classList.add('active');

    breakInterval = setInterval(() => {
        breakTime--;
        updateBreakTimer();
        if (breakTime <= 0) {
            skipBreak();
        }
    }, 1000);
}

function updateBreakTimer() {
    const mins = Math.floor(breakTime / 60);
    const secs = breakTime % 60;
    document.getElementById('breakTimer').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;
}

function skipBreak() {
    clearInterval(breakInterval);
    document.getElementById('breakOverlay').classList.remove('active');
}

// Schedule break reminders during focus
function scheduleBreakReminder() {
    // After 25 minutes of focus, show reminder
    setTimeout(() => {
        if (focusRunning) {
            const types = ['stretch', 'eyes', 'water', 'walk'];
            showBreakReminder(types[Math.floor(Math.random() * types.length)]);
        }
    }, 25 * 60 * 1000);
}


// ============================================
// NOTIFICATIONS SYSTEM
// ============================================

// requestNotificationPermission già definita sopra (linea ~11989)

function sendNotification(title, body, tag = 'savers') {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: '🎯',
            tag: tag,
            requireInteraction: false
        });
    }
}

function scheduleNotifications() {
    // Morning notification at 6 AM
    const now = new Date();
    const morning = new Date(now);
    morning.setHours(6, 0, 0, 0);
    if (morning < now) morning.setDate(morning.getDate() + 1);

    const morningDelay = morning - now;
    setTimeout(() => {
        sendNotification('🌅 Buongiorno!', 'È ora di iniziare la routine S.A.V.E.R.S.');
        // Reschedule for next day
        scheduleNotifications();
    }, morningDelay);
}

// ============================================
// DAILY DIGEST & STREAK PROTECTION
// ============================================

function scheduleDailyDigest() {
    const now = new Date();
    const target = new Date();
    target.setHours(7, 0, 0, 0); // Digest alle 7:00

    if (now > target) {
        target.setDate(target.getDate() + 1);
    }

    const delay = target - now;
    setTimeout(() => {
        showDailyDigest();
        scheduleDailyDigest(); // Reschedule
    }, delay);
}

function showDailyDigest() {
    if (!state.settings?.notifications) return;

    const todayTasks = state.tasks.filter(t => !t.completed && t.due === state.today.date);
    const overdueTasks = state.tasks.filter(t => !t.completed && t.due && t.due < state.today.date);
    const habits = state.habits?.filter(h => !(h.completedDates || []).includes(state.today.date)) || [];
    const routineComplete = state.today.routineCompleted?.filter(Boolean).length || 0;

    let message = `🌅 Buongiorno! `;

    if (todayTasks.length > 0) {
        message += `${todayTasks.length} task per oggi. `;
    }
    if (overdueTasks.length > 0) {
        message += `⚠️ ${overdueTasks.length} in ritardo. `;
    }
    if (habits.length > 0) {
        message += `${habits.length} abitudini da completare. `;
    }
    if (state.stats?.streak > 0) {
        message += `🔥 Streak: ${state.stats.streak} giorni!`;
    }

    sendNotification('SAVERS Morning Digest', message);
    showToast(message, 'info');
}

function checkStreakProtection() {
    const hour = new Date().getHours();

    // Alert alle 20:00 se routine non completata
    if (hour === 20 && state.settings?.notifications) {
        const completedCount = state.today.routineCompleted?.filter(Boolean).length || 0;
        if (completedCount < 6 && state.stats?.streak > 0) {
            const message = `⚠️ Completa S.A.V.E.R.S. per mantenere la streak di ${state.stats.streak} giorni!`;
            sendNotification('Streak a Rischio!', message);
            showToast(message, 'warning');
        }
    }

    // Alert alle 22:00 per task non completati
    if (hour === 22) {
        const todayTasks = state.tasks.filter(t => !t.completed && t.due === state.today.date);
        if (todayTasks.length > 0) {
            showToast(`📋 Hai ancora ${todayTasks.length} task per oggi!`, 'warning');
        }
    }
}


// ============================================
// SMART SUGGESTIONS
// ============================================

function getSmartSuggestions() {
    const suggestions = [];
    const hour = new Date().getHours();
    const pendingTasks = state.tasks.filter(t => !t.completed);

    // Time-based suggestions
    if (hour >= 6 && hour < 9) {
        suggestions.push({
            text: '🌅 Inizia con S.A.V.E.R.S.',
            action: () => switchPage('routine')
        });
    }

    if (hour >= 9 && hour < 12 && pendingTasks.length > 0) {
        suggestions.push({
            text: `🎯 Hai ${pendingTasks.length} task. Focus time?`,
            action: () => switchPage('focus')
        });
    }

    if (hour >= 20) {
        suggestions.push({
            text: '🌙 Evening review?',
            action: () => openDailyFlow()
        });
    }

    return suggestions;
}


// ============================================
// TASK RECURRENCE
// ============================================

function createRecurringTask(task) {
    if (!task.recurrence) return;

    const nextDate = new Date(task.dueDate || new Date());

    switch(task.recurrence) {
        case 'daily':
            nextDate.setDate(nextDate.getDate() + 1);
            break;
        case 'weekdays':
            do {
                nextDate.setDate(nextDate.getDate() + 1);
            } while (nextDate.getDay() === 0 || nextDate.getDay() === 6);
            break;
        case 'weekly':
            nextDate.setDate(nextDate.getDate() + 7);
            break;
        case 'monthly':
            nextDate.setMonth(nextDate.getMonth() + 1);
            break;
    }

    const newTask = {
        ...task,
        id: 't_' + Date.now(),
        completed: false,
        completedDate: null,
        dueDate: nextDate.toISOString().split('T')[0],
        createdAt: new Date().toISOString()
    };

    state.tasks.push(newTask);
    saveStateAndSync();
}


// ============================================
// AUTO PRIORITY
// ============================================

function updateTaskPriorities() {
    if (!state.tasks || state.tasks.length === 0) return;

    const today = new Date();
    let hasChanges = false;

    state.tasks.forEach(task => {
        if (task.completed || !task.dueDate) return;

        const dueDate = new Date(task.dueDate);
        const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        const oldPriority = task.priority;
        const wasOverdue = task.overdue;

        // Auto-escalate priority based on due date
        if (daysUntilDue <= 0) {
            task.priority = 'high';
            task.overdue = true;
        } else if (daysUntilDue <= 1) {
            task.priority = 'high';
        } else if (daysUntilDue <= 3 && task.priority === 'low') {
            task.priority = 'medium';
        }

        // Traccia se ci sono state modifiche
        if (task.priority !== oldPriority || task.overdue !== wasOverdue) {
            hasChanges = true;
        }
    });

    // Salva solo se ci sono state modifiche e se siamo loggati
    if (hasChanges && isLoggedIn && initialLoadComplete) {
        saveStateAndSync('tasks');
    }
}


// ============================================
// KEYBOARD SHORTCUTS
// ============================================

document.addEventListener('keydown', (e) => {
    // Don't trigger if typing in input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

    // Q = Quick Capture
    if (e.key === 'q' || e.key === 'Q') {
        openModal('quickCaptureModal');
    }

    // F = Focus mode
    if (e.key === 'f' || e.key === 'F') {
        switchPage('focus');
    }

    // H = Home
    if (e.key === 'h' || e.key === 'H') {
        switchPage('home');
    }

    // T = Tasks
    if (e.key === 't' || e.key === 'T') {
        switchPage('tasks');
    }

    // Escape = Close modals
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => {
            m.classList.remove('active');
        });
    }
});


// ============================================
// INIT EXTENSIONS
// ============================================

// Extend switchPage for new pages
const originalSwitchPage = switchPage;
switchPage = function(pageName) {
    originalSwitchPage(pageName);

    // Additional page initializations
    switch(pageName) {
        case 'books':
            initBooksPage();
            break;
        case 'challenges':
            initChallengesPage();
            break;
        case 'analytics':
            setTimeout(renderAdvancedAnalytics, 200);
            break;
    }
};

// NOTA: updateTaskPriorities() e altre init sono spostate in initializeApp()
// per evitare che vengano eseguite prima di loadState()


// ============================================
// GUIDED MODE & ONBOARDING SYSTEM
// ============================================

let guidedStep = 0;
let spotlightStep = 0;

// Guided Tour Steps
const guidedTourSteps = [
    {
        icon: '🚀',
        title: 'Benvenuto in Mago Max!',
        text: 'La tua app all-in-one per produttività, finanza personale e crescita. Ti guiderò attraverso le funzionalità principali.',
        action: 'next'
    },
    {
        icon: '🌅',
        title: 'Il Metodo S.A.V.E.R.S.',
        text: 'Silence, Affirmations, Visualization, Exercise, Reading, Scribing. Una routine mattutina potente per iniziare ogni giornata al meglio.',
        action: 'next'
    },
    {
        icon: '✅',
        title: 'Gestione Task Intelligente',
        text: 'Crea task con priorità, scadenze e ricorrenza. L\'app auto-prioritizza i task in base alle scadenze!',
        action: 'next'
    },
    {
        icon: '🍅',
        title: 'Focus Mode & Pomodoro',
        text: 'Usa la tecnica Pomodoro per concentrarti. 25 minuti di lavoro, 5 di pausa. Traccia i tuoi pomodori giornalieri.',
        action: 'next'
    },
    {
        icon: '💰',
        title: 'Finanza Personale',
        text: 'Traccia entrate e uscite, imposta budget e monitora i tuoi risparmi. Tutto in un\'unica app!',
        action: 'next'
    },
    {
        icon: '📊',
        title: 'Analytics & Insights',
        text: 'Visualizza i tuoi progressi con grafici, heatmap e correlazioni. Scopri i tuoi pattern di produttività.',
        action: 'next'
    },
    {
        icon: '🏆',
        title: 'Gamification',
        text: 'Completa sfide, sblocca achievements e guadagna XP. Leggi libri e traccia le tue pagine per bonus XP!',
        action: 'next'
    },
    {
        icon: '⚡',
        title: 'Quick Capture',
        text: 'Premi il bottone ⚡ o il tasto Q per catturare rapidamente task, note o idee. Keyboard shortcuts: F=Focus, H=Home, T=Tasks.',
        action: 'next'
    },
    {
        icon: '🎉',
        title: 'Sei Pronto!',
        text: 'Inizia creando il tuo primo task o facendo la routine mattutina. Buona produttività!',
        action: 'finish'
    }
];

// Onboarding Checklist Items
const onboardingItems = [
    { id: 'profile', text: 'Personalizza il tuo profilo', icon: '👤', action: () => switchPage('settings') },
    { id: 'task', text: 'Crea il tuo primo task', icon: '✅', action: () => openModal('addTaskModal') },
    { id: 'routine', text: 'Completa la routine mattutina', icon: '🌅', action: () => switchPage('routine') },
    { id: 'pomodoro', text: 'Fai un pomodoro di 25 min', icon: '🍅', action: () => switchPage('focus') },
    { id: 'habit', text: 'Aggiungi un\'abitudine', icon: '✨', action: () => switchPage('habits') }
];

// Contextual Tips Database
const contextualTips = {
    home: [
        { title: 'Morning Flow', text: 'Inizia ogni giornata con il Morning Flow per massimizzare la tua energia!', icon: '🌅' },
        { title: 'Focus Score', text: 'Il Focus Score riflette la tua produttività. Più task completi e pomodori fai, più sale!', icon: '📈' }
    ],
    tasks: [
        { title: 'Priorità MIT', text: 'Identifica i tuoi 3 Most Important Tasks (MIT) ogni giorno per massimizzare l\'impatto.', icon: '🎯' },
        { title: 'Time Blocking', text: 'Assegna orari specifici ai task per creare blocchi di lavoro focalizzato.', icon: '⏰' }
    ],
    focus: [
        { title: 'Ambiente Sonoro', text: 'Attiva i suoni ambient dal menu per migliorare la concentrazione.', icon: '🎵' },
        { title: 'Pausa Attiva', text: 'Durante le pause, fai stretching o cammina. Non usare il telefono!', icon: '🧘' }
    ],
    finance: [
        { title: 'Regola 50/30/20', text: '50% necessità, 30% desideri, 20% risparmi. Un metodo semplice per gestire le finanze.', icon: '💡' },
        { title: 'Traccia Tutto', text: 'Registra anche le piccole spese. I "piccoli" importi fanno la differenza!', icon: '📝' }
    ],
    habits: [
        { title: 'Habit Stacking', text: 'Collega una nuova abitudine a una esistente: "Dopo [ABITUDINE], farò [NUOVA ABITUDINE]".', icon: '🔗' },
        { title: 'Non Spezzare la Catena', text: 'Mantieni lo streak! Ogni giorno consecutivo rafforza l\'abitudine.', icon: '🔥' }
    ],
    routine: [
        { title: 'Inizia Piccolo', text: 'Anche solo 1 minuto per elemento S.A.V.E.R.S. è meglio di niente!', icon: '🌱' },
        { title: 'Preparati la Sera Prima', text: 'Prepara vestiti e spazio la sera per una routine mattutina fluida.', icon: '🌙' }
    ]
};

// Spotlight Tutorial Elements
const spotlightElements = [
    { selector: '.header-btn[onclick*="quickAddModal"]', title: 'Aggiungi Rapido', text: 'Clicca qui per aggiungere velocemente task, spese o note.', position: 'bottom' },
    { selector: '.quick-capture-fab', title: 'Quick Capture', text: 'Cattura rapidamente idee, task o note al volo!', position: 'top' },
    { selector: '.bottom-nav', title: 'Navigazione', text: 'Naviga tra Home, Task, Habits, Focus e altro.', position: 'top' },
    { selector: '.stat-card', title: 'Dashboard Stats', text: 'Clicca su ogni stat per andare alla sezione corrispondente.', position: 'bottom' }
];

// Initialize Guided Mode
function initGuidedMode() {
    // Check if user is new (no completed tasks, no transactions, etc.)
    const isNewUser = !state.onboardingCompleted &&
                      state.tasks.length === 0 &&
                      state.transactions.length === 0;

    if (isNewUser && !localStorage.getItem('guidedTourSkipped')) {
        setTimeout(() => {
            showGuidedTour();
        }, 1000);
    }

    // Show onboarding checklist for incomplete onboarding
    if (!state.onboardingCompleted) {
        renderOnboardingChecklist();
    }

    // Show contextual tips based on current page
    showContextualTip();
}

// Show Guided Tour
function showGuidedTour() {
    guidedStep = 0;
    renderGuidedStep();
    document.getElementById('guidedOverlay').classList.add('active');
}

function renderGuidedStep() {
    const step = guidedTourSteps[guidedStep];
    document.getElementById('guidedIcon').textContent = step.icon;
    document.getElementById('guidedTitle').textContent = step.title;
    document.getElementById('guidedText').textContent = step.text;

    // Render progress dots
    const progressHTML = guidedTourSteps.map((_, i) => {
        let className = 'guided-dot';
        if (i < guidedStep) className += ' completed';
        if (i === guidedStep) className += ' active';
        return `<div class="${className}"></div>`;
    }).join('');
    document.getElementById('guidedProgress').innerHTML = progressHTML;

    // Update actions
    const actionsHTML = step.action === 'finish'
        ? `<button class="btn btn-primary btn-lg" onclick="finishGuidedTour()">🎉 Inizia!</button>`
        : `<button class="guided-skip" onclick="skipGuidedTour()">Salta Tour</button>
           <button class="btn btn-primary" onclick="nextGuidedStep()">Avanti →</button>`;
    document.getElementById('guidedActions').innerHTML = actionsHTML;
}

function nextGuidedStep() {
    if (guidedStep < guidedTourSteps.length - 1) {
        guidedStep++;
        renderGuidedStep();
    }
}

function skipGuidedTour() {
    document.getElementById('guidedOverlay').classList.remove('active');
    localStorage.setItem('guidedTourSkipped', 'true');
    showToast('Puoi riavviare il tour dalle Impostazioni', 'info');
}

function finishGuidedTour() {
    document.getElementById('guidedOverlay').classList.remove('active');
    showToast('🎉 Benvenuto! Inizia il tuo viaggio produttivo!', 'success');

    // Start spotlight tutorial after a delay
    setTimeout(() => {
        startSpotlightTutorial();
    }, 500);
}

// Restart guided tour (from settings)
function restartGuidedTour() {
    localStorage.removeItem('guidedTourSkipped');
    state.onboardingCompleted = false;
    saveStateAndSync();
    showGuidedTour();
}

// Spotlight Tutorial
function startSpotlightTutorial() {
    spotlightStep = 0;
    showSpotlight();
}

function showSpotlight() {
    const spotlight = spotlightElements[spotlightStep];
    const element = document.querySelector(spotlight.selector);

    if (!element) {
        nextSpotlight();
        return;
    }

    const rect = element.getBoundingClientRect();
    const highlight = document.getElementById('spotlightHighlight');
    const tooltip = document.getElementById('spotlightTooltip');

    // Position highlight
    highlight.style.left = (rect.left - 8) + 'px';
    highlight.style.top = (rect.top - 8) + 'px';
    highlight.style.width = (rect.width + 16) + 'px';
    highlight.style.height = (rect.height + 16) + 'px';

    // Position tooltip (centrato orizzontalmente via CSS, solo top viene impostato)
    document.getElementById('spotlightTitle').textContent = spotlight.title;
    document.getElementById('spotlightText').textContent = spotlight.text;

    tooltip.className = 'spotlight-tooltip ' + spotlight.position;

    // Non impostiamo left - il CSS centra automaticamente il tooltip
    // Impostiamo solo la posizione verticale
    if (spotlight.position === 'bottom') {
        tooltip.style.top = Math.min(rect.bottom + 20, window.innerHeight - 150) + 'px';
    } else {
        tooltip.style.top = Math.max(rect.top - 130, 20) + 'px';
    }

    document.getElementById('spotlightOverlay').classList.add('active');
}

function nextSpotlight() {
    if (spotlightStep < spotlightElements.length - 1) {
        spotlightStep++;
        showSpotlight();
    } else {
        closeSpotlight();
    }
}

function prevSpotlight() {
    if (spotlightStep > 0) {
        spotlightStep--;
        showSpotlight();
    }
}

function closeSpotlight() {
    document.getElementById('spotlightOverlay').classList.remove('active');
}

// Onboarding Checklist
function renderOnboardingChecklist() {
    const completedItems = state.onboardingProgress || [];
    const incompletedItems = onboardingItems.filter(item => !completedItems.includes(item.id));

    if (incompletedItems.length === 0) {
        state.onboardingCompleted = true;
        saveStateAndSync();
        document.getElementById('onboardingChecklist').style.display = 'none';
        return;
    }

    const completed = completedItems.length;
    const total = onboardingItems.length;
    const progress = (completed / total) * 100;

    document.getElementById('onboardingProgressText').textContent = `${completed}/${total} completati`;
    document.getElementById('onboardingProgressFill').style.width = progress + '%';

    const itemsHTML = onboardingItems.map(item => {
        const isCompleted = completedItems.includes(item.id);
        return `
            <div class="onboarding-item ${isCompleted ? 'completed' : ''}" onclick="handleOnboardingItem('${item.id}')">
                <div class="onboarding-check">${isCompleted ? '✓' : ''}</div>
                <div class="onboarding-item-text">${item.text}</div>
                <div class="onboarding-item-action">${item.icon}</div>
            </div>
        `;
    }).join('');

    document.getElementById('onboardingItems').innerHTML = itemsHTML;
    document.getElementById('onboardingChecklist').style.display = 'block';
}

function handleOnboardingItem(itemId) {
    const item = onboardingItems.find(i => i.id === itemId);
    if (item && item.action) {
        item.action();
    }
}

function completeOnboardingItem(itemId, silent = false) {
    if (!state.onboardingProgress) state.onboardingProgress = [];
    if (!state.onboardingProgress.includes(itemId)) {
        state.onboardingProgress.push(itemId);
        saveStateAndSync();
        renderOnboardingChecklist();
        if (!silent) {
            const item = onboardingItems.find(i => i.id === itemId);
            showToast(`✨ ${item?.text || 'Obiettivo'} completato!`, 'success');
        }
    }
}

function dismissOnboarding() {
    document.getElementById('onboardingChecklist').style.display = 'none';
    state.onboardingCompleted = true;
    saveStateAndSync();
}

// Contextual Tips
function showContextualTip() {
    const currentPage = document.querySelector('.page.active')?.id?.replace('Page', '') || 'home';
    const tips = contextualTips[currentPage];

    if (!tips || tips.length === 0) return;

    // Check if tip was dismissed recently
    const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips') || '{}');
    const lastDismissed = dismissedTips[currentPage];
    const now = Date.now();

    // Show tip if never dismissed or dismissed more than 24 hours ago
    if (lastDismissed && (now - lastDismissed) < 24 * 60 * 60 * 1000) {
        return;
    }

    // Random tip for variety
    const tip = tips[Math.floor(Math.random() * tips.length)];

    document.getElementById('contextualTipIcon').textContent = tip.icon;
    document.getElementById('contextualTipTitle').textContent = tip.title;
    document.getElementById('contextualTipText').textContent = tip.text;
    document.getElementById('contextualTip').style.display = 'flex';
}

function dismissContextualTip() {
    document.getElementById('contextualTip').style.display = 'none';

    const currentPage = document.querySelector('.page.active')?.id?.replace('Page', '') || 'home';
    const dismissedTips = JSON.parse(localStorage.getItem('dismissedTips') || '{}');
    dismissedTips[currentPage] = Date.now();
    localStorage.setItem('dismissedTips', JSON.stringify(dismissedTips));
}

// Auto-complete onboarding items based on user actions
function checkOnboardingProgress(showNotification = false) {
    if (state.onboardingCompleted) return;

    // Check if profile was customized (has name or profession set)
    if (state.user?.name || state.user?.profession || state.user?.nickname) {
        completeOnboardingItem('profile', !showNotification);
    }

    // Check if first task was created
    if (state.tasks && state.tasks.length > 0) {
        completeOnboardingItem('task', !showNotification);
    }

    // Check if routine was completed (SAVERS usa routineCompleted array)
    const routineCompleted = state.today?.routineCompleted || [];
    if (routineCompleted.some(v => v === true)) {
        completeOnboardingItem('routine', !showNotification);
    }

    // Check if pomodoro was done
    if ((state.today?.pomodoros || 0) > 0 || (state.stats?.pomodorosTotal || 0) > 0) {
        completeOnboardingItem('pomodoro', !showNotification);
    }

    // Check if habit was added
    if (state.habits && state.habits.length > 0) {
        completeOnboardingItem('habit', !showNotification);
    }

    // Check completamento totale
    const completedCount = (state.onboardingProgress || []).length;
    if (completedCount >= onboardingItems.length && !state.onboardingCompleted) {
        state.onboardingCompleted = true;
        const checklist = document.getElementById('onboardingChecklist');
        if (checklist) checklist.style.display = 'none';
        showToast('🎉 Tutti gli obiettivi completati! Benvenuto!', 'success');
        saveStateAndSync();
    }
}

// Hook into existing functions to track onboarding progress
const originalSaveTask = typeof saveTask !== 'undefined' ? saveTask : null;
if (originalSaveTask) {
    saveTask = function() {
        originalSaveTask.apply(this, arguments);
        setTimeout(checkOnboardingProgress, 100);
    };
}

// Initialize guided mode on load
setTimeout(initGuidedMode, 1500);

// Re-check onboarding on page switch
const originalExtendedSwitchPage = switchPage;
switchPage = function(pageName) {
    originalExtendedSwitchPage(pageName);

    // Hide contextual tip when switching pages
    document.getElementById('contextualTip').style.display = 'none';

    // Show new contextual tip for the new page
    setTimeout(showContextualTip, 500);

    // Handle new pages: skills and team
    switch(pageName) {
        case 'skills':
            renderSkillsPage();
            break;
        case 'team':
            renderTeamPage();
            break;
    }

    // Update nav - new navigation: home, tasks, skills, team, more
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItems = document.querySelectorAll('.nav-item');
    const mainNavPages = ['home', 'tasks', 'skills', 'team'];
    const pageIndex = mainNavPages.indexOf(pageName);
    if (pageIndex >= 0 && navItems[pageIndex]) {
        navItems[pageIndex].classList.add('active');
    }
};

// ============================================
// SKILLS SYSTEM - Per Animatori
// ============================================

const SKILL_CATEGORIES = {
    performance: {
        name: 'Performance',
        icon: '🎭',
        color: '#ef4444',
        examples: ['Magia', 'Giocoleria', 'Clown', 'Mimo', 'Ventriloquismo', 'Balloon Art Show']
    },
    technique: {
        name: 'Tecniche',
        icon: '🎨',
        color: '#3b82f6',
        examples: ['Palloncini Scultura', 'Face Painting', 'Trucchi Carte', 'Manipolazione Oggetti']
    },
    business: {
        name: 'Business',
        icon: '💼',
        color: '#10b981',
        examples: ['Marketing', 'Social Media', 'Vendita', 'Networking', 'Public Speaking', 'Gestione Eventi']
    }
};

const XP_PER_LEVEL = [0, 100, 300, 600, 1000, 1500]; // XP necessari per livello

function renderSkillsPage() {
    const container = document.getElementById('skillsGrid');
    if (!container) return;

    const skills = state.skills || [];
    const categoryFilter = document.querySelector('.skill-filter-btn.active')?.dataset.category || 'all';

    const filteredSkills = categoryFilter === 'all'
        ? skills
        : skills.filter(s => s.category === categoryFilter);

    if (filteredSkills.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">🎭</div>
                <div class="empty-title">Nessuna skill</div>
                <div class="empty-text">Aggiungi le tue prime skill da imparare!</div>
            </div>
        `;
        return;
    }

    container.innerHTML = filteredSkills.map(skill => {
        const level = getSkillLevel(skill.xp);
        const progress = getSkillProgress(skill.xp);
        const category = SKILL_CATEGORIES[skill.category] || SKILL_CATEGORIES.performance;

        return `
            <div class="skill-card" data-category="${skill.category}" onclick="openSkillDetail('${skill.id}')">
                <div class="skill-icon">${skill.icon || category.icon}</div>
                <div class="skill-info">
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-level">${'⭐'.repeat(level)}${'☆'.repeat(5-level)} Livello ${level}</div>
                    <div class="skill-progress">
                        <div class="progress-bar" style="width: ${progress}%; background: ${category.color}"></div>
                    </div>
                    <div class="skill-xp">${skill.xp || 0}/${XP_PER_LEVEL[Math.min(level, 4)] || 1500} XP</div>
                </div>
                <button class="btn-practice" onclick="event.stopPropagation(); openPracticeModal('${skill.id}')">🎯</button>
            </div>
        `;
    }).join('');

    // Update stats
    updateSkillStats();
}

function getSkillLevel(xp) {
    xp = xp || 0;
    for (let i = XP_PER_LEVEL.length - 1; i >= 0; i--) {
        if (xp >= XP_PER_LEVEL[i]) return i + 1;
    }
    return 1;
}

function getSkillProgress(xp) {
    xp = xp || 0;
    const level = getSkillLevel(xp);
    const currentLevelXP = XP_PER_LEVEL[level - 1] || 0;
    const nextLevelXP = XP_PER_LEVEL[level] || XP_PER_LEVEL[XP_PER_LEVEL.length - 1];
    return Math.round(((xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100);
}

function updateSkillStats() {
    const skills = state.skills || [];
    const totalLevel = skills.reduce((sum, s) => sum + getSkillLevel(s.xp), 0);
    document.getElementById('totalSkillsLevel').textContent = totalLevel || 0;

    // Stats per categoria
    Object.keys(SKILL_CATEGORIES).forEach(cat => {
        const catSkills = skills.filter(s => s.category === cat);
        const el = document.getElementById(`skillsCount${cat.charAt(0).toUpperCase() + cat.slice(1)}`);
        if (el) el.textContent = catSkills.length;
    });
}

function filterSkills(category, btn) {
    document.querySelectorAll('.skill-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderSkillsPage();
}

function saveSkill() {
    const name = document.getElementById('skillName').value.trim();
    if (!name) {
        showToast('Inserisci un nome', 'error');
        return;
    }

    const skill = {
        id: 'skill_' + Date.now(),
        name,
        category: document.getElementById('skillCategory').value,
        icon: document.getElementById('skillIcon').value || SKILL_CATEGORIES[document.getElementById('skillCategory').value].icon,
        level: 1,
        xp: 0,
        department: 'work',
        lastPracticed: null,
        resources: [],
        notes: document.getElementById('skillNotes')?.value || '',
        createdAt: new Date().toISOString()
    };

    state.skills = state.skills || [];
    state.skills.push(skill);
    saveStateAndSync();

    // Log skill creata per KPI
    logAttivita('skill_creata', 'skills', skill.id, {
        nome: name,
        categoria: skill.category
    });

    document.getElementById('skillName').value = '';
    document.getElementById('skillNotes').value = '';

    closeModal('addSkillModal');
    renderSkillsPage();
    addXP(10);
    showToast('Skill aggiunta! +10 XP', 'success');
}

function openPracticeModal(skillId) {
    const skill = state.skills.find(s => s.id === skillId);
    if (!skill) return;

    document.getElementById('practiceSkillId').value = skillId;
    document.getElementById('practiceSkillName').textContent = skill.name;
    document.getElementById('practiceMinutes').value = 30;
    document.getElementById('practiceNotes').value = '';

    openModal('practiceSkillModal');
}

// Mostra dettagli skill con statistiche e log pratica
function openSkillDetail(skillId) {
    const skill = state.skills.find(s => s.id === skillId);
    if (!skill) return;

    const level = getSkillLevel(skill.xp);
    const xpForNext = getXpForNextLevel(level);
    const currentLevelXp = skill.xp - getTotalXpForLevel(level - 1);
    const progress = Math.round((currentLevelXp / xpForNext) * 100);

    const lastPracticed = skill.lastPracticed
        ? new Date(skill.lastPracticed).toLocaleDateString('it-IT')
        : 'Mai';

    const practiceLog = (skill.practiceLog || []).slice(-5).reverse();
    const logHtml = practiceLog.length > 0
        ? practiceLog.map(p => `
            <div style="padding:8px 0; border-bottom:1px solid var(--border);">
                <div style="font-size:0.85rem; color:var(--text-secondary);">${new Date(p.date).toLocaleDateString('it-IT')} - ${p.minutes} min</div>
                ${p.notes ? `<div style="font-size:0.9rem; margin-top:4px;">${p.notes}</div>` : ''}
            </div>
        `).join('')
        : '<div style="color:var(--text-muted); font-style:italic;">Nessuna pratica registrata</div>';

    const content = `
        <div style="padding:20px;">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:3rem;">${skill.icon || '🎯'}</div>
                <h3 style="margin:10px 0;">${skill.name}</h3>
                <div style="color:var(--text-secondary);">${SKILL_CATEGORIES[skill.category]?.name || skill.category}</div>
            </div>

            <div style="background:var(--bg-secondary); padding:16px; border-radius:12px; margin-bottom:16px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Livello ${level}</span>
                    <span>${skill.xp || 0} XP</span>
                </div>
                <div style="height:8px; background:var(--border); border-radius:4px; overflow:hidden;">
                    <div style="height:100%; width:${progress}%; background:var(--primary); border-radius:4px;"></div>
                </div>
                <div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">
                    ${currentLevelXp}/${xpForNext} XP per livello ${level + 1}
                </div>
            </div>

            <div style="margin-bottom:16px;">
                <div style="font-size:0.9rem; color:var(--text-secondary);">Ultima pratica: ${lastPracticed}</div>
            </div>

            <div style="margin-bottom:16px;">
                <h4 style="margin-bottom:12px;">📝 Ultime sessioni</h4>
                ${logHtml}
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="closeModal('customDetailModal'); openPracticeModal('${skill.id}')">🎯 Registra Pratica</button>
                <button class="btn btn-danger" onclick="closeModal('customDetailModal'); deleteSkill('${skill.id}')">🗑️ Elimina</button>
            </div>
        </div>
    `;

    showCustomModal('Dettaglio Skill', content);
}

// Calcola XP totali necessari per raggiungere un livello
function getTotalXpForLevel(level) {
    if (level <= 0) return 0;
    let total = 0;
    for (let i = 1; i <= level; i++) {
        total += getXpForNextLevel(i);
    }
    return total;
}

// Calcola XP necessari per il prossimo livello
function getXpForNextLevel(level) {
    return level * 100; // 100 XP per livello 1, 200 per livello 2, etc.
}

function savePractice() {
    const skillId = document.getElementById('practiceSkillId').value;
    const minutes = parseInt(document.getElementById('practiceMinutes').value) || 0;
    const notes = document.getElementById('practiceNotes').value;

    const skill = state.skills.find(s => s.id === skillId);
    if (!skill) return;

    // Calcola XP guadagnati (1 XP per minuto)
    const xpGained = minutes;
    const oldLevel = getSkillLevel(skill.xp);
    skill.xp = (skill.xp || 0) + xpGained;
    const newLevel = getSkillLevel(skill.xp);
    skill.lastPracticed = new Date().toISOString();

    if (notes) {
        skill.practiceLog = skill.practiceLog || [];
        skill.practiceLog.push({
            date: new Date().toISOString(),
            minutes,
            notes
        });
    }

    // Log pratica skill per KPI
    logAttivita('skill_praticata', 'skills', skillId, {
        nome: skill.name,
        minuti: minutes,
        xp_guadagnati: xpGained,
        livello_skill: newLevel
    });

    // Log level up skill
    if (newLevel > oldLevel) {
        logAttivita('skill_level_up', 'skills', skillId, {
            nome: skill.name,
            livello_precedente: oldLevel,
            nuovo_livello: newLevel
        });
        showToast(`🎯 ${skill.name} livello ${newLevel}!`, 'success');
    }

    saveStateAndSync();
    closeModal('practiceSkillModal');
    renderSkillsPage();
    addXP(Math.round(xpGained / 2));
    showToast(`Pratica registrata! +${xpGained} XP skill, +${Math.round(xpGained/2)} XP personali`, 'success');
}

function deleteSkill(skillId) {
    if (!confirm('Eliminare questa skill?')) return;
    state.skills = state.skills.filter(s => s.id !== skillId);
    saveStateAndSync();
    renderSkillsPage();
    showToast('Skill eliminata', 'info');
}

// ============================================
// TEAM MANAGEMENT SYSTEM
// ============================================

// Genera codice invito unico
function generateInviteCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

// Crea nuovo team (con backend Google Sheets)
async function createTeam() {
    const name = document.getElementById('newTeamName').value.trim();
    const description = document.getElementById('newTeamDescription').value.trim();
    const visibility = document.getElementById('newTeamVisibility')?.value || 'private';

    if (!name) {
        showToast('Inserisci il nome del team', 'error');
        return;
    }

    try {
        showToast('Creazione team in corso...', 'info');

        const response = await apiCall('createTeam', {
            name: name,
            description: description,
            visibility: visibility
        });

        if (response.success) {
            closeModal('createTeamModal');
            document.getElementById('newTeamName').value = '';
            document.getElementById('newTeamDescription').value = '';
            if (document.getElementById('newTeamInviteCode')) {
                document.getElementById('newTeamInviteCode').value = '';
            }

            showToast(`Team "${name}" creato! Codice invito: ${response.inviteCode}`, 'success');

            // Ricarica i team dal backend
            await loadUserTeams();
        } else {
            showToast(response.message || 'Errore nella creazione del team', 'error');
        }
    } catch (error) {
        console.error('Errore createTeam:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Carica i team dell'utente dal backend Google Sheets
async function loadUserTeams() {
    try {
        const response = await apiCall('getUserTeams', {});
        console.log('getUserTeams response:', response);

        if (response.success) {
            // Aggiorna lo stato locale con i team dal backend
            state.teams = response.teams.map(t => ({
                id: t.teamId,
                name: t.name,
                description: t.description,
                inviteCode: t.inviteCode,
                ownerUsername: t.ownerUsername,
                ownerEmail: t.ownerUsername,
                members: t.members,
                pendingRequests: t.pendingRequests || [],
                myRole: t.myRole,
                createdAt: t.createdAt,
                isPrivate: t.isPrivate !== false // default true
            }));

            console.log('state.teams aggiornato:', state.teams);

            // Aggiorna badge inbox con richieste pendenti team
            updateInboxBadge();

            renderMyTeams();
        } else {
            console.warn('getUserTeams failed:', response.message);
        }
    } catch (error) {
        console.error('Errore loadUserTeams:', error);
    }
}

// Apri gestione team - ora apre un modal vero
function openTeamManagement() {
    const myTeams = state.teams || [];

    // Se non ci sono team, mostra il modal per creare uno nuovo
    if (myTeams.length === 0) {
        openModal('createTeamModal');
        return;
    }

    // Popola il selettore team
    const select = document.getElementById('manageTeamSelect');
    if (select) {
        select.innerHTML = '<option value="">Scegli un team...</option>' +
            myTeams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    // Reset contenuto
    document.getElementById('teamManagementContent').style.display = 'none';
    document.getElementById('teamMemberSearchInput').value = '';
    document.getElementById('teamMemberSearchResults').style.display = 'none';

    // Se c'è un solo team, selezionalo automaticamente
    if (myTeams.length === 1) {
        select.value = myTeams[0].id;
        loadTeamForManagement(myTeams[0].id);
    }

    openModal('teamManagementModal');
}

// Carica un team per la gestione
function loadTeamForManagement(teamId) {
    if (!teamId) {
        document.getElementById('teamManagementContent').style.display = 'none';
        return;
    }

    currentManagingTeamId = teamId;
    const team = (state.teams || []).find(t => t.id === teamId);

    if (!team) {
        showToast('Team non trovato', 'error');
        return;
    }

    // Mostra contenuto
    document.getElementById('teamManagementContent').style.display = 'block';

    // Header info
    document.getElementById('manageTeamName').textContent = team.name;
    document.getElementById('manageTeamCode').textContent = `Codice: ${team.inviteCode || team.code || 'N/A'}`;

    const isOwner = team.myRole === 'owner';
    const roleEl = document.getElementById('manageTeamRole');
    roleEl.textContent = isOwner ? '👑 Owner' : '👤 Membro';
    roleEl.className = `permission-badge ${isOwner ? 'owner' : 'viewer'}`;

    // Mostra/nascondi sezioni owner
    document.getElementById('addMemberSection').style.display = isOwner ? 'block' : 'none';
    document.getElementById('teamDangerZone').style.display = isOwner ? 'block' : 'none';

    // Renderizza membri
    renderTeamMembersForManagement(team);

    // Carica richieste in attesa (solo owner)
    if (isOwner) {
        loadPendingJoinRequests(teamId);
    }
}

// Renderizza lista membri per gestione
function renderTeamMembersForManagement(team) {
    const container = document.getElementById('teamMembersList');
    const countEl = document.getElementById('manageMemberCount');
    const members = team.members || [];
    const isOwner = team.myRole === 'owner';
    const myEmail = state.cloudUser?.email?.toLowerCase();

    countEl.textContent = members.length;

    if (members.length === 0) {
        container.innerHTML = '<div class="no-collaborators">Nessun membro nel team</div>';
        return;
    }

    const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444'];

    container.innerHTML = members.map((m, i) => {
        const initial = (m.name || m.username || '?').charAt(0).toUpperCase();
        const displayName = m.name || m.username || m.email?.split('@')[0] || 'Membro';
        const memberRole = m.role || 'member';
        const isMe = (m.email || '').toLowerCase() === myEmail || (m.username || '').toLowerCase() === myEmail;
        const canRemove = isOwner && !isMe && memberRole !== 'owner';

        return `
            <div class="collaborator-item">
                <div class="collaborator-info">
                    <div class="collaborator-avatar" style="background:${colors[i % colors.length]}">
                        ${initial}
                    </div>
                    <div class="collaborator-details">
                        <div class="collaborator-email">${displayName} ${isMe ? '(Tu)' : ''}</div>
                        <div class="collaborator-role">${m.email || m.username}</div>
                    </div>
                </div>
                <div class="collaborator-actions">
                    <span class="permission-badge ${memberRole === 'owner' ? 'owner' : 'viewer'}">
                        ${memberRole === 'owner' ? '👑 Owner' : '👤 Membro'}
                    </span>
                    ${canRemove ? `<button class="btn btn-ghost btn-xs" onclick="removeTeamMemberFromManagement('${team.id}', '${m.username || m.email}')" title="Rimuovi">✕</button>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// Rimuovi membro dal team
async function removeTeamMemberFromManagement(teamId, memberUsername) {
    if (!confirm(`Sei sicuro di voler rimuovere questo membro dal team?`)) {
        return;
    }

    try {
        const result = await apiCall('removeTeamMember', {
            teamId: teamId,
            targetUsername: memberUsername  // Backend usa targetUsername
        });

        if (result.success) {
            showToast('Membro rimosso!', 'success');
            // Ricarica i team
            await loadUserTeams();
            loadTeamForManagement(teamId);
            renderTeamMembers();
        } else {
            showToast(result.message || 'Errore rimozione', 'error');
        }
    } catch (error) {
        console.error('Errore rimozione membro:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Carica richieste di join in attesa
async function loadPendingJoinRequests(teamId) {
    const section = document.getElementById('pendingRequestsSection');
    const container = document.getElementById('teamPendingRequests');

    try {
        const result = await apiCall('getTeamJoinRequests', { teamId: teamId });

        if (result.success && result.requests && result.requests.length > 0) {
            section.style.display = 'block';
            container.innerHTML = result.requests.map(req => `
                <div class="collaborator-item">
                    <div class="collaborator-info">
                        <div class="collaborator-avatar" style="background:#f59e0b">
                            ${(req.username || '?').charAt(0).toUpperCase()}
                        </div>
                        <div class="collaborator-details">
                            <div class="collaborator-email">${req.username}</div>
                            <div class="collaborator-role">${req.email || 'In attesa'}</div>
                        </div>
                    </div>
                    <div class="collaborator-actions" style="gap:8px;">
                        <button class="btn btn-sm" style="background:var(--success);color:white;" onclick="handleJoinRequestFromManagement('${teamId}', '${req.username}', 'approve')">✓</button>
                        <button class="btn btn-ghost btn-sm" style="color:var(--danger);" onclick="handleJoinRequestFromManagement('${teamId}', '${req.username}', 'reject')">✕</button>
                    </div>
                </div>
            `).join('');
        } else {
            section.style.display = 'none';
        }
    } catch (error) {
        section.style.display = 'none';
    }
}

// Gestisci richiesta join
async function handleJoinRequestFromManagement(teamId, username, action) {
    try {
        const result = await apiCall('handleJoinRequest', {
            teamId: teamId,
            username: username,
            action: action
        });

        if (result.success) {
            showToast(action === 'approve' ? 'Richiesta approvata!' : 'Richiesta rifiutata', 'success');
            await loadUserTeams();
            loadTeamForManagement(teamId);
            renderTeamMembers();
        } else {
            showToast(result.message || 'Errore', 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Debounce per ricerca membri team
function debounceTeamMemberSearch(query) {
    clearTimeout(teamMemberSearchTimeout);

    const resultsDiv = document.getElementById('teamMemberSearchResults');

    if (!query || query.trim().length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }

    teamMemberSearchTimeout = setTimeout(() => {
        searchUsersForTeam(query.trim());
    }, 300);
}

// Cerca utenti per aggiungerli al team
async function searchUsersForTeam(query) {
    const resultsDiv = document.getElementById('teamMemberSearchResults');

    if (!state.cloudUser?.token) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:var(--text-muted);">Devi essere connesso</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.innerHTML = '<div style="padding:10px; text-align:center;"><span class="spinner-small"></span> Ricerca...</div>';
    resultsDiv.style.display = 'block';

    try {
        const result = await apiCall('searchUsers', { query: query, searchType: 'all' });

        if (result.success && result.users) {
            renderTeamMemberSearchResults(result.users);
        } else {
            resultsDiv.innerHTML = `<div style="padding:10px; color:var(--text-muted);">Nessun utente trovato</div>`;
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:var(--danger);">Errore ricerca</div>';
    }
}

// Renderizza risultati ricerca per aggiunta al team
function renderTeamMemberSearchResults(users) {
    const resultsDiv = document.getElementById('teamMemberSearchResults');
    const team = (state.teams || []).find(t => t.id === currentManagingTeamId);
    const currentMembers = (team?.members || []).map(m => (m.email || m.username || '').toLowerCase());
    const myEmail = state.cloudUser?.email?.toLowerCase();

    // Filtra utenti già membri
    const availableUsers = users.filter(u => {
        const userEmail = (u.email || '').toLowerCase();
        const username = (u.username || '').toLowerCase();
        return userEmail !== myEmail && !currentMembers.includes(userEmail) && !currentMembers.includes(username);
    });

    if (availableUsers.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:var(--text-muted);">Nessun nuovo utente trovato</div>';
        return;
    }

    resultsDiv.innerHTML = availableUsers.map(user => {
        const initial = (user.name || user.username || '?').charAt(0).toUpperCase();
        return `
            <div class="user-search-result" onclick="inviteUserToTeam('${user.username}', '${user.email}', '${user.name || user.nickname || user.username}')">
                <div class="user-result-avatar">${initial}</div>
                <div class="user-result-info">
                    <div class="user-result-name">${user.name || user.nickname || user.username}</div>
                    <div class="user-result-email">${user.email}</div>
                </div>
            </div>
        `;
    }).join('');
}

// Invita utente al team
async function inviteUserToTeam(username, email, name) {
    if (!currentManagingTeamId) return;

    try {
        const result = await apiCall('inviteToTeam', {
            teamId: currentManagingTeamId,
            inviteeUsername: username,
            inviteeEmail: email
        });

        if (result.success) {
            showToast(`${name} invitato al team!`, 'success');
            document.getElementById('teamMemberSearchInput').value = '';
            document.getElementById('teamMemberSearchResults').style.display = 'none';

            // Ricarica team
            await loadUserTeams();
            loadTeamForManagement(currentManagingTeamId);
            renderTeamMembers();
        } else {
            showToast(result.message || 'Errore invito', 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Conferma eliminazione team
function confirmDeleteTeam() {
    if (!currentManagingTeamId) return;

    const team = (state.teams || []).find(t => t.id === currentManagingTeamId);
    if (!team) return;

    if (confirm(`Sei sicuro di voler eliminare il team "${team.name}"? Questa azione è irreversibile!`)) {
        deleteTeam(currentManagingTeamId);
    }
}

// Elimina team
async function deleteTeam(teamId) {
    try {
        const result = await apiCall('deleteTeam', { teamId: teamId });

        if (result.success) {
            showToast('Team eliminato', 'success');
            closeModal('teamManagementModal');
            await loadUserTeams();
            renderMyTeams();
            renderTeamMembers();
        } else {
            showToast(result.message || 'Errore eliminazione', 'error');
        }
    } catch (error) {
        showToast('Errore di connessione', 'error');
    }
}

// Mostra dettagli membro cliccato
function viewMemberDetails(encodedMember) {
    try {
        const member = JSON.parse(decodeURIComponent(encodedMember));
        const content = `
            <div style="text-align:center; padding:20px;">
                <div style="width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, #6366f1, #8b5cf6); display:flex; align-items:center; justify-content:center; color:white; font-size:1.5rem; font-weight:600; margin:0 auto 12px;">
                    ${(member.name || '?').charAt(0).toUpperCase()}
                </div>
                <div style="font-size:1.2rem; font-weight:600;">${member.name || member.username || 'Membro'}</div>
                <div style="color:var(--text-muted); font-size:0.9rem;">${member.email || ''}</div>
                ${member.teamName ? `<div style="margin-top:8px;"><span class="member-team-badge">${member.teamName}</span></div>` : ''}
                <div style="margin-top:8px;">
                    <span class="permission-badge ${member.role === 'owner' ? 'owner' : 'viewer'}">
                        ${member.role === 'owner' ? '👑 Owner' : '👤 Membro'}
                    </span>
                </div>
            </div>
        `;

        // Usa un alert semplice o crea un toast grande
        showToast(member.name || member.username || 'Membro', 'info');
    } catch (e) {
        console.error('Errore parsing membro:', e);
    }
}

// Renderizza i miei team (dal backend)
function renderMyTeams() {
    const container = document.getElementById('myTeamsList');
    if (!container) return;

    // I team vengono dal backend tramite loadUserTeams()
    const myTeams = state.teams || [];

    if (myTeams.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--text-muted);">
                <div style="font-size:2rem; margin-bottom:8px;">🏢</div>
                <p>Non fai parte di nessun team</p>
                <p style="font-size:0.85rem;">Crea un team o unisciti a uno esistente</p>
            </div>
        `;
        return;
    }

    container.innerHTML = myTeams.map(team => {
        const isOwner = team.myRole === 'owner';
        const memberCount = team.members?.length || 1;

        return `
            <div class="team-card" onclick="openTeamDetail('${team.id}')" style="
                display:flex;
                align-items:center;
                padding:12px;
                background:var(--bg-secondary);
                border-radius:12px;
                cursor:pointer;
                transition: transform 0.2s, box-shadow 0.2s;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';"
               onmouseout="this.style.transform='none'; this.style.boxShadow='none';">
                <div style="
                    width:48px;
                    height:48px;
                    border-radius:12px;
                    background:linear-gradient(135deg, var(--primary), var(--primary-dark));
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-size:1.5rem;
                    margin-right:12px;
                ">
                    🏢
                </div>
                <div style="flex:1; min-width:0;">
                    <div style="font-weight:600; display:flex; align-items:center; gap:6px;">
                        ${team.name}
                        ${isOwner ? '<span style="font-size:0.7rem; background:var(--primary); color:white; padding:2px 6px; border-radius:4px;">OWNER</span>' : ''}
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">
                        ${memberCount} membri · Codice: ${team.inviteCode}
                    </div>
                </div>
                <div style="color:var(--text-muted);">›</div>
            </div>
        `;
    }).join('');

    // Mostra richieste di iscrizione se sono owner di qualche team
    renderTeamJoinRequests();
}

// Renderizza richieste di iscrizione al team (dal backend)
function renderTeamJoinRequests() {
    const card = document.getElementById('teamJoinRequestsCard');
    const container = document.getElementById('teamJoinRequestsList');
    const countBadge = document.getElementById('pendingRequestsCount');
    if (!card || !container) return;

    // Raccogli tutte le richieste pendenti dai team dove sono owner
    const allPendingRequests = [];
    (state.teams || []).forEach(team => {
        if (team.myRole === 'owner' && team.pendingRequests && team.pendingRequests.length > 0) {
            team.pendingRequests.forEach(req => {
                allPendingRequests.push({
                    ...req,
                    teamId: team.id,
                    teamName: team.name
                });
            });
        }
    });

    if (allPendingRequests.length === 0) {
        card.style.display = 'none';
        return;
    }

    card.style.display = 'block';
    countBadge.textContent = allPendingRequests.length;

    container.innerHTML = allPendingRequests.map(req => `
        <div style="display:flex; align-items:center; padding:12px; border-bottom:1px solid var(--border-color);">
            <div style="
                width:40px;
                height:40px;
                border-radius:50%;
                background:var(--bg-tertiary);
                display:flex;
                align-items:center;
                justify-content:center;
                font-weight:bold;
                margin-right:12px;
            ">
                ${(req.username || req.email || '?').charAt(0).toUpperCase()}
            </div>
            <div style="flex:1; min-width:0;">
                <div style="font-weight:500;">${req.username || req.email}</div>
                <div style="font-size:0.8rem; color:var(--text-muted);">
                    Vuole unirsi a "${req.teamName}"
                </div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-sm" onclick="approveJoinRequest('${req.teamId}', '${req.username}')" style="background:#22c55e; color:white;">
                    ✓
                </button>
                <button class="btn btn-sm" onclick="rejectJoinRequest('${req.teamId}', '${req.username}')" style="background:#dc2626; color:white;">
                    ✕
                </button>
            </div>
        </div>
    `).join('');
}

// Approva richiesta di iscrizione (con backend Google Sheets)
async function approveJoinRequest(teamId, targetUsername) {
    try {
        const response = await apiCall('handleJoinRequest', {
            teamId: teamId,
            targetUsername: targetUsername,
            approve: true
        });

        if (response.success) {
            showToast('Membro approvato e aggiunto al team!', 'success');
            await loadUserTeams();
        } else {
            showToast(response.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore approveJoinRequest:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Rifiuta richiesta di iscrizione (con backend Google Sheets)
async function rejectJoinRequest(teamId, targetUsername) {
    try {
        const response = await apiCall('handleJoinRequest', {
            teamId: teamId,
            targetUsername: targetUsername,
            approve: false
        });

        if (response.success) {
            showToast('Richiesta rifiutata', 'info');
            await loadUserTeams();
        } else {
            showToast(response.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore rejectJoinRequest:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Gestisci richiesta team dalla inbox
async function handleTeamRequestFromInbox(teamId, username, approve) {
    try {
        const response = await apiCall('handleJoinRequest', {
            teamId: teamId,
            targetUsername: username,
            approve: approve
        });

        if (response.success) {
            showToast(approve ? 'Membro approvato! 🎉' : 'Richiesta rifiutata', approve ? 'success' : 'info');
            await loadUserTeams();
            renderInbox();
        } else {
            showToast(response.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore handleTeamRequestFromInbox:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Apri dettaglio team (usa myRole dal backend)
function openTeamDetail(teamId) {
    console.log('openTeamDetail chiamato con teamId:', teamId);
    console.log('state.teams:', state.teams);

    const team = (state.teams || []).find(t => t.id === teamId);
    if (!team) {
        console.error('Team non trovato:', teamId);
        showToast('Team non trovato', 'error');
        return;
    }

    console.log('Team trovato:', team);

    currentTeamId = teamId;
    const myRole = team.myRole;
    const isOwner = myRole === 'owner';
    const isAdmin = myRole === 'admin';
    const canManage = isOwner || isAdmin;

    // Helper per ottenere colore e label del ruolo
    const getRoleStyle = (role) => {
        switch(role) {
            case 'owner': return { bg: 'var(--primary)', color: 'white', label: '👑 Owner' };
            case 'admin': return { bg: '#f59e0b', color: 'white', label: '⭐ Admin' };
            default: return { bg: 'var(--bg-secondary)', color: 'var(--text-muted)', label: 'Membro' };
        }
    };

    document.getElementById('teamDetailTitle').textContent = `🏢 ${team.name}`;

    const content = document.getElementById('teamDetailContent');
    content.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
            <div style="font-size:3rem; margin-bottom:8px;">🏢</div>
            <h3 style="margin:0;">${team.name}</h3>
            ${team.description ? `<p style="color:var(--text-muted); margin-top:8px;">${team.description}</p>` : ''}
            <div style="margin-top:8px;">
                <span style="font-size:0.8rem; background:${getRoleStyle(myRole).bg}; color:${getRoleStyle(myRole).color}; padding:4px 12px; border-radius:12px;">
                    Il tuo ruolo: ${getRoleStyle(myRole).label}
                </span>
            </div>
        </div>

        <div class="card" style="margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <span class="text-muted">Codice Invito</span>
                <span style="font-weight:bold; font-family:monospace; letter-spacing:2px;">${team.inviteCode}</span>
            </div>
            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">
                Condividi il link di invito per far unire nuovi membri al team
            </p>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-secondary btn-sm" onclick="copyTeamInviteCode('${team.inviteCode}')" style="flex:1;">
                    📋 Codice
                </button>
                <button class="btn btn-primary btn-sm" onclick="copyTeamInviteLink('${team.id}', '${team.inviteCode}')" style="flex:1;">
                    🔗 Copia Link
                </button>
                <button class="btn btn-sm" onclick="shareTeamInviteLink('${team.name}', '${team.inviteCode}')" style="flex:1; background:#25D366; color:white;">
                    📤 Invia
                </button>
            </div>
        </div>

        <div class="card" style="margin-bottom:12px;">
            <div style="font-weight:600; margin-bottom:12px;">👥 Membri (${team.members?.length || 0})</div>
            ${(team.members || []).map(m => {
                const roleStyle = getRoleStyle(m.role);
                const canRemove = canManage && m.role !== 'owner' && !(isAdmin && m.role === 'admin');
                const canChangeRole = isOwner && m.role !== 'owner';

                return `
                <div style="display:flex; align-items:center; padding:8px 0; border-bottom:1px solid var(--border-color);">
                    <div style="
                        width:36px;
                        height:36px;
                        border-radius:50%;
                        background:${roleStyle.bg};
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        font-weight:bold;
                        color:${roleStyle.color};
                        margin-right:12px;
                    ">
                        ${(m.username || m.email || '?').charAt(0).toUpperCase()}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:500;">${m.username || m.email}</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">${m.email || ''}</div>
                    </div>
                    <span style="font-size:0.75rem; background:${roleStyle.bg}; color:${roleStyle.color}; padding:2px 8px; border-radius:4px;">
                        ${roleStyle.label}
                    </span>
                    ${canChangeRole ? `
                        <select class="form-select" style="margin-left:8px; padding:2px 4px; font-size:0.75rem; width:auto;"
                                onchange="changeTeamMemberRole('${team.id}', '${m.username}', this.value)">
                            <option value="member" ${m.role === 'member' ? 'selected' : ''}>Membro</option>
                            <option value="admin" ${m.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    ` : ''}
                    ${canRemove ? `
                        <button class="btn btn-ghost btn-sm" onclick="removeTeamMember('${team.id}', '${m.username}')" style="margin-left:8px; color:#dc2626;" title="Rimuovi">
                            ✕
                        </button>
                    ` : ''}
                </div>
            `}).join('')}
        </div>

        ${canManage && (team.pendingRequests || []).length > 0 ? `
            <div class="card" style="margin-bottom:12px; border:1px solid var(--primary);">
                <div style="font-weight:600; margin-bottom:12px;">
                    📬 Richieste di Iscrizione (${team.pendingRequests.length})
                </div>
                ${team.pendingRequests.map(req => `
                    <div style="display:flex; align-items:center; padding:8px; border-bottom:1px solid var(--border-color);">
                        <div style="
                            width:36px;
                            height:36px;
                            border-radius:50%;
                            background:var(--bg-tertiary);
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            font-weight:bold;
                            margin-right:12px;
                        ">
                            ${(req.username || req.email || '?').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:500;">${req.username || req.email}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">${req.email || ''}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-sm" onclick="approveJoinRequest('${team.id}', '${req.username}')" style="background:#22c55e; color:white;">
                                ✓ Accetta
                            </button>
                            <button class="btn btn-sm" onclick="rejectJoinRequest('${team.id}', '${req.username}')" style="background:#dc2626; color:white;">
                                ✕ Rifiuta
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        ` : ''}

        ${canManage ? `
            <div class="card" style="margin-bottom:12px;">
                <div style="font-weight:600; margin-bottom:12px;">⚙️ Impostazioni Team</div>
                <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border-color);">
                    <div>
                        <div style="font-weight:500;">Visibilità</div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">
                            ${team.isPrivate ? '🔒 Privato - Solo su invito' : '🌐 Pubblico - Chiunque può richiedere'}
                        </div>
                    </div>
                    <select class="form-select" style="width:auto; padding:4px 8px;"
                            onchange="updateTeamPrivacy('${team.id}', this.value === 'private')">
                        <option value="private" ${team.isPrivate ? 'selected' : ''}>🔒 Privato</option>
                        <option value="public" ${!team.isPrivate ? 'selected' : ''}>🌐 Pubblico</option>
                    </select>
                </div>
            </div>
        ` : ''}

        ${isOwner ? `
            <div class="card" style="margin-bottom:12px; border:1px solid #f59e0b;">
                <div style="font-weight:600; margin-bottom:8px;">⚡ Trasferisci Ownership</div>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:8px;">
                    Trasferisci la proprietà del team a un altro membro. Tu diventerai admin.
                </p>
                <select id="transferOwnershipSelect" class="form-select" style="margin-bottom:8px;">
                    <option value="">Seleziona nuovo proprietario...</option>
                    ${(team.members || []).filter(m => m.role !== 'owner').map(m => `
                        <option value="${m.username}">${m.username}</option>
                    `).join('')}
                </select>
                <button class="btn btn-sm" onclick="transferTeamOwnership('${team.id}')" style="background:#f59e0b; color:white; width:100%;">
                    🔄 Trasferisci Ownership
                </button>
            </div>
        ` : ''}
    `;

    const footer = document.getElementById('teamDetailFooter');
    if (isOwner) {
        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal('teamDetailModal')">Chiudi</button>
            <button class="btn" onclick="deleteTeam('${team.id}')" style="background:#dc2626; color:white;">🗑️ Elimina Team</button>
        `;
    } else {
        footer.innerHTML = `
            <button class="btn btn-secondary" onclick="closeModal('teamDetailModal')">Chiudi</button>
            <button class="btn" onclick="leaveTeam('${team.id}')" style="background:#f59e0b; color:white;">🚪 Esci dal Team</button>
        `;
    }

    openModal('teamDetailModal');
}

// Copia codice invito
function copyTeamInviteCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showToast(`Codice ${code} copiato!`, 'success');
    }).catch(() => {
        showToast(`Codice: ${code}`, 'info');
    });
}

// Genera e copia link di invito
function copyTeamInviteLink(teamId, code) {
    // Genera un link che include il codice invito come parametro URL
    const baseUrl = window.location.href.split('?')[0].split('#')[0];
    const inviteLink = `${baseUrl}?jointeam=${code}`;

    navigator.clipboard.writeText(inviteLink).then(() => {
        showToast('Link di invito copiato!', 'success');
    }).catch(() => {
        // Fallback: mostra il link in un prompt
        prompt('Copia questo link di invito:', inviteLink);
    });
}

// Condividi link via Web Share API (mobile)
function shareTeamInviteLink(teamName, code) {
    const baseUrl = window.location.href.split('?')[0].split('#')[0];
    const inviteLink = `${baseUrl}?jointeam=${code}`;

    if (navigator.share) {
        navigator.share({
            title: `Unisciti al team "${teamName}"`,
            text: `Sei stato invitato a unirti al team "${teamName}" su SAVERS Pro!`,
            url: inviteLink
        }).catch(() => {
            // Se share fallisce, copia il link
            copyTeamInviteLink(null, code);
        });
    } else {
        copyTeamInviteLink(null, code);
    }
}

// Aggiorna privacy del team
async function updateTeamPrivacy(teamId, isPrivate) {
    try {
        const response = await apiCall('updateTeamSettings', {
            teamId: teamId,
            isPrivate: isPrivate
        });

        if (response.success) {
            showToast(isPrivate ? 'Team impostato come privato 🔒' : 'Team impostato come pubblico 🌐', 'success');
            await loadUserTeams();
            // Ricarica dettagli se modal aperto
            if (currentTeamId === teamId) {
                openTeamDetail(teamId);
            }
        } else {
            showToast(response.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore updateTeamPrivacy:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Controlla se c'è un codice invito nell'URL all'avvio
function checkUrlInviteCode() {
    const urlParams = new URLSearchParams(window.location.search);
    const inviteCode = urlParams.get('jointeam');

    if (inviteCode) {
        // Rimuovi il parametro dall'URL senza ricaricare
        const newUrl = window.location.href.split('?')[0];
        window.history.replaceState({}, document.title, newUrl);

        // Aspetta che l'app sia inizializzata, poi mostra il modal
        setTimeout(() => {
            document.getElementById('teamInviteCodeInput').value = inviteCode.toUpperCase();
            openModal('joinTeamModal');
            showToast('Inserisci il codice o clicca "Unisciti"', 'info');
        }, 1000);
    }
}

// Rimuovi membro dal team (con backend Google Sheets)
async function removeTeamMember(teamId, targetUsername) {
    if (!confirm('Rimuovere questo membro dal team?')) return;

    try {
        const response = await apiCall('removeTeamMember', {
            teamId: teamId,
            targetUsername: targetUsername
        });

        if (response.success) {
            showToast('Membro rimosso', 'success');
            await loadUserTeams();
            openTeamDetail(teamId);
        } else {
            showToast(response.message || 'Errore nella rimozione', 'error');
        }
    } catch (error) {
        console.error('Errore removeTeamMember:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Elimina team (con backend Google Sheets)
async function deleteTeam(teamId) {
    if (!confirm('Eliminare questo team? Tutti i membri verranno rimossi.')) return;

    try {
        const response = await apiCall('deleteTeam', {
            teamId: teamId
        });

        if (response.success) {
            closeModal('teamDetailModal');
            showToast('Team eliminato', 'success');
            await loadUserTeams();
        } else {
            showToast(response.message || 'Errore nella eliminazione', 'error');
        }
    } catch (error) {
        console.error('Errore deleteTeam:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Esci dal team (con backend Google Sheets)
async function leaveTeam(teamId) {
    if (!confirm('Vuoi uscire da questo team?')) return;

    try {
        const response = await apiCall('leaveTeam', {
            teamId: teamId
        });

        if (response.success) {
            closeModal('teamDetailModal');
            showToast('Sei uscito dal team', 'info');
            await loadUserTeams();
        } else {
            showToast(response.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore leaveTeam:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Cambia ruolo di un membro del team (owner può cambiare)
async function changeTeamMemberRole(teamId, targetUsername, newRole) {
    try {
        const response = await apiCall('changeTeamMemberRole', {
            teamId: teamId,
            targetUsername: targetUsername,
            newRole: newRole
        });

        if (response.success) {
            showToast(response.message || 'Ruolo aggiornato', 'success');
            await loadUserTeams();
            openTeamDetail(teamId); // Riapri per aggiornare la UI
        } else {
            showToast(response.message || 'Errore', 'error');
            await loadUserTeams();
            openTeamDetail(teamId);
        }
    } catch (error) {
        console.error('Errore changeTeamMemberRole:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Trasferisci ownership del team
async function transferTeamOwnership(teamId) {
    const select = document.getElementById('transferOwnershipSelect');
    const newOwnerUsername = select?.value;

    if (!newOwnerUsername) {
        showToast('Seleziona il nuovo proprietario', 'error');
        return;
    }

    if (!confirm(`Sei sicuro di voler trasferire la proprietà del team a ${newOwnerUsername}? Tu diventerai admin.`)) {
        return;
    }

    try {
        const response = await apiCall('transferTeamOwnership', {
            teamId: teamId,
            newOwnerUsername: newOwnerUsername
        });

        if (response.success) {
            showToast(response.message || 'Ownership trasferita!', 'success');
            await loadUserTeams();
            openTeamDetail(teamId);
        } else {
            showToast(response.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore transferTeamOwnership:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Switch tab nel modal unisciti
function switchJoinTab(tab) {
    joinTeamTab = tab;

    document.getElementById('joinByCodeTab').className = tab === 'code' ? 'btn btn-sm' : 'btn btn-secondary btn-sm';
    document.getElementById('joinBySearchTab').className = tab === 'search' ? 'btn btn-sm' : 'btn btn-secondary btn-sm';

    document.getElementById('joinByCodeSection').style.display = tab === 'code' ? 'block' : 'none';
    document.getElementById('joinBySearchSection').style.display = tab === 'search' ? 'block' : 'none';

    // Carica automaticamente i team pubblici quando si passa al tab cerca
    if (tab === 'search') {
        loadPublicTeams();
    }
}

// Carica tutti i team pubblici (senza filtro)
async function loadPublicTeams() {
    const container = document.getElementById('publicTeamsList');

    // Mostra loading
    container.innerHTML = `
        <div class="text-muted text-center" style="padding:20px;">
            <div class="spinner" style="margin:0 auto 10px;"></div>
            Caricamento team pubblici...
        </div>
    `;

    try {
        const response = await apiCall('searchPublicTeams', { query: '' });

        if (!response.success) {
            container.innerHTML = `
                <div class="text-muted text-center" style="padding:20px;">
                    ❌ Errore nel caricamento
                </div>
            `;
            return;
        }

        const publicTeams = response.teams || [];

        if (publicTeams.length === 0) {
            container.innerHTML = `
                <div class="text-muted text-center" style="padding:20px;">
                    📭 Nessun team pubblico disponibile al momento
                </div>
            `;
            return;
        }

        container.innerHTML = publicTeams.map(team => `
            <div style="display:flex; align-items:center; padding:12px; border-bottom:1px solid var(--border-color);">
                <div style="
                    width:40px;
                    height:40px;
                    border-radius:8px;
                    background:var(--primary);
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    margin-right:12px;
                    font-size:1.2rem;
                ">🏢</div>
                <div style="flex:1;">
                    <div style="font-weight:500;">${team.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted);">
                        ${team.memberCount || 0} membri • Creato da ${team.ownerUsername || 'N/A'}
                    </div>
                    ${team.description ? `<div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">${team.description.substring(0, 60)}${team.description.length > 60 ? '...' : ''}</div>` : ''}
                </div>
                <button class="btn btn-primary btn-sm" onclick="joinTeamByInviteCode('${team.inviteCode}')">
                    Unisciti
                </button>
            </div>
        `).join('');

    } catch (error) {
        console.error('Errore caricamento team pubblici:', error);
        container.innerHTML = `
            <div class="text-muted text-center" style="padding:20px;">
                ❌ Errore di connessione
            </div>
        `;
    }
}

// Unisciti al team tramite codice (con backend Google Sheets)
async function joinTeamByCode() {
    const code = document.getElementById('teamInviteCodeInput').value.trim().toUpperCase();

    if (!code) {
        showToast('Inserisci il codice invito', 'error');
        return;
    }

    try {
        showToast('Invio richiesta...', 'info');

        const response = await apiCall('joinTeamByCode', {
            inviteCode: code
        });

        if (response.success) {
            closeModal('joinTeamModal');
            document.getElementById('teamInviteCodeInput').value = '';

            showToast(response.message || `Richiesta inviata al team "${response.teamName}"!`, 'success');

            // Ricarica i team dal backend
            await loadUserTeams();
        } else {
            showToast(response.message || 'Codice invito non valido', 'error');
        }
    } catch (error) {
        console.error('Errore joinTeamByCode:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Cerca team pubblici - chiama il backend
let searchTeamTimeout = null;

async function searchPublicTeams() {
    const query = document.getElementById('searchTeamInput').value.trim();
    const container = document.getElementById('publicTeamsList');

    // Debounce per evitare troppe chiamate
    if (searchTeamTimeout) clearTimeout(searchTeamTimeout);

    // Mostra loading
    container.innerHTML = `
        <div class="text-muted text-center" style="padding:20px;">
            <div class="spinner" style="margin:0 auto 10px;"></div>
            Ricerca in corso...
        </div>
    `;

    searchTeamTimeout = setTimeout(async () => {
        try {
            const response = await apiCall('searchPublicTeams', { query });

            if (!response.success) {
                container.innerHTML = `
                    <div class="text-muted text-center" style="padding:20px;">
                        ❌ Errore nella ricerca
                    </div>
                `;
                return;
            }

            const publicTeams = response.teams || [];

            if (publicTeams.length === 0) {
                container.innerHTML = `
                    <div class="text-muted text-center" style="padding:20px;">
                        ${query ? 'Nessun team pubblico trovato per "' + query + '"' : 'Nessun team pubblico disponibile'}
                    </div>
                `;
                return;
            }

            container.innerHTML = publicTeams.map(team => `
                <div style="display:flex; align-items:center; padding:12px; border-bottom:1px solid var(--border-color);">
                    <div style="
                        width:40px;
                        height:40px;
                        border-radius:8px;
                        background:var(--primary);
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        margin-right:12px;
                        font-size:1.2rem;
                    ">🏢</div>
                    <div style="flex:1;">
                        <div style="font-weight:500;">${team.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">
                            ${team.memberCount || 0} membri • Creato da ${team.ownerUsername || 'N/A'}
                        </div>
                        ${team.description ? `<div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">${team.description.substring(0, 60)}${team.description.length > 60 ? '...' : ''}</div>` : ''}
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="joinTeamByInviteCode('${team.inviteCode}')">
                        Unisciti
                    </button>
                </div>
            `).join('');

        } catch (error) {
            console.error('Errore ricerca team:', error);
            container.innerHTML = `
                <div class="text-muted text-center" style="padding:20px;">
                    ❌ Errore di connessione
                </div>
            `;
        }
    }, 300); // 300ms debounce
}

// Helper per unirsi tramite codice invito
async function joinTeamByInviteCode(inviteCode) {
    if (!inviteCode) {
        showToast('Codice invito mancante', 'error');
        return;
    }

    // Usa il token più recente (currentUser ha priorità su localStorage)
    let token = currentUser?.token || state.cloudUser?.token || localStorage.getItem('savers_token');

    console.log('🔑 Token usato:', token ? token.substring(0, 15) + '...' : 'NESSUNO');

    if (!token) {
        showToast('Devi essere loggato per unirti a un team', 'error');
        return;
    }

    try {
        showToast('⏳ Invio richiesta...', 'info');
        console.log('📤 joinTeamByCode - inviteCode:', inviteCode);

        const response = await apiCall('joinTeamByCode', {
            token: token,
            inviteCode: inviteCode.toUpperCase().trim()
        });

        console.log('📥 joinTeamByCode response:', response);

        if (response.success) {
            showToast('✅ ' + (response.message || 'Richiesta inviata!'), 'success');
            closeModal('joinTeamModal');
            // Ricarica i team
            if (typeof loadUserTeams === 'function') {
                loadUserTeams();
            }
        } else {
            showToast('❌ ' + (response.message || 'Errore sconosciuto'), 'error');
        }
    } catch (error) {
        console.error('❌ Errore join team:', error);
        showToast('Errore: ' + (error.message || 'Connessione fallita'), 'error');
    }
}

// Richiedi iscrizione a team
function requestJoinTeam(teamId) {
    const team = (state.teams || []).find(t => t.id === teamId);
    if (!team) return;

    const myEmail = (currentUser?.email || state.profile?.email || '').toLowerCase();
    const myName = currentUser?.name || state.profile?.name || myEmail.split('@')[0];

    // Verifica se già membro
    if (team.members?.some(m => m.email?.toLowerCase() === myEmail)) {
        showToast('Fai già parte di questo team!', 'warning');
        return;
    }

    // Verifica richiesta già pendente
    if ((state.teamJoinRequests || []).some(r => r.teamId === teamId && r.userEmail === myEmail && r.status === 'pending')) {
        showToast('Hai già una richiesta pendente per questo team', 'warning');
        return;
    }

    const request = {
        id: 'req_' + Date.now(),
        teamId: team.id,
        teamName: team.name,
        userEmail: myEmail,
        userName: myName,
        message: '',
        status: 'pending',
        requestedAt: new Date().toISOString()
    };

    state.teamJoinRequests = state.teamJoinRequests || [];
    state.teamJoinRequests.push(request);
    saveStateAndSync();

    closeModal('joinTeamModal');
    showToast(`Richiesta inviata a "${team.name}"!`, 'success');
}

// Ottieni tutti i membri dei miei team (per autocomplete e assegnazione task)
// I membri vengono dai Team salvati su Google Sheets
function getTeamMembersForAutocomplete() {
    const myUsername = currentUser?.username || '';
    const members = [];
    const seenUsernames = new Set();

    // Aggiungi membri da tutti i team a cui appartengo
    (state.teams || []).forEach(team => {
        (team.members || []).forEach(m => {
            // Usa username come identificatore unico
            const username = m.username || m.email;
            if (username && !seenUsernames.has(username)) {
                seenUsernames.add(username);
                members.push({
                    id: username,
                    username: m.username,
                    email: m.email || '',
                    name: m.username || m.email?.split('@')[0] || 'Membro',
                    teamName: team.name,
                    teamId: team.id,
                    role: m.role
                });
            }
        });
    });

    return members;
}

// Ottieni tutti i membri unici da tutti i team per visualizzazione
function getAllTeamMembers() {
    return getTeamMembersForAutocomplete();
}

// ============================================
// TEAM ALIGNMENT MAP
// ============================================

/**
 * Helper per trovare un progetto sia nei propri che nei condivisi
 * Gestisce ID normali e ID con prefisso "shared_"
 */
function getProjectById(projectId) {
    if (!projectId) return null;

    // Prima cerca nei progetti propri
    let project = state.teamProjects?.find(p => p.id === projectId);
    if (project) return project;

    // Se l'ID inizia con "shared_", cerca nei progetti condivisi
    if (projectId.startsWith('shared_')) {
        const sharedId = projectId.replace('shared_', '');
        const shared = state.sharedProjects?.find(p => p.id === sharedId);
        if (shared) {
            // Restituisci i dati del progetto con metadati di condivisione
            project = shared.data || shared;
            project.id = projectId; // Mantieni l'ID con prefisso per consistenza
            project.isShared = true;
            project.ownerEmail = shared.ownerEmail;
            project.myPermission = shared.myPermission;
            return project;
        }
    }

    // Cerca anche nei condivisi senza prefisso (fallback)
    const sharedFallback = state.sharedProjects?.find(p => p.id === projectId);
    if (sharedFallback) {
        project = sharedFallback.data || sharedFallback;
        project.isShared = true;
        project.ownerEmail = sharedFallback.ownerEmail;
        project.myPermission = sharedFallback.myPermission;
        return project;
    }

    return null;
}

function renderTeamPage() {
    console.log('🏢 renderTeamPage chiamato');
    console.log('  - state.cloudUser:', state.cloudUser);
    console.log('  - state.teamProjects:', state.teamProjects?.length || 0);
    console.log('  - state.sharedProjects:', state.sharedProjects?.length || 0);

    renderMyTeams();
    renderTeamMembers();

    // Carica progetti condivisi se non ancora caricati
    if (state.cloudUser?.token && (!state.sharedProjects || state.sharedProjects.length === 0)) {
        console.log('  - Caricamento progetti condivisi...');
        loadSharedProjects().then(() => {
            console.log('  - loadSharedProjects completato, ora renderProjectSelector');
            renderProjectSelector();
        });
    } else {
        console.log('  - Render diretto del selettore progetti');
        renderProjectSelector();
    }

    renderTeamProject();
}

function renderTeamMembers() {
    const container = document.getElementById('teamMembersGrid');
    const hint = document.getElementById('noTeamMembersHint');
    if (!container) return;

    // Ottieni membri da tutti i team (dal backend Google Sheets)
    const members = getAllTeamMembers();

    if (members.length === 0) {
        container.innerHTML = '';
        if (hint) hint.style.display = 'block';
        return;
    }

    if (hint) hint.style.display = 'none';

    // Genera colori consistenti per ogni membro
    const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444'];

    // Mostra membri con nome completo e ruolo
    container.innerHTML = members.map((m, i) => {
        const initial = (m.name || m.username || '?').charAt(0).toUpperCase();
        const displayName = m.name || m.username || m.email?.split('@')[0] || 'Membro';
        const roleIcon = m.role === 'owner' ? '👑' : '';
        const teamBadge = m.teamName ? `<span class="member-team-badge">${m.teamName}</span>` : '';

        return `
            <div class="team-member-card" onclick="viewMemberDetails('${encodeURIComponent(JSON.stringify(m))}')">
                <div class="member-avatar" style="background:${colors[i % colors.length]}">
                    ${initial}
                </div>
                <div class="member-info">
                    <div class="member-name">${roleIcon} ${displayName}</div>
                    ${teamBadge}
                </div>
            </div>
        `;
    }).join('');

    // Aggiorna contatore
    const teamCountEl = document.getElementById('teamMembersCount');
    if (teamCountEl) teamCountEl.textContent = members.length;
}

function renderProjectSelector() {
    const select = document.getElementById('teamProjectSelect');
    if (!select) {
        console.warn('⚠️ renderProjectSelector: select #teamProjectSelect non trovato');
        return;
    }

    // I MIEI PROGETTI: progetti di cui sono owner (state.teamProjects)
    // CONDIVISI CON ME: progetti di ALTRI utenti che li hanno condivisi con me (state.sharedProjects)
    const myProjects = state.teamProjects || [];
    const sharedWithMe = state.sharedProjects || [];

    console.log('📋 renderProjectSelector chiamato');
    console.log('  - I MIEI progetti (sono owner):', myProjects.length);
    console.log('  - CONDIVISI con me (altri owner):', sharedWithMe.length);
    console.log('  - currentProjectId:', currentProjectId);

    let html = '<option value="">Seleziona un progetto...</option>';

    // ========== I MIEI PROGETTI (di cui sono owner) ==========
    html += '<optgroup label="📁 I miei progetti">';
    if (myProjects.length > 0) {
        html += myProjects.map(p => {
            const hasCollaborators = p.collaborators?.length > 0;
            const collabIcon = hasCollaborators ? ' 👥' : '';
            return `<option value="${p.id}" ${p.id === currentProjectId ? 'selected' : ''}>${p.name}${collabIcon}</option>`;
        }).join('');
    } else {
        html += '<option value="" disabled>Nessun progetto creato</option>';
    }
    html += '</optgroup>';

    // ========== PROGETTI CONDIVISI CON ME (di altri owner) ==========
    html += '<optgroup label="📥 Condivisi con me">';
    if (sharedWithMe.length > 0) {
        html += sharedWithMe.map(sp => {
            const sharedId = 'shared_' + sp.id;
            const permissionIcon = sp.myPermission === 'editor' ? '✏️' : '👁️';
            const ownerName = sp.ownerUsername || sp.ownerEmail?.split('@')[0] || 'Sconosciuto';
            return `<option value="${sharedId}" ${sharedId === currentProjectId ? 'selected' : ''}>${permissionIcon} ${sp.name} (da ${ownerName})</option>`;
        }).join('');
    } else {
        html += '<option value="" disabled>Nessun progetto condiviso</option>';
    }
    html += '</optgroup>';

    select.innerHTML = html;
    console.log('  - HTML generato, optgroups inseriti');

    // Se c'è un progetto selezionato, assicurati che sia visibile nel selector
    if (currentProjectId) {
        select.value = currentProjectId;
    }
}

function loadTeamProject(projectId) {
    console.log('📂 loadTeamProject chiamato con projectId:', projectId);

    // Se è un progetto condiviso, carica i dati aggiornati dal server
    if (projectId && projectId.startsWith('shared_')) {
        const sharedId = projectId.replace('shared_', '');
        console.log('  - Progetto condiviso, ID reale:', sharedId);
        loadSharedProjectData(sharedId);
    }

    currentProjectId = projectId;
    console.log('  - currentProjectId impostato a:', currentProjectId);
    renderTeamProject();
}

// Carica i dati aggiornati di un progetto condiviso dal server
async function loadSharedProjectData(projectId) {
    if (!state.cloudUser?.token) return;

    try {
        // Usa apiCall per evitare problemi CORS
        const result = await apiCall('loadSharedProject', {
            email: state.cloudUser.email,
            projectId: projectId
        });

        if (result.success && result.project) {
            // Aggiorna i dati locali del progetto condiviso
            const idx = state.sharedProjects?.findIndex(p => p.id === projectId);
            if (idx >= 0) {
                state.sharedProjects[idx] = result.project;
            }
            renderTeamProject();
        }
    } catch (error) {
        console.error('Errore caricamento progetto condiviso:', error);
    }
}

function selectProject(projectId) {
    loadTeamProject(projectId);
}

function renderTeamProject() {
    const container = document.getElementById('teamAlignmentMap');
    const emptyState = document.getElementById('teamEmptyState');

    if (!currentProjectId) {
        if (container) container.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        return;
    }

    // Usa helper che gestisce sia progetti propri che condivisi
    const project = getProjectById(currentProjectId);

    if (!project) {
        console.warn('⚠️ Progetto non trovato:', currentProjectId);
        if (container) container.style.display = 'none';
        if (emptyState) emptyState.style.display = 'block';
        return;
    }

    if (container) container.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';

    // Update header
    const titleEl = document.getElementById('currentProjectTitle');
    const objectiveEl = document.getElementById('currentProjectObjective');
    const deadlineEl = document.getElementById('currentProjectDeadline');
    const teamCountEl = document.getElementById('currentProjectTeamCount');

    // Mostra se è un progetto condiviso con me (non mio)
    const isSharedWithMe = currentProjectId.startsWith('shared_') || project.isShared;
    const ownerInfo = isSharedWithMe ? ` (da ${project.ownerEmail?.split('@')[0] || 'altro utente'})` : '';
    const projectIcon = isSharedWithMe ? '📥 ' : '📁 ';

    if (titleEl) titleEl.textContent = projectIcon + project.name + ownerInfo;
    if (objectiveEl) objectiveEl.textContent = project.objective || 'Clicca per definire un obiettivo...';
    if (deadlineEl) deadlineEl.textContent = project.deadline ? formatDate(project.deadline) : 'Nessuna scadenza';
    // Mostra membri del progetto, o tutti i membri se non specificati
    const projectMemberCount = project.members?.length || getAllTeamMembers().length;
    if (teamCountEl) teamCountEl.textContent = projectMemberCount;

    // Calculate and update project statistics
    updateProjectStats(project);

    // Update sharing badge
    updateSharingBadge(project);

    // Render Kanban columns
    renderKanbanColumn('todo', project.columns?.tasks?.filter(t => t.status === 'todo') || []);
    renderKanbanColumn('doing', project.columns?.tasks?.filter(t => t.status === 'doing') || []);
    renderKanbanColumn('done', project.columns?.tasks?.filter(t => t.status === 'done') || []);

    // Render Problems
    renderTeamProblems(project.columns?.problems || []);

    // Render Resources
    renderTeamResources(project.columns?.resources || []);

    // Render Activity Log (Bacheca)
    renderProjectActivityLog(project);

    // Setup touch drag drop per i task del team
    setTimeout(() => initTouchDragDrop(), 100);
}

function renderKanbanColumn(status, tasks) {
    // Map status to correct HTML element IDs: teamTodoTasks, teamDoingTasks, teamDoneTasks
    const idMap = {
        'todo': 'teamTodoTasks',
        'doing': 'teamDoingTasks',
        'done': 'teamDoneTasks'
    };
    const containerId = idMap[status];
    const container = document.getElementById(containerId);
    if (!container) return;

    // Update count badge
    const countEl = document.getElementById(`team${status.charAt(0).toUpperCase() + status.slice(1)}Count`);
    if (countEl) countEl.textContent = tasks.length;

    if (tasks.length === 0) {
        container.innerHTML = '<div class="kanban-empty">Nessun task</div>';
        return;
    }

    // Se ci sono più di 30 task, usa lazy loading per performance
    if (tasks.length > 30) {
        lazyLoader.reset(containerId);
        lazyLoader.init(containerId, tasks, (task) => renderSingleKanbanTask(status, task));
        return;
    }

    // Altrimenti renderizza normalmente
    container.innerHTML = tasks.map(task => renderSingleKanbanTask(status, task)).join('');
}

// Renderizza singolo task Kanban (usato sia da lazy loading che da render normale)
function renderSingleKanbanTask(status, task) {
    return `
        <div class="kanban-task" draggable="true" data-id="${task.id}" ondragstart="dragTask(event)" ondragend="dragEnd(event)" onmouseenter="prefetchTaskComments('${task.id}')">
            <div class="kanban-task-title" onclick="openEditTeamTask('${task.id}')" style="cursor:pointer;">${task.title}</div>
            ${task.description ? `<div class="kanban-task-desc" style="font-size:0.75rem; color:var(--text-muted); margin-bottom:6px;">${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}</div>` : ''}

            <!-- Scadenza Task -->
            ${task.deadline ? `<div style="margin-bottom:6px;">${getTaskDeadlineBadge(task.deadline)}</div>` : ''}

            <!-- Assegnatari (singoli o multipli) -->
            <div class="task-assignees">
                ${renderTaskAssignees(task.assignees || (task.assignee ? [task.assignee] : []))}
            </div>

            <div class="kanban-task-meta" style="margin-top:8px;">
                <span style="display:flex; gap:4px; align-items:center;">
                    ${task.comments?.length ? `<span class="kanban-comments" title="${task.comments.length} commenti">💬 ${task.comments.length}</span>` : ''}
                    ${task.problems?.length ? '<span class="kanban-warning">⚠️</span>' : ''}
                </span>
            </div>

            <!-- Bottoni Azione -->
            <div class="kanban-task-actions">
                ${status !== 'todo' ? `<button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); moveTask('${task.id}', 'prev')" title="Sposta indietro">←</button>` : ''}
                <button class="btn btn-primary btn-xs" onclick="event.stopPropagation(); openEditTeamTask('${task.id}')" title="Modifica / Commenta">✏️ Modifica</button>
                ${status !== 'done' ? `<button class="btn btn-ghost btn-xs" onclick="event.stopPropagation(); moveTask('${task.id}', 'next')" title="Sposta avanti">→</button>` : ''}
            </div>
        </div>
    `;
}

function renderTeamProblems(problems) {
    const container = document.getElementById('teamProblemsList');
    if (!container) return;

    if (problems.length === 0) {
        container.innerHTML = '<div class="empty-mini">Nessun problema 🎉</div>';
        return;
    }

    container.innerHTML = problems.map(prob => `
        <div class="problem-card priority-${prob.priority || 'medium'}">
            <div class="problem-title">${prob.title}</div>
            <div class="problem-meta">
                <span class="problem-priority">${prob.priority === 'high' ? '🔴' : prob.priority === 'medium' ? '🟡' : '🟢'}</span>
                <button class="btn btn-ghost btn-xs" onclick="convertProblemToTask('${prob.id}')">→ Task</button>
            </div>
        </div>
    `).join('');
}

function renderTeamResources(resources) {
    const container = document.getElementById('teamResourcesList');
    if (!container) return;

    if (resources.length === 0) {
        container.innerHTML = '<div class="empty-mini">Nessuna risorsa</div>';
        return;
    }

    container.innerHTML = resources.map(res => {
        const icon = res.type === 'document' ? '📄' : res.type === 'link' ? '🔗' : '👤';

        // Se ha URL, rendi tutto cliccabile
        if (res.url) {
            return `
                <a href="${res.url}" target="_blank" rel="noopener noreferrer" class="resource-card" style="text-decoration:none;color:inherit;cursor:pointer;">
                    <span class="resource-icon">${icon}</span>
                    <span class="resource-title" style="flex:1;">${res.title}</span>
                    <span style="color:var(--primary);font-size:12px;">↗</span>
                </a>
            `;
        }

        return `
            <div class="resource-card">
                <span class="resource-icon">${icon}</span>
                <span class="resource-title">${res.title}</span>
            </div>
        `;
    }).join('');
}

function getTeamMemberName(memberId) {
    const member = getAllTeamMembers().find(m => m.id === memberId || m.username === memberId);
    return member ? member.name : 'Non assegnato';
}

function getTeamMemberAvatar(memberId) {
    const member = getAllTeamMembers().find(m => m.id === memberId || m.username === memberId);
    const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];
    const color = member ? colors[member.name.charCodeAt(0) % colors.length] : '#6366f1';
    return member ? `<span style="background:${color}; width:24px; height:24px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.7rem; color:white;">${(member.name || '?').charAt(0).toUpperCase()}</span>` : '👤';
}

// ========== PROJECT STATISTICS ==========

function updateProjectStats(project) {
    const tasks = project.columns?.tasks || [];
    const totalTasks = tasks.length;
    const completedTasks = tasks.filter(t => t.status === 'done').length;
    const completionPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    // Calcola giorni rimanenti
    let daysLeft = '--';
    if (project.deadline) {
        const deadline = new Date(project.deadline);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        deadline.setHours(0, 0, 0, 0);
        const diffTime = deadline - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) {
            daysLeft = `<span style="color:#ef4444;">Scaduto da ${Math.abs(diffDays)} gg</span>`;
        } else if (diffDays === 0) {
            daysLeft = `<span style="color:#f59e0b;">OGGI!</span>`;
        } else if (diffDays <= 3) {
            daysLeft = `<span style="color:#f59e0b;">${diffDays}</span>`;
        } else {
            daysLeft = diffDays;
        }
    }

    // Aggiorna elementi DOM
    const daysLeftEl = document.getElementById('projectDaysLeft');
    const totalTasksEl = document.getElementById('projectTotalTasks');
    const completedTasksEl = document.getElementById('projectCompletedTasks');
    const percentEl = document.getElementById('projectCompletionPercent');
    const progressBar = document.getElementById('projectProgressBar');

    if (daysLeftEl) daysLeftEl.innerHTML = daysLeft;
    if (totalTasksEl) totalTasksEl.textContent = totalTasks;
    if (completedTasksEl) completedTasksEl.textContent = completedTasks;
    if (percentEl) percentEl.textContent = completionPercent + '%';
    if (progressBar) progressBar.style.width = completionPercent + '%';
}

// ========== TASK DEADLINE BADGE ==========

function getTaskDeadlineBadge(deadline) {
    if (!deadline) return '';

    const deadlineDate = new Date(deadline);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    deadlineDate.setHours(0, 0, 0, 0);

    const diffTime = deadlineDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    let badgeClass = '';
    let text = '';

    if (diffDays < 0) {
        badgeClass = 'overdue';
        text = `⚠️ Scaduto da ${Math.abs(diffDays)} gg`;
    } else if (diffDays === 0) {
        badgeClass = 'overdue';
        text = '🔥 Scade OGGI!';
    } else if (diffDays <= 2) {
        badgeClass = 'soon';
        text = `⏰ Scade tra ${diffDays} gg`;
    } else {
        text = `📅 ${formatDate(deadline)}`;
    }

    return `<span class="task-deadline-badge ${badgeClass}">${text}</span>`;
}

// ========== RENDER TASK ASSIGNEES (MULTIPLI) ==========

function renderTaskAssignees(assigneeIds) {
    if (!assigneeIds || assigneeIds.length === 0) {
        return '<span class="task-assignee-chip" style="opacity:0.6;">👤 Non assegnato</span>';
    }

    // Usa membri dai Team invece di state.teamMembers
    const members = getAllTeamMembers();

    return assigneeIds.map(id => {
        const member = members.find(m => m.id === id || m.username === id);
        if (!member) return '';

        const displayName = member.name || member.username || id;
        const avatarChar = displayName.charAt(0).toUpperCase();

        return `
            <span class="task-assignee-chip">
                <span class="mini-avatar" style="background:${member.color || '#6366f1'}">${member.avatar || avatarChar}</span>
                ${displayName}
            </span>
        `;
    }).join('');
}

// ========== EDIT PROJECT MODAL ==========

function openEditProjectModal() {
    console.log('🔧 openEditProjectModal chiamato');
    console.log('  - currentProjectId:', currentProjectId);
    console.log('  - state.teamProjects:', state.teamProjects?.length || 0);

    if (!currentProjectId) {
        console.warn('⚠️ currentProjectId è null!');
        showToast('Seleziona prima un progetto', 'warning');
        return;
    }

    const project = getProjectById(currentProjectId);
    console.log('  - project trovato:', project ? project.name : 'NO');

    if (!project) {
        showToast('Progetto non trovato', 'error');
        return;
    }

    document.getElementById('editProjectName').value = project.name || '';
    document.getElementById('editProjectObjective').value = project.objective || '';
    document.getElementById('editProjectDeadline').value = project.deadline || '';
    document.getElementById('editProjectNotes').value = project.notes || '';

    // Popola lista membri con quelli già selezionati
    renderProjectMembersSelect('editProjectMembersSelect', project.members || []);

    openModal('editProjectModal');
}

function updateProject() {
    const project = getProjectById(currentProjectId);
    if (!project) return;

    const name = document.getElementById('editProjectName').value.trim();
    if (!name) {
        showToast('Inserisci un nome', 'error');
        return;
    }

    project.name = name;
    project.objective = document.getElementById('editProjectObjective').value;
    project.deadline = document.getElementById('editProjectDeadline').value;
    project.notes = document.getElementById('editProjectNotes').value;
    project.members = getSelectedProjectMembers('editProjectMembersSelect');
    project.updatedAt = new Date().toISOString();

    saveStateAndSync();
    closeModal('editProjectModal');
    renderProjectSelector();
    renderTeamProject();
    showToast('Progetto aggiornato!', 'success');
}

function deleteCurrentProject() {
    if (!currentProjectId) return;

    if (confirm('Sei sicuro di voler eliminare questo progetto e tutti i suoi task?')) {
        state.teamProjects = state.teamProjects.filter(p => p.id !== currentProjectId);
        currentProjectId = null;
        saveStateAndSync();
        closeModal('editProjectModal');
        renderTeamPage();
        showToast('Progetto eliminato', 'info');
    }
}

// ========== ARCHIVIAZIONE PROGETTI ==========

function archiveProject(projectId = currentProjectId) {
    if (!projectId) {
        showToast('Seleziona un progetto', 'warning');
        return;
    }

    const project = state.teamProjects.find(p => p.id === projectId);
    if (!project) {
        showToast('Progetto non trovato', 'error');
        return;
    }

    if (confirm(`Archiviare il progetto "${project.name}"? Sarà spostato nell'archivio.`)) {
        // Aggiungi metadati di archiviazione
        project.archivedAt = new Date().toISOString();
        project.status = 'archived';

        // Calcola statistiche finali
        const tasks = project.columns?.tasks || [];
        project.finalStats = {
            totalTasks: tasks.length,
            completedTasks: tasks.filter(t => t.status === 'done').length,
            completionRate: tasks.length > 0 ? Math.round((tasks.filter(t => t.status === 'done').length / tasks.length) * 100) : 0
        };

        // Sposta nell'archivio
        state.archivedProjects = state.archivedProjects || [];
        state.archivedProjects.push(project);

        // Rimuovi dai progetti attivi
        state.teamProjects = state.teamProjects.filter(p => p.id !== projectId);

        if (currentProjectId === projectId) {
            currentProjectId = null;
        }

        saveStateAndSync();
        closeModal('editProjectModal');
        renderTeamPage();
        showToast('Progetto archiviato!', 'success');
    }
}

// ========== EXPORT CSV PROGETTO ==========

function exportProjectCSV() {
    const project = state.teamProjects?.find(p => p.id === currentProjectId);
    if (!project) {
        showToast('Seleziona un progetto', 'warning');
        return;
    }

    const members = getAllTeamMembers();

    // Raccoglie tutti i task da tutte le colonne
    const allTasks = [
        ...(project.columns?.todo || []).map(t => ({...t, status: 'Da Fare'})),
        ...(project.columns?.progress || []).map(t => ({...t, status: 'In Corso'})),
        ...(project.columns?.done || []).map(t => ({...t, status: 'Completato'})),
        ...(project.columns?.tasks || []).map(t => ({...t, status: t.status || 'Da Fare'}))
    ];

    // Header CSV
    const headers = [
        'ID Task',
        'Titolo',
        'Descrizione',
        'Status',
        'Assegnato A',
        'Scadenza',
        'Priorità',
        'Commenti',
        'Creato Il',
        'Completato Il'
    ];

    // Rows
    const rows = allTasks.map(task => {
        // Trova i nomi degli assegnatari
        const assigneeIds = task.assignees || (task.assignee ? [task.assignee] : []);
        const assigneeNames = assigneeIds.map(id => {
            const member = members.find(m => m.id === id || m.username === id);
            return member?.name || member?.username || id;
        }).join('; ');

        // Conta commenti
        const commentsCount = task.comments?.length || 0;

        // Formatta status in italiano
        let statusLabel = task.status;
        if (task.status === 'todo') statusLabel = 'Da Fare';
        if (task.status === 'progress') statusLabel = 'In Corso';
        if (task.status === 'done') statusLabel = 'Completato';

        return [
            task.id,
            escapeCsvField(task.title || ''),
            escapeCsvField(task.description || ''),
            statusLabel,
            assigneeNames,
            task.deadline || '',
            task.priority || 'media',
            commentsCount,
            task.createdAt ? formatDateCSV(task.createdAt) : '',
            task.completedAt ? formatDateCSV(task.completedAt) : ''
        ];
    });

    // Aggiungi riga riepilogo
    const totalTasks = allTasks.length;
    const completedTasks = allTasks.filter(t => t.status === 'Completato' || t.status === 'done').length;
    const inProgressTasks = allTasks.filter(t => t.status === 'In Corso' || t.status === 'progress').length;
    const todoTasks = totalTasks - completedTasks - inProgressTasks;

    rows.push([]); // Riga vuota
    rows.push(['--- RIEPILOGO PROGETTO ---']);
    rows.push(['Nome Progetto', project.name]);
    rows.push(['Obiettivo', project.objective || '-']);
    rows.push(['Scadenza', project.deadline || '-']);
    rows.push(['Task Totali', totalTasks]);
    rows.push(['Da Fare', todoTasks]);
    rows.push(['In Corso', inProgressTasks]);
    rows.push(['Completati', completedTasks]);
    rows.push(['Completamento', totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) + '%' : '0%']);

    // Genera CSV
    let csv = '\uFEFF'; // BOM per Excel
    csv += headers.join(',') + '\n';
    csv += rows.map(row => row.join(',')).join('\n');

    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `progetto_${sanitizeFilename(project.name)}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('CSV esportato con successo! 📊', 'success');
}

function escapeCsvField(field) {
    if (!field) return '';
    // Se contiene virgole, a capo o virgolette, racchiudi tra virgolette
    if (field.includes(',') || field.includes('\n') || field.includes('"')) {
        return '"' + field.replace(/"/g, '""') + '"';
    }
    return field;
}

function formatDateCSV(dateStr) {
    if (!dateStr) return '';
    try {
        const d = new Date(dateStr);
        return d.toLocaleDateString('it-IT') + ' ' + d.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
    } catch (e) {
        return dateStr;
    }
}

function sanitizeFilename(name) {
    return name.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
}

function restoreProject(projectId) {
    const project = state.archivedProjects?.find(p => p.id === projectId);
    if (!project) {
        showToast('Progetto non trovato nell\'archivio', 'error');
        return;
    }

    if (confirm(`Ripristinare il progetto "${project.name}"?`)) {
        // Rimuovi metadati di archiviazione
        delete project.archivedAt;
        project.status = 'active';

        // Sposta nei progetti attivi
        state.teamProjects.push(project);

        // Rimuovi dall'archivio
        state.archivedProjects = state.archivedProjects.filter(p => p.id !== projectId);

        saveStateAndSync();
        renderArchivedProjects();
        renderTeamPage();
        showToast('Progetto ripristinato!', 'success');
    }
}

function copyProjectAsTemplate(projectId) {
    // Cerca sia nei progetti attivi che archiviati
    let project = state.teamProjects?.find(p => p.id === projectId);
    if (!project) {
        project = state.archivedProjects?.find(p => p.id === projectId);
    }

    if (!project) {
        showToast('Progetto non trovato', 'error');
        return;
    }

    const templateName = prompt('Nome del template:', `Template - ${project.name}`);
    if (!templateName) return;

    // Crea template (senza task completati, senza date specifiche)
    const template = {
        id: 'template_' + Date.now(),
        name: templateName,
        originalProjectName: project.name,
        objective: project.objective || '',
        members: project.members || [],
        // Copia struttura task ma resetta stato
        taskTemplates: (project.columns?.tasks || []).map(t => ({
            title: t.title,
            description: t.description || '',
            status: 'todo' // Tutti i task tornano "da fare"
        })),
        problemTemplates: project.columns?.problems || [],
        resourceTemplates: project.columns?.resources || [],
        createdAt: new Date().toISOString(),
        createdFrom: projectId
    };

    state.projectTemplates = state.projectTemplates || [];
    state.projectTemplates.push(template);

    saveStateAndSync();
    showToast(`Template "${templateName}" creato!`, 'success');
}

function createProjectFromTemplate(templateId) {
    const template = state.projectTemplates?.find(t => t.id === templateId);
    if (!template) {
        showToast('Template non trovato', 'error');
        return;
    }

    const projectName = prompt('Nome del nuovo progetto:', template.name.replace('Template - ', ''));
    if (!projectName) return;

    const project = {
        id: 'project_' + Date.now(),
        name: projectName,
        objective: template.objective,
        deadline: '', // L'utente imposterà la scadenza
        owner: currentUser?.username || state.cloudUser?.email || null,
        members: template.members || [],
        status: 'planning',
        columns: {
            tasks: (template.taskTemplates || []).map((t, i) => ({
                id: 'ptask_' + Date.now() + '_' + i,
                title: t.title,
                description: t.description || '',
                status: 'todo',
                assignees: [],
                comments: [],
                createdAt: new Date().toISOString()
            })),
            problems: [],
            resources: (template.resourceTemplates || []).map((r, i) => ({
                ...r,
                id: 'res_' + Date.now() + '_' + i
            }))
        },
        createdAt: new Date().toISOString(),
        createdFromTemplate: templateId
    };

    state.teamProjects.push(project);
    currentProjectId = project.id;
    saveStateAndSync();

    renderTeamPage();
    showToast(`Progetto "${projectName}" creato da template!`, 'success');
}

function deleteTemplate(templateId) {
    const template = state.projectTemplates?.find(t => t.id === templateId);
    if (!template) return;

    if (confirm(`Eliminare il template "${template.name}"?`)) {
        state.projectTemplates = state.projectTemplates.filter(t => t.id !== templateId);
        saveStateAndSync();
        renderProjectTemplates();
        showToast('Template eliminato', 'info');
    }
}

function openArchivedProjectsModal() {
    renderArchivedProjects();
    renderProjectTemplates();

    // Aggiorna contatori
    const archivedCount = document.getElementById('archivedCount');
    const templatesCount = document.getElementById('templatesCount');
    if (archivedCount) archivedCount.textContent = state.archivedProjects?.length || 0;
    if (templatesCount) templatesCount.textContent = state.projectTemplates?.length || 0;

    // Mostra tab archiviati di default
    showArchiveTab('archived');

    openModal('archivedProjectsModal');
}

function showArchiveTab(tab) {
    const archivedTab = document.getElementById('archivedTab');
    const templatesTab = document.getElementById('templatesTab');
    const tabArchived = document.getElementById('tabArchived');
    const tabTemplates = document.getElementById('tabTemplates');

    if (tab === 'archived') {
        archivedTab.style.display = 'block';
        templatesTab.style.display = 'none';
        tabArchived.style.background = 'var(--primary)';
        tabArchived.style.color = 'white';
        tabTemplates.style.background = 'transparent';
        tabTemplates.style.color = 'var(--text)';
    } else {
        archivedTab.style.display = 'none';
        templatesTab.style.display = 'block';
        tabTemplates.style.background = 'var(--primary)';
        tabTemplates.style.color = 'white';
        tabArchived.style.background = 'transparent';
        tabArchived.style.color = 'var(--text)';
    }
}

function renderArchivedProjects() {
    const container = document.getElementById('archivedProjectsList');
    if (!container) return;

    const archived = state.archivedProjects || [];

    if (archived.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--text-muted);">
                <div style="font-size:2rem; margin-bottom:8px;">📦</div>
                <div>Nessun progetto archiviato</div>
            </div>
        `;
        return;
    }

    container.innerHTML = archived.map(p => {
        const archivedDate = p.archivedAt ? new Date(p.archivedAt).toLocaleDateString('it-IT') : '';
        const stats = p.finalStats || {};
        return `
            <div class="archived-project-card" style="
                background:var(--bg-secondary);
                padding:12px 16px;
                border-radius:var(--radius-md);
                margin-bottom:8px;
                border-left:3px solid var(--success);
            ">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${p.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">
                            📅 Archiviato: ${archivedDate}
                            ${stats.completionRate !== undefined ? ` · ✅ ${stats.completionRate}% completato` : ''}
                        </div>
                        ${p.objective ? `<div style="font-size:0.85rem; margin-top:4px;">🎯 ${p.objective}</div>` : ''}
                    </div>
                    <div style="display:flex; gap:4px; flex-shrink:0;">
                        <button class="btn btn-ghost btn-xs" onclick="copyProjectAsTemplate('${p.id}')" title="Copia come Template">📋</button>
                        <button class="btn btn-ghost btn-xs" onclick="restoreProject('${p.id}')" title="Ripristina">🔄</button>
                        <button class="btn btn-ghost btn-xs" onclick="deleteArchivedProject('${p.id}')" title="Elimina definitivamente" style="color:var(--danger);">🗑️</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderProjectTemplates() {
    const container = document.getElementById('projectTemplatesList');
    if (!container) return;

    const templates = state.projectTemplates || [];

    if (templates.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--text-muted);">
                <div style="font-size:2rem; margin-bottom:8px;">📄</div>
                <div>Nessun template salvato</div>
                <div style="font-size:0.8rem; margin-top:4px;">Crea un template da un progetto archiviato</div>
            </div>
        `;
        return;
    }

    container.innerHTML = templates.map(t => {
        const taskCount = t.taskTemplates?.length || 0;
        return `
            <div class="template-card" style="
                background:var(--bg-secondary);
                padding:12px 16px;
                border-radius:var(--radius-md);
                margin-bottom:8px;
                border-left:3px solid var(--primary);
            ">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1;">
                        <div style="font-weight:600;">${t.name}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">
                            📋 ${taskCount} task predefiniti
                            ${t.members?.length ? ` · 👥 ${t.members.length} membri` : ''}
                        </div>
                    </div>
                    <div style="display:flex; gap:4px; flex-shrink:0;">
                        <button class="btn btn-primary btn-xs" onclick="createProjectFromTemplate('${t.id}')" title="Crea progetto da template">➕ Usa</button>
                        <button class="btn btn-ghost btn-xs" onclick="deleteTemplate('${t.id}')" title="Elimina template" style="color:var(--danger);">🗑️</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function deleteArchivedProject(projectId) {
    const project = state.archivedProjects?.find(p => p.id === projectId);
    if (!project) return;

    if (confirm(`Eliminare DEFINITIVAMENTE il progetto "${project.name}"? Questa azione non può essere annullata.`)) {
        state.archivedProjects = state.archivedProjects.filter(p => p.id !== projectId);
        saveStateAndSync();
        renderArchivedProjects();
        showToast('Progetto eliminato definitivamente', 'info');
    }
}

// Team CRUD Functions
const TEAM_MEMBER_COLORS = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#ef4444', '#14b8a6'];

function selectMemberAvatar(emoji) {
    document.getElementById('memberAvatar').value = emoji;
    // Update visual selection
    document.querySelectorAll('.member-avatar-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === emoji) {
            btn.classList.add('selected');
        }
    });
}

function saveTeamMember() {
    // I membri del team ora vengono dai Team a cui l'utente partecipa
    // Non si possono più aggiungere manualmente
    showToast('Per aggiungere membri, crea un Team e condividi il codice invito', 'info');
    closeModal('addTeamMemberModal');

    // Apri il modal per gestire i Team
    setTimeout(() => {
        showPage('settingsPage');
        // Scroll alla sezione Team
        const teamSection = document.querySelector('.settings-section:has(#myTeamsList)');
        if (teamSection) teamSection.scrollIntoView({ behavior: 'smooth' });
    }, 300);
}

// Apri modal creazione progetto con lista membri
function openAddProjectModal() {
    // Reset form
    document.getElementById('projectName').value = '';
    const objectiveEl = document.getElementById('projectObjective');
    const deadlineEl = document.getElementById('projectDeadline');
    if (objectiveEl) objectiveEl.value = '';
    if (deadlineEl) deadlineEl.value = '';

    // Popola lista membri selezionabili
    renderProjectMembersSelect('projectMembersSelect', []);

    openModal('addTeamProjectModal');
}

// Renderizza checkbox membri per selezione progetto
function renderProjectMembersSelect(containerId, selectedMembers = []) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const members = getAllTeamMembers();

    if (members.length === 0) {
        container.innerHTML = `
            <div style="color:var(--text-muted); padding:12px; text-align:center; width:100%;">
                <div style="font-size:1.5rem; margin-bottom:8px;">👥</div>
                <div>Unisciti a un Team per aggiungere membri al progetto!</div>
                <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="openTeamManagement()">Gestisci Team</button>
            </div>
        `;
        return;
    }

    container.innerHTML = members.map(m => {
        const displayName = m.name || m.username || m.id;
        const avatarChar = displayName.charAt(0).toUpperCase();
        const isSelected = selectedMembers.includes(m.id) || selectedMembers.includes(m.username);
        return `
            <label class="project-member-checkbox ${isSelected ? 'selected' : ''}" style="
                display:inline-flex;
                align-items:center;
                gap:6px;
                padding:6px 10px;
                background:${isSelected ? 'var(--primary)' : 'var(--bg-secondary)'};
                color:${isSelected ? 'white' : 'var(--text)'};
                border-radius:20px;
                cursor:pointer;
                transition:all 0.2s;
                font-size:0.85rem;
            " onclick="toggleProjectMember(this, '${m.id}')">
                <input type="checkbox" value="${m.id}" class="project-member-cb" ${isSelected ? 'checked' : ''} style="display:none;">
                <span style="
                    width:24px;
                    height:24px;
                    border-radius:50%;
                    background:${isSelected ? 'rgba(255,255,255,0.3)' : (m.color || '#6366f1')};
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    font-size:0.75rem;
                    font-weight:600;
                ">${m.avatar || avatarChar}</span>
                <span>${displayName}</span>
                ${m.teamName ? `<span style="font-size:0.7rem; opacity:0.7;">(${m.teamName})</span>` : ''}
            </label>
        `;
    }).join('');
}

function toggleProjectMember(label, memberId) {
    const checkbox = label.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
        label.style.background = 'var(--primary)';
        label.style.color = 'white';
        label.classList.add('selected');
    } else {
        label.style.background = 'var(--bg-secondary)';
        label.style.color = 'var(--text)';
        label.classList.remove('selected');
    }
}

function getSelectedProjectMembers(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return [];
    const checkboxes = container.querySelectorAll('.project-member-cb:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function saveTeamProject() {
    console.log('💾 saveTeamProject chiamato');

    const nameEl = document.getElementById('projectName');
    console.log('  - projectName element:', nameEl);

    const name = nameEl ? nameEl.value.trim() : '';
    console.log('  - name:', name);

    if (!name) {
        showToast('Inserisci un nome', 'error');
        return;
    }

    // Usa gli ID corretti del modale HTML
    const objectiveEl = document.getElementById('projectObjective');
    const deadlineEl = document.getElementById('projectDeadline');
    console.log('  - objectiveEl:', !!objectiveEl, 'deadlineEl:', !!deadlineEl);

    // Ottieni membri selezionati
    const selectedMembers = getSelectedProjectMembers('projectMembersSelect');
    console.log('  - selectedMembers:', selectedMembers);

    const project = {
        id: 'project_' + Date.now(),
        name,
        objective: objectiveEl ? objectiveEl.value : '',
        deadline: deadlineEl ? deadlineEl.value : '',
        owner: currentUser?.username || state.cloudUser?.email || null,
        members: selectedMembers, // Membri del progetto
        status: 'planning',
        columns: {
            tasks: [],
            problems: [],
            resources: []
        },
        department: 'work',
        createdAt: new Date().toISOString()
    };

    state.teamProjects = state.teamProjects || [];
    state.teamProjects.push(project);
    currentProjectId = project.id;
    saveStateAndSync();

    // Reset form
    document.getElementById('projectName').value = '';
    if (objectiveEl) objectiveEl.value = '';
    if (deadlineEl) deadlineEl.value = '';

    closeModal('addTeamProjectModal');
    renderTeamPage();
    console.log('✅ Progetto creato, currentProjectId dopo renderTeamPage:', currentProjectId);
    addXP(15);
    showToast('Progetto creato! +15 XP', 'success');
}

function openAddTeamTask(status = 'todo') {
    try {
        console.log('📋 openAddTeamTask chiamato');
        console.log('  - currentProjectId:', currentProjectId);
        console.log('  - status:', status);

        if (!currentProjectId) {
            console.warn('⚠️ currentProjectId è null in openAddTeamTask!');
            showToast('Seleziona prima un progetto', 'error');
            return;
        }
        newTeamTaskStatus = status;

        // Reset form
        const titleEl = document.getElementById('teamTaskTitle');
        const descEl = document.getElementById('teamTaskDesc');
        const deadlineInput = document.getElementById('newTeamTaskDeadline');

        console.log('  - elementi form trovati:', { titleEl: !!titleEl, descEl: !!descEl, deadlineInput: !!deadlineInput });

        if (titleEl) titleEl.value = '';
        if (descEl) descEl.value = '';
        if (deadlineInput) deadlineInput.value = '';

        // Popola gli assegnatari con checkbox
        renderNewTaskAssignees();

        console.log('  - Aprendo modal addTeamTaskModal...');
        openModal('addTeamTaskModal');
        console.log('  - Modal aperto!');
    } catch (error) {
        console.error('❌ Errore in openAddTeamTask:', error);
        showToast('Errore apertura form task: ' + error.message, 'error');
    }
}

function renderNewTaskAssignees() {
    const container = document.getElementById('newTeamTaskAssignees');
    if (!container) return;

    // Ottieni membri del progetto corrente (se specificati) o tutti i membri del team
    const project = state.teamProjects?.find(p => p.id === currentProjectId);
    let members = getAllTeamMembers();

    // Se il progetto ha membri specifici, filtra solo quelli
    if (project?.members && project.members.length > 0) {
        members = members.filter(m =>
            project.members.includes(m.id) || project.members.includes(m.username)
        );
    }

    if (members.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">Nessun membro assegnato al progetto. Modifica il progetto per aggiungere membri!</div>';
        return;
    }

    container.innerHTML = members.map(m => {
        const displayName = m.name || m.username || m.id;
        const avatarChar = displayName.charAt(0).toUpperCase();
        return `
            <label class="assignee-checkbox" onclick="toggleAssigneeSelection(this, '${m.id}')">
                <input type="checkbox" value="${m.id}" class="new-task-assignee">
                <span class="assignee-avatar-mini" style="background:${m.color || '#6366f1'}">${m.avatar || avatarChar}</span>
                <span class="assignee-name">${displayName}</span>
                ${m.teamName ? `<span style="font-size:0.7rem; opacity:0.6; margin-left:4px;">(${m.teamName})</span>` : ''}
            </label>
        `;
    }).join('');
}

function getNewTaskSelectedAssignees() {
    const checkboxes = document.querySelectorAll('.new-task-assignee:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function saveTeamTask() {
    console.log('💾 saveTeamTask chiamato');
    console.log('  - currentProjectId:', currentProjectId);

    if (!currentProjectId) {
        console.warn('⚠️ currentProjectId è null in saveTeamTask!');
        showToast('Seleziona prima un progetto', 'warning');
        return;
    }

    const title = document.getElementById('teamTaskTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    const project = getProjectById(currentProjectId);
    console.log('  - project trovato:', project ? project.name : 'NO');

    if (!project) {
        showToast('Progetto non trovato', 'error');
        return;
    }

    // Inizializza columns se non esiste
    if (!project.columns) {
        project.columns = { tasks: [], problems: [], resources: [] };
    }
    if (!project.columns.tasks) {
        project.columns.tasks = [];
    }

    // Ottieni assegnatari selezionati
    const assignees = getNewTaskSelectedAssignees();

    // Ottieni scadenza
    const deadlineInput = document.getElementById('newTeamTaskDeadline');
    const deadline = deadlineInput ? deadlineInput.value : null;

    const projectTaskId = 'ptask_' + Date.now();

    const task = {
        id: projectTaskId,
        title,
        description: document.getElementById('teamTaskDesc')?.value || '',
        assignees: assignees,
        assignee: assignees.length > 0 ? assignees[0] : null,
        deadline: deadline,
        status: newTeamTaskStatus || 'todo',
        comments: [],
        resources: [],
        problems: [],
        createdAt: new Date().toISOString(),
        linkedTaskId: null // Sarà collegato al task personale
    };

    project.columns.tasks = project.columns.tasks || [];
    project.columns.tasks.push(task);

    // NUOVO: Crea anche un task personale collegato
    const personalTaskId = 'task_' + Date.now();
    const personalTask = {
        id: personalTaskId,
        title: `📋 ${project.name}: ${title}`,
        description: `Task del progetto "${project.name}"\n\n${task.description || ''}`,
        due: deadline || '',
        priority: 'medium',
        category: 'work',
        quadrant: '1', // Urgente e importante
        estimate: 60,
        isTop3: false,
        top3: false,
        department: 'work',
        recurrence: 'none',
        subtasks: [],
        dependsOn: [],
        actualTime: 0,
        completed: false,
        status: newTeamTaskStatus === 'done' ? 'done' : 'todo',
        createdAt: new Date().toISOString(),
        // Link bidirezionale
        linkedProjectTaskId: projectTaskId,
        linkedProjectId: currentProjectId
    };

    // Collega i due task
    task.linkedTaskId = personalTaskId;

    state.tasks.push(personalTask);

    // Log attività nella bacheca del progetto
    logProjectActivity(project, 'task_created', { taskTitle: title, taskId: projectTaskId });

    saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso

    // Log attivita per KPI
    logAttivita('task_creato', 'tasks', projectTaskId, { progetto: project.name });

    // Reset form
    document.getElementById('teamTaskTitle').value = '';
    document.getElementById('teamTaskDesc').value = '';
    if (deadlineInput) deadlineInput.value = '';
    newTeamTaskStatus = 'todo';

    closeModal('addTeamTaskModal');
    renderTeamProject();
    renderTasksPage();
    addXP(5);
    showToast('Task aggiunto al progetto e ai tuoi Task! +5 XP', 'success');
}

function saveTeamProblem() {
    if (!currentProjectId) return;

    const title = document.getElementById('problemTitle').value.trim();
    if (!title) {
        showToast('Descrivi il problema', 'error');
        return;
    }

    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Inizializza columns se non esiste
    if (!project.columns) {
        project.columns = { tasks: [], problems: [], resources: [] };
    }

    const problem = {
        id: 'prob_' + Date.now(),
        title,
        priority: document.getElementById('problemPriority').value,
        linkedTask: null,
        status: 'open'
    };

    project.columns.problems = project.columns.problems || [];
    project.columns.problems.push(problem);

    // Log attività nella bacheca del progetto
    logProjectActivity(project, 'problem_added', { problemTitle: title, problemId: problem.id });

    saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso

    document.getElementById('problemTitle').value = '';

    closeModal('addTeamProblemModal');
    renderTeamProject();
    showToast('Problema registrato', 'info');
}

function saveTeamResource() {
    if (!currentProjectId) return;

    const title = document.getElementById('resourceTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Inizializza columns se non esiste
    if (!project.columns) {
        project.columns = { tasks: [], problems: [], resources: [] };
    }

    // Normalizza URL aggiungendo https:// se manca
    let url = document.getElementById('resourceUrl').value.trim();
    if (url && !url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('mailto:') && !url.startsWith('tel:')) {
        // Se sembra un URL (contiene un punto), aggiungi https://
        if (url.includes('.')) {
            url = 'https://' + url;
        }
    }

    const resource = {
        id: 'res_' + Date.now(),
        title,
        type: document.getElementById('resourceType').value,
        url: url
    };

    project.columns.resources = project.columns.resources || [];
    project.columns.resources.push(resource);

    // Log attività nella bacheca del progetto
    logProjectActivity(project, 'resource_added', { resourceTitle: title, resourceId: resource.id });

    saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso

    document.getElementById('resourceTitle').value = '';
    document.getElementById('resourceUrl').value = '';

    closeModal('addTeamResourceModal');
    renderTeamProject();
    showToast('Risorsa aggiunta!', 'success');
}

function moveTask(taskId, direction) {
    const project = getProjectById(currentProjectId);
    if (!project || !project.columns || !project.columns.tasks) return;

    const task = project.columns.tasks.find(t => t.id === taskId);
    if (!task) return;

    const statusOrder = ['todo', 'doing', 'done'];
    const currentIndex = statusOrder.indexOf(task.status);
    const newIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;

    if (newIndex >= 0 && newIndex < statusOrder.length) {
        const oldStatus = task.status;
        task.status = statusOrder[newIndex];

        // SYNC: Aggiorna anche il task personale collegato
        syncProjectTaskToPersonal(task);

        // Log attività nella bacheca del progetto
        if (task.status === 'done') {
            logProjectActivity(project, 'task_completed', { taskTitle: task.title, taskId: task.id });
        } else {
            logProjectActivity(project, 'task_moved', { taskTitle: task.title, taskId: task.id, oldStatus, newStatus: task.status });
        }

        saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso
        renderTeamProject();
        renderTasksPage();

        if (task.status === 'done') {
            addXP(10);
            showToast('Task completato! +10 XP', 'success');
        }
    }
}

// Sincronizza stato task progetto → task personale
function syncProjectTaskToPersonal(projectTask) {
    if (!projectTask.linkedTaskId) return;

    const personalTask = state.tasks.find(t => t.id === projectTask.linkedTaskId);
    if (!personalTask) return;

    // Aggiorna stato
    personalTask.status = projectTask.status;
    personalTask.completed = projectTask.status === 'done';

    // Aggiorna scadenza se cambiata
    if (projectTask.deadline) {
        personalTask.due = projectTask.deadline;
    }

    console.log('🔄 Sync progetto → personale:', projectTask.title);
}

// Sincronizza stato task personale → task progetto
function syncPersonalTaskToProject(personalTask) {
    if (!personalTask.linkedProjectTaskId || !personalTask.linkedProjectId) return;

    const project = state.teamProjects.find(p => p.id === personalTask.linkedProjectId);
    if (!project || !project.columns || !project.columns.tasks) return;

    const projectTask = project.columns.tasks.find(t => t.id === personalTask.linkedProjectTaskId);
    if (!projectTask) return;

    // Aggiorna stato
    if (personalTask.completed || personalTask.status === 'done') {
        projectTask.status = 'done';
    } else if (personalTask.status === 'doing' || personalTask.status === 'in_progress') {
        projectTask.status = 'doing';
    } else {
        projectTask.status = 'todo';
    }

    console.log('🔄 Sync personale → progetto:', personalTask.title);
}

function deleteTeamTask(taskId) {
    const project = getProjectById(currentProjectId);
    if (!project || !project.columns || !project.columns.tasks) return;

    // Trova il task prima di eliminarlo per ottenere il linkedTaskId
    const taskToDelete = project.columns.tasks.find(t => t.id === taskId);

    // Log attività nella bacheca del progetto PRIMA di eliminare
    if (taskToDelete) {
        logProjectActivity(project, 'task_deleted', { taskTitle: taskToDelete.title, taskId: taskId });
    }

    // Elimina anche il task personale collegato
    if (taskToDelete && taskToDelete.linkedTaskId) {
        state.tasks = state.tasks.filter(t => t.id !== taskToDelete.linkedTaskId);
    }

    project.columns.tasks = project.columns.tasks.filter(t => t.id !== taskId);
    saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso
    renderTeamProject();
    renderTasksPage();
}

// ========== EDIT TEAM TASK & COMMENTS ==========

async function openEditTeamTask(taskId) {
    console.log('🔧 openEditTeamTask chiamato');
    console.log('  - taskId:', taskId);
    console.log('  - currentProjectId:', currentProjectId);

    const project = getProjectById(currentProjectId);
    console.log('  - project trovato:', project ? project.name : 'NO');

    if (!project) {
        showToast('Seleziona prima un progetto', 'warning');
        return;
    }

    const task = project.columns?.tasks?.find(t => t.id === taskId);
    console.log('  - task trovato:', task ? task.title : 'NO');

    if (!task) {
        showToast('Task non trovato', 'error');
        return;
    }

    currentEditingTeamTaskId = taskId;

    // Popola i campi del modale IMMEDIATAMENTE
    document.getElementById('editTeamTaskId').value = taskId;
    document.getElementById('editTeamTaskTitle').value = task.title || '';
    document.getElementById('editTeamTaskDesc').value = task.description || '';
    document.getElementById('editTeamTaskStatus').value = task.status || 'todo';

    // Popola la scadenza
    const deadlineInput = document.getElementById('editTeamTaskDeadline');
    if (deadlineInput) {
        deadlineInput.value = task.deadline || '';
    }

    // Popola gli assegnatari multipli con checkbox
    renderAssigneesChecklist(task);

    // ========== FAST OPEN: Mostra modale SUBITO con dati locali ==========
    renderTeamTaskComments(task);
    openModal('editTeamTaskModal');

    // ========== BACKGROUND: Sincronizza commenti dal cloud ==========
    if (state.cloudUser?.token) {
        // Prima controlla la cache
        const cached = dataCache.comments.get(taskId);
        if (isCacheValid(cached)) {
            console.log('📦 Usando commenti dalla cache');
            mergeCloudComments(task, cached.data);
            renderTeamTaskComments(task);
        } else {
            // Fetch in background (non blocca)
            getCachedComments(taskId).then(commenti => {
                if (commenti && commenti.length > 0) {
                    mergeCloudComments(task, commenti);
                    // Aggiorna la vista solo se il modale è ancora aperto per questo task
                    if (currentEditingTeamTaskId === taskId) {
                        renderTeamTaskComments(task);
                    }
                }
            }).catch(e => {
                console.warn('⚠️ Errore caricamento commenti cloud:', e);
            });
        }
    }

    // Avvia polling per aggiornamenti commenti in tempo reale
    startCommentsPolling(taskId);
}

// Helper per merge commenti cloud
function mergeCloudComments(task, commentiCloud) {
    if (!commentiCloud || commentiCloud.length === 0) return;

    const formattedComments = commentiCloud.map(c => ({
        id: c.id,
        text: c.contenuto,
        author: c.username,
        createdAt: c.data_creazione
    }));

    // Merge: usa cloud come base, aggiungi locali non presenti
    const idsCloud = new Set(formattedComments.map(c => c.id));
    const commentiLocali = (task.comments || []).filter(c => !idsCloud.has(c.id));
    task.comments = [...formattedComments, ...commentiLocali];

    console.log('✅ Commenti task sincronizzati dal cloud:', task.comments.length);
}

// Avvia il polling per nuovi commenti (ogni 10 secondi)
function startCommentsPolling(taskId) {
    stopCommentsPolling(); // Ferma eventuale polling precedente

    commentsPollingInterval = setInterval(async () => {
        // Verifica che il modale sia ancora aperto
        const modal = document.getElementById('editTeamTaskModal');
        if (!modal || !modal.classList.contains('active')) {
            stopCommentsPolling();
            return;
        }

        await refreshTaskComments(taskId);
    }, 10000); // Ogni 10 secondi

    console.log('🔄 Polling commenti avviato per task:', taskId);
}

// Ferma il polling dei commenti
function stopCommentsPolling() {
    if (commentsPollingInterval) {
        clearInterval(commentsPollingInterval);
        commentsPollingInterval = null;
        console.log('⏹️ Polling commenti fermato');
    }
}

// Ricarica i commenti dal cloud senza ricaricare tutto il modale
async function refreshTaskComments(taskId) {
    if (!state.cloudUser?.token || !taskId) return;

    const project = getProjectById(currentProjectId);
    if (!project) return;

    const task = findTaskInProject(project, taskId);
    if (!task) return;

    try {
        // Carica commenti dal backend condiviso (dal progetto)
        const result = await apiCall('loadSharedProject', {
            email: state.cloudUser.email,
            projectId: currentProjectId.replace('shared_', '')
        });

        if (result.success && result.project?.data?.columns?.tasks) {
            // Trova il task aggiornato
            const updatedTask = result.project.data.columns.tasks.find(t => t.id === taskId);
            if (updatedTask && updatedTask.comments) {
                const oldCount = task.comments?.length || 0;
                const newCount = updatedTask.comments.length;

                // Aggiorna i commenti locali
                task.comments = updatedTask.comments;

                // Se ci sono nuovi commenti, aggiorna la vista
                if (newCount > oldCount) {
                    renderTeamTaskComments(task);
                    console.log('📨 Nuovi commenti ricevuti:', newCount - oldCount);
                }
            }
        }

        // Carica anche dal foglio TaskComments
        const commentiResult = await apiCall('ottieniCommentiTask', { task_id: taskId });
        if (commentiResult.success && commentiResult.commenti?.length > 0) {
            const commentiCloud = commentiResult.commenti.map(c => ({
                id: c.id,
                text: c.contenuto,
                author: c.username,
                createdAt: c.data_creazione
            }));

            // Merge commenti
            const existingIds = new Set((task.comments || []).map(c => c.id));
            const newComments = commentiCloud.filter(c => !existingIds.has(c.id));

            if (newComments.length > 0) {
                task.comments = [...(task.comments || []), ...newComments];
                renderTeamTaskComments(task);
                console.log('📨 Nuovi commenti dal foglio TaskComments:', newComments.length);
            }
        }
    } catch (e) {
        console.warn('⚠️ Errore refresh commenti:', e);
    }
}

// Refresh manuale commenti (bottone)
async function manualRefreshComments() {
    if (!currentEditingTeamTaskId) return;

    const statusEl = document.getElementById('commentsRefreshStatus');
    if (statusEl) statusEl.textContent = '...';

    await refreshTaskComments(currentEditingTeamTaskId);

    if (statusEl) {
        statusEl.textContent = '✓';
        setTimeout(() => { statusEl.textContent = ''; }, 2000);
    }

    showToast('Commenti aggiornati', 'success');
}

function renderAssigneesChecklist(task) {
    const container = document.getElementById('editTeamTaskAssignees');
    if (!container) {
        console.warn('⚠️ Container editTeamTaskAssignees non trovato');
        return;
    }

    // Ottieni membri del progetto corrente (sia proprio che condiviso)
    const project = getProjectById(currentProjectId);
    let members = getAllTeamMembers();

    // Se il progetto ha membri specifici, filtra solo quelli
    if (project?.members && project.members.length > 0) {
        members = members.filter(m =>
            project.members.includes(m.id) || project.members.includes(m.username)
        );
    }

    console.log('👥 renderAssigneesChecklist - membri progetto:', members.length);

    // Supporta sia il vecchio formato (singolo assignee) che il nuovo (array assignees)
    const currentAssignees = task.assignees || (task.assignee ? [task.assignee] : []);

    if (members.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">Nessun membro assegnato al progetto. Modifica il progetto per aggiungere membri!</div>';
        return;
    }

    container.innerHTML = members.map(m => {
        const isSelected = currentAssignees.includes(m.id);
        const displayName = m.name || m.username || m.id;
        const avatarChar = displayName.charAt(0).toUpperCase();
        return `
            <label class="assignee-checkbox ${isSelected ? 'selected' : ''}" onclick="toggleAssigneeSelection(this, '${m.id}')">
                <input type="checkbox" value="${m.id}" ${isSelected ? 'checked' : ''}>
                <span class="assignee-avatar-mini" style="background:${m.color || '#6366f1'}">${m.avatar || avatarChar}</span>
                <span class="assignee-name">${displayName}</span>
                ${m.teamName ? `<span style="font-size:0.7rem; opacity:0.6; margin-left:4px;">(${m.teamName})</span>` : ''}
            </label>
        `;
    }).join('');
}

function toggleAssigneeSelection(label, memberId) {
    const checkbox = label.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    label.classList.toggle('selected', checkbox.checked);
}

function getSelectedAssignees() {
    const container = document.getElementById('editTeamTaskAssignees');
    if (!container) return [];

    const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function renderTeamTaskComments(task) {
    const container = document.getElementById('teamTaskComments');
    const comments = task.comments || [];

    if (comments.length === 0) {
        container.innerHTML = '<div class="no-comments">Nessun commento ancora. Sii il primo! Usa @nome per menzionare qualcuno.</div>';
        return;
    }

    // Ordina commenti dal più vecchio al più nuovo (cronologico)
    const sortedComments = [...comments].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateA - dateB; // Ascendente: più vecchi prima
    });

    // Crea una mappa per trovare l'indice originale (per il delete)
    const originalIndexMap = new Map();
    comments.forEach((c, idx) => originalIndexMap.set(c.id, idx));

    container.innerHTML = sortedComments.map((c) => {
        const originalIndex = originalIndexMap.get(c.id) ?? comments.indexOf(c);
        return `
            <div class="task-comment">
                <div class="task-comment-header">
                    <span class="task-comment-author">${c.author || 'Anonimo'}</span>
                    <span class="task-comment-date">${formatCommentDate(c.createdAt)}</span>
                </div>
                <div class="task-comment-text">${formatCommentWithMentions(c.text)}</div>
                <div class="task-comment-actions">
                    <button class="btn btn-ghost btn-xs" onclick="deleteTeamTaskComment(${originalIndex})">🗑️</button>
                </div>
            </div>
        `;
    }).join('');

    // Scrolla in basso per vedere gli ultimi commenti (i più recenti)
    container.scrollTop = container.scrollHeight;
}

// Formatta il testo del commento con menzioni @ evidenziate
function formatCommentWithMentions(text) {
    if (!text) return '';

    // Escape HTML prima
    const escaped = escapeHtml(text);

    // Trova e sostituisci le menzioni @username con stile evidenziato
    return escaped.replace(/@(\w+)/g, '<span class="mention-tag">@$1</span>');
}

function formatCommentDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;

    // Meno di 1 minuto
    if (diff < 60000) return 'Adesso';
    // Meno di 1 ora
    if (diff < 3600000) return Math.floor(diff / 60000) + ' min fa';
    // Meno di 24 ore
    if (diff < 86400000) return Math.floor(diff / 3600000) + ' ore fa';
    // Altrimenti mostra la data
    return date.toLocaleDateString('it-IT', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addTeamTaskComment() {
    const input = document.getElementById('newTeamTaskComment');
    const text = input.value.trim();
    if (!text) return;

    const project = getProjectById(currentProjectId);
    if (!project) return;

    const task = findTaskInProject(project, currentEditingTeamTaskId);
    if (!task) return;

    // Inizializza array commenti se non esiste
    task.comments = task.comments || [];

    const authorName = currentUser?.nickname || state.cloudUser?.username || currentUser?.username || state.profile?.name || 'Tu';
    const taskId = task.id;

    // Crea il commento
    const comment = {
        id: 'comment_' + Date.now(),
        text: text,
        author: authorName,
        createdAt: new Date().toISOString()
    };

    // ========== OPTIMISTIC UI: Aggiorna SUBITO l'interfaccia ==========
    task.comments.push(comment);
    input.value = '';
    renderTeamTaskComments(task);
    showToast('Commento aggiunto!', 'success');

    // Invalida la cache
    invalidateTaskCache(taskId);

    // Rileva menzioni @ per notifiche
    const mentions = extractMentions(text);

    // ========== BACKGROUND SYNC: Sincronizza in background ==========
    queueBackgroundOperation(async () => {
        // Log attività
        logProjectActivity(project, 'comment_added', { taskTitle: task.title, taskId: taskId, commentPreview: text.substring(0, 50) });

        // Invia notifiche menzioni
        if (mentions.length > 0) {
            sendMentionNotifications(mentions, task, project, authorName);
            mentions.forEach(mention => {
                logProjectActivity(project, 'mention', { taskTitle: task.title, taskId: taskId, mentionedUser: mention });
            });
        }

        // Sincronizza commento con il cloud
        if (state.cloudUser?.token) {
            try {
                await apiCall('salvaCommentoTask', {
                    task_id: taskId,
                    contenuto: text,
                    id: comment.id
                });
                console.log('✅ Commento task sincronizzato con il cloud');
            } catch (e) {
                console.warn('⚠️ Errore sync commento task:', e);
            }
        }

        // Sincronizza progetto condiviso
        await syncSharedProject(project);
    });

    // Salva stato locale (debounced)
    saveStateAndSync();
}

// Trova un task in qualsiasi colonna del progetto
function findTaskInProject(project, taskId) {
    if (!project || !taskId) return null;

    // Prima cerca nell'array principale tasks (usato dalla maggior parte delle funzioni)
    if (project.columns?.tasks) {
        const task = project.columns.tasks.find(t => t.id === taskId);
        if (task) return task;
    }

    // Fallback: cerca anche nelle colonne legacy se esistono
    if (project.columns) {
        for (const status of ['todo', 'doing', 'done', 'progress']) {
            const tasks = project.columns[status];
            if (Array.isArray(tasks)) {
                const task = tasks.find(t => t.id === taskId);
                if (task) return task;
            }
        }
    }

    return null;
}

// Estrae le menzioni @username dal testo
function extractMentions(text) {
    const matches = text.match(/@(\w+)/g);
    if (!matches) return [];

    // Rimuovi duplicati e @ prefix
    return [...new Set(matches.map(m => m.substring(1).toLowerCase()))];
}

// Invia notifiche agli utenti menzionati
async function sendMentionNotifications(mentions, task, project, authorName) {
    if (!state.cloudUser?.token) return;

    // Ottieni membri del progetto e dei team
    const allMembers = getAllTeamMembers();
    const projectMembers = project.members || [];
    const collaborators = project.collaborators || [];

    // Trova gli utenti menzionati
    for (const mention of mentions) {
        // Cerca tra i membri del team
        let mentionedUser = allMembers.find(m =>
            m.username?.toLowerCase() === mention ||
            m.nickname?.toLowerCase() === mention ||
            m.name?.toLowerCase() === mention
        );

        // Cerca anche tra i collaboratori
        if (!mentionedUser) {
            mentionedUser = collaborators.find(c =>
                c.nickname?.toLowerCase() === mention ||
                c.email?.toLowerCase().split('@')[0] === mention
            );
        }

        if (mentionedUser && mentionedUser.email) {
            // Non notificare se stesso
            if (mentionedUser.email.toLowerCase() === state.cloudUser.email?.toLowerCase()) continue;

            try {
                await apiCall('sendMentionNotification', {
                    toEmail: mentionedUser.email,
                    fromUsername: authorName,
                    taskTitle: task.title,
                    projectName: project.name,
                    projectId: project.id,
                    taskId: task.id
                });
                console.log(`📧 Notifica inviata a @${mention}`);
            } catch (error) {
                console.error('Errore invio notifica menzione:', error);
            }
        }
    }
}

// ========== AUTOCOMPLETE MENZIONI @ ==========
// Nota: mentionSearchStart e selectedMentionIndex sono definiti all'inizio del file

function handleCommentInput(event) {
    const input = event.target;
    const value = input.value;
    const cursorPos = input.selectionStart;

    // Cerca l'ultima @ prima del cursore
    const textBeforeCursor = value.substring(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');

    if (lastAtIndex === -1) {
        hideMentionAutocomplete();
        return;
    }

    // Controlla che non ci siano spazi dopo @
    const searchText = textBeforeCursor.substring(lastAtIndex + 1);
    if (searchText.includes(' ')) {
        hideMentionAutocomplete();
        return;
    }

    mentionSearchStart = lastAtIndex;
    showMentionAutocomplete(searchText);
}

function handleCommentKeydown(event) {
    const autocomplete = document.getElementById('mentionAutocomplete');
    if (!autocomplete.classList.contains('show')) {
        if (event.key === 'Enter') {
            event.preventDefault();
            addTeamTaskComment();
        }
        return;
    }

    const options = autocomplete.querySelectorAll('.mention-option');

    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            selectedMentionIndex = Math.min(selectedMentionIndex + 1, options.length - 1);
            updateMentionSelection(options);
            break;
        case 'ArrowUp':
            event.preventDefault();
            selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
            updateMentionSelection(options);
            break;
        case 'Enter':
        case 'Tab':
            event.preventDefault();
            if (options[selectedMentionIndex]) {
                selectMention(options[selectedMentionIndex].dataset.username);
            }
            break;
        case 'Escape':
            hideMentionAutocomplete();
            break;
    }
}

function showMentionAutocomplete(searchText) {
    const autocomplete = document.getElementById('mentionAutocomplete');
    if (!autocomplete) {
        console.warn('⚠️ mentionAutocomplete element non trovato');
        return;
    }

    // Usa getProjectById per trovare sia progetti propri che condivisi
    const project = getProjectById(currentProjectId);
    console.log('🔍 showMentionAutocomplete - progetto:', project?.name, 'searchText:', searchText);

    // Raccogli tutti i possibili utenti da menzionare
    const mentionables = getMentionableUsers(project);

    // Filtra per testo di ricerca (se vuoto mostra tutti)
    const filtered = mentionables.filter(u =>
        searchText === '' ||
        u.username.toLowerCase().includes(searchText.toLowerCase()) ||
        u.name.toLowerCase().includes(searchText.toLowerCase())
    ).slice(0, 6);

    console.log('🔍 showMentionAutocomplete - filtrati:', filtered.length);

    if (filtered.length === 0) {
        // Mostra messaggio "nessun utente trovato" invece di nascondere
        autocomplete.innerHTML = `
            <div style="padding:12px; text-align:center; color:var(--text-muted); font-size:0.85rem;">
                ${mentionables.length === 0 ?
                    '👥 Nessun membro nel team.<br>Aggiungi collaboratori al progetto.' :
                    '🔍 Nessun utente trovato per "' + searchText + '"'}
            </div>
        `;
        autocomplete.classList.add('show');
        return;
    }

    selectedMentionIndex = 0;

    autocomplete.innerHTML = filtered.map((u, i) => `
        <div class="mention-option ${i === 0 ? 'selected' : ''}"
             data-username="${u.username}"
             data-index="${i}"
             onmousedown="event.preventDefault(); selectMention('${u.username}');"
             onmouseenter="selectedMentionIndex = ${i}; updateTaskMentionHighlight();">
            <div class="mention-option-avatar" style="background:${u.color || '#6366f1'}">
                ${(u.name || u.username).charAt(0).toUpperCase()}
            </div>
            <div>
                <div class="mention-option-name">${u.name || u.username}</div>
                ${u.email ? `<div class="mention-option-email">${u.email}</div>` : ''}
            </div>
        </div>
    `).join('');

    autocomplete.classList.add('show');
}

// Helper per aggiornare highlight senza re-render
function updateTaskMentionHighlight() {
    const autocomplete = document.getElementById('mentionAutocomplete');
    if (!autocomplete) return;

    const options = autocomplete.querySelectorAll('.mention-option');
    options.forEach((opt, i) => {
        opt.classList.toggle('selected', i === selectedMentionIndex);
    });
}

function hideMentionAutocomplete() {
    const autocomplete = document.getElementById('mentionAutocomplete');
    if (autocomplete) {
        autocomplete.classList.remove('show');
    }
    mentionSearchStart = -1;
}

function updateMentionSelection(options) {
    options.forEach((opt, i) => {
        opt.classList.toggle('selected', i === selectedMentionIndex);
    });
}

function selectMention(username) {
    const input = document.getElementById('newTeamTaskComment');
    if (!input) {
        console.warn('⚠️ selectMention: input non trovato');
        return;
    }

    const value = input.value;

    // Sostituisci dalla @ fino al cursore con @username
    const before = value.substring(0, mentionSearchStart);
    const after = value.substring(input.selectionStart);

    input.value = before + '@' + username + ' ' + after;

    // Nascondi prima l'autocomplete
    hideMentionAutocomplete();

    // Posiziona cursore dopo la menzione con setTimeout per garantire il focus
    const newPos = mentionSearchStart + username.length + 2;
    setTimeout(() => {
        input.focus();
        input.setSelectionRange(newPos, newPos);
    }, 10);

    console.log('✅ Menzione inserita:', '@' + username);
}

function getMentionableUsers(project) {
    const users = new Map();
    const myEmail = state.cloudUser?.email?.toLowerCase();

    // Aggiungi membri del team
    const members = getAllTeamMembers();
    console.log('🔍 getMentionableUsers - membri team:', members.length);

    members.forEach(m => {
        const memberEmail = m.email?.toLowerCase();
        if (memberEmail && memberEmail !== myEmail) {
            users.set(memberEmail, {
                username: m.username || m.nickname || m.name || memberEmail.split('@')[0],
                name: m.name || m.nickname || m.username || memberEmail.split('@')[0],
                email: m.email,
                color: m.color || '#6366f1'
            });
        }
    });

    // Aggiungi collaboratori del progetto
    if (project?.collaborators) {
        console.log('🔍 getMentionableUsers - collaboratori progetto:', project.collaborators.length);
        project.collaborators.forEach(c => {
            const collabEmail = c.email?.toLowerCase();
            if (collabEmail && collabEmail !== myEmail && !users.has(collabEmail)) {
                users.set(collabEmail, {
                    username: c.nickname || c.email.split('@')[0],
                    name: c.nickname || c.name || c.email.split('@')[0],
                    email: c.email,
                    color: '#8b5cf6'
                });
            }
        });
    }

    // Aggiungi membri assegnati al progetto (da project.members)
    if (project?.members) {
        project.members.forEach(memberId => {
            const member = members.find(m => m.id === memberId || m.username === memberId);
            if (member && member.email?.toLowerCase() !== myEmail && !users.has(member.email?.toLowerCase())) {
                users.set(member.email?.toLowerCase(), {
                    username: member.username || member.nickname || member.name,
                    name: member.name || member.nickname || member.username,
                    email: member.email,
                    color: member.color || '#10b981'
                });
            }
        });
    }

    // Se è un progetto condiviso, aggiungi anche il proprietario
    if (project?.ownerEmail && project.ownerEmail.toLowerCase() !== myEmail) {
        const ownerEmail = project.ownerEmail.toLowerCase();
        if (!users.has(ownerEmail)) {
            users.set(ownerEmail, {
                username: project.ownerUsername || ownerEmail.split('@')[0],
                name: project.ownerUsername || ownerEmail.split('@')[0],
                email: project.ownerEmail,
                color: '#f59e0b'
            });
        }
    }

    // Se non ci sono utenti, prova a cercare nei progetti condivisi
    if (users.size === 0 && state.sharedProjects) {
        const sharedProject = state.sharedProjects.find(sp =>
            sp.id === currentProjectId?.replace('shared_', '')
        );
        if (sharedProject?.ownerEmail && sharedProject.ownerEmail.toLowerCase() !== myEmail) {
            users.set(sharedProject.ownerEmail.toLowerCase(), {
                username: sharedProject.ownerUsername || sharedProject.ownerEmail.split('@')[0],
                name: sharedProject.ownerUsername || sharedProject.ownerEmail.split('@')[0],
                email: sharedProject.ownerEmail,
                color: '#f59e0b'
            });
        }
    }

    console.log('🔍 getMentionableUsers - totale utenti menzionabili:', users.size);

    return Array.from(users.values());
}

function deleteTeamTaskComment(commentIndex) {
    const project = getProjectById(currentProjectId);
    if (!project || !project.columns || !project.columns.tasks) return;

    const task = project.columns.tasks.find(t => t.id === currentEditingTeamTaskId);
    if (!task || !task.comments) return;

    // Ottieni l'ID del commento prima di eliminarlo
    const commentToDelete = task.comments[commentIndex];
    const commentId = commentToDelete?.id;
    const taskId = task.id;

    console.log('🗑️ Eliminando commento:', commentId, 'index:', commentIndex);

    // ========== OPTIMISTIC UI: Aggiorna SUBITO l'interfaccia ==========
    task.comments.splice(commentIndex, 1);
    renderTeamTaskComments(task);
    showToast('Commento eliminato', 'success');

    // Invalida la cache per questo task
    invalidateTaskCache(taskId);

    // ========== BACKGROUND SYNC: Sincronizza in background ==========
    queueBackgroundOperation(async () => {
        // Log attività
        logProjectActivity(project, 'comment_deleted', { taskTitle: task.title, taskId: taskId });

        // Elimina dal backend cloud
        if (state.cloudUser?.token && commentId) {
            try {
                const result = await apiCall('eliminaCommentoTask', {
                    task_id: taskId,
                    comment_id: commentId
                });
                if (result.success) {
                    console.log('✅ Commento eliminato dal cloud');
                } else {
                    console.warn('⚠️ Errore eliminazione commento dal cloud:', result.message);
                }
            } catch (e) {
                console.error('❌ Errore chiamata eliminaCommentoTask:', e);
            }
        }

        // Sincronizza progetto condiviso
        await syncSharedProject(project);
    });

    // Salva stato locale (debounced)
    saveStateAndSync();
}

function updateTeamTask() {
    const project = getProjectById(currentProjectId);
    if (!project || !project.columns || !project.columns.tasks) return;

    const task = project.columns.tasks.find(t => t.id === currentEditingTeamTaskId);
    if (!task) return;

    const title = document.getElementById('editTeamTaskTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    // Aggiorna i campi
    const oldStatus = task.status;
    task.title = title;
    task.description = document.getElementById('editTeamTaskDesc').value;
    task.status = document.getElementById('editTeamTaskStatus').value;

    // Scadenza task
    const deadlineInput = document.getElementById('editTeamTaskDeadline');
    task.deadline = deadlineInput ? deadlineInput.value : null;

    // Assegnatari multipli (nuovo formato)
    task.assignees = getSelectedAssignees();

    // Mantieni compatibilità con vecchio formato (singolo assignee)
    task.assignee = task.assignees.length > 0 ? task.assignees[0] : null;

    task.updatedAt = new Date().toISOString();

    // SYNC: Aggiorna anche il task personale collegato
    syncProjectTaskToPersonal(task);

    // Aggiorna anche titolo/descrizione del task personale
    if (task.linkedTaskId) {
        const personalTask = state.tasks.find(t => t.id === task.linkedTaskId);
        if (personalTask) {
            personalTask.title = `📋 ${project.name}: ${title}`;
            personalTask.description = `Task del progetto "${project.name}"\n\n${task.description || ''}`;
            personalTask.due = task.deadline || '';
        }
    }

    // Log attività nella bacheca del progetto
    if (task.status === 'done' && oldStatus !== 'done') {
        logProjectActivity(project, 'task_completed', { taskTitle: task.title, taskId: task.id });
    } else {
        logProjectActivity(project, 'task_updated', { taskTitle: task.title, taskId: task.id });
    }

    saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso
    closeModal('editTeamTaskModal');
    renderTeamProject();
    renderTasksPage();

    // XP se completato
    if (task.status === 'done' && oldStatus !== 'done') {
        addXP(10);
        showToast('Task aggiornato e completato! +10 XP', 'success');
    } else {
        showToast('Task aggiornato!', 'success');
    }
}

function deleteCurrentTeamTask() {
    if (!currentEditingTeamTaskId) return;

    if (confirm('Sei sicuro di voler eliminare questo task?')) {
        deleteTeamTask(currentEditingTeamTaskId);
        closeModal('editTeamTaskModal');
        currentEditingTeamTaskId = null;
    }
}

// ========== END EDIT TEAM TASK ==========

// ========== PROJECT SHARING SYSTEM ==========

function openShareProject() {
    if (!currentProjectId) {
        showToast('Seleziona prima un progetto', 'error');
        return;
    }

    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Popola info progetto
    document.getElementById('shareProjectId').value = currentProjectId;
    document.getElementById('shareProjectName').textContent = project.name;
    document.getElementById('shareProjectOwner').textContent = state.cloudUser?.email || 'Tu';

    // Renderizza lista collaboratori
    renderProjectCollaborators(project);

    // Reset ricerca utenti
    document.getElementById('userSearchInput').value = '';
    document.getElementById('userSearchResults').style.display = 'none';
    clearSelectedUser();

    // Popola selezione rapida membri team
    renderTeamMembersQuickSelect(project);

    // Reset permessi
    document.getElementById('sharePermission').value = 'editor';

    // Nascondi status
    document.getElementById('sharingStatus').style.display = 'none';

    openModal('shareProjectModal');
}

// Popola il selettore dei membri del team per condivisione progetto
function renderShareMemberOptions(project) {
    const select = document.getElementById('shareTeamMemberSelect');
    if (!select) return;

    const members = getAllTeamMembers();
    const currentCollaborators = (project.collaborators || []).map(c => c.email?.toLowerCase());
    const myEmail = state.cloudUser?.email?.toLowerCase();

    // Filtra: escludi me stesso e chi è già collaboratore
    const availableMembers = members.filter(m => {
        const memberEmail = (m.email || '').toLowerCase();
        const memberUsername = (m.username || '').toLowerCase();
        return memberEmail !== myEmail &&
               memberUsername !== myEmail &&
               !currentCollaborators.includes(memberEmail) &&
               !currentCollaborators.includes(memberUsername);
    });

    if (availableMembers.length === 0) {
        select.innerHTML = '<option value="">Nessun membro disponibile</option>';
        return;
    }

    select.innerHTML = '<option value="">Seleziona un membro...</option>' +
        availableMembers.map(m => {
            const displayName = m.name || m.username || m.email;
            const email = m.email || m.username;
            const teamInfo = m.teamName ? ` (${m.teamName})` : '';
            return `<option value="${email}" data-name="${displayName}">${displayName}${teamInfo}</option>`;
        }).join('');
}

// Aggiungi collaboratore selezionato dal dropdown team
function addProjectCollaboratorFromTeam() {
    const select = document.getElementById('shareTeamMemberSelect');
    const email = select.value;
    const permission = document.getElementById('sharePermission').value;

    if (!email) {
        showToast('Seleziona un membro del team', 'warning');
        return;
    }

    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Inizializza array collaboratori se non esiste
    if (!project.collaborators) {
        project.collaborators = [];
    }

    // Verifica duplicati
    if (project.collaborators.find(c => c.email?.toLowerCase() === email.toLowerCase())) {
        showToast('Questo membro è già un collaboratore', 'warning');
        return;
    }

    // Ottieni nome dal data-attribute
    const selectedOption = select.options[select.selectedIndex];
    const name = selectedOption.getAttribute('data-name') || email;

    // Aggiungi collaboratore
    project.collaborators.push({
        email: email,
        name: name,
        permission: permission,
        addedAt: new Date().toISOString()
    });

    // Salva lo stato (locale + cloud)
    saveStateAndSync();

    // Aggiorna UI
    renderProjectCollaborators(project);
    renderShareMemberOptions(project);

    // Mostra status - ricorda di cliccare Salva per sincronizzare la condivisione
    const status = document.getElementById('sharingStatus');
    status.innerHTML = `✅ ${name} aggiunto come ${permission === 'editor' ? 'Editor' : 'Viewer'}<br><small>Clicca "Salva Condivisione" per sincronizzare</small>`;
    status.style.display = 'block';
    status.style.background = 'var(--success-bg, rgba(16, 185, 129, 0.1))';
    status.style.color = 'var(--success)';

    showToast(`${name} aggiunto al progetto!`, 'success');
}

// ============================================
// USER SEARCH SYSTEM v5.0
// ============================================

// Debounce per la ricerca utenti
function debounceUserSearch(query) {
    clearTimeout(userSearchTimeout);

    const resultsDiv = document.getElementById('userSearchResults');

    if (!query || query.trim().length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }

    userSearchTimeout = setTimeout(() => {
        searchUsersAPI(query.trim());
    }, 300);
}

// Chiamata API per cercare utenti
async function searchUsersAPI(query) {
    const resultsDiv = document.getElementById('userSearchResults');
    const searchType = document.getElementById('userSearchType')?.value || 'all';

    if (!state.cloudUser?.token) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:var(--text-muted);">Devi essere connesso per cercare utenti</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    // Mostra loading
    resultsDiv.innerHTML = '<div style="padding:15px; text-align:center;"><span class="spinner-small"></span> Ricerca in corso...</div>';
    resultsDiv.style.display = 'block';

    try {
        const result = await apiCall('searchUsers', {
            query: query,
            searchType: searchType
        });

        if (result.success && result.users) {
            renderUserSearchResults(result.users);
        } else {
            resultsDiv.innerHTML = `<div style="padding:10px; color:var(--text-muted);">Nessun utente trovato per "${query}"</div>`;
        }
    } catch (error) {
        console.error('Errore ricerca utenti:', error);
        resultsDiv.innerHTML = '<div style="padding:10px; color:var(--danger);">Errore nella ricerca</div>';
    }
}

// Renderizza i risultati della ricerca
function renderUserSearchResults(users) {
    const resultsDiv = document.getElementById('userSearchResults');
    const project = getProjectById(currentProjectId);
    const currentCollaborators = (project?.collaborators || []).map(c => c.email?.toLowerCase());
    const myEmail = state.cloudUser?.email?.toLowerCase();

    // Filtra utenti già collaboratori o me stesso
    const availableUsers = users.filter(u => {
        const userEmail = (u.email || '').toLowerCase();
        return userEmail !== myEmail && !currentCollaborators.includes(userEmail);
    });

    if (availableUsers.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:10px; color:var(--text-muted);">Nessun nuovo utente trovato (tutti già collaboratori)</div>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.innerHTML = availableUsers.map(user => {
        const initial = (user.name || user.nickname || user.username || '?').charAt(0).toUpperCase();
        const skillsHtml = user.skills?.length > 0
            ? `<div style="margin-top:4px;">${user.skills.slice(0,3).map(s => `<span class="skill-tag-mini">${s}</span>`).join('')}</div>`
            : '';

        return `
            <div class="user-search-result" onclick="selectUserFromSearch(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                <div class="user-result-avatar" style="${user.picture ? `background-image:url(${user.picture});background-size:cover;` : ''}">
                    ${!user.picture ? initial : ''}
                </div>
                <div class="user-result-info">
                    <div class="user-result-name">${user.name || user.nickname || user.username}</div>
                    <div class="user-result-email">${user.email}</div>
                    ${user.profession ? `<div class="user-result-profession">${getProfessionLabel(user.profession)}</div>` : ''}
                    ${skillsHtml}
                </div>
            </div>
        `;
    }).join('');

    resultsDiv.style.display = 'block';
}

// Helper per label professione
function getProfessionLabel(profession) {
    const labels = {
        'magician': '🎩 Mago',
        'musician': '🎵 Musicista',
        'actor': '🎭 Attore',
        'entertainer': '🎪 Intrattenitore',
        'speaker': '🎤 Speaker',
        'developer': '💻 Developer',
        'designer': '🎨 Designer',
        'other': '💼 Altro'
    };
    return labels[profession] || profession;
}

// Seleziona un utente dalla ricerca
function selectUserFromSearch(user) {
    selectedUserData = user;

    // Nascondi risultati
    document.getElementById('userSearchResults').style.display = 'none';
    document.getElementById('userSearchInput').value = '';

    // Mostra card utente selezionato
    const card = document.getElementById('selectedUserCard');
    const avatarDiv = document.getElementById('selectedUserAvatar');
    const nameDiv = document.getElementById('selectedUserName');
    const emailDiv = document.getElementById('selectedUserEmail');

    if (user.picture) {
        avatarDiv.innerHTML = `<img src="${user.picture}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
    } else {
        avatarDiv.innerHTML = (user.name || user.nickname || '?').charAt(0).toUpperCase();
    }

    nameDiv.textContent = user.name || user.nickname || user.username;
    emailDiv.textContent = user.email;

    card.style.display = 'block';

    // Abilita pulsante aggiungi
    document.getElementById('addCollaboratorBtn').disabled = false;

    // Salva email per l'aggiunta
    document.getElementById('shareEmail').value = user.email;
    document.getElementById('selectedUserId').value = user.id || user.username;
}

// Pulisci utente selezionato
function clearSelectedUser() {
    selectedUserData = null;
    document.getElementById('selectedUserCard').style.display = 'none';
    document.getElementById('addCollaboratorBtn').disabled = true;
    document.getElementById('shareEmail').value = '';
    document.getElementById('selectedUserId').value = '';
}

// Aggiungi l'utente selezionato come collaboratore
function addSelectedUserAsCollaborator() {
    if (!selectedUserData) {
        showToast('Seleziona prima un utente', 'warning');
        return;
    }

    const permission = document.getElementById('sharePermission').value;
    const project = getProjectById(currentProjectId);

    if (!project) {
        showToast('Progetto non trovato', 'error');
        return;
    }

    // Salva i dati utente PRIMA di pulire
    const userData = { ...selectedUserData };
    const userName = userData.name || userData.nickname || userData.username || userData.email;

    // Inizializza array collaboratori se non esiste
    project.collaborators = project.collaborators || [];

    // Verifica se già esiste
    const exists = project.collaborators.some(
        c => c.email?.toLowerCase() === userData.email?.toLowerCase()
    );

    if (exists) {
        showToast('Questo utente è già un collaboratore', 'warning');
        clearSelectedUser();
        return;
    }

    // Aggiungi collaboratore
    project.collaborators.push({
        email: userData.email,
        name: userName,
        username: userData.username,
        permission: permission,
        picture: userData.picture,
        addedAt: new Date().toISOString()
    });

    // Aggiorna UI
    renderProjectCollaborators(project);
    clearSelectedUser();

    // Mostra status
    const status = document.getElementById('sharingStatus');
    status.style.display = 'block';
    status.style.background = 'rgba(59, 130, 246, 0.1)';
    status.innerHTML = `✅ <strong>${userName}</strong> aggiunto come ${permission === 'editor' ? 'Editor' : 'Viewer'}`;
    status.style.color = 'var(--accent)';

    showToast(`${userName} aggiunto!`, 'success');

    // Salva
    saveStateAndSync('teamProjects', project.id);
}

// Renderizza selezione rapida membri del team
function renderTeamMembersQuickSelect(project) {
    const container = document.getElementById('teamMembersQuickSelect');
    if (!container) return;

    const members = getAllTeamMembers();
    const currentCollaborators = (project?.collaborators || []).map(c => c.email?.toLowerCase());
    const myEmail = state.cloudUser?.email?.toLowerCase();

    // Filtra membri disponibili
    const availableMembers = members.filter(m => {
        const memberEmail = (m.email || '').toLowerCase();
        return memberEmail !== myEmail && !currentCollaborators.includes(memberEmail);
    });

    if (availableMembers.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted); font-size:0.85rem;">Tutti i membri del team sono già collaboratori</div>';
        return;
    }

    container.innerHTML = availableMembers.map(m => {
        const initial = (m.name || m.username || '?').charAt(0).toUpperCase();
        return `
            <button class="team-member-quick-btn" onclick="quickAddTeamMember('${m.email}', '${m.name || m.username}')" title="${m.name || m.username}">
                <span class="quick-avatar">${initial}</span>
                <span class="quick-name">${(m.name || m.username || '').split(' ')[0]}</span>
            </button>
        `;
    }).join('');
}

// Aggiunge rapidamente un membro del team
function quickAddTeamMember(email, name) {
    const permission = document.getElementById('sharePermission').value;
    const project = getProjectById(currentProjectId);

    if (!project) return;

    project.collaborators = project.collaborators || [];

    // Verifica duplicati
    if (project.collaborators.some(c => c.email?.toLowerCase() === email.toLowerCase())) {
        showToast('Già collaboratore', 'warning');
        return;
    }

    project.collaborators.push({
        email: email,
        name: name,
        permission: permission,
        addedAt: new Date().toISOString()
    });

    renderProjectCollaborators(project);
    renderTeamMembersQuickSelect(project);

    showToast(`${name} aggiunto!`, 'success');
    saveStateAndSync('teamProjects', project.id);
}

function renderProjectCollaborators(project) {
    const container = document.getElementById('projectCollaboratorsList');
    const collaborators = project.collaborators || [];

    if (collaborators.length === 0) {
        container.innerHTML = '<div class="no-collaborators">Nessun collaboratore. Invita qualcuno dal tuo Team!</div>';
        return;
    }

    container.innerHTML = collaborators.map((collab, index) => {
        const displayName = collab.name || collab.email;
        const avatarChar = displayName.charAt(0).toUpperCase();
        return `
        <div class="collaborator-item">
            <div class="collaborator-info">
                <div class="collaborator-avatar">${avatarChar}</div>
                <div class="collaborator-details">
                    <span class="collaborator-name" style="font-weight:600;">${displayName}</span>
                    ${collab.email && collab.email !== collab.name ? `<span class="collaborator-email" style="font-size:0.75rem; color:var(--text-muted);">${collab.email}</span>` : ''}
                    <span class="collaborator-role">${collab.permission === 'editor' ? '✏️ Può modificare' : '👁️ Solo visualizzazione'}</span>
                </div>
            </div>
            <div class="collaborator-actions">
                <select class="form-input form-select" style="width:100px; font-size:0.75rem; padding:4px;" onchange="updateCollaboratorPermission(${index}, this.value)">
                    <option value="editor" ${collab.permission === 'editor' ? 'selected' : ''}>✏️ Editor</option>
                    <option value="viewer" ${collab.permission === 'viewer' ? 'selected' : ''}>👁️ Viewer</option>
                </select>
                <button class="btn btn-ghost btn-xs" onclick="removeCollaborator(${index})" title="Rimuovi">🗑️</button>
            </div>
        </div>
    `}).join('');
}

function addProjectCollaborator() {
    const email = document.getElementById('shareEmail').value.trim().toLowerCase();
    const permission = document.getElementById('sharePermission').value;

    if (!email) {
        showToast('Inserisci un\'email', 'error');
        return;
    }

    // Valida email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast('Email non valida', 'error');
        return;
    }

    // Non puoi invitare te stesso
    if (email === state.cloudUser?.email?.toLowerCase()) {
        showToast('Non puoi invitare te stesso!', 'error');
        return;
    }

    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Inizializza array se non esiste
    project.collaborators = project.collaborators || [];

    // Controlla se già presente
    if (project.collaborators.some(c => c.email.toLowerCase() === email)) {
        showToast('Questo collaboratore è già presente', 'error');
        return;
    }

    // Aggiungi collaboratore
    project.collaborators.push({
        email: email,
        permission: permission,
        invitedAt: new Date().toISOString(),
        invitedBy: state.cloudUser?.email || 'unknown'
    });

    saveStateAndSync();
    renderProjectCollaborators(project);
    document.getElementById('shareEmail').value = '';

    showToast(`${email} aggiunto come ${permission === 'editor' ? 'Editor' : 'Viewer'}!`, 'success');
}

function updateCollaboratorPermission(index, newPermission) {
    const project = getProjectById(currentProjectId);
    if (!project || !project.collaborators || !project.collaborators[index]) return;

    project.collaborators[index].permission = newPermission;
    saveStateAndSync();

    showToast('Permessi aggiornati!', 'success');
}

function removeCollaborator(index) {
    const project = getProjectById(currentProjectId);
    if (!project || !project.collaborators) return;

    const collab = project.collaborators[index];
    const displayName = collab.name || collab.email;

    if (confirm(`Rimuovere ${displayName} dal progetto?`)) {
        project.collaborators.splice(index, 1);
        saveStateAndSync();
        renderProjectCollaborators(project);
        renderShareMemberOptions(project); // Aggiorna selettore membri
        showToast('Collaboratore rimosso', 'info');
    }
}

function saveProjectSharing() {
    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Salva lo stato
    saveStateAndSync();

    // Sincronizza con il cloud se connesso
    if (state.cloudUser?.token) {
        syncProjectSharing(project);
    } else {
        showToast('Condivisione salvata localmente. Accedi al cloud per sincronizzare.', 'info');
        closeModal('shareProjectModal');
        updateSharingBadge(project);
    }
}

async function syncProjectSharing(project) {
    const statusEl = document.getElementById('sharingStatus');
    statusEl.style.display = 'block';
    statusEl.style.background = 'rgba(59, 130, 246, 0.1)';
    statusEl.innerHTML = '⏳ Sincronizzazione condivisione in corso...';

    console.log('📤 syncProjectSharing chiamato');
    console.log('  - project.id:', project.id);
    console.log('  - project.name:', project.name);
    console.log('  - collaborators:', project.collaborators);

    try {
        // Usa apiCall per evitare problemi CORS
        const result = await apiCall('shareProject', {
            projectId: project.id,
            projectName: project.name,
            collaborators: project.collaborators || [],
            projectData: project
        });

        console.log('  - Risposta shareProject:', result);

        if (result.success) {
            statusEl.style.background = 'rgba(16, 185, 129, 0.1)';
            statusEl.innerHTML = '✅ Condivisione sincronizzata! I collaboratori potranno vedere il progetto.';
            setTimeout(() => {
                closeModal('shareProjectModal');
                updateSharingBadge(project);
            }, 1500);
        } else {
            throw new Error(result.error || result.message || 'Errore sincronizzazione');
        }
    } catch (error) {
        console.error('Share sync error:', error);
        statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
        statusEl.innerHTML = '❌ Errore: ' + error.message + '<br>La condivisione è salvata localmente.';
    }
}

function updateSharingBadge(project) {
    const badge = document.getElementById('projectSharingBadge');
    const count = document.getElementById('sharedWithCount');

    if (project.collaborators && project.collaborators.length > 0) {
        badge.style.display = 'inline';
        count.textContent = project.collaborators.length + ' person' + (project.collaborators.length > 1 ? 'e' : 'a');
    } else {
        badge.style.display = 'none';
    }
}

// Funzione per caricare progetti condivisi con me
async function loadSharedProjects() {
    console.log('📥 loadSharedProjects chiamato');
    console.log('  - cloudUser:', state.cloudUser?.email);

    if (!state.cloudUser?.token || !state.cloudUser?.email) {
        console.warn('⚠️ loadSharedProjects: token o email mancante');
        return;
    }

    try {
        // Usa apiCall per evitare problemi CORS
        const result = await apiCall('getSharedProjects', {
            email: state.cloudUser.email
        });

        console.log('  - Risposta getSharedProjects:', result);

        if (result.success && result.projects) {
            // IMPORTANTE: state.sharedProjects contiene SOLO progetti di ALTRI utenti condivisi CON ME
            // I miei progetti che ho condiviso con altri rimangono in state.teamProjects
            state.sharedProjects = result.projects;

            console.log('  ✅ Progetti condivisi con me:', state.sharedProjects.length);
            state.sharedProjects.forEach(p => {
                console.log(`    - "${p.name}" di ${p.ownerUsername || p.ownerEmail} (permesso: ${p.myPermission})`);
            });

            // Aggiorna il selettore progetti
            renderProjectSelector();
        } else {
            console.log('  - Nessun progetto condiviso trovato o errore:', result.message);
            state.sharedProjects = [];
            renderProjectSelector();
        }
    } catch (error) {
        console.error('❌ Error loading shared projects:', error);
    }
}

// Funzione per aggiornare un progetto condiviso sul backend
async function syncSharedProject(project) {
    if (!project) return;

    // Verifica se il progetto è condiviso (ha collaboratori o è un progetto di team)
    const isShared = project.collaborators?.length > 0 || project.isShared;

    if (!isShared) return; // Non sincronizzare progetti non condivisi

    // Verifica token
    if (!state.cloudUser?.token) {
        console.warn('⚠️ syncSharedProject: nessun token disponibile');
        return;
    }

    try {
        console.log('🔄 Sincronizzazione progetto condiviso:', project.name);

        // Rimuovi il prefisso 'shared_' dall'ID se presente (per il backend)
        let projectIdForBackend = project.id;
        if (projectIdForBackend && projectIdForBackend.startsWith('shared_')) {
            projectIdForBackend = projectIdForBackend.replace('shared_', '');
        }

        // Prepara versione "slim" del progetto per ridurre la dimensione del payload
        // Mantieni solo i dati essenziali per la condivisione
        const projectDataForBackend = {
            id: projectIdForBackend,
            name: project.name,
            description: project.description || '',
            objective: project.objective || '',
            deadline: project.deadline || null,
            status: project.status || 'active',
            members: project.members || [],
            collaborators: project.collaborators || [],
            columns: {
                tasks: (project.columns?.tasks || []).map(t => ({
                    id: t.id,
                    title: t.title,
                    description: t.description || '',
                    status: t.status,
                    assignees: t.assignees || [],
                    deadline: t.deadline || null,
                    priority: t.priority || 'medium',
                    // Limita commenti agli ultimi 50 per task
                    comments: (t.comments || []).slice(-50)
                })),
                problems: project.columns?.problems || [],
                resources: project.columns?.resources || []
            },
            // Limita activity log alle ultime 100 voci
            activityLog: (project.activityLog || []).slice(-100),
            updatedAt: new Date().toISOString()
        };

        const payloadSize = JSON.stringify(projectDataForBackend).length;
        console.log('📦 syncSharedProject payload size:', payloadSize, 'bytes');
        console.log('📦 Project ID:', projectIdForBackend);
        console.log('📦 Activity log entries:', projectDataForBackend.activityLog?.length || 0);
        console.log('📦 Tasks count:', projectDataForBackend.columns?.tasks?.length || 0);

        // Se il payload è ancora troppo grande (>50KB), riduci ulteriormente
        if (payloadSize > 50000) {
            console.warn('⚠️ Payload troppo grande, riducendo commenti e activity log');
            projectDataForBackend.columns.tasks = projectDataForBackend.columns.tasks.map(t => ({
                ...t,
                comments: (t.comments || []).slice(-10) // Solo ultimi 10 commenti
            }));
            projectDataForBackend.activityLog = (project.activityLog || []).slice(-20);
        }

        const result = await apiCall('updateSharedProject', {
            email: state.cloudUser?.email,
            projectId: projectIdForBackend,
            projectData: projectDataForBackend
        });

        if (result.success) {
            console.log('✅ Progetto condiviso aggiornato:', result.updatedAt);
        } else {
            console.warn('⚠️ Errore aggiornamento progetto condiviso:', result.message);
        }
    } catch (error) {
        console.error('❌ Errore sync progetto condiviso:', error);
    }
}

// Wrapper per saveStateAndSync che sincronizza anche i progetti condivisi
async function saveStateAndSyncProject(project) {
    saveStateAndSync();

    // Se il progetto è condiviso, sincronizzalo anche sul backend condiviso
    if (project) {
        await syncSharedProject(project);
    }
}

function renderSharedProjects() {
    // Se ci sono progetti condivisi, mostrali nel selettore progetti
    const select = document.getElementById('teamProjectSelect');
    if (!select || !state.sharedProjects || state.sharedProjects.length === 0) return;

    // Aggiungi gruppo progetti condivisi
    const sharedGroup = document.createElement('optgroup');
    sharedGroup.label = '📥 Condivisi con me';

    state.sharedProjects.forEach(sp => {
        const opt = document.createElement('option');
        opt.value = 'shared_' + sp.id;
        opt.textContent = `${sp.name} (da ${sp.ownerEmail})`;
        sharedGroup.appendChild(opt);
    });

    select.appendChild(sharedGroup);
}

// Verifica permessi utente sul progetto
function canEditProject(project) {
    // Se è il proprietario, può sempre modificare
    if (!project.ownerEmail || project.ownerEmail === state.cloudUser?.email) {
        return true;
    }

    // Se è un collaboratore, controlla i permessi
    const collab = project.collaborators?.find(c => c.email.toLowerCase() === state.cloudUser?.email?.toLowerCase());
    return collab?.permission === 'editor';
}

function canViewProject(project) {
    // Proprietario può sempre vedere
    if (!project.ownerEmail || project.ownerEmail === state.cloudUser?.email) {
        return true;
    }

    // Collaboratore può vedere
    return project.collaborators?.some(c => c.email.toLowerCase() === state.cloudUser?.email?.toLowerCase());
}

// ========== END PROJECT SHARING ==========

function convertProblemToTask(problemId) {
    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Inizializza columns se non esiste
    if (!project.columns) {
        project.columns = { tasks: [], problems: [], resources: [] };
    }
    if (!project.columns.problems) return;

    const problem = project.columns.problems.find(p => p.id === problemId);
    if (!problem) return;

    // Crea task dal problema
    const task = {
        id: 'ptask_' + Date.now(),
        title: '🔧 ' + problem.title,
        assignee: null,
        status: 'todo',
        resources: [],
        problems: [problemId]
    };

    project.columns.tasks = project.columns.tasks || [];
    project.columns.tasks.push(task);
    problem.status = 'converted';
    problem.linkedTask = task.id;

    // Rimuovi dalla lista problemi attivi
    project.columns.problems = project.columns.problems.filter(p => p.id !== problemId);

    saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso
    renderTeamProject();
    showToast('Problema convertito in task!', 'success');
}

// Drag and drop per Kanban
function dragTask(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.id);
    e.target.classList.add('dragging');
}

function dragEnd(e) {
    e.target.classList.remove('dragging');
}

function allowDrop(e) {
    e.preventDefault();
}

function dropTask(e, newStatus) {
    e.preventDefault();
    const taskId = e.dataTransfer.getData('text/plain');

    const project = getProjectById(currentProjectId);
    if (!project || !project.columns || !project.columns.tasks) return;

    const task = project.columns.tasks.find(t => t.id === taskId);
    if (task) {
        const oldStatus = task.status;
        task.status = newStatus;

        // SYNC: Aggiorna anche il task personale collegato
        syncProjectTaskToPersonal(task);

        // Log attività nella bacheca del progetto
        if (newStatus === 'done') {
            logProjectActivity(project, 'task_completed', { taskTitle: task.title, taskId: task.id });
        } else if (oldStatus !== newStatus) {
            logProjectActivity(project, 'task_moved', { taskTitle: task.title, taskId: task.id, oldStatus, newStatus });
        }

        saveStateAndSyncProject(project); // Sincronizza anche il progetto condiviso
        renderTeamProject();
        renderTasksPage();

        if (newStatus === 'done') {
            addXP(10);
            showToast('Task completato! +10 XP', 'success');
            // Log attivita per KPI
            logAttivita('task_completato', 'tasks', taskId, { progetto: project.name });
        } else if (oldStatus !== newStatus) {
            // Log cambio stato
            logAttivita('task_stato_cambiato', 'tasks', taskId, { da: oldStatus, a: newStatus });
        }
    }
}

// ============================================
// BACHECA ATTIVITÀ PROGETTO
// ============================================

// Log attività specifico del progetto (salvato localmente nel progetto)
function logProjectActivity(project, action, details = {}) {
    if (!project) return;

    // Inizializza array attività se non esiste
    project.activityLog = project.activityLog || [];

    const authorName = currentUser?.nickname || state.cloudUser?.username || currentUser?.username || state.profile?.name || 'Utente';

    const activity = {
        id: 'act_' + Date.now(),
        action: action,
        author: authorName,
        authorEmail: state.cloudUser?.email || '',
        details: details,
        timestamp: new Date().toISOString()
    };

    // Aggiungi all'inizio (più recenti prima)
    project.activityLog.unshift(activity);

    // Limita a 100 attività per non appesantire
    if (project.activityLog.length > 100) {
        project.activityLog = project.activityLog.slice(0, 100);
    }

    // Aggiorna la UI se il progetto è quello corrente
    if (project.id === currentProjectId) {
        renderProjectActivityLog(project);
    }

    return activity;
}

// Renderizza la bacheca attività
function renderProjectActivityLog(project) {
    const container = document.getElementById('projectActivityLog');
    if (!container) return;

    const activities = project?.activityLog || [];

    if (activities.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:16px; text-align:center; font-size:0.85rem;">
                Nessuna attività recente
            </div>
        `;
        return;
    }

    // Mostra le ultime 20 attività
    const recentActivities = activities.slice(0, 20);

    container.innerHTML = recentActivities.map(act => {
        const timeAgo = getTimeAgo(act.timestamp);
        const icon = getActivityIcon(act.action);
        const description = getActivityDescription(act);

        return `
            <div class="activity-log-item" style="padding:8px; border-bottom:1px solid var(--border); font-size:0.8rem;">
                <div style="display:flex; gap:8px; align-items:flex-start;">
                    <span style="font-size:1rem;">${icon}</span>
                    <div style="flex:1;">
                        <div style="color:var(--text);">${description}</div>
                        <div style="color:var(--text-muted); font-size:0.7rem; margin-top:2px;">
                            👤 ${act.author} • ${timeAgo}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Icone per le attività
function getActivityIcon(action) {
    const icons = {
        'task_created': '✅',
        'task_updated': '📝',
        'task_deleted': '🗑️',
        'task_moved': '➡️',
        'task_completed': '🎉',
        'comment_added': '💬',
        'comment_deleted': '🗑️',
        'problem_added': '⚠️',
        'problem_resolved': '✔️',
        'resource_added': '📦',
        'resource_deleted': '🗑️',
        'member_joined': '👋',
        'member_left': '👤',
        'project_updated': '⚙️',
        'mention': '📣'
    };
    return icons[action] || '📌';
}

// Descrizioni per le attività
function getActivityDescription(activity) {
    const d = activity.details || {};

    const descriptions = {
        'task_created': `Ha creato il task "${d.taskTitle || 'Nuovo task'}"`,
        'task_updated': `Ha modificato il task "${d.taskTitle || ''}"`,
        'task_deleted': `Ha eliminato il task "${d.taskTitle || ''}"`,
        'task_moved': `Ha spostato "${d.taskTitle || ''}" in <b>${getStatusLabel(d.newStatus)}</b>`,
        'task_completed': `Ha completato "${d.taskTitle || ''}" 🎉`,
        'comment_added': `Ha commentato su "${d.taskTitle || ''}"`,
        'comment_deleted': `Ha eliminato un commento da "${d.taskTitle || ''}"`,
        'problem_added': `Ha segnalato: "${d.problemTitle || ''}"`,
        'problem_resolved': `Ha risolto: "${d.problemTitle || ''}"`,
        'resource_added': `Ha aggiunto risorsa: "${d.resourceTitle || ''}"`,
        'resource_deleted': `Ha rimosso risorsa: "${d.resourceTitle || ''}"`,
        'member_joined': `${d.memberName || 'Nuovo membro'} si è unito al progetto`,
        'member_left': `${d.memberName || 'Un membro'} ha lasciato il progetto`,
        'project_updated': `Ha aggiornato le impostazioni del progetto`,
        'mention': `Ha menzionato @${d.mentionedUser || ''} in "${d.taskTitle || ''}"`
    };

    return descriptions[activity.action] || `${activity.action}`;
}

// Helper per label status
function getStatusLabel(status) {
    const labels = {
        'todo': 'Da fare',
        'doing': 'In corso',
        'done': 'Completato'
    };
    return labels[status] || status;
}

// Helper per tempo relativo (accetta stringa timestamp o oggetto Date)
function getTimeAgo(timestamp) {
    if (!timestamp) return '';

    const now = new Date();
    const then = timestamp instanceof Date ? timestamp : new Date(timestamp);

    // Verifica che la data sia valida
    if (isNaN(then.getTime())) return '';

    const diffMs = now - then;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Adesso';
    if (diffMins < 60) return `${diffMins} min fa`;
    if (diffHours < 24) return `${diffHours}h fa`;
    if (diffDays < 7) return `${diffDays}g fa`;

    return then.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
}

// Aggiorna bacheca attività
async function refreshProjectActivityLog() {
    const project = getProjectById(currentProjectId);
    if (!project) return;

    // Se è un progetto condiviso, carica le attività dal server
    if (project.isShared || project.collaborators?.length > 0) {
        try {
            showToast('⏳ Caricamento attività...', 'info');
            const result = await apiCall('getProjectActivityLog', {
                projectId: project.id
            });

            if (result.success && result.activities) {
                project.activityLog = result.activities;
                showToast('✅ Attività aggiornate', 'success');
            }
        } catch (error) {
            console.error('Errore caricamento attività:', error);
        }
    }

    renderProjectActivityLog(project);
}

// ============================================
// CALENDARIO AVANZATO
// ============================================
// Nota: calendarView e calendarDate sono definite all'inizio del file
// per evitare "Cannot access before initialization" error

function setCalendarView(view) {
    const previousView = calendarView;
    calendarView = view;

    // Update buttons
    document.querySelectorAll('.cal-view-btn').forEach(btn => btn.classList.remove('active'));
    if (event && event.target) event.target.classList.add('active');

    // Show/hide views
    document.getElementById('calDayView').style.display = view === 'day' ? 'block' : 'none';
    document.getElementById('calWeekView').style.display = view === 'week' ? 'block' : 'none';
    document.getElementById('calMonthView').style.display = view === 'month' ? 'block' : 'none';
    document.getElementById('calAgendaView').style.display = view === 'agenda' ? 'block' : 'none';

    // Se cambiamo a vista mese, ricarica gli eventi per tutto il mese
    if (view === 'month' && previousView !== 'month') {
        loadCalendarEventsForCurrentView();
    }

    renderCalendar();
}

function navigateCalendar(direction) {
    const previousMonth = calendarDate.getMonth();
    const previousYear = calendarDate.getFullYear();

    switch(calendarView) {
        case 'day':
            calendarDate.setDate(calendarDate.getDate() + direction);
            break;
        case 'week':
        case 'agenda':
            calendarDate.setDate(calendarDate.getDate() + (direction * 7));
            break;
        case 'month':
            calendarDate.setMonth(calendarDate.getMonth() + direction);
            break;
    }

    // Se siamo cambiati di mese, ricarica gli eventi
    const newMonth = calendarDate.getMonth();
    const newYear = calendarDate.getFullYear();
    if (newMonth !== previousMonth || newYear !== previousYear) {
        loadCalendarEventsForCurrentView();
    }

    renderCalendar();
}

function goToToday() {
    const previousMonth = calendarDate.getMonth();
    calendarDate = new Date();

    // Se eravamo in un mese diverso, ricarica
    if (calendarDate.getMonth() !== previousMonth) {
        loadCalendarEventsForCurrentView();
    }

    renderCalendar();
}

// Carica eventi per la vista corrente
async function loadCalendarEventsForCurrentView() {
    if (!isGoogleSignedIn) return;

    let startOfRange, endOfRange;

    if (calendarView === 'month') {
        // Vista mese: carica tutto il mese + giorni visibili delle settimane adiacenti
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        // Inizia dalla domenica della prima settimana del mese
        const firstDay = new Date(year, month, 1);
        startOfRange = new Date(firstDay);
        startOfRange.setDate(startOfRange.getDate() - firstDay.getDay());
        // Finisce il sabato dell'ultima settimana del mese
        const lastDay = new Date(year, month + 1, 0);
        endOfRange = new Date(lastDay);
        endOfRange.setDate(endOfRange.getDate() + (6 - lastDay.getDay()));
    } else if (calendarView === 'week' || calendarView === 'agenda') {
        // Vista settimana: 2 settimane
        startOfRange = new Date(calendarDate);
        startOfRange.setDate(startOfRange.getDate() - startOfRange.getDay());
        endOfRange = new Date(startOfRange);
        endOfRange.setDate(endOfRange.getDate() + 14);
    } else {
        // Vista giorno: 2 settimane
        startOfRange = new Date(calendarDate);
        startOfRange.setDate(startOfRange.getDate() - 7);
        endOfRange = new Date(calendarDate);
        endOfRange.setDate(endOfRange.getDate() + 7);
    }

    await loadCalendarEvents({ start: startOfRange, end: endOfRange });
}

function renderCalendar() {
    updateCalendarNavDate();

    switch(calendarView) {
        case 'day':
            renderDayView();
            break;
        case 'week':
            renderWeekView();
            break;
        case 'month':
            renderMonthView();
            break;
        case 'agenda':
            renderAgendaView();
            break;
    }

    // Renderizza anche gli inviti in attesa
    renderPendingInvites();
}

// Renderizza gli inviti in attesa nel calendario
function renderPendingInvites() {
    const section = document.getElementById('pendingInvitesSection');
    const list = document.getElementById('pendingInvitesList');
    const countEl = document.getElementById('pendingInvitesCount');

    console.log('🔔 renderPendingInvites chiamato');
    console.log('  - calendarEvents:', state.calendarEvents?.length || 0);
    console.log('  - backendNotifications:', state.backendNotifications?.length || 0);
    console.log('  - profile email:', state.profile?.email);

    if (!section || !list) {
        console.warn('⚠️ Sezione pendingInvites non trovata nel DOM');
        return;
    }

    // Raccogli inviti da Google Calendar (responseStatus === 'needsAction')
    let pendingInvites = [];

    if (state.calendarEvents) {
        state.calendarEvents.forEach(event => {
            if (event.attendees) {
                const myAttendee = event.attendees.find(a =>
                    a.self || a.email === state.profile?.email
                );
                if (myAttendee && myAttendee.responseStatus === 'needsAction') {
                    pendingInvites.push({
                        id: event.id,
                        type: 'google',
                        title: event.summary || 'Evento senza titolo',
                        organizer: event.organizer?.displayName || event.organizer?.email || 'Organizzatore',
                        date: event.start?.dateTime || event.start?.date,
                        location: event.location || ''
                    });
                }
            }
        });
    }

    // Aggiungi inviti dal backend (app)
    if (state.backendNotifications) {
        state.backendNotifications.forEach(notif => {
            if (notif.type === 'event_invite' && notif.status !== 'accepted' && notif.status !== 'declined') {
                const eventData = notif.eventData || {};
                pendingInvites.push({
                    id: notif.id,
                    type: 'app',
                    title: eventData.title || notif.title?.replace('Invito: ', '') || 'Evento',
                    organizer: notif.fromUsername || 'Utente',
                    date: eventData.date ? `${eventData.date}T${eventData.startTime || '00:00'}` : notif.createdAt,
                    location: eventData.location || ''
                });
            }
        });
    }

    // Aggiorna UI
    if (pendingInvites.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';
    countEl.textContent = pendingInvites.length;

    // Ordina per data
    pendingInvites.sort((a, b) => new Date(a.date) - new Date(b.date));

    list.innerHTML = pendingInvites.map(invite => {
        const dateStr = invite.date ? new Date(invite.date).toLocaleDateString('it-IT', {
            weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
        }) : '';

        return `
            <div class="pending-invite-item" style="background:var(--bg-secondary); padding:10px 12px; border-radius:8px; border-left:3px solid var(--warning);">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${invite.title}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">
                            👤 ${invite.organizer}${invite.location ? ' · 📍 ' + invite.location : ''}
                        </div>
                        <div style="font-size:0.75rem; color:var(--text-muted);">📅 ${dateStr}</div>
                    </div>
                    <div style="display:flex; gap:4px; flex-shrink:0;">
                        ${invite.type === 'google' ?
                            `<button class="btn btn-xs" style="background:var(--success); color:white; padding:4px 8px; font-size:0.75rem;" onclick="respondToInvite('${invite.id}', 'accepted', true)">✓</button>
                             <button class="btn btn-xs" style="background:var(--text-muted); color:white; padding:4px 8px; font-size:0.75rem;" onclick="respondToInvite('${invite.id}', 'tentative', true)">?</button>
                             <button class="btn btn-xs" style="background:var(--danger); color:white; padding:4px 8px; font-size:0.75rem;" onclick="respondToInvite('${invite.id}', 'declined', true)">✗</button>`
                            :
                            `<button class="btn btn-xs" style="background:var(--success); color:white; padding:4px 8px; font-size:0.75rem;" onclick="respondToBackendEventInvite('${invite.id}', 'accepted')">✓</button>
                             <button class="btn btn-xs" style="background:var(--danger); color:white; padding:4px 8px; font-size:0.75rem;" onclick="respondToBackendEventInvite('${invite.id}', 'declined')">✗</button>`
                        }
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateCalendarNavDate() {
    const el = document.getElementById('calNavDate');
    if (!el) return;

    const today = new Date();
    const isToday = calendarDate.toDateString() === today.toDateString();

    const options = { weekday: 'short', day: 'numeric', month: 'short' };
    if (calendarView === 'month') {
        el.textContent = calendarDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
    } else if (calendarView === 'week') {
        const weekStart = new Date(calendarDate);
        weekStart.setDate(calendarDate.getDate() - calendarDate.getDay() + 1);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        el.textContent = `${weekStart.getDate()} - ${weekEnd.getDate()} ${weekEnd.toLocaleDateString('it-IT', { month: 'short' })}`;
    } else {
        el.textContent = isToday ? 'Oggi' : calendarDate.toLocaleDateString('it-IT', options);
    }
}

function toggleCalendarCompactView() {
    calendarCompactView = !calendarCompactView;
    const btn = document.getElementById('compactViewToggle');
    if (btn) {
        btn.textContent = calendarCompactView ? '📋' : '📅';
        btn.title = calendarCompactView ? 'Vista estesa' : 'Vista compatta';
    }
    renderDayView();
}

function renderDayView() {
    const container = document.getElementById('dayTimeline');
    if (!container) return;

    const events = getEventsForDate(calendarDate);
    const googleEvents = (state.calendarEvents || []).filter(e => {
        const eventDate = new Date(e.start?.dateTime || e.start?.date);
        return eventDate.toDateString() === calendarDate.toDateString();
    });

    // Raccogli tutte le ore che hanno eventi
    const hoursWithEvents = new Set();

    events.forEach(e => {
        const hour = parseInt(e.startTime?.split(':')[0]);
        if (!isNaN(hour)) hoursWithEvents.add(hour);
    });

    googleEvents.forEach(e => {
        const eventDate = new Date(e.start?.dateTime);
        const hour = eventDate.getHours();
        if (!isNaN(hour)) hoursWithEvents.add(hour);
    });

    // Se vista compatta e non ci sono eventi, mostra messaggio
    if (calendarCompactView && hoursWithEvents.size === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:30px 16px; color:var(--text-muted);">
                <div style="font-size:2rem; margin-bottom:8px;">📅</div>
                <div>Nessun evento per oggi</div>
                <button class="btn btn-sm btn-primary" style="margin-top:12px;" onclick="openAddEventModal()">+ Aggiungi Evento</button>
            </div>
        `;
        return;
    }

    // Determina le ore da mostrare
    let hoursToShow;
    if (calendarCompactView && hoursWithEvents.size > 0) {
        // Vista compatta: mostra solo le ore con eventi + 1 ora prima e dopo per contesto
        const sortedHours = [...hoursWithEvents].sort((a, b) => a - b);
        const minHour = Math.max(0, sortedHours[0] - 1);
        const maxHour = Math.min(23, sortedHours[sortedHours.length - 1] + 1);
        hoursToShow = [];
        for (let h = minHour; h <= maxHour; h++) {
            hoursToShow.push(h);
        }
    } else {
        // Vista estesa: mostra tutte le ore dalle 6 alle 22
        hoursToShow = [];
        for (let h = 6; h <= 22; h++) {
            hoursToShow.push(h);
        }
    }

    // Trova l'ora del primo evento
    let firstEventHour = hoursWithEvents.size > 0 ? Math.min(...hoursWithEvents) : null;

    // Genera timeline
    let html = '';
    for (const hour of hoursToShow) {
        const hourEvents = events.filter(e => {
            const eventHour = parseInt(e.startTime?.split(':')[0]);
            return eventHour === hour;
        });

        const gEventsHour = googleEvents.filter(e => {
            const eventDate = new Date(e.start?.dateTime);
            return eventDate.getHours() === hour;
        });

        const hasEvents = hourEvents.length > 0 || gEventsHour.length > 0;
        const isFirstEventHour = (hour === firstEventHour);

        // In vista compatta, evidenzia le ore con eventi
        const slotClass = calendarCompactView && hasEvents ? 'day-hour-slot has-events' : 'day-hour-slot';

        html += `
            <div class="${slotClass}" ${isFirstEventHour ? 'id="firstEventSlot"' : ''}>
                <div class="day-hour-label">${hour.toString().padStart(2, '0')}:00</div>
                <div class="day-hour-events">
                    ${hourEvents.map(e => `
                        <div class="day-event ${e.type}" onclick="showEventDetail('${e.id}')">
                            <div class="day-event-title">${getEventTypeIcon(e.type)} ${e.title}</div>
                            <div class="day-event-time">${e.startTime} - ${e.endTime} ${e.location ? '📍 ' + e.location : ''}</div>
                        </div>
                    `).join('')}
                    ${gEventsHour.map(e => `
                        <div class="day-event google" onclick="showEventDetail('${e.id}', true)" style="cursor:pointer;">
                            <div class="day-event-title">☁️ ${e.summary || 'Evento'}</div>
                            <div class="day-event-time">${formatGoogleEventTime(e)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    container.innerHTML = html;

    // In vista estesa, scroll al primo evento
    if (!calendarCompactView && firstEventHour !== null) {
        setTimeout(() => {
            const firstSlot = document.getElementById('firstEventSlot');
            const scrollContainer = document.getElementById('calDayView');

            if (firstSlot && scrollContainer) {
                const slotOffsetTop = firstSlot.offsetTop;
                scrollContainer.scrollTo({
                    top: Math.max(0, slotOffsetTop - 10),
                    behavior: 'smooth'
                });
            }
        }, 150);
    }
}

function renderWeekView() {
    const header = document.getElementById('weekHeader');
    const grid = document.getElementById('weekGrid');
    if (!header || !grid) return;

    const weekStart = new Date(calendarDate);
    weekStart.setDate(calendarDate.getDate() - calendarDate.getDay() + 1);

    const days = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
    const today = new Date();

    // Helper per eventi Google
    const getGoogleEventsForDate = (date) => {
        return (state.calendarEvents || []).filter(e => {
            const eventDate = new Date(e.start?.dateTime || e.start?.date);
            return eventDate.toDateString() === date.toDateString();
        });
    };

    // Header
    let headerHtml = '';
    let gridHtml = '';

    for (let i = 0; i < 7; i++) {
        const day = new Date(weekStart);
        day.setDate(weekStart.getDate() + i);
        const isToday = day.toDateString() === today.toDateString();
        const localEvents = getEventsForDate(day);
        const googleEvents = getGoogleEventsForDate(day);
        const totalEvents = localEvents.length + googleEvents.length;

        // Header con indicatore eventi
        headerHtml += `<div class="week-header-day ${isToday ? 'today' : ''} ${totalEvents > 0 ? 'has-events' : ''}">${days[i]}<br>${day.getDate()}</div>`;

        // Combina eventi locali e Google per la visualizzazione
        const allEvents = [
            ...localEvents.map(e => ({ ...e, isGoogle: false })),
            ...googleEvents.map(e => ({
                title: e.summary || 'Evento',
                type: 'google',
                startTime: e.start?.dateTime ? new Date(e.start.dateTime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'Tutto il giorno',
                isGoogle: true
            }))
        ];

        gridHtml += `
            <div class="week-day-cell ${isToday ? 'today' : ''} ${totalEvents > 0 ? 'has-events' : ''}" onclick="selectCalendarDay(${day.getTime()})">
                <div class="week-day-events">
                    ${allEvents.slice(0, 3).map(e => `
                        <div class="week-event-dot" style="background:${e.isGoogle ? '#4285F420' : getEventColor(e.type) + '20'}; color:${e.isGoogle ? '#4285F4' : getEventColor(e.type)};">
                            ${e.isGoogle ? '☁️ ' : ''}${e.title.substring(0, 8)}${e.title.length > 8 ? '..' : ''}
                        </div>
                    `).join('')}
                    ${allEvents.length > 3 ? `<div style="font-size:0.65rem; color:var(--text-secondary);">+${allEvents.length - 3}</div>` : ''}
                </div>
            </div>
        `;
    }

    header.innerHTML = headerHtml;
    grid.innerHTML = gridHtml;
}

function renderMonthView() {
    const grid = document.getElementById('monthGrid');
    if (!grid) return;

    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const today = new Date();

    // Helper per contare eventi Google in una data
    const getGoogleEventsForDate = (date) => {
        return (state.calendarEvents || []).filter(e => {
            const eventDate = new Date(e.start?.dateTime || e.start?.date);
            return eventDate.toDateString() === date.toDateString();
        });
    };

    let html = '';

    // Days of week header
    ['L', 'M', 'M', 'G', 'V', 'S', 'D'].forEach(d => {
        html += `<div style="text-align:center; font-size:0.7rem; font-weight:600; color:var(--text-secondary); padding:4px;">${d}</div>`;
    });

    // Start from Monday
    let startDay = firstDay.getDay() || 7;
    startDay = startDay - 1;

    // Previous month days
    for (let i = startDay - 1; i >= 0; i--) {
        const day = new Date(year, month, -i);
        const localEvents = getEventsForDate(day);
        const googleEvents = getGoogleEventsForDate(day);
        const totalEvents = localEvents.length + googleEvents.length;
        html += `<div class="month-day-cell other-month ${totalEvents > 0 ? 'has-events' : ''}" onclick="selectCalendarDay(${day.getTime()})">
            ${day.getDate()}
            ${totalEvents > 0 ? `<div class="event-dots">${renderEventDots(localEvents, googleEvents)}</div>` : ''}
        </div>`;
    }

    // Current month days
    for (let d = 1; d <= lastDay.getDate(); d++) {
        const day = new Date(year, month, d);
        const isToday = day.toDateString() === today.toDateString();
        const localEvents = getEventsForDate(day);
        const googleEvents = getGoogleEventsForDate(day);
        const totalEvents = localEvents.length + googleEvents.length;

        html += `<div class="month-day-cell ${isToday ? 'today' : ''} ${totalEvents > 0 ? 'has-events' : ''}" onclick="selectCalendarDay(${day.getTime()})">
            ${d}
            ${totalEvents > 0 ? `<div class="event-dots">${renderEventDots(localEvents, googleEvents)}</div>` : ''}
        </div>`;
    }

    // Next month days
    const remaining = 42 - (startDay + lastDay.getDate());
    for (let i = 1; i <= remaining; i++) {
        const day = new Date(year, month + 1, i);
        const localEvents = getEventsForDate(day);
        const googleEvents = getGoogleEventsForDate(day);
        const totalEvents = localEvents.length + googleEvents.length;
        html += `<div class="month-day-cell other-month ${totalEvents > 0 ? 'has-events' : ''}" onclick="selectCalendarDay(${day.getTime()})">
            ${i}
            ${totalEvents > 0 ? `<div class="event-dots">${renderEventDots(localEvents, googleEvents)}</div>` : ''}
        </div>`;
    }

    grid.innerHTML = html;
}

// Renderizza i pallini degli eventi per la vista mese
function renderEventDots(localEvents, googleEvents) {
    let dots = '';
    const maxDots = 3; // Mostra massimo 3 pallini
    let count = 0;

    // Pallini per eventi locali (colorati per tipo)
    for (const e of localEvents) {
        if (count >= maxDots) break;
        const color = getEventTypeColor(e.type);
        dots += `<span class="event-dot" style="background:${color};"></span>`;
        count++;
    }

    // Pallini per eventi Google (blu)
    for (const e of googleEvents) {
        if (count >= maxDots) break;
        dots += `<span class="event-dot" style="background:#4285F4;"></span>`;
        count++;
    }

    // Se ci sono più eventi, mostra +N
    const total = localEvents.length + googleEvents.length;
    if (total > maxDots) {
        dots += `<span class="event-more">+${total - maxDots}</span>`;
    }

    return dots;
}

// Colore per tipo evento
function getEventTypeColor(type) {
    const colors = {
        show: '#f59e0b',      // Giallo/arancio per spettacoli
        rehearsal: '#8b5cf6', // Viola per prove
        meeting: '#3b82f6',   // Blu per meeting
        personal: '#10b981',  // Verde per personale
        other: '#6b7280'      // Grigio per altro
    };
    return colors[type] || colors.other;
}

function selectCalendarDay(timestamp) {
    calendarDate = new Date(timestamp);
    calendarView = 'day';

    document.querySelectorAll('.cal-view-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.cal-view-btn').classList.add('active');

    document.getElementById('calDayView').style.display = 'block';
    document.getElementById('calWeekView').style.display = 'none';
    document.getElementById('calMonthView').style.display = 'none';
    document.getElementById('calAgendaView').style.display = 'none';

    renderCalendar();
}

// Vista Agenda - mostra eventi dei prossimi 14 giorni (stile Reclaim.ai)
function renderAgendaView() {
    const container = document.getElementById('agendaList');
    if (!container) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Raccogli eventi per i prossimi 14 giorni
    const agendaEvents = [];

    for (let i = 0; i < 14; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);

        // Eventi locali
        const localEvents = getEventsForDate(date).map(e => ({
            ...e,
            dateObj: date,
            isGoogle: false,
            itemType: 'event'
        }));

        // Eventi Google
        const googleEvents = (state.calendarEvents || []).filter(ge => {
            const eventDate = new Date(ge.start?.dateTime || ge.start?.date);
            return eventDate.toDateString() === date.toDateString();
        }).map(ge => ({
            id: ge.id,
            title: ge.summary || 'Evento senza titolo',
            startTime: ge.start?.dateTime ? new Date(ge.start.dateTime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'Tutto il giorno',
            endTime: ge.end?.dateTime ? new Date(ge.end.dateTime).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : '',
            location: ge.location || '',
            type: 'google',
            dateObj: date,
            isGoogle: true,
            originalEvent: ge,
            itemType: 'google'
        }));

        // Tasks con scadenza o schedulati per questo giorno (stile Reclaim.ai)
        const tasksForDate = (state.tasks || []).filter(t => {
            if (t.completed) return false;
            // Task schedulato per questa data
            if (t.scheduledTime) {
                const scheduledDate = new Date(t.scheduledTime);
                return scheduledDate.toDateString() === date.toDateString();
            }
            // Task con deadline oggi
            if (t.due) {
                const dueDate = new Date(t.due);
                return dueDate.toDateString() === date.toDateString();
            }
            return false;
        }).map(t => {
            const isScheduled = !!t.scheduledTime;
            const scheduledTime = t.scheduledTime ? new Date(t.scheduledTime) : null;
            return {
                id: t.id,
                title: t.title,
                startTime: scheduledTime ? scheduledTime.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : (t.due ? '⏰ Scadenza' : ''),
                endTime: scheduledTime && t.estimate ? new Date(scheduledTime.getTime() + t.estimate * 60000).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : '',
                type: isScheduled ? 'task-scheduled' : 'task-tentative',
                dateObj: date,
                isGoogle: false,
                isTask: true,
                priority: t.priority,
                estimate: t.estimate,
                itemType: 'task',
                originalTask: t
            };
        });

        // Habits per questo giorno della settimana
        const dayOfWeek = date.getDay();
        const habitsForDate = (state.habits || []).filter(h => {
            if (!h.active) return false;
            // Check se l'habit è per questo giorno
            if (h.frequency === 'daily') return true;
            if (h.frequency === 'weekly' && h.days && h.days.includes(dayOfWeek)) return true;
            if (h.frequency === 'weekdays' && dayOfWeek >= 1 && dayOfWeek <= 5) return true;
            return false;
        }).map(h => ({
            id: h.id,
            title: h.name || h.title,
            startTime: h.preferredTime || '🌅 Giornata',
            endTime: '',
            type: 'habit',
            dateObj: date,
            isGoogle: false,
            isHabit: true,
            itemType: 'habit',
            originalHabit: h,
            completed: isHabitCompletedForDate(h.id, date)
        }));

        agendaEvents.push(...localEvents, ...googleEvents, ...tasksForDate, ...habitsForDate);
    }

    if (agendaEvents.length === 0) {
        container.innerHTML = `
            <div class="agenda-empty">
                <div class="agenda-empty-icon">📅</div>
                <div>Nessun evento nei prossimi 14 giorni</div>
                <button class="btn btn-primary btn-sm" style="margin-top:12px;" onclick="openAddEventModal()">+ Aggiungi Evento</button>
            </div>
        `;
        return;
    }

    // Raggruppa per data
    const groupedByDate = {};
    agendaEvents.forEach(e => {
        const dateKey = e.dateObj.toDateString();
        if (!groupedByDate[dateKey]) {
            groupedByDate[dateKey] = { date: e.dateObj, events: [] };
        }
        groupedByDate[dateKey].events.push(e);
    });

    // Ordina eventi per orario all'interno di ogni giorno
    Object.values(groupedByDate).forEach(group => {
        group.events.sort((a, b) => {
            const timeA = a.startTime || '00:00';
            const timeB = b.startTime || '00:00';
            return timeA.localeCompare(timeB);
        });
    });

    let html = '';
    Object.values(groupedByDate).forEach(group => {
        const isToday = group.date.toDateString() === today.toDateString();
        const dateStr = group.date.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });

        // Conta per tipo
        const eventsCount = group.events.filter(e => e.itemType === 'event' || e.itemType === 'google').length;
        const tasksCount = group.events.filter(e => e.itemType === 'task').length;
        const habitsCount = group.events.filter(e => e.itemType === 'habit').length;

        let countLabel = '';
        if (eventsCount > 0) countLabel += `${eventsCount} eventi`;
        if (tasksCount > 0) countLabel += `${countLabel ? ' · ' : ''}${tasksCount} task`;
        if (habitsCount > 0) countLabel += `${countLabel ? ' · ' : ''}${habitsCount} habits`;

        html += `
            <div class="agenda-day-group">
                <div class="agenda-day-header ${isToday ? 'today' : ''}">
                    <span>${isToday ? '📍 Oggi - ' : ''}${dateStr}</span>
                    <span style="font-size:0.75rem; opacity:0.8;">${countLabel}</span>
                </div>
                ${group.events.map(e => renderAgendaItem(e)).join('')}
            </div>
        `;
    });

    container.innerHTML = html;
}

// Rendering singolo item nell'agenda (evento, task, o habit)
function renderAgendaItem(e) {
    const clickHandler = getAgendaItemClickHandler(e);
    const icon = getAgendaItemIcon(e);
    const badge = getAgendaItemBadge(e);
    const extraInfo = getAgendaItemExtraInfo(e);

    // Controlla se l'evento ha invitati che hanno rifiutato
    const hasDeclined = hasDeclinedAttendees(e);
    const declinedClass = hasDeclined ? 'has-declined' : '';
    const declinedInfo = hasDeclined ? getDeclinedInfo(e) : '';

    return `
        <div class="agenda-event ${e.type} ${e.isGoogle ? 'google' : ''} ${e.isTask ? 'task' : ''} ${e.isHabit ? 'habit' : ''} ${e.completed ? 'completed' : ''} ${declinedClass}"
             onclick="${clickHandler}"
             style="${e.completed ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
            <div class="agenda-event-time">
                ${e.startTime}${e.endTime ? '<br>' + e.endTime : ''}
            </div>
            <div class="agenda-event-content">
                <div class="agenda-event-title">
                    ${icon} ${e.title}${badge}
                </div>
                <div class="agenda-event-details">
                    ${e.location ? '📍 ' + e.location : ''}
                    ${extraInfo}
                    ${declinedInfo}
                </div>
            </div>
            ${e.isTask ? `<div class="agenda-event-actions" onclick="event.stopPropagation()">
                <button class="btn-icon-sm" onclick="scheduleTaskNow('${e.id}')" title="Schedula ora">📅</button>
            </div>` : ''}
        </div>
    `;
}

// Controlla se un evento ha invitati che hanno rifiutato
function hasDeclinedAttendees(event) {
    const attendees = event.attendees || event.originalEvent?.attendees || [];
    return attendees.some(att => att.responseStatus === 'declined' || att.status === 'declined');
}

// Genera info sui rifiuti
function getDeclinedInfo(event) {
    const attendees = event.attendees || event.originalEvent?.attendees || [];
    const declined = attendees.filter(att => att.responseStatus === 'declined' || att.status === 'declined');

    if (declined.length === 0) return '';

    const names = declined.map(att => att.displayName || att.email?.split('@')[0] || att.name || 'Utente').join(', ');
    return `<span class="declined-badge">❌ Rifiutato da: ${names}</span>`;
}

function getAgendaItemClickHandler(e) {
    if (e.isTask) return `showTaskDetail('${e.id}')`;
    if (e.isHabit) return `toggleHabitFromAgenda('${e.id}', '${e.dateObj.toISOString()}')`;
    return `showEventDetail('${e.id}', ${e.isGoogle})`;
}

function getAgendaItemIcon(e) {
    if (e.isGoogle) return '☁️';
    if (e.isTask) return e.type === 'task-scheduled' ? '🎯' : '📋';
    if (e.isHabit) return '✨';
    return getEventTypeIcon(e.type);
}

function getAgendaItemBadge(e) {
    if (e.isTask && e.type === 'task-tentative') {
        return `<span class="agenda-event-badge badge-tentative">Provvisorio</span>`;
    }
    if (e.isTask && e.type === 'task-scheduled') {
        return `<span class="agenda-event-badge badge-scheduled">Schedulato</span>`;
    }
    if (e.isHabit) {
        return `<span class="agenda-event-badge badge-habit">Habit</span>`;
    }
    return '';
}

function getAgendaItemExtraInfo(e) {
    let info = '';
    if (e.isTask) {
        if (e.priority) info += getPriorityBadge(e.priority);
        if (e.estimate) info += ` ⏱️ ${e.estimate}min`;
    }
    return info;
}

function getPriorityBadge(priority) {
    const badges = {
        high: '🔴 Alta',
        medium: '🟡 Media',
        low: '🟢 Bassa'
    };
    return badges[priority] || '';
}

// Controlla se un habit è stato completato per una data specifica
function isHabitCompletedForDate(habitId, date) {
    const dateKey = date.toISOString().split('T')[0];
    const habit = (state.habits || []).find(h => h.id === habitId);
    if (!habit) return false;
    return (habit.completedDates || []).includes(dateKey);
}

// Toggle habit dall'agenda
function toggleHabitFromAgenda(habitId, dateStr) {
    const date = new Date(dateStr);
    const dateKey = date.toISOString().split('T')[0];
    const habit = (state.habits || []).find(h => h.id === habitId);
    if (!habit) return;

    habit.completedDates = habit.completedDates || [];
    const index = habit.completedDates.indexOf(dateKey);

    if (index >= 0) {
        habit.completedDates.splice(index, 1);
        showToast('Habit non completato', 'info');
    } else {
        habit.completedDates.push(dateKey);
        showToast('Habit completato! ✨', 'success');
        addXP(5);
    }

    saveStateAndSync();
    renderAgendaView();
}

// Mostra dettagli task
function showTaskDetail(taskId) {
    const task = (state.tasks || []).find(t => t.id === taskId);
    if (!task) return;

    const content = `
        <div style="padding:20px;">
            <h3 style="margin-bottom:16px;">🎯 ${task.title}</h3>
            <div style="margin-bottom:12px;">
                <strong>📊 Priorità:</strong> ${getPriorityBadge(task.priority)}
            </div>
            ${task.due ? `<div style="margin-bottom:12px;"><strong>⏰ Scadenza:</strong> ${new Date(task.due).toLocaleDateString('it-IT')}</div>` : ''}
            ${task.estimate ? `<div style="margin-bottom:12px;"><strong>⏱️ Tempo stimato:</strong> ${task.estimate} minuti</div>` : ''}
            ${task.scheduledTime ? `<div style="margin-bottom:12px;"><strong>📅 Schedulato:</strong> ${new Date(task.scheduledTime).toLocaleString('it-IT')}</div>` : ''}
            ${task.notes ? `<div style="margin-bottom:12px;"><strong>📝 Note:</strong> ${task.notes}</div>` : ''}
            <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" onclick="completeTaskFromDetail('${task.id}')">✅ Completa</button>
                ${!task.scheduledTime ? `<button class="btn btn-secondary btn-sm" onclick="scheduleTaskNow('${task.id}')">📅 Schedula</button>` : ''}
                <button class="btn btn-ghost btn-sm" onclick="closeModal('customDetailModal')">Chiudi</button>
            </div>
        </div>
    `;

    showCustomModal('Dettaglio Task', content);
}

// Completa task dal dettaglio
function completeTaskFromDetail(taskId) {
    const task = (state.tasks || []).find(t => t.id === taskId);
    if (task) {
        task.completed = true;
        task.completedAt = new Date().toISOString();
        saveStateAndSync();
        closeModal('customDetailModal');
        renderAgendaView();
        renderTasks();
        showToast('Task completato! 🎉', 'success');
        addXP(10);
    }
}

// Schedula task immediatamente
async function scheduleTaskNow(taskId) {
    const task = (state.tasks || []).find(t => t.id === taskId);
    if (!task) return;

    if (!isGoogleSignedIn) {
        showToast('Connetti Google Calendar prima', 'warning');
        return;
    }

    showToast('Cercando slot libero...', 'info');

    // Trova primo slot libero oggi
    const today = new Date();
    const freeSlots = await findFreeSlots(today, task.estimate || 30);

    if (freeSlots.length === 0) {
        // Prova domani
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowSlots = await findFreeSlots(tomorrow, task.estimate || 30);

        if (tomorrowSlots.length === 0) {
            showToast('Nessuno slot libero trovato', 'warning');
            return;
        }

        await scheduleTaskToSlot(task, tomorrowSlots[0]);
    } else {
        await scheduleTaskToSlot(task, freeSlots[0]);
    }
}

async function scheduleTaskToSlot(task, slot) {
    const endTime = new Date(slot.start);
    endTime.setMinutes(endTime.getMinutes() + (task.estimate || 30));

    const event = await createCalendarEvent(
        `🎯 ${task.title}`,
        slot.start,
        endTime,
        `Task pianificato da Mago Max S.A.V.E.R.S.\n\nPriorità: ${task.priority || 'media'}\nTempo: ${task.estimate || 30} min`
    );

    if (event) {
        task.scheduledTime = slot.start.toISOString();
        task.calendarEventId = event.id;
        saveStateAndSync();
        closeModal('customDetailModal');
        renderAgendaView();
        renderTasks();
        showToast(`Task schedulato alle ${slot.start.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })}! 📅`, 'success');
    }
}

function getEventsForDate(date) {
    state.events = state.events || [];
    return state.events.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate.toDateString() === date.toDateString();
    });
}

function getEventTypeIcon(type) {
    const icons = { show: '🎭', rehearsal: '🎯', meeting: '👥', personal: '👤', other: '📌' };
    return icons[type] || '📅';
}

function getEventColor(type) {
    const colors = { show: '#f59e0b', rehearsal: '#8b5cf6', meeting: '#3b82f6', personal: '#10b981', other: '#6b7280' };
    return colors[type] || '#6b7280';
}

// Mostra dettagli evento (locale o Google)
function showEventDetail(eventId, isGoogle = false) {
    let event;

    if (isGoogle) {
        event = (state.calendarEvents || []).find(e => e.id === eventId);
        if (event) {
            showGoogleEventDetail(event);
        }
    } else {
        event = (state.events || []).find(e => e.id === eventId);
        if (event) {
            showLocalEventDetail(event);
        }
    }
}

function showLocalEventDetail(event) {
    // Usa il nuovo sistema con commenti e partecipanti
    openEventDetail(event.id, false);
}

function showGoogleEventDetail(event) {
    // Usa il nuovo sistema con commenti e partecipanti
    openEventDetail(event.id, true);
}

function showCustomModal(title, content) {
    // Usa un modal generico o crea uno dinamico
    let modal = document.getElementById('customDetailModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customDetailModal';
        modal.className = 'modal-overlay modal-center';
        modal.innerHTML = `
            <div class="modal" style="max-width:450px;">
                <div class="modal-header">
                    <div class="modal-title" id="customModalTitle"></div>
                    <button class="modal-close" onclick="closeModal('customDetailModal')">✕</button>
                </div>
                <div class="modal-body" id="customModalContent"></div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    document.getElementById('customModalTitle').textContent = title;
    document.getElementById('customModalContent').innerHTML = content;
    openModal('customDetailModal');
}

function editEvent(eventId) {
    closeModal('customDetailModal');
    const event = (state.events || []).find(e => e.id === eventId);
    if (!event) return;

    // Popola il form di modifica
    document.getElementById('eventTitle').value = event.title;
    document.getElementById('eventDate').value = event.date;
    document.getElementById('eventStartTime').value = event.startTime;
    document.getElementById('eventType').value = event.type;
    document.getElementById('eventLocation').value = event.location || '';
    document.getElementById('eventNotes').value = event.notes || '';

    // Segna che stiamo modificando
    window.editingEventId = eventId;

    openModal('addEventModal');
}

function deleteEvent(eventId) {
    if (!confirm('Eliminare questo evento?')) return;

    state.events = (state.events || []).filter(e => e.id !== eventId);
    saveStateAndSync();
    closeModal('customDetailModal');
    renderDayView();
    renderWeekView();
    renderMonthView();
    showToast('Evento eliminato', 'success');
}

// ============================================
// GOOGLE CALENDAR EVENT MANAGEMENT
// ============================================
// Nota: editingGoogleEventId è definita all'inizio del file

// Modifica evento Google Calendar
function editGoogleEvent(eventId) {
    closeModal('eventDetailModal');

    const event = (state.calendarEvents || []).find(e => e.id === eventId);
    if (!event) {
        showToast('Evento non trovato', 'error');
        return;
    }

    // Estrai data e ora dall'evento Google
    const isAllDay = !event.start?.dateTime;
    let startDate, startTime, endTime;

    if (isAllDay) {
        startDate = event.start.date;
        startTime = '09:00';
        endTime = '10:00';
    } else {
        const start = new Date(event.start.dateTime);
        const end = new Date(event.end.dateTime);
        startDate = start.toISOString().split('T')[0];
        startTime = `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}`;
        endTime = `${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;
    }

    // Popola il form
    document.getElementById('eventTitle').value = event.summary || '';
    document.getElementById('eventDate').value = startDate;
    document.getElementById('eventStartTime').value = startTime;

    const endTimeInput = document.getElementById('eventEndTime');
    if (endTimeInput) endTimeInput.value = endTime;

    document.getElementById('eventLocation').value = event.location || '';
    document.getElementById('eventNotes').value = event.description || '';

    // Imposta tipo evento (default 'other' per eventi Google)
    document.getElementById('eventType').value = 'other';

    // Segna che stiamo modificando un evento Google
    editingGoogleEventId = eventId;
    window.editingEventId = null; // Reset evento locale

    // Attiva sync Google automaticamente
    const toggle = document.getElementById('eventSyncGoogle');
    if (toggle && !toggle.classList.contains('active')) {
        toggle.classList.add('active');
    }
    const calendarGroup = document.getElementById('eventCalendarSelectGroup');
    if (calendarGroup) {
        calendarGroup.style.display = 'block';
        populateEventCalendarSelect();
    }

    openModal('addEventModal');
}

// Elimina evento Google Calendar
async function deleteGoogleEvent(eventId) {
    if (!confirm('Eliminare questo evento da Google Calendar?')) return;

    if (!isGoogleSignedIn) {
        showToast('Non connesso a Google', 'error');
        return;
    }

    try {
        await gapi.client.calendar.events.delete({
            calendarId: selectedCalendarId,
            eventId: eventId
        });

        // Rimuovi dall'array locale
        state.calendarEvents = (state.calendarEvents || []).filter(e => e.id !== eventId);

        closeModal('eventDetailModal');
        renderDayView();
        renderWeekView();
        renderMonthView();
        showToast('Evento eliminato da Google Calendar', 'success');

        // Ricarica eventi per sincronizzare
        loadCalendarEvents();

    } catch (error) {
        console.error('Errore eliminazione evento Google:', error);
        showToast('Errore eliminazione evento', 'error');

        if (error.status === 401) {
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            isGoogleSignedIn = false;
            updateGoogleUI();
        }
    }
}

// Elimina evento locale
function deleteLocalEvent(eventId) {
    const event = (state.events || []).find(e => e.id === eventId);
    if (!event) return;

    // Salva per undo
    const eventBackup = { ...event };

    state.events = (state.events || []).filter(e => e.id !== eventId);
    saveStateAndSync();

    closeModal('eventDetailModal');
    renderDayView();
    renderWeekView();
    renderMonthView();
    renderCalendar();

    // Registra azione per undo
    undoSystem.register({
        type: 'deleteEvent',
        data: eventBackup,
        message: '🗑️ Evento eliminato'
    });
}

// Aggiorna evento Google Calendar
async function updateGoogleEvent(eventId, eventData) {
    if (!isGoogleSignedIn) {
        showToast('Non connesso a Google', 'error');
        return null;
    }

    try {
        const response = await gapi.client.calendar.events.update({
            calendarId: selectedCalendarId,
            eventId: eventId,
            resource: eventData
        });

        console.log('Evento Google aggiornato:', response.result);
        return response.result;

    } catch (error) {
        console.error('Errore aggiornamento evento Google:', error);
        const errorMsg = error.result?.error?.message || 'Verifica connessione Google';
        showToast(`Errore evento: ${errorMsg}`, 'error');

        if (error.status === 401 || error.status === 403) {
            localStorage.removeItem('google_access_token');
            localStorage.removeItem('google_token_expiry');
            isGoogleSignedIn = false;
            updateGoogleUI();
        }
        return null;
    }
}

function formatGoogleEventTime(event) {
    if (event.start?.dateTime) {
        const start = new Date(event.start.dateTime);
        const end = new Date(event.end.dateTime);
        return `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')} - ${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;
    }
    return 'Tutto il giorno';
}

// ============================================
// INBOX & EVENT COMMENTS SYSTEM
// ============================================
// Nota: currentInboxFilter, currentEventId, isCurrentEventGoogle sono definite all'inizio del file

// Inizializza struttura inbox se non esiste
function initInbox() {
    if (!state.inbox) {
        state.inbox = {
            items: [],
            lastChecked: null
        };
    }
    if (!state.eventComments) {
        state.eventComments = {}; // eventId -> [comments]
    }
}

// Apre la inbox - usa i dati già in cache (caricati al login/sync)
function openInbox() {
    initInbox();
    openModal('inboxModal');
    renderInbox();
    // I dati sono già stati caricati da loadFromCloud() al login
}

// Refresh manuale inbox
async function refreshInbox() {
    const btn = document.getElementById('inboxRefreshBtn');
    if (btn) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.innerHTML = '⏳';
    }
    try {
        await loadUserNotifications();
        await loadUserTeams(); // Per aggiornare anche richieste team
        renderInbox();
        updateInboxBadge();
    } catch (err) {
        console.warn('Errore refresh inbox:', err);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.innerHTML = '🔄';
        }
    }
}

// Refresh automatico notifiche in background (ogni 5 minuti)
async function autoRefreshNotifications() {
    if (!isLoggedIn || !currentUser) return;

    try {
        const prevCount = (state.backendNotifications || []).filter(n => n.status === 'unread').length;

        await loadUserNotifications();
        await loadUserTeams();
        updateInboxBadge();

        // Se l'inbox è aperto, aggiorna la vista
        const inboxModal = document.getElementById('inboxModal');
        if (inboxModal && inboxModal.classList.contains('active')) {
            renderInbox();
        }

        // Notifica se ci sono nuove notifiche
        const newCount = (state.backendNotifications || []).filter(n => n.status === 'unread').length;
        if (newCount > prevCount) {
            const diff = newCount - prevCount;
            showToast(`📬 ${diff} nuov${diff === 1 ? 'a' : 'e'} notific${diff === 1 ? 'a' : 'he'}`, 'info');
        }

        console.log('Auto-refresh notifiche completato');
    } catch (err) {
        console.warn('Errore auto-refresh notifiche:', err);
    }
}

// Filtra inbox
function filterInbox(filter) {
    currentInboxFilter = filter;

    // Update tab styling
    document.querySelectorAll('[id^="inboxTab"]').forEach(tab => {
        tab.style.borderBottom = '2px solid transparent';
    });
    const activeTab = document.getElementById('inboxTab' + filter.charAt(0).toUpperCase() + filter.slice(1));
    if (activeTab) activeTab.style.borderBottom = '2px solid var(--primary)';

    renderInbox();
}

// Renderizza inbox
function renderInbox() {
    const container = document.getElementById('inboxList');
    if (!container) return;

    initInbox();

    // Combina inviti Google Calendar con notifiche locali
    let items = [...(state.inbox.items || [])];

    // Debug info
    console.log('📬 renderInbox - calendarEvents:', state.calendarEvents?.length || 0);
    console.log('📬 renderInbox - backendNotifications:', state.backendNotifications?.length || 0);
    console.log('📬 renderInbox - profile email:', state.profile?.email);

    // Aggiungi inviti da eventi Google Calendar che richiedono risposta
    if (state.calendarEvents) {
        state.calendarEvents.forEach(event => {
            if (event.attendees) {
                const myAttendee = event.attendees.find(a =>
                    a.self || a.email === state.profile?.email
                );
                // Debug per ogni evento con attendees
                if (myAttendee) {
                    console.log('📬 Evento con me come attendee:', event.summary, 'status:', myAttendee.responseStatus);
                }
                if (myAttendee && myAttendee.responseStatus === 'needsAction') {
                    // È un invito in attesa di risposta
                    const existingInvite = items.find(i => i.eventId === event.id && i.type === 'invite');
                    if (!existingInvite) {
                        items.push({
                            id: 'invite_' + event.id,
                            type: 'invite',
                            eventId: event.id,
                            isGoogle: true,
                            title: event.summary || 'Evento senza titolo',
                            from: event.organizer?.email || 'Organizzatore',
                            fromName: event.organizer?.displayName || event.organizer?.email || 'Organizzatore',
                            date: event.start?.dateTime || event.start?.date,
                            createdAt: event.created || new Date().toISOString(),
                            read: false
                        });
                    }
                }
            }
        });
    }

    // Aggiungi richieste di iscrizione ai team (per owner/admin)
    if (state.teams) {
        state.teams.forEach(team => {
            if ((team.myRole === 'owner' || team.myRole === 'admin') && team.pendingRequests) {
                team.pendingRequests.forEach(req => {
                    const existingReq = items.find(i => i.type === 'teamRequest' && i.teamId === team.id && i.username === req.username);
                    if (!existingReq) {
                        items.push({
                            id: 'teamreq_' + team.id + '_' + req.username,
                            type: 'teamRequest',
                            teamId: team.id,
                            teamName: team.name,
                            username: req.username,
                            email: req.email,
                            title: `Richiesta di iscrizione al team "${team.name}"`,
                            preview: `${req.username || req.email} vuole unirsi al team`,
                            createdAt: req.requestedAt || new Date().toISOString(),
                            read: false
                        });
                    }
                });
            }
        });
    }

    // Aggiungi notifiche dal backend (inviti eventi, menzioni, risposte, ecc.)
    if (state.backendNotifications) {
        state.backendNotifications.forEach(notif => {
            // Evita duplicati
            const existingNotif = items.find(i => i.backendId === notif.id);
            if (!existingNotif) {
                const isEventInvite = notif.type === 'event_invite';
                const isInviteResponse = notif.type === 'invite_response';
                const isMention = notif.type === 'mention';

                // Determina il tipo per la UI
                let itemType = 'notification';
                if (isEventInvite) itemType = 'eventInvite';
                else if (isInviteResponse) itemType = 'inviteResponse';
                else if (isMention) itemType = 'mention';

                // Parsa eventData se è stringa
                let parsedEventData = notif.eventData;
                if (typeof parsedEventData === 'string') {
                    try {
                        parsedEventData = JSON.parse(parsedEventData);
                    } catch (e) {
                        parsedEventData = {};
                    }
                }

                items.push({
                    id: 'backend_' + notif.id,
                    backendId: notif.id,
                    type: itemType,
                    title: notif.title,
                    preview: notif.message,
                    fromUsername: notif.fromUsername,
                    eventData: parsedEventData,
                    taskId: parsedEventData?.taskId,
                    projectId: parsedEventData?.projectId,
                    status: notif.status,
                    createdAt: notif.createdAt,
                    read: !!notif.readAt || notif.status === 'read',
                    responded: notif.status === 'accepted' || notif.status === 'declined'
                });
            }
        });
    }

    // Filtra per tipo
    if (currentInboxFilter === 'invites') {
        // Include sia inviti Google Calendar che inviti evento dal backend
        items = items.filter(i => (i.type === 'invite' || i.type === 'eventInvite') && !i.responded);
    } else if (currentInboxFilter === 'team') {
        items = items.filter(i => i.type === 'teamRequest');
    } else if (currentInboxFilter === 'mentions') {
        // Include menzioni dal backend non ancora lette
        items = items.filter(i => i.type === 'mention' && !i.read && i.status !== 'read');
    } else if (currentInboxFilter === 'history') {
        // Mostra solo notifiche già gestite/lette
        items = items.filter(i => i.responded || i.read || i.status === 'accepted' || i.status === 'declined' || i.status === 'read');
    } else {
        // "all" mostra solo notifiche attive (non ancora gestite/lette)
        items = items.filter(i => !i.responded && !i.read && i.status !== 'accepted' && i.status !== 'declined' && i.status !== 'read');
    }

    // Ordina per data (più recenti prima)
    items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    if (items.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding:40px;">
                <div style="font-size:3rem;margin-bottom:16px;">📭</div>
                <div class="text-muted">Nessuna notifica</div>
            </div>
        `;
        return;
    }

    container.innerHTML = items.map(item => {
        // Determina icona e classe in base al tipo
        let icon = '🔔';
        let iconClass = 'reminder';

        if (item.type === 'invite') {
            icon = '📅'; iconClass = 'invite';
        } else if (item.type === 'eventInvite') {
            icon = '📅'; iconClass = 'invite';
        } else if (item.type === 'inviteResponse') {
            icon = '✉️'; iconClass = 'mention';
        } else if (item.type === 'teamRequest') {
            icon = '👥'; iconClass = 'invite';
        } else if (item.type === 'mention') {
            icon = '💬'; iconClass = 'mention';
        }

        const timeAgo = getTimeAgo(new Date(item.createdAt));

        let actions = '';
        if (item.type === 'invite') {
            actions = `
                <div class="inbox-actions">
                    <button class="rsvp-btn accept" onclick="event.stopPropagation(); respondToInvite('${item.eventId}', 'accepted', ${item.isGoogle})">✓ Accetto</button>
                    <button class="rsvp-btn maybe" onclick="event.stopPropagation(); respondToInvite('${item.eventId}', 'tentative', ${item.isGoogle})">? Forse</button>
                    <button class="rsvp-btn decline" onclick="event.stopPropagation(); respondToInvite('${item.eventId}', 'declined', ${item.isGoogle})">✗ Rifiuto</button>
                </div>
            `;
        } else if (item.type === 'eventInvite' && item.status !== 'accepted' && item.status !== 'declined') {
            // Invito evento dal backend (non Google) - mostra pulsanti se non già risposto
            actions = `
                <div class="inbox-actions">
                    <button class="rsvp-btn accept" onclick="event.stopPropagation(); respondToBackendEventInvite('${item.backendId}', 'accepted')">✓ Accetto</button>
                    <button class="rsvp-btn decline" onclick="event.stopPropagation(); respondToBackendEventInvite('${item.backendId}', 'declined')">✗ Rifiuto</button>
                </div>
            `;
        } else if (item.type === 'teamRequest') {
            actions = `
                <div class="inbox-actions">
                    <button class="rsvp-btn accept" onclick="event.stopPropagation(); handleTeamRequestFromInbox('${item.teamId}', '${item.username}', true)">✓ Accetta</button>
                    <button class="rsvp-btn decline" onclick="event.stopPropagation(); handleTeamRequestFromInbox('${item.teamId}', '${item.username}', false)">✗ Rifiuta</button>
                </div>
            `;
        }

        // Mostra stato se già risposto
        let statusBadge = '';
        if (item.responded || item.status === 'accepted' || item.status === 'declined') {
            const statusText = item.status === 'accepted' ? '✅ Accettato' : '❌ Rifiutato';
            statusBadge = `<span style="font-size:0.75rem; color:var(--text-muted);">${statusText}</span>`;
        }

        return `
            <div class="inbox-item ${item.read ? '' : 'unread'}" onclick="openInboxItem('${item.id}')">
                <div class="inbox-icon ${iconClass}">${icon}</div>
                <div class="inbox-content">
                    <div class="inbox-title">${item.title}</div>
                    <div class="inbox-preview">
                        ${item.type === 'invite' ? `Da: ${item.fromName}` : item.type === 'eventInvite' ? `Da: ${item.fromUsername}` : item.preview || ''}
                    </div>
                    <div class="inbox-time">${timeAgo} ${statusBadge}</div>
                    ${actions}
                </div>
            </div>
        `;
    }).join('');

    // Aggiorna badge
    updateInboxBadge();
}

// Aggiorna badge inbox
function updateInboxBadge() {
    initInbox();
    const badge = document.getElementById('inboxBadge');
    if (!badge) return;

    let unreadCount = (state.inbox.items || []).filter(i => !i.read).length;

    // Conta anche inviti Google non letti
    if (state.calendarEvents) {
        state.calendarEvents.forEach(event => {
            if (event.attendees) {
                const myAttendee = event.attendees.find(a => a.self || a.email === state.profile?.email);
                if (myAttendee && myAttendee.responseStatus === 'needsAction') {
                    unreadCount++;
                }
            }
        });
    }

    // Conta richieste di iscrizione ai team (per owner/admin)
    if (state.teams) {
        state.teams.forEach(team => {
            if ((team.myRole === 'owner' || team.myRole === 'admin') && team.pendingRequests) {
                unreadCount += team.pendingRequests.length;
            }
        });
    }

    // Conta notifiche backend non lette (inviti eventi, menzioni, ecc.)
    if (state.backendNotifications) {
        state.backendNotifications.forEach(notif => {
            // Una notifica è "non letta" se:
            // - Non ha readAt E
            // - Lo status è pending, unread, o non è già accepted/declined
            const isUnread = !notif.readAt &&
                (notif.status === 'pending' || notif.status === 'unread' ||
                 (notif.status !== 'accepted' && notif.status !== 'declined'));
            if (isUnread) {
                unreadCount++;
            }
        });
    }

    console.log('📬 updateInboxBadge - unreadCount finale:', unreadCount);

    if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// Rispondi a un invito
async function respondToInvite(eventId, response, isGoogle) {
    if (isGoogle && isGoogleSignedIn) {
        try {
            // Aggiorna la risposta su Google Calendar
            const event = state.calendarEvents.find(e => e.id === eventId);
            if (event) {
                // Trova il mio attendee e aggiorna
                const myEmail = state.profile?.email || '';

                await gapi.client.calendar.events.patch({
                    calendarId: selectedCalendarId,
                    eventId: eventId,
                    sendUpdates: 'all',
                    resource: {
                        attendees: event.attendees.map(a => {
                            if (a.self || a.email === myEmail) {
                                return { ...a, responseStatus: response };
                            }
                            return a;
                        })
                    }
                });

                const responseText = response === 'accepted' ? 'Accettato' :
                                    response === 'declined' ? 'Rifiutato' : 'Forse';
                showToast(`Invito: ${responseText}! ✅`, 'success');

                // Marca come risposto nella inbox (per spostarlo nello storico)
                initInbox();
                const inboxItem = state.inbox.items.find(i => i.eventId === eventId && i.type === 'invite');
                if (inboxItem) {
                    inboxItem.responded = true;
                    inboxItem.responseStatus = response;
                    inboxItem.respondedAt = new Date().toISOString();
                    saveStateAndSync();
                }

                // Ricarica eventi
                await loadCalendarEvents();
                renderInbox();
            }
        } catch (error) {
            console.error('Errore risposta invito:', error);
            showToast('Errore nell\'invio della risposta', 'error');
        }
    } else {
        // Invito locale
        const item = state.inbox.items.find(i => i.eventId === eventId);
        if (item) {
            item.response = response;
            item.responded = true;
            item.respondedAt = new Date().toISOString();
            item.read = true;
            saveStateAndSync();
            renderInbox();
            showToast('Risposta inviata!', 'success');
        }
    }
}

// Apri elemento inbox
async function openInboxItem(itemId) {
    console.log('🔔 openInboxItem chiamato con itemId:', itemId);
    console.log('🔔 itemId type:', typeof itemId);

    initInbox();

    // Prima controlla se è una notifica backend (id inizia con 'backend_')
    if (itemId && itemId.startsWith('backend_')) {
        const backendId = itemId.replace('backend_', '');
        console.log('🔔 È una notifica backend, cercando ID:', backendId);

        const backendNotif = state.backendNotifications?.find(n => n.id === backendId);
        console.log('🔔 Notifica backend trovata:', backendNotif);

        if (backendNotif) {
            // Marca come letta nel backend
            if (state.cloudUser?.token && !backendNotif.readAt) {
                try {
                    await apiCall('markNotificationRead', { notificationId: backendId });
                    backendNotif.readAt = new Date().toISOString();
                    console.log('✅ Notifica marcata come letta');
                } catch (e) {
                    console.warn('⚠️ Errore marcando notifica come letta:', e);
                }
            }

            // Parsa eventData se necessario
            let eventData = backendNotif.eventData;
            if (typeof eventData === 'string') {
                try {
                    eventData = JSON.parse(eventData);
                } catch (e) {
                    console.warn('⚠️ Errore parsing eventData:', e);
                    eventData = {};
                }
            }
            eventData = eventData || {};

            console.log('📬 eventData:', eventData);
            console.log('📬 Tipo notifica:', backendNotif.type);

            // Naviga in base al tipo di notifica
            if (backendNotif.type === 'mention' || backendNotif.type === 'comment' || backendNotif.type === 'task_comment') {
                if (eventData.taskId && eventData.projectId) {
                    console.log('🎯 Navigando al task:', eventData.taskId, 'progetto:', eventData.projectId);
                    closeModal('inboxModal');
                    await navigateToTaskComment(eventData.projectId, eventData.taskId);
                    return;
                }
                if (eventData.eventId) {
                    console.log('🎯 Navigando all\'evento:', eventData.eventId);
                    closeModal('inboxModal');
                    // Passa anche i dati della notifica per eventi condivisi non locali
                    openEventDetailWithFallback(eventData.eventId, eventData, backendNotif);
                    return;
                }
            }

            if (backendNotif.type === 'event_invite' || backendNotif.type === 'invite_response') {
                if (eventData.eventId) {
                    console.log('🎯 Navigando all\'evento:', eventData.eventId);
                    closeModal('inboxModal');
                    // Passa anche i dati della notifica per eventi condivisi non locali
                    openEventDetailWithFallback(eventData.eventId, eventData, backendNotif);
                    return;
                }
            }

            // Fallback: se ha taskId e projectId
            if (eventData.taskId && eventData.projectId) {
                console.log('🎯 Fallback - Navigando al task:', eventData.taskId);
                closeModal('inboxModal');
                await navigateToTaskComment(eventData.projectId, eventData.taskId);
                return;
            }

            console.warn('⚠️ Notifica senza destinazione navigabile:', backendNotif);
            showToast('Notifica aperta', 'info');
            renderInbox();
            updateInboxBadge();
            return;
        }
    }

    // Cerca negli items locali dell'inbox
    const item = state.inbox.items?.find(i => i.id === itemId);

    if (item) {
        console.log('📬 Item trovato in inbox.items:', item);
        item.read = true;
        saveStateAndSync();

        // Se ha taskId e projectId direttamente (dalla renderInbox migliorata)
        if (item.taskId && item.projectId) {
            console.log('🎯 Navigando direttamente al task da item:', item.taskId);
            closeModal('inboxModal');
            await navigateToTaskComment(item.projectId, item.taskId);
            return;
        }

        if (item.eventId) {
            closeModal('inboxModal');
            openEventDetail(item.eventId, item.isGoogle);
            return;
        }
    }

    // Se è un invito Google, apri dettaglio evento
    if (itemId && itemId.startsWith('invite_')) {
        const eventId = itemId.replace('invite_', '');
        console.log('🎯 Aprendo invito Google evento:', eventId);
        closeModal('inboxModal');
        openEventDetail(eventId, true);
        return;
    }

    // Se è una richiesta team
    if (itemId && itemId.startsWith('teamreq_')) {
        console.log('🎯 Richiesta team, apro pannello team');
        closeModal('inboxModal');
        switchPage('team');
        return;
    }

    console.warn('⚠️ Item non trovato o tipo sconosciuto:', itemId);
    renderInbox();
}

// Naviga al task e apre il modale commenti
async function navigateToTaskComment(projectId, taskId) {
    console.log('📍 navigateToTaskComment chiamato');
    console.log('  - projectId ricevuto:', projectId);
    console.log('  - taskId ricevuto:', taskId);

    if (!projectId || !taskId) {
        console.error('❌ navigateToTaskComment: projectId o taskId mancante');
        showToast('Dati notifica incompleti', 'error');
        return;
    }

    // Rimuovi eventuale prefisso shared_ per la ricerca
    const cleanProjectId = projectId.replace('shared_', '');
    let targetProjectId = projectId;
    let project = null;

    console.log('  - cleanProjectId:', cleanProjectId);

    // 1. Cerca nei progetti propri
    project = state.teamProjects?.find(p => p.id === cleanProjectId || p.id === projectId);
    if (project) {
        targetProjectId = project.id;
        console.log('  ✅ Trovato nei progetti propri:', project.name);
    }

    // 2. Cerca nei progetti condivisi
    if (!project) {
        project = state.sharedProjects?.find(p => p.id === cleanProjectId);
        if (project) {
            targetProjectId = 'shared_' + cleanProjectId;
            console.log('  ✅ Trovato nei progetti condivisi:', project.name);
        }
    }

    // 3. Se non trovato, ricarica i progetti e riprova
    if (!project) {
        console.log('  ⏳ Progetto non trovato, ricaricamento...');
        showToast('Caricamento progetto...', 'info');

        // Ricarica progetti
        await loadSharedProjects();

        // Riprova nei propri
        project = state.teamProjects?.find(p => p.id === cleanProjectId || p.id === projectId);
        if (project) {
            targetProjectId = project.id;
        }

        // Riprova nei condivisi
        if (!project) {
            project = state.sharedProjects?.find(p => p.id === cleanProjectId);
            if (project) {
                targetProjectId = 'shared_' + cleanProjectId;
            }
        }
    }

    if (!project) {
        console.error('❌ Progetto non trovato dopo ricaricamento');
        showToast('Progetto non trovato. Potresti non avere più accesso.', 'warning');
        return;
    }

    console.log('  🎯 Navigando a progetto:', targetProjectId, '- task:', taskId);
    showToast('Aprendo task...', 'info');

    // Chiudi eventuali modali aperti
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));

    // Naviga alla sezione TEAM
    switchPage('team');

    // Attendi che la sezione sia visibile, poi carica il progetto
    setTimeout(async () => {
        console.log('  📂 Caricando progetto:', targetProjectId);

        // Carica il progetto
        loadTeamProject(targetProjectId);

        // Aggiorna il selettore
        const select = document.getElementById('teamProjectSelect');
        if (select) {
            select.value = targetProjectId;
            console.log('  ✅ Selettore aggiornato');
        }

        // Attendi che il progetto sia caricato, poi apri il task
        setTimeout(() => {
            console.log('  📂 Aprendo task:', taskId);

            // Verifica che il task esista
            const currentProject = getProjectById(targetProjectId);
            const task = currentProject?.columns?.tasks?.find(t => t.id === taskId);

            if (task) {
                console.log('  ✅ Task trovato:', task.title);
                openEditTeamTask(taskId);
            } else {
                console.error('  ❌ Task non trovato nel progetto');
                showToast('Task non trovato nel progetto', 'error');
            }
        }, 800);
    }, 500);
}

// Helper: Ottiene l'ID universale per i commenti (condiviso tra tutti i partecipanti)
// Strategia: iCalUID > recurringEventId > hash(summary+startTime+organizer)
function getEventCommentId(event, isGoogle) {
    if (!event) return null;

    if (isGoogle) {
        // PRIORITÀ 1: iCalUID - identico per tutti i partecipanti
        if (event.iCalUID) {
            console.log('🔑 getEventCommentId usando iCalUID:', event.iCalUID);
            return event.iCalUID;
        }

        // PRIORITÀ 2: recurringEventId - per eventi ricorrenti
        if (event.recurringEventId) {
            console.log('🔑 getEventCommentId usando recurringEventId:', event.recurringEventId);
            return event.recurringEventId;
        }

        // PRIORITÀ 3: Genera un ID universale basato sui dati condivisi dell'evento
        // Tutti i partecipanti vedono lo stesso: titolo, data/ora inizio, organizzatore
        const summary = (event.summary || 'untitled').trim().toLowerCase();
        const startTime = event.start?.dateTime || event.start?.date || '';
        const organizer = event.organizer?.email || event.creator?.email || '';

        // Crea un hash semplice ma deterministico
        const dataString = `${summary}|${startTime}|${organizer}`;
        const universalId = 'evt_' + simpleHash(dataString);

        console.log('🔑 getEventCommentId generato hash:', {
            summary: summary,
            startTime: startTime,
            organizer: organizer,
            universalId: universalId
        });

        return universalId;
    } else {
        // Per eventi locali, usa semplicemente l'id
        return event.id;
    }
}

// Hash semplice e deterministico per generare ID universali
function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    // Converti in stringa esadecimale positiva
    return Math.abs(hash).toString(16);
}

/**
 * Apri dettaglio evento con fallback per eventi condivisi non locali
 * Se l'evento non è trovato localmente, usa i dati dalla notifica
 */
function openEventDetailWithFallback(eventId, eventData, notificationData) {
    console.log('🔍 openEventDetailWithFallback:', { eventId, eventData, notificationData });

    // Cerca prima localmente (eventi Google o locali)
    let event = state.calendarEvents?.find(e => e.id === eventId);
    let isGoogle = !!event;

    if (!event) {
        event = state.events?.find(e => e.id === eventId);
        isGoogle = false;
    }

    // Se trovato localmente, usa la funzione standard
    if (event) {
        console.log('✅ Evento trovato localmente');
        openEventDetail(eventId, isGoogle);
        return;
    }

    // Evento non trovato localmente - usa i dati dalla notifica
    console.log('⚠️ Evento non trovato localmente, uso dati notifica');

    currentEventId = eventId;
    isCurrentEventGoogle = false; // Trattiamo come evento condiviso
    currentEventCommentId = eventId; // Usa l'eventId per i commenti

    // Popola header
    const titleEl = document.getElementById('eventDetailTitle');
    titleEl.textContent = `📅 ${eventData.eventTitle || 'Evento condiviso'}`;

    // Popola contenuto con info dalla notifica
    const contentEl = document.getElementById('eventDetailContent');
    const fromUser = notificationData?.fromUsername || 'Un utente';
    const commentText = eventData.commentText || '';

    contentEl.innerHTML = `
        <div class="shared-event-notice" style="background: var(--primary-light, #e3f2fd); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
            <strong>📤 Evento condiviso</strong>
            <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: var(--text-muted, #666);">
                Questo evento appartiene a un altro utente. Puoi visualizzare e commentare.
            </p>
        </div>
        ${eventData.eventTitle ? `<div style="margin-bottom:12px;"><strong>📌 Titolo:</strong> ${eventData.eventTitle}</div>` : ''}
        ${commentText ? `<div style="margin-bottom:12px;"><strong>💬 Ultimo commento di ${fromUser}:</strong><br/><span style="font-style:italic;">"${commentText}"</span></div>` : ''}
    `;

    // Popola partecipanti (vuoto per eventi condivisi non locali)
    const attendeesContainer = document.getElementById('eventAttendeesList');
    if (attendeesContainer) {
        attendeesContainer.innerHTML = '<div class="text-muted" style="font-size:0.85rem;">Partecipanti non disponibili</div>';
    }

    // Carica commenti dal cloud
    console.log('📬 Caricamento commenti con ID:', eventId);
    loadEventCommentsFromCloud(eventId).then(() => {
        renderEventComments(eventId);
    });

    // Footer - solo visualizzazione per eventi condivisi non locali
    const footerEl = document.getElementById('eventDetailFooter');
    footerEl.innerHTML = `
        <span class="text-muted" style="margin-right:auto;font-size:0.8rem;">👤 Evento di un altro utente</span>
        <button class="btn btn-secondary" onclick="closeModal('eventDetailModal')">Chiudi</button>
    `;

    closeModal('inboxModal');
    openModal('eventDetailModal');
}

// Apri dettaglio evento con commenti
function openEventDetail(eventId, isGoogle = false) {
    currentEventId = eventId;
    isCurrentEventGoogle = isGoogle;

    // DEBUG: Log ID evento per confronto tra dispositivi
    console.log('🔍 DEBUG openEventDetail:', {
        eventId: eventId,
        eventIdLength: eventId?.length,
        isGoogle: isGoogle,
        firstChars: eventId?.substring(0, 20),
        lastChars: eventId?.substring(eventId.length - 20)
    });

    let event;
    if (isGoogle) {
        event = state.calendarEvents?.find(e => e.id === eventId);
    } else {
        event = state.events?.find(e => e.id === eventId);
    }

    if (!event) {
        showToast('Evento non trovato', 'error');
        return;
    }

    // Ottieni l'ID universale per i commenti
    currentEventCommentId = getEventCommentId(event, isGoogle);
    console.log('🔑 ID commenti evento:', currentEventCommentId);

    // DEBUG: Log dettagli evento
    console.log('🔍 DEBUG evento trovato:', {
        id: event.id,
        summary: event.summary || event.title,
        recurringEventId: event.recurringEventId,
        iCalUID: event.iCalUID
    });

    // Popola header
    const titleEl = document.getElementById('eventDetailTitle');
    titleEl.textContent = isGoogle ? `☁️ ${event.summary || 'Evento'}` : `📅 ${event.title}`;

    // Popola contenuto
    const contentEl = document.getElementById('eventDetailContent');
    if (isGoogle) {
        const start = event.start?.dateTime ? new Date(event.start.dateTime) : new Date(event.start.date);
        contentEl.innerHTML = `
            <div style="margin-bottom:12px;">
                <strong>📅 Data:</strong> ${start.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
            </div>
            <div style="margin-bottom:12px;">
                <strong>⏰ Orario:</strong> ${formatGoogleEventTime(event)}
            </div>
            ${event.location ? `<div style="margin-bottom:12px;"><strong>📍 Luogo:</strong> ${event.location}</div>` : ''}
            ${event.description ? `<div style="margin-bottom:12px;"><strong>📝 Note:</strong> ${event.description}</div>` : ''}
        `;
    } else {
        contentEl.innerHTML = `
            <div style="margin-bottom:12px;">
                <strong>📅 Data:</strong> ${new Date(event.date).toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' })}
            </div>
            <div style="margin-bottom:12px;">
                <strong>⏰ Orario:</strong> ${event.startTime || 'N/D'}
            </div>
            ${event.location ? `<div style="margin-bottom:12px;"><strong>📍 Luogo:</strong> ${event.location}</div>` : ''}
            ${event.notes ? `<div style="margin-bottom:12px;"><strong>📝 Note:</strong> ${event.notes}</div>` : ''}
        `;
    }

    // Popola partecipanti
    renderEventAttendees(event, isGoogle);

    // Carica commenti dal cloud usando l'ID universale (iCalUID per eventi condivisi)
    const commentId = currentEventCommentId || eventId;
    console.log('📬 Caricamento commenti con ID:', commentId);
    loadEventCommentsFromCloud(commentId).then(() => {
        renderEventComments(commentId);
    });

    // Footer con azioni
    const footerEl = document.getElementById('eventDetailFooter');

    // Verifica se l'utente è il proprietario/organizzatore dell'evento
    const myEmail = state.profile?.email?.toLowerCase();
    let isOwner = false;

    if (isGoogle) {
        // Per eventi Google, controlla se l'organizer sono io o se sono "self"
        const organizerEmail = event.organizer?.email?.toLowerCase();
        isOwner = event.organizer?.self ||
                  organizerEmail === myEmail ||
                  event.creator?.email?.toLowerCase() === myEmail;
    } else {
        // Per eventi locali, l'utente corrente è sempre il proprietario
        isOwner = true;
    }

    if (isGoogle) {
        if (isOwner) {
            // Proprietario: può modificare e eliminare
            footerEl.innerHTML = `
                <button class="btn btn-danger btn-sm" onclick="deleteGoogleEvent('${eventId}')" style="margin-right:auto;">🗑️ Elimina</button>
                <button class="btn btn-secondary" onclick="closeModal('eventDetailModal')">Chiudi</button>
                <button class="btn btn-primary" onclick="editGoogleEvent('${eventId}');closeModal('eventDetailModal');">✏️ Modifica</button>
            `;
        } else {
            // Partecipante: può solo commentare e chiudere
            footerEl.innerHTML = `
                <span class="text-muted" style="margin-right:auto;font-size:0.8rem;">👤 Sei un partecipante</span>
                <button class="btn btn-secondary" onclick="closeModal('eventDetailModal')">Chiudi</button>
            `;
        }
    } else {
        // Eventi locali: sempre proprietario
        footerEl.innerHTML = `
            <button class="btn btn-danger btn-sm" onclick="deleteLocalEvent('${eventId}')" style="margin-right:auto;">🗑️ Elimina</button>
            <button class="btn btn-secondary" onclick="closeModal('eventDetailModal')">Chiudi</button>
            <button class="btn btn-primary" onclick="editEvent('${eventId}');closeModal('eventDetailModal');">✏️ Modifica</button>
        `;
    }

    closeModal('inboxModal');
    openModal('eventDetailModal');
}

// Renderizza partecipanti evento
function renderEventAttendees(event, isGoogle) {
    const container = document.getElementById('eventAttendeesList');
    if (!container) return;

    let attendees = [];

    if (isGoogle && event.attendees) {
        attendees = event.attendees;
    } else if (!isGoogle && event.attendees) {
        attendees = event.attendees;
    }

    if (attendees.length === 0) {
        container.innerHTML = '<div class="text-muted" style="font-size:0.85rem;">Nessun partecipante</div>';
        return;
    }

    container.innerHTML = attendees.map(att => {
        const name = att.displayName || att.email?.split('@')[0] || att.name || 'Partecipante';
        const initial = name.charAt(0).toUpperCase();
        const status = att.responseStatus || att.status || 'pending';
        const statusClass = status === 'accepted' ? 'accepted' :
                           status === 'declined' ? 'declined' :
                           status === 'tentative' ? 'tentative' : 'pending';
        const statusIcon = status === 'accepted' ? '✓' :
                          status === 'declined' ? '✗' :
                          status === 'tentative' ? '?' : '•';

        return `
            <div class="attendee-chip ${statusClass}">
                <span class="attendee-avatar">${initial}</span>
                <span>${name}</span>
                <span>${statusIcon}</span>
            </div>
        `;
    }).join('');
}

// Renderizza commenti evento
function renderEventComments(eventId) {
    initInbox();
    const container = document.getElementById('eventCommentsList');
    if (!container) return;

    const comments = state.eventComments[eventId] || [];

    if (comments.length === 0) {
        container.innerHTML = '<div class="text-muted" style="font-size:0.85rem;padding:8px 0;">Nessun commento ancora. Sii il primo!</div>';
        return;
    }

    container.innerHTML = comments.map(comment => {
        const timeAgo = getTimeAgo(new Date(comment.createdAt));
        const initial = (comment.authorName || 'U').charAt(0).toUpperCase();

        // Evidenzia menzioni
        let text = comment.text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');

        return `
            <div class="comment-item">
                <div class="comment-avatar">${initial}</div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-author">${comment.authorName || 'Anonimo'}</span>
                        <span class="comment-time">${timeAgo}</span>
                    </div>
                    <div class="comment-text">${text}</div>
                </div>
            </div>
        `;
    }).join('');
}

// ============================================
// AUTOCOMPLETE MENZIONI (@) - PER EVENTI
// ============================================

// Nota: getMentionableUsers(project) per i Task del Team è definita nella sezione TEAMS
// Questa funzione è specifica per gli eventi del calendario
function getMentionableUsersForEvent() {
    // Combina: membri dei miei team + partecipanti evento corrente + team members legacy
    const users = [];
    const seenEmails = new Set();
    const myEmail = (currentUser?.email || state.profile?.email || '').toLowerCase();

    // 1. PRIORITÀ: Membri dei team a cui appartengo
    (state.teams || []).forEach(team => {
        const isMember = team.members?.some(m => m.email?.toLowerCase() === myEmail);
        if (isMember) {
            (team.members || []).forEach(m => {
                if (m.email && !seenEmails.has(m.email.toLowerCase())) {
                    seenEmails.add(m.email.toLowerCase());
                    users.push({
                        name: m.name || m.email.split('@')[0],
                        email: m.email,
                        username: m.username || m.email.split('@')[0],
                        teamName: team.name,
                        role: m.role
                    });
                }
            });
        }
    });

    // 2. Partecipanti dell'evento corrente (se Google)
    if (isCurrentEventGoogle && currentEventId) {
        const event = state.calendarEvents?.find(e => e.id === currentEventId);
        if (event?.attendees) {
            event.attendees.forEach(att => {
                if (att.email && !seenEmails.has(att.email.toLowerCase())) {
                    seenEmails.add(att.email.toLowerCase());
                    users.push({
                        name: att.displayName || att.email.split('@')[0],
                        email: att.email,
                        username: att.email.split('@')[0],
                        source: 'evento'
                    });
                }
            });
        }
    }

    // Escludi me stesso dalla lista
    return users.filter(u => u.email?.toLowerCase() !== myEmail);
}

// Questa funzione è per i commenti degli EVENTI del calendario
function checkEventMentionAutocomplete(input) {
    const value = input.value;
    const cursorPos = input.selectionStart;
    const textBeforeCursor = value.substring(0, cursorPos);

    // Trova l'ultima @ prima del cursore
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');

    if (lastAtIndex === -1) {
        hideEventMentionAutocomplete();
        return;
    }

    // Verifica che @ sia preceduto da spazio o sia all'inizio
    if (lastAtIndex > 0 && textBeforeCursor[lastAtIndex - 1] !== ' ') {
        hideEventMentionAutocomplete();
        return;
    }

    // Estrai il termine di ricerca dopo @
    const searchTerm = textBeforeCursor.substring(lastAtIndex + 1).toLowerCase();

    // Non mostrare se c'è uno spazio dopo il termine (menzione completata)
    if (searchTerm.includes(' ')) {
        hideEventMentionAutocomplete();
        return;
    }

    // Filtra utenti (usa la versione per eventi)
    const users = getMentionableUsersForEvent();
    mentionMatches = users.filter(u =>
        u.name.toLowerCase().includes(searchTerm) ||
        u.email.toLowerCase().includes(searchTerm) ||
        (u.username && u.username.toLowerCase().includes(searchTerm))
    ).slice(0, 5); // Max 5 risultati

    if (mentionMatches.length === 0) {
        hideEventMentionAutocomplete();
        return;
    }

    mentionSelectedIndex = 0;
    renderEventMentionAutocomplete();
}

// Nota: queste funzioni sono per i commenti degli EVENTI del calendario
// Le funzioni per i commenti dei TASK del team sono nella sezione TEAMS

function renderEventMentionAutocomplete() {
    const container = document.getElementById('eventMentionAutocomplete');
    if (!container || mentionMatches.length === 0) return;

    container.innerHTML = mentionMatches.map((user, index) => {
        const initial = user.name.charAt(0).toUpperCase();
        const selected = index === mentionSelectedIndex ? 'selected' : '';
        const teamBadge = user.teamName ? `<span style="font-size:0.65rem; background:rgba(255,255,255,0.3); color:inherit; padding:1px 4px; border-radius:3px; margin-left:4px;">${user.teamName}</span>` : '';
        const roleBadge = user.role === 'owner' ? '<span style="font-size:0.65rem; margin-left:2px;">👑</span>' : '';

        return `
            <div class="mention-item ${selected}"
                 data-index="${index}"
                 onmousedown="event.preventDefault(); selectEventMention(${index});"
                 onmouseenter="mentionSelectedIndex = ${index}; updateMentionHighlight();">
                <div class="mention-avatar" style="${user.role === 'owner' ? 'background:var(--primary-dark);' : ''}">${initial}</div>
                <div class="mention-info">
                    <div class="mention-name">${user.name}${roleBadge}${teamBadge}</div>
                    <div class="mention-email">${user.email}</div>
                </div>
            </div>
        `;
    }).join('');

    container.style.display = 'block';
    container.classList.add('visible');
}

// Helper per aggiornare solo l'highlight senza re-render completo
function updateMentionHighlight() {
    const container = document.getElementById('eventMentionAutocomplete');
    if (!container) return;

    const items = container.querySelectorAll('.mention-item');
    items.forEach((item, i) => {
        item.classList.toggle('selected', i === mentionSelectedIndex);
    });
}

function hideEventMentionAutocomplete() {
    const container = document.getElementById('eventMentionAutocomplete');
    if (container) {
        container.style.display = 'none';
        container.classList.remove('visible');
    }
    mentionMatches = [];
}

function selectEventMention(index) {
    const user = mentionMatches[index];
    if (!user) {
        console.warn('⚠️ selectEventMention: user non trovato per index', index);
        return;
    }

    const input = document.getElementById('eventCommentInput');
    if (!input) {
        console.warn('⚠️ selectEventMention: input non trovato');
        return;
    }

    const value = input.value;
    const cursorPos = input.selectionStart;
    const textBeforeCursor = value.substring(0, cursorPos);
    const textAfterCursor = value.substring(cursorPos);

    // Trova l'ultima @ prima del cursore
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');

    if (lastAtIndex === -1) {
        console.warn('⚠️ selectEventMention: @ non trovata');
        hideEventMentionAutocomplete();
        return;
    }

    // Usa username per la menzione (più affidabile per le notifiche)
    const mentionName = user.username || user.name;

    // Sostituisci @termine con @NomeUtente
    const newText = textBeforeCursor.substring(0, lastAtIndex) + '@' + mentionName + ' ' + textAfterCursor;
    input.value = newText;

    // Posiziona il cursore dopo il nome + spazio
    const newCursorPos = lastAtIndex + mentionName.length + 2;

    // Nascondi prima l'autocomplete
    hideEventMentionAutocomplete();

    // Poi focus e posiziona cursore (usa setTimeout per garantire il focus)
    setTimeout(() => {
        input.focus();
        input.setSelectionRange(newCursorPos, newCursorPos);
    }, 10);

    console.log('✅ Menzione inserita:', '@' + mentionName);
}

// Handler per tastiera nelle menzioni degli eventi calendario
function handleEventMentionKeydown(event) {
    const container = document.getElementById('eventMentionAutocomplete');
    if (!container || container.style.display === 'none' || mentionMatches.length === 0) {
        return;
    }

    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            mentionSelectedIndex = (mentionSelectedIndex + 1) % mentionMatches.length;
            renderEventMentionAutocomplete();
            break;
        case 'ArrowUp':
            event.preventDefault();
            mentionSelectedIndex = (mentionSelectedIndex - 1 + mentionMatches.length) % mentionMatches.length;
            renderEventMentionAutocomplete();
            break;
        case 'Enter':
        case 'Tab':
            event.preventDefault();
            selectEventMention(mentionSelectedIndex);
            break;
        case 'Escape':
            hideEventMentionAutocomplete();
            break;
    }
}

// Aggiungi commento a evento
function addEventComment() {
    if (!currentEventId) return;

    const input = document.getElementById('eventCommentInput');
    const text = input.value.trim();
    if (!text) return;

    initInbox();

    // Usa l'ID universale per i commenti (iCalUID per eventi condivisi)
    const commentId = currentEventCommentId || currentEventId;
    console.log('💬 Aggiunta commento con ID:', commentId);

    if (!state.eventComments[commentId]) {
        state.eventComments[commentId] = [];
    }

    const authorName = currentUser?.nickname || state.profile?.name || state.profile?.stageName || 'Tu';
    const authorEmail = state.profile?.email || state.cloudUser?.email || null;

    const comment = {
        id: 'comment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        text: text,
        authorId: state.profile?.googleId || currentUser?.username || 'local',
        authorName: authorName,
        authorEmail: authorEmail,
        createdAt: new Date().toISOString()
    };

    state.eventComments[commentId].push(comment);

    // Salva commenti evento su Google Sheets usando l'ID universale
    saveEventCommentsToCloud(commentId);

    // Cerca menzioni e invia notifiche
    const mentions = extractMentions(text);
    if (mentions.length > 0) {
        // Trova info evento
        const event = isCurrentEventGoogle ?
            state.calendarEvents?.find(e => e.id === currentEventId) :
            state.events?.find(e => e.id === currentEventId);

        sendEventMentionNotifications(mentions, event, currentEventId, text, authorName);
    }

    saveStateAndSync();
    input.value = '';
    renderEventComments(commentId);

    // Riproduci suono per conferma
    showToast('Commento aggiunto!', 'success');
}

// Salva i commenti evento su Google Sheets
async function saveEventCommentsToCloud(eventId) {
    if (!isLoggedIn || !currentUser?.token) {
        console.log('⚠️ saveEventCommentsToCloud: utente non loggato');
        return;
    }

    try {
        const comments = state.eventComments[eventId] || [];
        console.log('💾 Salvataggio commenti evento:', eventId, '- commenti:', comments.length);
        const response = await apiCall('saveEventComments', {
            eventId: eventId,
            comments: comments
        });
        if (response.success) {
            console.log('✅ Commenti evento salvati su cloud');
        } else {
            console.warn('⚠️ Salvataggio commenti fallito:', response.message);
        }
    } catch (error) {
        console.error('❌ Errore salvataggio commenti evento:', error);
    }
}

// Carica i commenti evento da Google Sheets
async function loadEventCommentsFromCloud(eventId) {
    // Verifica che l'utente sia loggato
    if (!isLoggedIn || !currentUser?.token) {
        console.log('⚠️ loadEventCommentsFromCloud: utente non loggato');
        return;
    }

    try {
        console.log('📬 Caricamento commenti per evento:', eventId);
        const response = await apiCall('loadEventComments', {
            eventId: eventId
        });

        console.log('📬 Risposta loadEventComments:', response);

        if (response.success) {
            // Inizializza se necessario
            initInbox();

            const cloudComments = response.comments || [];
            const localComments = state.eventComments[eventId] || [];

            console.log(`📬 Commenti cloud: ${cloudComments.length}, locali: ${localComments.length}`);

            // Se ci sono commenti nel cloud, usali come base
            if (cloudComments.length > 0) {
                // Trova commenti locali che non sono nel cloud (appena aggiunti)
                const cloudIds = new Set(cloudComments.map(c => c.id));
                const newLocalComments = localComments.filter(c => !cloudIds.has(c.id));

                // Combina: cloud + nuovi locali
                state.eventComments[eventId] = [...cloudComments, ...newLocalComments];
                console.log(`✅ Commenti evento caricati: ${cloudComments.length} dal cloud, ${newLocalComments.length} locali`);
            } else {
                // Nessun commento nel cloud - mantieni quelli locali se esistono
                if (localComments.length === 0) {
                    state.eventComments[eventId] = [];
                }
                console.log('📬 Nessun commento nel cloud, mantenuti locali:', localComments.length);
            }
        } else {
            console.warn('⚠️ loadEventComments fallito:', response.message);
        }
    } catch (error) {
        console.error('❌ Errore caricamento commenti evento:', error);
    }
}

// Invia notifiche per menzioni negli eventi
async function sendEventMentionNotifications(mentions, event, eventId, commentText, authorName) {
    if (!state.cloudUser?.token) return;

    const eventTitle = event?.summary || event?.title || 'Evento';
    const eventDate = event?.date || event?.start?.dateTime?.split('T')[0] || '';

    // Ottieni lista partecipanti per trovare email delle menzioni
    const attendees = event?.attendees || [];
    const teamMembers = getAllTeamMembers();

    for (const mention of mentions) {
        // Cerca l'utente menzionato
        let mentionedUser = teamMembers.find(m =>
            m.username?.toLowerCase() === mention ||
            m.nickname?.toLowerCase() === mention ||
            m.name?.toLowerCase() === mention
        );

        // Cerca anche tra i partecipanti dell'evento
        if (!mentionedUser) {
            mentionedUser = attendees.find(a =>
                a.displayName?.toLowerCase() === mention ||
                a.email?.toLowerCase().split('@')[0] === mention
            );
        }

        if (mentionedUser && mentionedUser.email) {
            // Non notificare se stesso
            if (mentionedUser.email.toLowerCase() === state.cloudUser.email?.toLowerCase()) continue;

            try {
                await apiCall('sendMentionNotification', {
                    toEmail: mentionedUser.email,
                    fromUsername: authorName,
                    eventId: eventId,
                    eventTitle: eventTitle,
                    eventDate: eventDate,
                    commentText: commentText.substring(0, 100) // Troncato per la notifica
                });
                console.log(`📧 Notifica menzione evento inviata a @${mention}`);
            } catch (error) {
                console.error('Errore invio notifica menzione evento:', error);
            }
        }
    }
}

// Invia notifica menzione all'utente menzionato (via backend)
async function addMentionNotification(eventId, mentionedUsername, commentText) {
    const event = isCurrentEventGoogle ?
        state.calendarEvents?.find(e => e.id === eventId) :
        state.events?.find(e => e.id === eventId);

    const eventTitle = event?.summary || event?.title || 'Evento';
    const fromUser = currentUser?.nickname || currentUser?.username || 'Qualcuno';

    try {
        // Invia notifica al backend per l'utente menzionato
        const response = await apiCall('sendMentionNotification', {
            mentionedUsername: mentionedUsername,
            eventId: eventId,
            eventTitle: eventTitle,
            commentText: commentText,
            fromUsername: currentUser?.username,
            fromNickname: fromUser
        });

        if (response.success) {
            console.log(`📢 Notifica menzione inviata a @${mentionedUsername}`);
        } else {
            console.warn('Menzione non inviata:', response.message);
        }
    } catch (error) {
        console.error('Errore invio notifica menzione:', error);
    }
}

// Utility: tempo trascorso
// Nota: funzione getTimeAgo principale è definita nella sezione BACHECA ATTIVITÀ
// Questa è una versione alternativa per eventi che accetta Date object
function getTimeAgoFromDate(date) {
    if (!date) return '';
    // Converte in Date se è una stringa
    const dateObj = date instanceof Date ? date : new Date(date);
    if (isNaN(dateObj.getTime())) return '';

    const seconds = Math.floor((new Date() - dateObj) / 1000);

    if (seconds < 60) return 'Ora';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} min fa`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} ore fa`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)} giorni fa`;

    return dateObj.toLocaleDateString('it-IT');
}

// Invia invito a evento (per eventi locali)
function inviteToEvent(eventId, emails) {
    initInbox();

    const event = state.events?.find(e => e.id === eventId);
    if (!event) return;

    if (!event.attendees) event.attendees = [];

    emails.forEach(email => {
        // Aggiungi partecipante all'evento
        event.attendees.push({
            email: email,
            name: email.split('@')[0],
            status: 'pending',
            invitedAt: new Date().toISOString()
        });
    });

    saveStateAndSync();
    showToast(`Invito inviato a ${emails.length} persona/e`, 'success');
}

// Seleziona department (Vita/Lavoro) nel form evento
function selectEventDepartment(dept) {
    // Aggiorna bottoni
    document.querySelectorAll('.dept-select-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.dept === dept) {
            btn.classList.add('active');
        }
    });

    // Aggiorna hidden input
    const input = document.getElementById('eventDepartment');
    if (input) input.value = dept;
}

// Apri modal evento (verifica connessione Google prima)
function openAddEventModal() {
    if (!isGoogleSignedIn) {
        showToast('🔗 Connettiti a Google per creare eventi', 'info');
        handleGoogleSignIn();
        return;
    }
    openModal('addEventModal');
}

// Toggle sincronizzazione Google nel form evento
function toggleEventGoogleSync() {
    const toggle = document.getElementById('eventSyncGoogle');
    const calendarGroup = document.getElementById('eventCalendarSelectGroup');

    toggle.classList.toggle('active');

    if (toggle.classList.contains('active')) {
        // Mostra selettore calendario e popola
        calendarGroup.style.display = 'block';
        populateEventCalendarSelect();
    } else {
        calendarGroup.style.display = 'none';
    }
}

// Popola il selettore calendari nel form evento
function populateEventCalendarSelect() {
    const select = document.getElementById('eventCalendarSelect');
    if (!select) return;

    select.innerHTML = '<option value="">-- Seleziona calendario --</option>';

    if (userCalendars.length === 0) {
        select.innerHTML += '<option value="primary">Calendario principale</option>';
    } else {
        userCalendars.forEach(cal => {
            const selected = cal.id === selectedCalendarId ? 'selected' : '';
            select.innerHTML += `<option value="${cal.id}" ${selected}>${cal.summary || cal.id}</option>`;
        });
    }
}

// ============================================
// GESTIONE NON DISPONIBILITÀ (BUSY)
// ============================================

function toggleBusyAllDay() {
    const toggle = document.getElementById('busyAllDay');
    const timeSection = document.getElementById('busyTimeSection');

    toggle.classList.toggle('active');

    if (toggle.classList.contains('active')) {
        timeSection.style.display = 'none';
    } else {
        timeSection.style.display = 'block';
    }
}

function toggleBusyRecurring() {
    const toggle = document.getElementById('busyRecurring');
    const section = document.getElementById('busyRecurrenceSection');

    toggle.classList.toggle('active');

    if (toggle.classList.contains('active')) {
        section.style.display = 'block';
        updateBusyRecurrenceOptions();
    } else {
        section.style.display = 'none';
    }
}

function updateBusyRecurrenceOptions() {
    const type = document.getElementById('busyRecurrenceType').value;
    const weekdaysSection = document.getElementById('busyWeekdaysSection');

    // Mostra selezione giorni solo per "custom" o "weekly"
    if (type === 'custom') {
        weekdaysSection.style.display = 'block';
    } else {
        weekdaysSection.style.display = 'none';
    }
}

function updateBusyEndOptions() {
    const endType = document.getElementById('busyRecurrenceEnd').value;
    const dateSection = document.getElementById('busyEndDateSection');
    const countSection = document.getElementById('busyEndCountSection');

    dateSection.style.display = endType === 'date' ? 'block' : 'none';
    countSection.style.display = endType === 'count' ? 'block' : 'none';
}

// Costruisce la stringa RRULE per Google Calendar
function buildRecurrenceRule() {
    const type = document.getElementById('busyRecurrenceType').value;
    const endType = document.getElementById('busyRecurrenceEnd').value;

    let rule = 'RRULE:';

    // Frequenza base
    switch (type) {
        case 'daily':
            rule += 'FREQ=DAILY';
            break;
        case 'weekly':
            rule += 'FREQ=WEEKLY';
            break;
        case 'biweekly':
            rule += 'FREQ=WEEKLY;INTERVAL=2';
            break;
        case 'monthly':
            rule += 'FREQ=MONTHLY';
            break;
        case 'yearly':
            rule += 'FREQ=YEARLY';
            break;
        case 'custom':
            // Giorni personalizzati
            const days = [];
            ['MO', 'TU', 'WE', 'TH', 'FR', 'SA', 'SU'].forEach(day => {
                if (document.getElementById(`busyDay_${day}`)?.checked) {
                    days.push(day);
                }
            });
            if (days.length > 0) {
                rule += `FREQ=WEEKLY;BYDAY=${days.join(',')}`;
            } else {
                rule += 'FREQ=WEEKLY';
            }
            break;
    }

    // Fine ricorrenza
    if (endType === 'date') {
        const endDate = document.getElementById('busyRecurrenceEndDate').value;
        if (endDate) {
            // Formato RRULE: YYYYMMDD
            const dateStr = endDate.replace(/-/g, '');
            rule += `;UNTIL=${dateStr}T235959Z`;
        }
    } else if (endType === 'count') {
        const count = document.getElementById('busyRecurrenceCount').value || 10;
        rule += `;COUNT=${count}`;
    }

    return rule;
}

function populateBusyCalendarSelect() {
    const select = document.getElementById('busyCalendarSelect');
    if (!select) return;

    select.innerHTML = '';

    if (userCalendars.length === 0) {
        select.innerHTML = '<option value="primary">Calendario principale</option>';
    } else {
        userCalendars.forEach(cal => {
            const selected = cal.id === selectedCalendarId ? 'selected' : '';
            select.innerHTML += `<option value="${cal.id}" ${selected}>${cal.summary || cal.id}</option>`;
        });
    }
}

async function saveBusyEvent() {
    if (!isGoogleSignedIn) {
        showToast('Devi essere connesso a Google Calendar', 'warning');
        return;
    }

    // Verifica che il nome d'arte sia impostato
    const stageName = state.profile?.stageName || state.profile?.nickname || '';
    if (!stageName) {
        showToast('Imposta prima il tuo Nome d\'Arte nelle impostazioni', 'warning');
        closeModal('busyModal');
        // Porta l'utente alle impostazioni
        switchPage('settings');
        // Apri il modal del profilo dopo un breve delay
        setTimeout(() => {
            openProfileModal();
        }, 300);
        return;
    }

    const reason = document.getElementById('busyReason').value.trim();
    const dateStart = document.getElementById('busyDateStart').value;
    const dateEnd = document.getElementById('busyDateEnd').value || dateStart;
    const location = document.getElementById('busyLocation').value.trim();
    const isAllDay = document.getElementById('busyAllDay').classList.contains('active');
    const timeStart = document.getElementById('busyTimeStart').value;
    const timeEnd = document.getElementById('busyTimeEnd').value;
    const calendarId = document.getElementById('busyCalendarSelect').value || selectedCalendarId || 'primary';
    const isRecurring = document.getElementById('busyRecurring').classList.contains('active');

    if (!dateStart) {
        showToast('Seleziona almeno una data', 'error');
        return;
    }

    // Crea il titolo: "🚫 Occupato - Nome d'Arte" oppure "🚫 Occupato - Nome d'Arte (motivo)"
    let eventTitle = `🚫 Occupato - ${stageName}`;
    if (reason) {
        eventTitle += ` (${reason})`;
    }

    try {
        showToast('Creazione in corso...', 'info');

        let event;

        if (isAllDay) {
            // Evento tutto il giorno
            // Per eventi multi-giorno, la data fine deve essere il giorno DOPO l'ultimo giorno
            const endDate = new Date(dateEnd);
            endDate.setDate(endDate.getDate() + 1);
            const endDateStr = endDate.toISOString().split('T')[0];

            event = {
                summary: eventTitle,
                location: location || undefined,
                description: `Non disponibile - ${stageName}\nCreato da S.A.V.E.R.S.`,
                start: {
                    date: dateStart
                },
                end: {
                    date: endDateStr
                },
                transparency: 'opaque', // Mostra come "Occupato"
                visibility: 'private'
            };
        } else {
            // Evento con orario specifico
            const startDateTime = new Date(`${dateStart}T${timeStart}`);
            const endDateTime = new Date(`${dateStart}T${timeEnd}`); // Usa dateStart per eventi ricorrenti

            event = {
                summary: eventTitle,
                location: location || undefined,
                description: `Non disponibile - ${stageName}\nCreato da S.A.V.E.R.S.`,
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                },
                transparency: 'opaque', // Mostra come "Occupato"
                visibility: 'private'
            };
        }

        // Aggiungi ricorrenza se attiva
        if (isRecurring) {
            const recurrenceRule = buildRecurrenceRule();
            event.recurrence = [recurrenceRule];
        }

        // Rimuovi location se vuota
        if (!event.location) delete event.location;

        const response = await gapi.client.calendar.events.insert({
            calendarId: calendarId,
            resource: event
        });

        console.log('Evento busy creato:', response.result);

        closeModal('busyModal');
        resetBusyForm();

        // Ricarica eventi
        await loadCalendarEvents();
        renderCalendar();

        showToast('Non disponibilità salvata! 🚫', 'success');

    } catch (error) {
        console.error('Errore creazione evento busy:', error);
        showToast('Errore: ' + (error.result?.error?.message || error.message), 'error');
    }
}

function resetBusyForm() {
    document.getElementById('busyReason').value = '';
    document.getElementById('busyDateStart').value = '';
    document.getElementById('busyDateEnd').value = '';
    document.getElementById('busyTimeStart').value = '09:00';
    document.getElementById('busyTimeEnd').value = '18:00';
    document.getElementById('busyLocation').value = '';

    // Reset toggle "tutto il giorno" a disattivo (default: orario specifico)
    const allDayToggle = document.getElementById('busyAllDay');
    allDayToggle.classList.remove('active');
    document.getElementById('busyTimeSection').style.display = 'block';

    // Reset ricorrenza
    const recurringToggle = document.getElementById('busyRecurring');
    recurringToggle.classList.remove('active');
    document.getElementById('busyRecurrenceSection').style.display = 'none';
    document.getElementById('busyRecurrenceType').value = 'weekly';
    document.getElementById('busyRecurrenceEnd').value = 'never';
    document.getElementById('busyWeekdaysSection').style.display = 'none';
    document.getElementById('busyEndDateSection').style.display = 'none';
    document.getElementById('busyEndCountSection').style.display = 'none';
    document.getElementById('busyRecurrenceCount').value = '10';
    document.getElementById('busyRecurrenceEndDate').value = '';

    // Reset checkbox giorni
    ['MO', 'TU', 'WE', 'TH', 'FR', 'SA', 'SU'].forEach(day => {
        const cb = document.getElementById(`busyDay_${day}`);
        if (cb) cb.checked = false;
    });
}

// ============================================
// GESTIONE INVITATI EVENTO
// ============================================

function addEventAttendee() {
    const input = document.getElementById('eventAttendeeEmail');
    const email = input.value.trim().toLowerCase();

    if (!email) return;

    // Validazione email semplice
    if (!email.includes('@') || !email.includes('.')) {
        showToast('Inserisci un\'email valida', 'error');
        return;
    }

    // Evita duplicati
    if (eventAttendees.includes(email)) {
        showToast('Email già aggiunta', 'warning');
        return;
    }

    eventAttendees.push(email);
    input.value = '';
    hideAttendeeSuggestions();
    renderEventAttendees();
}

// Mostra suggerimenti membri team per inviti
function showAttendeeSuggestions() {
    const input = document.getElementById('eventAttendeeEmail');
    const container = document.getElementById('attendeeSuggestions');
    if (!input || !container) return;

    const query = input.value.trim().toLowerCase();

    // Ottieni tutti i membri dei team
    const teamMembers = getTeamMembersForAutocomplete();

    // Filtra per query
    const filtered = teamMembers.filter(m => {
        // Escludi già aggiunti
        if (eventAttendees.includes(m.email.toLowerCase())) return false;
        // Filtra per nome o email
        if (!query) return true;
        return m.name.toLowerCase().includes(query) || m.email.toLowerCase().includes(query);
    });

    if (filtered.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.innerHTML = filtered.slice(0, 8).map(member => `
        <div onclick="selectAttendee('${member.email}', '${member.name}')" style="
            display:flex;
            align-items:center;
            padding:10px 12px;
            cursor:pointer;
            border-bottom:1px solid var(--border-color);
            transition: background 0.2s;
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
            <div style="
                width:32px;
                height:32px;
                border-radius:50%;
                background:${member.role === 'owner' ? 'var(--primary)' : 'var(--bg-tertiary)'};
                display:flex;
                align-items:center;
                justify-content:center;
                font-weight:bold;
                font-size:0.8rem;
                color:${member.role === 'owner' ? 'white' : 'inherit'};
                margin-right:10px;
            ">
                ${(member.name || '?').charAt(0).toUpperCase()}
            </div>
            <div style="flex:1; min-width:0;">
                <div style="font-weight:500; font-size:0.9rem; display:flex; align-items:center; gap:4px;">
                    ${member.name}
                    ${member.role === 'owner' ? '<span style="font-size:0.7rem;">👑</span>' : ''}
                </div>
                <div style="font-size:0.75rem; color:var(--text-muted); display:flex; align-items:center; gap:6px;">
                    ${member.email}
                    ${member.teamName ? `<span style="background:var(--primary); color:white; padding:1px 4px; border-radius:3px; font-size:0.65rem;">${member.teamName}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');

    container.style.display = 'block';
}

// Nascondi suggerimenti
function hideAttendeeSuggestions() {
    const container = document.getElementById('attendeeSuggestions');
    if (container) {
        setTimeout(() => {
            container.style.display = 'none';
        }, 200);
    }
}

// Seleziona membro da suggerimenti
function selectAttendee(email, name) {
    const input = document.getElementById('eventAttendeeEmail');
    if (input) input.value = email;

    addEventAttendee();
    showToast(`${name} aggiunto!`, 'success');
}

// Chiudi suggerimenti quando clicchi fuori
document.addEventListener('click', function(e) {
    const input = document.getElementById('eventAttendeeEmail');
    const container = document.getElementById('attendeeSuggestions');
    if (input && container && !input.contains(e.target) && !container.contains(e.target)) {
        container.style.display = 'none';
    }
});

function removeEventAttendee(email) {
    eventAttendees = eventAttendees.filter(e => e !== email);
    renderEventAttendees();
}

function renderEventAttendees() {
    const container = document.getElementById('eventAttendeesInput');
    if (!container) return;

    if (eventAttendees.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = eventAttendees.map(email => `
        <div class="attendee-chip pending" style="display:flex;align-items:center;gap:4px;padding:4px 8px;">
            <span style="font-size:0.8rem;">${email}</span>
            <button type="button" onclick="removeEventAttendee('${email}')" style="background:none;border:none;cursor:pointer;padding:0;font-size:0.9rem;">✕</button>
        </div>
    `).join('');
}

function clearEventAttendees() {
    eventAttendees = [];
    const container = document.getElementById('eventAttendeesInput');
    if (container) container.innerHTML = '';
}

// Invia inviti evento al backend (con lista invitati esplicita)
async function sendEventInvitesToUsers(eventData, inviteesList) {
    if (!inviteesList || inviteesList.length === 0) return;

    console.log('📧 Invio inviti a:', inviteesList);

    try {
        const response = await apiCall('sendEventInvites', {
            invitees: inviteesList,
            eventData: {
                id: eventData.id,
                title: eventData.title,
                date: eventData.date,
                startTime: eventData.startTime,
                endTime: eventData.endTime,
                location: eventData.location,
                notes: eventData.notes,
                creatorUsername: currentUser?.username,
                creatorNickname: currentUser?.nickname
            }
        });

        console.log('📧 Risposta inviti:', response);

        if (response.success) {
            if (response.sentCount > 0) {
                showToast(`📧 Inviti inviati a ${response.sentCount} persona/e!`, 'success');
            }
            if (response.notFoundEmails?.length > 0) {
                showToast(`⚠️ Utenti non trovati: ${response.notFoundEmails.join(', ')}`, 'warning');
            }
        } else {
            console.error('Errore invio inviti:', response.message);
            showToast('Errore invio inviti: ' + response.message, 'error');
        }
    } catch (error) {
        console.error('Errore sendEventInvitesToUsers:', error);
        showToast('Errore invio inviti', 'error');
    }
}

// ========== NOTIFICATION SOUND SYSTEM ==========

let lastNotificationCount = 0;
let notificationSound = null;

// Inizializza il suono delle notifiche
function initNotificationSound() {
    // Crea un AudioContext per generare suoni sintetici
    try {
        notificationSound = {
            play: function() {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                    // Nota principale (campana dolce)
                    const osc1 = audioCtx.createOscillator();
                    const gain1 = audioCtx.createGain();
                    osc1.type = 'sine';
                    osc1.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
                    osc1.frequency.exponentialRampToValueAtTime(660, audioCtx.currentTime + 0.1);
                    gain1.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain1.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc1.connect(gain1);
                    gain1.connect(audioCtx.destination);
                    osc1.start(audioCtx.currentTime);
                    osc1.stop(audioCtx.currentTime + 0.5);

                    // Seconda nota (eco armonico)
                    setTimeout(() => {
                        const osc2 = audioCtx.createOscillator();
                        const gain2 = audioCtx.createGain();
                        osc2.type = 'sine';
                        osc2.frequency.setValueAtTime(1320, audioCtx.currentTime); // E6
                        gain2.gain.setValueAtTime(0.15, audioCtx.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc2.connect(gain2);
                        gain2.connect(audioCtx.destination);
                        osc2.start(audioCtx.currentTime);
                        osc2.stop(audioCtx.currentTime + 0.3);
                    }, 100);

                    console.log('🔔 Suono notifica riprodotto');
                } catch (e) {
                    console.warn('Impossibile riprodurre suono:', e);
                }
            }
        };
    } catch (e) {
        console.warn('AudioContext non supportato');
    }
}

// Riproduci suono notifica
function playNotificationSound() {
    if (state.settings?.notificationSound === false) return; // Rispetta impostazione
    if (notificationSound) {
        notificationSound.play();
    }
}

// Carica notifiche dal backend
async function loadUserNotifications() {
    try {
        const response = await apiCall('getUserNotifications', {});
        console.log('getUserNotifications response:', response);

        if (response.success) {
            const newNotifications = response.notifications || [];
            const previousCount = state.backendNotifications?.length || 0;

            state.backendNotifications = newNotifications;
            console.log('Notifiche caricate:', state.backendNotifications.length);

            // Se ci sono nuove notifiche, riproduci suono
            if (newNotifications.length > previousCount && previousCount > 0) {
                playNotificationSound();
                // Vibra su mobile se disponibile
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
            }

            updateInboxBadge();
            // Aggiorna sezione inviti in attesa nel calendario
            if (typeof renderPendingInvites === 'function') renderPendingInvites();
        } else {
            console.warn('getUserNotifications failed:', response.message);
        }
    } catch (error) {
        console.error('Errore loadUserNotifications:', error);
    }
}

// Rispondi a un invito evento dal backend
async function respondToBackendEventInvite(notificationId, response) {
    console.log('respondToBackendEventInvite chiamato:', { notificationId, response });

    if (!notificationId) {
        showToast('Errore: ID notifica mancante', 'error');
        return;
    }

    try {
        const result = await apiCall('respondToEventInvite', {
            notificationId: notificationId,
            response: response, // 'accepted' o 'declined'
            responderUsername: currentUser?.nickname || currentUser?.username || state.cloudUser?.username
        });

        console.log('Risposta respondToEventInvite:', result);

        if (result.success) {
            showToast(result.message, response === 'accepted' ? 'success' : 'info');

            // Se accettato, aggiungi l'evento al calendario locale
            if (response === 'accepted' && result.eventData) {
                const event = {
                    id: 'invited_' + Date.now(),
                    title: result.eventData.title,
                    date: result.eventData.date,
                    startTime: result.eventData.startTime,
                    endTime: result.eventData.endTime,
                    location: result.eventData.location || '',
                    notes: result.eventData.notes || '',
                    type: 'meeting',
                    department: 'work',
                    isInvited: true,
                    invitedBy: result.eventData.creatorUsername,
                    createdAt: new Date().toISOString()
                };

                state.events = state.events || [];
                state.events.push(event);
                saveStateAndSync();
                renderCalendar();
            }

            // Se rifiutato, riproduci suono (feedback)
            if (response === 'declined') {
                // Il backend invierà notifica al creatore
                console.log('📧 Notifica rifiuto inviata al creatore');
            }

            // Ricarica notifiche
            await loadUserNotifications();
            renderInbox();
        } else {
            showToast(result.message || 'Errore', 'error');
        }
    } catch (error) {
        console.error('Errore respondToBackendEventInvite:', error);
        showToast('Errore di connessione', 'error');
    }
}

async function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    if (!title) {
        showToast('Inserisci un titolo', 'error');
        return;
    }

    const date = document.getElementById('eventDate').value || new Date().toISOString().split('T')[0];
    const startTime = document.getElementById('eventStartTime').value || '09:00';
    const duration = parseInt(document.getElementById('eventDuration').value) || 60;

    // Calcola ora fine
    const [hours, mins] = startTime.split(':').map(Number);
    const endDate = new Date(2000, 0, 1, hours, mins + duration);
    const endTime = `${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}`;

    const location = document.getElementById('eventLocation').value;
    const notes = document.getElementById('eventNotes').value;
    const eventType = document.getElementById('eventType').value;

    // ============================================
    // MODIFICA EVENTO GOOGLE ESISTENTE
    // ============================================
    if (editingGoogleEventId) {
        const startDateTime = new Date(`${date}T${startTime}`);
        const endDateTime = new Date(`${date}T${endTime}`);

        // Trova l'evento esistente per confrontare gli attendees
        const existingGoogleEvent = state.calendarEvents?.find(e => e.id === editingGoogleEventId);
        const oldAttendees = (existingGoogleEvent?.attendees || []).map(a => a.email?.toLowerCase());

        const googleEventData = {
            summary: title,
            description: notes || '',
            location: location || '',
            start: {
                dateTime: startDateTime.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            end: {
                dateTime: endDateTime.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }
        };

        // Aggiungi nuovi invitati se presenti
        if (eventAttendees.length > 0) {
            googleEventData.attendees = eventAttendees.map(email => ({ email }));

            // Trova i NUOVI invitati per notificarli via backend
            const newAttendees = eventAttendees.filter(email =>
                !oldAttendees.includes(email.toLowerCase())
            );

            if (newAttendees.length > 0) {
                console.log('📧 Nuovi invitati Google da notificare:', newAttendees);
                // Invia notifiche backend ai nuovi invitati
                const eventDataForNotif = {
                    id: editingGoogleEventId,
                    title: title,
                    date: date,
                    startTime: startTime,
                    endTime: endTime,
                    location: location,
                    notes: notes
                };
                sendEventInvitesToUsers(eventDataForNotif, newAttendees);
            }
        }

        const result = await updateGoogleEvent(editingGoogleEventId, googleEventData);

        if (result) {
            const newCount = eventAttendees.filter(e => !oldAttendees.includes(e.toLowerCase())).length;
            if (newCount > 0) {
                showToast(`Evento Google aggiornato! Inviti inviati a ${newCount} nuovi partecipanti`, 'success');
            } else {
                showToast('Evento Google aggiornato!', 'success');
            }
            loadCalendarEvents(); // Ricarica eventi
        }

        // Reset
        editingGoogleEventId = null;
        resetEventForm();
        closeModal('addEventModal');
        renderCalendar();
        return;
    }

    // ============================================
    // MODIFICA EVENTO LOCALE ESISTENTE
    // ============================================
    if (window.editingEventId) {
        const syncGoogle = document.getElementById('eventSyncGoogle').classList.contains('active');

        // Se si attiva sync Google, sposta l'evento su Google Calendar (elimina locale)
        if (syncGoogle && isGoogleSignedIn) {
            // Elimina evento locale
            state.events = (state.events || []).filter(e => e.id !== window.editingEventId);
            saveStateAndSync();

            // Crea su Google con invitati
            const targetCalendarId = document.getElementById('eventCalendarSelect').value || selectedCalendarId || 'primary';
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);
            await createCalendarEventToCalendar(title, startDateTime, endDateTime, notes, location, targetCalendarId, eventAttendees);
            await loadCalendarEvents();

            clearEventAttendees();
            showToast('Evento spostato su Google Calendar!', 'success');
        } else {
            // Aggiorna evento locale
            const existingEvent = state.events.find(e => e.id === window.editingEventId);
            if (existingEvent) {
                // Salva i vecchi attendees per confronto
                const oldAttendees = (existingEvent.attendees || []).map(a => a.email?.toLowerCase() || a.toLowerCase());

                existingEvent.title = title;
                existingEvent.date = date;
                existingEvent.startTime = startTime;
                existingEvent.endTime = endTime;
                existingEvent.duration = duration;
                existingEvent.type = eventType;
                existingEvent.location = location;
                existingEvent.notes = notes;
                existingEvent.department = document.getElementById('eventDepartment')?.value || 'personal';
                existingEvent.updatedAt = new Date().toISOString();

                // Aggiorna attendees con i nuovi dal form
                if (eventAttendees.length > 0) {
                    existingEvent.attendees = eventAttendees.map(email => {
                        // Mantieni lo status dei vecchi invitati
                        const oldAtt = (existingEvent.attendees || []).find(a =>
                            (a.email?.toLowerCase() || a.toLowerCase()) === email.toLowerCase()
                        );
                        return {
                            email: email,
                            status: oldAtt?.status || 'pending'
                        };
                    });

                    // Trova i NUOVI invitati (non presenti prima)
                    const newAttendees = eventAttendees.filter(email =>
                        !oldAttendees.includes(email.toLowerCase())
                    );

                    // Invia notifiche solo ai nuovi invitati
                    if (newAttendees.length > 0) {
                        console.log('📧 Nuovi invitati da notificare:', newAttendees);
                        sendEventInvitesToUsers(existingEvent, newAttendees);
                        showToast(`Evento aggiornato! Inviti inviati a ${newAttendees.length} nuovi partecipanti`, 'success');
                    } else {
                        showToast('Evento aggiornato!', 'success');
                    }
                } else {
                    showToast('Evento aggiornato!', 'success');
                }

                saveStateAndSync();
            }
        }

        window.editingEventId = null;
        resetEventForm();
        closeModal('addEventModal');
        renderCalendar();
        updateDepartmentStats();
        return;
    }

    // ============================================
    // CREA NUOVO EVENTO
    // ============================================
    const syncGoogle = document.getElementById('eventSyncGoogle').classList.contains('active');

    // Se sync Google è attivo, crea SOLO su Google Calendar (no duplicato locale)
    if (syncGoogle && isGoogleSignedIn) {
        const targetCalendarId = document.getElementById('eventCalendarSelect').value || selectedCalendarId || 'primary';
        const startDateTime = new Date(`${date}T${startTime}`);
        const endDateTime = new Date(`${date}T${endTime}`);

        // Passa anche gli invitati
        await createCalendarEventToCalendar(title, startDateTime, endDateTime, notes, location, targetCalendarId, eventAttendees);

        // Ricarica eventi Google per vedere il nuovo evento
        await loadCalendarEvents();

        // Pulisci invitati
        clearEventAttendees();

        resetEventForm();
        closeModal('addEventModal');
        renderCalendar();
        updateDepartmentStats();
        addXP(5);
        return;
    }

    // Altrimenti crea evento locale
    const event = {
        id: 'event_' + Date.now(),
        title,
        date,
        startTime,
        endTime,
        duration,
        type: eventType,
        location: location,
        notes: notes,
        department: document.getElementById('eventDepartment')?.value || 'personal',
        attendees: eventAttendees.length > 0 ? eventAttendees.map(email => ({ email, status: 'pending' })) : [],
        createdAt: new Date().toISOString()
    };

    state.events = state.events || [];
    state.events.push(event);
    saveStateAndSync();

    // Se ci sono invitati, invia gli inviti tramite backend
    // Copia gli invitati prima di resettare il form
    const attendeesToSend = [...eventAttendees];
    if (attendeesToSend.length > 0) {
        // Invia inviti in background
        sendEventInvitesToUsers(event, attendeesToSend);
    }

    resetEventForm();
    closeModal('addEventModal');
    renderCalendar();
    updateDepartmentStats();
    addXP(5);
    showToast('Evento creato! +5 XP', 'success');
}

// Reset form evento
function resetEventForm() {
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventLocation').value = '';
    document.getElementById('eventNotes').value = '';

    // NON disattivare il toggle Google - rimane attivo di default se utente è connesso
    // Il toggle viene gestito in openModal('addEventModal')

    window.editingEventId = null;
    editingGoogleEventId = null;

    // Reset department a 'personal'
    selectEventDepartment('personal');

    // Pulisci anche gli invitati
    clearEventAttendees();
}

// Crea evento su un calendario Google specifico (con supporto invitati)
async function createCalendarEventToCalendar(title, startDateTime, endDateTime, description, location, calendarId, attendeesEmails = []) {
    if (!isGoogleSignedIn) return;

    try {
        const event = {
            summary: title,
            description: description || '',
            location: location || '',
            start: {
                dateTime: startDateTime.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            end: {
                dateTime: endDateTime.toISOString(),
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }
        };

        // Aggiungi invitati se presenti
        if (attendeesEmails && attendeesEmails.length > 0) {
            event.attendees = attendeesEmails.map(email => ({ email: email }));
        }

        const response = await gapi.client.calendar.events.insert({
            calendarId: calendarId,
            resource: event,
            sendUpdates: 'all' // Invia email di invito a tutti i partecipanti
        });

        if (attendeesEmails && attendeesEmails.length > 0) {
            showToast(`Evento creato! Inviti inviati a ${attendeesEmails.length} persona/e ☁️`, 'success');
        } else {
            showToast('Evento aggiunto a Google Calendar! ☁️', 'success');
        }

        // Ricarica eventi
        setTimeout(loadCalendarEvents, 1000);

        return response.result;
    } catch (error) {
        console.error('Errore creazione evento Google:', error);
        showToast('Errore sincronizzazione Google', 'error');
    }
}

// Inizializza il calendario all'avvio
document.addEventListener('DOMContentLoaded', function() {
    // Imposta la data del campo evento a oggi
    const eventDateInput = document.getElementById('eventDate');
    if (eventDateInput) {
        eventDateInput.value = new Date().toISOString().split('T')[0];
    }

    // Renderizza il calendario
    setTimeout(renderCalendar, 500);

    // Check onboarding progress al caricamento
    setTimeout(() => {
        checkOnboardingProgress(false);
        updateDepartmentStats();
    }, 1000);

    // ============================================
    // INIZIALIZZA NUOVI SISTEMI
    // ============================================

    // Pull-to-refresh DISABILITATO - causava problemi con la barra superiore
    // if ('ontouchstart' in window) {
    //     pullToRefresh.init();
    // }

    // Token manager per refresh automatico
    tokenManager.init();

    // Processa coda offline se ci sono operazioni pendenti
    if (offlineQueue.operations.length > 0 && navigator.onLine) {
        setTimeout(() => offlineQueue.processQueue(), 2000);
    }

    // Banner offline
    const offlineBanner = document.createElement('div');
    offlineBanner.className = 'offline-banner';
    offlineBanner.innerHTML = '📴 Modalità offline - Le modifiche verranno sincronizzate quando torni online';
    document.body.prepend(offlineBanner);

    // Aggiorna visibilità banner
    const updateOfflineBanner = () => {
        offlineBanner.classList.toggle('visible', !navigator.onLine);
    };
    window.addEventListener('online', updateOfflineBanner);
    window.addEventListener('offline', updateOfflineBanner);
    updateOfflineBanner();

    console.log('✅ Sistemi avanzati inizializzati: Undo, Offline Queue, Pull-to-Refresh, Token Manager');
});

// ============================================
// SUPER ADMIN PANEL
// ============================================

// Apri pannello admin (accesso segreto)
function openSuperAdminPanel() {
    // Reset stato
    isAdminAuthenticated = false;
    document.getElementById('adminAuthScreen').style.display = 'block';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('adminPasswordInput').value = '';

    openModal('superAdminModal');
}

// Verifica password admin
function verifyAdminPassword() {
    const password = document.getElementById('adminPasswordInput').value;

    if (password === SUPER_ADMIN_PASSWORD) {
        isAdminAuthenticated = true;
        document.getElementById('adminAuthScreen').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';

        showToast('Accesso Admin autorizzato! 🛡️', 'success');
        loadAdminUserList();
    } else {
        showToast('Password errata!', 'error');
        document.getElementById('adminPasswordInput').value = '';
        document.getElementById('adminPasswordInput').focus();
    }
}

// Carica lista utenti dal backend
async function loadAdminUserList() {
    if (!isAdminAuthenticated) return;

    try {
        const response = await apiCall('adminGetAllUsers', {
            adminPassword: SUPER_ADMIN_PASSWORD
        });

        if (response.success && response.users) {
            adminUsersList = response.users;
            renderAdminUserList();
            updateAdminStats();
        } else {
            // Se l'API non supporta ancora questa funzione, mostra messaggio
            document.getElementById('adminUsersList').innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-muted);">
                    <div style="font-size:2rem; margin-bottom:10px;">⚠️</div>
                    <p>Per abilitare la gestione utenti, aggiorna il tuo Google Apps Script con le funzioni admin.</p>
                    <p style="font-size:0.85rem; margin-top:10px;">Vedi documentazione per il codice da aggiungere.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Errore caricamento utenti:', error);
        document.getElementById('adminUsersList').innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-muted);">
                <div style="font-size:2rem; margin-bottom:10px;">❌</div>
                <p>Errore caricamento utenti</p>
                <p style="font-size:0.85rem;">${error.message || 'Verifica la connessione'}</p>
            </div>
        `;
    }
}

// Aggiorna statistiche admin
function updateAdminStats() {
    const total = adminUsersList.length;
    const banned = adminUsersList.filter(u => u.banned).length;
    const active = total - banned;

    document.getElementById('adminTotalUsers').textContent = total;
    document.getElementById('adminActiveUsers').textContent = active;
    document.getElementById('adminBannedUsers').textContent = banned;
}

// Renderizza lista utenti
function renderAdminUserList() {
    const container = document.getElementById('adminUsersList');
    const searchTerm = document.getElementById('adminUserSearch')?.value?.toLowerCase() || '';

    const filteredUsers = adminUsersList.filter(user => {
        const username = (user.username || '').toLowerCase();
        const email = (user.email || '').toLowerCase();
        return username.includes(searchTerm) || email.includes(searchTerm);
    });

    if (filteredUsers.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-muted);">
                ${searchTerm ? 'Nessun utente trovato' : 'Nessun utente registrato'}
            </div>
        `;
        return;
    }

    container.innerHTML = filteredUsers.map(user => `
        <div class="admin-user-card" onclick="openAdminUserDetail('${user.username}')" style="
            display:flex;
            align-items:center;
            padding:12px 16px;
            border-bottom:1px solid var(--border-color);
            cursor:pointer;
            transition: background 0.2s;
            ${user.banned ? 'opacity:0.6; background:rgba(220,38,38,0.1);' : ''}
        " onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='${user.banned ? 'rgba(220,38,38,0.1)' : 'transparent'}'">
            <div style="
                width:40px;
                height:40px;
                border-radius:50%;
                background:${user.banned ? '#dc2626' : 'var(--primary)'};
                display:flex;
                align-items:center;
                justify-content:center;
                font-weight:bold;
                color:white;
                margin-right:12px;
            ">
                ${user.banned ? '🚫' : (user.username?.charAt(0)?.toUpperCase() || '?')}
            </div>
            <div style="flex:1; min-width:0;">
                <div style="font-weight:500; display:flex; align-items:center; gap:6px;">
                    ${user.username || 'Sconosciuto'}
                    ${user.banned ? '<span style="font-size:0.7rem; background:#dc2626; color:white; padding:2px 6px; border-radius:4px;">BANNATO</span>' : ''}
                    ${user.loginMethod === 'google' ? '<span style="font-size:0.8rem;">🔷</span>' : ''}
                </div>
                <div style="font-size:0.8rem; color:var(--text-muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${user.email || 'Email non disponibile'}
                </div>
            </div>
            <div style="font-size:0.75rem; color:var(--text-muted); text-align:right;">
                <div>${user.lastLogin ? formatRelativeDate(new Date(user.lastLogin)) : 'Mai'}</div>
                <div>Ultimo accesso</div>
            </div>
            <div style="margin-left:8px; color:var(--text-muted);">›</div>
        </div>
    `).join('');
}

// Filtra utenti nella ricerca
function filterAdminUsers() {
    renderAdminUserList();
}

// Aggiorna lista utenti
function refreshAdminUserList() {
    loadAdminUserList();
    showToast('Lista aggiornata', 'info');
}

// Apri dettaglio utente
function openAdminUserDetail(username) {
    selectedAdminUser = adminUsersList.find(u => u.username === username);
    if (!selectedAdminUser) return;

    const user = selectedAdminUser;
    const content = document.getElementById('adminUserDetailContent');

    content.innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
            <div style="
                width:80px;
                height:80px;
                border-radius:50%;
                background:${user.banned ? '#dc2626' : 'var(--primary)'};
                display:flex;
                align-items:center;
                justify-content:center;
                font-size:2rem;
                font-weight:bold;
                color:white;
                margin:0 auto 10px;
            ">
                ${user.banned ? '🚫' : (user.username?.charAt(0)?.toUpperCase() || '?')}
            </div>
            <h3 style="margin:0;">${user.username || 'Utente'}</h3>
            ${user.banned ? '<span style="font-size:0.8rem; background:#dc2626; color:white; padding:4px 12px; border-radius:4px; display:inline-block; margin-top:8px;">🚫 ACCOUNT BANNATO</span>' : ''}
        </div>

        <div class="card" style="margin-bottom:12px;">
            <div style="display:grid; gap:12px;">
                <div style="display:flex; justify-content:space-between;">
                    <span class="text-muted">Email</span>
                    <span style="font-weight:500;">${user.email || 'N/A'}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span class="text-muted">Metodo Login</span>
                    <span style="font-weight:500;">${user.loginMethod === 'google' ? '🔷 Google' : '🔑 Password'}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span class="text-muted">Registrato il</span>
                    <span style="font-weight:500;">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('it-IT') : 'N/A'}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span class="text-muted">Ultimo accesso</span>
                    <span style="font-weight:500;">${user.lastLogin ? new Date(user.lastLogin).toLocaleString('it-IT') : 'Mai'}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span class="text-muted">Task completati</span>
                    <span style="font-weight:500;">${user.stats?.tasksCompleted || 0}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span class="text-muted">Livello</span>
                    <span style="font-weight:500;">Lv. ${user.stats?.level || 1}</span>
                </div>
            </div>
        </div>

        ${user.banReason ? `
        <div class="card" style="background:rgba(220,38,38,0.1); border:1px solid #dc2626;">
            <div style="font-weight:500; margin-bottom:4px;">🚫 Motivo Ban:</div>
            <div style="font-size:0.9rem;">${user.banReason}</div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-top:8px;">
                Bannato il: ${user.bannedAt ? new Date(user.bannedAt).toLocaleString('it-IT') : 'N/A'}
            </div>
        </div>
        ` : ''}
    `;

    // Aggiorna testo pulsante ban
    const banBtn = document.getElementById('adminToggleBanBtn');
    if (banBtn) {
        if (user.banned) {
            banBtn.innerHTML = '✅ Riabilita Utente';
            banBtn.style.background = '#22c55e';
        } else {
            banBtn.innerHTML = '🚫 Banna Utente';
            banBtn.style.background = '#f59e0b';
        }
    }

    openModal('adminUserDetailModal');
}

// Toggle ban utente
async function adminToggleUserBan() {
    if (!selectedAdminUser || !isAdminAuthenticated) return;

    const user = selectedAdminUser;
    const action = user.banned ? 'sbannare' : 'bannare';

    let banReason = '';
    if (!user.banned) {
        banReason = prompt(`Motivo per bannare ${user.username}:`);
        if (banReason === null) return; // Annullato
    }

    if (!confirm(`Sei sicuro di voler ${action} l'utente "${user.username}"?`)) return;

    try {
        const response = await apiCall('adminToggleUserBan', {
            adminPassword: SUPER_ADMIN_PASSWORD,
            targetUsername: user.username,
            ban: !user.banned,
            reason: banReason
        });

        if (response.success) {
            showToast(`Utente ${user.banned ? 'riabilitato' : 'bannato'} con successo!`, 'success');
            closeModal('adminUserDetailModal');
            loadAdminUserList();
        } else {
            showToast(response.message || 'Errore durante l\'operazione', 'error');
        }
    } catch (error) {
        console.error('Errore toggle ban:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Reset password utente
async function adminResetUserPassword() {
    if (!selectedAdminUser || !isAdminAuthenticated) return;

    const newPassword = prompt(`Nuova password per ${selectedAdminUser.username}:`);
    if (!newPassword || newPassword.length < 4) {
        if (newPassword !== null) showToast('Password deve essere almeno 4 caratteri', 'error');
        return;
    }

    if (!confirm(`Confermi il reset della password per "${selectedAdminUser.username}"?`)) return;

    try {
        const response = await apiCall('adminResetPassword', {
            adminPassword: SUPER_ADMIN_PASSWORD,
            targetUsername: selectedAdminUser.username,
            newPassword: newPassword
        });

        if (response.success) {
            showToast(`Password resettata! Nuova password: ${newPassword}`, 'success');
        } else {
            showToast(response.message || 'Errore durante il reset', 'error');
        }
    } catch (error) {
        console.error('Errore reset password:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Elimina utente
async function adminDeleteUser() {
    if (!selectedAdminUser || !isAdminAuthenticated) return;

    const confirmText = prompt(`Per eliminare definitivamente "${selectedAdminUser.username}", scrivi "ELIMINA":`);
    if (confirmText !== 'ELIMINA') {
        if (confirmText !== null) showToast('Eliminazione annullata', 'info');
        return;
    }

    try {
        const response = await apiCall('adminDeleteUser', {
            adminPassword: SUPER_ADMIN_PASSWORD,
            targetUsername: selectedAdminUser.username
        });

        if (response.success) {
            showToast(`Utente "${selectedAdminUser.username}" eliminato definitivamente!`, 'success');
            closeModal('adminUserDetailModal');
            loadAdminUserList();
        } else {
            showToast(response.message || 'Errore durante l\'eliminazione', 'error');
        }
    } catch (error) {
        console.error('Errore eliminazione utente:', error);
        showToast('Errore di connessione', 'error');
    }
}

// Accesso segreto: triplo tap sul logo o combinazione tasti
function handleSecretTap() {
    secretTapCount++;

    if (secretTapTimer) clearTimeout(secretTapTimer);

    secretTapTimer = setTimeout(() => {
        secretTapCount = 0;
    }, 1000);

    if (secretTapCount >= 5) {
        secretTapCount = 0;
        // Verifica se l'utente corrente è un admin autorizzato
        const currentEmail = currentUser?.email?.toLowerCase() || state.profile?.email?.toLowerCase();
        if (SUPER_ADMIN_EMAILS.some(e => e.toLowerCase() === currentEmail)) {
            openSuperAdminPanel();
        } else {
            // Non mostra nulla per non rivelare l'esistenza del pannello
            console.log('Accesso non autorizzato');
        }
    }
}

// Combinazione tasti segreti: Ctrl+Shift+A
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        const currentEmail = currentUser?.email?.toLowerCase() || state.profile?.email?.toLowerCase();
        if (SUPER_ADMIN_EMAILS.some(e => e.toLowerCase() === currentEmail)) {
            openSuperAdminPanel();
        }
    }
});

// Reveal admin button in settings (click 5 times on version number)
function handleAdminReveal() {
    adminRevealCount++;

    if (adminRevealTimer) clearTimeout(adminRevealTimer);

    adminRevealTimer = setTimeout(() => {
        adminRevealCount = 0;
    }, 2000);

    if (adminRevealCount >= 5) {
        adminRevealCount = 0;
        const currentEmail = currentUser?.email?.toLowerCase() || state.profile?.email?.toLowerCase();

        if (SUPER_ADMIN_EMAILS.some(e => e.toLowerCase() === currentEmail)) {
            const adminSection = document.getElementById('adminAccessSection');
            if (adminSection) {
                adminSection.style.display = 'block';
                showToast('🛡️ Accesso Admin sbloccato!', 'success');
            }
        } else {
            // Non mostra nulla
            showToast('Funzione non disponibile', 'info');
        }
    }
}

// Verifica se utente è bannato al login
async function checkUserBanStatus(username) {
    try {
        const response = await apiCall('checkBanStatus', { username });
        if (response.banned) {
            showToast(`Account sospeso: ${response.reason || 'Contatta l\'amministratore'}`, 'error');
            logout();
            return true;
        }
        return false;
    } catch (error) {
        console.error('Errore verifica ban:', error);
        return false;
    }
}


    </script>
</body>
</html>
